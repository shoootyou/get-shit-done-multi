name: Publish to NPM (Dev Branch)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Semantic version (e.g., 2.0.0-beta.1 or 1.9.2-alpha.1)'
        required: true
        type: string

concurrency:
  group: npm-publish-dev
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
          
      - name: Validate version format
        run: |
          if ! echo "${{ inputs.version }}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
            echo "❌ Invalid version format: must be X.Y.Z or X.Y.Z-prerelease"
            echo "Examples: 1.9.1, 2.0.0-beta.1, 1.10.5-alpha.2, 2.1.0-rc.1"
            echo "Got: ${{ inputs.version }}"
            exit 1
          fi
          echo "✓ Version format valid: ${{ inputs.version }}"
          
      - name: Check tag doesn't exist
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/v${{ inputs.version }}$"; then
            echo "❌ Tag v${{ inputs.version }} already exists"
            echo "Please choose a different version or delete the existing tag"
            exit 1
          fi
          echo "✓ Tag v${{ inputs.version }} does not exist"
          
      - name: Validate against current package.json version
        run: |
          CURRENT=$(jq -r '.version' package.json)
          echo "Current version in package.json: $CURRENT"
          echo "Input version: ${{ inputs.version }}"
          
          # Use sort -V to compare versions
          if [ "$(printf '%s\n' "$CURRENT" "${{ inputs.version }}" | sort -V | head -n1)" != "$CURRENT" ]; then
            echo "❌ Input version ${{ inputs.version }} must be higher than current version $CURRENT"
            exit 1
          fi
          
          if [ "$CURRENT" == "${{ inputs.version }}" ]; then
            echo "❌ Input version ${{ inputs.version }} is equal to current version $CURRENT"
            echo "Please specify a higher version"
            exit 1
          fi
          
          echo "✓ Input version ${{ inputs.version }} is higher than current $CURRENT"
          
      - name: Verify package.json has files field
        run: |
          if ! jq -e '.files' package.json > /dev/null; then
            echo "❌ package.json must have 'files' field"
            echo "Please add a 'files' array to specify which files to publish"
            exit 1
          fi
          echo "✓ package.json has 'files' field"
          jq '.files' package.json
          
      - name: Update package.json version
        run: |
          echo "Updating package.json version to ${{ inputs.version }}"
          jq --arg version "${{ inputs.version }}" '.version = $version' package.json > package.json.tmp
          mv package.json.tmp package.json
          echo "✓ package.json updated"
          
      - name: Verify version update
        run: |
          UPDATED_VERSION=$(jq -r '.version' package.json)
          if [ "$UPDATED_VERSION" != "${{ inputs.version }}" ]; then
            echo "❌ Failed to update package.json version"
            echo "Expected: ${{ inputs.version }}"
            echo "Got: $UPDATED_VERSION"
            exit 1
          fi
          echo "✓ Version update verified: $UPDATED_VERSION"
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run tests
        run: npm test
        
      - name: Build if build script exists
        run: |
          if jq -e '.scripts.build' package.json > /dev/null; then
            echo "Build script found, running build..."
            npm run build
          else
            echo "No build script found, skipping build step"
          fi
          
      - name: Create and test tarball
        run: |
          echo "Creating tarball..."
          npm pack
          TARBALL=$(ls *.tgz)
          echo "Created: $TARBALL"
          
          echo "Testing tarball installation..."
          TEST_DIR="/tmp/npm-test-$$"
          mkdir -p "$TEST_DIR"
          cd "$TEST_DIR"
          npm install "$OLDPWD/$TARBALL"
          cd "$OLDPWD"
          rm -rf "$TEST_DIR"
          echo "✓ Tarball installation test passed"
          
      - name: Dry-run publish
        run: |
          echo "Running npm publish dry-run..."
          npm publish --dry-run
          echo "✓ Dry-run publish successful"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          
      - name: Create git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "Creating annotated tag v${{ inputs.version }}"
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
          
          echo "Pushing tag to origin..."
          git push origin "v${{ inputs.version }}"
          echo "✓ Git tag v${{ inputs.version }} created and pushed"
          
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Creating GitHub release for v${{ inputs.version }}"
          gh release create "v${{ inputs.version }}" \
            --title "Release v${{ inputs.version }}" \
            --notes "Published version ${{ inputs.version }} to NPM"
          echo "✓ GitHub release created"
          
      - name: Publish to NPM with conditional dist-tag
        run: |
          if [[ "${{ inputs.version }}" =~ - ]]; then
            echo "Pre-release version detected, publishing with 'beta' tag"
            npm publish --tag beta
            echo "✓ Package published to NPM with @beta tag"
            echo "Install with: npm install get-shit-done-multi@beta"
          else
            echo "Stable version detected, publishing with 'latest' tag"
            npm publish --tag latest
            echo "✓ Package published to NPM with @latest tag"
            echo "Install with: npm install get-shit-done-multi"
          fi
          echo "View at: https://www.npmjs.com/package/get-shit-done-multi/v/${{ inputs.version }}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
