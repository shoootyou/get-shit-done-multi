name: Publish to NPM (Main Branch)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Semantic version (e.g., 1.9.1 - no pre-release suffixes)"
        required: true
        type: string

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"
          cache: "npm"

      - name: Pre-flight validation
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== Pre-flight Validation for v${{ inputs.version }} ==="
          echo ""
          VALIDATION_FAILED=0

          # 1. Validate version format
          echo "1. Checking version format..."
          if ! echo "${{ inputs.version }}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "   ❌ Invalid version format: must be X.Y.Z (no pre-release suffixes on main)"
            echo "   Examples: 1.9.1, 2.0.0, 1.10.5"
            echo "   Got: ${{ inputs.version }}"
            VALIDATION_FAILED=1
          else
            echo "   ✓ Version format valid: ${{ inputs.version }}"
          fi
          echo ""

          # 2. Validate against current package.json version
          echo "2. Checking version against package.json..."
          CURRENT=$(jq -r '.version' package.json)
          echo "   Current version in package.json: $CURRENT"
          echo "   Input version: ${{ inputs.version }}"

          if [ "$(printf '%s\n' "$CURRENT" "${{ inputs.version }}" | sort -V | head -n1)" != "$CURRENT" ]; then
            echo "   ❌ Input version ${{ inputs.version }} must be equal or higher than current version $CURRENT"
            VALIDATION_FAILED=1
          elif [ "$CURRENT" == "${{ inputs.version }}" ]; then
            echo "   ⚠️  Input version equals current version (re-publish scenario)"
          else
            echo "   ✓ Input version is higher than current version"
          fi
          echo ""

          # 3. Check if git tag exists
          echo "3. Checking if git tag exists..."
          if git ls-remote --tags origin | grep -q "refs/tags/v${{ inputs.version }}$"; then
            echo "   ❌ Tag v${{ inputs.version }} already exists in repository"
            echo "   To re-publish, delete the tag first: git push --delete origin v${{ inputs.version }}"
            VALIDATION_FAILED=1
          else
            echo "   ✓ Tag v${{ inputs.version }} does not exist"
          fi
          echo ""

          # 4. Check if GitHub Release exists
          echo "4. Checking if GitHub Release exists..."
          if gh release view "v${{ inputs.version }}" &>/dev/null; then
            echo "   ❌ GitHub Release v${{ inputs.version }} already exists"
            echo "   To re-publish, delete the release first: gh release delete v${{ inputs.version }}"
            VALIDATION_FAILED=1
          else
            echo "   ✓ GitHub Release v${{ inputs.version }} does not exist"
          fi
          echo ""

          # 5. Check if version exists on NPM
          echo "5. Checking if version exists on NPM..."
          if npm view get-shit-done-multi@${{ inputs.version }} version &>/dev/null; then
            echo "   ❌ Version ${{ inputs.version }} already published to NPM"
            echo "   NPM does not allow re-publishing the same version"
            echo "   Consider using a patch version bump (e.g., ${{ inputs.version }} -> $(echo ${{ inputs.version }} | awk -F. '{print $1"."$2"."$3+1}'))"
            VALIDATION_FAILED=1
          else
            echo "   ✓ Version ${{ inputs.version }} is not published to NPM"
          fi
          echo ""

          # 6. Verify package.json has files field
          echo "6. Checking package.json configuration..."
          if ! jq -e '.files' package.json > /dev/null; then
            echo "   ❌ package.json must have 'files' field"
            echo "   Add a 'files' array to specify which files to publish"
            VALIDATION_FAILED=1
          else
            echo "   ✓ package.json has 'files' field:"
            jq -r '.files[] | "      - " + .' package.json
          fi
          echo ""

          # Final result
          echo "=== Validation Summary ==="
          if [ $VALIDATION_FAILED -eq 1 ]; then
            echo "❌ Pre-flight validation FAILED"
            echo "Please resolve the issues above before proceeding"
            exit 1
          else
            echo "✅ All pre-flight checks passed"
            echo "Proceeding with publication process..."
          fi

      - name: Update package.json version
        run: |
          CURRENT=$(jq -r '.version' package.json)
          if [ "$CURRENT" == "${{ inputs.version }}" ]; then
            echo "⏭️  Version already matches ${{ inputs.version }}, skipping update"
          else
            echo "Updating package.json version from $CURRENT to ${{ inputs.version }}"
            jq --arg version "${{ inputs.version }}" '.version = $version' package.json > package.json.tmp
            mv package.json.tmp package.json
            
            # Verify the update
            UPDATED_VERSION=$(jq -r '.version' package.json)
            if [ "$UPDATED_VERSION" != "${{ inputs.version }}" ]; then
              echo "❌ Failed to update package.json version"
              echo "Expected: ${{ inputs.version }}"
              echo "Got: $UPDATED_VERSION"
              exit 1
            fi
            echo "✓ package.json updated and verified"
          fi

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build if build script exists
        run: |
          if jq -e '.scripts.build' package.json > /dev/null; then
            echo "Build script found, running build..."
            npm run build
          else
            echo "No build script found, skipping build step"
          fi

      - name: Create and test tarball
        run: |
          echo "Creating tarball..."
          npm pack
          TARBALL=$(ls *.tgz)
          echo "Created: $TARBALL"

          echo "Testing tarball installation..."
          TEST_DIR="/tmp/npm-test-$$"
          mkdir -p "$TEST_DIR"
          cd "$TEST_DIR"
          npm install "$OLDPWD/$TARBALL"
          cd "$OLDPWD"
          rm -rf "$TEST_DIR"
          echo "✓ Tarball installation test passed"

      - name: Dry-run publish
        run: |
          echo "Running npm publish dry-run..."
          npm publish --dry-run
          echo "✓ Dry-run publish successful"

      - name: Create git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Creating annotated tag v${{ inputs.version }}"
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"

          echo "Pushing tag to origin..."
          git push origin "v${{ inputs.version }}"
          echo "✓ Git tag v${{ inputs.version }} created and pushed"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Creating GitHub release for v${{ inputs.version }}"
          gh release create "v${{ inputs.version }}" \
            --title "Release v${{ inputs.version }}" \
            --notes "Published version ${{ inputs.version }} to NPM"
          echo "✓ GitHub release created"

      - name: Publish to NPM
        run: |
          echo "Publishing to NPM with provenance and latest tag..."
          npm publish --provenance --access public
          echo "✓ Package published to NPM with OIDC provenance"
          echo "View at: https://www.npmjs.com/package/get-shit-done-multi/v/${{ inputs.version }}"
