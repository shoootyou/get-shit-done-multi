#!/bin/bash
# Pre-commit hook: Regenerate documentation if code changes
#
# This hook automatically regenerates GSD documentation when code changes.
# It ensures docs stay in sync with code and prevents committing stale documentation.
#
# Triggers regeneration when:
# - capability-matrix.js changes (affects comparison and matrix)
# - command files change (affects command docs)
# - state files change (affects state feature docs)
#
# Install: npm run install-hooks

set -e

# Check if doc generators or source files changed
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Track if we need to regenerate docs
SHOULD_REGEN=false

# Check for capability matrix changes
if echo "$CHANGED_FILES" | grep -q "bin/lib-ghcc/orchestration/capability-matrix.js"; then
  echo "ðŸ“ Capability matrix changed - regenerating docs..."
  SHOULD_REGEN=true
fi

if echo "$CHANGED_FILES" | grep -q "lib-ghcc/orchestration/capability-matrix.js"; then
  echo "ðŸ“ Capability matrix changed - regenerating docs..."
  SHOULD_REGEN=true
fi

# Check for command file changes
if echo "$CHANGED_FILES" | grep -q "commands/gsd/"; then
  echo "ðŸ“ Command files changed - regenerating docs..."
  SHOULD_REGEN=true
fi

# Check for state file changes
if echo "$CHANGED_FILES" | grep -q "lib-ghcc/state/"; then
  echo "ðŸ“ State files changed - regenerating docs..."
  SHOULD_REGEN=true
fi

# If regeneration needed, run the pipeline
if [ "$SHOULD_REGEN" = true ]; then
  echo ""
  echo "ðŸ”„ Running documentation generation pipeline..."
  
  # Regenerate comparison table
  if [ -f "bin/doc-generator/generate-comparison.js" ]; then
    node bin/doc-generator/generate-comparison.js
  fi
  
  # Regenerate capability data
  if [ -f "bin/doc-generator/generate-matrix.js" ]; then
    node bin/doc-generator/generate-matrix.js
  fi
  
  if [ -f "bin/doc-generator/extract-capabilities.js" ]; then
    node bin/doc-generator/extract-capabilities.js
  fi
  
  # Add version stamps
  if [ -f "bin/doc-generator/add-version-stamps.js" ]; then
    node bin/doc-generator/add-version-stamps.js docs/cli-comparison.md 2>/dev/null || true
  fi
  
  echo ""
  echo "ðŸ” Validating generated documentation..."
  
  # Validate generated docs
  if [ -f "bin/validate-docs.js" ]; then
    if ! node bin/validate-docs.js; then
      echo ""
      echo "âŒ Documentation validation failed"
      echo "Fix errors before committing"
      exit 1
    fi
  fi
  
  # Stage regenerated docs
  git add docs/cli-comparison.md 2>/dev/null || true
  git add docs/capability-data.json 2>/dev/null || true
  
  echo ""
  echo "âœ… Documentation regenerated and staged"
  echo ""
fi

exit 0
