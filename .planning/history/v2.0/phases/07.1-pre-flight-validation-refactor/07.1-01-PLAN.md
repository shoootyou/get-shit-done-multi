---
phase: 07.1-pre-flight-validation-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/preflight/pre-flight-validator.js
  - bin/lib/preflight/error-formatter.js
  - bin/lib/validation/error-logger.js
autonomous: true
must_haves:
  - Pre-flight validator module exists at bin/lib/preflight/pre-flight-validator.js
  - validateBeforeInstall() function orchestrates all validation in dependency order
  - Validation runs: disk â†’ templates â†’ permissions â†’ paths â†’ symlinks (cheap-first)
  - Stops at first prerequisite failure (templates missing â†’ skip path validation)
  - Collects independent validation errors for grouped display
  - Error formatter extends error-logger.js with formatPreflightReport()
  - Grouped error output: category headers + user-friendly messages + fix instructions
  - Reuses existing validators (path-validator, symlink-resolver, pre-install-checks)
---

# Phase 7.1, Plan 01: Create Pre-Flight Validation Orchestrator

## Objective

Create a centralized pre-flight validation orchestrator that runs all validation checks before installation begins, using a fail-fast execution strategy with fail-slow reporting (collect all errors for grouped display).

## Context

Phase 7 established individual validators (path-validator, symlink-resolver, pre-install-checks) that work well but are scattered throughout the installation flow. This creates poor UX when multiple issues exist - users fix one error, run again, hit another error, repeat (whack-a-mole).

The standard pattern in mature CLIs (npm, git, docker) is a **pre-flight gate**: run all validation upfront before any work begins, collect errors by category, display grouped report with fixes. This plan creates that orchestrator.

**Key architectural decisions from CONTEXT.md:**
- New module at `bin/lib/preflight/` (independent domain like `updater/`)
- Orchestrator coordinates existing validators (no duplication)
- Fail-fast on prerequisite failures (templates missing â†’ can't validate paths)
- Collect independent errors for grouped display
- Extend error-logger.js with preflight-specific formatting

**Research findings (RESEARCH.md):**
- Use orchestrator pattern with try-catch error collection
- Order validations: cheap-first (disk, templates) then expensive (paths with 8-layer checks)
- Node.js built-in fs.statfs() available (no new dependencies)
- Error grouping by category: Templates / Paths / Disk / Permissions / Symlinks

## Tasks

<task name="create-preflight-orchestrator" type="auto">
  <files>bin/lib/preflight/pre-flight-validator.js</files>
  <action>
    Create pre-flight validation orchestrator module with validateBeforeInstall() function.
    
    **Function signature:**
    ```javascript
    /**
     * Pre-flight validation orchestrator
     * Validates all requirements before installation begins
     * 
     * @param {Array<string>} platforms - Platforms to install (copilot, cursor, etc)
     * @param {string} scope - Installation scope (skills, agents, all)
     * @param {Object} config - Configuration object
     * @param {string} config.scriptDir - Script directory (__dirname from install.js)
     * @param {boolean} config.verbose - Verbose logging enabled
     * @param {string|null} config.customPath - Custom installation path (or null)
     * @returns {Promise<void>} - Resolves if validation passes, throws if fails
     */
    export async function validateBeforeInstall(platforms, scope, config) { ... }
    ```
    
    **Validation order (per CONTEXT.md):**
    1. Disk space check (cheapest, independent)
    2. Templates exist check (cheap, PREREQUISITE for paths)
    3. Permissions check (medium cost, independent)
    4. Path validation (expensive: 8-layer Ã— N paths)
    5. Symlink detection (expensive: lstat + readlink per target)
    
    **Error collection strategy:**
    - Use try-catch for each validator
    - Stop on prerequisite failure (templates missing â†’ skip paths)
    - Collect independent validation errors: `errors.push({ category: 'Disk', error: err })`
    - After all validations, if errors exist, throw grouped error for display
    
    **Import existing validators:**
    ```javascript
    import { checkDiskSpace, checkWritePermissions } from '../validation/pre-install-checks.js';
    import { validateAllPaths } from '../validation/path-validator.js';
    import { resolveSymlinkSingleLevel } from '../paths/symlink-resolver.js';
    import { formatPreflightReport } from './error-formatter.js';
    ```
    
    **Disk space calculation:**
    - Calculate total template size for selected platforms/scope
    - Required space = template_size * 1.5 (50% buffer per CONTEXT.md)
    - Use fs.statfs() with bavail (available to non-root) not bfree
    
    **Templates check:**
    - Verify templates/ directory exists at scriptDir
    - Check required subdirectories based on platforms/scope:
      - skills: templates/skills/
      - agents: templates/agents/
      - workflows: templates/workflows/
    
    **Symlink handling:**
    - Check target paths for symlinks (not source templates)
    - Warning with prompt (not fatal) per CONTEXT.md
    - Use existing symlink-resolver.js: resolveSymlinkSingleLevel()
    
    **Error throw pattern:**
    ```javascript
    if (errors.length > 0) {
      const report = formatPreflightReport(errors);
      throw new InstallError('VALIDATION_FAILED', report, { errors });
    }
    ```
  </action>
  <verify>
    ```bash
    # File exists
    test -f bin/lib/preflight/pre-flight-validator.js
    
    # Exports validateBeforeInstall
    grep -q "export.*validateBeforeInstall" bin/lib/preflight/pre-flight-validator.js
    
    # Imports existing validators
    grep -q "from '../validation/pre-install-checks.js'" bin/lib/preflight/pre-flight-validator.js
    grep -q "from '../validation/path-validator.js'" bin/lib/preflight/pre-flight-validator.js
    grep -q "from '../paths/symlink-resolver.js'" bin/lib/preflight/pre-flight-validator.js
    
    # Has validation order comments
    grep -q "disk.*template.*permission.*path.*symlink" bin/lib/preflight/pre-flight-validator.js
    ```
  </verify>
  <done>
    - bin/lib/preflight/pre-flight-validator.js exists
    - validateBeforeInstall() function implemented
    - Orchestrates all validators in dependency order
    - Collects errors for grouped reporting
    - Reuses existing validation modules (no duplication)
  </done>
</task>

<task name="create-error-formatter" type="auto">
  <files>bin/lib/preflight/error-formatter.js</files>
  <action>
    Create error formatter module for grouped pre-flight error display.
    
    **Function signature:**
    ```javascript
    /**
     * Format pre-flight validation errors into grouped report
     * 
     * @param {Array<Object>} errors - Collected validation errors
     * @param {string} errors[].category - Error category (Disk, Templates, Permissions, Paths, Symlinks)
     * @param {Error} errors[].error - Error object with message and details
     * @returns {string} - Formatted multi-line error report
     */
    export function formatPreflightReport(errors) { ... }
    ```
    
    **Output format (per CONTEXT.md):**
    ```
    ðŸš¨ Validation Failed
    
    Templates:
     âœ— Missing: templates/skills/
     âœ— Missing: templates/agents/
    
    Paths:
     âœ— Invalid path: ../../../etc
     | Reason: Path traversal detected
     | Fix: Use a valid installation directory
    
    Disk:
     âœ— Insufficient space: 5MB available
     | Required: 15MB (10MB templates + 50% buffer)
     | Fix: Free up disk space
    
    Permissions:
     âœ— Cannot write to: .github/
     | Reason: Permission denied
     | Fix: Run with appropriate permissions or use --custom-path
    ```
    
    **Implementation:**
    1. Group errors by category
    2. For each category with errors:
       - Print category header
       - Print each error with âœ— symbol
       - Print multi-line details with | prefix (if available)
       - Print fix suggestion with | prefix
    3. Use logger.error() formatting patterns from error-logger.js
    
    **Error detail extraction:**
    - Access error.message for main description
    - Access error.details for structured information (if InstallError)
    - Access error.fix for remediation guidance
    
    **Category order:**
    Templates â†’ Disk â†’ Permissions â†’ Paths â†’ Symlinks
    (Prerequisite checks first, then dependent checks)
  </action>
  <verify>
    ```bash
    # File exists
    test -f bin/lib/preflight/error-formatter.js
    
    # Exports formatPreflightReport
    grep -q "export.*formatPreflightReport" bin/lib/preflight/error-formatter.js
    
    # Has emoji icon
    grep -q "ðŸš¨" bin/lib/preflight/error-formatter.js
    
    # Groups by category
    grep -q "category" bin/lib/preflight/error-formatter.js
    ```
  </verify>
  <done>
    - bin/lib/preflight/error-formatter.js exists
    - formatPreflightReport() formats grouped errors
    - Output includes category headers, error symbols, fix instructions
    - Follows error-logger.js formatting patterns
  </done>
</task>

<task name="extend-error-logger" type="auto">
  <files>bin/lib/validation/error-logger.js</files>
  <action>
    Extend error-logger.js to support pre-flight error formatting if needed.
    
    **Analysis step:**
    Read existing error-logger.js to understand:
    - Current formatting patterns
    - Available helper functions
    - Whether we need to add preflight-specific utilities
    
    **Potential additions:**
    - Helper for vertical bar prefixes (| for multi-line details)
    - Helper for category headers formatting
    - Helper for fix suggestion formatting
    
    **If existing patterns sufficient:**
    - Document which functions error-formatter.js should use
    - Add JSDoc comments explaining preflight integration
    
    **If new helpers needed:**
    - Add functions following existing naming conventions
    - Keep consistent with logger.error() patterns
    - Export for use by error-formatter.js
    
    Example helper (if needed):
    ```javascript
    /**
     * Format multi-line error detail with vertical bar prefix
     * @param {string} label - Label like "Reason:" or "Fix:"
     * @param {string} detail - Detail text (may be multi-line)
     * @returns {string} - Formatted with | prefix
     */
    export function formatErrorDetail(label, detail) {
      return ` | ${label} ${detail}`;
    }
    ```
  </action>
  <verify>
    ```bash
    # File unchanged if no extensions needed
    git diff bin/lib/validation/error-logger.js
    
    # OR if extended, new exports exist
    grep -q "formatErrorDetail\|formatCategoryHeader" bin/lib/validation/error-logger.js || echo "No extensions needed"
    ```
  </verify>
  <done>
    - error-logger.js analyzed for preflight needs
    - Extensions added if needed, or documented as sufficient
    - error-formatter.js can leverage existing patterns
  </done>
</task>

## Verification Criteria

After task completion, verify:

```bash
# Module structure
test -d bin/lib/preflight
test -f bin/lib/preflight/pre-flight-validator.js
test -f bin/lib/preflight/error-formatter.js

# Exports
node -e "import('./bin/lib/preflight/pre-flight-validator.js').then(m => console.log(typeof m.validateBeforeInstall))" | grep -q "function"
node -e "import('./bin/lib/preflight/error-formatter.js').then(m => console.log(typeof m.formatPreflightReport))" | grep -q "function"

# No syntax errors
node --check bin/lib/preflight/pre-flight-validator.js
node --check bin/lib/preflight/error-formatter.js

# Imports resolve
cd bin/lib/preflight && node -e "
  import('./pre-flight-validator.js').then(() => console.log('âœ“ Validator imports OK')).catch(e => { console.error('âœ—', e.message); process.exit(1); })
"
```

## Success Criteria

This plan succeeds when:

1. **Module created:** `bin/lib/preflight/` directory with orchestrator and formatter
2. **Orchestrator functional:** validateBeforeInstall() coordinates all validators
3. **Validation order:** Cheap-first (disk, templates) then expensive (paths, symlinks)
4. **Error collection:** Independent errors grouped by category
5. **Prerequisite handling:** Stops on template failure (can't validate paths without templates)
6. **Reuse pattern:** Imports and delegates to existing validators (no duplication)
7. **Error formatting:** Grouped output with category headers and fix instructions
8. **No breaking changes:** Existing validators unchanged
9. **Export clean:** Both modules export promised functions

## Output

**Files created:**
- `bin/lib/preflight/pre-flight-validator.js` - Orchestrator with validateBeforeInstall()
- `bin/lib/preflight/error-formatter.js` - Grouped error reporter

**Files modified:**
- `bin/lib/validation/error-logger.js` - Extended with preflight formatting helpers (if needed)

**Ready for:** Plan 02 (Integration + Cleanup) which will wire orchestrator into install.js and remove redundant validation from orchestrator.js.
