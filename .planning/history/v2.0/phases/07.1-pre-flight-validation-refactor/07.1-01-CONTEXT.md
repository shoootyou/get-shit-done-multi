---
phase: 07.1
discussed: 2026-01-29T00:26:00Z
areas: ['Error Reporting & Formatting', 'Validation Orchestration Flow', 'Integration with Existing Code', 'Test Strategy & Coverage']
decisions_count: 16
---

# Phase 7.1 Context: Pre-Flight Validation Refactor

## Essential Features

### Validation Orchestration
- Create `bin/lib/preflight/pre-flight-validator.js` with `validateBeforeInstall()` function
- Run all validation before any installation work begins
- Call from `install.js` at line ~102 (after banner/migration, before runInteractive/executeInstallationLoop)
- Validation order: disk â†’ templates â†’ permissions â†’ paths â†’ symlinks (cheap-first)
- Stop at first fatal error (fail-fast execution)
- Skip dependent validations when prerequisite fails (e.g., paths need templates)

### Error Reporting
- Group errors by category: Templates / Paths / Disk / Permissions / Symlinks
- User-friendly format: what's wrong + how to fix (no technical implementation details)
- Use `logger.error()` with vertical bars for multiline messages
- Display grouped report with category headers
- Extend `error-logger.js` with `formatPreflightReport(errors)` for grouped output

### Severity Handling
- **Fatal errors** (stop installation):
  - Missing templates directory
  - Path traversal detected
  - Insufficient disk space (< source size + 50%)
  - Permission denied errors
- **Warning with prompt** (can proceed with confirmation):
  - Symlink detected in target path
- **Explicitly excluded** from preflight validation:
  - Old version detection (handled separately by Phase 6 migration logic)

### Disk Space Calculation
- Calculate: total source template size + 50% buffer
- Reject installation if available space < required space
- Formula: `required = templates_size * 1.5`

## Technical Boundaries

### Architecture Decisions
- **New module location**: `bin/lib/preflight/` (independent domain like `updater/`)
- **Transversal modules stay**: `validation/pre-install-checks.js` remains in `validation/` (called by preflight)
- **Single-point validation**: No defense-in-depth redundancy
- **Error communication**: Functions throw errors immediately on failure (no return booleans)

### Code Removal
- **Remove from orchestrator.js**:
  - Batch path validation (lines 263-285)
  - Per-file validation (if implemented)
- **Simplify orchestrator**: Only load templates, process files, generate manifests (no validation)

### Module Reuse
- `preflight/` **uses** (does not duplicate):
  - `validation/pre-install-checks.js` - disk, permissions, existing install
  - `validation/path-validator.js` - 8-layer path security
  - `paths/symlink-resolver.js` - symlink detection
  - `validation/error-logger.js` - error formatting (extend with preflight formatter)

## Scope Limits

### Out of Scope for This Phase
- Changing validation logic (path security, disk checks, etc.) - use existing implementations
- Adding new validation types beyond what exists in Phase 7
- Modifying migration/version detection (Phase 6 responsibility)
- Performance optimization of validation algorithms
- Rollback/cleanup logic (handled by existing transaction system)

### Deferred Features
- Per-validation timing/metrics (could add in future)
- Validation result caching (run once per session)
- Parallel validation execution (keep sequential for now)
- Verbose mode details per validation (keep simple)

## Implementation Decisions

### Validation Order Rationale
1. **Disk space** - cheapest, fails early if no space
2. **Templates** - fast stat check, required for path validation
3. **Permissions** - medium cost, creates temp file
4. **Paths** - 8-layer validation Ã— N paths
5. **Symlinks** - lstat + readlink per target

### Error Grouping Structure
```
ðŸš¨ Validation Failed

Templates:
 âœ— Missing: templates/skills/
 âœ— Missing: templates/agents/

Paths:
 âœ— Invalid path: ../../../etc
 | Reason: Path traversal detected
 | Fix: Use a valid installation directory

Disk:
 âœ— Insufficient space: 5MB available
 | Required: 15MB (10MB templates + 50% buffer)
 | Fix: Free up disk space

Permissions:
 âœ— Cannot write to: .github/
 | Reason: Permission denied
 | Fix: Run with appropriate permissions or use --custom-path
```

### Integration Point
```javascript
// install.js ~line 102
showTemplatePath(__dirname);

// NEW: Pre-flight validation gate
await validateBeforeInstall(platforms, scope, {
  scriptDir: __dirname,
  verbose: options.verbose || false,
  customPath: options.customPath || null
});

// Proceed to installation only if validation passes
if (shouldUseInteractiveMode(...)) {
  await runInteractive(...);
} else {
  await executeInstallationLoop(...);
}
```

## Testing Strategy

### Coverage
- **Comprehensive matrix**: 20+ test scenarios
- Each validation type Ã— each error condition
- Success cases + multi-error combinations
- Edge cases (barely enough disk, symlink chains, etc.)

### Test Setup
- **Script-based setup**: Each test has setup function
- **Test runner**: Bash script `run-all-tests.sh`
- **Isolation**: Each test in `/tmp/gsd-test-preflight-{scenario}/`
- **Protection**: Copy full project to /tmp (never touch source)

### Test Scenarios (Examples)
```
/tmp/gsd-test-preflight-success/           # All validation passes
/tmp/gsd-test-preflight-no-disk/           # Insufficient disk space
/tmp/gsd-test-preflight-no-templates/      # Missing templates directory
/tmp/gsd-test-preflight-no-permissions/    # Permission denied
/tmp/gsd-test-preflight-bad-paths/         # Path traversal attempt
/tmp/gsd-test-preflight-symlinks/          # Symlink detected
/tmp/gsd-test-preflight-multi-error/       # Multiple failures
/tmp/gsd-test-preflight-edge-disk/         # Barely enough disk
/tmp/gsd-test-preflight-broken-symlink/    # Broken symlink
... 15+ more scenarios
```

### Test Verification
- **Integration tests**: Execute `install.js` directly
- **Assertions**: Verify error messages match expected output
- **Exit codes**: Check installation fails/succeeds appropriately
- **Example**:
  ```bash
  output=$(node /tmp/test-xyz/bin/install.js --copilot 2>&1)
  if echo "$output" | grep -q "Missing: templates/"; then
    echo "âœ“ Correct error message"
  else
    echo "âœ— Expected error message not found"
    exit 1
  fi
  ```

### Test Organization
```bash
# tests/integration/preflight/
â”œâ”€â”€ run-all-tests.sh          # Main test runner
â”œâ”€â”€ setup-scenarios.sh        # Setup functions for each scenario
â”œâ”€â”€ test-success.sh           # Individual test scripts
â”œâ”€â”€ test-no-disk.sh
â”œâ”€â”€ test-no-templates.sh
â”œâ”€â”€ test-bad-paths.sh
â””â”€â”€ ... (one per scenario)
```

## Open Questions for Research

1. **Error message templates**: Should we have a standard format/template for each validation error type?
2. **Disk space calculation accuracy**: How to handle sparse files, compression, filesystem overhead?
3. **Symlink prompt UX**: Exact wording for symlink confirmation prompt (interactive vs --force flag)
4. **Test automation**: Integration with existing vitest suite, or keep bash-based?
5. **Performance baseline**: What's acceptable validation time? (aim for < 500ms total?)

## Dependencies

**Requires (Phase 7 completed)**:
- `bin/lib/validation/path-validator.js` (8-layer validation)
- `bin/lib/paths/symlink-resolver.js` (symlink detection)
- `bin/lib/validation/pre-install-checks.js` (disk, permissions)
- `bin/lib/validation/error-logger.js` (error formatting)

**No breaking changes to**:
- Phase 6 migration/version detection (explicitly separate concern)
- Phase 5 transaction system (preflight runs before transactions begin)
- Phase 7 path security (reuse as-is, don't modify)
