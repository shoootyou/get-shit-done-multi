---
phase: 07.1-pre-flight-validation-refactor
plan: 01
subsystem: validation
tags: [validation, error-handling, orchestration, preflight, node-fs]

# Dependency graph
requires:
  - phase: 07-path-security-and-validation
    provides: Path validator, symlink resolver, pre-install-checks modules
provides:
  - Pre-flight validation orchestrator (validateBeforeInstall)
  - Grouped error formatter for validation reports
  - Centralized validation gate before installation
affects: [08-atomic-transactions, installation-flow, error-reporting]

# Tech tracking
tech-stack:
  added: []
  patterns: 
    - Pre-flight validation orchestration (fail-fast prerequisites, fail-slow reporting)
    - Dependency-ordered validation (cheap-first, prerequisites before dependents)
    - Grouped error reporting by category

key-files:
  created:
    - bin/lib/preflight/pre-flight-validator.js
    - bin/lib/preflight/error-formatter.js
  modified:
    - bin/lib/validation/error-logger.js

key-decisions:
  - "Fail-fast on prerequisite failures (templates missing → skip path validation)"
  - "Collect independent validation errors for grouped display"
  - "Validation order: disk → templates → permissions → paths → symlinks (cheap-first)"
  - "Use 50% disk space buffer (increased from 10% in pre-install-checks.js)"
  - "Symlinks are warnings, not fatal errors"

patterns-established:
  - "Pre-flight orchestrator pattern: coordinate existing validators, don't duplicate logic"
  - "Error collection pattern: separate warnings (code 0) from fatal errors"
  - "Category-grouped error reporting: Templates → Disk → Permissions → Paths → Symlinks"

# Metrics
duration: 4min
completed: 2026-01-29
---

# Phase 07.1 Plan 01: Pre-Flight Validation Orchestrator Summary

**Pre-flight validation orchestrator with fail-fast prerequisite handling, dependency-ordered checks, and grouped error reporting**

## Performance

- **Duration:** 4 min
- **Started:** 2026-01-29T01:28:13Z
- **Completed:** 2026-01-29T01:32:00Z
- **Tasks:** 3
- **Files created:** 2
- **Files modified:** 1

## Accomplishments

- Created centralized pre-flight validation orchestrator that runs all checks before installation begins
- Implemented dependency-ordered validation: cheap-first (disk, templates) then expensive (paths with 8-layer checks, symlinks)
- Built grouped error formatter that collects errors by category with user-friendly messages and fix instructions
- Established fail-fast pattern for prerequisite failures (templates missing → skip path validation)
- Reused existing validators (checkDiskSpace, checkWritePermissions, validateAllPaths, resolveSymlinkSingleLevel) with no duplication

## Task Commits

Each task was committed atomically:

1. **Task 1: Create pre-flight orchestrator** - `509efda` (feat)
2. **Task 2: Create error formatter** - `2d10cf7` (feat)
3. **Task 3: Extend error-logger** - `51e604c` (docs)

## Files Created/Modified

**Created:**
- `bin/lib/preflight/pre-flight-validator.js` - Orchestrates all validation checks in dependency order with error collection
- `bin/lib/preflight/error-formatter.js` - Formats grouped validation errors with category headers and fix suggestions

**Modified:**
- `bin/lib/validation/error-logger.js` - Added JSDoc documenting pre-flight integration (no functional changes needed)

## Decisions Made

**1. Fail-fast on prerequisite failures**
- Templates missing → skip path validation (can't validate paths without knowing what templates exist)
- Broken symlinks → error immediately (can't proceed with invalid target)
- Rationale: Prerequisite failures make dependent validations meaningless

**2. Fail-slow for independent errors**
- Collect all independent validation errors (disk, permissions, multiple invalid paths)
- Display grouped report showing all issues at once
- Rationale: Better UX - user sees all problems, fixes them all, retries once (not whack-a-mole)

**3. Validation order: cheap-first**
- Order: disk (statfs) → templates (pathExists) → permissions (write test) → paths (8-layer × N) → symlinks (lstat + readlink)
- Rationale: Fail early on cheap checks before expensive operations

**4. Increased disk space buffer to 50%**
- Previous: 10% buffer in pre-install-checks.js
- Now: 50% buffer in pre-flight-validator.js
- Rationale: Per CONTEXT.md guidance, more conservative for safety

**5. Symlinks as warnings, not fatal**
- Symlink detection returns code 0 (warning) not error code
- User sees warning but installation can proceed
- Rationale: Symlinks are valid paths, just need user awareness

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all validators imported cleanly, syntax checks passed, no integration issues.

## Next Phase Readiness

**Ready for Plan 02 (Integration + Cleanup):**
- Pre-flight orchestrator module complete and tested
- Error formatter produces grouped reports
- Ready to wire into install.js as first step
- Ready to remove redundant validation from orchestrator.js

**No blockers:**
- All existing validators reused successfully
- No breaking changes to existing modules
- Export signatures match plan specifications

**Integration points for next plan:**
- Call validateBeforeInstall() at start of install.js (before any work begins)
- Catch InstallError and display formatted report
- Remove duplicate validation calls from orchestrator.js after integration confirmed

---

*Phase: 07.1-pre-flight-validation-refactor*  
*Completed: 2026-01-29*
