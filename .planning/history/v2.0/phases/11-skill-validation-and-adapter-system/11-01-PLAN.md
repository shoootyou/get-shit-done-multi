---
phase: 11-skill-validation-and-adapter-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - bin/lib/frontmatter/base-validator.js
  - bin/lib/frontmatter/validation-error.js
  - bin/lib/frontmatter/field-validators.js
autonomous: true

must_haves:
  truths:
    - "Joi 18.0.2 installed and available for schema validation"
    - "Base validator defines template method pattern for validation flow"
    - "Validation errors include all required context (template, field, value, spec URL)"
    - "Field validators enforce agentskills.io spec rules"
    - "Name field validation rejects quotes, enforces 1-64 chars, letters/numbers/hyphens only"
    - "Description field validation enforces max 1024 chars, single line, no special chars"
  artifacts:
    - path: "package.json"
      provides: "Joi dependency declaration"
      contains: '"joi": "18.0.2"'
    - path: "bin/lib/frontmatter/base-validator.js"
      provides: "Abstract base class with template method pattern"
      exports: ["BaseValidator"]
      min_lines: 80
    - path: "bin/lib/frontmatter/validation-error.js"
      provides: "Custom error class with formatted console output"
      exports: ["ValidationError"]
      min_lines: 60
    - path: "bin/lib/frontmatter/field-validators.js"
      provides: "Joi schemas for name, description, frontmatter structure"
      exports: ["validateName", "validateDescription", "validateStructure"]
      min_lines: 50
  key_links:
    - from: "bin/lib/frontmatter/base-validator.js"
      to: "bin/lib/frontmatter/field-validators.js"
      via: "imports validation functions"
      pattern: "import.*from.*field-validators"
    - from: "bin/lib/frontmatter/base-validator.js"
      to: "bin/lib/frontmatter/validation-error.js"
      via: "throws ValidationError on failures"
      pattern: "throw new ValidationError"
---

<objective>
Create validation foundation layer with Joi schema library, base validator interface, validation error class, and field-level validators.

**Purpose:** Establish core validation infrastructure that platform-specific validators will extend. This layer enforces agentskills.io base spec rules (name, description, frontmatter structure).

**Output:** 
- Joi 18.0.2 installed as production dependency
- Base validator with template method pattern (structure → required → optional → unknown)
- ValidationError class with formatted console output
- Field validators using Joi schemas for name/description validation
</objective>

<execution_context>
@.github/get-shit-done/workflows/execute-plan.md
@.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-skill-validation-and-adapter-system/11-01-CONTEXT.md
@.planning/phases/11-skill-validation-and-adapter-system/11-RESEARCH.md

# Existing infrastructure
@bin/lib/platforms/base-adapter.js
@bin/lib/platforms/platform-names.js
@bin/lib/errors/install-error.js
@bin/lib/installer/install-skills.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Joi and create base validator with validation error class</name>
  <files>
    package.json
    package-lock.json
    bin/lib/frontmatter/base-validator.js
    bin/lib/frontmatter/validation-error.js
  </files>
  <action>
Install Joi 18.0.2 as production dependency:
```bash
npm install joi@18.0.2
```

Create `bin/lib/frontmatter/validation-error.js`:
- Export `ValidationError` class extending `Error`
- Constructor accepts: `message` (string), `details` (object with template, platform, field, value, expected, spec)
- Method `toConsoleOutput()` returns formatted string with:
  - Header with emoji: "❌ VALIDATION ERROR" with decorative line
  - Context: template name, platform, field name
  - Error message
  - Actual value (if provided)
  - Expected format (if provided)
  - Spec URL (if provided)
  - Installation stopped message
  - Report URL: https://github.com/shoootyou/get-shit-done-multi/issues
  - System info: package version, Node version
  - Footer decorative line
- Follow error format patterns from existing `bin/lib/errors/install-error.js`

Create `bin/lib/frontmatter/base-validator.js`:
- Export `BaseValidator` class
- Constructor accepts `platform` (string)
- Method `validate(frontmatter, context)` orchestrates validation flow (template method pattern):
  1. Call `validateStructure(frontmatter, context)` - shared implementation
  2. Call `validateRequiredFields(frontmatter, context)` - shared implementation  
  3. Call `validateOptionalFields(frontmatter, context)` - hook for subclasses (throw if not overridden)
  4. Call `validateUnknownFields(frontmatter, context)` - hook for subclasses (throw if not overridden)
- Method `validateStructure(frontmatter, context)` checks:
  - Frontmatter is object (not null/undefined)
  - Frontmatter is not empty object
  - Throws ValidationError with proper context if invalid
- Method `validateRequiredFields(frontmatter, context)` delegates to field validators (placeholder - will use field-validators.js in Task 2)
- Hook methods `validateOptionalFields()` and `validateUnknownFields()` throw error "must be implemented by subclass"
- Use `abortEarly: true` philosophy (fail-fast on first error)
- Reference agentskills.io spec URL: https://agentskills.io/specification

Context parameter shape: `{ templateName: string, filePath: string }`
  </action>
  <verify>
```bash
# Verify Joi installed
grep '"joi"' package.json

# Verify files created
ls -la bin/lib/frontmatter/base-validator.js bin/lib/frontmatter/validation-error.js

# Verify exports
grep "export class ValidationError" bin/lib/frontmatter/validation-error.js
grep "export class BaseValidator" bin/lib/frontmatter/base-validator.js

# Verify ValidationError has required methods
grep "toConsoleOutput()" bin/lib/frontmatter/validation-error.js

# Verify BaseValidator has template method structure
grep "validate(frontmatter, context)" bin/lib/frontmatter/base-validator.js
grep "validateStructure" bin/lib/frontmatter/base-validator.js
grep "validateRequiredFields" bin/lib/frontmatter/base-validator.js
```
  </verify>
  <done>
- Joi 18.0.2 listed in package.json dependencies
- ValidationError class with toConsoleOutput() method formatting all required context
- BaseValidator class with template method pattern (validate, validateStructure, validateRequiredFields, hook methods)
- Files follow ESM import/export patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Create field validators with Joi schemas</name>
  <files>
    bin/lib/frontmatter/field-validators.js
    bin/lib/frontmatter/base-validator.js
  </files>
  <action>
Create `bin/lib/frontmatter/field-validators.js`:
- Import Joi from 'joi'
- Export function `validateName(value, context)`:
  - Creates Joi schema: `Joi.string().min(1).max(64).pattern(/^[a-zA-Z0-9-]+$/).required()`
  - Custom messages:
    - `string.pattern.base`: "Name must contain only letters, numbers, and hyphens"
    - `string.max`: "Name must be 1-64 characters"
    - `any.required`: "Name field is required"
  - Validates with `{ abortEarly: true }`
  - On error: throw ValidationError with field='name', spec='https://agentskills.io/specification#name-field'
  - Returns validated value on success

- Export function `validateDescription(value, context)`:
  - Creates Joi schema: `Joi.string().min(1).max(1024).pattern(/^[a-zA-Z0-9\s\-.,()]+$/).required()`
  - Pattern allows: letters, numbers, spaces, hyphens, periods, commas, parentheses
  - Custom messages:
    - `string.pattern.base`: "Description contains invalid characters (only letters, numbers, spaces, hyphens, periods, commas, parentheses allowed)"
    - `string.max`: "Description must be maximum 1024 characters"
    - `any.required`: "Description field is required"
  - Validates with `{ abortEarly: true }`
  - On error: throw ValidationError with field='description', spec='https://agentskills.io/specification'
  - Returns validated value on success

- Export function `validateStructure(frontmatter, context)`:
  - Check frontmatter is object and not empty
  - Throw ValidationError if invalid
  - Used by base validator's validateStructure method

Update `bin/lib/frontmatter/base-validator.js`:
- Import validation functions from field-validators.js
- Update `validateRequiredFields(frontmatter, context)` implementation:
  - Call `validateName(frontmatter.name, context)` 
  - Call `validateDescription(frontmatter.description, context)`
  - Catch and re-throw ValidationError (already formatted)
  - On success, validation passes silently

Important: 
- All validators use fail-fast approach (throw on first error)
- ValidationError already imported from validation-error.js
- Context object includes { templateName, filePath, platform }
  </action>
  <verify>
```bash
# Verify file created
ls -la bin/lib/frontmatter/field-validators.js

# Verify exports
grep "export function validateName" bin/lib/frontmatter/field-validators.js
grep "export function validateDescription" bin/lib/frontmatter/field-validators.js
grep "export function validateStructure" bin/lib/frontmatter/field-validators.js

# Verify Joi usage
grep "import.*Joi.*from.*'joi'" bin/lib/frontmatter/field-validators.js
grep "Joi.string()" bin/lib/frontmatter/field-validators.js

# Verify base validator integration
grep "import.*field-validators" bin/lib/frontmatter/base-validator.js
grep "validateName" bin/lib/frontmatter/base-validator.js
grep "validateDescription" bin/lib/frontmatter/base-validator.js

# Test basic validation with Node
node -e "
  import('./bin/lib/frontmatter/field-validators.js').then(mod => {
    try {
      mod.validateName('gsd-test', { templateName: 'test', filePath: 'test.md', platform: 'claude' });
      console.log('✓ Valid name passes');
    } catch (e) {
      console.error('✗ Valid name failed:', e.message);
      process.exit(1);
    }
    
    try {
      mod.validateName('invalid name!', { templateName: 'test', filePath: 'test.md', platform: 'claude' });
      console.error('✗ Invalid name should fail');
      process.exit(1);
    } catch (e) {
      console.log('✓ Invalid name rejected');
    }
  });
"
```
  </verify>
  <done>
- field-validators.js exports validateName, validateDescription, validateStructure
- Each validator uses Joi with fail-fast mode
- Name validator enforces 1-64 chars, alphanumeric + hyphens only
- Description validator enforces max 1024 chars, safe characters only
- BaseValidator's validateRequiredFields() calls field validators
- Basic validation test passes (valid accepts, invalid rejects)
  </done>
</task>

</tasks>

<verification>
After completion, verify validation foundation:

```bash
# 1. Dependency installed
npm list joi

# 2. All files exist
ls -la bin/lib/frontmatter/*.js

# 3. Imports work
node -e "import('./bin/lib/frontmatter/base-validator.js').then(() => console.log('✓ Imports valid'))"

# 4. Test validation error formatting
node -e "
  import('./bin/lib/frontmatter/validation-error.js').then(mod => {
    const err = new mod.ValidationError('Test error', {
      template: 'gsd-test',
      platform: 'claude', 
      field: 'name',
      value: 'bad!name',
      spec: 'https://agentskills.io/specification'
    });
    const output = err.toConsoleOutput();
    console.log(output);
    if (output.includes('❌ VALIDATION ERROR')) console.log('✓ Error format valid');
  });
"

# 5. Test base validator structure
node -e "
  import('./bin/lib/frontmatter/base-validator.js').then(mod => {
    const validator = new mod.BaseValidator('test');
    console.log('✓ BaseValidator instantiates');
    console.log('Methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(validator)));
  });
"
```

Expected state:
- Joi 18.0.2 in dependencies
- 3 new files in bin/lib/frontmatter/
- ValidationError formats errors with all context
- BaseValidator provides template method pattern
- Field validators enforce agentskills.io spec
</verification>

<success_criteria>
Foundation validation layer complete when:

1. **Joi installed:** `npm list joi` shows version 18.0.2
2. **BaseValidator created:** Template method pattern with validate(), validateStructure(), validateRequiredFields(), hook methods
3. **ValidationError created:** toConsoleOutput() method formats errors with template, platform, field, value, spec URL, system info, report URL
4. **Field validators created:** validateName() and validateDescription() use Joi schemas with fail-fast mode
5. **Name validation enforces:**
   - 1-64 characters length
   - Only letters, numbers, hyphens
   - Required field
6. **Description validation enforces:**
   - Max 1024 characters
   - Only safe characters (letters, numbers, spaces, basic punctuation)
   - Required field
7. **Integration wired:** BaseValidator.validateRequiredFields() calls field validators
8. **All files use ESM:** import/export syntax throughout
9. **Verification tests pass:** Basic validation accepts valid values, rejects invalid values
</success_criteria>

<output>
After completion, create `.planning/phases/11-skill-validation-and-adapter-system/11-01-SUMMARY.md`

Document:
- Joi installation and version
- Validation architecture (base validator, field validators, error class)
- Validation rules implemented (name, description specs)
- Template method pattern explanation
- Files created and their exports
- Next step: Create platform-specific validators in 11-02
</output>
