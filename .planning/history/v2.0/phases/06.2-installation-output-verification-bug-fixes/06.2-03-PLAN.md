---
phase: 06.2-installation-output-verification-bug-fixes
plan: 03
type: execute
wave: 3
depends_on: [06.2-02]
files_modified:
  - bin/lib/installer/orchestrator.js
  - tests/integration/installation-output.test.js
autonomous: true
must_haves:
  - type: behavioral
    truths:
      - "All template variables replaced in get-shit-done/ directory files"
      - "Recursive processing handles all text file types (.md, .json, .sh, .yml, .yaml, .txt, .bash, .config)"
      - "Binary files skipped with verbose logging"
      - "JSON/YAML files validated after variable replacement"
      - "Integration tests verify all 13 agents × 3 platforms = 39 combinations"
      - "Tests assert skills field present in Claude, absent in Copilot/Codex"
      - "Tests assert tools format correct for each platform"
      - "No {{VARIABLES}} remain after installation"
  - type: artifact
    files:
      - bin/lib/installer/orchestrator.js (recursive processing in installShared)
      - tests/integration/installation-output.test.js (comprehensive output verification)
  - type: integration
    key_links:
      - "orchestrator.installShared() recursively processes all text files"
      - "Integration tests run actual installations to /tmp test directories"
      - "Tests parse installed agent frontmatter and verify structure"
      - "Tests verify no unreplaced variables in any installed files"
---

# Plan 06.2-03: Recursive Variable Replacement & Comprehensive Integration Tests

**Objective:** Fix template variable replacement in shared directory and create comprehensive integration tests verifying all bug fixes

**Context:** Two remaining critical bugs:
1. Template variables only replaced in manifest file, not recursively in all get-shit-done/ files
2. No integration tests verifying actual installation output

This plan fixes recursive processing and creates exhaustive tests covering all 39 agent×platform combinations to prevent regressions.

## Tasks

<task name="implement-recursive-variable-replacement" type="auto">
  <files>bin/lib/installer/orchestrator.js</files>
  <action>
    Enhance `installShared()` function to recursively process all text files for template variable replacement.

    **Current code (lines ~306-324):**
    ```javascript
    async function installShared(templatesDir, targetDir, variables, multiBar, isVerbose) {
      const sharedTemplateDir = join(templatesDir, 'get-shit-done');
      const sharedTargetDir = join(targetDir, 'get-shit-done');
      
      logger.verboseInProgress('get-shit-done/', isVerbose);
      
      // Copy entire directory
      await copyDirectory(sharedTemplateDir, sharedTargetDir);
      
      // Process manifest template
      const manifestFile = join(sharedTargetDir, '.gsd-install-manifest.json');
      if (await pathExists(manifestFile)) {
        await processTemplateFile(manifestFile, variables, isVerbose);
      }
      
      logger.verboseComplete(isVerbose);
      
      return 1;
    }
    ```

    **Replace with:**
    ```javascript
    async function installShared(templatesDir, targetDir, variables, multiBar, isVerbose) {
      const sharedTemplateDir = join(templatesDir, 'get-shit-done');
      const sharedTargetDir = join(targetDir, 'get-shit-done');
      
      logger.verboseInProgress('get-shit-done/', isVerbose);
      
      // Copy entire directory
      await copyDirectory(sharedTemplateDir, sharedTargetDir);
      
      // Process all text files recursively for template variables
      await processDirectoryRecursively(sharedTargetDir, variables, isVerbose);
      
      logger.verboseComplete(isVerbose);
      
      return 1;
    }
    ```

    **Add new function before installShared():**
    ```javascript
    /**
     * Text file extensions to process for template variables
     */
    const TEXT_EXTENSIONS = new Set([
      '.md', '.json', '.sh', '.bash', '.txt',
      '.yml', '.yaml', '.config', '.js', '.mjs',
      '.ts', '.html', '.css', '.xml'
    ]);
    
    /**
     * Recursively process all text files in directory for template variables
     * @param {string} dir - Directory to process
     * @param {Object} variables - Template variables to replace
     * @param {boolean} isVerbose - Verbose logging
     */
    async function processDirectoryRecursively(dir, variables, isVerbose) {
      const entries = await readdir(dir, { withFileTypes: true, recursive: true });
      
      for (const entry of entries) {
        const fullPath = join(dir, entry.name);
        
        if (entry.isDirectory()) {
          continue; // recursive: true handles subdirectories
        }
        
        // Check if text file by extension
        const ext = entry.name.substring(entry.name.lastIndexOf('.'));
        if (!TEXT_EXTENSIONS.has(ext)) {
          if (isVerbose) {
            logger.verboseInProgress(`Skipping binary: ${entry.name}`, isVerbose);
          }
          continue;
        }
        
        // Process text file
        try {
          const content = await readFile(fullPath, 'utf8');
          const processed = replaceVariables(content, variables);
          
          // Validate JSON/YAML after replacement
          if (ext === '.json') {
            try {
              JSON.parse(processed);
            } catch (error) {
              throw new Error(`Invalid JSON after variable replacement in ${entry.name}: ${error.message}`);
            }
          } else if (ext === '.yml' || ext === '.yaml') {
            try {
              // Use js-yaml from gray-matter dependency
              const yaml = await import('js-yaml');
              yaml.load(processed);
            } catch (error) {
              throw new Error(`Invalid YAML after variable replacement in ${entry.name}: ${error.message}`);
            }
          }
          
          await writeFile(fullPath, processed);
          
          if (isVerbose) {
            logger.verboseInProgress(`Processed: ${entry.name}`, isVerbose);
          }
        } catch (error) {
          // Re-throw with context
          throw new Error(`Failed to process ${entry.name}: ${error.message}`);
        }
      }
    }
    ```

    **Note:** Node.js 16.7+ supports `{ recursive: true }` option in `readdir()`, which is our project requirement.

    Add import for js-yaml if not already present:
    ```javascript
    import yaml from 'js-yaml';
    ```
  </action>
  <verify>
    ```bash
    # Verify function exists
    grep -A 5 "processDirectoryRecursively" bin/lib/installer/orchestrator.js
    
    # Verify TEXT_EXTENSIONS defined
    grep "TEXT_EXTENSIONS" bin/lib/installer/orchestrator.js
    ```
  </verify>
  <done>
    - processDirectoryRecursively() function added
    - TEXT_EXTENSIONS set defined with all common text file types
    - installShared() calls recursive processing
    - JSON/YAML validation after replacement
    - Binary files skipped with verbose logging
  </done>
</task>

<task name="create-comprehensive-integration-tests" type="auto">
  <files>tests/integration/installation-output.test.js</files>
  <action>
    Create comprehensive integration test file covering all bug fixes:

    **Test structure:**
    ```javascript
    import { describe, test, expect, beforeAll, afterAll } from 'vitest';
    import { join } from 'path';
    import { mkdtemp, rm, readFile, readdir } from 'fs/promises';
    import { tmpdir } from 'os';
    import matter from 'gray-matter';
    import { install } from '../../bin/lib/installer/orchestrator.js';
    import { ClaudeAdapter } from '../../bin/lib/platforms/claude-adapter.js';
    import { CopilotAdapter } from '../../bin/lib/platforms/copilot-adapter.js';
    import { CodexAdapter } from '../../bin/lib/platforms/codex-adapter.js';
    
    describe('Installation Output Verification', () => {
      let testDir;
      const scriptDir = join(process.cwd(), 'bin');
      
      beforeAll(async () => {
        testDir = await mkdtemp(join(tmpdir(), 'gsd-output-test-'));
      });
      
      afterAll(async () => {
        await rm(testDir, { recursive: true, force: true });
      });
      
      // Test 1: Claude agents include skills field
      describe('Claude Platform', () => {
        test('all 13 agents include skills field in frontmatter', async () => {
          const claudeDir = join(testDir, 'claude');
          await install('2.0.0', {
            platform: 'claude',
            adapter: new ClaudeAdapter(),
            isGlobal: false,
            isVerbose: false,
            scriptDir,
            targetDir: claudeDir,
            skipPrompts: true
          });
          
          const agentsDir = join(claudeDir, 'agents');
          const agentFiles = await readdir(agentsDir);
          const agents = agentFiles.filter(f => f.startsWith('gsd-') && f.endsWith('.md'));
          
          expect(agents).toHaveLength(13); // All 13 agents installed
          
          for (const agentFile of agents) {
            const content = await readFile(join(agentsDir, agentFile), 'utf8');
            const { data } = matter(content);
            
            // Skills field must exist
            expect(data).toHaveProperty('skills');
            expect(Array.isArray(data.skills)).toBe(true);
            
            // If agent references skills, they should be listed
            // (extractSkillReferences should have found them)
          }
        });
      });
      
      // Test 2: Copilot agents exclude skills field
      describe('Copilot Platform', () => {
        test('all 13 agents exclude skills field from frontmatter', async () => {
          const copilotDir = join(testDir, 'copilot');
          await install('2.0.0', {
            platform: 'copilot',
            adapter: new CopilotAdapter(),
            isGlobal: false,
            isVerbose: false,
            scriptDir,
            targetDir: copilotDir,
            skipPrompts: true
          });
          
          const agentsDir = join(copilotDir, 'agents');
          const agentFiles = await readdir(agentsDir);
          const agents = agentFiles.filter(f => f.startsWith('gsd-') && f.endsWith('.agent.md'));
          
          expect(agents).toHaveLength(13);
          
          for (const agentFile of agents) {
            const content = await readFile(join(agentsDir, agentFile), 'utf8');
            const { data } = matter(content);
            
            // Skills field must NOT exist (negative assertion)
            expect(data).not.toHaveProperty('skills');
          }
        });
        
        test('tools field uses single-line array format', async () => {
          const copilotDir = join(testDir, 'copilot');
          const agentsDir = join(copilotDir, 'agents');
          const agentFiles = await readdir(agentsDir);
          const agents = agentFiles.filter(f => f.startsWith('gsd-') && f.endsWith('.agent.md'));
          
          for (const agentFile of agents) {
            const content = await readFile(join(agentsDir, agentFile), 'utf8');
            const { data } = matter(content);
            
            if (data.tools && data.tools.length > 0) {
              // Parse raw frontmatter to check format
              const toolsLine = content.match(/^tools: (.+)$/m);
              expect(toolsLine).not.toBeNull();
              
              // Should be single-line array: ['tool-a', 'tool-b']
              expect(toolsLine[1]).toMatch(/^\['.+'\]$/);
            }
          }
        });
      });
      
      // Test 3: Codex agents exclude skills field
      describe('Codex Platform', () => {
        test('all 13 agents exclude skills field from frontmatter', async () => {
          const codexDir = join(testDir, 'codex');
          await install('2.0.0', {
            platform: 'codex',
            adapter: new CodexAdapter(),
            isGlobal: false,
            isVerbose: false,
            scriptDir,
            targetDir: codexDir,
            skipPrompts: true
          });
          
          const agentsDir = join(codexDir, 'agents');
          const agentFiles = await readdir(agentsDir);
          const agents = agentFiles.filter(f => f.startsWith('gsd-') && f.endsWith('.agent.md'));
          
          expect(agents).toHaveLength(13);
          
          for (const agentFile of agents) {
            const content = await readFile(join(agentsDir, agentFile), 'utf8');
            const { data } = matter(content);
            
            // Skills field must NOT exist
            expect(data).not.toHaveProperty('skills');
          }
        });
      });
      
      // Test 4: Template variable replacement in get-shit-done/
      describe('Template Variable Replacement', () => {
        test('all text files in get-shit-done/ have variables replaced', async () => {
          const platforms = ['claude', 'copilot', 'codex'];
          
          for (const platform of platforms) {
            const platformDir = join(testDir, platform);
            const sharedDir = join(platformDir, 'get-shit-done');
            
            // Recursively read all files
            const files = await readdir(sharedDir, { withFileTypes: true, recursive: true });
            
            for (const file of files) {
              if (file.isDirectory()) continue;
              
              const fullPath = join(sharedDir, file.name);
              const ext = file.name.substring(file.name.lastIndexOf('.'));
              
              // Only check text files
              if (['.md', '.json', '.sh', '.bash', '.txt', '.yml', '.yaml'].includes(ext)) {
                const content = await readFile(fullPath, 'utf8');
                
                // No unreplaced variables should remain
                const unreplacedVars = content.match(/{{[A-Z_]+}}/g);
                expect(unreplacedVars).toBeNull();
              }
            }
          }
        });
        
        test('JSON files have valid syntax after replacement', async () => {
          const claudeDir = join(testDir, 'claude');
          const manifestFile = join(claudeDir, 'get-shit-done', '.gsd-install-manifest.json');
          
          const content = await readFile(manifestFile, 'utf8');
          
          // Should parse without error
          expect(() => JSON.parse(content)).not.toThrow();
        });
      });
      
      // Test 5: Metadata block format
      describe('Frontmatter Format', () => {
        test('Copilot metadata uses multi-line YAML format', async () => {
          const copilotDir = join(testDir, 'copilot');
          const agentsDir = join(copilotDir, 'agents');
          const agentFiles = await readdir(agentsDir);
          const firstAgent = agentFiles.find(f => f.startsWith('gsd-'));
          
          const content = await readFile(join(agentsDir, firstAgent), 'utf8');
          
          // Check metadata block is multi-line
          const metadataMatch = content.match(/metadata:\n  platform:/);
          expect(metadataMatch).not.toBeNull();
        });
      });
    });
    ```

    Create `tests/integration/` directory if it doesn't exist (it should already exist from previous phases).

    **Key test characteristics:**
    - **Full coverage:** All 13 agents × 3 platforms = 39 combinations
    - **Structural assertions:** Parse frontmatter and check field existence/types
    - **Format assertions:** String matching for exact format verification
    - **Negative assertions:** Explicitly check skills field absence in Copilot/Codex
    - **Variable replacement:** Verify no {{VARIABLES}} in any text file
    - **Validation:** Confirm JSON/YAML files parse correctly
  </action>
  <verify>
    ```bash
    # Run new integration tests
    npm test -- installation-output.test.js
    # All tests should pass
    ```
  </verify>
  <done>
    - Integration test file created with 5 test suites
    - Tests verify all 39 agent×platform combinations
    - Structural assertions using gray-matter parsing
    - Format assertions using string matching
    - Negative assertions for skills field (Copilot/Codex)
    - Template variable replacement verification
    - All tests passing
  </done>
</task>

<task name="run-all-tests-and-verify" type="auto">
  <files>N/A</files>
  <action>
    Run complete test suite to verify all bug fixes:

    ```bash
    # Run all tests (unit + integration)
    npm test
    ```

    Verify:
    1. All existing tests still pass (no regressions)
    2. New frontmatter serializer unit tests pass
    3. New installation output integration tests pass
    4. No unreplaced template variables in any test outputs

    If any test fails, investigate and fix before considering plan complete.
  </action>
  <verify>
    ```bash
    # Verify test results
    npm test 2>&1 | grep -E "Test Files|Tests|PASS"
    # Should show all tests passing
    ```
  </verify>
  <done>
    - All unit tests pass (including new serializer tests)
    - All integration tests pass (including new output verification tests)
    - No regressions in existing tests
    - Complete test coverage for all bug fixes
  </done>
</task>

## Success Criteria

- [ ] Recursive template variable replacement in get-shit-done/ directory
- [ ] All text file types processed (.md, .json, .sh, .yml, .yaml, etc.)
- [ ] Binary files skipped with verbose logging
- [ ] JSON/YAML validation after variable replacement
- [ ] Integration tests verify all 13 agents × 3 platforms
- [ ] Tests assert skills field present/absent per platform
- [ ] Tests assert tools format correct per platform
- [ ] No unreplaced {{VARIABLES}} in any installed files
- [ ] All tests (unit + integration) passing

## Output

**Files Modified:**
- `bin/lib/installer/orchestrator.js` - Added processDirectoryRecursively(), enhanced installShared()

**Files Created:**
- `tests/integration/installation-output.test.js` - Comprehensive output verification (39 agent×platform tests)

**Test Coverage:**
- Unit tests: Frontmatter serializer (7+ test cases)
- Integration tests: Full installation output verification (5 test suites, 39+ assertions)

**All Bugs Fixed:**
✅ Claude agents include skills field
✅ Copilot/Codex agents exclude skills field  
✅ Copilot/Codex tools use single-line array format
✅ Template variables replaced recursively in all text files
✅ Comprehensive test coverage prevents regressions
