---
phase: 06.2-installation-output-verification-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/rendering/frontmatter-serializer.js
  - tests/unit/frontmatter-serializer.test.js
autonomous: true
must_haves:
  - type: behavioral
    truths:
      - "Copilot/Codex tools serialized as single-line array: ['tool-a', 'tool-b']"
      - "Empty arrays omitted from frontmatter output (no `tools: []`)"
      - "Metadata blocks use multi-line YAML format with 2-space indentation"
      - "Skills field serialized as multi-line array for Claude"
  - type: artifact
    files:
      - bin/lib/rendering/frontmatter-serializer.js
      - tests/unit/frontmatter-serializer.test.js
  - type: integration
    key_links:
      - "Serializer exports `serializeFrontmatter(data, platform)` function"
      - "Test coverage includes empty arrays, tools format, metadata blocks, skills arrays"
      - "Returns properly formatted YAML string ready for file write"
---

# Plan 06.2-01: Custom Frontmatter Serializer

**Objective:** Create custom YAML frontmatter serializer that produces correct format for each platform

**Context:** Current implementation uses generic YAML serializer (gray-matter) which doesn't support platform-specific formatting requirements. Copilot/Codex need single-line arrays (`['tool-a', 'tool-b']`), while Claude needs multi-line arrays. Empty fields must be omitted. This serializer is the foundation for fixing agent frontmatter bugs.

## Tasks

<task name="create-frontmatter-serializer" type="auto">
  <files>bin/lib/rendering/frontmatter-serializer.js</files>
  <action>
    Create new module `bin/lib/rendering/frontmatter-serializer.js` with custom YAML serialization:

    1. **Export main function:**
       ```javascript
       export function serializeFrontmatter(data, platform)
       ```
       - Takes frontmatter object and platform name
       - Returns YAML string (without `---` delimiters)

    2. **Field omission logic:**
       - Skip `undefined` fields
       - Skip empty arrays (`[]`)
       - Keep empty objects and other falsy values

    3. **Format by field type:**
       - **Arrays:** 
         - Copilot/Codex: Single-line flow style `['item-a', 'item-b']`
         - Claude: Multi-line block style with `- ` prefix
       - **Objects:** Multi-line block style with 2-space indentation
       - **Scalars:** Inline format `key: value`

    4. **Special handling for `tools` field:**
       - Wrap items in single quotes
       - Handle special characters (slashes, hyphens) without escaping
       - Example: `tools: ['read', 'write', 'custom-mcp/tool-1']`

    5. **Field ordering:**
       - Standard order: name, description, tools, disallowedTools, skills, metadata
       - Other fields appended in object key order

    Implementation notes:
    - Use template literals for readability
    - No external dependencies (native JS only)
    - Handle edge cases: null, undefined, special chars
    - Reference RESEARCH.md Pattern 2 for detailed examples
  </action>
  <verify>
    ```bash
    # File exists and exports function
    node -e "import('./bin/lib/rendering/frontmatter-serializer.js').then(m => console.log(typeof m.serializeFrontmatter))"
    # Should output: function
    ```
  </verify>
  <done>
    - File `bin/lib/rendering/frontmatter-serializer.js` created
    - Exports `serializeFrontmatter(data, platform)` function
    - Handles all field types (arrays, objects, scalars)
    - Omits undefined and empty arrays
    - Platform-specific array formatting
  </done>
</task>

<task name="create-serializer-unit-tests" type="auto">
  <files>tests/unit/frontmatter-serializer.test.js</files>
  <action>
    Create comprehensive unit tests for the serializer in `tests/unit/frontmatter-serializer.test.js`:

    1. **Test structure:**
       ```javascript
       import { describe, test, expect } from 'vitest';
       import { serializeFrontmatter } from '../../bin/lib/rendering/frontmatter-serializer.js';
       ```

    2. **Test cases:**

       **Empty array omission:**
       - Input: `{name: 'test', tools: []}`
       - Expected: No `tools` field in output

       **Copilot single-line tools:**
       - Input: `{tools: ['read', 'write', 'bash']}`
       - Expected: `tools: ['read', 'write', 'bash']`

       **Special characters in tools:**
       - Input: `{tools: ['custom-mcp/tool-1', 'tool-with-dash']}`
       - Expected: Properly quoted, no escaping issues

       **Metadata block indentation:**
       - Input: `{metadata: {platform: 'copilot', generated: '2026-01-28'}}`
       - Expected:
         ```yaml
         metadata:
           platform: copilot
           generated: 2026-01-28
         ```

       **Claude multi-line skills:**
       - Input: `{skills: ['gsd-help', 'gsd-verify']}`
       - Expected (when platform='claude'):
         ```yaml
         skills:
           - gsd-help
           - gsd-verify
         ```

       **Undefined field omission:**
       - Input: `{name: 'test', tools: undefined, description: 'test'}`
       - Expected: Only `name` and `description` in output

       **Complete Copilot agent:**
       - Real-world example with all fields
       - Verify exact format matches CONTEXT.md requirements

    3. **Assertion approach:**
       - Parse output as actual YAML to verify structure
       - Use string matching for exact format verification
       - Test both platforms: copilot and claude

    Create `tests/unit/` directory if it doesn't exist.
  </action>
  <verify>
    ```bash
    # Run unit tests
    npm test -- frontmatter-serializer.test.js
    # Should pass all tests
    ```
  </verify>
  <done>
    - Test file `tests/unit/frontmatter-serializer.test.js` created
    - 7+ test cases covering all requirements
    - Tests verify both structure (via YAML parsing) and exact format (via string matching)
    - All tests passing
  </done>
</task>

## Success Criteria

- [ ] `serializeFrontmatter(data, platform)` function exists and exports correctly
- [ ] Empty arrays omitted from output
- [ ] Copilot/Codex arrays use single-line format: `['item-a', 'item-b']`
- [ ] Claude arrays use multi-line format with `- ` prefix
- [ ] Metadata blocks use 2-space indentation
- [ ] Special characters in tool names handled correctly
- [ ] Unit tests pass for all platforms and edge cases
- [ ] Function is ready to integrate into adapter pipeline

## Output

**Files Created:**
- `bin/lib/rendering/frontmatter-serializer.js` - Custom YAML serializer
- `tests/unit/frontmatter-serializer.test.js` - Comprehensive test coverage

**Integration Point:**
Next plan will integrate this serializer into adapter pipeline for agent installation.

