---
phase: 06.2
plan: 01
title: Custom Frontmatter Serializer
one_liner: Custom YAML serializer with platform-specific array formatting and date/version string quoting
subsystem: rendering
tags: [yaml, serialization, frontmatter, multi-platform, copilot, codex, claude]
requires: []
provides:
  - serializeFrontmatter function for platform-specific YAML generation
  - Empty array omission logic
  - Date and version string quoting to prevent YAML auto-parsing
affects:
  - 06.2-02 (Adapter integration will use this serializer)
  - 06.2-03 (Output verification tests will validate serializer output)
tech-stack:
  added: []
  patterns:
    - Custom YAML serializer pattern (no external dependencies)
    - Platform-specific formatting (Copilot/Codex flow style, Claude block style)
    - Date/version string quoting for YAML safety
key-files:
  created:
    - bin/lib/rendering/frontmatter-serializer.js
    - tests/unit/frontmatter-serializer.test.js
  modified: []
decisions:
  - slug: custom-serializer-over-js-yaml
    summary: Built custom serializer instead of using js-yaml
    rationale: js-yaml's flowLevel option is all-or-nothing; cannot mix flow and block styles at root level
  - slug: quote-date-version-strings
    summary: Automatically quote strings matching date/version patterns
    rationale: Prevents YAML from auto-parsing '2026-01-28' as Date object or '2.0.0' as number
  - slug: single-quotes-for-tools
    summary: Use single quotes for array items (tools field)
    rationale: Handles special characters (slashes, hyphens) without escaping issues
metrics:
  tasks_completed: 2
  tests_added: 22
  duration: 4m 2s
completed: 2026-01-28
---

# Phase 06.2 Plan 01: Custom Frontmatter Serializer Summary

**One-liner:** Custom YAML serializer with platform-specific array formatting and date/version string quoting

**Completion:** 2026-01-28 (4m 2s)

---

## Objective

Create a custom YAML frontmatter serializer that produces correct format for each platform (Copilot/Codex/Claude) with proper handling of empty arrays, special characters, and date/version strings.

---

## Execution Summary

### What Was Built

1. **Custom YAML Serializer** (`bin/lib/rendering/frontmatter-serializer.js`)
   - Exports `serializeFrontmatter(data, platform)` function
   - Platform-specific array formatting:
     - Copilot/Codex: Single-line flow style `['tool-a', 'tool-b']`
     - Claude: Multi-line block style with `- ` prefix
   - Empty array omission (no `tools: []` in output)
   - Metadata block formatting with 2-space indentation
   - Date/version string quoting to prevent YAML auto-parsing
   - Special character handling in tool names

2. **Comprehensive Test Suite** (`tests/unit/frontmatter-serializer.test.js`)
   - 22 test cases covering all requirements
   - Tests for both Copilot/Codex and Claude platforms
   - Edge case coverage (null, boolean, numeric, special strings)
   - Structural validation via gray-matter parsing
   - Format validation via string matching

### Tasks Completed

| Task | Description | Commit | Files |
|------|-------------|--------|-------|
| 1 | Create frontmatter serializer | 31d3107 | bin/lib/rendering/frontmatter-serializer.js |
| 2 | Create serializer unit tests | e47398d | tests/unit/frontmatter-serializer.test.js, bin/lib/rendering/frontmatter-serializer.js (fix) |

**Commits:**
- `31d3107` - feat(06.2-01): create custom frontmatter serializer
- `e47398d` - test(06.2-01): add comprehensive frontmatter serializer tests

---

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Added date/version string quoting**

- **Found during:** Task 2 - Writing unit tests
- **Issue:** YAML parser was auto-converting strings like `2026-01-28` to Date objects and `2.0.0` to numbers
- **Fix:** Added regex pattern detection for date-like (`/^\d{4}-\d{2}-\d{2}/`) and version-like (`/^\d+\.\d+(\.\d+)?$/`) strings to automatically quote them
- **Files modified:** `bin/lib/rendering/frontmatter-serializer.js`
- **Commit:** e47398d
- **Rationale:** Critical for data integrity - without quoting, parsed YAML has different types than original data. Tests caught this bug immediately via structural validation.

---

## Decisions Made

### 1. Custom Serializer Over js-yaml
**Decision:** Built custom serializer instead of using js-yaml library  
**Rationale:** js-yaml's `flowLevel` option is all-or-nothing - setting `flowLevel: 0` makes everything flow style (inline), setting `flowLevel: 1` makes nested objects flow style. We need: root-level objects in block style, arrays in flow style (Copilot/Codex) or block style (Claude), nested objects in block style. Custom implementation gives precise control.  
**Alternative considered:** Using js-yaml with post-processing (rejected - too complex and fragile)

### 2. Quote Date and Version Strings
**Decision:** Automatically quote strings matching date/version patterns  
**Rationale:** YAML spec auto-parses `2026-01-28` as Date object and `2.0.0` as number. Quoting preserves string type for consistency with source data.  
**Pattern detection:** `/^\d{4}-\d{2}-\d{2}/` for dates, `/^\d+\.\d+(\.\d+)?$/` for versions  
**Impact:** Prevents type coercion bugs in downstream consumers

### 3. Single Quotes for Tool Names
**Decision:** Use single quotes for array items in tools field  
**Rationale:** Handles special characters (slashes in `custom-mcp/tool-1`, hyphens in `tool-with-dash`) without escaping issues. Copilot CLI parser correctly handles slashes in quoted strings.  
**Alternative considered:** Double quotes with escaping (rejected - more complex, less readable)

---

## Technical Notes

### Implementation Details

**Field Ordering:**
- Standard fields first: `name`, `description`, `tools`, `disallowedTools`, `skills`, `metadata`
- Other fields appended in object key order
- Ensures consistent output across platforms

**Omission Rules:**
- Skip `undefined` fields (not present in output)
- Skip empty arrays `[]` (no `tools: []` in output)
- Keep empty objects `{}` and other falsy values (null, false, 0)

**Value Formatting:**
- Scalars: Inline `key: value`
- Arrays: Platform-specific (flow for Copilot/Codex, block for Claude)
- Objects: Multi-line block with 2-space indentation
- Nested objects: Recursive with additional indentation (4 spaces)

### Test Coverage

**Test Categories:**
1. Empty array omission (2 tests)
2. Copilot single-line format (2 tests)
3. Special characters (3 tests)
4. Metadata indentation (2 tests)
5. Claude multi-line format (2 tests)
6. Undefined field omission (2 tests)
7. Complete agent examples (2 tests)
8. Edge cases (6 tests)
9. Field ordering (1 test)

**Total:** 22 tests, all passing

**Assertion Strategy:**
- Structural validation: Parse output with gray-matter, verify object structure
- Format validation: String matching for exact YAML format
- Both approaches ensure correctness without brittleness

---

## Integration Points

### Outgoing Dependencies (What This Provides)

**For Plan 06.2-02 (Adapter Integration):**
- `serializeFrontmatter(data, platform)` function ready to replace gray-matter usage
- Platform-specific formatting guaranteed by tests
- Date/version string safety built-in

**For Plan 06.2-03 (Output Verification):**
- Verified serializer output format via unit tests
- Integration tests can validate end-to-end with confidence

### Usage Pattern

```javascript
import { serializeFrontmatter } from './bin/lib/rendering/frontmatter-serializer.js';

// Copilot/Codex usage
const frontmatter = serializeFrontmatter({
  name: 'agent-name',
  tools: ['read', 'write', 'custom-mcp/tool-1'],
  metadata: { platform: 'copilot', generated: '2026-01-28' }
}, 'copilot');

const agentFile = `---\n${frontmatter}\n---\n${instructions}`;

// Claude usage
const frontmatter = serializeFrontmatter({
  name: 'agent-name',
  skills: ['skill-a', 'skill-b'],
  metadata: { platform: 'claude' }
}, 'claude');
```

---

## Next Phase Readiness

### Blockers
None - Plan complete and tested

### Concerns
None - All success criteria met

### Recommendations

1. **For 06.2-02 (Adapter Integration):**
   - Replace gray-matter serialization with `serializeFrontmatter`
   - Update copilot-adapter.js and codex-adapter.js
   - Verify metadata field handling in real agent files

2. **For 06.2-03 (Output Verification):**
   - Add integration tests that use real templates
   - Verify installed agent files parse correctly
   - Test all 13 agents × 3 platforms = 39 combinations

3. **Future Enhancement:**
   - Consider adding YAML comments support if needed
   - Consider adding custom formatting hooks for special fields

---

## Success Criteria ✅

- ✅ `serializeFrontmatter(data, platform)` function exists and exports correctly
- ✅ Empty arrays omitted from output
- ✅ Copilot/Codex arrays use single-line format: `['item-a', 'item-b']`
- ✅ Claude arrays use multi-line format with `- ` prefix
- ✅ Metadata blocks use 2-space indentation
- ✅ Special characters in tool names handled correctly
- ✅ Unit tests pass for all platforms and edge cases (22/22)
- ✅ Function is ready to integrate into adapter pipeline

**Status:** All criteria met, plan complete

---

## Files Changed

**Created:**
- `bin/lib/rendering/frontmatter-serializer.js` (183 lines)
- `tests/unit/frontmatter-serializer.test.js` (356 lines)

**Modified:**
- None (serializer bug fix was part of Task 2 commit)

**Total:** 539 lines added

---

## Lessons Learned

1. **Test-driven bug detection:** Writing comprehensive tests immediately caught the date/version string parsing bug before integration
2. **Custom vs library trade-off:** Sometimes a focused custom implementation is simpler than configuring a complex library
3. **YAML auto-parsing gotchas:** YAML's helpful auto-parsing can cause type bugs - quote strings that look like dates/numbers/booleans
4. **Platform-specific requirements:** Multi-platform support requires flexible serialization - one format doesn't fit all

---

**Plan Status:** ✅ Complete  
**Next Plan:** 06.2-02 - Adapter Integration (use this serializer in platform adapters)
