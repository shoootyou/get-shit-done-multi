---
phase: 09-platform-instructions-installer
plan: 03
type: execute
wave: 2
depends_on: [09-01, 09-02]
files_modified:
  - bin/lib/installer/orchestrator.js
autonomous: true
must_haves:
  truths:
    - orchestrator.js calls installPlatformInstructions() in non-verbose mode after installShared()
    - orchestrator.js calls installPlatformInstructions() in verbose mode after installShared()
    - Function receives correct parameters: templatesDir, targetDir, variables, multiBar, isVerbose, adapter
    - stats.instructions tracks count (always 1)
    - Non-verbose mode shows completion line: "Platform Instructions: 1/1"
    - Verbose mode shows subtitle: "Installing Platform Instructions"
    - Installation runs for all platforms (Claude, Copilot, Codex)
  artifacts:
    - orchestrator.js imports installPlatformInstructions
    - orchestrator.js has stats.instructions field
    - Function called in both verbose branches
  wiring:
    - orchestrator passes adapter.getInstructionsPath(isGlobal) to installer
    - Function uses same pattern as installShared() integration
    - Runs after shared directory installation (phase ordering)
  key_links:
    - installPlatformInstructions() receives adapter instance
    - Adapter provides platform-specific path via getInstructionsPath()
    - Variables object includes PLATFORM_ROOT and COMMAND_PREFIX
---

# Plan 09-03: Integrate into Orchestrator

## Objective

Integrate installPlatformInstructions() function into the orchestrator's installation flow, calling it after installShared() in both verbose and non-verbose modes, with proper stats tracking and user feedback.

## Context

**What exists:**
- `bin/lib/installer/orchestrator.js` orchestrates installation phases
- Two execution modes: verbose (with subtitles) and non-verbose (with completion lines)
- Existing pattern: installShared() called after skills/agents installation
- Stats object tracks counts for each phase
- displayCompletionLine() shows non-verbose progress

**What's needed:**
- Import installPlatformInstructions from install-platform-instructions.js
- Call function in non-verbose mode (after installShared, before manifest)
- Call function in verbose mode (after installShared, before manifest)
- Track stats.instructions (always 1)
- Display appropriate user feedback

**Integration points:**
- Non-verbose: Around line 168 (after installShared)
- Verbose: Around line 185 (after installShared)
- Both: Pass adapter instance so function can call getInstructionsPath()

## Tasks

<task name="add-import-statement" type="auto">
  <files>bin/lib/installer/orchestrator.js</files>
  <action>
Add import for installPlatformInstructions at top of file.

**Find existing import block:**
```javascript
import { installSkills } from './install-skills.js';
import { installAgents } from './install-agents.js';
import { installShared } from './install-shared.js';
```

**Add new import:**
```javascript
import { installSkills } from './install-skills.js';
import { installAgents } from './install-agents.js';
import { installShared } from './install-shared.js';
import { installPlatformInstructions } from './install-platform-instructions.js';
```

**Placement:** Keep imports organized (install-*.js files grouped together).
  </action>
  <verify>
```bash
# Check import exists
grep "installPlatformInstructions" bin/lib/installer/orchestrator.js | grep import
# Should show the import line
```
  </verify>
  <done>Import statement added for installPlatformInstructions</done>
</task>

<task name="integrate-non-verbose-mode" type="auto">
  <files>bin/lib/installer/orchestrator.js</files>
  <action>
Integrate installPlatformInstructions() in non-verbose mode.

**Find the non-verbose block** (around line 160-170):
```javascript
// Phase 3: Install shared directory
stats.shared = await installShared(templatesDir, targetDir, templateVars, null, isVerbose);
displayCompletionLine('Shared', stats.shared, stats.shared);
```

**Add new phase after shared (before manifest generation):**
```javascript
// Phase 3: Install shared directory
stats.shared = await installShared(templatesDir, targetDir, templateVars, null, isVerbose);
displayCompletionLine('Shared', stats.shared, stats.shared);

// Phase 4: Install platform instructions
stats.instructions = await installPlatformInstructions(
  templatesDir,
  targetDir,
  templateVars,
  null,
  isVerbose,
  adapter
);
displayCompletionLine('Platform Instructions', stats.instructions, stats.instructions);
```

**Key points:**
- Pass `null` for multiBar (not used in non-verbose)
- Pass `adapter` instance (last parameter) for getInstructionsPath() access
- Display completion line immediately after
- stats.instructions always 1 (single file per platform)
  </action>
  <verify>
```bash
# Check non-verbose integration exists
grep -A 3 "Phase 4: Install platform instructions" bin/lib/installer/orchestrator.js | head -5
# Should show the installPlatformInstructions call and displayCompletionLine

# Verify adapter is passed
grep "installPlatformInstructions(" bin/lib/installer/orchestrator.js | grep -v "import" | grep "adapter"
# Should show adapter parameter
```
  </verify>
  <done>installPlatformInstructions() integrated in non-verbose mode with completion line display</done>
</task>

<task name="integrate-verbose-mode" type="auto">
  <files>bin/lib/installer/orchestrator.js</files>
  <action>
Integrate installPlatformInstructions() in verbose mode.

**Find the verbose block** (around line 180-190):
```javascript
console.log();
logger.simpleSubtitle('Installing Shared Directory');
stats.shared = await installShared(templatesDir, targetDir, templateVars, null, isVerbose);
```

**Add new phase after shared:**
```javascript
console.log();
logger.simpleSubtitle('Installing Shared Directory');
stats.shared = await installShared(templatesDir, targetDir, templateVars, null, isVerbose);

console.log();
logger.simpleSubtitle('Installing Platform Instructions');
stats.instructions = await installPlatformInstructions(
  templatesDir,
  targetDir,
  templateVars,
  null,
  isVerbose,
  adapter
);
```

**Key points:**
- Add blank line before subtitle (consistent with other phases)
- Subtitle: "Installing Platform Instructions"
- Pass same parameters as non-verbose mode
- No displayCompletionLine in verbose mode (function logs directly)
  </action>
  <verify>
```bash
# Check verbose integration exists
grep "Installing Platform Instructions" bin/lib/installer/orchestrator.js
# Should show the subtitle line

# Verify both modes exist
grep -c "installPlatformInstructions(" bin/lib/installer/orchestrator.js | grep -v "import"
# Should show 2 (one for each mode)
```
  </verify>
  <done>installPlatformInstructions() integrated in verbose mode with subtitle display</done>
</task>

<task name="update-stats-initialization" type="auto">
  <files>bin/lib/installer/orchestrator.js</files>
  <action>
Add stats.instructions field to stats object initialization.

**Find stats object initialization** (near top of orchestrator function):
```javascript
const stats = {
  skills: 0,
  agents: 0,
  shared: 0
};
```

**Add instructions field:**
```javascript
const stats = {
  skills: 0,
  agents: 0,
  shared: 0,
  instructions: 0
};
```

**Why:** Ensures stats.instructions is defined before assignment, follows existing pattern.
  </action>
  <verify>
```bash
# Check stats object has instructions field
grep -A 5 "const stats = {" bin/lib/installer/orchestrator.js | grep instructions
# Should show: instructions: 0
```
  </verify>
  <done>stats.instructions field added to stats object initialization</done>
</task>

## Verification

After completing all tasks:

```bash
# Import statement exists
grep "import.*installPlatformInstructions" bin/lib/installer/orchestrator.js

# Both integration points exist
grep -n "installPlatformInstructions(" bin/lib/installer/orchestrator.js | grep -v "import"
# Should show 2 lines (non-verbose and verbose modes)

# Non-verbose has completion line
grep -A 1 "stats.instructions = await installPlatformInstructions" bin/lib/installer/orchestrator.js | grep displayCompletionLine
# Should show displayCompletionLine call

# Verbose has subtitle
grep -B 1 "stats.instructions = await installPlatformInstructions" bin/lib/installer/orchestrator.js | grep "simpleSubtitle.*Platform Instructions"
# Should show subtitle

# stats object initialized
grep -A 5 "const stats = {" bin/lib/installer/orchestrator.js | grep "instructions: 0"
# Should show initialization

# Adapter passed to function
grep "installPlatformInstructions(" bin/lib/installer/orchestrator.js | grep "adapter" | grep -v "import"
# Should show adapter parameter in both calls
```

## Success Criteria

- [ ] orchestrator.js imports installPlatformInstructions
- [ ] stats object initialized with instructions: 0
- [ ] Non-verbose mode calls installPlatformInstructions() after installShared()
- [ ] Non-verbose mode displays "Platform Instructions: 1/1"
- [ ] Verbose mode calls installPlatformInstructions() after installShared()
- [ ] Verbose mode displays subtitle "Installing Platform Instructions"
- [ ] Both modes pass correct parameters: templatesDir, targetDir, templateVars, null, isVerbose, adapter
- [ ] Adapter instance passed as last parameter
- [ ] Installation runs in correct phase order (shared → instructions → manifest)
- [ ] Code follows existing orchestrator patterns

## Output

Orchestrator integration complete:
- `bin/lib/installer/orchestrator.js` - Updated with platform instructions phase

Installation flow now includes:
1. Skills
2. Agents
3. Shared directory
4. **Platform instructions** ← NEW
5. Manifest generation
