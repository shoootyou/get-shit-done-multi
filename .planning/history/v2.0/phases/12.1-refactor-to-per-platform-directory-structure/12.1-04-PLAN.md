---
phase: 12.1-refactor-to-per-platform-directory-structure
plan: 04
type: execute
wave: 2
depends_on: [12.1-01, 12.1-02, 12.1-03]
files_modified:
  - bin/lib/platforms/_shared/base-validator.js
  - bin/lib/platforms/_shared/base-adapter.js
  - bin/lib/platforms/_shared/field-validators.js
  - bin/lib/platforms/_shared/validation-error.js
  - bin/lib/platforms/claude/validator.js
  - bin/lib/platforms/claude/adapter.js
  - bin/lib/platforms/copilot/validator.js
  - bin/lib/platforms/copilot/adapter.js
  - bin/lib/platforms/codex/validator.js
  - bin/lib/platforms/codex/adapter.js
autonomous: true

must_haves:
  truths:
    - Shared platform files are in platforms/_shared/ directory
    - All platform validators import from _shared/base-validator.js
    - All platform adapters import from _shared/base-adapter.js
    - frontmatter/ and serialization/ directories no longer exist
    - Full test suite passes after migration
  artifacts:
    - path: "bin/lib/platforms/_shared/base-validator.js"
      provides: "BaseValidator class"
      exports: ["BaseValidator"]
    - path: "bin/lib/platforms/_shared/base-adapter.js"
      provides: "BaseAdapter class"
      exports: ["BaseAdapter"]
    - path: "bin/lib/platforms/_shared/field-validators.js"
      provides: "Field validation utilities"
      min_lines: 50
    - path: "bin/lib/platforms/_shared/validation-error.js"
      provides: "ValidationError class"
      exports: ["ValidationError"]
  key_links:
    - from: "bin/lib/platforms/claude/validator.js"
      to: "../_shared/base-validator.js"
      via: "extends import"
      pattern: "from.*_shared/base-validator"
    - from: "bin/lib/platforms/claude/adapter.js"
      to: "../_shared/base-adapter.js"
      via: "extends import"
      pattern: "from.*_shared/base-adapter"
---

<objective>
Migrate shared platform files to platforms/_shared/ directory and remove empty frontmatter/ and serialization/ directories.

Purpose: Complete the platform-based directory structure by consolidating shared code that platforms extend, finalizing the migration.
Output: All shared files in platforms/_shared/, empty directories removed, full test suite passing.
</objective>

<execution_context>
@.github/get-shit-done/workflows/execute-plan.md
@.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.1-refactor-to-per-platform-directory-structure/12.1-01-CONTEXT.md
@.planning/phases/12.1-refactor-to-per-platform-directory-structure/12.1-RESEARCH.md

# Prior plan summaries
@.planning/phases/12.1-refactor-to-per-platform-directory-structure/12.1-01-SUMMARY.md
@.planning/phases/12.1-refactor-to-per-platform-directory-structure/12.1-02-SUMMARY.md
@.planning/phases/12.1-refactor-to-per-platform-directory-structure/12.1-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Migrate shared platform files to _shared directory</name>
  <files>
    bin/lib/platforms/_shared/base-validator.js
    bin/lib/platforms/_shared/base-adapter.js
    bin/lib/platforms/_shared/field-validators.js
    bin/lib/platforms/_shared/validation-error.js
  </files>
  <action>
Create _shared directory and move shared files using git mv:

1. Create directory:
   ```bash
   mkdir -p bin/lib/platforms/_shared
   ```

2. Move shared files (preserves git history):
   ```bash
   git mv bin/lib/frontmatter/base-validator.js bin/lib/platforms/_shared/base-validator.js
   git mv bin/lib/platforms/base-adapter.js bin/lib/platforms/_shared/base-adapter.js
   git mv bin/lib/frontmatter/field-validators.js bin/lib/platforms/_shared/field-validators.js
   git mv bin/lib/frontmatter/validation-error.js bin/lib/platforms/_shared/validation-error.js
   ```

3. Verify moves:
   ```bash
   ls -la bin/lib/platforms/_shared/
   ```
   Should show 4 files (base-validator.js, base-adapter.js, field-validators.js, validation-error.js)

Named exports remain unchanged (BaseValidator, BaseAdapter, ValidationError, etc.).
  </action>
  <verify>
Run: `ls -la bin/lib/platforms/_shared/` shows 4 files
Run: `git status` shows 4 renames (R) for shared files
Run: `node --eval "import('./bin/lib/platforms/_shared/base-validator.js').then(() => console.log('OK'))"` succeeds
  </verify>
  <done>
Shared platform files exist in platforms/_shared/ directory with git rename history preserved.
  </done>
</task>

<task type="auto">
  <name>Update imports in platform validators and adapters</name>
  <files>
    bin/lib/platforms/claude/validator.js
    bin/lib/platforms/claude/adapter.js
    bin/lib/platforms/copilot/validator.js
    bin/lib/platforms/copilot/adapter.js
    bin/lib/platforms/codex/validator.js
    bin/lib/platforms/codex/adapter.js
  </files>
  <action>
Update imports in all platform files to reference _shared directory:

1. Update validator imports (all three platforms):
   - Old: `from '../frontmatter/base-validator.js'` or `from '../../frontmatter/base-validator.js'`
   - New: `from '../_shared/base-validator.js'`
   
   ```bash
   # Update Claude validator
   sed -i '' "s|['\"].*frontmatter/base-validator.js['\"]|'../_shared/base-validator.js'|g" bin/lib/platforms/claude/validator.js
   
   # Update Copilot validator
   sed -i '' "s|['\"].*frontmatter/base-validator.js['\"]|'../_shared/base-validator.js'|g" bin/lib/platforms/copilot/validator.js
   
   # Update Codex validator
   sed -i '' "s|['\"].*frontmatter/base-validator.js['\"]|'../_shared/base-validator.js'|g" bin/lib/platforms/codex/validator.js
   ```

2. Update adapter imports (all three platforms):
   - Old: `from './base-adapter.js'` (when in platforms/ root)
   - New: `from '../_shared/base-adapter.js'`
   
   ```bash
   # Update Claude adapter
   sed -i '' "s|['\"]./base-adapter.js['\"]|'../_shared/base-adapter.js'|g" bin/lib/platforms/claude/adapter.js
   
   # Update Copilot adapter
   sed -i '' "s|['\"]./base-adapter.js['\"]|'../_shared/base-adapter.js'|g" bin/lib/platforms/copilot/adapter.js
   
   # Update Codex adapter
   sed -i '' "s|['\"]./base-adapter.js['\"]|'../_shared/base-adapter.js'|g" bin/lib/platforms/codex/adapter.js
   ```

3. Update field-validators and validation-error imports if present:
   ```bash
   grep -r "from.*frontmatter/field-validators" bin/lib/platforms/ --include="*.js"
   grep -r "from.*frontmatter/validation-error" bin/lib/platforms/ --include="*.js"
   # Update any found references to use ../_shared/
   ```

4. Verify no old imports remain:
   ```bash
   grep -r "from.*frontmatter/" bin/lib/platforms/ --include="*.js"
   grep -r "from.*['\"]./base-adapter.js['\"]" bin/lib/platforms/ --include="*.js" | grep -v _shared
   ```
   Should return no results (or only _shared/ results).
  </action>
  <verify>
Run: `grep -r "from.*_shared/base-validator" bin/lib/platforms/*/validator.js` shows 3 matches (Claude, Copilot, Codex)
Run: `grep -r "from.*_shared/base-adapter" bin/lib/platforms/*/adapter.js` shows 3 matches
Run: `grep -r "from.*frontmatter/" bin/lib/platforms/ --include="*.js"` returns no results
Run: `node --eval "import('./bin/lib/platforms/claude/validator.js').then(() => console.log('OK'))"` succeeds
  </verify>
  <done>
All platform validators and adapters import from _shared directory.
  </done>
</task>

<task type="auto">
  <name>Remove empty directories and run full test suite</name>
  <files>N/A</files>
  <action>
Remove empty frontmatter/ and serialization/ directories, then validate with full test suite:

1. Verify directories are empty:
   ```bash
   ls -la bin/lib/frontmatter/
   ls -la bin/lib/serialization/
   ```
   Should show only . and .. entries (empty directories).

2. Remove empty directories:
   ```bash
   rmdir bin/lib/frontmatter
   rmdir bin/lib/serialization
   ```
   
   Use `rmdir` (not `rm -rf`) so it fails if directories aren't actually empty.

3. Verify removal:
   ```bash
   ls bin/lib/ | grep -E "frontmatter|serialization"
   ```
   Should return no results.

4. Run full test suite:
   ```bash
   npm test
   ```
   
   All tests must pass. If any fail, investigate and fix before completing this task.

5. If tests fail, check for:
   - Missed import updates
   - Test files still referencing old paths
   - Relative path calculation errors (wrong number of ../)

6. Stage everything together:
   ```bash
   git add -A
   git status
   ```
   
   Review to ensure all changes are staged (file moves, import updates, directory deletions).
  </action>
  <verify>
Run: `ls bin/lib/ | grep -E "frontmatter|serialization"` returns no results
Run: `npm test` exits with code 0 (all tests pass)
Run: `git status` shows all changes staged
  </verify>
  <done>
Empty directories removed, full test suite passes, migration complete.
  </done>
</task>

</tasks>

<verification>
1. All shared files exist in bin/lib/platforms/_shared/
2. All platform validators import BaseValidator from ../_shared/
3. All platform adapters import BaseAdapter from ../_shared/
4. No frontmatter/ or serialization/ directories exist
5. No references to frontmatter/ or serialization/ paths in imports
6. Full test suite passes (npm test)
7. Git history preserved for all moved files
</verification>

<success_criteria>
- Complete migration to per-platform directory structure achieved
- All shared code in platforms/_shared/, all platform code in platforms/{platform}/
- All imports updated and resolving correctly
- Empty directories removed
- Full test suite passing
- Git rename history preserved for all files
- Ready for commit (all changes staged)
</success_criteria>

<output>
After completion, create `.planning/phases/12.1-refactor-to-per-platform-directory-structure/12.1-04-SUMMARY.md`
</output>
