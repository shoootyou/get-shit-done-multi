# Phase 12.1: Refactor to per-platform directory structure - Research

**Researched:** 2026-02-01
**Domain:** Directory restructuring, Node.js ESM import management, Git history preservation
**Confidence:** HIGH

## Summary

Directory restructuring in Node.js ESM projects requires careful coordination between file moves and import updates. The standard approach uses `git mv` for history preservation, manual import path updates (sed-based for small scopes like this), and validation between migration phases.

Key findings:
- **Git history preservation**: `git mv` automatically preserves rename history; `git log --follow` accesses full history across renames
- **Import atomicity**: All imports must be updated in the same commit as file moves to maintain working state
- **Phased migration safety**: Each file move must include ALL import updates for that file (in source, tests, and consumers) before proceeding
- **No build-time solutions**: For ~15 import updates across clean code, manual sed-based updates are faster and more reliable than introducing jscodeshift/babel dependencies

**Primary recommendation:** Use git mv for all file moves, update imports with sed, validate after each platform migration with install test.

## Standard Stack

No additional dependencies required. This phase uses built-in tools only.

### Core Tools
| Tool | Version | Purpose | Why Standard |
|------|---------|---------|--------------|
| git mv | 2.x+ | File moves with history | Built into git, automatic rename detection |
| sed | Any | Import path updates | POSIX standard, available everywhere |
| grep | Any | Find imports to update | POSIX standard, fast pattern matching |
| node | 18+ | Import validation | Runtime import resolution verification |

### Why No Additional Tools

For this scope (15 source files, ~15 import updates, clean Phase 12 code):
- **jscodeshift**: Overkill - adds 50MB+ dependency for ~15 string replacements
- **ts-morph**: TypeScript-focused, unnecessary for pure ESM
- **babel**: Requires config, transform pipeline for simple path updates
- **eslint --fix**: No rule exists for arbitrary path restructuring

**Manual sed is faster** for:
- Small, well-defined scope
- One-time refactoring (not repeated pattern)
- No complex AST transformations needed
- Immediate visibility of changes

## Architecture Patterns

### File Move + Import Update Atomicity

**Core principle:** File moves and ALL related import updates MUST be in the same commit.

**Structure:**
```
For each platform migration:
1. Create target directory (mkdir -p)
2. Move all platform files (git mv × 4)
3. Move all platform tests (git mv × 3-4)
4. Update imports in moved files
5. Update imports in files that USE moved files
6. Stage everything together (git add -A)
7. Commit atomically
8. Validate with install test
```

**Why atomic:** ESM module resolution fails at import time. Partial state = broken code.

### Phased Migration Pattern

**Pattern:** Migrate one platform at a time, validate between phases.

```
Phase 1: Claude platform
├── Move claude-validator.js → platforms/claude/validator.js
├── Move claude-serializer.js → platforms/claude/serializer.js
├── Move claude-cleaner.js → platforms/claude/cleaner.js
├── Move claude-adapter.js → platforms/claude/adapter.js
├── Move tests/unit/claude-*.test.js → tests/unit/platforms/claude/*.test.js
├── Update ALL imports referencing these files
├── Commit
└── Validate: node /abs/path/bin/install.js --claude

Phase 2: Copilot platform
└── (same pattern)

Phase 3: Codex platform
└── (same pattern)

Phase 4: Shared files + cleanup
├── Move base-validator.js → platforms/_shared/
├── Move base-adapter.js → platforms/_shared/
├── Move field-validators.js → platforms/_shared/
├── Move validation-error.js → platforms/_shared/
├── Update imports
├── Remove empty directories (rmdir frontmatter/ serialization/)
└── Commit
```

**Critical:** Each phase is independently validated BEFORE proceeding to next.

### Import Path Update Pattern

**Strategy:** Find all, update all, verify all.

```bash
# 1. Find all imports of file being moved
grep -r "from.*claude-validator" bin/lib/ tests/ --include="*.js"

# 2. Update each file with sed
sed -i '' "s|'../frontmatter/claude-validator.js'|'../platforms/claude/validator.js'|g" file.js

# 3. Verify import resolves
node --eval "import('./bin/lib/platforms/claude/validator.js')" 2>&1
```

**Handle both quote types:**
```bash
# Pattern that works with single or double quotes
sed -i '' "s|['\"]../frontmatter/claude-validator.js['\"]|'../platforms/claude/validator.js'|g" file.js
```

### Test File Mirroring

**Rule:** Test structure MUST mirror source structure exactly.

```
Source:                           Tests:
bin/lib/platforms/                tests/unit/platforms/
├── _shared/                      ├── _shared/
│   └── base-validator.js         │   └── (shared tests if needed)
├── claude/                       ├── claude/
│   ├── adapter.js                │   ├── adapter.test.js
│   ├── validator.js              │   ├── validator.test.js
│   ├── serializer.js             │   ├── serializer.test.js
│   └── cleaner.js                │   └── cleaner.test.js
└── copilot/                      └── copilot/
    └── ...                           └── ...
```

**Why mirror:** Makes finding tests obvious, maintains mental model consistency.

### Git History Preservation

**Best practice:** Use `git mv` for all moves.

**Behavior verified:**
- `git mv old.js new.js` creates staged rename (R in git status)
- Git detects renames automatically (default similarity threshold: 50%)
- `git log --follow new.js` shows full history from old.js
- Works identically to manual `mv` + `git add -A` but signals intent

**For viewing history after migration:**
```bash
git log --follow -- bin/lib/platforms/claude/validator.js
# Shows commits from when it was bin/lib/frontmatter/claude-validator.js
```

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| AST-based refactoring | Custom parser/transformer | sed for simple path updates | Adds complexity, dependencies for no benefit at this scale |
| Import discovery | Custom file walker | grep -r | POSIX standard, fast, reliable |
| Module resolution validation | Custom import checker | node command directly | Runtime is authoritative source |
| Circular dependency detection | Custom graph analyzer | Let Node.js fail at runtime | ESM handles gracefully, explicit errors |
| Batch file operations | Custom script | Standard Unix tools (git mv, sed, grep) | Battle-tested, debugging is easier |

**Key insight:** For 15 files and ~15 imports, shell tools are faster than tool setup.

## Common Pitfalls

### Pitfall 1: Forgotten Test Imports
**What goes wrong:** Source files moved and imports updated, but test files still import from old location.
**Why it happens:** Tests live in separate directory, easy to forget when focusing on source code.
**How to avoid:** 
1. List ALL files that import the moving file (include tests/ in grep)
2. Update test imports in same commit as source
3. Run `node test-file.test.js` after update to verify import resolves
**Warning signs:** Tests fail with `ERR_MODULE_NOT_FOUND` after migration.

### Pitfall 2: Relative Path Calculation Errors
**What goes wrong:** File moves deeper (or shallower) in hierarchy, relative imports have wrong number of `../`
**Why it happens:** 
- Old: `bin/lib/frontmatter/claude-validator.js` imports `./base-validator.js` (same dir)
- New: `bin/lib/platforms/claude/validator.js` imports `../_shared/base-validator.js` (up one, then down)
**How to avoid:** 
1. Count directory depth before and after move
2. Adjust `../` segments accordingly
3. Test import with `node --eval "import('path')"`
**Warning signs:** `ERR_MODULE_NOT_FOUND` with path that looks close but isn't exact.

### Pitfall 3: Partial Import Updates (Atomicity Violation)
**What goes wrong:** File moved, some imports updated, some missed. Code partially works.
**Why it happens:** Found imports manually, didn't grep exhaustively.
**How to avoid:**
```bash
# Find ALL imports before moving file
grep -r "from.*claude-validator" bin/lib/ tests/ --include="*.js"
# Update each result
# Verify no results remain:
grep -r "from.*frontmatter/claude-validator" bin/lib/ tests/ --include="*.js"
# Should return nothing
```
**Warning signs:** Some modules work, others fail with MODULE_NOT_FOUND.

### Pitfall 4: Case Sensitivity (macOS vs Linux)
**What goes wrong:** 
- File renamed: `claude-adapter.js` → `adapter.js`
- Import still says: `from './claude-adapter.js'`
- Works on macOS (case-insensitive filesystem), fails on Linux (case-sensitive)
**Why it happens:** macOS HFS+ is case-insensitive by default.
**How to avoid:** 
1. Use exact filename in imports (check with `ls`)
2. Test on case-sensitive filesystem if possible
3. Verify import path matches exact `git mv` target
**Warning signs:** CI fails on Linux but local (macOS) works fine.

### Pitfall 5: Empty Directory Removal Timing
**What goes wrong:** Delete `frontmatter/` directory after moving claude-validator but before updating all imports.
**Why it happens:** Eager cleanup before migration complete.
**How to avoid:** 
- Remove empty directories in FINAL commit only
- After ALL platforms migrated
- Separate commit for clarity (Commit 2 in this phase)
**Warning signs:** MODULE_NOT_FOUND errors during migration process.

### Pitfall 6: Missing .js Extension in New Paths
**What goes wrong:** 
- Old: `from '../frontmatter/claude-validator.js'` (has .js)
- New: `from '../platforms/claude/validator'` (missing .js)
- ESM requires explicit extensions
**Why it happens:** Forgetting that ESM doesn't auto-resolve extensions.
**How to avoid:** 
- Always include `.js` in sed replacement pattern
- Pattern: `'../platforms/claude/validator.js'` not `'../platforms/claude/validator'`
**Warning signs:** `ERR_MODULE_NOT_FOUND` with path missing extension.

### Pitfall 7: Quote Type Mismatches in sed
**What goes wrong:** File uses double quotes, sed pattern uses single quote match.
```javascript
// File has:
import { X } from "../path.js"

// sed pattern:
sed "s|'../old.js'|'../new.js'|" 
// Doesn't match because file uses double quotes
```
**Why it happens:** Inconsistent quote usage in codebase.
**How to avoid:** Use regex that handles both:
```bash
sed "s|['\"]../old.js['\"]|'../new.js'|g"
```
**Warning signs:** grep shows imports exist, sed replacement has no effect.

### Pitfall 8: Git Staging Incomplete
**What goes wrong:** 
- Use `git mv` (auto-staged)
- Edit imports in files (not staged)
- Commit
- Commit has file move but broken imports
**Why it happens:** `git mv` stages the rename, but edits to other files need explicit staging.
**How to avoid:** 
- After all changes, run `git add -A` to stage everything
- Review `git status` before commit
- Verify `git diff --cached` shows both moves and import changes
**Warning signs:** `git status` shows modified files after you thought you staged everything.

## Code Examples

Verified patterns from research:

### Complete Platform Migration Workflow

```bash
# Source: Empirical testing of git mv and import updates

# 1. Create target directories
mkdir -p bin/lib/platforms/claude
mkdir -p tests/unit/platforms/claude

# 2. Move source files (preserves history)
git mv bin/lib/frontmatter/claude-validator.js bin/lib/platforms/claude/validator.js
git mv bin/lib/serialization/claude-serializer.js bin/lib/platforms/claude/serializer.js
git mv bin/lib/serialization/claude-cleaner.js bin/lib/platforms/claude/cleaner.js
git mv bin/lib/platforms/claude-adapter.js bin/lib/platforms/claude/adapter.js

# 3. Move test files
git mv tests/unit/claude-serializer.test.js tests/unit/platforms/claude/serializer.test.js
# (repeat for other test files)

# 4. Find all imports to update
echo "Files that import claude-validator:"
grep -r "from.*claude-validator" bin/lib/ tests/ --include="*.js"

# 5. Update imports (one file at a time for control)
sed -i '' "s|['\"]../frontmatter/claude-validator.js['\"]|'../platforms/claude/validator.js'|g" \
  bin/lib/installer/install-skills.js

sed -i '' "s|['\"]../serialization/claude-serializer.js['\"]|'../platforms/claude/serializer.js'|g" \
  bin/lib/platforms/claude/adapter.js

# 6. Verify no old imports remain
grep -r "frontmatter/claude-validator" bin/lib/ tests/ --include="*.js"
# Should return no results

# 7. Stage everything
git add -A

# 8. Review what's staged
git status
git diff --cached --stat

# 9. Commit atomically
git commit -m "refactor(platforms): migrate claude platform to platform directory

- Move validator, serializer, cleaner, adapter to platforms/claude/
- Move tests to mirror source structure
- Update all import paths
- Preserves git history with git mv"

# 10. Validate
mkdir -p /tmp/gsd-test-claude
cd /tmp/gsd-test-claude
node /absolute/path/to/bin/install.js --claude
# If succeeds, migration is safe
```

### Import Path Update Pattern

```bash
# Source: Empirical testing of sed patterns

# Pattern that handles both single and double quotes
# Template:
sed -i '' "s|['\"]OLD_PATH['\"]|'NEW_PATH'|g" file.js

# Examples:
sed -i '' "s|['\"]../frontmatter/claude-validator.js['\"]|'../platforms/claude/validator.js'|g" file.js
sed -i '' "s|['\"]../serialization/claude-serializer.js['\"]|'../platforms/claude/serializer.js'|g" file.js

# For files that moved (internal imports)
# Old location: bin/lib/platforms/claude-adapter.js
#   import { serializeFrontmatter } from '../serialization/claude-serializer.js';
# New location: bin/lib/platforms/claude/adapter.js
#   import { serializeFrontmatter } from './serializer.js'; (same directory now)

sed -i '' "s|['\"]../serialization/claude-serializer.js['\"]|'./serializer.js'|g" \
  bin/lib/platforms/claude/adapter.js
```

### Finding All Imports to Update

```bash
# Source: POSIX grep documentation

# Find all imports of a specific file
grep -r "from.*claude-validator" bin/lib/ tests/ --include="*.js"

# Find all imports from a directory
grep -r "from.*['\"].*frontmatter/" bin/lib/ tests/ --include="*.js"

# Find all platform-specific imports
grep -r "from.*['\"].*\(claude\|copilot\|codex\)" bin/lib/ tests/ --include="*.js"

# Count imports (to track progress)
grep -r "from.*frontmatter/claude" bin/lib/ tests/ --include="*.js" | wc -l

# Verify cleanup (should return 0 results)
grep -r "from.*frontmatter/claude" bin/lib/ tests/ --include="*.js"
```

### Validating Import Resolution

```bash
# Source: Node.js ESM documentation

# Test import resolves (fails fast if broken)
node --eval "import('./bin/lib/platforms/claude/validator.js').then(() => console.log('OK'))"

# Test multiple imports
node --eval "
  Promise.all([
    import('./bin/lib/platforms/claude/validator.js'),
    import('./bin/lib/platforms/claude/serializer.js'),
    import('./bin/lib/platforms/claude/adapter.js')
  ]).then(() => console.log('All imports OK'))
"

# Full validation: run install test
mkdir -p /tmp/gsd-test-validate
cd /tmp/gsd-test-validate
node /absolute/path/to/bin/install.js --claude
# Exit code 0 = success
```

### Rollback Strategy

```bash
# Source: Git documentation

# If migration fails validation:

# 1. Check current state
git status
git log --oneline -5

# 2. Rollback last commit (soft = keep changes, hard = discard)
git reset --hard HEAD~1

# 3. Verify rollback
git status  # Should be clean
git log --oneline -5  # Migration commit should be gone

# 4. Code should work again
mkdir -p /tmp/gsd-test-rollback
cd /tmp/gsd-test-rollback
node /absolute/path/to/bin/install.js --claude

# If mid-migration (uncommitted changes):
git reset --hard HEAD  # Discard all uncommitted changes
git clean -fd          # Remove untracked files/directories
```

### Shared File Migration

```bash
# Source: CONTEXT.md decisions + empirical testing

# Move shared files (base classes that platforms extend)
mkdir -p bin/lib/platforms/_shared

git mv bin/lib/frontmatter/base-validator.js bin/lib/platforms/_shared/base-validator.js
git mv bin/lib/platforms/base-adapter.js bin/lib/platforms/_shared/base-adapter.js
git mv bin/lib/frontmatter/field-validators.js bin/lib/platforms/_shared/field-validators.js
git mv bin/lib/frontmatter/validation-error.js bin/lib/platforms/_shared/validation-error.js

# Update imports in platform files that extend these
# Example: claude/validator.js extends BaseValidator
sed -i '' "s|['\"]../frontmatter/base-validator.js['\"]|'../_shared/base-validator.js'|g" \
  bin/lib/platforms/claude/validator.js

sed -i '' "s|['\"].*/base-validator.js['\"]|'../_shared/base-validator.js'|g" \
  bin/lib/platforms/copilot/validator.js

# Note: Adapters now import from _shared (up one level from claude/, copilot/, etc.)
sed -i '' "s|['\"]./base-adapter.js['\"]|'../_shared/base-adapter.js'|g" \
  bin/lib/platforms/claude/adapter.js
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Domain-based structure (MVC-style) | Feature/platform-based structure | ~2020 onwards | Better encapsulation, easier to add platforms |
| Manual find-replace for imports | AST-based refactoring (jscodeshift) | 2019+ | AST tools for complex refactoring, manual for simple |
| Single big-bang migration | Phased migration with validation | Ongoing best practice | Safer, easier to debug, can rollback |
| Flat test directory | Tests mirror source structure | ~2018 onwards | Easier to find tests, clearer organization |
| `_private/` for internal code | `_shared/` for shared utilities | 2022+ | More intuitive naming |

**Deprecated/outdated:**
- **CommonJS require()**: ESM is standard for Node.js 18+ (2022)
- **Import without extensions**: Never worked in ESM, must include `.js`
- **Directory imports**: ESM requires explicit `/index.js`, no auto-resolution

## Open Questions

None - all research questions resolved with HIGH confidence.

## Sources

### Primary (HIGH confidence)
- Git documentation (man git-mv, git log --follow) - Verified rename detection and history preservation
- Node.js ESM specification - Module resolution requirements tested empirically
- POSIX sed/grep documentation - String replacement patterns verified with test files
- Empirical testing (see bash examples above) - All patterns tested in /tmp before documenting

### Secondary (MEDIUM confidence)
- Directory naming conventions (_shared/ vs shared/) - Based on GitHub ecosystem analysis (qualitative observation)
- Industry trends for structure organization - Based on modern framework conventions (Next.js, NestJS patterns)

### Tertiary (LOW confidence)
None - all findings verified with primary sources or empirical testing.

## Metadata

**Confidence breakdown:**
- Git mv history preservation: HIGH - Verified empirically with git log --follow
- Import update patterns: HIGH - Tested sed patterns on sample files
- Phased migration safety: HIGH - Tested partial migration scenarios, verified failure modes
- ESM requirements: HIGH - Node.js official behavior, tested directly
- Common pitfalls: MEDIUM - Based on experience patterns, verified where possible
- Tool recommendations: HIGH - Tested jscodeshift vs sed for this scope

**Research date:** 2026-02-01
**Valid until:** 90 days (directory restructuring patterns are stable)
**Context constraints:** Decisions in CONTEXT.md locked: phased approach, git mv, _shared/ naming, test mirroring
