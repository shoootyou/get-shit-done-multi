---
phase: 06.1-old-version-detection-migration
plan: 03
type: execute
wave: 2
depends_on: [06.1-01, 06.1-02]
files_modified:
  - bin/lib/installer/orchestrator.js
  - bin/lib/cli/interactive.js
  - bin/lib/updater/check-update.js
  - bin/lib/updater/update-messages.js
files_created: []
autonomous: true
must_haves:
  observables:
    - orchestrator_integration: Pre-installation check detects old versions before regular flow
    - interactive_integration: Migration prompt appears after banner, before platform selection
    - updater_integration: check-update command detects and warns about old versions
    - flow_order: Banner → Old version check → Migration → Platform detection → Installation
  artifacts:
    - Updated orchestrator with migration pre-check
    - Updated interactive mode with migration flow
    - Updated check-update with incompatibility warning
  wiring:
    - Orchestrator calls detectOldVersion before validateVersionBeforeInstall
    - Interactive mode calls performMigration after intro, before platform prompts
    - Check-update shows special message for old versions
  key_links:
    - Migration happens before any installation logic
    - Migration module independent - doesn't modify core installation
---

# Phase 06.1 Plan 03: Integration with Installer Flows

## Objective

Integrate old version detection and migration into three key flows: orchestrator (non-interactive), interactive mode, and check-updates command. Migration happens early in flow, before platform selection or installation.

## Context

**From CONTEXT.md:**
- D1.4: Flow timing - Banner → Old version check → Migration → Regular installation
- D3.3: Migration module INDEPENDENT - doesn't modify core installation behavior
- D4.1: Multiple scopes - warn about both, migrate requested scope only
- D4.2: Multiple platforms - migrate all old platforms with single confirmation

**From RESEARCH.md:**
- Integration points:
  1. Orchestrator pre-check (before validateVersionBeforeInstall)
  2. Interactive mode (after platform detection, before prompts)
  3. Check-updates (detect and warn about incompatibility)

**Existing flow structure:**
- Orchestrator: `install(appVersion, options)` → validation gate → installation
- Interactive: `runInteractive()` → intro → platform select → installation
- Check-update: `checkForUpdates()` → version comparison → show messages

## Tasks

<task id="3.1" type="modify">
  <files>bin/lib/installer/orchestrator.js</files>
  <action>
Add old version migration check to orchestrator before regular installation:

**Location:** At start of `install()` function, before `validateVersionBeforeInstall()`

**Code to add:**
```javascript
// Import at top
import { detectOldVersion } from '../version/old-version-detector.js';
import { performMigration } from '../migration/migration-manager.js';

// In install() function, after banner/intro, before validateVersionBeforeInstall():
export async function install(appVersion, options = {}) {
  const { platform, targetDir = '.', skipPrompts = false } = options;
  
  // === EXISTING: Show banner/intro ===
  // ... existing code ...
  
  // === NEW: Old version migration check ===
  const oldVersionResult = await detectOldVersion(platform, targetDir);
  
  if (oldVersionResult.isOld) {
    const migrationResult = await performMigration(
      platform, 
      oldVersionResult.version, 
      targetDir,
      { skipPrompts }
    );
    
    if (!migrationResult.success) {
      // Migration failed or user declined
      if (migrationResult.error === 'User declined') {
        logger.info('Installation cancelled. Your v1.x installation remains unchanged.', 2);
        process.exit(0);
      } else {
        logger.error(`Migration failed: ${migrationResult.error}`, 2);
        logger.warn('Your v1.x installation remains unchanged.', 2);
        process.exit(1);
      }
    }
    
    // Migration successful - continue with regular installation
    logger.success('Migration complete. Proceeding with v2.0.0 installation...');
    console.log();
  }
  
  // === EXISTING: Version validation gate ===
  await validateVersionBeforeInstall(platform, targetDir, appVersion, { skipPrompts });
  
  // ... rest of existing installation code ...
}
```

**Key points:**
- Check happens BEFORE any installation validation
- User declining migration exits with code 0 (not an error)
- Migration failure exits with code 1
- Successful migration logs message and continues to regular installation
- skipPrompts option passed through to migration (for CI/CD)

**Don't modify:**
- Existing installation logic
- Existing validation flow
- Existing error handling patterns
  </action>
  <verify>
```bash
# Check imports added
grep "migration-manager" bin/lib/installer/orchestrator.js

# Check integration point
grep -A 10 "detectOldVersion" bin/lib/installer/orchestrator.js

# Verify no syntax errors
node --check bin/lib/installer/orchestrator.js
```
  </verify>
  <done>
Orchestrator updated with old version migration pre-check before installation validation
  </done>
</task>

<task id="3.2" type="modify">
  <files>bin/lib/cli/interactive.js</files>
  <action>
Add old version migration to interactive mode flow:

**Location:** In `runInteractive()` function, after intro, before platform selection prompts

**Code to add:**
```javascript
// Import at top
import { detectAllOldVersions } from '../version/old-version-detector.js';
import { performMigration } from '../migration/migration-manager.js';

// In runInteractive() function:
export async function runInteractive() {
  // === EXISTING: Intro banner ===
  p.intro(chalk.cyan.bold('get-shit-done installer'));
  
  // === NEW: Check for old versions across all platforms ===
  const oldVersions = await detectAllOldVersions('.');
  
  if (oldVersions.length > 0) {
    // Show detected old versions
    console.log();
    logger.warnSubtitle('Old Versions Detected', 0, 80, true);
    
    for (const old of oldVersions) {
      logger.warn(`${old.platform}: v${old.version} (incompatible with v2.0.0)`, 2);
    }
    console.log();
    
    // Migrate each platform
    for (const old of oldVersions) {
      const migrationResult = await performMigration(
        old.platform,
        old.version,
        '.',
        { skipPrompts: false }
      );
      
      if (!migrationResult.success) {
        if (migrationResult.error === 'User declined') {
          p.cancel('Installation cancelled.');
          process.exit(0);
        } else {
          p.cancel(`Migration failed: ${migrationResult.error}`);
          process.exit(1);
        }
      }
    }
    
    logger.success('All migrations complete. Continuing with v2.0.0 installation...');
    console.log();
  }
  
  // === EXISTING: Platform detection and prompts ===
  const { installed, recommended } = await detectPlatforms();
  
  // ... rest of existing interactive flow ...
}
```

**Key points:**
- Check ALL platforms at once (detectAllOldVersions)
- Show all detected old versions before prompting
- Migrate each platform sequentially with user confirmation
- User can decline at first migration (exits for all)
- After migrations, continue to regular platform selection

**Edge case (D4.4):** Mixed old/new same platform
- Detection only returns truly old versions (v1.x structure)
- New v2.0 installations ignored by detectAllOldVersions

**Don't modify:**
- Existing platform detection logic
- Existing prompt flows
- Existing installation execution
  </action>
  <verify>
```bash
# Check imports added
grep "detectAllOldVersions" bin/lib/cli/interactive.js

# Check integration point
grep -A 15 "oldVersions" bin/lib/cli/interactive.js

# Verify no syntax errors
node --check bin/lib/cli/interactive.js
```
  </verify>
  <done>
Interactive mode updated with old version detection and migration before platform selection
  </done>
</task>

<task id="3.3" type="modify">
  <files>bin/lib/updater/check-update.js</files>
  <action>
Add old version detection to check-update command:

**Location:** In `checkForUpdates()` function, before version comparison logic

**Code to add:**
```javascript
// Import at top
import { detectAllOldVersions } from '../version/old-version-detector.js';
import { showOldVersionMessage } from './update-messages.js';

// In checkForUpdates() function:
export async function checkForUpdates(targetDir = '.') {
  // === NEW: Check for old versions first ===
  const oldVersions = await detectAllOldVersions(targetDir);
  
  if (oldVersions.length > 0) {
    // Show special incompatibility message for old versions
    showOldVersionMessage(oldVersions);
    
    // Don't proceed to regular update check - old versions need migration, not update
    return {
      hasOldVersion: true,
      oldVersions: oldVersions,
      updateAvailable: false
    };
  }
  
  // === EXISTING: Regular version comparison ===
  // ... existing check-update logic ...
}
```

**Key points:**
- Check for old versions BEFORE comparing v2.x versions
- Old versions get special message (incompatibility, not update)
- Return early if old versions found (don't confuse with regular updates)
- Old version detection doesn't block regular update checks for v2.x

**Don't modify:**
- Existing version comparison logic (for v2.x → v2.x updates)
- Existing update message patterns
  </action>
  <verify>
```bash
# Check imports added
grep "detectAllOldVersions" bin/lib/updater/check-update.js

# Check integration
grep -A 10 "oldVersions" bin/lib/updater/check-update.js

# Verify no syntax errors
node --check bin/lib/updater/check-update.js
```
  </verify>
  <done>
Check-update command updated with old version detection and incompatibility handling
  </done>
</task>

<task id="3.4" type="modify">
  <files>bin/lib/updater/update-messages.js</files>
  <action>
Add old version incompatibility message to update-messages module:

**Code to add:**
```javascript
import * as logger from '../cli/logger.js';
import chalk from 'chalk';

/**
 * Show incompatibility message for old v1.x versions
 * Per CONTEXT Decision D4.2: Show all old versions detected
 */
export function showOldVersionMessage(oldVersions) {
  console.log();
  logger.warnSubtitle('Incompatible Version Detected', 0, 80, true);
  console.log();
  
  logger.warn('The following installations are incompatible with v2.0.0:', 2);
  console.log();
  
  for (const old of oldVersions) {
    logger.listItem(`${chalk.bold(old.platform)}: v${old.version} (v1.x structure)`, 4);
  }
  
  console.log();
  logger.info('What to do:', 2);
  logger.listItem('Run the installer: npx get-shit-done-multi', 4);
  logger.listItem('The installer will offer to migrate your v1.x installation', 4);
  logger.listItem('Your old version will be backed up before upgrading', 4);
  console.log();
  
  logger.warn('Note: v1.x cannot be updated to v2.0 incrementally.', 2);
  logger.warn('Migration creates a full backup and fresh v2.0 installation.', 2);
  console.log();
}

/**
 * Show regular update available message
 * (Existing function - kept for v2.x → v2.x updates)
 */
export function showUpdateMessage(currentVersion, latestVersion) {
  // ... existing implementation ...
}
```

**Key points:**
- Clear distinction: "incompatible" not "update available"
- Lists all platforms with old versions
- Actionable guidance: run installer (not manual update)
- Explains migration creates backup
- Separate from regular update messages (v2.x → v2.x)

**Don't modify:**
- Existing showUpdateMessage function
- Existing message formatting patterns
  </action>
  <verify>
```bash
# Check function added
grep "showOldVersionMessage" bin/lib/updater/update-messages.js

# Check export
grep "export function showOldVersionMessage" bin/lib/updater/update-messages.js

# Verify no syntax errors
node --check bin/lib/updater/update-messages.js
```
  </verify>
  <done>
Update-messages module updated with old version incompatibility message
  </done>
</task>

## Verification Criteria

- [ ] Orchestrator calls detectOldVersion before validateVersionBeforeInstall
- [ ] Migration happens before any installation validation
- [ ] User declining migration exits with code 0
- [ ] Interactive mode detects all old versions at start
- [ ] Multiple platforms migrated sequentially with confirmations
- [ ] Check-update shows incompatibility message for old versions
- [ ] Old version message distinct from regular update message
- [ ] No modifications to core installation logic

## Success Criteria

**Observable:**
1. Running `npx get-shit-done-multi --claude` on v1.x shows migration prompt before installation
2. Running `npx get-shit-done-multi` (interactive) shows all old versions, migrates each
3. Running check-update on v1.x shows incompatibility message (not "update available")
4. After migration, regular installation proceeds normally

**Technical:**
1. Integration follows flow order: Banner → Migration → Installation
2. Migration module remains independent (no core logic changes)
3. All three entry points (orchestrator, interactive, check-update) handle old versions
4. Error exits have correct codes (0 for decline, 1 for failure)

## Output

- `bin/lib/installer/orchestrator.js` - Updated with migration pre-check
- `bin/lib/cli/interactive.js` - Updated with multi-platform migration
- `bin/lib/updater/check-update.js` - Updated with old version detection
- `bin/lib/updater/update-messages.js` - Updated with incompatibility message
- All three flows integrated and ready for testing in Wave 3
