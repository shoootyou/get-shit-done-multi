---
phase: 06.1-old-version-detection-migration
plan: 04
type: execute
wave: 3
depends_on: [06.1-01, 06.1-02, 06.1-03]
files_modified:
  - README.md
files_created:
  - tests/integration/migration-flow.test.js
autonomous: true
must_haves:
  observables:
    - e2e_tests: End-to-end migration scenarios validate full flow
    - user_confirm_scenario: Test user confirming migration
    - user_decline_scenario: Test user declining migration
    - backup_failure_scenario: Test backup failure preserves old files
    - multi_platform_scenario: Test multiple platforms migrating sequentially
    - documentation: README has "Upgrading from v1.x" section
  artifacts:
    - Integration test suite covering all migration scenarios
    - README documentation for v1.x users
  wiring:
    - Tests exercise orchestrator + interactive + check-update flows
    - Tests verify backup creation and old file removal
  key_links:
    - Integration tests validate ROADMAP success criteria
    - Documentation gives users clear upgrade path
---

# Phase 06.1 Plan 04: Integration Tests & Documentation

## Objective

Create end-to-end integration tests covering all migration scenarios (confirm, decline, failures, multi-platform) and document the upgrade process in README for v1.x users.

## Context

**From ROADMAP success criteria:**
1. Installer detects old v1.x installations (monolithic structure) ✓
2. User sees clear warning ✓
3. Single confirmation prompt ✓
4. If Yes: Automatic backup to .gsd-backup/YYYY-MM-DD-HHMM/ ✓
5. All old files moved to backup ✓
6. Clear message shows backup location ✓
7. v2.0.0 installation proceeds after successful backup ✓
8. If No: Exit with explanation ✓
9. Backup failures preserve old files ✓
10. Integration tests pass for all migration scenarios ← THIS TASK

**From CONTEXT.md:**
- D1.4: Flow timing - Banner → Old version check → Migration → Regular installation
- D3.1: Backup fails → abort, no changes
- D3.2: Partial backup → retry 3x, keep partial, cancel
- D4.1: Multiple scopes - migrate one at a time
- D4.2: Multiple platforms - migrate all with single confirmation each

**Testing requirements:**
- TEST-01: Execute under /tmp directory
- TEST-02: Cleanup test folders after completion

## Tasks

<task id="4.1" type="create">
  <files>tests/integration/migration-flow.test.js</files>
  <action>
Create integration tests for migration flow:

**Test setup:**
```javascript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { mkdir, writeFile, rm, pathExists, readdir } from 'fs-extra';
import { join } from 'path';
import { performMigration } from '../../bin/lib/migration/migration-manager.js';
import { detectOldVersion } from '../../bin/lib/version/old-version-detector.js';

// Create unique test directory per TEST-01
const getTestDir = () => `/tmp/gsd-migration-test-${Date.now()}`;
```

**Test suites:**

**1. End-to-End Migration Flow - User Confirms**
```javascript
describe('E2E Migration - User Confirms', () => {
  let testDir;
  
  beforeEach(async () => {
    testDir = getTestDir();
    
    // Create v1.x Claude installation
    await mkdir(join(testDir, '.claude/get-shit-done'), { recursive: true });
    await mkdir(join(testDir, '.claude/commands/gsd'), { recursive: true });
    await writeFile(join(testDir, '.claude/get-shit-done/VERSION'), '1.8.0');
    await writeFile(join(testDir, '.claude/commands/gsd/test.md'), '# Test');
  });
  
  afterEach(async () => {
    await rm(testDir, { recursive: true, force: true });
  });
  
  it('should detect old version', async () => {
    const result = await detectOldVersion('claude', testDir);
    expect(result.isOld).toBe(true);
    expect(result.version).toBe('1.8.0');
    expect(result.paths).toContain('.claude/get-shit-done');
  });
  
  it('should create backup directory', async () => {
    const result = await performMigration('claude', '1.8.0', testDir, { 
      skipPrompts: true 
    });
    
    expect(result.success).toBe(true);
    expect(result.backupPath).toMatch(/\.gsd-backup\/\d{4}-\d{2}-\d{2}-\d{4}/);
    
    // Verify backup exists
    const backupExists = await pathExists(join(testDir, result.backupPath));
    expect(backupExists).toBe(true);
  });
  
  it('should copy all old files to backup', async () => {
    const result = await performMigration('claude', '1.8.0', testDir, { 
      skipPrompts: true 
    });
    
    // Check VERSION file in backup
    const versionInBackup = await pathExists(
      join(testDir, result.backupPath, '.claude/get-shit-done/VERSION')
    );
    expect(versionInBackup).toBe(true);
    
    // Check commands in backup
    const commandsInBackup = await pathExists(
      join(testDir, result.backupPath, '.claude/commands/gsd/test.md')
    );
    expect(commandsInBackup).toBe(true);
  });
  
  it('should remove old files after successful backup', async () => {
    await performMigration('claude', '1.8.0', testDir, { 
      skipPrompts: true 
    });
    
    // Old files should be gone
    const oldCommandsExist = await pathExists(
      join(testDir, '.claude/commands/gsd/test.md')
    );
    expect(oldCommandsExist).toBe(false);
  });
});
```

**2. End-to-End Migration Flow - User Declines**
```javascript
describe('E2E Migration - User Declines', () => {
  it('should preserve old files when user declines', async () => {
    // Mock @clack/prompts to return false
    // Test that old files unchanged
    // Test that function returns { success: false, error: 'User declined' }
  });
});
```

**3. Backup Failure Scenarios**
```javascript
describe('Backup Failure Scenarios', () => {
  it('should abort on insufficient disk space', async () => {
    // Mock calculateDirectorySize to return huge number
    // Mock checkDiskSpace to return warning
    // Verify error thrown before any copies
    // Verify old files unchanged
  });
  
  it('should keep partial backup on copy failures', async () => {
    // Mock copyDirectory to fail on 2nd file
    // Verify partial backup directory exists
    // Verify old files unchanged
    // Verify return includes failed paths
  });
  
  it('should retry failed copies 3 times', async () => {
    // Mock copyDirectory to fail 2 times, succeed on 3rd
    // Verify retry logic executed
    // Verify eventual success
  });
});
```

**4. Multi-Platform Scenarios**
```javascript
describe('Multi-Platform Migration', () => {
  it('should detect multiple platforms with old versions', async () => {
    // Create v1.x for Claude, Copilot, and Codex
    // Run detectAllOldVersions
    // Verify all three detected
  });
  
  it('should migrate each platform to separate backup', async () => {
    // Migrate Claude
    // Migrate Copilot
    // Verify two separate .gsd-backup directories
    // Verify platform-specific paths in each
  });
});
```

**5. Edge Cases**
```javascript
describe('Edge Cases', () => {
  it('should handle missing VERSION file gracefully', async () => {
    // Create old structure without VERSION
    // Verify detection returns isOld: false
  });
  
  it('should handle backup directory already exists', async () => {
    // Create .gsd-backup/2024-01-28-1400/
    // Run migration
    // Verify new backup with -SS suffix created
  });
  
  it('should preserve directory structure in backup', async () => {
    // Create nested structure
    // Run migration
    // Verify exact structure in backup
  });
});
```

**Assertions:**
- Use vitest expect() assertions
- Test both success and failure paths
- Verify file existence with pathExists
- Verify directory contents with readdir
- Mock @clack/prompts for user interaction tests
- Mock disk space checks for failure scenarios
  </action>
  <verify>
```bash
# Run integration tests
npm test -- migration-flow.test.js

# Check all scenarios pass
npm test -- migration-flow.test.js --reporter=verbose

# Verify cleanup
ls /tmp/gsd-migration-test-* 2>/dev/null || echo "Cleanup successful"
```
  </verify>
  <done>
Integration tests created and passing, all migration scenarios validated, cleanup working
  </done>
</task>

<task id="4.2" type="modify">
  <files>README.md</files>
  <action>
Add "Upgrading from v1.x" section to README:

**Location:** After "Installation" section, before "Usage" section

**Content to add:**
```markdown
## Upgrading from v1.x

If you have an older v1.x installation of get-shit-done, the v2.0.0 installer will automatically detect it and offer to migrate.

### What Happens

1. **Detection:** The installer detects your v1.x installation automatically
2. **Warning:** You'll see a clear message about the incompatibility
3. **Confirmation:** A single prompt asks: "Create backup and upgrade?"
4. **Backup:** If you confirm, all old files are backed up to `.gsd-backup/YYYY-MM-DD-HHMM/`
5. **Installation:** v2.0.0 is installed fresh after successful backup

### Example Migration Flow

```bash
$ npx get-shit-done-multi

⚠ Old Version Detected
  Version 1.8.0 is incompatible with v2.0.0

What will happen:
  • Backup v1.8.0 to .gsd-backup/2024-01-28-1400/
  • Remove old files
  • Install v2.0.0

? Create backup and upgrade? [Y/n]
```

### Backup Location

Your old installation is backed up to:
- **Local installations:** `.gsd-backup/YYYY-MM-DD-HHMM/` in your project directory
- **Global installations:** `.gsd-backup/YYYY-MM-DD-HHMM/` in your home directory

The backup preserves your complete v1.x installation. You can delete it manually after verifying v2.0.0 works correctly.

### What Changed from v1.x to v2.0

**Structure:**
- **Old (v1.x):** Monolithic `get-shit-done/` skill with all commands
- **New (v2.0):** Individual `gsd-*` skills for each command

**Versioning:**
- **Old (v1.x):** Single `VERSION` file
- **New (v2.0):** Per-skill `version.json` files

**Claude Hooks:**
- **Old (v1.x):** Hooks in `.claude/hooks/`
- **New (v2.0):** No hooks (removed)

**Agent Naming:**
- **Old (v1.x):** Claude used `gsd-*.md` (no .agent.md suffix)
- **New (v2.0):** All platforms use `gsd-*.agent.md`

### Troubleshooting

**"Insufficient disk space for backup"**
- Free up space equal to your current installation size + 10%
- Or move to a directory with more space

**"Backup failed: Permission denied"**
- Ensure you have write permissions to create `.gsd-backup/`
- For global installations, you may need elevated permissions

**Migration declined**
- Your v1.x installation remains unchanged
- v1.x and v2.0 cannot coexist - migration is required for upgrade

### Manual Migration (Advanced)

If you prefer to migrate manually:

1. **Backup your v1.x installation:**
   ```bash
   cp -r .claude/commands/gsd .gsd-backup-manual/claude-commands
   cp -r .claude/agents .gsd-backup-manual/claude-agents
   # Repeat for other platforms
   ```

2. **Remove old installation:**
   ```bash
   rm -rf .claude/commands/gsd
   rm -rf .claude/agents/gsd-*
   rm -rf .claude/hooks/gsd-*
   rm -rf .claude/get-shit-done
   # Repeat for other platforms
   ```

3. **Install v2.0:**
   ```bash
   npx get-shit-done-multi
   ```

**Note:** Automatic migration is recommended - it handles all platforms and edge cases correctly.
```

**Key points:**
- Place BEFORE "Usage" section (users with v1.x need this first)
- Clear, step-by-step explanation
- Example shows actual user experience
- Troubleshooting for common issues
- Manual migration option for advanced users
- Explains what changed and why migration needed
  </action>
  <verify>
```bash
# Check section added
grep "Upgrading from v1.x" README.md

# Verify markdown formatting
npx markdownlint README.md || echo "Check linting"

# Check section placement (before Usage)
grep -A 5 "Upgrading from" README.md | grep -B 5 "Usage"
```
  </verify>
  <done>
README updated with comprehensive "Upgrading from v1.x" section including troubleshooting and manual migration guide
  </done>
</task>

## Verification Criteria

- [ ] Integration tests created in `tests/integration/migration-flow.test.js`
- [ ] Tests cover user confirm scenario
- [ ] Tests cover user decline scenario
- [ ] Tests cover backup failure scenarios
- [ ] Tests cover multi-platform scenarios
- [ ] Tests cover edge cases (missing VERSION, duplicate backup dirs)
- [ ] All tests execute under /tmp per TEST-01
- [ ] Test cleanup works per TEST-02
- [ ] README has "Upgrading from v1.x" section
- [ ] Documentation includes troubleshooting
- [ ] Manual migration guide included

## Success Criteria

**Observable:**
1. Running `npm test -- migration-flow.test.js` shows all scenarios passing
2. Tests validate all 10 ROADMAP success criteria
3. README clearly explains upgrade path for v1.x users
4. Documentation includes troubleshooting for common issues

**Technical:**
1. Integration tests exercise full flow (detect → prompt → backup → remove → install)
2. Tests use mocks for user interaction (@clack/prompts)
3. Tests validate file operations (backup created, old files removed)
4. Test directories cleaned up automatically

## Output

- `tests/integration/migration-flow.test.js` - Comprehensive E2E tests
- `README.md` - Updated with "Upgrading from v1.x" section
- All ROADMAP success criteria validated by tests
- Users have clear documentation for migration process
