---
phase: 12.2-add-npm-publishing-workflow-with-github-actions
plan: 01
subsystem: ci-cd
completed: 2026-02-01
duration: 4 minutes

tags:
  - github-actions
  - npm-publishing
  - ci-cd
  - release-automation
  - workflow

requires:
  - phase: 12
    provides: Package structure with files field
  - phase: all-prior
    provides: Stable codebase ready for publishing

provides:
  - Stable release workflow for main branch
  - Pre-release workflow for dev branch
  - Comprehensive releasing documentation
  - NPM publishing automation
  - Git tag and GitHub release creation

affects:
  - future: maintainer-workflows
    impact: Enables one-click publishing to NPM
  - future: version-management
    impact: Establishes version control patterns

tech-stack:
  added:
    - GitHub Actions workflows
    - GitHub CLI (gh)
    - jq for JSON manipulation
  patterns:
    - Manual workflow dispatch for controlled releases
    - Pre-flight validation before point-of-no-return
    - Conditional dist-tag based on version format
    - Atomic tag and release creation
    - Ephemeral package.json version updates

key-files:
  created:
    - .github/workflows/publish-main.yml
    - .github/workflows/publish-dev.yml
    - docs/releasing.md
  modified: []

decisions:
  - id: two-workflow-approach
    what: Separate workflows for main (stable) and dev (pre-release) branches
    why: Different permission requirements, version validation, and dist-tags
    impact: Clear separation of stable vs pre-release publishing

  - id: ephemeral-version-update
    what: Update package.json during workflow but don't commit back to repo
    why: Version tracked in git tags, avoid commit spam
    impact: Git tags are source of truth for versions

  - id: validate-before-tag
    what: All checks (tests, build, tarball) before creating git tag
    why: Git tags are immutable, avoid orphaned tags
    impact: Safe failure path before point-of-no-return

  - id: conditional-dist-tag
    what: Dev workflow auto-detects pre-release and uses appropriate dist-tag
    why: Pre-releases should use beta tag, not latest
    impact: Users don't get pre-releases unless explicitly requesting

  - id: use-gh-cli
    what: Use GitHub CLI for release creation instead of deprecated actions
    why: actions/create-release is deprecated and unmaintained
    impact: Future-proof release creation

  - id: granular-npm-token
    what: Recommend granular access tokens over classic automation tokens
    why: Better security, scope to specific package
    impact: More secure token management

metrics:
  tasks-completed: 3
  files-created: 3
  lines-added: 847
  commits: 3
  deviations: 0
---

# Phase 12.2 Plan 01: Add NPM Publishing Workflow Summary

**One-liner:** Automated NPM publishing with dual workflows for stable (main) and pre-release (dev) branches using GitHub Actions

## What Was Built

Created a complete NPM publishing automation system with two GitHub Actions workflows and comprehensive maintainer documentation.

### Workflow Architecture

**publish-main.yml** - Stable releases from main branch:
- Admin-only trigger via workflow_dispatch
- Validates version format (X.Y.Z only, no pre-release suffixes)
- Publishes to NPM with `latest` dist-tag
- Creates annotated git tags and GitHub releases
- 16-step validation pipeline from input to publish

**publish-dev.yml** - Pre-releases from dev branch:
- Write-access trigger for pre-release testing
- Validates version format (X.Y.Z or X.Y.Z-prerelease)
- Conditional dist-tag: `beta` for pre-releases, `latest` for stable
- Same 16-step validation pipeline as main
- Enables alpha, beta, and RC testing before stable release

### Validation Pipeline (Both Workflows)

Both workflows follow the same comprehensive validation sequence:

1. **Pre-flight checks** (safe failure zone):
   - Version format validation (regex based on branch)
   - Tag existence check (prevents duplicates)
   - Version comparison (must be higher than current)
   - Files field verification (prevents empty packages)
   - Version update in package.json (ephemeral)
   - Dependency installation
   - Test execution
   - Build execution (if build script exists)
   - Tarball creation and installation test
   - Dry-run publish validation

2. **Point of no return** - Git tag creation (immutable)

3. **Publishing** (requires manual intervention if fails):
   - GitHub release creation
   - NPM package publish

### Documentation

**docs/releasing.md** - Comprehensive maintainer guide covering:
- Prerequisites (NPM_TOKEN setup)
- Step-by-step stable release instructions
- Step-by-step pre-release instructions
- Version numbering conventions (semver)
- Troubleshooting (8+ common failure scenarios)
- NPM token setup (granular vs classic)
- Token rotation schedule
- Workflow behavior explanation
- Manual recovery procedures
- Tag deletion process
- Examples of successful and failed releases
- Best practices

## Technical Decisions

### Version Management Strategy

**Decision:** Input version updates package.json during workflow but doesn't commit back to repository.

**Rationale:** 
- Git tags are the source of truth for versions
- Avoids commit spam from bot accounts
- Prevents merge conflicts on version bumps
- Keeps main/dev branches clean

**Implementation:** Uses `jq` to update package.json ephemeral for publish, version lives only in git tags and NPM registry.

### Two-Workflow Approach

**Decision:** Separate workflows instead of single workflow with branch conditions.

**Rationale:**
- Different permission requirements (main = admins only)
- Different version validation rules (main disallows pre-release)
- Different NPM dist-tags (latest vs beta)
- Clearer intent and easier to audit
- Simpler workflow logic

**Tradeoff:** Some duplication, but worth it for clarity and safety.

### Validation Order

**Decision:** Extensive validation BEFORE git tag creation.

**Rationale:**
- Git tags are immutable and should not be deleted
- Tag existence indicates intent to publish
- Orphaned tags (tag exists but NPM not published) are confusing
- All checks before point-of-no-return enables safe failure

**Implementation:** 10 validation steps before tag creation, only 2 steps after.

### Conditional Dist-Tag Logic

**Decision:** Dev workflow auto-detects pre-release suffix and uses appropriate dist-tag.

**Rationale:**
- Pre-release versions should use `beta` tag to avoid polluting `latest`
- Dev branch may publish stable versions in emergency situations
- Automatic detection prevents human error

**Implementation:** Bash regex check `[[ "$version" =~ - ]]` determines tag.

### GitHub CLI for Releases

**Decision:** Use `gh release create` instead of actions/create-release.

**Rationale:**
- actions/create-release deprecated and unmaintained
- gh CLI is pre-installed on all GitHub Actions runners
- Simpler syntax, actively maintained
- Future-proof approach

**Implementation:** `gh release create` with GH_TOKEN from github.token.

### NPM Token Type

**Decision:** Recommend granular access tokens over classic automation tokens.

**Rationale:**
- Better security posture
- Scope to specific package
- Prevents token from being used for other packages
- Aligns with NPM best practices

**Documentation:** Covers both types with recommendation for granular.

## Success Metrics

✅ **All measurable outcomes met:**

1. `.github/workflows/publish-main.yml` exists with:
   - 16 validation and publish steps ✓
   - Rejects pre-release versions (regex `^[0-9]+\.[0-9]+\.[0-9]+$`) ✓
   - Creates annotated git tags with message ✓
   - Uses gh CLI for GitHub releases ✓
   - Publishes to NPM with `latest` dist-tag ✓

2. `.github/workflows/publish-dev.yml` exists with:
   - Same 16 steps as main workflow ✓
   - Allows pre-release versions (regex includes `(-[a-zA-Z0-9.]+)?`) ✓
   - Conditional dist-tag based on version (beta for pre-release, latest for stable) ✓

3. `docs/releasing.md` exists with:
   - Prerequisites section (NPM_TOKEN setup) ✓
   - Stable release instructions (main branch) ✓
   - Pre-release instructions (dev branch) ✓
   - Version numbering conventions ✓
   - Troubleshooting section (8+ common failures) ✓
   - Manual recovery procedures (orphaned tag cleanup) ✓

4. Workflows follow research best practices:
   - Validate before point-of-no-return (tag creation) ✓
   - Use official actions (setup-node@v6, checkout@v4) ✓
   - Use gh CLI instead of deprecated create-release action ✓
   - Concurrency control prevents race conditions ✓
   - Comprehensive pre-flight checks ✓

5. Ready for manual testing:
   - Requires NPM_TOKEN in repository secrets
   - Can be tested with dry-run before actual publish

## Deviations from Plan

None - plan executed exactly as written.

All tasks completed with no auto-fixes, no missing critical functionality additions, and no blocking issues encountered.

## Implementation Notes

### Workflow Structure

Both workflows share the same structure:
- `workflow_dispatch` trigger with version input
- Concurrency control (separate groups for main/dev)
- Permissions: `contents: write`, `id-token: write`
- Ubuntu-latest runner
- Node.js 20.x via setup-node@v6

### Key Implementation Details

**Version Validation:**
- Main: `^[0-9]+\.[0-9]+\.[0-9]+$` (no pre-release)
- Dev: `^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$` (optional pre-release)

**Version Comparison:**
Uses `printf + sort -V` pattern from research:
```bash
if [ "$(printf '%s\n' "$CURRENT" "$INPUT" | sort -V | head -n1)" != "$CURRENT" ]; then
  # Input is not higher than current
  exit 1
fi
```

**NPM Authentication:**
- setup-node with `registry-url: 'https://registry.npmjs.org'`
- NODE_AUTH_TOKEN from secrets.NPM_TOKEN
- Dry-run publish validates token before tag creation

**Tarball Testing:**
Creates temp directory, installs tarball locally, verifies success:
```bash
TEST_DIR="/tmp/npm-test-$$"
mkdir -p "$TEST_DIR"
cd "$TEST_DIR"
npm install "$OLDPWD/$TARBALL"
```

**Git Configuration:**
Uses github-actions[bot] identity:
```bash
git config user.name "github-actions[bot]"
git config user.email "github-actions[bot]@users.noreply.github.com"
```

### Error Messages

All validation steps include clear error messages with context:
- Invalid format shows expected format and what was received
- Tag exists provides instructions for choosing different version
- Version comparison shows current vs input
- Missing files field explains requirement

### User Experience

**Workflow Inputs:**
- Clear description with examples
- Required field (no default)
- Type: string for flexibility

**Output Messages:**
- Checkmarks (✓) for successful steps
- Error indicators (❌) for failures
- NPM package URL on successful publish
- Install command examples for pre-releases

## Files Changed

### Created Files

| File | Lines | Purpose |
|------|-------|---------|
| `.github/workflows/publish-main.yml` | 168 | Stable release workflow for main branch |
| `.github/workflows/publish-dev.yml` | 176 | Pre-release workflow for dev branch |
| `docs/releasing.md` | 503 | Comprehensive releasing guide for maintainers |

**Total:** 3 files, 847 lines

### Modified Files

None - this was purely additive work.

## Next Phase Readiness

### Enables Future Work

**Immediate capabilities:**
- Maintainers can publish stable releases from main branch
- Maintainers can publish pre-releases from dev branch
- Clear documentation for onboarding new maintainers

**Future enhancements enabled:**
- Changelog generation (can hook into release creation)
- Release notes automation (gh CLI supports release notes)
- NPM provenance (id-token permission already present)
- Multi-registry publishing (workflow structure supports)

### Blockers/Concerns

**Before first use:**
1. **NPM_TOKEN must be added to repository secrets**
   - Maintainer needs NPM account with publish permission
   - Token must be created on npmjs.com
   - Token must be added to GitHub: Settings → Secrets → Actions
   - Document token creation date for rotation schedule

2. **Test workflow with dry-run first**
   - Trigger workflow with test version
   - Will fail at NPM publish without token (expected)
   - Validates all other steps work correctly

**Ongoing considerations:**
- Token rotation schedule (annually recommended)
- Monitor workflow failures for auth issues
- Update documentation if NPM or GitHub Actions change

### Manual Testing Checklist

Before first production use:

1. ✓ Workflows exist and are valid YAML
2. ⏹ Add NPM_TOKEN to repository secrets
3. ⏹ Test main workflow with dry-run version
4. ⏹ Test dev workflow with pre-release version
5. ⏹ Verify error handling (try invalid version)
6. ⏹ Verify tag existence check works
7. ⏹ Document first publish experience

## Knowledge Transfer

### For Future Maintainers

**Critical knowledge:**
- Version must be higher than package.json (workflow validates)
- Tags are immutable - don't delete unless absolutely necessary
- Workflow validates extensively before creating tag (point of no return)
- Pre-releases must use dev workflow or version validation fails
- Token must have publish permission for package

**Common mistakes to avoid:**
- Trying to publish pre-release from main (will fail validation)
- Entering version equal to current (will fail comparison)
- Forgetting to rotate token (calendar reminder recommended)
- Deleting tags without understanding implications

**Debugging tips:**
- Check workflow logs for specific failure step
- Verify NPM_TOKEN is set in repository secrets
- Test locally: `npm ci && npm test && npm run build`
- Use dry-run to validate without publishing
- Check tag existence: `git ls-remote --tags origin | grep vX.Y.Z`

### Research Applied

This implementation directly applies patterns from 12.2-RESEARCH.md:

- **Pattern 1:** Manual workflow with version input ✓
- **Pattern 2:** NPM authentication with setup-node ✓
- **Pattern 3:** Validate before point-of-no-return ✓
- **Pattern 4:** Atomic tag and release creation ✓
- **Pattern 5:** Pre-flight checks ✓
- **Pattern 6:** Update package.json version ✓
- **Pattern 7:** Concurrency control ✓

All anti-patterns avoided:
- ✓ Used gh CLI instead of deprecated actions/create-release
- ✓ Version changes are ephemeral, not committed back
- ✓ Tags are only deleted in documented failure scenarios
- ✓ Publishing happens after all validation
- ✓ Manual control instead of npm version command

## Lessons Learned

### What Went Well

1. **Research phase was thorough** - All patterns from research applied directly
2. **Two-workflow approach** - Clear separation makes intent obvious
3. **Validation ordering** - Safe failure path before tag creation
4. **Documentation completeness** - Covered all common scenarios
5. **Error messages** - Clear and actionable

### What Could Improve

1. **Testing without NPM_TOKEN** - Can validate most steps but not actual publish
2. **Changelog integration** - Future enhancement, not in scope
3. **Automated version bumping** - User must provide version manually
4. **Release notes templates** - Future enhancement for richer releases

### Applicability to Other Projects

This workflow pattern is highly reusable for any NPM package:

**Customize for your project:**
1. Replace package name in documentation
2. Adjust version validation if needed (e.g., allow RC tags)
3. Modify dist-tags if using different naming (alpha, canary, next)
4. Add project-specific validation steps
5. Adjust build/test commands

**Core pattern remains the same:**
- Manual dispatch with version input
- Validate before tag creation
- Use official GitHub Actions
- Clear documentation for maintainers

## Summary

Successfully implemented automated NPM publishing with dual workflows for stable and pre-release branches. The system provides:

- **Safety:** Extensive validation before point-of-no-return (tag creation)
- **Clarity:** Separate workflows for different release types
- **Automation:** One-click publishing from GitHub Actions UI
- **Documentation:** Comprehensive guide for maintainers
- **Best practices:** Follows GitHub Actions and NPM standards

The workflows are ready for use pending NPM_TOKEN configuration in repository secrets. All code follows research patterns and avoids known anti-patterns. Documentation covers common failures and manual recovery procedures.

**Next steps:** Add NPM_TOKEN to secrets, test with dry-run, perform first release.
