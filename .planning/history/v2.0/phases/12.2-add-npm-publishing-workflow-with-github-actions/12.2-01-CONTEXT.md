---
phase: 12.2
discussed: 2026-02-01T13:02:27Z
areas: ["Version Management Strategy", "Git Tag Handling", "NPM Publishing Behavior", "Workflow Security & Permissions"]
decisions_count: 18
---

# Phase 12.2 Context: Add NPM Publishing Workflow

## Essential Features

### Version Management
- Workflow takes version as manual input (e.g., `1.9.1`)
- Input version updates `package.json` automatically during workflow
- Workflow MUST fail if `package.json` already has a higher version than input
- Pre-release versions (alpha, beta, rc) supported ONLY from `dev` branch
- Main branch: stable releases only (no pre-release suffixes)
- Tag existence validation: MUST fail if tag already exists (no overwrites)

### Git Tag Creation
- Workflow creates git tag automatically (user doesn't create manually)
- Tag format: `v{version}` (with 'v' prefix, e.g., `v1.9.1`)
- Tag message: `Release v{version}`
- Tag pushed to remote after creation as part of GitHub release

### NPM Publishing
- Publish with `latest` dist-tag by default
- Tests MUST run before publishing (workflow fails if tests fail)
- Build MUST run before publishing
- Validate installation: `npm pack`, create temp dir, install tarball, verify success
- Verify `package.json` has `files` field (fail if missing)

### GitHub Release
- Workflow creates GitHub release with the tag
- Release tied to the version tag

## Technical Boundaries

### Branch Strategy
- Two separate workflows:
  - `publish-main.yml` - For stable releases from main branch
  - `publish-dev.yml` - For pre-releases from dev branch
- Main branch: Only admins can trigger
- Dev branch: Anyone with write access can trigger

### Authentication
- NPM token stored as GitHub repository secret: `NPM_TOKEN`
- No OIDC, no environment-specific secrets
- Default GitHub token permissions (no elevated permissions)

### Workflow Execution Order
1. Validate input version format
2. Check if tag already exists (fail if yes)
3. Validate package.json version (fail if higher than input)
4. Update package.json to input version
5. Run tests (fail if errors)
6. Run build (fail if errors)
7. Create and pack tarball
8. Install tarball in temp directory (fail if errors)
9. Create git tag (`v{version}`)
10. Push tag to remote
11. Create GitHub release
12. Publish to NPM with `latest` tag

## Scope Limits

### Out of Scope
- Automatic version bumping (user provides version explicitly)
- Changelog generation (future phase)
- Release notes automation (future phase)
- Rollback mechanisms (future phase)
- Multiple dist-tag support (only `latest` for now)
- Custom tag messages (fixed format: `Release v{version}`)
- OIDC trusted publisher setup (use simple token for now)
- Environment-based approvals (permission control at branch level)

### Deferred Ideas
- Automated changelog generation from commits
- Release notes templates
- Slack/Discord notifications on publish
- NPM provenance attestation
- Multi-registry publishing (GitHub Packages + NPM)

## Open Questions

### For Research
- Best practice for NPM token permissions (publish vs automation token)
- Recommended GitHub Actions for NPM publishing (official actions available?)
- How to validate tarball installation without affecting global npm cache
- Should workflow commit package.json version change back to repo?
- Best practice for handling failed publishes (cleanup steps needed?)
- Dry-run capability for testing workflow without actual publish

### Technical Unknowns
- Does `npm publish` automatically use package.json version or need explicit flag?
- How to handle workspace/monorepo scenarios (single package for now)
- GitHub release API requirements and best practices
- Rate limiting concerns for NPM publishing

## User-Observable Outcomes

### Success Case
1. User triggers workflow from GitHub Actions UI
2. Inputs version (e.g., `1.9.1`)
3. Workflow runs all checks and tests
4. Tag `v1.9.1` created and pushed
5. GitHub release published
6. Package published to NPM as `@scope/package@1.9.1` with `latest` tag
7. User sees success message with NPM package URL

### Failure Cases
- Tag already exists: Clear error message with existing tag info
- Version lower than package.json: Error with version comparison
- Tests fail: Show test output, don't publish
- Build fails: Show build errors, don't publish
- NPM_TOKEN missing/invalid: Clear authentication error
- Pre-release attempted from main: Error explaining branch restriction

## Documentation Requirements

### /docs/releasing.md (new file)
- Overview of release process
- Step-by-step workflow trigger instructions
- Version numbering conventions
- Branch-specific rules (main vs dev)
- Troubleshooting common issues
- NPM_TOKEN setup instructions for maintainers

### Screenshots/Examples
- GitHub Actions UI showing workflow inputs
- Successful release output example
- Failed validation error examples
