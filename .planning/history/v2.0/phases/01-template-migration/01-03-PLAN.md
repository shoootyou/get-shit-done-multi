---
phase: 01-template-migration
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - scripts/migrate-to-templates.js
  - scripts/lib/agent-migrator.js
  - scripts/lib/skill-scanner.js
  - templates/agents/*.agent.md
  - templates/agents/versions.json
  - templates/get-shit-done/**/*
autonomous: true
must_haves:
  - all 13 agents migrated from .github/agents/ to templates/agents/
  - frontmatter corrections applied per TEMPLATE-01D spec
  - tools field converted from array to comma-separated string
  - tool names normalized using same mappings as skills
  - metadata block removed from frontmatter
  - skills field auto-generated by scanning agent content for /gsd- references
  - single consolidated versions.json created for all agents
  - shared directory copied from get-shit-done/ to templates/get-shit-done/
  - template variables injected in all files
---

# Plan 01-03: Agents Migration & Correction

## Objective

Migrate all 13 agents from `.github/agents/` to `/templates/agents/` with frontmatter corrections, skill reference auto-generation, and copy shared directory to templates.

## Context

This is Wave 3 of Phase 1. Foundation (Plan 01) and skills migration (Plan 02) are complete. Now we process all 13 agents with TEMPLATE-01D corrections, plus migrate the shared directory.

From REQUIREMENTS.md TEMPLATE-01D:
- Remove unsupported field: `metadata` block
- Convert tools format: From array to comma-separated string
- Map tool names: Copilot aliases â†’ Claude official (same as skills)
- Add skills field (Claude only): Scan agent content for `/gsd-` references
- Keep supported fields: name, description, tools, disallowedTools, model, permissionMode, skills, hooks
- Create consolidated versions.json for ALL agents (not per-agent)

Agents structure:
- Source: `.github/agents/gsd-*.agent.md` (flat files)
- Target: `templates/agents/gsd-*.agent.md` (flat files)
- Metadata: `templates/agents/versions.json` (consolidated)

Shared directory:
- Source: `get-shit-done/` (contains references, workflows, etc.)
- Target: `templates/get-shit-done/`

## Tasks

<task name="create-skill-scanner" type="auto">
  <files>scripts/lib/skill-scanner.js</files>
  <action>
    Create skill reference scanner for auto-generating skills field:
    
    **scripts/lib/skill-scanner.js**:
    ```javascript
    import path from 'node:path';
    import fs from 'fs-extra';
    
    /**
     * Scan agent content for skill references
     * Looks for patterns: /gsd-*, $gsd-*, gsd-* (in markdown links, text)
     * Cross-references with actual skills in templates/skills/ directory
     * 
     * @param {string} content - Agent markdown content
     * @param {string} skillsDir - Path to templates/skills/ directory
     * @returns {Array<string>} - Array of skill command names (e.g., ['gsd-new-project', 'gsd-execute-phase'])
     */
    export async function scanForSkillReferences(content, skillsDir) {
      const references = new Set();
      
      // Patterns to match skill references
      const patterns = [
        /\/gsd-([a-z-]+)/g,      // /gsd-new-project
        /\$gsd-([a-z-]+)/g,      // $gsd-new-project (Codex)
        /`gsd-([a-z-]+)`/g,      // `gsd-new-project` (inline code)
        /\bgsd-([a-z-]+)\b/g     // gsd-new-project (plain text)
      ];
      
      // Extract all potential skill names
      patterns.forEach(pattern => {
        const matches = content.matchAll(pattern);
        for (const match of matches) {
          references.add(`gsd-${match[1]}`);
        }
      });
      
      // Get list of actual skills from templates/skills/ directory
      let actualSkills = [];
      if (await fs.pathExists(skillsDir)) {
        const dirs = await fs.readdir(skillsDir);
        actualSkills = dirs.filter(dir => dir.startsWith('gsd-'));
      }
      
      // Filter to only include references that match actual skills
      const validSkills = Array.from(references).filter(ref => 
        actualSkills.includes(ref)
      );
      
      return validSkills.sort();
    }
    ```
  </action>
  <verify>
    ```bash
    test -f scripts/lib/skill-scanner.js && \
    echo "âœ“ Skill scanner module created"
    ```
  </verify>
  <done>Skill scanner module exists for auto-generating skills field</done>
</task>

<task name="create-agent-migrator" type="auto">
  <files>scripts/lib/agent-migrator.js</files>
  <action>
    Create agent migration logic with frontmatter corrections:
    
    **scripts/lib/agent-migrator.js**:
    ```javascript
    import path from 'node:path';
    import fs from 'fs-extra';
    import matter from 'gray-matter';
    import { parseFrontmatter, validateFrontmatter } from './frontmatter-parser.js';
    import { injectTemplateVariables } from './template-injector.js';
    import { scanForSkillReferences } from './skill-scanner.js';
    
    /**
     * Tool name mappings (same as skills - from TEMPLATE-02B)
     */
    const TOOL_NAME_MAP = {
      'read': 'Read',
      'write': 'Write',
      'edit': 'Edit',
      'bash': 'Bash',
      'execute': 'Bash',
      'grep': 'Grep',
      'glob': 'Glob',
      'search': 'Grep',
      'task': 'Task',
      'agent': 'Task',
      'skill': 'Skill',
      'askuserquestion': 'AskUserQuestion',
      'webfetch': 'WebFetch',
      'websearch': 'WebSearch',
      'lsp': 'LSP',
      'mcpsearch': 'MCPSearch',
      'taskoutput': 'TaskOutput',
      'killshell': 'KillShell',
      'notebookedit': 'NotebookEdit',
      'exitplanmode': 'ExitPlanMode'
    };
    
    function normalizeToolName(toolName) {
      const lower = toolName.toLowerCase().trim();
      return TOOL_NAME_MAP[lower] || toolName;
    }
    
    function convertToolsToString(toolsArray) {
      if (!Array.isArray(toolsArray)) {
        return typeof toolsArray === 'string' ? toolsArray : '';
      }
      return toolsArray.map(tool => normalizeToolName(tool)).join(', ');
    }
    
    /**
     * Apply frontmatter corrections to agent data
     * Implements TEMPLATE-01D specification
     */
    export async function correctAgentFrontmatter(data, content, skillsDir) {
      const corrected = { ...data };
      const metadata = {};
      
      // Store unsupported fields in metadata object
      if (corrected.metadata !== undefined) {
        metadata.metadata = corrected.metadata;
        delete corrected.metadata;
      }
      
      // Store version fields if present
      ['skill_version', 'requires_version', 'platforms'].forEach(field => {
        if (corrected[field] !== undefined) {
          metadata[field] = corrected[field];
          delete corrected[field];
        }
      });
      
      // Convert tools array â†’ string
      if (corrected.tools && Array.isArray(corrected.tools)) {
        corrected.tools = convertToolsToString(corrected.tools);
      }
      
      // Auto-generate skills field by scanning content
      const skillRefs = await scanForSkillReferences(content, skillsDir);
      if (skillRefs.length > 0) {
        corrected.skills = skillRefs;
      }
      
      return { corrected, metadata };
    }
    
    /**
     * Migrate a single agent
     */
    export async function migrateAgent(sourcePath, targetDir, skillsDir, validator) {
      const agentName = path.basename(sourcePath, '.agent.md');
      const targetPath = path.join(targetDir, path.basename(sourcePath));
      
      try {
        // Read source file
        const content = await fs.readFile(sourcePath, 'utf-8');
        
        // Parse frontmatter
        const { data, content: body } = parseFrontmatter(sourcePath, content);
        
        // Apply corrections (pass body content for skill scanning)
        const { corrected, metadata } = await correctAgentFrontmatter(data, body, skillsDir);
        
        // Inject template variables into body
        const injectedBody = injectTemplateVariables(body);
        
        // Validate corrected frontmatter
        const validationErrors = validateFrontmatter(targetPath, corrected, 'agent');
        if (validationErrors.length > 0) {
          validator.addIssues(targetPath, validationErrors);
        }
        
        // Write corrected agent file
        const newContent = matter.stringify(injectedBody, corrected);
        await fs.writeFile(targetPath, newContent, 'utf-8');
        
        return {
          success: true,
          file: targetPath,
          agentName,
          metadata,
          skillsFound: corrected.skills || []
        };
        
      } catch (err) {
        validator.addError(sourcePath, 'migration', err.message);
        return {
          success: false,
          file: sourcePath,
          error: err.message
        };
      }
    }
    
    /**
     * Migrate all agents from source to target directory
     */
    export async function migrateAllAgents(sourceDir, targetDir, skillsDir, validator) {
      // Find all agent files
      const files = await fs.readdir(sourceDir);
      const agentPaths = files
        .filter(f => f.startsWith('gsd-') && f.endsWith('.agent.md'))
        .map(f => path.join(sourceDir, f));
      
      console.log(`Found ${agentPaths.length} agents to migrate`);
      
      // Migrate each agent
      const results = [];
      const versionsData = {};
      
      for (const agentPath of agentPaths) {
        const result = await migrateAgent(agentPath, targetDir, skillsDir, validator);
        results.push(result);
        
        if (result.success && result.metadata) {
          versionsData[result.agentName] = result.metadata;
        }
      }
      
      // Write consolidated versions.json
      const versionsPath = path.join(targetDir, 'versions.json');
      await fs.writeJson(versionsPath, versionsData, { spaces: 2 });
      
      const successful = results.filter(r => r.success).length;
      const failed = results.filter(r => !r.success).length;
      
      return {
        total: results.length,
        successful,
        failed,
        results,
        versionsPath
      };
    }
    ```
  </action>
  <verify>
    ```bash
    test -f scripts/lib/agent-migrator.js && \
    echo "âœ“ Agent migrator module created"
    ```
  </verify>
  <done>Agent migrator module exists with frontmatter correction and skill scanning logic</done>
</task>

<task name="integrate-agents-and-shared-migration" type="auto">
  <files>scripts/migrate-to-templates.js</files>
  <action>
    Update main migration script to execute agents migration and shared directory copy:
    
    Replace the `// TODO: Agents migration (Plan 03)` section with:
    
    ```javascript
    import { migrateAllAgents } from './lib/agent-migrator.js';
    
    // ... (after skills migration in main function)
    
    // Prepare agents directories
    const sourceAgentsDir = path.join(process.cwd(), '.github/agents');
    const targetAgentsDir = path.join(process.cwd(), 'templates/agents');
    
    // Clean templates/agents if exists (start fresh)
    if (await fs.pathExists(targetAgentsDir)) {
      console.log(chalk.yellow('âš  Removing existing templates/agents directory'));
      await fs.remove(targetAgentsDir);
    }
    await fs.ensureDir(targetAgentsDir);
    
    // Migrate agents (pass skillsDir for skill reference scanning)
    console.log(chalk.cyan('\nðŸ¤– Migrating agents...'));
    const agentsResult = await migrateAllAgents(
      sourceAgentsDir, 
      targetAgentsDir, 
      targetSkillsDir,
      validator
    );
    
    console.log(chalk.green(`âœ“ Agents migrated: ${agentsResult.successful}/${agentsResult.total}`));
    if (agentsResult.failed > 0) {
      console.log(chalk.red(`âœ— Agents failed: ${agentsResult.failed}`));
    }
    console.log(chalk.gray(`  Consolidated versions.json: ${agentsResult.versionsPath}`));
    
    // Migrate shared directory
    console.log(chalk.cyan('\nðŸ“¦ Copying shared directory...'));
    const sourceSharedDir = path.join(process.cwd(), 'get-shit-done');
    const targetSharedDir = path.join(process.cwd(), 'templates/get-shit-done');
    
    if (await fs.pathExists(targetSharedDir)) {
      await fs.remove(targetSharedDir);
    }
    
    await fs.copy(sourceSharedDir, targetSharedDir);
    
    // Inject template variables into manifest template
    const manifestPath = path.join(targetSharedDir, '.gsd-install-manifest.json');
    if (await fs.pathExists(manifestPath)) {
      let manifestContent = await fs.readFile(manifestPath, 'utf-8');
      manifestContent = injectTemplateVariables(manifestContent);
      await fs.writeFile(manifestPath, manifestContent, 'utf-8');
    }
    
    console.log(chalk.green(`âœ“ Shared directory copied to templates/get-shit-done/`));
    ```
  </action>
  <verify>
    ```bash
    # Run migration to verify agents are migrated
    node scripts/migrate-to-templates.js
    
    # Check that templates/agents directory was created
    test -d templates/agents && echo "âœ“ templates/agents created"
    
    # Count migrated agents
    ls -1 templates/agents/*.agent.md 2>/dev/null | wc -l
    
    # Verify versions.json exists
    test -f templates/agents/versions.json && echo "âœ“ versions.json created"
    
    # Verify shared directory copied
    test -d templates/get-shit-done && echo "âœ“ shared directory copied"
    ```
  </verify>
  <done>Agents migration and shared directory copy integrated into main script</done>
</task>

## Verification

After completing this plan:

1. **Skill scanner created:** scripts/lib/skill-scanner.js for auto-generating skills field
2. **Agent migrator created:** scripts/lib/agent-migrator.js with correction logic
3. **All agents migrated:** 13 agents in templates/agents/gsd-*.agent.md
4. **Frontmatter corrected:**
   - `tools` converted to comma-separated string
   - Tool names normalized (same as skills)
   - `metadata` block removed
   - `skills` field auto-generated from content scan
5. **Consolidated metadata:** templates/agents/versions.json with all agent metadata
6. **Shared directory copied:** templates/get-shit-done/ with all resources
7. **Template variables injected:** {{PLATFORM_ROOT}}, {{COMMAND_PREFIX}} in all files
8. **Validation clean:** No errors blocking migration

## Success Criteria

- [ ] scripts/lib/skill-scanner.js exists for skill reference extraction
- [ ] scripts/lib/agent-migrator.js exists with correction logic
- [ ] templates/agents/ directory contains 13 gsd-*.agent.md files
- [ ] templates/agents/versions.json exists with consolidated metadata
- [ ] Agent frontmatter uses `tools` as comma-separated string
- [ ] Tool names are capitalized correctly (Read, Write, Bash)
- [ ] No `metadata` blocks in agent frontmatter
- [ ] `skills` field auto-generated for agents (scanned from content)
- [ ] templates/get-shit-done/ directory exists with all shared resources
- [ ] Template variables present in all files
- [ ] Running migration script shows agents migrated successfully
- [ ] No validation errors blocking migration

## Output

13 agents migrated to templates/agents/ with corrected frontmatter and auto-generated skills field. Shared directory copied to templates/get-shit-done/. Ready for validation and manual review in Plan 04.
