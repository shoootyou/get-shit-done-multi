---
phase: 03-spec-migration-template-generation
plan: 07
type: execute
wave: 1
depends_on: ["03-04", "03-05"]
files_modified:
  - bin/lib/template-system/field-transformer.js
  - bin/lib/template-system/generator.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Metadata uses clean field names without underscores (platform, generated)"
    - "Metadata rendered in multi-line YAML format, not inline"
    - "Metadata includes project name and version from package.json"
    - "Generated agents have single blank line after frontmatter closing ---"
  artifacts:
    - path: "bin/lib/template-system/field-transformer.js"
      provides: "Metadata with clean names and project info"
      contains: ["platform:", "generated:", "projectName:", "projectVersion:"]
    - path: "bin/lib/template-system/generator.js"
      provides: "Multi-line YAML formatting for metadata object"
      contains: "flowLevel: 2"
  key_links:
    - from: "field-transformer.js:addPlatformMetadata"
      to: "generator.js:serializeFrontmatter"
      via: "metadata object shape"
      pattern: "metadata:"
    - from: "generator.js:serializeFrontmatter"
      to: "output assembly"
      via: "frontmatter string with single newline"
      pattern: "---\\n\\n"
---

<objective>
Fix metadata field naming, formatting, and completeness to match user expectations.

Purpose: Improve generated agent quality with cleaner metadata naming, more readable YAML formatting, and complete project context.

Output: Updated field-transformer.js and generator.js with corrected metadata handling.
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-spec-migration-template-generation/03-04-SUMMARY.md
@.planning/phases/03-spec-migration-template-generation/03-05-SUMMARY.md

# Source files to modify
@bin/lib/template-system/field-transformer.js
@bin/lib/template-system/generator.js

# For reading project info
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix metadata field names and add project info</name>
  <files>bin/lib/template-system/field-transformer.js</files>
  <action>
Update addPlatformMetadata() function (lines 194-220) to fix metadata field names and add project information:

**Changes needed:**
1. Remove underscore prefixes from field names:
   - `_platform` → `platform`
   - `_generated` → `generated`
   - `_templateVersion` → `templateVersion` (if present)
   - `_sourceSpec` → `sourceSpec` (if present)

2. Add project metadata from package.json:
   - Read package.json at module load time
   - Add `projectName` field with pkg.name value
   - Add `projectVersion` field with pkg.version value

**Implementation:**
```javascript
// At top of file, add:
const path = require('path');
const fs = require('fs');

// Read package.json for project metadata
let projectInfo = { name: 'unknown', version: 'unknown' };
try {
  const pkgPath = path.join(__dirname, '../../../package.json');
  const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
  projectInfo = { name: pkg.name, version: pkg.version };
} catch (err) {
  // Fallback if package.json not found
  console.warn('Could not read package.json for metadata:', err.message);
}

// Update addPlatformMetadata function (lines 208-213):
if (platform === 'copilot') {
  const metadata = {
    platform: platform,                           // NO underscore
    generated: new Date().toISOString(),          // NO underscore
    projectName: projectInfo.name,                // NEW field
    projectVersion: projectInfo.version,          // NEW field
    ...(options.version && { templateVersion: options.version }),  // NO underscore
    ...(options.specPath && { sourceSpec: options.specPath })      // NO underscore
  };
  
  return {
    ...frontmatter,
    metadata: metadata
  };
}
```

**Why these changes:**
- Clean field names (no underscores) follow standard naming conventions
- Project metadata provides context about which project generated the agents
- Reading package.json at load time is efficient (once per process)
  </action>
  <verify>
Run sample generation and check output:
```bash
cd bin && node lib/template-system/generate-samples.js
cat ../test-output/copilot/gsd-executor.md | head -15
```

Expected metadata format:
```yaml
metadata:
  platform: copilot
  generated: '2026-01-21T...'
  projectName: get-shit-done-multi
  projectVersion: 1.8.0
  templateVersion: ...
  sourceSpec: ...
```
  </verify>
  <done>
- Metadata fields use clean names (platform, generated, projectName, projectVersion)
- No underscore prefixes in metadata field names
- Project name and version correctly populated from package.json
- Generated Copilot agents show correct metadata structure
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix YAML formatting and blank line spacing</name>
  <files>bin/lib/template-system/generator.js</files>
  <action>
Update serializeFrontmatter() function (lines 25-50) and output assembly (line 343) to fix YAML formatting:

**Change 1: Multi-line YAML for metadata object**
Current yamlOptions uses `flowLevel: 1` which makes objects inline. Need `flowLevel: 2` to make nested objects (like metadata) multi-line while keeping arrays single-line.

Update lines 40-47:
```javascript
// YAML dump options for formatting
const yamlOptions = {
  // flowLevel 2: top-level block, nested objects block, arrays flow (single-line)
  // This makes metadata: {...} render as multi-line YAML
  flowLevel: 2,
  // Unlimited line width prevents wrapping
  lineWidth: -1,
  // Indent 2 spaces
  indent: 2
};
```

**Change 2: Single blank line after frontmatter**
Current output has two blank lines: `---\n${frontmatterStr}---\n\n${spec.body}`

Update line 343:
```javascript
const output = `---\n${frontmatterStr}---\n${spec.body}`;
```

**Why these changes:**
- flowLevel: 2 makes nested objects (metadata) render multi-line while keeping arrays (tools) single-line
- Single `\n` after closing `---` gives exactly one blank line, matching expected format
- More readable YAML follows standard conventions for structured data
  </action>
  <verify>
Run sample generation and check formatting:
```bash
cd bin && node lib/template-system/generate-samples.js
cat ../test-output/copilot/gsd-executor.md | head -20
```

Expected format:
```yaml
---
name: gsd-executor
description: ...
tools: [bash, view, edit, ...]
metadata:
  platform: copilot
  generated: '2026-01-21T...'
  projectName: get-shit-done-multi
  projectVersion: 1.8.0
---

<role>
```

Check:
- metadata object is multi-line (not inline)
- Exactly ONE blank line between closing --- and <role>
- Arrays (tools) remain single-line
  </verify>
  <done>
- Metadata object renders in multi-line YAML format
- Exactly one blank line after frontmatter closing ---
- Arrays (tools) remain in single-line format
- Generated agents match expected formatting
  </done>
</task>

</tasks>

<verification>
**Format checks:**
```bash
# Generate all samples
cd bin && node lib/template-system/generate-samples.js

# Check Copilot agent format
COPILOT_FILE="../test-output/copilot/gsd-executor.md"

# 1. Metadata field names (no underscores)
grep -E "platform:|generated:|projectName:|projectVersion:" "$COPILOT_FILE" | head -4

# 2. Multi-line metadata (should span multiple lines, not inline)
sed -n '/^metadata:/,/^[a-z]/p' "$COPILOT_FILE" | head -7

# 3. Blank lines after frontmatter (should be exactly 1)
head -20 "$COPILOT_FILE" | grep -A 2 "^---$" | tail -3

# 4. Project info populated
grep "projectName: get-shit-done-multi" "$COPILOT_FILE"
grep "projectVersion: 1.8.0" "$COPILOT_FILE"
```

**Expected results:**
- Metadata fields: `platform:`, `generated:`, `projectName:`, `projectVersion:` (no underscores)
- Metadata format: Multi-line YAML with proper indentation
- Spacing: Single blank line between `---` and `<role>`
- Project info: Correct name and version from package.json
</verification>

<success_criteria>
All 4 formatting gaps closed:

1. **Metadata field names:** Clean names without underscores (platform, generated, projectName, projectVersion)
2. **YAML formatting:** Multi-line format for metadata object with proper indentation
3. **Project metadata:** projectName and projectVersion fields populated from package.json
4. **Spacing:** Exactly one blank line after frontmatter closing ---

Generated agents pass format validation and match user expectations.
</success_criteria>

<output>
After completion, create `.planning/phases/03-spec-migration-template-generation/03-07-SUMMARY.md`
</output>
