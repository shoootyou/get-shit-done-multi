---
phase: 03-spec-migration-template-generation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/template-system/generator.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Claude agents have single-line description format: description: \"text here\""
    - "Claude agents have single-line tools format: tools: Bash, Read, Edit"
    - "Copilot agents have single-line description format"
    - "Copilot agents have single-line tools array format: tools: ['bash', 'read', 'edit']"
    - "Generated YAML conforms to official platform specs"
  artifacts:
    - path: "bin/lib/template-system/generator.js"
      provides: "Custom YAML serialization with platform-specific formatting"
      exports: ["generateAgent", "generateFromSpec"]
  key_links:
    - from: "generator.js"
      to: "js-yaml library"
      via: "yaml.dump() with custom options"
      pattern: "yaml\\.dump\\(.*\\{.*lineWidth.*\\}"
---

<objective>
Fix YAML frontmatter formatting to match official platform specifications for description and tools fields.

Purpose: Ensure generated agents conform to Claude and Copilot documentation requirements
Output: Agents with single-line description and platform-appropriate tools format
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/03-spec-migration-template-generation/03-VERIFICATION.md
@bin/lib/template-system/generator.js
@test-output/claude/gsd-planner.md
@test-output/copilot/gsd-verifier.md

## Gap Context

**Issue 1 - Description field format (CRITICAL)**
- Current: Uses `>-` multi-line YAML format
- Expected: Single line format `description: "text here"`
- Affects: Both Claude and Copilot
- Reference: https://code.claude.com/docs/en/sub-agents#supported-frontmatter-fields

**Issue 2 - Claude tools format (CRITICAL)**
- Current: Multi-line YAML list
- Expected: Single line comma-separated: `tools: Bash, Read, Edit`
- Reference: https://code.claude.com/docs/en/sub-agents#supported-frontmatter-fields

**Issue 3 - Copilot tools format (CRITICAL)**
- Current: Multi-line YAML list or incorrect format
- Expected: Single line array: `tools: ['bash', 'read', 'edit']`
- Reference: https://docs.github.com/en/copilot/reference/custom-agents-configuration

## Current Implementation

Line 305-306 in generator.js:
```javascript
const frontmatterStr = yaml.dump(finalFrontmatter);
const output = `---\n${frontmatterStr}---\n\n${spec.body}`;
```

Problem: `yaml.dump()` uses default options which produce multi-line format for strings and arrays.

## Solution Approach

Use `yaml.dump()` with platform-specific formatting options:

**For Claude:**
- `description`: Force single-line quoted string
- `tools`: Custom serialization to comma-separated string (not array)

**For Copilot:**
- `description`: Force single-line quoted string  
- `tools`: Custom serialization to single-line array format: `['tool1', 'tool2']`

**Implementation:**
1. Create platform-specific YAML dump options
2. Pre-process frontmatter to convert tools array to appropriate format
3. Use `flowLevel: 0` and `lineWidth: -1` to force single-line arrays
4. Add custom string styles for single-line descriptions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement platform-specific YAML serialization</name>
  <files>bin/lib/template-system/generator.js</files>
  <action>
Modify the YAML serialization logic in generator.js (lines 305-306) to use platform-specific formatting:

1. **Create serialization helper function** (before generateAgent function):
```javascript
/**
 * Serialize frontmatter with platform-specific YAML formatting
 * @param {Object} frontmatter - Frontmatter object to serialize
 * @param {string} platform - Target platform ('claude' or 'copilot')
 * @returns {string} Formatted YAML string
 */
function serializeFrontmatter(frontmatter, platform) {
  // Clone to avoid mutating original
  const fm = JSON.parse(JSON.stringify(frontmatter));
  
  if (platform === 'claude') {
    // Claude: tools as comma-separated string (not array)
    if (Array.isArray(fm.tools)) {
      fm.tools = fm.tools.join(', ');
    }
  } else if (platform === 'copilot') {
    // Copilot: tools remains as array, will be formatted as single-line array
    // (handled by YAML options below)
  }
  
  // YAML dump options for single-line formatting
  const yamlOptions = {
    // Force arrays to flow (single-line) format
    flowLevel: 0,
    // Unlimited line width prevents wrapping
    lineWidth: -1,
    // Use double quotes for strings
    quotingType: '"',
    // Force single-line strings (no folded/literal)
    forceQuotes: true,
    // Indent 2 spaces
    indent: 2
  };
  
  return yaml.dump(fm, yamlOptions);
}
```

2. **Replace lines 305-306** with:
```javascript
const frontmatterStr = serializeFrontmatter(finalFrontmatter, platform);
const output = `---\n${frontmatterStr}---\n\n${spec.body}`;
```

3. **Update generateFromSpec function** similarly (around line 620):
Find the corresponding `yaml.dump(finalFrontmatter)` call and replace with:
```javascript
const frontmatterStr = serializeFrontmatter(finalFrontmatter, platform);
const output = `---\n${frontmatterStr}---\n\n${spec.body}`;
```

**Why this approach:**
- `flowLevel: 0` forces arrays to use flow style: `[item1, item2]`
- `lineWidth: -1` prevents line wrapping
- `quotingType: '"'` and `forceQuotes: true` ensure strings use double quotes
- For Claude, converting tools array to string gives exact format: `tools: Bash, Read, Edit`
- For Copilot, flow-style array gives: `tools: ['bash', 'read', 'edit']`

**Do NOT:**
- Change the structure of finalFrontmatter before this point
- Modify tool-mapper.js or field-transformer.js (tools are correct as arrays in pipeline)
- Add custom YAML serialization that breaks standard YAML parsing
  </action>
  <verify>
Run existing integration tests:
```bash
cd bin/lib/template-system
node integration.test.js
```

Check generated output format:
```bash
# Generate test output
node -e "
const {generateAgent} = require('./generator.js');
const claudeResult = generateAgent('specs/agents/gsd-planner.md', 'claude');
const copilotResult = generateAgent('specs/agents/gsd-verifier.md', 'copilot');
console.log('Claude description:', claudeResult.output.split('\\n')[2]);
console.log('Claude tools:', claudeResult.output.split('\\n')[6]);
console.log('Copilot description:', copilotResult.output.split('\\n')[2]);
console.log('Copilot tools:', copilotResult.output.split('\\n')[8]);
"
```

Expected output:
- Claude description: `description: "Creates executable phase plans..."`
- Claude tools: `tools: Read, Write, Bash, Glob, Grep, WebFetch, mcp__context7__*`
- Copilot description: `description: "Verifies phase goal achievement..."`
- Copilot tools: `tools: ['read', 'bash', 'grep', 'glob']`
  </verify>
  <done>
- serializeFrontmatter() function exists in generator.js
- Claude agents have single-line description with double quotes
- Claude agents have comma-separated tools string (NOT array)
- Copilot agents have single-line description with double quotes
- Copilot agents have single-line array tools: ['tool1', 'tool2']
- Integration tests pass (26 tests)
  </done>
</task>

</tasks>

<verification>
Generate sample agents and verify format:

```bash
cd bin/lib/template-system
node generate-samples.js
cat test-output/claude/gsd-planner.md | head -20
cat test-output/copilot/gsd-verifier.md | head -20
```

Check:
- [ ] No `>-` multi-line syntax in description
- [ ] Claude tools are comma-separated string
- [ ] Copilot tools are single-line array
- [ ] Both formats match official documentation
</verification>

<success_criteria>
1. Claude agents: `description: "text here"` (single-line)
2. Claude agents: `tools: Bash, Read, Edit` (comma-separated string)
3. Copilot agents: `description: "text here"` (single-line)
4. Copilot agents: `tools: ['bash', 'read', 'edit']` (single-line array)
5. All 26 integration tests pass
6. Generated YAML is valid and parseable
</success_criteria>

<output>
After completion, create `.planning/phases/03-spec-migration-template-generation/03-04-SUMMARY.md`
</output>
