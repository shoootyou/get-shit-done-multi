---
phase: 04.1-installation-quality-copilot-spec-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/template-system/tool-mapper.js
  - bin/lib/template-system/tool-mapper.test.js
  - bin/lib/template-system/field-transformer.js
autonomous: true
must_haves:
  truths:
    - Tool mapper accepts both uppercase (Bash) and lowercase (bash) canonical names
    - Tool mapper accepts all aliases (execute, bash, shell) and resolves to PRIMARY name
    - Copilot agents use PRIMARY aliases (execute, edit, search, agent) not compatible aliases
    - Grep + Glob deduplicate to single 'search' tool in Copilot agents
    - Color field excluded from Copilot frontmatter
  artifacts:
    - bin/lib/template-system/tool-mapper.js with REVERSE_TOOL_INDEX
    - bin/lib/template-system/tool-mapper.js with PRIMARY names in copilot field
    - bin/lib/template-system/field-transformer.js with color field rule
  wiring:
    - REVERSE_TOOL_INDEX maps all cases/aliases to canonical name
    - mapTools() uses REVERSE_INDEX for lookup, returns PRIMARY name
    - transformFields() filters color field when platform=copilot
  key_links:
    - REVERSE_TOOL_INDEX → mapTools() lookup
    - TOOL_COMPATIBILITY_MATRIX.copilot field → PRIMARY alias output
    - FIELD_RULES.color → transformFields() filtering
---

# Phase 04.1 Plan 01: Bidirectional Tool Mapper + Copilot PRIMARY Aliases

## Objective

Fix tool mapping to recognize all name variants (uppercase, lowercase, aliases) and output Copilot PRIMARY aliases with deduplication.

## Context

**Current Issues:**
- Tool mapper only recognizes uppercase canonical names (Bash, Read, Edit) from CANONICAL_TOOLS
- Receives lowercase from Copilot templates (bash, read, edit) → "Unknown tool" warnings
- Uses compatible aliases (bash, write) instead of PRIMARY aliases (execute, edit)
- No deduplication: Grep + Glob should → 'search' in Copilot

**Official Tool Names:**
- **Claude**: Bash, Read, Edit, Grep, Glob, Task (uppercase, case-sensitive)
- **Copilot PRIMARY**: execute, edit, search, agent (lowercase, from official docs)
- **Copilot compatible**: bash, read, write, grep, glob, task (backward compat)

**Technical Approach:**
- REVERSE_TOOL_INDEX: Maps ALL variants → canonical name (for lookup)
- Forward mapping: Canonical → platform-specific PRIMARY name (for output)
- Deduplication: Both Grep and Glob → 'search' in Copilot

**Reference Material:**
- bin/lib/template-system/tool-mapper.js (current implementation)
- bin/lib/template-system/tool-mapper.test.js (40 tests for new logic)
- .planning/phases/02-platform-abstraction-layer/02-01-SUMMARY.md (original design)

## Tasks

<task name="create-reverse-index-bidirectional-lookup" type="auto">
  <files>bin/lib/template-system/tool-mapper.js</files>
  <action>
    Create REVERSE_TOOL_INDEX constant for bidirectional tool name lookup.
    
    **Build reverse index mapping ALL variants to canonical name:**
    
    ```javascript
    // Build at module load time
    const REVERSE_TOOL_INDEX = {};
    
    for (const [canonical, config] of Object.entries(TOOL_COMPATIBILITY_MATRIX)) {
      // Canonical name itself
      REVERSE_TOOL_INDEX[canonical] = canonical;
      REVERSE_TOOL_INDEX[canonical.toLowerCase()] = canonical;
      
      // Claude name (case-sensitive)
      if (config.claude) {
        REVERSE_TOOL_INDEX[config.claude] = canonical;
      }
      
      // Copilot name (case-insensitive)
      if (config.copilot) {
        REVERSE_TOOL_INDEX[config.copilot] = canonical;
        REVERSE_TOOL_INDEX[config.copilot.toLowerCase()] = canonical;
      }
      
      // All aliases (case-insensitive)
      config.aliases.forEach(alias => {
        REVERSE_TOOL_INDEX[alias] = canonical;
        REVERSE_TOOL_INDEX[alias.toLowerCase()] = canonical;
      });
    }
    ```
    
    **Update mapTools() to use REVERSE_INDEX:**
    
    ```javascript
    function mapTools(toolArray, platform) {
      // ... validation ...
      
      return toolArray.map(tool => {
        // 1. Resolve to canonical name via REVERSE_INDEX
        const canonical = REVERSE_TOOL_INDEX[tool];
        
        if (!canonical) {
          console.warn(`Warning: Unknown tool "${tool}" - passing through unchanged`);
          return tool;
        }
        
        // 2. Map canonical to platform-specific PRIMARY name
        const compatibility = TOOL_COMPATIBILITY_MATRIX[canonical];
        return platform === 'claude' ? compatibility.claude : compatibility.copilot;
      }).filter(tool => tool !== null);
    }
    ```
    
    **Benefits:**
    - Accepts: Bash, bash, BASH, execute, shell → resolves to 'Bash'
    - Maps: 'Bash' → 'Bash' (Claude) or 'execute' (Copilot)
    - No more "Unknown tool 'read'" warnings
  </action>
  <verify>
    ```bash
    # Test bidirectional lookup
    node -e "
    const { mapTools } = require('./bin/lib/template-system/tool-mapper.js');
    
    // Test uppercase canonical
    console.log(mapTools(['Bash', 'Read'], 'copilot')); // ['execute', 'read']
    
    // Test lowercase variants
    console.log(mapTools(['bash', 'read'], 'copilot')); // ['execute', 'read']
    
    // Test aliases
    console.log(mapTools(['execute', 'shell'], 'copilot')); // ['execute', 'execute']
    "
    ```
    
    Should output PRIMARY names without warnings.
  </verify>
  <done>REVERSE_TOOL_INDEX exists, mapTools() uses it for lookup, no warnings on lowercase/alias input</done>
</task>

<task name="update-primary-aliases-deduplication" type="auto">
  <files>bin/lib/template-system/tool-mapper.js</files>
  <action>
    Update TOOL_COMPATIBILITY_MATRIX to use Copilot PRIMARY aliases and add deduplication logic.
    
    **Update copilot field to PRIMARY names:**
    
    ```javascript
    const TOOL_COMPATIBILITY_MATRIX = {
      'Bash': {
        claude: 'Bash',
        copilot: 'execute',  // PRIMARY (was: 'bash')
        aliases: ['execute', 'bash', 'shell', 'Bash', 'powershell'],
        safe: true,
      },
      'Read': {
        claude: 'Read',
        copilot: 'read',  // Already PRIMARY
        aliases: ['Read', 'read', 'view', 'NotebookRead'],
        safe: true,
      },
      'Edit': {
        claude: 'Edit',
        copilot: 'edit',  // PRIMARY (replaces 'write')
        aliases: ['Edit', 'edit', 'Write', 'write', 'MultiEdit', 'create'],
        safe: true,
      },
      'Grep': {
        claude: 'Grep',
        copilot: 'search',  // PRIMARY (was: 'grep')
        aliases: ['Grep', 'grep', 'search'],
        safe: true,
      },
      'Glob': {
        claude: 'Glob',
        copilot: 'search',  // PRIMARY - DEDUPLICATES with Grep
        aliases: ['Glob', 'glob'],
        safe: true,
      },
      'Task': {
        claude: 'Task',
        copilot: 'agent',  // PRIMARY (was: 'task')
        aliases: ['Task', 'task', 'agent', 'custom-agent'],
        safe: true,
        warning: 'Task invocation may have different agent types available per platform',
      },
      // ... rest unchanged
    };
    ```
    
    **Add deduplication to mapTools():**
    
    ```javascript
    function mapTools(toolArray, platform) {
      // ... existing logic ...
      
      const mapped = toolArray.map(/* ... */).filter(tool => tool !== null);
      
      // Deduplicate for Copilot (Grep + Glob both → 'search')
      if (platform === 'copilot') {
        return [...new Set(mapped)];
      }
      
      return mapped;
    }
    ```
    
    **Result:**
    - Copilot agents use: execute, read, edit, search, agent (PRIMARY)
    - ['Bash', 'Read', 'Edit', 'Grep', 'Glob'] → ['execute', 'read', 'edit', 'search'] (deduplicated)
  </action>
  <verify>
    ```bash
    # Test PRIMARY aliases
    node -e "
    const { mapTools } = require('./bin/lib/template-system/tool-mapper.js');
    
    // Test Copilot PRIMARY output
    const tools = ['Bash', 'Read', 'Edit', 'Grep', 'Glob', 'Task'];
    const copilot = mapTools(tools, 'copilot');
    console.log('Copilot:', copilot);
    // Expected: ['execute', 'read', 'edit', 'search', 'agent']
    // (search appears once, not twice)
    
    console.log('Unique count:', copilot.length);
    // Expected: 5 (not 6)
    "
    ```
    
    Verify: execute (not bash), edit (not write), search (once), agent (not task).
  </verify>
  <done>TOOL_COMPATIBILITY_MATRIX uses PRIMARY aliases, mapTools() deduplicates Copilot output, Grep+Glob both map to 'search'</done>
</task>

<task name="filter-color-field-copilot" type="auto">
  <files>bin/lib/template-system/field-transformer.js</files>
  <action>
    Add color field to FIELD_RULES for Copilot filtering.
    
    **Add to FIELD_RULES constant:**
    
    ```javascript
    const FIELD_RULES = {
      // ... existing rules ...
      
      // Pitfall: Color field for agent UI customization (Claude-only)
      color: { 
        claude: true, 
        copilot: false,
        reason: 'Copilot does not support color field in agent frontmatter',
        suggestion: 'Remove color field for Copilot agents'
      },
      
      // ... rest of rules
    };
    ```
    
    **Behavior:**
    - Claude: color field preserved in frontmatter
    - Copilot: color field filtered out during transformFields()
    - Warning logged: "color: Copilot does not support color field in agent frontmatter"
  </action>
  <verify>
    ```bash
    # Test color field filtering
    node -e "
    const { transformFields } = require('./bin/lib/template-system/field-transformer.js');
    
    const frontmatter = {
      name: 'test-agent',
      tools: ['Bash'],
      color: 'blue'
    };
    
    // Claude - preserves color
    const claude = transformFields(frontmatter, 'claude');
    console.log('Claude color:', claude.transformed.color); // 'blue'
    
    // Copilot - filters color
    const copilot = transformFields(frontmatter, 'copilot');
    console.log('Copilot color:', copilot.transformed.color); // undefined
    console.log('Copilot warnings:', copilot.warnings.length); // 1
    "
    ```
    
    Verify: Claude keeps color, Copilot removes it with warning.
  </verify>
  <done>FIELD_RULES includes color field rule, transformFields() filters it for Copilot, warning logged</done>
</task>

<task name="update-tool-mapper-tests" type="auto">
  <files>bin/lib/template-system/tool-mapper.test.js</files>
  <action>
    Add 40 new tests for REVERSE_INDEX, PRIMARY aliases, and deduplication.
    
    **Test categories:**
    
    1. **REVERSE_INDEX tests (15 tests):**
       - Uppercase canonical: Bash → Bash
       - Lowercase canonical: bash → Bash
       - Aliases: execute → Bash, shell → Bash
       - Case-insensitive: BASH → Bash, Execute → Bash
       - Unknown tools: xyz → undefined
    
    2. **PRIMARY alias tests (15 tests):**
       - Bash → 'execute' (Copilot)
       - Read → 'read' (Copilot)
       - Edit → 'edit' (Copilot, not 'write')
       - Grep → 'search' (Copilot)
       - Glob → 'search' (Copilot)
       - Task → 'agent' (Copilot)
    
    3. **Deduplication tests (10 tests):**
       - ['Grep', 'Glob'] → ['search'] (single entry)
       - ['Bash', 'Bash'] → ['execute'] (single entry)
       - Order preservation for unique tools
       - Claude no deduplication (keeps both Grep, Glob)
    
    **Run existing tests to ensure no regressions:**
    ```bash
    node bin/lib/template-system/tool-mapper.test.js
    ```
    
    All 69 tests should pass (29 existing + 40 new).
  </action>
  <verify>
    ```bash
    # Run tool-mapper tests
    node bin/lib/template-system/tool-mapper.test.js
    
    # Should show:
    # - 69 tests passing (29 existing + 40 new)
    # - 0 failures
    # - Coverage: REVERSE_INDEX, PRIMARY aliases, deduplication
    ```
  </verify>
  <done>40 new tests added and passing, total 69 tests, REVERSE_INDEX/PRIMARY/deduplication fully tested</done>
</task>

## Verification

**After all tasks complete:**

```bash
# 1. Test tool mapper end-to-end
node -e "
const { mapTools, getToolCompatibility } = require('./bin/lib/template-system/tool-mapper.js');

// Test case-insensitive lookup
console.log('Lowercase input:', mapTools(['bash', 'read', 'grep'], 'copilot'));
// Expected: ['execute', 'read', 'search']

// Test PRIMARY aliases
console.log('Canonical input:', mapTools(['Bash', 'Edit', 'Task'], 'copilot'));
// Expected: ['execute', 'edit', 'agent']

// Test deduplication
console.log('With duplicates:', mapTools(['Grep', 'Glob'], 'copilot'));
// Expected: ['search'] (single entry)

// Test Claude unchanged
console.log('Claude:', mapTools(['Bash', 'Grep', 'Glob'], 'claude'));
// Expected: ['Bash', 'Grep', 'Glob'] (no deduplication)
"

# 2. Test field transformer
node -e "
const { transformFields } = require('./bin/lib/template-system/field-transformer.js');

const fm = { name: 'test', tools: ['Bash'], color: 'blue' };
const result = transformFields(fm, 'copilot');

console.log('Color filtered:', !result.transformed.color);
// Expected: true

console.log('Warning present:', result.warnings.some(w => w.field === 'color'));
// Expected: true
"

# 3. Run all tests
node bin/lib/template-system/tool-mapper.test.js
node bin/lib/template-system/field-transformer.test.js

# Expected: All tests passing, no warnings
```

## Success Criteria

- [ ] REVERSE_TOOL_INDEX maps all variants (uppercase, lowercase, aliases) to canonical names
- [ ] mapTools() accepts both 'Bash' and 'bash', resolves correctly
- [ ] Copilot agents use PRIMARY aliases: execute, edit, search, agent
- [ ] Grep + Glob deduplicate to single 'search' in Copilot output
- [ ] Color field filtered from Copilot frontmatter with warning
- [ ] 69 tool-mapper tests passing (29 existing + 40 new)
- [ ] 20 field-transformer tests passing (existing)
- [ ] No "Unknown tool" warnings during generation

## Output

**Files Modified:**
- `bin/lib/template-system/tool-mapper.js` - REVERSE_INDEX + PRIMARY aliases + deduplication
- `bin/lib/template-system/tool-mapper.test.js` - 40 new tests
- `bin/lib/template-system/field-transformer.js` - color field rule

**Tests Passing:**
- Tool mapper: 69/69 tests
- Field transformer: 20/20 tests

**Next:** Plan 02 will update agent prompt content with platform-specific tool references using Mustache conditionals.
