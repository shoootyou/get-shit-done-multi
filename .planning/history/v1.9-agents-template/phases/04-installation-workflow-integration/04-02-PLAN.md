---
phase: 04-installation-workflow-integration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - bin/lib/template-system/field-transformer.js
  - package.json
  - CHANGELOG.md
autonomous: true

must_haves:
  truths:
    - "Generated agents include version metadata"
    - "Metadata shows template version, generation date, platform"
    - "Package version is 1.8.1"
    - "Changelog documents optimization changes"
  artifacts:
    - path: "bin/lib/template-system/field-transformer.js"
      provides: "Metadata generation in addPlatformMetadata function"
      contains: "templateVersion"
      min_lines: 200
    - path: "package.json"
      provides: "Version 1.8.1"
      contains: "\"version\": \"1.8.1\""
    - path: "CHANGELOG.md"
      provides: "1.8.1 release notes"
      contains: "## [1.8.1]"
  key_links:
    - from: "field-transformer.js"
      to: "package.json"
      via: "reads version for metadata"
      pattern: "require.*package\\.json.*version"
    - from: "generator.js"
      to: "field-transformer.addPlatformMetadata"
      via: "calls to add metadata fields"
      pattern: "addPlatformMetadata"
---

<objective>
Add version metadata to generated agents and bump package version to 1.8.1 with changelog documentation.

Purpose: Track template version and generation details in agent files; document optimization release.

Output: Agents include metadata (template version, generation date, platform), package.json at 1.8.1, CHANGELOG.md updated.
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Files to modify
@bin/lib/template-system/field-transformer.js
@package.json
@CHANGELOG.md

# Reference for metadata structure
@.planning/phases/03-spec-migration-template-generation/03-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Add version metadata to field-transformer</name>
  <files>bin/lib/template-system/field-transformer.js</files>
  <action>
Enhance addPlatformMetadata() function to include version and generation metadata:

1. **Import package.json at top**:
   ```javascript
   const pkg = require('../../package.json');
   ```

2. **Modify addPlatformMetadata() function** (currently around line 145):
   
   Current structure adds basic platform/generated fields. Enhance to:
   
   ```javascript
   function addPlatformMetadata(frontmatter, platform) {
     const now = new Date();
     const metadata = {
       platform: platform,
       generated: now.toISOString().split('T')[0], // YYYY-MM-DD format
       templateVersion: '1.0.0', // Template system version
       projectVersion: pkg.version, // Package version (1.8.1)
       projectName: pkg.name
     };
     
     if (platform === 'copilot') {
       // Copilot: nest under metadata object
       frontmatter.metadata = metadata;
     } else if (platform === 'claude') {
       // Claude: no metadata field (per official spec)
       // Claude doesn't support metadata in frontmatter
       // Keep comment documenting this decision
     }
     
     return frontmatter;
   }
   ```

3. **Key principles**:
   - Use ISO date format (YYYY-MM-DD) for consistency
   - templateVersion tracks template system evolution (start at 1.0.0)
   - projectVersion from package.json for traceability
   - Platform-specific structure (Copilot nested, Claude none)
   - Clear comments explaining Claude limitation

4. **Verify existing tests pass**:
   ```bash
   npm test -- field-transformer.test.js
   ```

5. **If tests fail**, update test expectations to include new metadata fields.
  </action>
  <verify>
```bash
# Run field-transformer tests
npm test -- field-transformer.test.js

# Generate sample agents and check metadata
node bin/install.js --copilot
head -40 .github/copilot/agents/gsd-executor.md | grep -A 5 "^metadata:"

# Verify metadata structure
node -e "
const yaml = require('js-yaml');
const fs = require('fs');
const content = fs.readFileSync('.github/copilot/agents/gsd-executor.md', 'utf8');
const parts = content.split('---');
const fm = yaml.load(parts[1]);
console.log('Metadata:', JSON.stringify(fm.metadata, null, 2));
"
```
  </verify>
  <done>
- field-transformer imports package.json
- addPlatformMetadata includes templateVersion, projectVersion, generated date
- Copilot agents have metadata object with all fields
- Claude agents have no metadata (per spec)
- Tests pass with updated expectations
- Generated agents contain version information
  </done>
</task>

<task type="auto">
  <name>Bump version and update changelog</name>
  <files>package.json, CHANGELOG.md</files>
  <action>
Update package version and document changes:

1. **Update package.json**:
   - Change version from "1.8.0" to "1.8.1"
   - Verify all other fields unchanged

2. **Update CHANGELOG.md**:
   Add new section at top (after title, before existing entries):
   
   ```markdown
   ## [1.8.1] - 2025-01-21
   
   ### Added
   - Template-based agent generation system for platform-specific optimization
   - Install-time generation replaces static agent files
   - Platform abstraction layer for Claude/Copilot compatibility
   - Version metadata in generated agents (template version, generation date, platform)
   
   ### Changed
   - Agents now generated from specs during installation
   - `--copilot` flag generates Copilot-optimized agents (array tools syntax, size-aware)
   - `--local`/`--global` flags generate Claude-optimized agents (string tools syntax)
   - `--all` flag applies platform-specific optimization to all detected CLIs
   
   ### Technical
   - Template system: spec-parser, context-builder, engine, generator
   - Platform abstraction: tool-mapper, field-transformer, validators
   - 13 agents converted to spec-as-template format
   - 46 integration tests (100% pass rate)
   - Agent splits: gsd-planner, gsd-debugger now coordinator/specialist pairs for Copilot size limits
   
   ### Migration Notes
   - No user action required - agents generated automatically during install
   - Re-running install is safe (idempotent operation)
   - Existing orchestration system works unchanged
   ```

3. **Verify semantic versioning**:
   - Patch release (1.8.0 → 1.8.1) correct because:
     * Backward compatible
     * No breaking changes
     * Optimization of existing functionality
     * Users see same behavior, better internals

4. **Update version link at bottom** of CHANGELOG.md if version comparison links exist.
  </action>
  <verify>
```bash
# Verify version bump
grep '"version"' package.json

# Verify changelog entry
head -50 CHANGELOG.md | grep "## \[1.8.1\]"

# Verify semantic versioning (should be patch)
node -e "
const pkg = require('./package.json');
const semver = pkg.version.split('.');
const major = semver[0], minor = semver[1], patch = semver[2];
console.log('Version:', pkg.version);
console.log('Major:', major, '(breaking changes)');
console.log('Minor:', minor, '(new features)');
console.log('Patch:', patch, '(bug fixes, optimizations) ✓');
if (patch === '1') console.log('Correct: patch release for optimization');
"
```
  </verify>
  <done>
- package.json version is 1.8.1
- CHANGELOG.md has 1.8.1 section with comprehensive notes
- Changelog documents added features, changes, technical details
- Semantic versioning rationale clear (patch release)
- Migration notes explain no user action required
  </done>
</task>

</tasks>

<verification>
1. Generated agents include version metadata
2. Copilot agents have nested metadata object
3. Claude agents have no metadata (per spec)
4. Package version is 1.8.1
5. Changelog documents optimization release
6. All tests pass
</verification>

<success_criteria>
From Phase 4 success criteria:
- ✅ Generated files include version metadata (template version, generation date, platform)
- ✅ Package version bumped to 1.8.1 with changelog documenting optimization

From requirements:
- ✅ VERS-01: Package version bumped to 1.8.1 (patch release)
- ✅ VERS-02: Version metadata embedded in generated agents
- ✅ VERS-03: Changelog documents optimization changes
</success_criteria>

<output>
After completion, create `.planning/phases/04-installation-workflow-integration/04-02-SUMMARY.md`
</output>
