---
phase: 04-installation-workflow-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/install.js
autonomous: true

must_haves:
  truths:
    - "install.js generates agents from specs at install time"
    - "Generated agents written to correct platform directories"
    - "Installation remains idempotent (safe re-runs)"
    - "--copilot flag produces Copilot-optimized agents"
    - "--local/--global flags produce Claude-optimized agents"
  artifacts:
    - path: "bin/install.js"
      provides: "Template generation integration in install functions"
      contains: "generateAgent"
      min_lines: 1200
  key_links:
    - from: "bin/install.js"
      to: "bin/lib/template-system/generator.js"
      via: "require and generateAgent calls"
      pattern: "const.*generator.*=.*require.*template-system"
    - from: "install() function"
      to: "specs/agents/*.md"
      via: "reads specs and generates agents"
      pattern: "fs\\.readdirSync.*specs/agents"
    - from: "installCopilot() function"
      to: "generator.generateAgent"
      via: "platform='copilot' parameter"
      pattern: "generateAgent.*platform.*copilot"
---

<objective>
Integrate template generation into install.js so agents are generated from specs at install time instead of copied from static files.

Purpose: Enables platform-specific optimization during installation, replacing static agent copying with dynamic generation.

Output: Modified install.js that generates optimized agents for detected platform using existing flag detection and adapter logic.
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Template system (already built)
@bin/lib/template-system/generator.js
@bin/lib/template-system/index.js

# Existing install structure
@bin/install.js

# Available specs
@specs/agents/

# Codebase understanding
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/STRUCTURE.md
</context>

<tasks>

<task type="auto">
  <name>Add template generation to install functions</name>
  <files>bin/install.js</files>
  <action>
Integrate template generation into install.js following existing patterns:

1. **Import generator at top**:
   ```javascript
   const { generateAgent } = require('./lib/template-system/generator');
   ```

2. **Create helper function generateAgentsFromSpecs**:
   - Parameters: (specsDir, outputDir, platform)
   - Read all .md files from specsDir
   - For each spec file:
     * Call generateAgent(specPath, { platform, outputDir })
     * Handle success/error results
     * Track success/failure counts
   - Return { generated, failed, errors }
   - Place function BEFORE install() function (around line 250)

3. **Modify install() function** (Claude platform, ~line 409):
   - BEFORE copying agents directory (line ~460):
     * Define platform = 'claude'
     * Define agentsDest = dirs.agents
     * Call generateAgentsFromSpecs(path.join(__dirname, '../specs/agents'), agentsDest, platform)
     * Log results: "Generated N agents from specs (M failed)"
   - KEEP existing agent copying logic as fallback (don't remove yet)
   - KEEP all other existing logic (commands, skills, hooks, settings, verification)

4. **Modify installCopilot() function** (line ~592):
   - BEFORE copying agents directory:
     * Define platform = 'copilot'
     * Define agentsDest = dirs.agents
     * Call generateAgentsFromSpecs(path.join(__dirname, '../specs/agents'), agentsDest, platform)
     * Log results
   - KEEP existing agent copying logic as fallback
   - KEEP all other logic unchanged

5. **Modify installCodex() function** (line ~729):
   - Similar pattern but use platform = 'codex'
   - Note: Codex optimization deferred, but structure in place

6. **Modify installAll() function** (line ~874):
   - No changes needed - it calls install(true), installCopilot(), installCodex()
   - Generation happens automatically via those functions

**Key principles:**
- Minimal changes - add generation, keep existing logic
- Use existing error handling patterns (try/catch where present)
- Maintain existing directory cleanup (rmSync) behavior
- Follow existing logging style (cyan, green, yellow, dim, reset)
- Generator outputs to correct directory, adapter logic already handles paths

**Don't**:
- Don't remove existing agent copying yet (keep as fallback)
- Don't change flag detection logic (already works)
- Don't modify adapter calls (claudeAdapter, copilotAdapter already correct)
- Don't change verification logic (already validates generated files)
  </action>
  <verify>
Run installation test:
```bash
# Test Claude local
node bin/install.js --local

# Test Copilot
node bin/install.js --copilot

# Check generated agents exist and are platform-optimized
ls -la .claude/agents/
ls -la .github/copilot/agents/

# Verify format compliance
node generate-validation-report.js
```
  </verify>
  <done>
- install.js imports template generator
- generateAgentsFromSpecs() helper function exists
- install() calls generator for Claude platform
- installCopilot() calls generator for Copilot platform
- Installation test produces valid platform-optimized agents
- Validation report shows 100% format compliance
  </done>
</task>

<task type="auto">
  <name>Test integration with all install modes</name>
  <files>bin/install.js</files>
  <action>
Test all installation modes to verify template generation works correctly:

1. **Clean previous installs**:
   ```bash
   rm -rf .claude .github/copilot .codex test-output/*/
   ```

2. **Test Claude local** (--local):
   ```bash
   node bin/install.js --local
   # Verify: .claude/agents/ contains all 13 agents
   # Verify: Agents have Claude-format tools (comma-separated string)
   ```

3. **Test Claude global** (--global):
   ```bash
   # Skip actual global install (would modify ~/.claude)
   # Code review that install(true) path works
   ```

4. **Test Copilot** (--copilot):
   ```bash
   node bin/install.js --copilot
   # Verify: .github/copilot/agents/ contains agents under 30KB
   # Verify: Agents have Copilot-format tools (array syntax)
   ```

5. **Test all** (--all):
   ```bash
   node bin/install.js --all
   # Verify: Both .claude and .github directories populated
   ```

6. **Test idempotency** (re-run):
   ```bash
   node bin/install.js --local
   # Should succeed without errors
   # Files should be overwritten cleanly
   ```

7. **Run validation report**:
   ```bash
   node generate-validation-report.js
   # Verify: All agents pass format validation
   # Verify: Claude agents have string tools
   # Verify: Copilot agents have array tools
   # Verify: All agents under size limits (Claude unlimited, Copilot <30KB for qualified agents)
   ```

**Expected results:**
- All install modes succeed
- Platform-specific agents generated correctly
- Re-running install overwrites safely (idempotent)
- Validation report shows 100% compliance

**Document any errors** encountered for debugging.
  </action>
  <verify>
```bash
# Final validation
node generate-validation-report.js

# Check file counts
find .claude/agents -name "*.md" | wc -l  # Should be 13
find .github/copilot/agents -name "*.md" | wc -l  # Should be 11 (2 too large for Copilot)

# Verify format
head -30 .claude/agents/gsd-planner.md | grep "^tools:"
head -30 .github/copilot/agents/gsd-executor.md | grep "^tools:"
```
  </verify>
  <done>
- All install modes (--local, --copilot, --all) succeed
- Generated agents exist in correct directories
- Claude agents have comma-separated tools string
- Copilot agents have array tools syntax
- Re-running install is idempotent (no errors)
- Validation report confirms 100% format compliance
  </done>
</task>

</tasks>

<verification>
1. Template generation integrated into install.js
2. All install modes work (--local, --global, --copilot, --all)
3. Platform-specific agents generated correctly
4. Installation is idempotent (safe re-runs)
5. Validation report confirms format compliance
</verification>

<success_criteria>
From Phase 4 success criteria:
- ✅ --copilot flag generates optimized agents to .github/copilot/agents/
- ✅ --local/--global flags generate optimized agents to Claude directories
- ✅ --all flag installs for all detected CLIs using platform-specific optimization
- ✅ Re-running install overwrites safely (idempotent operation)
- ⏳ Version metadata (handled in Plan 02)
- ⏳ Package version bump (handled in Plan 02)

From requirements:
- ✅ INST-01: Template system extends existing bin/install.js
- ✅ INST-02: Template generation respects existing install flags
- ✅ INST-03: --all flag works with platform-specific optimization
- ✅ INST-04: Uses existing adapter logic for platform-specific paths
- ✅ INST-05: No external dependencies beyond existing packages
- ✅ INST-06: Works with existing CLI detection and adapter system
- ✅ TMPL-02: Template system integrates with install flags
- ✅ TMPL-08: Re-running install overwrites safely
</success_criteria>

<output>
After completion, create `.planning/phases/04-installation-workflow-integration/04-01-SUMMARY.md`
</output>
