---
phase: 05-cross-platform-testing-validation
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - bin/test-agent-invocation.js
  - bin/lib/test-helpers/cli-invoker.js
autonomous: false
must_haves:
  - "Test harness can invoke generated agents via CLI process spawn"
  - "Invocation tests validate agent responds to simple prompts"
  - "Tests verify tool execution (bash runs commands, read accesses files)"
  - "Platform-specific features tested (model selection on Claude, MCP on Copilot)"
  - "Human checkpoint validates tests work on local CLI installations"
---

# Objective

Create invocation smoke tests that validate generated agents can be called via CLI and execute tool operations correctly.

## Context

**What Exists:**
- Generation tests (Plan 1) validate agents generate correctly
- Installation tests (Plan 1) validate file placement
- 11 agents installed to platform directories
- CLI commands for invoking agents

**What's Needed:**
- Test harness to invoke agents via process spawn
- Simple prompts to test tool execution
- Validation of agent responses and tool usage
- Platform-specific feature testing

**Constraints:**
- Cannot fully automate (requires actual CLI installations)
- Must run on developer machines locally
- Focus on smoke tests, not exhaustive validation

**Phase Goal:** End-to-end validation through actual invocation.

## Tasks

<task name="create-cli-invoker-helper" type="auto">
  <files>bin/lib/test-helpers/cli-invoker.js</files>
  <action>
Create helper module for spawning CLI processes and capturing output.

**Module Structure:**
```javascript
const { spawn } = require('child_process');
const path = require('path');

/**
 * Invoke agent via Claude CLI
 * @param {string} agentName - Agent to invoke (e.g., 'gsd-executor')
 * @param {string} prompt - Prompt to send to agent
 * @param {Object} options - CLI options
 * @returns {Promise<Object>} - { stdout, stderr, exitCode, duration }
 */
async function invokeClaude(agentName, prompt, options = {}) {
  return new Promise((resolve, reject) => {
    const startTime = Date.now();
    const args = ['agent', agentName, prompt];
    
    if (options.model) {
      args.unshift('--model', options.model);
    }
    
    const proc = spawn('claude', args, {
      stdio: ['ignore', 'pipe', 'pipe'],
      timeout: options.timeout || 30000
    });
    
    let stdout = '';
    let stderr = '';
    
    proc.stdout.on('data', (data) => {
      stdout += data.toString();
    });
    
    proc.stderr.on('data', (data) => {
      stderr += data.toString();
    });
    
    proc.on('close', (exitCode) => {
      const duration = Date.now() - startTime;
      resolve({ stdout, stderr, exitCode, duration });
    });
    
    proc.on('error', (err) => {
      reject(new Error(`Failed to spawn claude: ${err.message}`));
    });
    
    // Timeout handler
    setTimeout(() => {
      proc.kill();
      reject(new Error(`Claude invocation timeout after ${options.timeout || 30000}ms`));
    }, options.timeout || 30000);
  });
}

/**
 * Invoke agent via Copilot CLI
 * @param {string} agentName - Agent to invoke (e.g., '@gsd-executor')
 * @param {string} prompt - Prompt to send to agent
 * @param {Object} options - CLI options
 * @returns {Promise<Object>} - { stdout, stderr, exitCode, duration }
 */
async function invokeCopilot(agentName, prompt, options = {}) {
  return new Promise((resolve, reject) => {
    const startTime = Date.now();
    // Copilot CLI syntax: gh copilot agent @agent-name "prompt"
    const args = ['copilot', 'agent', `@${agentName}`, prompt];
    
    const proc = spawn('gh', args, {
      stdio: ['ignore', 'pipe', 'pipe'],
      timeout: options.timeout || 30000,
      cwd: options.cwd || process.cwd()
    });
    
    let stdout = '';
    let stderr = '';
    
    proc.stdout.on('data', (data) => {
      stdout += data.toString();
    });
    
    proc.stderr.on('data', (data) => {
      stderr += data.toString();
    });
    
    proc.on('close', (exitCode) => {
      const duration = Date.now() - startTime;
      resolve({ stdout, stderr, exitCode, duration });
    });
    
    proc.on('error', (err) => {
      reject(new Error(`Failed to spawn gh: ${err.message}`));
    });
    
    // Timeout handler
    setTimeout(() => {
      proc.kill();
      reject(new Error(`Copilot invocation timeout after ${options.timeout || 30000}ms`));
    }, options.timeout || 30000);
  });
}

/**
 * Check if Claude CLI is available
 */
function isClaude Available() {
  try {
    const { execSync } = require('child_process');
    execSync('claude --version', { stdio: 'ignore' });
    return true;
  } catch (err) {
    return false;
  }
}

/**
 * Check if Copilot CLI is available
 */
function isCopilotAvailable() {
  try {
    const { execSync } = require('child_process');
    execSync('gh copilot --version', { stdio: 'ignore' });
    return true;
  } catch (err) {
    return false;
  }
}

module.exports = {
  invokeClaude,
  invokeCopilot,
  isClaudeAvailable,
  isCopilotAvailable
};
```

**Features:**
- Process spawning with timeout protection
- Output capture (stdout, stderr)
- Duration tracking
- CLI availability detection
- Platform-specific invocation syntax
  </action>
  <verify>
```bash
# Verify module loads without errors
node -e "require('./bin/lib/test-helpers/cli-invoker')"
```
  </verify>
  <done>
CLI invoker helper exists with invocation functions for both platforms, timeout handling, and availability detection.
  </done>
</task>

<task name="create-invocation-tests" type="auto">
  <files>bin/test-agent-invocation.js</files>
  <action>
Create smoke tests that invoke agents and validate responses.

**Test Structure:**
```javascript
const fs = require('fs');
const path = require('path');
const os = require('os');
const {
  invokeClaude,
  invokeCopilot,
  isClaudeAvailable,
  isCopilotAvailable
} = require('./lib/test-helpers/cli-invoker');

async function runTests() {
  let passed = 0;
  let failed = 0;
  let skipped = 0;
  
  console.log('=== Agent Invocation Smoke Tests ===\n');
  console.log('These tests invoke agents via CLI and validate responses.');
  console.log('Tests require actual CLI installations.\n');
  
  const claudeAvailable = isClaudeAvailable();
  const copilotAvailable = isCopilotAvailable();
  
  console.log(`Claude CLI: ${claudeAvailable ? '✅ Available' : '❌ Not found'}`);
  console.log(`Copilot CLI: ${copilotAvailable ? '✅ Available' : '❌ Not found'}\n`);
  
  if (!claudeAvailable && !copilotAvailable) {
    console.log('⚠️  No CLIs available - skipping all invocation tests');
    console.log('Install Claude CLI or Copilot CLI to run these tests.\n');
    process.exit(0);
  }
  
  // Test agents (subset for smoke tests)
  const testAgents = [
    { name: 'gsd-executor', prompt: 'List files in current directory' },
    { name: 'gsd-planner', prompt: 'What is your role?' }
  ];
  
  // Claude tests
  if (claudeAvailable) {
    console.log('--- Claude CLI Tests ---\n');
    
    for (const agent of testAgents) {
      try {
        console.log(`Testing: ${agent.name}`);
        
        const result = await invokeClaude(agent.name, agent.prompt, {
          timeout: 30000
        });
        
        // Validate response
        if (result.exitCode === 0) {
          console.log(`  ✅ Agent responded (exit 0)`);
          passed++;
        } else {
          console.log(`  ❌ Agent failed (exit ${result.exitCode})`);
          if (result.stderr) {
            console.log(`  Error: ${result.stderr.slice(0, 100)}`);
          }
          failed++;
        }
        
        // Check for tool usage indicators
        const usedTools = result.stdout.includes('bash') || 
                          result.stdout.includes('read') ||
                          result.stdout.includes('executing');
        
        if (usedTools) {
          console.log(`  ✅ Tools used in response`);
          passed++;
        } else {
          console.log(`  ⚠️  No obvious tool usage (may be OK)`);
          skipped++;
        }
        
        console.log(`  Duration: ${result.duration}ms\n`);
        
      } catch (err) {
        console.log(`  ❌ Invocation failed: ${err.message}\n`);
        failed++;
      }
    }
  }
  
  // Copilot tests
  if (copilotAvailable) {
    console.log('--- Copilot CLI Tests ---\n');
    
    // Create temp test directory
    const testDir = path.join(os.tmpdir(), 'copilot-test-' + Date.now());
    fs.mkdirSync(testDir, { recursive: true });
    fs.writeFileSync(path.join(testDir, 'test.txt'), 'Hello from test file');
    
    for (const agent of testAgents) {
      try {
        console.log(`Testing: ${agent.name}`);
        
        const result = await invokeCopilot(agent.name, agent.prompt, {
          timeout: 30000,
          cwd: testDir
        });
        
        // Validate response
        if (result.exitCode === 0) {
          console.log(`  ✅ Agent responded (exit 0)`);
          passed++;
        } else {
          console.log(`  ❌ Agent failed (exit ${result.exitCode})`);
          if (result.stderr) {
            console.log(`  Error: ${result.stderr.slice(0, 100)}`);
          }
          failed++;
        }
        
        // Check for tool usage indicators
        const usedTools = result.stdout.includes('search') || 
                          result.stdout.includes('execute') ||
                          result.stdout.includes('edit');
        
        if (usedTools) {
          console.log(`  ✅ Tools used in response`);
          passed++;
        } else {
          console.log(`  ⚠️  No obvious tool usage (may be OK)`);
          skipped++;
        }
        
        console.log(`  Duration: ${result.duration}ms\n`);
        
      } catch (err) {
        console.log(`  ❌ Invocation failed: ${err.message}\n`);
        failed++;
      }
    }
    
    // Cleanup
    fs.rmSync(testDir, { recursive: true, force: true });
  }
  
  console.log('='.repeat(60));
  console.log(`✅ Passed: ${passed}`);
  console.log(`❌ Failed: ${failed}`);
  console.log(`⚠️  Skipped: ${skipped}`);
  console.log('='.repeat(60));
  
  if (!claudeAvailable && !copilotAvailable) {
    console.log('\n⚠️  Install CLIs to run full test suite');
    process.exit(0);
  }
  
  process.exit(failed > 0 ? 1 : 0);
}

if (require.main === module) {
  runTests().catch(err => {
    console.error('Fatal error:', err);
    process.exit(1);
  });
}

module.exports = { runTests };
```

**Test Coverage:**
- Agent invocation via CLI
- Response validation (exit codes)
- Tool usage detection
- Timeout handling
- Graceful degradation (skip if CLI not available)

**Exit Codes:**
- 0 if all tests pass or CLIs unavailable
- 1 if any test fails
  </action>
  <verify>
```bash
# This test requires CLI installations
# If no CLIs available, exits 0 with skip message
node bin/test-agent-invocation.js
```
  </verify>
  <done>
Invocation test exists, validates agent responses via CLI, detects tool usage, handles missing CLIs gracefully.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Agent invocation smoke tests that call agents via CLI</what-built>
  <how-to-verify>
**Prerequisites:**
- Claude CLI or Copilot CLI installed on your machine
- Agents installed via `node bin/install.js --all`

**Test Steps:**

1. **Run invocation tests:**
```bash
node bin/test-agent-invocation.js
```

2. **Expected output:**
```
=== Agent Invocation Smoke Tests ===

Claude CLI: ✅ Available
Copilot CLI: ✅ Available

--- Claude CLI Tests ---

Testing: gsd-executor
  ✅ Agent responded (exit 0)
  ✅ Tools used in response
  Duration: 2500ms

Testing: gsd-planner
  ✅ Agent responded (exit 0)
  ⚠️  No obvious tool usage (may be OK)
  Duration: 1800ms

--- Copilot CLI Tests ---

Testing: gsd-executor
  ✅ Agent responded (exit 0)
  ✅ Tools used in response
  Duration: 3200ms

Testing: gsd-planner
  ✅ Agent responded (exit 0)
  ⚠️  No obvious tool usage (may be OK)
  Duration: 2100ms

============================================================
✅ Passed: 6
❌ Failed: 0
⚠️  Skipped: 2
============================================================
```

3. **Check exit code:**
```bash
echo $?
# Should be 0
```

4. **If CLIs not available:**
- Tests should skip gracefully with message
- Exit code should still be 0

5. **If tests fail:**
- Note which agent/platform failed
- Check CLI installation
- Verify agents were installed correctly
  </how-to-verify>
  <resume-signal>
Reply "approved" if tests pass, or describe issues encountered:
- Which CLI (Claude/Copilot)?
- Which agent failed?
- Error messages shown?
  </resume-signal>
</task>

## Verification

**Success Criteria:**
- [ ] `bin/lib/test-helpers/cli-invoker.js` exists
- [ ] CLI invoker provides invocation functions for both platforms
- [ ] `bin/test-agent-invocation.js` exists and runs
- [ ] Invocation tests detect available CLIs
- [ ] Tests skip gracefully if CLIs not installed
- [ ] Tests validate agent responses and tool usage
- [ ] Human verification confirms tests work on local machine

**Commands:**
```bash
# Check helper loads
node -e "require('./bin/lib/test-helpers/cli-invoker')"

# Run invocation tests (requires CLI installation)
node bin/test-agent-invocation.js
```

## Success Criteria

Phase 5 Plan 2 complete when:
- CLI invoker helper provides platform-agnostic invocation
- Invocation tests can call agents via process spawn
- Tests validate responses and tool usage
- Tests handle missing CLIs gracefully
- Human verification confirms tests work on actual CLI installations

## Output

Files created:
- `bin/lib/test-helpers/cli-invoker.js` - CLI process spawning helper
- `bin/test-agent-invocation.js` - Agent invocation smoke tests

Dependencies verified:
- Depends on Plan 1 (generation and installation tests)
- Tests use generated agents from Plan 1
