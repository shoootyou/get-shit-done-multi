---
phase: 02-adapter-implementation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [bin/install.js]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User with global Codex installation can invoke /gsd:help"
    - "User with global Codex installation can invoke any /gsd: slash command"
    - "Prompts directory (~/.codex/prompts/gsd/) contains all 24 command files"
  artifacts:
    - path: "bin/install.js"
      provides: "installCodex() copies commands to both embedded location and prompts directory"
      min_lines: 15
      pattern: "if.*dirs\\.commands.*!==.*null"
  key_links:
    - from: "bin/install.js"
      to: "dirs.commands"
      via: "conditional copy when dirs.commands !== null"
      pattern: "copyWithPathReplacement.*dirs\\.commands"
---

<objective>
**Gap Closure: Fix Codex global installation to copy commands to prompts directory**

**Purpose:** Close CMD-07 verification gap by ensuring Codex global installations copy command files to both embedded skills location AND ~/.codex/prompts/gsd/ for slash command invocation.

**Output:** Modified installCodex() function that copies commands to prompts directory when dirs.commands is not null (global installations).
</objective>

<execution_context>
@.github/skills/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-adapter-implementation/02-VERIFICATION.md
@.planning/phases/02-adapter-implementation/02-03-SUMMARY.md
@bin/install.js
@bin/lib/adapters/codex.js
</context>

<tasks>

<task type="auto">
  <name>Add prompts directory copy for global Codex installations</name>
  <files>bin/install.js</files>
  <action>
Modify installCodex() function (currently lines 718-726) to copy commands to prompts directory for global installations.

**Current behavior (lines 718-726):**
- Commands copied ONLY to embedded skills location: `dirs.skills/commands/gsd`
- `dirs.commands` (from codex adapter line 38) is configured but never used

**Required behavior:**
After the existing commands copy (line 726), add conditional copy to prompts directory:

```javascript
// For global Codex, also copy to prompts directory
if (dirs.commands !== null) {
  copyWithPathReplacement(commandsSrc, dirs.commands, codexAdapter, 'command');
  if (verifyInstalled(dirs.commands, 'prompts/gsd')) {
    console.log(`  ${green}✓${reset} Installed prompts/gsd`);
  } else {
    failures.push('prompts/gsd');
  }
}
```

**Why this pattern:**
- Codex adapter correctly defines `commands: isGlobal ? path.join(os.homedir(), '.codex', 'prompts', 'gsd') : null` (codex.js line 38)
- Local Codex (dirs.commands === null): Commands embedded in skills only ✓
- Global Codex (dirs.commands !== null): Commands in BOTH skills (embedded) AND prompts (for slash invocation)
- Research (02-RESEARCH.md lines 283-290) documented this dual-location requirement
- Codex verify() (codex.js lines 118-127) already checks prompts directory when not null

**Do NOT:**
- Remove the existing commands copy to skills location (line 720-726) - this must remain for embedded commands
- Change the condition - use exact check `dirs.commands !== null`
- Modify the codex adapter - it already returns correct paths
  </action>
  <verify>
1. Read bin/install.js lines 718-750 to confirm conditional copy added after existing copy
2. Run grep to confirm pattern exists: `grep -n "if.*dirs\.commands.*!==.*null" bin/install.js`
3. Verify two copyWithPathReplacement calls exist for commandsSrc in installCodex()
4. Check that failures array includes 'prompts/gsd' in the new conditional block
  </verify>
  <done>
- installCodex() contains conditional block checking `if (dirs.commands !== null)`
- Block includes copyWithPathReplacement call with commandsSrc → dirs.commands
- Block includes verifyInstalled check for 'prompts/gsd'
- Block includes success message logging and failure tracking
- Existing commands copy to skills location remains intact
  </done>
</task>

</tasks>

<verification>
After implementation:

1. **Code inspection:**
   - `grep -n "dirs\.commands" bin/install.js` shows usage in installCodex()
   - Two copyWithPathReplacement calls for commands exist (skills + prompts)
   - Conditional block checks `dirs.commands !== null`

2. **Manual test (requires global Codex installation):**
   - Run: `npx get-shit-done-cc --codex-global`
   - Check: `ls ~/.codex/prompts/gsd/` shows 24 command files
   - Check: `ls ~/.codex/skills/get-shit-done/commands/gsd/` shows 24 command files
   - Both locations should have identical command files
</verification>

<success_criteria>
**Measurable completion:**

1. **Code verified:**
   - installCodex() function contains conditional `if (dirs.commands !== null)` block
   - Block calls copyWithPathReplacement with dirs.commands destination
   - Block calls verifyInstalled for 'prompts/gsd'
   - Existing commands copy to skills location preserved

2. **Gap closed:**
   - CMD-07 requirement satisfied: "Codex CLI commands use prompt files in correct directory"
   - Verification gap resolved: "Codex global installation doesn't copy commands to ~/.codex/prompts/gsd/"
   - Missing implementation added: "Copy commands to dirs.commands when dirs.commands !== null"

3. **Observable truths achievable:**
   - User with global Codex can invoke `/gsd:help` (commands in prompts directory)
   - User with global Codex can invoke any `/gsd:` command
   - Prompts directory contains all 24 command files
</success_criteria>

<output>
After completion, create `.planning/phases/02-adapter-implementation/02-04-SUMMARY.md` documenting:
- Gap closure implementation
- Code changes made
- Verification results
- Phase 2 now complete with all requirements satisfied
</output>
