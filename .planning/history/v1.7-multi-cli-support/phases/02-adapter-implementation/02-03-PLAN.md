---
phase: 02-adapter-implementation
plan: 03
type: execute
wave: 3
depends_on: [02-02]
files_modified:
  - bin/install.js
autonomous: true

must_haves:
  truths:
    - "User can run npx get-shit-done-cc --all to install to all detected CLIs"
    - "Installer loops through detected CLIs and installs to each"
    - "Post-install summary shows which CLIs were installed and verification status"
    - "Each CLI installation shows count of commands and agents installed"
  artifacts:
    - path: "bin/install.js"
      provides: "--all flag support and enhanced verification"
      contains: "--all"
      pattern: "args\\.includes\\(['\"]--(all|A)['\"]\\)"
  key_links:
    - from: "bin/install.js --all flag handler"
      to: "bin/lib/detect.js detectInstalledCLIs()"
      via: "CLI detection to determine install targets"
      pattern: "detectInstalledCLIs\\(\\)"
    - from: "bin/install.js verification"
      to: "adapter.verify() methods"
      via: "Post-install checks"
      pattern: "adapter\\.verify\\(dirs\\)"
---

<objective>
Enable --all flag for single-command installation to all detected CLIs with comprehensive verification reporting.

Purpose: Complete the multi-CLI deployment capability by allowing users to install GSD to all available CLIs in one command, with detailed verification that confirms commands and agents are accessible.

Output: --all flag support in install.js with automatic CLI detection, parallel installation to all detected CLIs, and enhanced verification reporting showing command/agent counts per CLI.
</objective>

<execution_context>
@.github/skills/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-adapter-implementation/02-02-SUMMARY.md

# Refactored installer from 02-02
@bin/install.js

# Detection utilities
@bin/lib/detect.js

# Adapter modules
@bin/lib/adapters/claude.js
@bin/lib/adapters/copilot.js
@bin/lib/adapters/codex.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --all flag support</name>
  <files>bin/install.js</files>
  <action>
Add --all flag parsing and installation logic to install.js.

**Step 1: Parse --all flag (after line 40)**
After existing flag parsing, add:
```javascript
const hasAll = args.includes('--all') || args.includes('-A');
```

**Step 2: Update help text (around line 70-107)**
Add to options list:
```javascript
    ${cyan}--all, -A${reset}                Install to all detected CLIs (Claude, Copilot, Codex)
```

Add to examples:
```javascript
    ${dim}# Install to all detected CLIs in one command${reset}
    npx get-shit-done-cc --all
```

**Step 3: Add installAll() function (after finishInstall, before promptLocation)**
```javascript
/**
 * Install to all detected CLIs
 */
function installAll() {
  const detected = detectInstalledCLIs();
  const availableCLIs = Object.entries(detected)
    .filter(([_, isInstalled]) => isInstalled)
    .map(([cli, _]) => cli);
  
  if (availableCLIs.length === 0) {
    console.log(`  ${yellow}No CLIs detected. Install a CLI first:${reset}`);
    console.log(`    - Claude Code: https://claude.ai/download`);
    console.log(`    - GitHub Copilot CLI: npm install -g @github/copilot-cli`);
    console.log(`    - Codex CLI: npm install -g @codex/cli`);
    process.exit(1);
  }
  
  console.log(`  ${green}Installing to ${availableCLIs.length} detected CLI(s)...${reset}\n`);
  
  const results = [];
  
  // Install Claude if detected
  if (detected.claude) {
    console.log(`  ${cyan}━━━ Claude Code ━━━${reset}\n`);
    try {
      const { settingsPath, settings, statuslineCommand } = install(true);
      // Skip statusline prompts in batch mode
      finishInstall(settingsPath, settings, statuslineCommand, false);
      results.push({ cli: 'Claude Code', success: true });
    } catch (err) {
      console.error(`  ${yellow}⚠ Claude installation failed: ${err.message}${reset}\n`);
      results.push({ cli: 'Claude Code', success: false, error: err.message });
    }
  }
  
  // Install Copilot if detected
  if (detected.copilot) {
    console.log(`  ${cyan}━━━ GitHub Copilot CLI ━━━${reset}\n`);
    try {
      installCopilot();
      results.push({ cli: 'GitHub Copilot CLI', success: true });
    } catch (err) {
      console.error(`  ${yellow}⚠ Copilot installation failed: ${err.message}${reset}\n`);
      results.push({ cli: 'GitHub Copilot CLI', success: false, error: err.message });
    }
  }
  
  // Install Codex if detected
  if (detected.codex) {
    console.log(`  ${cyan}━━━ Codex CLI ━━━${reset}\n`);
    try {
      installCodex(true); // Global install
      results.push({ cli: 'Codex CLI', success: true });
    } catch (err) {
      console.error(`  ${yellow}⚠ Codex installation failed: ${err.message}${reset}\n`);
      results.push({ cli: 'Codex CLI', success: false, error: err.message });
    }
  }
  
  // Summary
  console.log(`\n  ${cyan}━━━ Installation Summary ━━━${reset}\n`);
  results.forEach(result => {
    const status = result.success ? `${green}✓${reset}` : `${yellow}✗${reset}`;
    console.log(`  ${status} ${result.cli}${result.error ? ` (${result.error})` : ''}`);
  });
  
  const successCount = results.filter(r => r.success).length;
  console.log(`\n  Installed to ${successCount}/${results.length} CLI(s)\n`);
}
```

**Step 4: Wire --all flag into main flow (around line 910)**
After flag parsing, before CLI detection display, add:
```javascript
// Handle --all flag first
if (hasAll) {
  installAll();
  process.exit(0);
}
```

This exits early for --all, bypassing interactive prompts. Satisfies INSTALL-04 requirement (install for all detected CLIs in single run).
  </action>
  <verify>
# Verify --all flag parsing
grep -q "hasAll.*--all" bin/install.js && echo "PASS: --all flag parsed"

# Verify installAll function exists
grep -q "function installAll" bin/install.js && echo "PASS: installAll function created"

# Verify --all help text added
grep -q "\-\-all.*Install to all detected CLIs" bin/install.js && echo "PASS: help text added"
  </verify>
  <done>--all flag support implemented - users can install to all detected CLIs with single command</done>
</task>

<task type="auto">
  <name>Task 2: Enhance verification reporting</name>
  <files>bin/install.js</files>
  <action>
Enhance post-install verification to show detailed command and agent counts.

**Step 1: Update adapter verify() usage in install() function**
Replace existing verification call (added in 02-02) with enhanced version:
```javascript
// Verify installation with detailed reporting
const verifyResult = claudeAdapter.verify(dirs);
if (verifyResult.success) {
  const commandCount = fs.readdirSync(dirs.commands)
    .filter(f => f.endsWith('.md')).length;
  const agentCount = fs.readdirSync(dirs.agents)
    .filter(f => f.endsWith('.agent.md')).length;
  console.log(`  ${dim}✓ Verified: ${commandCount} commands, ${agentCount} agents${reset}\n`);
} else {
  console.error(`  ${yellow}⚠ Installation verification warnings:${reset}`);
  verifyResult.errors.forEach(err => console.error(`    - ${err}`));
  console.log();
}
```

**Step 2: Update verification in installCopilot() function**
Replace existing verification call with:
```javascript
// Verify installation with detailed reporting
const verifyResult = copilotAdapter.verify(dirs);
if (verifyResult.success) {
  const skillFiles = fs.readdirSync(dirs.skills)
    .filter(f => f.endsWith('.md')).length;
  const agentCount = fs.readdirSync(dirs.agents)
    .filter(f => f.endsWith('.agent.md')).length;
  console.log(`  ${dim}✓ Verified: ${skillFiles} skill files, ${agentCount} agents${reset}\n`);
} else {
  console.error(`  ${yellow}⚠ Installation verification warnings:${reset}`);
  verifyResult.errors.forEach(err => console.error(`    - ${err}`));
  console.log();
}
```

**Step 3: Update verification in installCodex() function**
Replace existing verification call with:
```javascript
// Verify installation with detailed reporting
const verifyResult = codexAdapter.verify(dirs);
if (verifyResult.success) {
  const skillFiles = fs.readdirSync(dirs.skills)
    .filter(f => f.endsWith('.md')).length;
  const agentDirs = fs.readdirSync(dirs.agents)
    .filter(f => fs.statSync(path.join(dirs.agents, f)).isDirectory()).length;
  console.log(`  ${dim}✓ Verified: ${skillFiles} skill files, ${agentDirs} agent skills${reset}\n`);
} else {
  console.error(`  ${yellow}⚠ Installation verification warnings:${reset}`);
  verifyResult.errors.forEach(err => console.error(`    - ${err}`));
  console.log();
}
```

Why count files: Research shows verification must check content, not just directories (Common Pitfall 5). File counts confirm installation completeness. This satisfies INSTALL-08 requirement (post-install verification confirms commands accessible).
  </action>
  <verify>
# Verify enhanced verification with counts
grep -c "commandCount\|skillFiles\|agentCount" bin/install.js  # Should be >= 6
  </verify>
  <done>Post-install verification enhanced to show command/agent counts, confirming installation completeness per CLI</done>
</task>

<task type="auto">
  <name>Task 3: Add verification to --all summary</name>
  <files>bin/install.js</files>
  <action>
Update installAll() function to collect and display verification results in summary.

Modify results array structure in installAll() to include verification:
```javascript
const results = [];

// For each CLI installation, capture verification:
if (detected.claude) {
  console.log(`  ${cyan}━━━ Claude Code ━━━${reset}\n`);
  try {
    const { settingsPath, settings, statuslineCommand } = install(true);
    finishInstall(settingsPath, settings, statuslineCommand, false);
    
    // Capture verification
    const dirs = claudeAdapter.getTargetDirs(true);
    const verifyResult = claudeAdapter.verify(dirs);
    const commandCount = verifyResult.success ? 
      fs.readdirSync(dirs.commands).filter(f => f.endsWith('.md')).length : 0;
    const agentCount = verifyResult.success ?
      fs.readdirSync(dirs.agents).filter(f => f.endsWith('.agent.md')).length : 0;
    
    results.push({ 
      cli: 'Claude Code', 
      success: true,
      commands: commandCount,
      agents: agentCount,
      verified: verifyResult.success
    });
  } catch (err) {
    console.error(`  ${yellow}⚠ Claude installation failed: ${err.message}${reset}\n`);
    results.push({ cli: 'Claude Code', success: false, error: err.message });
  }
}
```

Apply same pattern to Copilot and Codex installations (count skill files and agents).

Update summary display to show counts:
```javascript
// Summary
console.log(`\n  ${cyan}━━━ Installation Summary ━━━${reset}\n`);
results.forEach(result => {
  const status = result.success ? `${green}✓${reset}` : `${yellow}✗${reset}`;
  let line = `  ${status} ${result.cli}`;
  
  if (result.success && result.verified) {
    line += ` ${dim}(${result.commands || result.agents} commands, ${result.agents} agents)${reset}`;
  } else if (result.error) {
    line += ` ${dim}(${result.error})${reset}`;
  }
  
  console.log(line);
});

const successCount = results.filter(r => r.success).length;
console.log(`\n  ${green}✓${reset} Installed to ${successCount}/${results.length} CLI(s)\n`);
```

This provides clear success/failure visibility per CLI with verification counts. Addresses requirement CMD-10 (commands work with global and local) by verifying both installation types.
  </action>
  <verify>
# Verify results include verification fields
grep -A 5 "results.push.*cli.*success.*commands" bin/install.js | head -10
  </verify>
  <done>--all flag summary shows detailed verification results including command and agent counts per CLI</done>
</task>

</tasks>

<verification>
Test --all flag (requires having Claude/Copilot/Codex installed):

```bash
# Dry-run test: check --all flag handling exists
node bin/install.js --help | grep -A 1 "\-\-all"

# Test detection + --all logic (won't actually install without confirmation)
node -e "
const {detectInstalledCLIs} = require('./bin/lib/detect');
const detected = detectInstalledCLIs();
console.log('Detected CLIs:', detected);
console.log('Would install to:', Object.keys(detected).filter(cli => detected[cli]));
"

# Verify enhanced verification output
grep "Verified:.*commands.*agents" bin/install.js && echo "✓ Enhanced verification"

# Count verification enhancements
grep -c "commandCount\|skillFiles\|agentCount" bin/install.js  # Should be >= 6
```

Expected output:
- --all flag in help: ✓
- Detection shows available CLIs
- Enhanced verification: ✓
- Verification count checks: ≥6
</verification>

<success_criteria>
1. --all flag parsed and documented in help text
2. installAll() function detects available CLIs and installs to each
3. installAll() handles installation failures gracefully (logs error, continues to next CLI)
4. Post-install verification shows command and agent counts for each CLI
5. --all summary displays verification status and counts per CLI
6. Users can run npx get-shit-done-cc --all and see which CLIs were installed successfully
7. Verification confirms all 24 GSD commands accessible (by counting command files)
8. Phase 2 success criteria all satisfied:
   - ✓ User runs --all and installs to all detected CLIs in single execution
   - ✓ Post-install verification confirms commands accessible
   - ✓ Commands work with global and local installations (verified by counts)
   - ✓ Agents deployed correctly per CLI format
</success_criteria>

<output>
After completion, create `.planning/phases/02-adapter-implementation/02-03-SUMMARY.md`

Document:
- --all flag implementation complete
- Multi-CLI installation in single command working
- Enhanced verification with command/agent counts
- Phase 2 complete - all requirements satisfied
- Ready for Phase 3 (Command System - Unified Command Interface)
</output>
