---
phase: 02-adapter-implementation
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - bin/install.js
autonomous: true

must_haves:
  truths:
    - "install.js uses adapter modules for all CLI-specific logic"
    - "Path replacement logic removed from install.js (delegated to adapters)"
    - "Claude, Copilot, and Codex installations all use adapter interface"
    - "Verification runs after each CLI installation"
  artifacts:
    - path: "bin/install.js"
      provides: "Refactored installer using adapter layer"
      contains: "require('./lib/adapters/"
      pattern: "adapter\\.getTargetDirs\\(|adapter\\.convertContent\\("
  key_links:
    - from: "bin/install.js"
      to: "bin/lib/adapters/claude.js"
      via: "require('./lib/adapters/claude')"
      pattern: "require\\(['\"]\\.\\.\\/lib\\/adapters\\/claude['\"]\\)"
    - from: "bin/install.js"
      to: "bin/lib/adapters/copilot.js"
      via: "require('./lib/adapters/copilot')"
      pattern: "require\\(['\"]\\.\\.\\/lib\\/adapters\\/copilot['\"]\\)"
    - from: "bin/install.js"
      to: "bin/lib/adapters/codex.js"
      via: "require('./lib/adapters/codex')"
      pattern: "require\\(['\"]\\.\\.\\/lib\\/adapters\\/codex['\"]\\)"
---

<objective>
Wire adapter modules into install.js, replacing ad-hoc path replacement with structured adapter pattern that works consistently across all three CLIs.

Purpose: Eliminate CLI-specific logic scattered throughout install.js by delegating to adapter modules, making the installer easier to maintain and extend.

Output: Refactored install.js that uses adapter.getTargetDirs(), adapter.convertContent(), and adapter.verify() for all three CLIs, with replaceClaudePaths() function removed.
</objective>

<execution_context>
@.github/skills/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-adapter-implementation/02-01-SUMMARY.md

# Adapter modules from 02-01
@bin/lib/adapters/claude.js
@bin/lib/adapters/copilot.js
@bin/lib/adapters/codex.js

# Current installer implementation
@bin/install.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add adapter imports to install.js</name>
  <files>bin/install.js</files>
  <action>
Add adapter imports after existing require statements (after line 9):

```javascript
const claudeAdapter = require('./lib/adapters/claude');
const copilotAdapter = require('./lib/adapters/copilot');
const codexAdapter = require('./lib/adapters/codex');
```

This makes adapter modules available throughout install.js for use in installation functions.
  </action>
  <verify>grep -n "require.*adapters/claude" bin/install.js</verify>
  <done>Adapter modules imported and available in install.js</done>
</task>

<task type="auto">
  <name>Task 2: Replace replaceClaudePaths with adapter.convertContent</name>
  <files>bin/install.js</files>
  <action>
Refactor install.js to use adapter pattern:

**Step 1: Remove replaceClaudePaths function (lines 148-177)**
Delete the entire function - this logic now lives in adapters.

**Step 2: Update copyWithPathReplacement function (lines 179-220)**
Add `adapter` parameter: `function copyWithPathReplacement(srcDir, destDir, adapter, contentType = 'skill')`

Replace line 200 (calls replaceClaudePaths):
```javascript
// OLD
content = replaceClaudePaths(content, pathPrefix, includeLocalPaths);

// NEW
content = adapter.convertContent(content, contentType);
```

**Step 3: Update install() function (approx lines 220-350)**
This is the Claude installation function. Add at start of function:
```javascript
const dirs = claudeAdapter.getTargetDirs(isGlobal);
```

Replace manual path construction with dirs object:
- Replace `path.join(targetDir, 'get-shit-done')` with `dirs.skills`
- Replace `path.join(targetDir, 'agents')` with `dirs.agents`
- Replace `path.join(targetDir, 'commands', 'gsd')` with `dirs.commands`

Update copyWithPathReplacement calls to pass claudeAdapter:
```javascript
copyWithPathReplacement(skillsSrcDir, dirs.skills, claudeAdapter, 'skill');
```

**Step 4: Update installCopilot() function (lines 570-687)**
Add at start:
```javascript
const dirs = copilotAdapter.getTargetDirs(false); // Copilot is always local
```

Replace manual path joins with dirs object.

Update copyWithPathReplacement calls to pass copilotAdapter:
```javascript
copyWithPathReplacement(skillsSrcDir, dirs.skills, copilotAdapter, 'skill');
copyWithPathReplacement(agentsSrcDir, dirs.agents, copilotAdapter, 'agent');
```

**Step 5: Update installCodex() function (lines 689-800)**
Add at start:
```javascript
const dirs = codexAdapter.getTargetDirs(isGlobal);
```

Replace manual path joins with dirs object.

Update copyWithPathReplacement calls to pass codexAdapter:
```javascript
copyWithPathReplacement(skillsSrcDir, dirs.skills, codexAdapter, 'skill');
```

For agent copying in Codex, update to use skill format (per research - agents become skills):
```javascript
// Codex: convert agents to skill format
const agentFiles = fs.readdirSync(agentsSrcDir);
for (const agentFile of agentFiles.filter(f => f.endsWith('.agent.md'))) {
  const agentPath = path.join(agentsSrcDir, agentFile);
  const agentContent = fs.readFileSync(agentPath, 'utf8');
  const skillContent = codexAdapter.convertContent(agentContent, 'agent');
  
  const agentName = agentFile.replace('.agent.md', '');
  const agentSkillDir = path.join(dirs.agents, agentName);
  fs.mkdirSync(agentSkillDir, {recursive: true});
  fs.writeFileSync(path.join(agentSkillDir, 'SKILL.md'), skillContent);
}
```

Why separate agent handling for Codex: Codex expects folder-per-skill structure (.codex/skills/get-shit-done/agents/gsd-planner/SKILL.md), not flat .agent.md files. This addresses research Pitfall 2.
  </action>
  <verify>
# Verify replaceClaudePaths removed
! grep -q "function replaceClaudePaths" bin/install.js && echo "PASS: replaceClaudePaths removed" || echo "FAIL"

# Verify adapter.convertContent used
grep -q "adapter\.convertContent" bin/install.js && echo "PASS: adapter.convertContent used" || echo "FAIL"

# Verify adapter.getTargetDirs used
grep -c "\.getTargetDirs(" bin/install.js  # Should be 3 (once per CLI)
  </verify>
  <done>install.js refactored to use adapter pattern - all path replacement and format conversion delegated to adapter modules</done>
</task>

<task type="auto">
  <name>Task 3: Add post-install verification calls</name>
  <files>bin/install.js</files>
  <action>
Add verification after each CLI installation completes.

**For install() function (Claude):**
After file copying completes (before statusline handling), add:
```javascript
// Verify installation
const verifyResult = claudeAdapter.verify(dirs);
if (!verifyResult.success) {
  console.error(`  ${yellow}⚠ Installation verification warnings:${reset}`);
  verifyResult.errors.forEach(err => console.error(`    - ${err}`));
}
```

**For installCopilot() function:**
After file copying completes (before success message), add:
```javascript
// Verify installation
const verifyResult = copilotAdapter.verify(dirs);
if (!verifyResult.success) {
  console.error(`  ${yellow}⚠ Installation verification warnings:${reset}`);
  verifyResult.errors.forEach(err => console.error(`    - ${err}`));
  console.log(); // Blank line before success message
}
```

**For installCodex() function:**
After file copying completes (before success message), add:
```javascript
// Verify installation
const verifyResult = codexAdapter.verify(dirs);
if (!verifyResult.success) {
  console.error(`  ${yellow}⚠ Installation verification warnings:${reset}`);
  verifyResult.errors.forEach(err => console.error(`    - ${err}`));
  console.log(); // Blank line before success message
}
```

Verification checks run automatically but are non-blocking - warnings displayed but installation continues. This addresses INSTALL-08 requirement (post-install verification) while avoiding installation failures from minor issues.
  </action>
  <verify>
# Verify verification calls added for all three CLIs
grep -c "adapter\.verify(dirs)" bin/install.js  # Should be 3
  </verify>
  <done>Post-install verification runs automatically for all three CLIs, displaying warnings if critical files or structure is missing</done>
</task>

</tasks>

<verification>
Test refactored installer:

```bash
# Test Claude install (dry-run by inspecting code)
node -e "console.log(require('./bin/install.js'))" 2>&1 | head -10

# Verify old function removed
! grep -q "function replaceClaudePaths" bin/install.js && echo "✓ replaceClaudePaths removed"

# Verify adapter usage
grep "adapter.getTargetDirs(" bin/install.js | wc -l  # Should be 3
grep "adapter.convertContent(" bin/install.js | wc -l  # Should be >= 3
grep "adapter.verify(" bin/install.js | wc -l  # Should be 3

# Verify imports present
grep "require('./lib/adapters/claude')" bin/install.js && echo "✓ claude adapter imported"
grep "require('./lib/adapters/copilot')" bin/install.js && echo "✓ copilot adapter imported"
grep "require('./lib/adapters/codex')" bin/install.js && echo "✓ codex adapter imported"
```

Expected output:
- replaceClaudePaths removed: ✓
- getTargetDirs calls: 3
- convertContent calls: ≥3
- verify calls: 3
- All three adapters imported: ✓
</verification>

<success_criteria>
1. replaceClaudePaths function removed from install.js
2. All three adapters imported (claude, copilot, codex)
3. copyWithPathReplacement accepts adapter parameter
4. install() uses claudeAdapter.getTargetDirs() and claudeAdapter.convertContent()
5. installCopilot() uses copilotAdapter.getTargetDirs() and copilotAdapter.convertContent()
6. installCodex() uses codexAdapter.getTargetDirs() and codexAdapter.convertContent()
7. Codex agent installation converts to folder-per-skill structure
8. Verification runs after each CLI installation completes
9. install.js is shorter and cleaner with CLI-specific logic delegated to adapters
</success_criteria>

<output>
After completion, create `.planning/phases/02-adapter-implementation/02-02-SUMMARY.md`

Document:
- Refactored install.js to use adapter pattern
- Removed 150+ lines of ad-hoc path replacement code
- All three CLI installations use consistent adapter interface
- Verification automatically runs post-install
- Ready for --all flag implementation in Plan 02-03
</output>
