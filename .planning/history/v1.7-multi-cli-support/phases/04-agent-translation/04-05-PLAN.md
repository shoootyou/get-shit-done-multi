---
phase: 04-agent-translation
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/adapters/claude.js
  - bin/lib/adapters/copilot.js
  - bin/lib/adapters/codex.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Adapter invokeAgent methods execute actual CLI commands instead of returning mocks"
    - "Claude adapter uses child_process to invoke claude-code CLI"
    - "Copilot adapter uses child_process to invoke gh copilot CLI"
    - "Codex adapter uses child_process to invoke codex CLI"
    - "Adapters handle CLI command failures gracefully with error messages"
  artifacts:
    - path: "bin/lib/adapters/claude.js"
      provides: "Real CLI command execution in invokeAgent"
      min_lines: 140
    - path: "bin/lib/adapters/copilot.js"
      provides: "Real CLI command execution in invokeAgent"
      min_lines: 135
    - path: "bin/lib/adapters/codex.js"
      provides: "Real CLI command execution in invokeAgent"
      min_lines: 195
  key_links:
    - from: "invokeAgent functions"
      to: "child_process.execFile or child_process.spawn"
      via: "CLI command execution"
      pattern: "(execFile|spawn).*claude-code|gh|codex"
---

<objective>
Replace adapter stub implementations with real CLI command execution to enable transparent agent invocation across Claude, Copilot, and Codex CLIs.

Purpose: Close verification gap #1 (adapter stubs) by implementing actual CLI command invocation in all three adapters, enabling true multi-CLI agent orchestration.

Output: Working adapter implementations that execute real CLI commands and return structured results with stdout/stderr handling.
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-agent-translation/04-VERIFICATION.md
@.planning/phases/04-agent-translation/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Claude adapter CLI execution</name>
  <files>bin/lib/adapters/claude.js</files>
  <action>
Replace the TODO and mock return (lines 115-125) in invokeAgent function with actual CLI command execution:

1. Import child_process at top: `const { execFile } = require('node:child_process');` and `const { promisify } = require('node:util');`
2. Create promisified execFile: `const execFileAsync = promisify(execFile);`
3. Replace mock implementation with:
   ```javascript
   try {
     // Construct CLI command
     // Note: Exact command TBD based on Claude CLI docs - may be `claude-code agent invoke` or similar
     // For now, use placeholder that will be updated during testing
     const { stdout, stderr } = await execFileAsync('claude-code', [
       'agent', 'invoke', agent.name,
       '--prompt', prompt
     ]);
     
     return {
       success: true,
       cli: 'claude',
       agent: agent.name,
       result: stdout.trim(),
       duration: 0 // Will be tracked by PerformanceTracker in agent-invoker
     };
   } catch (error) {
     return {
       success: false,
       cli: 'claude',
       agent: agent.name,
       error: error.message,
       stderr: error.stderr || '',
       duration: 0
     };
   }
   ```

Key details:
- Use execFile (not exec) to avoid shell injection vulnerabilities
- Trim stdout to remove trailing newlines
- Include stderr in error response for debugging
- Preserve existing function signature (agent, prompt, options)
- Duration tracking happens in agent-invoker (PerformanceTracker), not here
  </action>
  <verify>
```bash
# Check TODO removed and execFile imported
grep -n "TODO" bin/lib/adapters/claude.js
grep -n "execFile" bin/lib/adapters/claude.js
grep -n "Mock agent execution" bin/lib/adapters/claude.js
```

Expect: No TODO lines, execFile import found, no mock return statement.
  </verify>
  <done>
invokeAgent function in claude.js executes real CLI commands using child_process.execFile with error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Copilot adapter CLI execution</name>
  <files>bin/lib/adapters/copilot.js</files>
  <action>
Replace the TODO and mock return (lines 110-120) in invokeAgent function with actual CLI command execution:

1. Import child_process at top: `const { execFile } = require('node:child_process');` and `const { promisify } = require('node:util');`
2. Create promisified execFile: `const execFileAsync = promisify(execFile);`
3. Replace mock implementation with:
   ```javascript
   try {
     // GitHub CLI with copilot extension
     // Command: gh copilot agent run {agentName} --prompt "{prompt}"
     const { stdout, stderr } = await execFileAsync('gh', [
       'copilot', 'agent', 'run', agent.name,
       '--prompt', prompt
     ]);
     
     return {
       success: true,
       cli: 'copilot',
       agent: agent.name,
       result: stdout.trim(),
       duration: 0
     };
   } catch (error) {
     return {
       success: false,
       cli: 'copilot',
       agent: agent.name,
       error: error.message,
       stderr: error.stderr || '',
       duration: 0
     };
   }
   ```

Key details:
- Use `gh` command (GitHub CLI) with copilot extension
- Agent name references .github/agents/{agentName}.agent.md
- Same security and error handling patterns as Claude adapter
  </action>
  <verify>
```bash
# Check TODO removed and execFile imported
grep -n "TODO" bin/lib/adapters/copilot.js
grep -n "execFile" bin/lib/adapters/copilot.js
grep -n "Mock agent execution" bin/lib/adapters/copilot.js
```

Expect: No TODO lines, execFile import found, no mock return statement.
  </verify>
  <done>
invokeAgent function in copilot.js executes real gh CLI commands with copilot extension.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Codex adapter CLI execution</name>
  <files>bin/lib/adapters/codex.js</files>
  <action>
Replace the TODO and mock return (lines 168-178) in invokeAgent function with actual CLI command execution:

1. Import child_process at top: `const { execFile } = require('node:child_process');` and `const { promisify } = require('node:util');`
2. Create promisified execFile: `const execFileAsync = promisify(execFile);`
3. Replace mock implementation with:
   ```javascript
   try {
     // Codex CLI skill invocation
     // Command: codex skill run {skillName} --prompt "{prompt}"
     const { stdout, stderr } = await execFileAsync('codex', [
       'skill', 'run', agent.name,
       '--prompt', prompt
     ]);
     
     return {
       success: true,
       cli: 'codex',
       agent: agent.name,
       result: stdout.trim(),
       duration: 0
     };
   } catch (error) {
     return {
       success: false,
       cli: 'codex',
       agent: agent.name,
       error: error.message,
       stderr: error.stderr || '',
       duration: 0
     };
   }
   ```

Key details:
- Use `codex` command with skill subcommand
- Agent name references .codex/skills/{agentName}/
- Same security and error handling patterns as other adapters
  </action>
  <verify>
```bash
# Check TODO removed and execFile imported
grep -n "TODO" bin/lib/adapters/codex.js
grep -n "execFile" bin/lib/adapters/codex.js
grep -n "Mock agent execution" bin/lib/adapters/codex.js

# Verify all three adapters cleaned up
echo "=== Adapter stub status ==="
grep -c "Mock agent execution" bin/lib/adapters/*.js
```

Expect: No TODO lines in any adapter, all imports present, grep returns "0" for mock count.
  </verify>
  <done>
All three adapter invokeAgent functions execute real CLI commands instead of returning mock data.
  </done>
</task>

</tasks>

<verification>
Run manual test of agent invocation:

```bash
# Test that invokeAgent is now callable (will fail if CLI not installed, but that's expected)
node -e "
const { invokeAgent } = require('./bin/lib/orchestration/agent-invoker.js');
const testAgent = { name: 'gsd-executor' };
const testPrompt = 'Test prompt';

invokeAgent(testAgent, testPrompt).then(result => {
  console.log('Invocation result:', result);
  // Expected: Either successful CLI execution OR error indicating CLI not found
  // NOT: Mock data response
  if (result.result === 'Mock agent execution (CLI command pending)') {
    console.error('❌ FAILED: Still returning mock data');
    process.exit(1);
  } else {
    console.log('✅ PASSED: Real CLI execution attempted');
  }
}).catch(err => {
  console.log('✅ PASSED: Real execution attempted (error expected if CLI not installed):', err.message);
});
"
```
</verification>

<success_criteria>
1. No TODO comments remain in any adapter invokeAgent function
2. All three adapters import and use child_process.execFile
3. Mock return statements replaced with CLI command execution
4. Error handling preserves stderr for debugging
5. Function signatures unchanged (backward compatible with agent-invoker)
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-translation/04-05-SUMMARY.md` documenting:
- Adapter stub removal
- CLI command execution implementation
- Error handling strategy
- Verification results
</output>
