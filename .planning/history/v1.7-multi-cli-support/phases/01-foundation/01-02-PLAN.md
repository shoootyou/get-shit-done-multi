---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - bin/install.js
  - bin/lib/upgrade.js
autonomous: true

must_haves:
  truths:
    - "Developer runs `npx get-shit-done-cc --codex` and GSD installs to `.codex/skills/get-shit-done/`"
    - "Developer runs `npx get-shit-done-cc --codex-global` and GSD installs to `~/.codex/skills/get-shit-done/`"
    - "Developer upgrades GSD and `.planning/` directory is preserved"
    - "Installation shows clear success message with next steps"
  artifacts:
    - path: "bin/install.js"
      provides: "Codex CLI installation support"
      contains: ["--codex", "--codex-global", "hasCodex", "detectInstalledCLIs"]
      min_lines: 850
    - path: "bin/lib/upgrade.js"
      provides: "Version upgrade and data preservation"
      exports: ["preserveUserData", "restoreUserData", "cleanOrphanedFiles"]
      min_lines: 100
  key_links:
    - from: "bin/install.js"
      to: "bin/lib/paths.js"
      via: "require('./lib/paths')"
      pattern: "require\\(['\"]\\./lib/paths['\"]\\)"
    - from: "bin/install.js"
      to: "bin/lib/detect.js"
      via: "require('./lib/detect')"
      pattern: "require\\(['\"]\\./lib/detect['\"]\\)"
    - from: "bin/lib/upgrade.js"
      to: "bin/lib/paths.js"
      via: "require('./paths')"
      pattern: "require\\(['\"]\\./paths['\"]\\)"
---

<objective>
Extend installer with Codex CLI support and implement version upgrade logic that preserves user data.

Purpose: Enable GSD installation to Codex CLI (local and global) while ensuring version upgrades don't destroy user's project data in `.planning/` directories. This completes the multi-CLI installation capability.

Output: Updated `bin/install.js` with Codex support and new `bin/lib/upgrade.js` module for safe upgrades.
</objective>

<execution_context>
@.github/skills/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@bin/install.js
@bin/lib/paths.js
@bin/lib/detect.js
</context>

<tasks>

<task type="auto">
  <name>Add Codex CLI support to installer</name>
  <files>bin/install.js</files>
  <action>
Modify `bin/install.js` to add Codex CLI installation support:

1. **Add CLI detection import** (near line 7)
   - Add: `const { detectInstalledCLIs, getDetectedCLIsMessage } = require('./lib/detect');`
   - Add: `const { getConfigPaths } = require('./lib/paths');`

2. **Parse Codex flags** (near line 35)
   - Add: `const hasCodex = args.includes('--codex') || args.includes('--codex-cli');`
   - Add: `const hasCodexGlobal = args.includes('--codex-global');`

3. **Update help text** (near line 64-94)
   - Add to options section:
     ```
     ${cyan}--codex${reset}                   Install Codex CLI assets locally (to ./.codex)
     ${cyan}--codex-global${reset}            Install Codex CLI assets globally (to ~/.codex)
     ```
   - Add example: `npx get-shit-done-cc --codex`

4. **Show detected CLIs** (after banner, before installation logic ~line 100)
   - Add CLI detection display:
     ```javascript
     const detected = detectInstalledCLIs();
     const detectionMsg = getDetectedCLIsMessage(detected);
     console.log(`  ${dim}${detectionMsg}${reset}\n`);
     ```

5. **Add Codex installation logic** (parallel to existing Claude/Copilot logic)
   - Handle `hasCodex`: Install to `.codex/skills/get-shit-done/` in current directory
   - Handle `hasCodexGlobal`: Install to `~/.codex/skills/get-shit-done/` using os.homedir()
   - Use path.join() for ALL path construction
   - Copy from `get-shit-done/` directory like Copilot installation does
   - Update success messages to include Codex CLI

6. **Use existing path utilities**
   - Replace any hardcoded path logic with getConfigPaths('codex')
   - Ensure all Codex paths use path.join(), no string concatenation

Follow existing code patterns for Claude/Copilot installations. Maintain consistency in messaging, error handling, and file operations.
  </action>
  <verify>
Run `node bin/install.js --help` and confirm --codex, --codex-global appear in help.
Run `node bin/install.js --codex` in a test directory and verify files copied to `.codex/skills/get-shit-done/`.
  </verify>
  <done>
- `bin/install.js` imports lib/detect and lib/paths
- `--codex` and `--codex-global` flags parsed
- Help text updated with Codex options
- Detected CLIs displayed before installation
- Codex installation logic implemented (local and global)
- All path operations use path.join()
- Success messages include Codex CLI
  </done>
</task>

<task type="auto">
  <name>Create version upgrade module</name>
  <files>bin/lib/upgrade.js</files>
  <action>
Create `bin/lib/upgrade.js` for safe version upgrades with user data preservation:

1. **preserveUserData(installDir)** - Backs up user data before upgrade
   - Takes installation directory path
   - Identifies preserve directories: ['.planning', 'user-data'] (if they exist)
   - For each directory, rename to `${dirName}.backup-${Date.now()}`
   - Return object mapping directory names to backup paths: `{'.planning': '/path/.planning.backup-1234567890'}`
   - Use fs.existsSync() before rename, fs.renameSync() for atomic move
   - Use path.join() for all path construction

2. **restoreUserData(installDir, backups)** - Restores user data after upgrade
   - Takes installation directory and backups object from preserveUserData
   - For each entry in backups, rename backup path back to original name
   - Use fs.renameSync() for atomic operation
   - Wrap in try-catch, log errors but don't throw (graceful degradation)

3. **cleanOrphanedFiles(installDir)** - Removes known orphaned files from old versions
   - Takes installation directory path
   - Define array of known orphaned relative paths (currently empty, placeholder for future)
   - For each path, check if exists with fs.existsSync()
   - If exists, remove with fs.rmSync(fullPath, {recursive: true, force: true})
   - Use path.join() to build full paths

Follow research Pattern from 01-RESEARCH.md "Version Upgrade Pattern". Add comprehensive JSDoc comments. All operations must be atomic and safe (won't lose data on failure).
  </action>
  <verify>
Run `node -e "const u = require('./bin/lib/upgrade'); console.log(u.preserveUserData); console.log(u.restoreUserData); console.log(u.cleanOrphanedFiles)"`

All three functions should be defined without errors.
  </verify>
  <done>
- `bin/lib/upgrade.js` created
- Exports preserveUserData, restoreUserData, cleanOrphanedFiles
- Uses path.join() for all path operations
- Implements atomic rename for backups
- Preserves .planning directory during upgrades
- Comprehensive JSDoc comments
  </done>
</task>

</tasks>

<verification>
1. Installer recognizes --codex and --codex-global flags
2. CLI detection displays before installation
3. Codex installation works (local and global)
4. Upgrade module preserves user data
5. All new code uses path.join(), no string concatenation
6. Help text documents all new options
</verification>

<success_criteria>
- Installer supports Codex CLI installation (local and global)
- CLI detection integrated and displays before installation
- Version upgrade module created with data preservation
- All path operations use path.join() consistently
- Help text updated with Codex options and examples
- Installation produces clear success messages
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md` following the summary template.
</output>
