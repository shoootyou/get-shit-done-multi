---
phase: 5.1-fix-git-identity-preservation-in-agents
plan: 02
type: execute
wave: 2
depends_on: ["5.1-01"]
files_modified:
  - specs/agents/gsd-executor.md
  - specs/agents/gsd-planner.md
  - specs/agents/gsd-debugger.md
  - specs/agents/gsd-phase-researcher.md
  - specs/agents/gsd-research-synthesizer.md
autonomous: true
must_haves:
  - All 5 agents reference git-identity-helpers.sh workflow file
  - All git commit commands replaced with commit_as_user() calls
  - Agents source helper functions before committing
  - Git identity read from config hierarchy (git config → config.json)
  - All commits preserve user identity instead of using agent name
---

# Phase 5.1, Plan 2: Update Agent Git Commits

## Objective

Update all 5 agents that make git commits to use identity-preserving commit pattern via git-identity-helpers.sh workflow.

## Context

**Problem:** Agents currently use bare `git commit -m "message"` commands, which allows GitHub Copilot CLI to override author with agent name ("GSD Debugger" instead of user name).

**Solution:** Replace all commit commands with calls to `commit_as_user()` function from git-identity-helpers.sh (created in Plan 01). This function sets GIT_AUTHOR_* and GIT_COMMITTER_* environment variables before each commit, overriding platform behavior.

**Agents to update (5 total):**
1. **gsd-executor** - 2 commits (task completion, plan completion)
2. **gsd-planner** - 2 commits (plan creation, roadmap updates)
3. **gsd-debugger** - 1 commit (bug fix implementation)
4. **gsd-phase-researcher** - 1 commit (research document creation)
5. **gsd-research-synthesizer** - 1 commit (synthesis document creation)

**Pattern to apply:**
```bash
# OLD (wrong - allows platform override):
git commit -m "feat(01-02): implement feature"

# NEW (correct - preserves user identity):
# Source helpers if not already done
if ! type commit_as_user >/dev/null 2>&1; then
    source ~/.claude/get-shit-done/workflows/git-identity-helpers.sh
fi

# Use helper function
commit_as_user "feat(01-02): implement feature"
```

## Tasks

<task name="update-executor-commits" type="auto">
  <files>
    specs/agents/gsd-executor.md
  </files>
  <action>
Update gsd-executor agent to use identity-preserving commits.

**Step 1: Add helper function reference to agent frontmatter or role section**

Add after `<role>` section, before `<execution_flow>`:

```markdown
## Git Identity Preservation

This agent makes commits. To preserve user identity (not override with agent name), 
use helper functions from @~/.claude/get-shit-done/workflows/git-identity-helpers.sh

Helper functions:
- `read_git_identity()` - Read from git config or config.json
- `commit_as_user "message"` - Commit with user identity preserved

See RESEARCH.md for details on environment variable precedence.
```

**Step 2: Find and replace commit patterns**

Search for: `git commit -m` (2 occurrences)

Replace pattern:
```bash
# Source git identity helpers
if ! type commit_as_user >/dev/null 2>&1; then
    source ~/.claude/get-shit-done/workflows/git-identity-helpers.sh
fi

# Commit preserving user identity
commit_as_user "{original commit message}"
```

**Occurrence 1 (line ~562): Task completion commit**
```bash
# OLD:
git commit -m "{type}({phase}-{plan}): {concise task description}

# NEW:
# Source git identity helpers
if ! type commit_as_user >/dev/null 2>&1; then
    source ~/.claude/get-shit-done/workflows/git-identity-helpers.sh
fi

# Commit preserving user identity
commit_as_user "{type}({phase}-{plan}): {concise task description}
```

**Occurrence 2 (line ~710): Plan completion commit**
```bash
# OLD:
git commit -m "docs({phase}-{plan}): complete [plan-name] plan

# NEW:
# Source git identity helpers (only if not already sourced)
if ! type commit_as_user >/dev/null 2>&1; then
    source ~/.claude/get-shit-done/workflows/git-identity-helpers.sh
fi

# Commit preserving user identity
commit_as_user "docs({phase}-{plan}): complete [plan-name] plan
```

**Important:** Keep all commit message formatting exactly the same. Only change HOW the commit is executed, not WHAT is committed.
  </action>
  <verify>
```bash
# Check helper reference added
if ! grep -q "git-identity-helpers.sh" specs/agents/gsd-executor.md; then
    echo "ERROR: Helper reference not added to executor"
    exit 1
fi

# Check commit_as_user used
commit_count=$(grep -c "commit_as_user" specs/agents/gsd-executor.md)
if [ "$commit_count" -lt 2 ]; then
    echo "ERROR: Expected 2 commit_as_user calls in executor, found $commit_count"
    exit 1
fi

# Check bare git commit removed
if grep -q "^git commit -m" specs/agents/gsd-executor.md; then
    echo "WARNING: Bare git commit still exists in executor"
fi

echo "✓ Executor updated with $commit_count identity-preserving commits"
```
  </verify>
  <done>
gsd-executor updated: helper reference added, 2 commits converted to commit_as_user() pattern.
  </done>
</task>

<task name="update-planner-commits" type="auto">
  <files>
    specs/agents/gsd-planner.md
  </files>
  <action>
Update gsd-planner agent to use identity-preserving commits.

**Step 1: Add helper function reference**

Add after `<role>` section:

```markdown
## Git Identity Preservation

This agent makes commits. To preserve user identity (not override with agent name), 
use helper functions from @~/.claude/get-shit-done/workflows/git-identity-helpers.sh

Helper functions:
- `read_git_identity()` - Read from git config or config.json
- `commit_as_user "message"` - Commit with user identity preserved
```

**Step 2: Find and replace commit patterns**

Search for: `git commit -m` (2 occurrences - plan creation, roadmap updates)

Replace with commit_as_user pattern:
```bash
# Source git identity helpers
if ! type commit_as_user >/dev/null 2>&1; then
    source ~/.claude/get-shit-done/workflows/git-identity-helpers.sh
fi

commit_as_user "{original message}"
```

**Note:** Preserve multiline commit messages exactly as they are. The commit_as_user function supports multiline strings.
  </action>
  <verify>
```bash
# Check helper reference
if ! grep -q "git-identity-helpers.sh" specs/agents/gsd-planner.md; then
    echo "ERROR: Helper reference not added to planner"
    exit 1
fi

# Check commit_as_user usage
commit_count=$(grep -c "commit_as_user" specs/agents/gsd-planner.md)
if [ "$commit_count" -lt 2 ]; then
    echo "ERROR: Expected 2 commit_as_user calls in planner, found $commit_count"
    exit 1
fi

echo "✓ Planner updated with $commit_count identity-preserving commits"
```
  </verify>
  <done>
gsd-planner updated: helper reference added, 2 commits converted to commit_as_user() pattern.
  </done>
</task>

<task name="update-remaining-agents" type="auto">
  <files>
    specs/agents/gsd-debugger.md
    specs/agents/gsd-phase-researcher.md
    specs/agents/gsd-research-synthesizer.md
  </files>
  <action>
Update remaining 3 agents to use identity-preserving commits.

**For each agent (debugger, phase-researcher, research-synthesizer):**

**Step 1: Add helper reference** (after `<role>` section)

```markdown
## Git Identity Preservation

This agent makes commits. To preserve user identity (not override with agent name), 
use helper functions from @~/.claude/get-shit-done/workflows/git-identity-helpers.sh

Helper functions:
- `read_git_identity()` - Read from git config or config.json
- `commit_as_user "message"` - Commit with user identity preserved
```

**Step 2: Replace git commit commands**

Pattern to find: `git commit -m`
Pattern to replace:
```bash
# Source git identity helpers
if ! type commit_as_user >/dev/null 2>&1; then
    source ~/.claude/get-shit-done/workflows/git-identity-helpers.sh
fi

commit_as_user "{original message}"
```

**Per-agent details:**

**gsd-debugger.md:**
- 1 commit (bug fix implementation)
- Keep all git add commands unchanged
- Only modify the commit command

**gsd-phase-researcher.md:**
- 1 commit (research document creation)
- Multiline commit message - preserve formatting

**gsd-research-synthesizer.md:**
- 1 commit (synthesis document creation)
- Multiline commit message - preserve formatting
  </action>
  <verify>
```bash
# Check all 3 agents
for agent in gsd-debugger gsd-phase-researcher gsd-research-synthesizer; do
    echo "Checking $agent..."
    
    # Check helper reference
    if ! grep -q "git-identity-helpers.sh" "specs/agents/$agent.md"; then
        echo "ERROR: Helper reference not added to $agent"
        exit 1
    fi
    
    # Check commit_as_user used
    commit_count=$(grep -c "commit_as_user" "specs/agents/$agent.md")
    if [ "$commit_count" -lt 1 ]; then
        echo "ERROR: Expected at least 1 commit_as_user call in $agent, found $commit_count"
        exit 1
    fi
    
    echo "✓ $agent updated with $commit_count identity-preserving commit(s)"
done

echo "All 3 remaining agents updated successfully"
```
  </verify>
  <done>
All 3 remaining agents updated: helper references added, commits converted to commit_as_user() pattern.
  </done>
</task>

<task name="regenerate-agents" type="auto">
  <action>
Regenerate all 5 updated agents from specs so changes take effect in installed locations.

**Run generation:**
```bash
# Navigate to project root
cd /workspace

# Run install script with regeneration
node bin/install.js --platform claude --skip-skills

# Verify generation succeeded
if [ $? -ne 0 ]; then
    echo "ERROR: Agent regeneration failed"
    exit 1
fi

echo "Agents regenerated successfully"
```

**What this does:**
- Reads updated specs from specs/agents/
- Applies template engine (Mustache conditionals, frontmatter)
- Writes to .claude/get-shit-done/agents/
- Preserves all updates to commit patterns

**Note:** Skip skills generation (--skip-skills) to avoid regenerating gsd-new-project before we test it separately.
  </action>
  <verify>
```bash
# Verify generated agents exist and have updated patterns
echo "Verifying generated agents..."

for agent in gsd-executor gsd-planner gsd-debugger gsd-phase-researcher gsd-research-synthesizer; do
    generated_file=".claude/get-shit-done/agents/$agent.md"
    
    if [ ! -f "$generated_file" ]; then
        echo "ERROR: Generated agent not found: $generated_file"
        exit 1
    fi
    
    # Check for commit_as_user in generated output
    if ! grep -q "commit_as_user" "$generated_file"; then
        echo "ERROR: commit_as_user not in generated $agent"
        exit 1
    fi
    
    # Check helper file reference
    if ! grep -q "git-identity-helpers.sh" "$generated_file"; then
        echo "ERROR: Helper reference not in generated $agent"
        exit 1
    fi
    
    echo "✓ $agent generated with identity preservation"
done

echo "All 5 agents verified in generated output"
```
  </verify>
  <done>
All 5 agents regenerated from specs. Generated agents in .claude/get-shit-done/agents/ contain updated commit patterns with user identity preservation.
  </done>
</task>

## Verification

After completing all tasks:

```bash
# 1. Count updated commits across all agents
echo "=== Commit Pattern Summary ==="
for agent in gsd-executor gsd-planner gsd-debugger gsd-phase-researcher gsd-research-synthesizer; do
    spec="specs/agents/$agent.md"
    generated=".claude/get-shit-done/agents/$agent.md"
    
    spec_count=$(grep -c "commit_as_user" "$spec" 2>/dev/null || echo 0)
    gen_count=$(grep -c "commit_as_user" "$generated" 2>/dev/null || echo 0)
    
    echo "$agent: $spec_count (spec) -> $gen_count (generated)"
done

# 2. Verify no bare git commits remain in specs
echo -e "\n=== Checking for Remaining Bare Commits ==="
for agent in specs/agents/gsd-*.md; do
    if grep -q "^git commit -m" "$agent" 2>/dev/null; then
        echo "WARNING: Bare git commit found in $(basename $agent)"
    fi
done
echo "Check complete"

# 3. Test helper functions can be sourced
echo -e "\n=== Testing Helper Functions ==="
if source ~/.claude/get-shit-done/workflows/git-identity-helpers.sh 2>/dev/null; then
    echo "✓ Helper functions sourceable"
    
    # Test function exists
    if type commit_as_user >/dev/null 2>&1; then
        echo "✓ commit_as_user function available"
    fi
else
    echo "ERROR: Cannot source helper functions"
fi

# 4. Summary
echo -e "\n=== Summary ==="
echo "Agents updated: 5"
echo "Specs modified: 5"
echo "Agents regenerated: 5"
echo "Helper file: ~/.claude/get-shit-done/workflows/git-identity-helpers.sh"
```

Expected output:
- All 5 agents have commit_as_user in both spec and generated files
- No bare `git commit -m` commands remain
- Helper functions source successfully
- commit_as_user function available

## Success Criteria

- [x] All 5 agent specs reference git-identity-helpers.sh
- [x] All git commit commands replaced with commit_as_user() calls
- [x] Agents source helpers before committing (type check prevents re-sourcing)
- [x] No bare `git commit -m` commands remain in agent specs
- [x] All 5 agents regenerated from updated specs
- [x] Generated agents in .claude/get-shit-done/agents/ contain updated patterns
- [x] Helper functions can be sourced and commit_as_user is available

## Output

**Specs modified:**
- `specs/agents/gsd-executor.md` - 2 commits updated
- `specs/agents/gsd-planner.md` - 2 commits updated  
- `specs/agents/gsd-debugger.md` - 1 commit updated
- `specs/agents/gsd-phase-researcher.md` - 1 commit updated
- `specs/agents/gsd-research-synthesizer.md` - 1 commit updated

**Generated agents updated:**
- `.claude/get-shit-done/agents/gsd-executor.md`
- `.claude/get-shit-done/agents/gsd-planner.md`
- `.claude/get-shit-done/agents/gsd-debugger.md`
- `.claude/get-shit-done/agents/gsd-phase-researcher.md`
- `.claude/get-shit-done/agents/gsd-research-synthesizer.md`

**Total commits preserved:** 7 commits across 5 agents now use user identity instead of agent name.

**Next:** Test identity preservation with actual commit, verify git log shows user name instead of "GSD [Agent Name]"
