---
phase: 5.1-fix-git-identity-preservation-in-agents
plan: 01
subsystem: infrastructure
tags: [git, identity, authentication, config-schema, bash-helpers]
requires:
  - config.json template system
  - new-project workflow (gsd-new-project)
provides:
  - Git identity schema in config.json
  - Helper functions for identity-preserving commits
  - Identity collection workflow in new-project
affects:
  - 5.1-02: Will regenerate gsd-new-project from updated spec
  - All agents that make commits: Will need to use helper functions
tech-stack:
  added: []
  patterns:
    - Git environment variables for identity override
    - Hierarchical config fallback (git config → config.json)
    - Python-based JSON manipulation in workflows
key-files:
  created:
    - .claude/get-shit-done/workflows/git-identity-helpers.sh
  modified:
    - .claude/get-shit-done/templates/config.json
    - .codex/skills/get-shit-done/templates/config.json
    - .github/skills/get-shit-done/templates/config.json
    - get-shit-done/templates/config.json
    - specs/skills/gsd-new-project/SKILL.md
decisions:
  - id: git-env-vars-override
    choice: Use GIT_AUTHOR_* and GIT_COMMITTER_* environment variables
    rationale: Highest precedence in git hierarchy, overrides platform behavior
  - id: python-json-manipulation
    choice: Use Python for config.json updates instead of jq
    rationale: Python available in all environments, no external dependencies
  - id: three-source-options
    choice: Support global, config, and local git identity sources
    rationale: Flexibility for different user workflows and security requirements
  - id: phase-5-5-insertion
    choice: Add Phase 5.5 between workflow preferences and research
    rationale: Must collect identity before first automated commit but after config.json creation
metrics:
  tasks: 3
  commits: 3
  duration: 2m 21s
  completed: 2026-01-23
---

# Phase 5.1, Plan 1: Git Identity Foundation Summary

**One-liner:** Created git identity schema in config.json, bash helper functions for identity-preserving commits, and Phase 5.5 workflow for identity collection in new-project setup.

## What Was Built

### 1. Config Template Schema Extension

Added git identity section to all 4 platform config.json templates:
- `.claude/get-shit-done/templates/config.json`
- `.codex/skills/get-shit-done/templates/config.json`
- `.github/skills/get-shit-done/templates/config.json`
- `get-shit-done/templates/config.json`

**Schema structure:**
```json
{
  "git": {
    "author": {
      "name": "User Name",
      "email": "user@example.com"
    },
    "source": "global"
  }
}
```

**Fields:**
- `git.author.name`: User's commit author name
- `git.author.email`: User's commit email
- `git.source`: Identity origin ("global" | "config" | "local")

### 2. Bash Helper Functions

Created `.claude/get-shit-done/workflows/git-identity-helpers.sh` with two functions:

**`read_git_identity()`:**
- Reads from git config first (respects global → local hierarchy)
- Falls back to `.planning/config.json` if not found
- Returns two lines: name on line 1, email on line 2
- Validates email contains @ symbol
- Exit code 0 on success, 1 if identity not found

**`commit_as_user()`:**
- Wraps `git commit` with identity preservation
- Sets all 4 environment variables:
  - `GIT_AUTHOR_NAME`
  - `GIT_AUTHOR_EMAIL`
  - `GIT_COMMITTER_NAME`
  - `GIT_COMMITTER_EMAIL`
- Highest precedence in git hierarchy - overrides platform behavior
- Usage: `commit_as_user "commit message"`

### 3. New-Project Workflow Integration

Added **Phase 5.5: Git Identity Configuration** to `specs/skills/gsd-new-project/SKILL.md`:

**Flow:**
1. Check if git is already configured (git config user.name/email)
2. If configured: Store in config.json with source="global", continue
3. If not configured: Present 3 options via AskUserQuestion:
   - **Configure globally:** Guide user to run git config commands
   - **Project-only:** Collect name/email, store in config.json
   - **Already done:** Verify and store

**Validation:**
- Email must contain @ symbol
- Both name and email must be non-empty
- Source is recorded for debugging

**Timing:** Runs after Phase 5 (workflow preferences create config.json) and before Phase 6 (research decision), ensuring identity is available before any automated commits.

## Decisions Made

### Use Git Environment Variables

**Decision:** Use `GIT_AUTHOR_*` and `GIT_COMMITTER_*` environment variables for identity override.

**Alternatives considered:**
- Modify user's global git config (rejected: too invasive)
- Use git config --local (rejected: lower precedence, can be overridden by platform)
- Use .git/config file directly (rejected: fragile, doesn't work with environment)

**Rationale:** Environment variables have highest precedence in git hierarchy and fully override platform behavior (like Copilot CLI converting agent name to commit author).

### Python for JSON Manipulation

**Decision:** Use Python for config.json updates instead of jq.

**Alternatives considered:**
- jq (rejected: not available in all environments, requires installation)
- sed/awk (rejected: fragile with nested JSON structures)

**Rationale:** Python is universally available, handles JSON natively, and provides reliable parsing/serialization.

### Three Source Options

**Decision:** Support three identity sources: global, config, local.

**Alternatives considered:**
- Force global only (rejected: too restrictive for some workflows)
- Project-only storage (rejected: duplicates config across projects)

**Rationale:** Flexibility for different user needs:
- **global:** Most users, prefer git config
- **config:** Project-specific identity (contractors, multi-account users)
- **local:** Git config --local (advanced users)

### Phase 5.5 Placement

**Decision:** Insert Phase 5.5 between Phase 5 (workflow preferences) and Phase 6 (research).

**Alternatives considered:**
- Before Phase 5 (rejected: config.json doesn't exist yet)
- After Phase 8 (rejected: too late, automated agents might commit before this)

**Rationale:** 
- Must run after config.json is created (Phase 5)
- Must run before any automated commits
- Logical grouping with other setup phases

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

All verifications passed:

1. **Config templates:** All 4 templates contain valid JSON with git section
2. **Helper functions:** Bash syntax valid, both functions present, environment variables included
3. **New-project integration:** Phase 5.5 present with all required elements
4. **Helper function test:** Successfully sources and reads identity

## Technical Details

### Git Precedence Hierarchy

Identity resolution follows this order (highest to lowest):
1. **Environment variables** (GIT_AUTHOR_*, GIT_COMMITTER_*) ← We use this
2. Command-line arguments (--author)
3. Git config --local (.git/config)
4. Git config --global (~/.gitconfig)
5. Git config --system (/etc/gitconfig)

Platform behavior (Copilot CLI) injects at level 2-3, so we override at level 1.

### Helper Function Export

Functions are exported with `export -f` to make them available in subshells:
```bash
export -f read_git_identity
export -f commit_as_user
```

Agents will source the file and immediately have access to both functions.

### Email Validation

Basic validation: `[[ ! "$email" =~ "@" ]]`
- Not RFC-compliant but sufficient for git
- Prevents common typos (missing domain)
- Git itself doesn't validate format

## Testing Notes

**Manual verification in this environment:**
- Helper functions source correctly
- `read_git_identity()` successfully reads current git config
- Returns: "GSD Planner Agent" and "planner@gsd-system.local"

**Future testing:**
- Test with missing git config (should fall back to config.json)
- Test with invalid email (should reject)
- Test commit_as_user() with actual commit

## Next Phase Readiness

**Ready for 5.1-02:**
- ✅ Config schema defined
- ✅ Helper functions created
- ✅ New-project workflow updated
- ⏭️ Need to regenerate gsd-new-project from spec
- ⏭️ Need to update agent specs to use helper functions

**Blockers:** None

**Concerns:** None - foundation is solid

## Success Metrics

- [x] All 4 config.json templates contain git identity schema
- [x] Git identity schema includes name, email, source fields
- [x] Bash helper functions exist with read_git_identity() and commit_as_user()
- [x] Helper functions use GIT_AUTHOR_* and GIT_COMMITTER_* env vars
- [x] New-project workflow includes Phase 5.5 for identity collection
- [x] User can choose between global git config or project-only storage
- [x] Identity validation checks for non-empty name and email with @
- [x] config.json updated with collected identity before first automated commit

**All success criteria met.**

## Files Changed

### Created (1)
- `.claude/get-shit-done/workflows/git-identity-helpers.sh` - Bash helper functions for identity-preserving commits

### Modified (5)
- `.claude/get-shit-done/templates/config.json` - Added git identity schema
- `.codex/skills/get-shit-done/templates/config.json` - Added git identity schema
- `.github/skills/get-shit-done/templates/config.json` - Added git identity schema
- `get-shit-done/templates/config.json` - Added git identity schema
- `specs/skills/gsd-new-project/SKILL.md` - Added Phase 5.5 for git identity collection

## Git Commits

1. `e40d51e` - feat(5.1-01): add git identity schema to config templates
2. `7dada1a` - feat(5.1-01): create git identity helper functions
3. `36c9a3a` - feat(5.1-01): add git identity collection to new-project workflow

**All commits atomic and independently revertable.**
