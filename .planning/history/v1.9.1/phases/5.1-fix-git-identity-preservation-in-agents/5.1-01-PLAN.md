---
phase: 5.1-fix-git-identity-preservation-in-agents
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/get-shit-done/templates/config.json
  - .codex/skills/get-shit-done/templates/config.json
  - .github/skills/get-shit-done/templates/config.json
  - get-shit-done/templates/config.json
  - specs/skills/gsd-new-project/SKILL.md
  - .claude/get-shit-done/workflows/git-identity-helpers.sh
autonomous: true
must_haves:
  - Git identity schema exists in config.json template with name, email, source fields
  - Git identity collection questions exist in new-project workflow (Phase 5.5)
  - User can choose between global git config or project-only storage
  - Bash helper functions exist for reading identity and committing with user attribution
  - New projects collect and store git identity before any commits are made
---

# Phase 5.1, Plan 1: Git Identity Foundation

## Objective

Establish git identity collection infrastructure: extend config.json schema, add identity questions to new-project workflow, and create reusable bash helpers for identity-preserving commits.

## Context

**Problem:** Agents are overriding user git identity when committing. GitHub Copilot CLI uses agent `name` field as git author, resulting in 261 commits by "GSD Debugger" instead of actual users.

**Root cause:** Platform behavior - Copilot converts agent name to title case and uses as commit author with `{name}@localhost` email.

**Solution:** Use git environment variables (GIT_AUTHOR_*, GIT_COMMITTER_*) which have highest precedence. Requires:
1. Schema to store identity in config.json
2. Collection mechanism in new-project workflow  
3. Helper functions for agents to use

**From RESEARCH.md:**
- Environment variables override all other git config
- Must set 4 variables: GIT_AUTHOR_NAME, GIT_AUTHOR_EMAIL, GIT_COMMITTER_NAME, GIT_COMMITTER_EMAIL
- Fallback chain: git config → config.json → error
- Never modify user's global git config

## Tasks

<task name="update-config-template" type="auto">
  <files>
    .claude/get-shit-done/templates/config.json
    .codex/skills/get-shit-done/templates/config.json
    .github/skills/get-shit-done/templates/config.json
    get-shit-done/templates/config.json
  </files>
  <action>
Add git identity section to all 4 platform config.json templates.

**New fields to add:**
```json
{
  "mode": "interactive",
  "depth": "standard",
  "parallelization": { ... },
  "gates": { ... },
  "safety": { ... },
  "git": {
    "author": {
      "name": "User Name",
      "email": "user@example.com"
    },
    "source": "global"
  }
}
```

**Field semantics:**
- `git.author.name`: User's git commit author name
- `git.author.email`: User's git commit email
- `git.source`: How identity was collected ("global", "config", "local")

**Important:** Keep all existing fields unchanged. Only ADD the git section.

**Validation:** Ensure valid JSON syntax after edits.
  </action>
  <verify>
```bash
# Check all 4 templates have git section
for template in \
  .claude/get-shit-done/templates/config.json \
  .codex/skills/get-shit-done/templates/config.json \
  .github/skills/get-shit-done/templates/config.json \
  get-shit-done/templates/config.json; do
  
  echo "Checking $template..."
  
  # Validate JSON syntax
  if ! jq empty "$template" 2>/dev/null; then
    echo "ERROR: Invalid JSON in $template"
    exit 1
  fi
  
  # Check git section exists
  if ! jq -e '.git.author.name' "$template" >/dev/null 2>&1; then
    echo "ERROR: Missing git.author.name in $template"
    exit 1
  fi
  
  if ! jq -e '.git.author.email' "$template" >/dev/null 2>&1; then
    echo "ERROR: Missing git.author.email in $template"
    exit 1
  fi
  
  if ! jq -e '.git.source' "$template" >/dev/null 2>&1; then
    echo "ERROR: Missing git.source in $template"
    exit 1
  fi
  
  echo "✓ $template valid"
done

echo "All templates updated successfully"
```
  </verify>
  <done>
All 4 config.json templates contain git identity schema with name, email, and source fields. JSON syntax validated.
  </done>
</task>

<task name="create-helper-functions" type="auto">
  <files>
    .claude/get-shit-done/workflows/git-identity-helpers.sh
  </files>
  <action>
Create reusable bash helper functions that agents will reference.

**Create file:** `.claude/get-shit-done/workflows/git-identity-helpers.sh`

**Content (from RESEARCH.md verified patterns):**

```bash
#!/usr/bin/env bash
# Git identity preservation helpers
# Used by agents to commit with user identity instead of agent name

# Read git identity from config hierarchy (git config → config.json)
# Returns: Two lines - name on line 1, email on line 2
# Exit code: 0 on success, 1 if identity not found
read_git_identity() {
    local name email
    
    # Try git config first (respects global → local hierarchy)
    name=$(git config user.name 2>/dev/null)
    email=$(git config user.email 2>/dev/null)
    
    # Fallback to project config.json
    if [ -z "$name" ] || [ -z "$email" ]; then
        if [ -f .planning/config.json ]; then
            # Simple grep-based extraction (no jq dependency)
            name=$(grep -A 3 '"git"' .planning/config.json | \
                   grep '"name"' | head -1 | cut -d'"' -f4)
            email=$(grep -A 4 '"git"' .planning/config.json | \
                    grep '"email"' | head -1 | cut -d'"' -f4)
        fi
    fi
    
    # Validate results
    if [ -z "$name" ] || [ -z "$email" ]; then
        echo "ERROR: Git identity not configured" >&2
        echo "Please run: git config --global user.name 'Your Name'" >&2
        echo "           git config --global user.email 'you@example.com'" >&2
        return 1
    fi
    
    # Basic email validation (contains @)
    if [[ ! "$email" =~ "@" ]]; then
        echo "ERROR: Invalid email format: $email" >&2
        return 1
    fi
    
    # Return both values
    echo "$name"
    echo "$email"
}

# Commit with user identity preservation
# Usage: commit_as_user "commit message"
# Sets all 4 env vars (author + committer) to override platform behavior
commit_as_user() {
    local commit_message="$1"
    
    if [ -z "$commit_message" ]; then
        echo "ERROR: commit_as_user requires commit message" >&2
        return 1
    fi
    
    # Read identity (stores output in array via mapfile)
    local identity_output
    identity_output=$(read_git_identity) || return 1
    
    # Parse into separate variables
    local git_name git_email
    git_name=$(echo "$identity_output" | head -1)
    git_email=$(echo "$identity_output" | tail -1)
    
    # Commit with identity override (highest precedence)
    # Must set all 4 variables to fully override platform behavior
    GIT_AUTHOR_NAME="$git_name" \
    GIT_AUTHOR_EMAIL="$git_email" \
    GIT_COMMITTER_NAME="$git_name" \
    GIT_COMMITTER_EMAIL="$git_email" \
    git commit -m "$commit_message"
    
    local exit_code=$?
    if [ $exit_code -ne 0 ]; then
        echo "ERROR: git commit failed with exit code $exit_code" >&2
        return $exit_code
    fi
    
    return 0
}

# Export functions for use in subshells
export -f read_git_identity
export -f commit_as_user
```

**Documentation at top of file explains:**
- Purpose: Preserve user identity in agent commits
- Problem solved: Platform using agent name as author
- How to use: Replace `git commit -m "msg"` with `commit_as_user "msg"`
- Precedence: Environment variables override all other git config
  </action>
  <verify>
```bash
# Check file exists and is valid bash
if [ ! -f .claude/get-shit-done/workflows/git-identity-helpers.sh ]; then
    echo "ERROR: Helper file not created"
    exit 1
fi

# Syntax check
if ! bash -n .claude/get-shit-done/workflows/git-identity-helpers.sh; then
    echo "ERROR: Bash syntax errors in helper file"
    exit 1
fi

# Check required functions exist
if ! grep -q "^read_git_identity()" .claude/get-shit-done/workflows/git-identity-helpers.sh; then
    echo "ERROR: read_git_identity() function missing"
    exit 1
fi

if ! grep -q "^commit_as_user()" .claude/get-shit-done/workflows/git-identity-helpers.sh; then
    echo "ERROR: commit_as_user() function missing"
    exit 1
fi

# Check critical patterns exist
if ! grep -q "GIT_AUTHOR_NAME" .claude/get-shit-done/workflows/git-identity-helpers.sh; then
    echo "ERROR: Missing GIT_AUTHOR_NAME environment variable"
    exit 1
fi

if ! grep -q "GIT_COMMITTER_NAME" .claude/get-shit-done/workflows/git-identity-helpers.sh; then
    echo "ERROR: Missing GIT_COMMITTER_NAME environment variable"
    exit 1
fi

echo "✓ Helper functions created and validated"
```
  </verify>
  <done>
Bash helper file created at `.claude/get-shit-done/workflows/git-identity-helpers.sh` with read_git_identity() and commit_as_user() functions. Syntax validated.
  </done>
</task>

<task name="update-new-project-skill" type="auto">
  <files>
    specs/skills/gsd-new-project/SKILL.md
  </files>
  <action>
Add git identity collection to new-project workflow (after project setup, before first commit).

**Location:** Insert new Phase 5.5 in the `<process>` section, between Phase 5.4 (Initial commit) and Phase 6 (Subagent spawning).

**Content to add:**

```markdown
### Phase 5.5: Git Identity Configuration

**Goal:** Ensure git identity is configured before agents make commits.

**Check if git is already configured:**

```bash
GIT_NAME=$(git config user.name 2>/dev/null)
GIT_EMAIL=$(git config user.email 2>/dev/null)

if [ -n "$GIT_NAME" ] && [ -n "$GIT_EMAIL" ]; then
    echo "Git identity already configured:"
    echo "  Name: $GIT_NAME"
    echo "  Email: $GIT_EMAIL"
    
    # Store source in config.json
    jq '.git = {"author": {"name": env.GIT_NAME, "email": env.GIT_EMAIL}, "source": "global"}' \
       .planning/config.json > .planning/config.json.tmp && \
       mv .planning/config.json.tmp .planning/config.json
    
    # Continue to next phase
fi
```

**If not configured**, use AskUserQuestion:

```yaml
header: "Git Identity Configuration"
question: |
  Git user information is needed for commit attribution. Automated agents 
  (like gsd-executor) will commit using this identity.
  
  How would you like to proceed?
options:
  - id: configure-global
    label: "Configure git globally (recommended)"
    description: "I'll set it in git config for all repositories"
  - id: project-only
    label: "Store in this project only"
    description: "Keep identity in .planning/config.json for this project"
  - id: already-done
    label: "I already configured it"
    description: "Skip this step and verify configuration"
```

**If "configure-global" selected:**

```bash
echo "Please configure git globally by running:"
echo ""
echo "  git config --global user.name \"Your Name\""
echo "  git config --global user.email \"you@example.com\""
echo ""
echo "After running these commands, type 'done' to continue."

# Wait for user confirmation (via AskUserQuestion)
# Then re-check git config and store source as "global"

GIT_NAME=$(git config user.name 2>/dev/null)
GIT_EMAIL=$(git config user.email 2>/dev/null)

if [ -z "$GIT_NAME" ] || [ -z "$GIT_EMAIL" ]; then
    echo "ERROR: Git config not detected. Please try again."
    # Loop back to question
else
    # Store in config.json
    jq '.git = {"author": {"name": env.GIT_NAME, "email": env.GIT_EMAIL}, "source": "global"}' \
       .planning/config.json > .planning/config.json.tmp && \
       mv .planning/config.json.tmp .planning/config.json
fi
```

**If "project-only" selected:**

```yaml
# Ask for name
header: "Git Author Name"
question: "Enter your full name for git commits:"
input_type: freeform

# Ask for email
header: "Git Author Email"
question: "Enter your email for git commits:"
input_type: freeform

# Validate and store
```

```bash
# After receiving inputs (USER_NAME, USER_EMAIL)
# Validate email contains @
if [[ ! "$USER_EMAIL" =~ "@" ]]; then
    echo "ERROR: Invalid email format (must contain @)"
    # Loop back
fi

# Store in config.json
jq '.git = {"author": {"name": env.USER_NAME, "email": env.USER_EMAIL}, "source": "config"}' \
   .planning/config.json > .planning/config.json.tmp && \
   mv .planning/config.json.tmp .planning/config.json

echo "Git identity stored in .planning/config.json"
```

**If "already-done" selected:**

```bash
# Verify git config returns values
GIT_NAME=$(git config user.name 2>/dev/null)
GIT_EMAIL=$(git config user.email 2>/dev/null)

if [ -z "$GIT_NAME" ] || [ -z "$GIT_EMAIL" ]; then
    echo "ERROR: Git identity not found. Please configure it first."
    # Loop back to question
else
    echo "Git identity verified."
    # Store source as "global"
    jq '.git = {"author": {"name": env.GIT_NAME, "email": env.GIT_EMAIL}, "source": "global"}' \
       .planning/config.json > .planning/config.json.tmp && \
       mv .planning/config.json.tmp .planning/config.json
fi
```

**Success criteria for Phase 5.5:**
- [ ] Git identity exists in git config OR .planning/config.json
- [ ] Identity includes valid name (non-empty) and email (contains @)
- [ ] Source recorded in config.json ("global", "config", or "local")
```

**Integration notes:**
- Renumber existing Phase 6+ to 6.5+ (shift by 0.5)
- This MUST run before any automated commits
- Error if identity not available - don't continue
  </action>
  <verify>
```bash
# Check Phase 5.5 exists in new-project skill
if ! grep -q "### Phase 5.5: Git Identity Configuration" specs/skills/gsd-new-project/SKILL.md; then
    echo "ERROR: Phase 5.5 not added to new-project skill"
    exit 1
fi

# Check key elements exist
if ! grep -q "git config user.name" specs/skills/gsd-new-project/SKILL.md; then
    echo "ERROR: Git config checks missing"
    exit 1
fi

if ! grep -q "AskUserQuestion" specs/skills/gsd-new-project/SKILL.md; then
    echo "ERROR: User questions missing"
    exit 1
fi

if ! grep -q "configure-global" specs/skills/gsd-new-project/SKILL.md; then
    echo "ERROR: Configuration options missing"
    exit 1
fi

# Check config.json integration
if ! grep -q '.git = {' specs/skills/gsd-new-project/SKILL.md; then
    echo "ERROR: config.json git section integration missing"
    exit 1
fi

echo "✓ Git identity collection added to new-project skill"
```
  </verify>
  <done>
Phase 5.5 added to gsd-new-project workflow with git identity collection questions, validation, and config.json storage. User can choose global config or project-only storage.
  </done>
</task>

## Verification

After completing all tasks:

```bash
# 1. Verify config templates have git schema
echo "=== Config Template Verification ==="
jq '.git' .claude/get-shit-done/templates/config.json

# 2. Verify helper functions exist
echo -e "\n=== Helper Functions ==="
ls -lh .claude/get-shit-done/workflows/git-identity-helpers.sh
bash -n .claude/get-shit-done/workflows/git-identity-helpers.sh && echo "✓ Bash syntax valid"

# 3. Verify new-project has identity collection
echo -e "\n=== New Project Integration ==="
grep -A 5 "### Phase 5.5: Git Identity Configuration" specs/skills/gsd-new-project/SKILL.md | head -6

# 4. Test helper functions in isolation
echo -e "\n=== Testing Helper Functions ==="
source .claude/get-shit-done/workflows/git-identity-helpers.sh
echo "Current git identity:"
read_git_identity 2>/dev/null || echo "(Not configured - expected)"
```

Expected output:
- Config templates: Valid JSON with git.author.name, git.author.email, git.source
- Helper file: Exists, bash syntax valid, functions defined
- New-project: Phase 5.5 exists with AskUserQuestion patterns
- Test: Functions source without errors

## Success Criteria

- [x] All 4 config.json templates contain git identity schema
- [x] Git identity schema includes name, email, source fields
- [x] Bash helper functions exist with read_git_identity() and commit_as_user()
- [x] Helper functions use GIT_AUTHOR_* and GIT_COMMITTER_* env vars
- [x] New-project workflow includes Phase 5.5 for identity collection
- [x] User can choose between global git config or project-only storage
- [x] Identity validation checks for non-empty name and email with @
- [x] config.json updated with collected identity before first automated commit

## Output

**Files created/modified:**
- `.claude/get-shit-done/templates/config.json` - Added git schema
- `.codex/skills/get-shit-done/templates/config.json` - Added git schema
- `.github/skills/get-shit-done/templates/config.json` - Added git schema
- `get-shit-done/templates/config.json` - Added git schema
- `.claude/get-shit-done/workflows/git-identity-helpers.sh` - Created helper functions
- `specs/skills/gsd-new-project/SKILL.md` - Added Phase 5.5 for identity collection

**Next:** Regenerate gsd-new-project skill and update agent specs to use helper functions (Plan 5.1-02)
