---
phase: 3
plan: "03-05"
title: "GAP CLOSURE: Fix --project-dir Flag Support"
type: gap_closure
autonomous: true
priority: CRITICAL
estimated_duration: 15 min
blocking: true
parent_plan: "03-04"
---

# Plan 03-05: Fix --project-dir Flag Support

## Context

**Issue discovered:** During checkpoint 03-04 testing, user attempted to test installation in /tmp directory but skills were installed to /workspace instead.

**Root cause:** install.js line 805 uses `const projectDir = process.cwd()` and doesn't parse or respect `--project-dir` CLI flag.

**Blocking:** Cannot complete checkpoint 03-04 verification without ability to test in clean temporary directory.

## Objective

Implement `--project-dir` flag support in install.js so that installations can be tested in arbitrary directories (e.g., /tmp/gsd-test-install) without polluting the main repository.

## Requirements

### Must Have
- Parse `--project-dir` argument from CLI (support both `--project-dir /path` and `--project-dir=/path` formats)
- Pass projectDir to installCopilot() and installCodex() functions
- Update all hardcoded `process.cwd()` references to use projectDir parameter
- Default to `process.cwd()` if --project-dir not provided (backward compatibility)
- Test: Install to /tmp/gsd-test-install and verify files created in correct location

### Should Have
- Help text update to document --project-dir flag
- Error handling for invalid project directory paths
- Validation that project directory exists or can be created

### Nice to Have
- --dry-run mode to show where files would be installed without writing

## Tasks

### Task 1: Add --project-dir Argument Parsing
**File:** `bin/install.js`  
**Lines:** ~42-72 (args parsing section)

```javascript
// Add after parseConfigDirArg() function (line ~69)
function parseProjectDirArg() {
  const projectDirIndex = args.findIndex(arg => arg === '--project-dir');
  if (projectDirIndex !== -1) {
    const nextArg = args[projectDirIndex + 1];
    if (!nextArg || nextArg.startsWith('-')) {
      console.error(`  ${yellow}--project-dir requires a path argument${reset}`);
      process.exit(1);
    }
    return nextArg;
  }
  // Handle --project-dir=value format
  const projectDirArg = args.find(arg => arg.startsWith('--project-dir='));
  if (projectDirArg) {
    return projectDirArg.split('=')[1];
  }
  return null;
}
const explicitProjectDir = parseProjectDirArg();
```

**Acceptance:**
- Function parses both `--project-dir /path` and `--project-dir=/path`
- Returns null if flag not provided
- Exits with error if flag provided without value

### Task 2: Update installCopilot() Function
**File:** `bin/install.js`  
**Lines:** 803-920 (installCopilot function)

**Changes:**
1. Add projectDir parameter: `function installCopilot(projectDir = process.cwd())`
2. Replace line 805: Remove `const projectDir = process.cwd();`
3. All existing `projectDir` references already use the variable, so no other changes needed

**Acceptance:**
- Function accepts optional projectDir parameter
- Defaults to process.cwd() if not provided (backward compatibility)
- All paths constructed using the parameter

### Task 3: Update installCodex() Function
**File:** `bin/install.js`  
**Lines:** ~1040-1140 (installCodex function)

**Similar changes:**
1. Add projectDir parameter with default
2. Remove any `process.cwd()` hardcoding
3. Pass projectDir through to path constructions

**Note:** installCodex uses codexAdapter which may need separate handling

**Acceptance:**
- Same as Task 2
- Verify codexAdapter respects projectDir

### Task 4: Update Function Call Sites
**File:** `bin/install.js`

**Find and update all calls:**
```javascript
// OLD
installCopilot();

// NEW
installCopilot(explicitProjectDir || process.cwd());
```

**Locations to check:**
- Direct installCopilot() calls
- installAll() function (lines ~1155-1277)
- Any other entry points

**Acceptance:**
- explicitProjectDir is passed when provided
- process.cwd() used as fallback
- All installation paths respect the parameter

### Task 5: Update Help Text
**File:** `bin/install.js`  
**Lines:** 76-105 (help text)

**Add:**
```
    ${cyan}--project-dir <path>${reset}    Install to specific project directory (for Copilot/Codex)
```

**Placement:** After --config-dir documentation

**Acceptance:**
- Help text documents the new flag
- Clearly states it affects Copilot/Codex (not Claude global)

### Task 6: Integration Test
**Action:** Test in /tmp directory

**Commands:**
```bash
# Clean test
rm -rf /tmp/gsd-test-install
mkdir -p /tmp/gsd-test-install
cd /tmp/gsd-test-install && git init

# Run install from workspace
cd /workspace
node bin/install.js --copilot --project-dir /tmp/gsd-test-install

# Verify
ls -la /tmp/gsd-test-install/.github/copilot/skills/
cat /tmp/gsd-test-install/.github/copilot/skills/gsd-help/SKILL.md | head -30
```

**Acceptance criteria:**
- ✅ Skills directory created: `/tmp/gsd-test-install/.github/copilot/skills/`
- ✅ 4 skill folders generated: gsd-help, gsd-execute-phase, gsd-new-project, gsd-new-milestone
- ✅ Each skill has SKILL.md file
- ✅ SKILL.md content is valid (frontmatter + body)
- ✅ NO files created in /workspace/.github/ during test
- ✅ Agents also installed to /tmp/gsd-test-install/.github/copilot/agents/

## Success Criteria

1. ✅ --project-dir flag parsed from CLI args
2. ✅ installCopilot() accepts and uses projectDir parameter
3. ✅ installCodex() accepts and uses projectDir parameter
4. ✅ Help text documents the flag
5. ✅ Integration test passes: skills installed to /tmp/gsd-test-install
6. ✅ Backward compatibility: works without flag (uses cwd)
7. ✅ No modifications to /workspace when testing in /tmp

## Risks

**Low risk:**
- Simple parameter passing change
- Existing code already uses projectDir variable
- Backward compatible (defaults to process.cwd())

**Potential issues:**
- codexAdapter may have hardcoded paths
- Issue templates installation may need similar fix
- Relative path handling if user provides relative --project-dir

**Mitigations:**
- Test both absolute and relative paths
- Verify all installation functions respect projectDir
- Check issueTemplates function (line 462)

## Dependencies

**Blocks:** Checkpoint 03-04 completion  
**Blocked by:** None (can execute immediately)

## Notes

- This is a gap closure for checkpoint 03-04
- User expectation: Test installations in /tmp, not modify repo
- After fix: Can complete proper E2E testing of checkpoint 03-04
- Similar to Phase 2 gap closure pattern (02-05-PLAN.md)

## Execution Strategy

**Auto-execute:** Yes (autonomous: true)  
**Estimated time:** 15 minutes  
**Parallel:** No (must complete before continuing checkpoint)

**Steps:**
1. Make code changes (Tasks 1-5)
2. Run integration test (Task 6)
3. Verify no workspace pollution
4. Document results in 03-05-SUMMARY.md
5. Resume checkpoint 03-04 verification
