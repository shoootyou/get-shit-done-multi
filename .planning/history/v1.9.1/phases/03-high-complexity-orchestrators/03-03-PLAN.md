---
phase: 03-high-complexity-orchestrators
plan: 03
type: execute
wave: 2
depends_on: ["03-02"]
files_modified:
  - specs/skills/gsd-new-project/SKILL.md
  - specs/skills/gsd-new-milestone/SKILL.md
  - specs/skills/gsd-new-project/_examples/ (optional)
  - specs/skills/gsd-new-milestone/_examples/ (optional)
autonomous: true
must_haves:
  goal: "Migrate new-project and new-milestone orchestrators preserving parallel research spawning"
  truths:
    - Files specs/skills/gsd-new-project/SKILL.md and gsd-new-milestone/SKILL.md exist
    - Parallel research spawning preserved (4 agents in single message)
    - Rich context injection patterns maintained (<research_type>, <milestone_context>)
    - Structured return parsing logic intact (## ROADMAP CREATED, ## ROADMAP BLOCKED)
    - All @-references preserved (4 per command: templates, references)
    - Multi-section XML structure maintained across both commands
    - Generated commands install to .claude/ successfully
  artifacts:
    - specs/skills/gsd-new-project/SKILL.md
    - specs/skills/gsd-new-milestone/SKILL.md
    - .claude/gsd-new-project.md (generated)
    - .claude/gsd-new-milestone.md (generated)
  wiring:
    - Both specs declare Task tool for parallel spawning
    - Both reference same templates (reusable patterns)
    - new-milestone references new-project patterns
  key_links:
    - SKILL.md → install.js::generateSkillsFromSpecs → .claude/*.md
---

# Phase 3 Plan 03: Migrate new-project & new-milestone Orchestrators

**Objective:** Migrate the two project creation orchestrators to spec format, preserving parallel research spawning, rich context injection, and structured return handling

## Context

These are the most complex orchestrators in the codebase:
- **new-project**: 892 lines, 14 subagent spawns, 4 @-references
- **new-milestone**: 718 lines, 9 subagent spawns, 4 @-references

Both follow the same pattern: spawn 4 researchers in parallel → synthesize → create roadmap → handle approval/revision flow.

**From Research (03-RESEARCH.md):**
- Pattern: Parallel research (4 gsd-project-researcher) → synthesizer → roadmapper
- Critical: Preserve parallel spawning (5x faster than sequential)
- Structure: Rich context injection with XML sections
- @-references: Templates (PROJECT.md, REQUIREMENTS.md), references (questioning.md, ui-brand.md)

**From Dependency Audit (03-01):**
- Risk: HIGH (most complex, creates foundational artifacts)
- Creates: PROJECT.md, REQUIREMENTS.md, ROADMAP.md, STATE.md, research/*.md
- Consumed by: plan-phase, execute-phase, progress, verify-phase
- Wave 2: Depends on 03-02 proving migration pattern works

**Why parallelize these two:** They share 80% structure but differ in milestone_context (greenfield vs subsequent). Migrating together ensures pattern consistency.

## Tasks

<task name="migrate-new-project-spec" type="auto">
  <files>specs/skills/gsd-new-project/SKILL.md</files>
  <action>
Create gsd-new-project spec following execute-phase pattern from 03-02.

**1. Create folder and frontmatter:**
```bash
mkdir -p specs/skills/gsd-new-project

cat > specs/skills/gsd-new-project/SKILL.md << 'EOF'
---
name: gsd-new-project
description: Orchestrate project initialization with parallel research and roadmap creation
skill_version: 1.9.1
requires_version: 1.9.0+
platforms:
  - claude
  - copilot
  - codex
tools:
  - name: task
    required: true
    reason: Spawn researchers, synthesizer, and roadmapper agents in parallel
  - name: read
    required: true
    reason: Load templates and validate planning directory
  - name: write
    required: true
    reason: Create .planning/ structure and configuration
  - name: bash
    required: true
    reason: Git operations, directory creation, file validation
  - name: AskUserQuestion
    required: true
    reason: Collect project details, approval gates, revision requests
arguments:
  - name: domain
    type: string
    required: false
    description: Project domain for research context
metadata:
  generated: {{generated}}
  platform: {{platform}}
  version: {{version}}
---

[Body migrated from commands/gsd/new-project.md]
EOF
```

**2. Migrate body from legacy:**

Preserve these sections exactly:
- `<role>` - "Primary orchestrator for project initialization"
- `<objective>` - Project initialization flow
- `<execution_context>` - @-references to templates/references:
  ```xml
  <execution_context>
  @~/.claude/get-shit-done/references/questioning.md
  @~/.claude/get-shit-done/references/ui-brand.md
  @~/.claude/get-shit-done/templates/project.md
  @~/.claude/get-shit-done/templates/requirements.md
  </execution_context>
  ```
- `<process>` - Step-by-step orchestration flow:
  1. Gather project info
  2. Create .planning/ structure
  3. Spawn 4 researchers in parallel
  4. Spawn synthesizer
  5. Spawn roadmapper
  6. Handle structured returns (approval/revision)
- `<parallel_research>` - 4 Task() calls in one message:
  ```javascript
  Task(prompt="<research_type>Stack...</research_type>", subagent_type="gsd-project-researcher")
  Task(prompt="<research_type>Features...</research_type>", subagent_type="gsd-project-researcher")
  Task(prompt="<research_type>Architecture...</research_type>", subagent_type="gsd-project-researcher")
  Task(prompt="<research_type>Pitfalls...</research_type>", subagent_type="gsd-project-researcher")
  ```
- `<structured_returns>` - Parsing ## ROADMAP CREATED vs ## ROADMAP BLOCKED
- `<output>` - Created artifacts and commit message
- `<success_criteria>` - What must be true when complete

**Critical from research:**
- ❌ Don't convert parallel spawns to sequential
- ❌ Don't inline @-references
- ✅ Preserve XML nesting exactly
- ✅ Keep rich context injection patterns

**3. Copy body:**
```bash
# Extract body from legacy (after frontmatter)
sed -n '/^---$/,/^---$/!p' commands/gsd/new-project.md | tail -n +2 >> specs/skills/gsd-new-project/SKILL.md
```
  </action>
  <verify>
```bash
# Verify spec exists
test -f specs/skills/gsd-new-project/SKILL.md

# Verify frontmatter
grep -q "name: gsd-new-project" specs/skills/gsd-new-project/SKILL.md
grep -q "task" specs/skills/gsd-new-project/SKILL.md

# Verify body sections
grep -q "<objective>" specs/skills/gsd-new-project/SKILL.md
grep -q "<execution_context>" specs/skills/gsd-new-project/SKILL.md
grep -q "<parallel_research>" specs/skills/gsd-new-project/SKILL.md

# Verify @-references preserved
grep -q "@~/.claude/get-shit-done/references/questioning.md" specs/skills/gsd-new-project/SKILL.md
grep -c "@" specs/skills/gsd-new-project/SKILL.md
# Should be ~4

# Verify parallel spawning preserved
grep -c "Task(prompt=" specs/skills/gsd-new-project/SKILL.md
# Should be 6+ (4 researchers + synthesizer + roadmapper)

# Check file size (should be ~900+ lines)
wc -l specs/skills/gsd-new-project/SKILL.md
```
  </verify>
  <done>
- gsd-new-project spec created with complete frontmatter
- Body migrated preserving all sections
- Parallel research spawning intact (4 Task calls)
- All @-references preserved (questioning.md, ui-brand.md, templates)
- Structured return parsing maintained
- File is ~950+ lines (frontmatter + body)
  </done>
</task>

<task name="migrate-new-milestone-spec" type="auto">
  <files>specs/skills/gsd-new-milestone/SKILL.md</files>
  <action>
Create gsd-new-milestone spec, similar to new-project but with milestone_context differences.

**1. Create folder and frontmatter:**
```bash
mkdir -p specs/skills/gsd-new-milestone

cat > specs/skills/gsd-new-milestone/SKILL.md << 'EOF'
---
name: gsd-new-milestone
description: Orchestrate milestone planning with parallel research for subsequent project phases
skill_version: 1.9.1
requires_version: 1.9.0+
platforms:
  - claude
  - copilot
  - codex
tools:
  - name: task
    required: true
    reason: Spawn researchers, synthesizer, and roadmapper agents in parallel
  - name: read
    required: true
    reason: Load existing project context and validate milestones/
  - name: write
    required: true
    reason: Create milestone directory and update project state
  - name: bash
    required: true
    reason: Git operations, directory validation, milestone numbering
  - name: AskUserQuestion
    required: true
    reason: Collect milestone details, approval gates, revision requests
arguments:
  - name: milestone
    type: string
    required: false
    description: Milestone number or description
metadata:
  generated: {{generated}}
  platform: {{platform}}
  version: {{version}}
---

[Body migrated from commands/gsd/new-milestone.md]
EOF
```

**2. Migrate body from legacy:**

Structure mirrors new-project but with key differences:
- Reads existing PROJECT.md (doesn't create)
- Creates milestones/XX-name/ (not .planning/)
- milestone_context set to "subsequent" (not "greenfield")
- Validates milestone number sequencing

Preserve sections:
- `<role>` - "Orchestrator for subsequent milestone planning"
- `<objective>` - Milestone initialization flow
- `<execution_context>` - Same @-references as new-project
- `<process>` - Similar to new-project but:
  1. Validate existing project
  2. Determine milestone number
  3. Create milestone directory
  4. Spawn 4 researchers (with milestone_context: subsequent)
  5. Spawn synthesizer
  6. Spawn roadmapper
  7. Handle approval/revision
- `<parallel_research>` - Same 4 Task() pattern with different context
- `<structured_returns>` - Same parsing logic
- `<differences_from_new_project>` - Document variations
- `<output>` - Milestone artifacts
- `<success_criteria>` - Milestone-specific truths

**3. Copy body:**
```bash
sed -n '/^---$/,/^---$/!p' commands/gsd/new-milestone.md | tail -n +2 >> specs/skills/gsd-new-milestone/SKILL.md
```
  </action>
  <verify>
```bash
# Verify spec exists
test -f specs/skills/gsd-new-milestone/SKILL.md

# Verify frontmatter
grep -q "name: gsd-new-milestone" specs/skills/gsd-new-milestone/SKILL.md
grep -q "task" specs/skills/gsd-new-milestone/SKILL.md

# Verify body sections
grep -q "<objective>" specs/skills/gsd-new-milestone/SKILL.md
grep -q "<execution_context>" specs/skills/gsd-new-milestone/SKILL.md
grep -q "<parallel_research>" specs/skills/gsd-new-milestone/SKILL.md

# Verify @-references preserved
grep -c "@" specs/skills/gsd-new-milestone/SKILL.md
# Should be ~4

# Verify parallel spawning preserved
grep -c "Task(prompt=" specs/skills/gsd-new-milestone/SKILL.md
# Should be 6+ (4 researchers + synthesizer + roadmapper)

# Check file size (should be ~750+ lines)
wc -l specs/skills/gsd-new-milestone/SKILL.md
```
  </verify>
  <done>
- gsd-new-milestone spec created with complete frontmatter
- Body migrated preserving all sections
- Parallel research spawning intact
- milestone_context differences preserved
- All @-references preserved
- File is ~780+ lines (frontmatter + body)
  </done>
</task>

<task name="test-both-orchestrators-generation" type="auto">
  <files>.claude/gsd-new-project.md, .claude/gsd-new-milestone.md</files>
  <action>
Generate and validate both orchestrator specs using template system.

**1. Generate both skills:**
```bash
node bin/install.js --platform claude --install skills

# Or test generation directly
node -e "
const { generateSkillsFromSpecs } = require('./bin/install.js');
const result = generateSkillsFromSpecs(
  './specs/skills',
  './.claude',
  'claude'
);
console.log('Generated:', result.generated);
console.log('Failed:', result.failed);

// Check both were generated
const fs = require('fs');
const npExists = fs.existsSync('./.claude/gsd-new-project.md');
const nmExists = fs.existsSync('./.claude/gsd-new-milestone.md');

console.log('new-project generated:', npExists);
console.log('new-milestone generated:', nmExists);

if (!npExists || !nmExists) {
  console.error('Missing outputs');
  process.exit(1);
}
"
```

**2. Validate new-project output:**
```bash
test -f .claude/gsd-new-project.md

# Verify metadata
grep -q "generated:" .claude/gsd-new-project.md
grep -q "platform: claude" .claude/gsd-new-project.md

# Verify parallel spawning pattern
grep -c "Task(prompt=" .claude/gsd-new-project.md
# Should be 6+

# Verify @-references
grep -q "@~/.claude/get-shit-done/references/questioning.md" .claude/gsd-new-project.md

# Check structured return handling
grep -q "## ROADMAP CREATED" .claude/gsd-new-project.md
grep -q "## ROADMAP BLOCKED" .claude/gsd-new-project.md
```

**3. Validate new-milestone output:**
```bash
test -f .claude/gsd-new-milestone.md

# Verify metadata
grep -q "generated:" .claude/gsd-new-milestone.md

# Verify parallel spawning pattern
grep -c "Task(prompt=" .claude/gsd-new-milestone.md

# Verify milestone-specific context
grep -q "milestone_context: subsequent" .claude/gsd-new-milestone.md || 
grep -q "subsequent" .claude/gsd-new-milestone.md
```

**4. Structural comparison:**
```bash
# Count sections in both
echo "new-project sections:"
grep -c "<.*>" .claude/gsd-new-project.md

echo "new-milestone sections:"
grep -c "<.*>" .claude/gsd-new-milestone.md

# Should be similar counts (within 2-3)
```
  </action>
  <verify>
```bash
# Both files exist
test -f .claude/gsd-new-project.md
test -f .claude/gsd-new-milestone.md

# Both have parallel spawning
grep -q "Task(prompt=" .claude/gsd-new-project.md
grep -q "Task(prompt=" .claude/gsd-new-milestone.md

# Both have @-references
grep -q "@" .claude/gsd-new-project.md
grep -q "@" .claude/gsd-new-milestone.md

# Both have structured returns
grep -q "## ROADMAP" .claude/gsd-new-project.md
grep -q "## ROADMAP" .claude/gsd-new-milestone.md

echo "✅ Both orchestrators generated successfully"
```
  </verify>
  <done>
- Generated files exist for both commands
- Metadata fields auto-generated correctly
- Parallel spawning patterns preserved in both
- @-references intact in outputs
- Structured return logic present
- Ready for E2E testing in 03-04
  </done>
</task>

## Verification

```bash
# Complete migration validation for both
test -f specs/skills/gsd-new-project/SKILL.md
test -f specs/skills/gsd-new-milestone/SKILL.md
test -f .claude/gsd-new-project.md
test -f .claude/gsd-new-milestone.md

# Parallel spawning preserved
for file in .claude/gsd-new-project.md .claude/gsd-new-milestone.md; do
  count=$(grep -c "Task(prompt=" "$file")
  echo "$file: $count Task spawns"
  [ $count -ge 6 ] || { echo "❌ Too few spawns"; exit 1; }
done

# @-references intact
for file in .claude/gsd-new-project.md .claude/gsd-new-milestone.md; do
  count=$(grep -c "@" "$file")
  echo "$file: $count @-references"
  [ $count -ge 4 ] || { echo "❌ Missing references"; exit 1; }
done

echo "✅ Both orchestrators migrated successfully"
```

## Success Criteria

- [x] specs/skills/gsd-new-project/SKILL.md exists (~950 lines)
- [x] specs/skills/gsd-new-milestone/SKILL.md exists (~780 lines)
- [x] Both frontmatter sections declare Task, Read, Write, Bash, AskUserQuestion
- [x] Parallel research spawning preserved (4 researchers per command)
- [x] All @-references preserved (4 per command)
- [x] Multi-section XML structure maintained
- [x] Structured return parsing logic intact
- [x] Generated outputs in .claude/ for both commands
- [x] Template system generates without errors

## Output

**Created:**
- `specs/skills/gsd-new-project/SKILL.md` - Complete orchestrator spec (~950 lines)
- `specs/skills/gsd-new-milestone/SKILL.md` - Complete orchestrator spec (~780 lines)
- `.claude/gsd-new-project.md` - Generated command (auto from spec)
- `.claude/gsd-new-milestone.md` - Generated command (auto from spec)

**Technical notes:**
- Most complex orchestrators (HIGH risk) migrated successfully
- Parallel spawning pattern proven across both commands
- Pattern consistency validates migration approach
- No template system changes needed (reuses existing generateAgent)
- Dependency graph from 03-01 validated: no conflicts with execute-phase
