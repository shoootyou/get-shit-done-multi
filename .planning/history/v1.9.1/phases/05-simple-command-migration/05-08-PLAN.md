---
phase: 05-simple-command-migration
plan: 08
type: execute
wave: 4
depends_on: [05-01, 05-02, 05-03, 05-04, 05-05, 05-06, 05-07]
files_modified:
  - specs/skills/gsd-progress/SKILL.md
  - .claude/skills/gsd-progress.md (generated)
autonomous: true
must_haves:
  goal: "Migrate progress routing hub that routes to 11 different commands based on project state"
  truths:
    - Spec folder exists with complex routing logic
    - Progress command counts files accurately (plans, summaries, UAT files)
    - Progress routes to 11 different commands based on state
    - All route conditions work correctly (9 different routing paths)
    - File counting logic preserved (bash commands for ls/wc)
    - Progress displays rich status report before routing
    - Command generates and installs successfully
  artifacts:
    - specs/skills/gsd-progress/SKILL.md
  wiring:
    - Progress reads STATE.md, ROADMAP.md, PROJECT.md for context
    - Progress counts files in phase directories for routing decisions
    - Progress uses task tool to route to appropriate command
    - Progress displays progress bar and recent work summary
  key_links:
    - File counts → routing logic → task() call → appropriate command
    - All 11 routed commands must exist before progress can work
---

# Phase 5 Plan 08: Batch 8 - Progress Routing Hub

**Objective:** Migrate progress command that routes to 11 different commands based on project state - MUST MIGRATE LAST

## Context

**From Research (05-RESEARCH.md):**
- **gsd-progress**: 356 lines, routes to 11 different commands
- **Complexity**: VERY HIGH (complex conditional logic, file counting, routing)
- **Critical dependency**: ALL 11 routed commands must exist before migration
- **Pattern**: Central orchestration hub for GSD workflow

**Command:**
- **gsd-progress** (356 lines) - Check progress, route to next action

**Routes to these commands:**
1. `/gsd:new-project` (no .planning/) ✓ Phase 3
2. `/gsd:execute-phase` (unexecuted plans) ✓ Phase 3
3. `/gsd:plan-phase` (needs planning) ✓ Phase 4
4. `/gsd:plan-phase --gaps` (UAT gaps) ✓ Phase 4
5. `/gsd:research-phase` (alternative) ✓ Phase 4
6. `/gsd:discuss-phase` (no CONTEXT) ✓ Phase 5 Plan 05
7. `/gsd:list-phase-assumptions` (alternative) ✓ Phase 5 Plan 01
8. `/gsd:verify-work` (user testing) ✓ Phase 5 Plan 05
9. `/gsd:complete-milestone` (milestone done) ✓ Phase 5 Plan 06
10. `/gsd:new-milestone` (between milestones) ✓ Phase 3
11. `/gsd:check-todos` (pending todos) ✓ Phase 5 Plan 04
12. `/gsd:debug` (debug sessions) ✓ Phase 4

**Why Wave 4 (MUST GO LAST):**
- Depends on ALL prior Phase 5 plans (routes to commands from 05-01 through 05-07)
- Depends on Phase 3-4 commands (orchestrators, planning commands)
- If migrated early, routing will fail with "command not found" errors
- This is the FINAL Phase 5 command to migrate

## Tasks

<task name="verify-all-routed-commands-exist" type="auto">
  <files>None (verification only)</files>
  <action>
Verify all 11 commands routed by progress exist in specs/skills/ before migration.

```bash
echo "=== Verifying Progress Route Dependencies ==="
echo ""

MISSING=0

# Check each routed command exists
COMMANDS=(
  "gsd-new-project"
  "gsd-execute-phase"
  "gsd-plan-phase"
  "gsd-research-phase"
  "gsd-discuss-phase"
  "gsd-list-phase-assumptions"
  "gsd-verify-work"
  "gsd-complete-milestone"
  "gsd-new-milestone"
  "gsd-check-todos"
  "gsd-debug"
)

for cmd in "${COMMANDS[@]}"; do
  if [ -f "specs/skills/${cmd}/SKILL.md" ]; then
    echo "✓ ${cmd}"
  else
    echo "✗ ${cmd} (MISSING)"
    MISSING=$((MISSING + 1))
  fi
done

echo ""
if [ $MISSING -eq 0 ]; then
  echo "✓ All 11 routed commands exist"
  echo "✓ Safe to migrate progress command"
else
  echo "✗ ${MISSING} commands missing"
  echo "✗ CANNOT migrate progress - dependencies not met"
  exit 1
fi
```

If any commands missing: STOP and report which commands need migration first.
  </action>
  <verify>All 11 commands exist in specs/skills/</verify>
  <done>Pre-migration verification passed - all dependencies exist</done>
</task>

<task name="migrate-progress-command" type="auto">
  <files>specs/skills/gsd-progress/SKILL.md</files>
  <action>
Create gsd-progress spec from legacy commands/gsd/progress.md (356 lines).

Frontmatter:
```yaml
name: gsd-progress
description: Check project progress, summarize recent work, intelligently route to next action
skill_version: 1.9.1
requires_version: 1.9.0+
platforms: [claude, copilot, codex]
tools:
  - name: read
  - name: bash
  - name: task
arguments: []
```

Body structure:
```xml
<objective>
Check project progress, summarize recent work and what's ahead, then 
intelligently route to the next action - either executing an existing 
plan or creating the next one.

Purpose: One-command workflow - user runs /gsd:progress and GSD figures 
out what to do next.
</objective>

<process>
<step name="verify_structure">
Verify planning structure exists:

```bash
if [ ! -d ".planning" ]; then
  echo "No .planning/ directory found"
  echo ""
  echo "Start new project: /gsd:new-project"
  exit 0
fi

if [ ! -f ".planning/STATE.md" ] || [ ! -f ".planning/ROADMAP.md" ]; then
  echo "Planning structure incomplete"
  echo "Missing: STATE.md or ROADMAP.md"
  echo ""
  echo "Reinitialize: /gsd:new-milestone"
  exit 0
fi
```
</step>

<step name="load_context">
Load full project context:

```bash
# Load state
STATE_CONTENT=$(cat .planning/STATE.md)

# Load roadmap
ROADMAP_CONTENT=$(cat .planning/ROADMAP.md)

# Load project
PROJECT_CONTENT=$(cat .planning/PROJECT.md 2>/dev/null || echo "")

# Parse current position from STATE.md
CURRENT_PHASE=$(echo "$STATE_CONTENT" | grep "^Phase:" | head -1 | sed 's/Phase: \([0-9.]*\).*/\1/')
CURRENT_PLAN=$(echo "$STATE_CONTENT" | grep "^Plan:" | head -1 | sed 's/Plan: \([0-9]*\).*/\1/')
STATUS=$(echo "$STATE_CONTENT" | grep "^Status:" | head -1 | sed 's/Status: //')
```
</step>

<step name="gather_recent_work">
Gather recent work context (2-3 most recent SUMMARYs):

```bash
# Find all SUMMARY files, sorted by modification time
RECENT_SUMMARIES=$(find .planning/phases -name "*-SUMMARY.md" -type f -printf '%T@ %p\n' | sort -rn | head -3 | cut -d' ' -f2-)

# Extract phase and plan numbers from filenames
RECENT_WORK=""
for summary in $RECENT_SUMMARIES; do
  PHASE_PLAN=$(basename "$summary" | sed 's/-SUMMARY.md//')
  TITLE=$(grep "^# " "$summary" | head -1 | sed 's/^# //')
  RECENT_WORK="${RECENT_WORK}\n- ${PHASE_PLAN}: ${TITLE}"
done
```
</step>

<step name="count_files">
Count files for routing decisions:

```bash
# Find current phase directory (handles both padded and unpadded)
PADDED_PHASE=$(printf "%02d" $CURRENT_PHASE 2>/dev/null || echo "$CURRENT_PHASE")
PHASE_DIR=$(ls -d .planning/phases/${PADDED_PHASE}-* .planning/phases/${CURRENT_PHASE}-* 2>/dev/null | head -1)

if [ -n "$PHASE_DIR" ]; then
  # Count plans in current phase
  PLAN_COUNT=$(ls -1 "${PHASE_DIR}"/*-PLAN.md 2>/dev/null | wc -l)
  
  # Count summaries in current phase
  SUMMARY_COUNT=$(ls -1 "${PHASE_DIR}"/*-SUMMARY.md 2>/dev/null | wc -l)
  
  # Count UAT files with gaps
  UAT_WITH_GAPS=$(grep -l "status: diagnosed" "${PHASE_DIR}"/*-UAT.md 2>/dev/null | wc -l)
  
  # Check for CONTEXT.md
  HAS_CONTEXT=$(ls "${PHASE_DIR}"/*-CONTEXT.md 2>/dev/null | wc -l)
else
  PLAN_COUNT=0
  SUMMARY_COUNT=0
  UAT_WITH_GAPS=0
  HAS_CONTEXT=0
fi

# Count pending todos
TODO_COUNT=$(ls -1 .planning/todos/pending/*.md 2>/dev/null | wc -l)

# Count active debug sessions
DEBUG_COUNT=$(ls -1 .planning/debug/*-DEBUG.md 2>/dev/null | grep -v "ARCHIVED" | wc -l)

# Find highest phase in roadmap
HIGHEST_PHASE=$(grep "^- Phase [0-9]" .planning/ROADMAP.md | sed 's/^- Phase \([0-9.]*\):.*/\1/' | sort -n | tail -1)
```
</step>

<step name="present_status_report">
Present rich status report:

```
## PROJECT PROGRESS

**Project:** ${PROJECT_NAME}
**Phase:** ${CURRENT_PHASE} of ${HIGHEST_PHASE}
**Status:** ${STATUS}

### Progress
[████████░░] ${COMPLETION}%

### Recent Work
${RECENT_WORK}

### Current Position
- Phase ${CURRENT_PHASE}: ${PHASE_NAME}
- Plans: ${SUMMARY_COUNT}/${PLAN_COUNT} complete
${UAT_WITH_GAPS > 0 ? "- ⚠ UAT gaps found: ${UAT_WITH_GAPS}" : ""}
${TODO_COUNT > 0 ? "- Pending todos: ${TODO_COUNT}" : ""}
${DEBUG_COUNT > 0 ? "- Active debug sessions: ${DEBUG_COUNT}" : ""}

---
```
</step>

<step name="route_to_next_action">
Route based on verified counts and state:

```javascript
// Routing decision tree (in priority order)

// Priority 1: UAT gaps need fixing
if (UAT_WITH_GAPS > 0) {
  task({
    agent_type: "gsd-plan-phase",
    description: "Plan UAT gap closure",
    prompt: `/gsd:plan-phase ${CURRENT_PHASE} --gaps`
  });
  return;
}

// Priority 2: Unexecuted plans exist
if (SUMMARY_COUNT < PLAN_COUNT) {
  const nextPlan = SUMMARY_COUNT + 1;
  task({
    agent_type: "gsd-execute-phase",
    description: "Execute next plan",
    prompt: `/gsd:execute-phase ${CURRENT_PHASE}`
  });
  return;
}

// Priority 3: Phase complete, check milestone
if (SUMMARY_COUNT === PLAN_COUNT && PLAN_COUNT > 0) {
  // Phase complete - is milestone done?
  if (CURRENT_PHASE == HIGHEST_PHASE) {
    // Last phase - milestone complete
    task({
      agent_type: "gsd-complete-milestone",
      description: "Complete milestone",
      prompt: `/gsd:complete-milestone`
    });
    return;
  } else {
    // More phases exist - move to next
    const nextPhase = CURRENT_PHASE + 1;
    // Recursively call progress for next phase
    task({
      agent_type: "gsd-progress",
      description: "Check next phase progress",
      prompt: `/gsd:progress`
    });
    return;
  }
}

// Priority 4: Phase needs planning
if (PLAN_COUNT === 0) {
  // No plans exist - need planning
  if (HAS_CONTEXT > 0) {
    // Has context - ready to plan
    task({
      agent_type: "gsd-plan-phase",
      description: "Plan phase",
      prompt: `/gsd:plan-phase ${CURRENT_PHASE}`
    });
    return;
  } else {
    // No context - need discussion
    task({
      agent_type: "gsd-discuss-phase",
      description: "Discuss phase approach",
      prompt: `/gsd:discuss-phase ${CURRENT_PHASE}`
    });
    return;
  }
}

// Priority 5: Pending todos
if (TODO_COUNT > 0) {
  task({
    agent_type: "gsd-check-todos",
    description: "Check pending todos",
    prompt: `/gsd:check-todos`
  });
  return;
}

// Priority 6: Active debug sessions
if (DEBUG_COUNT > 0) {
  task({
    agent_type: "gsd-debug",
    description: "Resume debug session",
    prompt: `/gsd:debug`
  });
  return;
}

// Fallback: No clear action (milestone done, no roadmap)
echo "No clear next action. Milestone may be complete."
echo "- Complete current milestone: /gsd:complete-milestone"
echo "- Start new milestone: /gsd:new-milestone"
echo "- Verify work: /gsd:verify-work ${CURRENT_PHASE}"
```
</step>

<step name="handle_routing_errors">
If routing fails (command not found):

```
ERROR: Command not found during routing.

This usually means:
1. Command hasn't been migrated yet (check specs/skills/)
2. Skills not generated (run: npm run install:local)
3. Platform doesn't support command yet

Fallback options:
- Execute plan manually: /gsd:execute-phase ${CURRENT_PHASE}
- Plan next phase: /gsd:plan-phase ${NEXT_PHASE}
- Check todos: /gsd:check-todos
```
</step>
</process>
```

**Critical elements:**
- File counting logic (plans, summaries, UAT, todos, debug)
- Complex routing decision tree (9 conditions, priority-ordered)
- Task tool routing to appropriate commands
- Error handling for missing commands
- Status report with progress bar
- Recent work summary (last 2-3 SUMMARYs)
- Handles both integer and decimal phases
- Recursive progress call for next phase
  </action>
  <verify>
Test spec creation and routing logic:
```bash
# Create spec
cat specs/skills/gsd-progress/SKILL.md

# Check routing logic exists
cat specs/skills/gsd-progress/SKILL.md | grep -A 5 "route_to_next_action"

# Count task() calls (should be ~11 routes)
grep -c "agent_type.*gsd-" specs/skills/gsd-progress/SKILL.md
```
  </verify>
  <done>gsd-progress spec exists with all 11 routing paths</done>
</task>

<task name="generate-and-test-progress-skill" type="auto">
  <files>None (testing only)</files>
  <action>
Generate gsd-progress skill and verify routing structure.

```bash
# Generate skill
npm run install:local

# Verify generated
echo "=== Generated Skill ==="
ls -la .claude/skills/gsd-progress.md

# Check line count (should be ~356)
wc -l .claude/skills/gsd-progress.md

# Verify all 11 routing targets exist in generated file
echo "=== Routing Targets ==="
ROUTES=(
  "gsd-new-project"
  "gsd-execute-phase"
  "gsd-plan-phase"
  "gsd-research-phase"
  "gsd-discuss-phase"
  "gsd-list-phase-assumptions"
  "gsd-verify-work"
  "gsd-complete-milestone"
  "gsd-new-milestone"
  "gsd-check-todos"
  "gsd-debug"
)

MISSING_ROUTES=0
for route in "${ROUTES[@]}"; do
  if grep -q "$route" .claude/skills/gsd-progress.md; then
    echo "✓ Routes to ${route}"
  else
    echo "✗ Missing route to ${route}"
    MISSING_ROUTES=$((MISSING_ROUTES + 1))
  fi
done

if [ $MISSING_ROUTES -eq 0 ]; then
  echo ""
  echo "✓ All 11 routing targets present"
else
  echo ""
  echo "✗ ${MISSING_ROUTES} routing targets missing"
  exit 1
fi

# Verify file counting logic
echo ""
echo "=== File Counting Logic ==="
grep -c "PLAN_COUNT" .claude/skills/gsd-progress.md
grep -c "SUMMARY_COUNT" .claude/skills/gsd-progress.md
grep -c "UAT_WITH_GAPS" .claude/skills/gsd-progress.md
grep -c "TODO_COUNT" .claude/skills/gsd-progress.md

# Run syntax check
node -e "
const fs = require('fs');
const content = fs.readFileSync('.claude/skills/gsd-progress.md', 'utf8');
const parts = content.split('---');

if (parts.length >= 3) {
  console.log('✓ gsd-progress: valid frontmatter');
  
  const frontmatter = parts[1];
  const hasTask = frontmatter.includes('task');
  const hasBash = frontmatter.includes('bash');
  
  console.log('  - task tool:', hasTask ? '✓' : '✗');
  console.log('  - bash tool:', hasBash ? '✓' : '✗');
  
  const body = parts.slice(2).join('---');
  const hasRouting = body.includes('route_to_next_action');
  const hasCount = body.includes('count_files');
  
  console.log('  - routing logic:', hasRouting ? '✓' : '✗');
  console.log('  - file counting:', hasCount ? '✓' : '✗');
} else {
  console.error('✗ gsd-progress: invalid structure');
  process.exit(1);
}
"

echo ""
echo "✓ gsd-progress skill generated and validated"
```
  </action>
  <verify>Generated skill has all routing logic and file counting</verify>
  <done>gsd-progress skill generated with all 11 routes validated</done>
</task>

<task name="validate-routing-paths" type="auto">
  <files>None (validation only)</files>
  <action>
Validate all routing paths can execute (smoke test).

```bash
echo "=== Routing Path Validation ==="
echo ""
echo "This validates routing targets exist, not full execution."
echo ""

# Check each routed command is callable
COMMANDS=(
  "gsd-new-project"
  "gsd-execute-phase"
  "gsd-plan-phase"
  "gsd-research-phase"
  "gsd-discuss-phase"
  "gsd-list-phase-assumptions"
  "gsd-verify-work"
  "gsd-complete-milestone"
  "gsd-new-milestone"
  "gsd-check-todos"
  "gsd-debug"
)

MISSING=0
for cmd in "${COMMANDS[@]}"; do
  # Check generated skill exists
  if [ -f ".claude/skills/${cmd}.md" ]; then
    echo "✓ ${cmd}.md (route target exists)"
  else
    echo "✗ ${cmd}.md (MISSING - route will fail)"
    MISSING=$((MISSING + 1))
  fi
done

echo ""
if [ $MISSING -eq 0 ]; then
  echo "✓ All routing paths valid"
  echo "✓ Progress command ready for use"
else
  echo "✗ ${MISSING} routing targets missing"
  echo "✗ Progress command will fail on some routes"
  exit 1
fi

# Test file counting logic doesn't error
echo ""
echo "=== File Counting Test ==="
cd .planning 2>/dev/null || { echo "No .planning/ - expected for fresh install"; exit 0; }

# These should not error even if counts are 0
PLAN_COUNT=$(ls -1 phases/*/  *-PLAN.md 2>/dev/null | wc -l)
SUMMARY_COUNT=$(ls -1 phases/*/*-SUMMARY.md 2>/dev/null | wc -l)
TODO_COUNT=$(ls -1 todos/pending/*.md 2>/dev/null | wc -l)

echo "Plans found: ${PLAN_COUNT}"
echo "Summaries found: ${SUMMARY_COUNT}"
echo "Todos found: ${TODO_COUNT}"
echo ""
echo "✓ File counting logic works (even with 0 files)"
```
  </action>
  <verify>All routing paths valid, file counting works</verify>
  <done>Progress command routing validated - all targets exist</done>
</task>

## Verification

**After execution:**
- [ ] Spec folder exists: specs/skills/gsd-progress/
- [ ] Spec has complete frontmatter with task and bash tools
- [ ] All 11 routing targets present in generated skill
- [ ] File counting logic preserved (plans, summaries, UAT, todos, debug)
- [ ] Routing decision tree intact (9 conditions)
- [ ] Skill generates successfully via npm run install:local
- [ ] Generated file exists in .claude/skills/ with ~356 lines
- [ ] All 11 routed commands exist and are callable
- [ ] Routing validation passes

## Success Criteria

**Observable truths:**
1. progress command loads project context correctly
2. progress command counts files accurately
3. progress command routes to correct next action based on state
4. All 11 routing paths work (no "command not found" errors)
5. progress command displays rich status report
6. progress command handles edge cases (no .planning/, missing files)

**Key deliverable:** Progress routing hub migrated with all 11 routing paths validated - completes Phase 5 command migration.

## Output

Files created:
- `specs/skills/gsd-progress/SKILL.md` - Progress routing hub
- `.claude/skills/gsd-progress.md` - Generated skill (~356 lines)

Ready for: Wave 5 (E2E verification checkpoint - test full Phase 5 command set)

## Critical Notes

**Why this plan MUST be Wave 4:**
1. Progress routes to 11 commands - all must exist first
2. Missing commands cause routing failures
3. This is the LAST Phase 5 command to migrate
4. Verification confirmed all dependencies exist before proceeding
5. All prior Phase 5 plans (01-07) must complete first

**Testing priority:**
Focus E2E verification (Plan 09) on progress routing paths - this is the highest-risk command in Phase 5.
