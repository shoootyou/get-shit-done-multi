---
phase: 05-simple-command-migration
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - specs/skills/gsd-add-phase/SKILL.md
  - specs/skills/gsd-insert-phase/SKILL.md
  - specs/skills/gsd-remove-phase/SKILL.md
  - .claude/skills/gsd-add-phase.md (generated)
  - .claude/skills/gsd-insert-phase.md (generated)
  - .claude/skills/gsd-remove-phase.md (generated)
autonomous: true
must_haves:
  goal: "Migrate ROADMAP manipulation commands preserving decimal phase logic and renumbering"
  truths:
    - Three spec folders exist with roadmap parsing logic intact
    - add-phase appends new integer phase to roadmap correctly
    - insert-phase creates decimal phases (72.1, 72.2) between existing phases
    - remove-phase deletes phases and renumbers subsequent phases
    - Decimal phase sorting works correctly (72, 72.1, 72.2, 73)
    - All git commits execute after roadmap changes
    - Test validation with backups prevents roadmap corruption
  artifacts:
    - specs/skills/gsd-add-phase/SKILL.md
    - specs/skills/gsd-insert-phase/SKILL.md
    - specs/skills/gsd-remove-phase/SKILL.md
  wiring:
    - All three use Read tool to load ROADMAP.md
    - All three use Write/Edit tool to modify ROADMAP.md
    - All three use Bash for git commits
    - Decimal numbering logic preserved exactly from legacy
  key_links:
    - Roadmap parsing logic → milestone section detection → phase number extraction
---

# Phase 5 Plan 03: Batch 3 - Phase Management Commands

**Objective:** Migrate roadmap manipulation commands (add-phase, insert-phase, remove-phase) preserving decimal phase logic and renumbering

## Context

These commands manipulate ROADMAP.md structure directly, requiring careful handling of integer and decimal phases. They're more complex than previous batches due to parsing logic, in-place editing, and git commit requirements.

**From Research (05-RESEARCH.md):**
- **Pattern 3**: Roadmap manipulation with decimal phase support
- **Complexity**: MEDIUM-HIGH (207-338 lines)
- **Risk**: HIGH - Can corrupt roadmap if decimal logic fails
- **Key features**: Integer phases (1, 2, 3), decimal phases (72.1, 72.2), renumbering

**Commands in batch:**
1. **gsd-add-phase** (207 lines) - Append new integer phase to end of milestone
2. **gsd-insert-phase** (227 lines) - Insert decimal phase between existing phases
3. **gsd-remove-phase** (338 lines) - Delete phase and renumber all subsequent phases

**Why Wave 2:**
- Depends on ROADMAP.md structure (established in Phase 1-2)
- No dependencies on other Phase 5 commands
- Can run parallel with Wave 1 batches

**Critical validations:**
- Decimal phase sorting (72 < 72.1 < 72.2 < 73)
- Renumbering logic (removing 17 → 18 becomes 17, 19 becomes 18, etc.)
- Git commits after each roadmap change
- No corruption to roadmap structure

## Tasks

<task name="migrate-add-phase-command" type="auto">
  <files>specs/skills/gsd-add-phase/SKILL.md</files>
  <action>
Create gsd-add-phase spec from legacy commands/gsd/add-phase.md (207 lines).

```bash
mkdir -p specs/skills/gsd-add-phase

cat > specs/skills/gsd-add-phase/SKILL.md << 'SPEC_EOF'
---
name: gsd-add-phase
description: Add new integer phase to end of current milestone in roadmap
skill_version: 1.9.1
requires_version: 1.9.0+
platforms: [claude, copilot, codex]
tools:
  - name: read
    required: true
    reason: Load ROADMAP.md to find current milestone and highest phase
  - name: write
    required: true
    reason: Append new phase entry to ROADMAP.md
  - name: bash
    required: true
    reason: Git commit after roadmap changes, validate structure
arguments:
  - name: description
    type: string
    required: true
    description: Phase description (all args combined become description)
metadata:
  generated: {{generated}}
  platform: {{platform}}
  version: {{version}}
---
SPEC_EOF
```

Append body from legacy commands/gsd/add-phase.md:
- Preserve phase number calculation logic (find highest, add 1)
- Maintain milestone section parsing
- Keep roadmap append logic
- Preserve git commit structure

Critical section from legacy (lines 51-78):
```bash
# Find milestone marker
MILESTONE_START=$(grep -n "^## Milestone:" "$ROADMAP" | tail -1 | cut -d: -f1)

# Extract phases after milestone marker
PHASES=$(sed -n "${MILESTONE_START},\$p" "$ROADMAP" | grep "^- Phase [0-9]")

# Find highest phase number (handles both integer and decimal)
HIGHEST_PHASE=$(echo "$PHASES" | sed 's/^- Phase \([0-9.]*\):.*/\1/' | sort -n | tail -1)

# Calculate next phase (integer only for add-phase)
NEXT_PHASE=$((${HIGHEST_PHASE%.*} + 1))  # Strip decimals, add 1

# Append to roadmap
echo "- Phase ${NEXT_PHASE}: ${DESCRIPTION}" >> "$ROADMAP"
```

Process structure:
<step name="parse_arguments">Parse all arguments as phase description</step>
<step name="load_roadmap">Load ROADMAP.md, validate existence</step>
<step name="find_last_phase">Find highest phase in current milestone</step>
<step name="append_phase">Calculate next integer, append to roadmap</step>
<step name="commit">Git commit with descriptive message</step>

Reference legacy:
```bash
sed -n '/^---$/,/^---$/!p' commands/gsd/add-phase.md >> specs/skills/gsd-add-phase/SKILL.md
```
  </action>
  <verify>
```bash
# Spec created
test -f specs/skills/gsd-add-phase/SKILL.md

# Contains phase calculation logic
grep -q "HIGHEST_PHASE\|sort -n\|NEXT_PHASE" specs/skills/gsd-add-phase/SKILL.md

# Has Write tool for roadmap editing
grep -q "write" specs/skills/gsd-add-phase/SKILL.md

# Generates successfully
npm run install:claude 2>&1 | grep -q "gsd-add-phase"

# Output created
test -f .claude/skills/gsd-add-phase.md
```
  </verify>
  <done>
gsd-add-phase spec exists, phase calculation logic preserved, roadmap append working, generates successfully
  </done>
</task>

<task name="migrate-insert-phase-command" type="auto">
  <files>specs/skills/gsd-insert-phase/SKILL.md</files>
  <action>
Create gsd-insert-phase spec from legacy commands/gsd/insert-phase.md (227 lines).

```bash
mkdir -p specs/skills/gsd-insert-phase

cat > specs/skills/gsd-insert-phase/SKILL.md << 'SPEC_EOF'
---
name: gsd-insert-phase
description: Insert decimal phase between existing phases (urgent work without renumbering)
skill_version: 1.9.1
requires_version: 1.9.0+
platforms: [claude, copilot, codex]
tools:
  - name: read
    required: true
    reason: Load ROADMAP.md to find target phase and existing decimals
  - name: write
    required: true
    reason: Insert new decimal phase entry in ROADMAP.md
  - name: bash
    required: true
    reason: Decimal calculation, git commit after roadmap changes
arguments:
  - name: after_phase
    type: string
    required: true
    description: Phase number to insert after (e.g., "72" inserts as 72.1)
  - name: description
    type: string
    required: true
    description: Phase description for inserted phase
metadata:
  generated: {{generated}}
  platform: {{platform}}
  version: {{version}}
---
SPEC_EOF
```

Append body from legacy commands/gsd/insert-phase.md:
- Preserve decimal numbering logic (72 → 72.1, 72.1 → 72.2)
- Maintain roadmap insertion position calculation
- Keep validation (target phase must exist)
- Preserve git commit structure

Critical decimal logic from legacy:
```bash
# Parse target phase (remove any existing decimal)
BASE_PHASE=${AFTER_PHASE%.*}

# Find existing decimal phases after this base
EXISTING_DECIMALS=$(grep "^- Phase ${BASE_PHASE}\." "$ROADMAP" | sed 's/^- Phase \([0-9.]*\):.*/\1/' | sort -n)

if [ -z "$EXISTING_DECIMALS" ]; then
  # No decimals exist, create .1
  NEW_PHASE="${BASE_PHASE}.1"
else
  # Get highest decimal
  HIGHEST_DECIMAL=$(echo "$EXISTING_DECIMALS" | tail -1)
  # Extract decimal part, increment
  DECIMAL_PART=${HIGHEST_DECIMAL##*.}
  NEXT_DECIMAL=$((DECIMAL_PART + 1))
  NEW_PHASE="${BASE_PHASE}.${NEXT_DECIMAL}"
fi

# Find insertion point (line after target phase)
INSERT_LINE=$(grep -n "^- Phase ${AFTER_PHASE}:" "$ROADMAP" | cut -d: -f1)
INSERT_LINE=$((INSERT_LINE + 1))

# Insert new phase
sed -i "${INSERT_LINE}i- Phase ${NEW_PHASE}: ${DESCRIPTION}" "$ROADMAP"
```

Process structure:
<step name="parse_arguments">Parse after_phase and description</step>
<step name="validate">Check target phase exists in roadmap</step>
<step name="calculate_decimal">Find next decimal number (.1, .2, .3...)</step>
<step name="insert">Insert new phase line in correct position</step>
<step name="commit">Git commit with decimal phase marker</step>

Edge cases to handle:
- First decimal (72 → 72.1)
- Subsequent decimals (72.1 → 72.2, 72.2 → 72.3)
- Double-digit decimals (72.9 → 72.10) - document behavior

Reference legacy:
```bash
sed -n '/^---$/,/^---$/!p' commands/gsd/insert-phase.md >> specs/skills/gsd-insert-phase/SKILL.md
```
  </action>
  <verify>
```bash
# Spec created
test -f specs/skills/gsd-insert-phase/SKILL.md

# Contains decimal logic
grep -q "decimal\|\.1\|\.2" specs/skills/gsd-insert-phase/SKILL.md

# Has after_phase argument
grep -q "after_phase" specs/skills/gsd-insert-phase/SKILL.md

# Generates successfully
npm run install:claude 2>&1 | grep -q "gsd-insert-phase"

# Output created
test -f .claude/skills/gsd-insert-phase.md
```
  </verify>
  <done>
gsd-insert-phase spec exists, decimal numbering logic preserved, insertion position correct, generates successfully
  </done>
</task>

<task name="migrate-remove-phase-command" type="auto">
  <files>specs/skills/gsd-remove-phase/SKILL.md</files>
  <action>
Create gsd-remove-phase spec from legacy commands/gsd/remove-phase.md (338 lines - MOST COMPLEX).

```bash
mkdir -p specs/skills/gsd-remove-phase

cat > specs/skills/gsd-remove-phase/SKILL.md << 'SPEC_EOF'
---
name: gsd-remove-phase
description: Remove phase from roadmap, delete phase directory, renumber subsequent phases
skill_version: 1.9.1
requires_version: 1.9.0+
platforms: [claude, copilot, codex]
tools:
  - name: read
    required: true
    reason: Load ROADMAP.md to validate phase exists and find subsequent phases
  - name: write
    required: true
    reason: Update ROADMAP.md with renumbered phases
  - name: bash
    required: true
    reason: Delete phase directory, renumber folders, git commit changes
arguments:
  - name: phase
    type: string
    required: true
    description: Phase number to remove (e.g., "17" removes 17, 17.1, 17.2, etc.)
metadata:
  generated: {{generated}}
  platform: {{platform}}
  version: {{version}}
---
SPEC_EOF
```

Append body from legacy commands/gsd/remove-phase.md:
- Preserve renumbering logic (18 → 17, 19 → 18 after removing 17)
- Maintain decimal phase deletion (removing 17 also removes 17.1, 17.2)
- Keep validation (phase exists, has no SUMMARYs)
- Preserve directory renaming
- Keep git commit with full change log

Critical renumbering logic from legacy:
```bash
# Validate no SUMMARYs exist (can't remove completed work)
SUMMARIES=$(ls .planning/phases/${PHASE}-*/*-SUMMARY.md 2>/dev/null | wc -l)
if [ "$SUMMARIES" -gt 0 ]; then
  echo "Error: Phase ${PHASE} has ${SUMMARIES} completed plans. Cannot remove completed work."
  exit 1
fi

# Find all phases after target (including decimals)
BASE_PHASE=${PHASE%.*}  # Remove decimal if present
ALL_PHASES=$(grep "^- Phase [0-9]" "$ROADMAP" | sed 's/^- Phase \([0-9.]*\):.*/\1/' | sort -n)

# Remove target phase and its decimals from roadmap
sed -i "/^- Phase ${BASE_PHASE}:/d" "$ROADMAP"
sed -i "/^- Phase ${BASE_PHASE}\./d" "$ROADMAP"

# Renumber subsequent phases
for phase in $ALL_PHASES; do
  if (( $(echo "$phase > $BASE_PHASE" | bc -l) )); then
    OLD_NUM=${phase%.*}  # Integer part
    NEW_NUM=$((OLD_NUM - 1))
    
    # Update roadmap
    sed -i "s/^- Phase ${phase}:/- Phase ${NEW_NUM}:/" "$ROADMAP"
    
    # Rename directory if exists
    if [ -d ".planning/phases/${phase}-"* ]; then
      OLD_DIR=$(ls -d .planning/phases/${phase}-* 2>/dev/null | head -1)
      NEW_DIR=$(echo "$OLD_DIR" | sed "s/${phase}-/${NEW_NUM}-/")
      mv "$OLD_DIR" "$NEW_DIR"
    fi
  fi
done

# Delete target phase directory
rm -rf .planning/phases/${BASE_PHASE}-*
```

Process structure:
<step name="validate">Check phase exists, no SUMMARYs exist</step>
<step name="confirm">Ask user confirmation (destructive operation)</step>
<step name="remove_from_roadmap">Delete phase lines from ROADMAP.md</step>
<step name="renumber_roadmap">Update all subsequent phase numbers</step>
<step name="renumber_directories">Rename phase folders</step>
<step name="delete_directory">Remove target phase directory</step>
<step name="commit">Git commit with detailed change log</step>

Safety features:
- Refuse if SUMMARYs exist (completed work)
- Require user confirmation
- Git commit enables rollback

Reference legacy:
```bash
sed -n '/^---$/,/^---$/!p' commands/gsd/remove-phase.md >> specs/skills/gsd-remove-phase/SKILL.md
```
  </action>
  <verify>
```bash
# Spec created
test -f specs/skills/gsd-remove-phase/SKILL.md

# Contains renumbering logic
grep -q "renumber\|subsequent" specs/skills/gsd-remove-phase/SKILL.md

# Has validation logic
grep -q "SUMMARY\|completed" specs/skills/gsd-remove-phase/SKILL.md

# Generates successfully
npm run install:claude 2>&1 | grep -q "gsd-remove-phase"

# Output created
test -f .claude/skills/gsd-remove-phase.md
```
  </verify>
  <done>
gsd-remove-phase spec exists, renumbering logic preserved, validation intact, directory operations working, generates successfully
  </done>
</task>

<task name="validate-batch-3-migration" type="auto">
  <files>.claude/skills/gsd-*.md</files>
  <action>
Run comprehensive validation on all three roadmap manipulation commands.

```bash
echo "=== Batch 3 Validation ==="
echo

# Test 1: All specs exist
echo "1. Checking specs exist..."
for cmd in gsd-add-phase gsd-insert-phase gsd-remove-phase; do
  if [ -f "specs/skills/${cmd}/SKILL.md" ]; then
    echo "  ✓ ${cmd}/SKILL.md exists"
  else
    echo "  ✗ ${cmd}/SKILL.md MISSING"
    exit 1
  fi
done
echo

# Test 2: Generate all skills
echo "2. Testing generation..."
npm run install:claude 2>&1 | tee /tmp/install-output.txt
if grep -q "gsd-add-phase" /tmp/install-output.txt && grep -q "gsd-insert-phase" /tmp/install-output.txt && grep -q "gsd-remove-phase" /tmp/install-output.txt; then
  echo "  ✓ All skills generated"
else
  echo "  ✗ Generation failed"
  cat /tmp/install-output.txt
  exit 1
fi
echo

# Test 3: Validate critical logic preservation
echo "3. Validating roadmap manipulation logic..."

# add-phase: highest phase calculation
if grep -q "HIGHEST_PHASE\|sort -n" specs/skills/gsd-add-phase/SKILL.md; then
  echo "  ✓ gsd-add-phase has phase calculation logic"
else
  echo "  ⚠ gsd-add-phase may be missing phase calculation"
fi

# insert-phase: decimal logic
if grep -q "decimal\|\.1" specs/skills/gsd-insert-phase/SKILL.md; then
  echo "  ✓ gsd-insert-phase has decimal numbering logic"
else
  echo "  ⚠ gsd-insert-phase may be missing decimal logic"
fi

# remove-phase: renumbering logic
if grep -q "renumber\|subsequent" specs/skills/gsd-remove-phase/SKILL.md; then
  echo "  ✓ gsd-remove-phase has renumbering logic"
else
  echo "  ⚠ gsd-remove-phase may be missing renumbering logic"
fi

# remove-phase: validation logic
if grep -q "SUMMARY\|completed" specs/skills/gsd-remove-phase/SKILL.md; then
  echo "  ✓ gsd-remove-phase has validation (prevents removing completed work)"
else
  echo "  ⚠ gsd-remove-phase may be missing validation"
fi

echo

# Test 4: All outputs exist
echo "4. Checking generated outputs..."
for cmd in gsd-add-phase gsd-insert-phase gsd-remove-phase; do
  if [ -f ".claude/skills/${cmd}.md" ]; then
    echo "  ✓ ${cmd}.md generated"
  else
    echo "  ✗ ${cmd}.md NOT generated"
    exit 1
  fi
done
echo

echo "=== Batch 3 Migration: COMPLETE ==="
echo "Commands migrated: 3/3"
echo "  - gsd-add-phase (append integer phase)"
echo "  - gsd-insert-phase (insert decimal phase)"
echo "  - gsd-remove-phase (delete + renumber)"
echo
echo "⚠ CRITICAL: Test with roadmap backups before production use"
echo "  These commands modify ROADMAP.md structure directly"
```
  </action>
  <verify>
```bash
# All validations passed
test $? -eq 0

# All three outputs exist
test -f .claude/skills/gsd-add-phase.md
test -f .claude/skills/gsd-insert-phase.md
test -f .claude/skills/gsd-remove-phase.md
```
  </verify>
  <done>
All three roadmap manipulation commands validated: specs exist, critical logic preserved (phase calc, decimals, renumbering), outputs generated
  </done>
</task>

## Success Criteria

**Observable truths** (user can verify):
1. Three new folders exist in `specs/skills/` (gsd-add-phase, gsd-insert-phase, gsd-remove-phase)
2. add-phase appends new integer phase to roadmap
3. insert-phase creates decimal phases (72.1, 72.2) for urgent work
4. remove-phase deletes phase and renumbers subsequent phases
5. All commands generate and install successfully

**Technical verification:**
- Phase calculation logic intact (find highest, add 1)
- Decimal numbering logic intact (.1, .2, .3...)
- Renumbering logic intact (18→17, 19→18 after removing 17)
- Git commits execute after each roadmap change
- Validation prevents removing completed work (SUMMARYs check)

**Testing recommendations:**
```bash
# Create test roadmap backup before testing
cp .planning/ROADMAP.md .planning/ROADMAP.backup.md

# Test add-phase
/gsd:add-phase Test new phase

# Test insert-phase (decimal)
/gsd:insert-phase 5 Urgent fix

# Verify decimal created (should be 5.1 or next available)
grep "Phase 5\." .planning/ROADMAP.md

# Restore backup if needed
mv .planning/ROADMAP.backup.md .planning/ROADMAP.md
```

**Git commit:**
```bash
git add specs/skills/gsd-{add,insert,remove}-phase/
git commit -m "feat(05): migrate batch 3 phase management commands

Batch 3: Roadmap manipulation (3 commands)
- gsd-add-phase: Append integer phase to milestone
- gsd-insert-phase: Insert decimal phase (urgent work)
- gsd-remove-phase: Delete phase + renumber subsequent

Pattern: ROADMAP.md manipulation with decimal phase support
Complexity: MEDIUM-HIGH (207-338 lines)
Wave: 2 (no dependencies on other Phase 5 commands)

Critical: Test with backups - these modify roadmap structure"
```

## Output

**Commands migrated:** 3/21 (total: 9/21)
**Completion:** ~43% of Phase 5
**Next:** Plan 05-04 (Batch 4: Todo management commands)
