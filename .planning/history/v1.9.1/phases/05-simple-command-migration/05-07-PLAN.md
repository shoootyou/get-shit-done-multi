---
phase: 05-simple-command-migration
plan: 07
type: execute
wave: 3
depends_on: [05-01, 05-02, 05-03, 05-04]
files_modified:
  - specs/skills/gsd-update/SKILL.md
  - .claude/skills/gsd-update.md (generated)
autonomous: true
must_haves:
  goal: "Migrate update command for GSD self-update functionality"
  truths:
    - Spec folder exists with update command logic
    - Update command fetches latest GSD version from repository
    - Update displays changelog between current and latest versions
    - Installation steps preserved (npm install, verification)
    - Command generates and installs successfully
  artifacts:
    - specs/skills/gsd-update/SKILL.md
  wiring:
    - Update command uses bash for git operations
    - Update reads CHANGELOG.md for version diff
    - Update runs npm install for dependency updates
  key_links:
    - git fetch → version check → changelog display → npm install
---

# Phase 5 Plan 07: Batch 7 - Update Command

**Objective:** Migrate gsd-update command for GSD self-update functionality

## Context

**From Research (05-RESEARCH.md):**
- **gsd-update**: 172 lines, updates GSD installation from repository
- **Complexity**: MEDIUM (git operations, changelog parsing, npm install)
- **Pattern**: Single-stage command with bash-heavy operations
- **No dependencies**: Standalone utility command

**Command:**
- **gsd-update** (172 lines) - Update GSD installation to latest version

**Why Wave 3:**
- No dependencies on other Phase 5 commands
- Can run in parallel with 05-05 and 05-06
- Independent utility command

## Tasks

<task name="migrate-update-command" type="auto">
  <files>specs/skills/gsd-update/SKILL.md</files>
  <action>
Create gsd-update spec from legacy commands/gsd/update.md (172 lines).

Frontmatter:
```yaml
name: gsd-update
description: Update GSD installation to latest version from repository
skill_version: 1.9.1
requires_version: 1.9.0+
platforms: [claude, copilot, codex]
tools:
  - name: read
  - name: bash
arguments: []
```

Body structure:
```xml
<objective>
Update GSD installation to latest version from repository, display changelog, 
and verify installation.

Purpose: Keep GSD up-to-date with latest features and bug fixes.
Output: Updated installation, changelog displayed.
</objective>

<process>
<step name="check_current_version">
Determine current GSD version:

```bash
# Check current version from package.json
CURRENT_VERSION=$(jq -r '.version' package.json 2>/dev/null || echo "unknown")
echo "Current GSD version: ${CURRENT_VERSION}"
```
</step>

<step name="fetch_latest">
Fetch latest version from repository:

```bash
# Ensure we're in GSD directory
if [ ! -f "package.json" ] || ! grep -q '"name": "get-shit-done"' package.json; then
  echo "Error: Not in GSD directory"
  exit 1
fi

# Fetch latest from origin
git fetch origin main

# Get latest version
LATEST_VERSION=$(git show origin/main:package.json | jq -r '.version' 2>/dev/null || echo "unknown")
echo "Latest GSD version: ${LATEST_VERSION}"
```
</step>

<step name="check_if_update_needed">
Compare versions:

```bash
if [ "${CURRENT_VERSION}" = "${LATEST_VERSION}" ]; then
  echo "✓ Already up-to-date (${CURRENT_VERSION})"
  echo ""
  echo "No update needed. You're running the latest version."
  exit 0
fi

echo ""
echo "Update available: ${CURRENT_VERSION} → ${LATEST_VERSION}"
echo ""
```
</step>

<step name="display_changelog">
Display changelog between versions:

```bash
# Parse CHANGELOG.md for changes between versions
echo "=== Changelog: ${CURRENT_VERSION} → ${LATEST_VERSION} ==="
echo ""

# Extract relevant changelog section
# Look for version headers and extract content between current and latest
if [ -f "CHANGELOG.md" ]; then
  # Show changes from remote (latest)
  git show origin/main:CHANGELOG.md | awk "
    /^## \[${LATEST_VERSION}\]/,/^## \[${CURRENT_VERSION}\]/ {
      if (/^## \[${CURRENT_VERSION}\]/) exit;
      print
    }
  " | head -50
else
  echo "(CHANGELOG.md not found)"
fi

echo ""
```
</step>

<step name="confirm_update">
Ask for confirmation:

If user confirms: proceed with update
If user declines: exit without updating

```bash
echo "Proceed with update? This will:"
echo "  1. Stash any local changes"
echo "  2. Pull latest code from origin/main"
echo "  3. Run npm install"
echo "  4. Verify installation"
echo ""
read -p "Continue? (y/n): " CONFIRM

if [ "${CONFIRM}" != "y" ] && [ "${CONFIRM}" != "Y" ]; then
  echo "Update cancelled"
  exit 0
fi
```
</step>

<step name="stash_local_changes">
Stash any local changes:

```bash
# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
  echo "Stashing local changes..."
  git stash push -m "GSD update: stash before update to ${LATEST_VERSION}"
  STASHED=true
else
  STASHED=false
fi
```
</step>

<step name="pull_latest">
Pull latest code:

```bash
echo "Pulling latest code..."
git pull origin main

if [ $? -ne 0 ]; then
  echo "Error: git pull failed"
  if [ "${STASHED}" = "true" ]; then
    echo "Your changes are stashed. Run 'git stash pop' to restore."
  fi
  exit 1
fi
```
</step>

<step name="install_dependencies">
Install updated dependencies:

```bash
echo "Installing dependencies..."
npm install

if [ $? -ne 0 ]; then
  echo "Error: npm install failed"
  exit 1
fi
```
</step>

<step name="verify_installation">
Verify updated installation:

```bash
echo "Verifying installation..."

# Check version updated
NEW_VERSION=$(jq -r '.version' package.json)

if [ "${NEW_VERSION}" != "${LATEST_VERSION}" ]; then
  echo "Warning: Version mismatch after update"
  echo "  Expected: ${LATEST_VERSION}"
  echo "  Got: ${NEW_VERSION}"
fi

# Run basic checks
echo "Running verification checks..."

# Check required files exist
CHECKS_PASSED=true

if [ ! -f "bin/install.js" ]; then
  echo "✗ Missing bin/install.js"
  CHECKS_PASSED=false
else
  echo "✓ bin/install.js exists"
fi

if [ ! -d "specs/skills" ]; then
  echo "✗ Missing specs/skills directory"
  CHECKS_PASSED=false
else
  SKILL_COUNT=$(ls -1 specs/skills | wc -l)
  echo "✓ specs/skills exists (${SKILL_COUNT} skills)"
fi

if [ ! -d "specs/agents" ]; then
  echo "✗ Missing specs/agents directory"
  CHECKS_PASSED=false
else
  AGENT_COUNT=$(ls -1 specs/agents | wc -l)
  echo "✓ specs/agents exists (${AGENT_COUNT} agents)"
fi
```
</step>

<step name="restore_stashed_changes">
Offer to restore stashed changes:

```bash
if [ "${STASHED}" = "true" ]; then
  echo ""
  echo "Local changes were stashed before update."
  read -p "Restore stashed changes? (y/n): " RESTORE
  
  if [ "${RESTORE}" = "y" ] || [ "${RESTORE}" = "Y" ]; then
    git stash pop
    echo "Changes restored. Review any merge conflicts."
  else
    echo "Changes remain stashed. Run 'git stash pop' to restore later."
  fi
fi
```
</step>

<step name="present_summary">
Present update summary:

```
## GSD UPDATE COMPLETE

**Previous version:** ${CURRENT_VERSION}
**Current version:** ${NEW_VERSION}

✓ Code updated
✓ Dependencies installed
✓ Installation verified

### Next Steps

1. Review changelog above for new features
2. Test critical workflows (e.g., /gsd:progress)
3. Report any issues on GitHub

**Note:** Skills and agents were not regenerated. Run installation 
manually if needed:
  - npm run install:local (for testing)
  - Or wait for next GSD command run (auto-regenerates)
```
</step>
</process>
```

**Critical elements:**
- Version comparison (current vs latest)
- Changelog extraction between versions
- User confirmation before updating
- Stash local changes (preserve work)
- Git pull + npm install
- Verification checks after update
- Offer to restore stashed changes
  </action>
  <verify>
Test spec creation and structure:
```bash
# Create spec
cat specs/skills/gsd-update/SKILL.md

# Check critical steps
cat specs/skills/gsd-update/SKILL.md | grep -A 5 "check_current_version"
cat specs/skills/gsd-update/SKILL.md | grep -A 5 "display_changelog"
cat specs/skills/gsd-update/SKILL.md | grep -A 5 "confirm_update"
```
  </verify>
  <done>gsd-update spec exists with full update workflow</done>
</task>

<task name="generate-and-test-update-skill" type="auto">
  <files>None (testing only)</files>
  <action>
Generate gsd-update skill and verify structure.

```bash
# Generate skill
npm run install:local

# Verify generated
echo "=== Generated Skill ==="
ls -la .claude/skills/gsd-update.md

# Check line count (should be ~172)
wc -l .claude/skills/gsd-update.md

# Verify key sections exist
echo "=== Key Sections ==="
grep -c "check_current_version" .claude/skills/gsd-update.md
grep -c "display_changelog" .claude/skills/gsd-update.md
grep -c "confirm_update" .claude/skills/gsd-update.md
grep -c "pull_latest" .claude/skills/gsd-update.md
grep -c "install_dependencies" .claude/skills/gsd-update.md

# Run syntax check
node -e "
const fs = require('fs');
const content = fs.readFileSync('.claude/skills/gsd-update.md', 'utf8');
const parts = content.split('---');

if (parts.length >= 3) {
  console.log('✓ gsd-update: valid frontmatter');
  const frontmatter = parts[1];
  
  // Check for required fields
  const hasName = frontmatter.includes('name:');
  const hasTools = frontmatter.includes('tools:');
  const hasBash = frontmatter.includes('bash');
  
  console.log('  - name field:', hasName ? '✓' : '✗');
  console.log('  - tools field:', hasTools ? '✓' : '✗');
  console.log('  - bash tool:', hasBash ? '✓' : '✗');
  
  // Check body has critical steps
  const body = parts.slice(2).join('---');
  const hasVersion = body.includes('check_current_version');
  const hasChangelog = body.includes('display_changelog');
  const hasConfirm = body.includes('confirm_update');
  
  console.log('  - version check:', hasVersion ? '✓' : '✗');
  console.log('  - changelog display:', hasChangelog ? '✓' : '✗');
  console.log('  - confirmation:', hasConfirm ? '✓' : '✗');
} else {
  console.error('✗ gsd-update: invalid structure');
}
"

echo ""
echo "✓ gsd-update skill generated successfully"
```
  </action>
  <verify>Generated skill exists with all critical sections</verify>
  <done>gsd-update skill generated and verified</done>
</task>

## Verification

**After execution:**
- [ ] Spec folder exists: specs/skills/gsd-update/
- [ ] Spec has complete frontmatter with bash tool
- [ ] All critical steps present (version check, changelog, confirm, pull, install)
- [ ] Skill generates successfully via npm run install:local
- [ ] Generated file exists in .claude/skills/ with ~172 lines
- [ ] Syntax validation passes

## Success Criteria

**Observable truths:**
1. update command can check current version
2. update command fetches latest version from repository
3. update command displays changelog between versions
4. update command asks for confirmation before proceeding
5. update command stashes local changes safely
6. update command pulls latest code and installs dependencies
7. update command verifies installation after update

**Key deliverable:** Update command migrated with full self-update workflow preserved.

## Output

Files created:
- `specs/skills/gsd-update/SKILL.md` - GSD self-update command
- `.claude/skills/gsd-update.md` - Generated skill (~172 lines)

Ready for: Wave 4 (progress hub migration - update command is referenced in progress routing)
