---
phase: 02-template-engine-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - specs/skills/_shared.yml
  - bin/lib/template-system/spec-parser.js
autonomous: true
must_haves:
  goal: "Enable DRY frontmatter with shared configuration file"
  truths:
    - File specs/skills/_shared.yml exists with common frontmatter blocks
    - spec-parser.js loads _shared.yml when parsing skill specs
    - Shared blocks merge with skill-specific frontmatter
    - Skill-specific values override shared values (merge precedence)
    - Tool arrays and other complex fields merge correctly
  artifacts:
    - specs/skills/_shared.yml with common tool declarations
    - bin/lib/template-system/spec-parser.js with merge logic
  wiring:
    - parseSpec() checks for _shared.yml in parent directory
    - Shared frontmatter merges before platform conditionals render
  key_links:
    - bin/lib/template-system/spec-parser.js::parseSpec → specs/skills/_shared.yml
---

# Phase 2 Plan 02: Frontmatter Inheritance

**Objective:** Implement _shared.yml mechanism for DRY frontmatter across skills (FOUN-07 requirement)

## Context

Research identified Option B (_shared.yml merge) as the simplest approach for frontmatter inheritance. Skills can share common tool declarations, metadata templates, and repeated frontmatter blocks without duplication.

**From Research (02-RESEARCH.md):**
- Requirement FOUN-07: Support frontmatter inheritance for DRY
- Recommended: _shared.yml with Object.assign() merge (simpler than YAML anchors)
- Merge precedence: skill-specific overrides shared
- Load shared before parsing each spec

**Use case:** All GSD skills need [Read, Bash, Glob] tools. Instead of declaring in every SKILL.md, define once in _shared.yml and inherit.

## Tasks

<task name="create-shared-frontmatter-file" type="auto">
  <files>specs/skills/_shared.yml</files>
  <action>
Create specs/skills/_shared.yml with common frontmatter blocks for GSD skills.

**Content:**
```yaml
# Shared frontmatter for GSD skills
# Skills can inherit these blocks and override specific fields

# Common tools used by most GSD commands
tools:
  claude: [Read, Bash, Glob]
  copilot: [file_read, shell_execute, glob]
  codex: [read, bash, glob]

# Common metadata (skills can override)
metadata:
  category: gsd-command
  system: get-shit-done
```

**Design decisions:**
1. Tools organized by platform (allows platform-specific tool lists)
2. Metadata provides defaults (skills can add/override)
3. YAML format matches skill frontmatter structure
4. Underscore prefix (_shared.yml) signals special file (not a skill spec)
  </action>
  <verify>
```bash
# Verify file exists and is valid YAML
ls -la specs/skills/_shared.yml

# Parse YAML to check structure
node -e "
  const yaml = require('js-yaml');
  const fs = require('fs');
  const shared = yaml.load(fs.readFileSync('specs/skills/_shared.yml', 'utf8'));
  console.log('Has tools:', !!shared.tools);
  console.log('Has metadata:', !!shared.metadata);
  console.log('Tool platforms:', Object.keys(shared.tools || {}));
"
```
  </verify>
  <done>
- File specs/skills/_shared.yml exists
- File contains valid YAML structure
- Common tools defined for claude, copilot, codex platforms
- Metadata provides defaults for category, system
  </done>
</task>

<task name="implement-frontmatter-merge" type="auto">
  <files>bin/lib/template-system/spec-parser.js</files>
  <action>
Extend parseSpec() and parseSpecString() functions in spec-parser.js to load and merge _shared.yml.

**Add helper function:**
```javascript
/**
 * Load shared frontmatter from _shared.yml if it exists
 * @param {string} specPath - Path to the spec file
 * @returns {object|null} Shared frontmatter or null if not found
 */
function loadSharedFrontmatter(specPath) {
  const path = require('path');
  const fs = require('fs');
  const yaml = require('js-yaml');
  
  // Look for _shared.yml in spec's parent directory
  const parentDir = path.dirname(path.dirname(specPath)); // Go up to specs/skills/
  const sharedPath = path.join(parentDir, '_shared.yml');
  
  if (fs.existsSync(sharedPath)) {
    try {
      const content = fs.readFileSync(sharedPath, 'utf8');
      return yaml.load(content);
    } catch (err) {
      // Silently ignore parse errors in _shared.yml
      console.warn(`Warning: Failed to parse _shared.yml: ${err.message}`);
      return null;
    }
  }
  
  return null;
}

/**
 * Merge shared frontmatter with skill-specific frontmatter
 * Skill-specific values override shared values (deep merge for objects)
 * @param {object} shared - Shared frontmatter from _shared.yml
 * @param {object} specific - Skill-specific frontmatter
 * @returns {object} Merged frontmatter
 */
function mergeFrontmatter(shared, specific) {
  if (!shared) return specific;
  
  const merged = { ...shared };
  
  // Deep merge for nested objects (like metadata)
  for (const key in specific) {
    if (specific[key] && typeof specific[key] === 'object' && !Array.isArray(specific[key])) {
      merged[key] = { ...(merged[key] || {}), ...specific[key] };
    } else {
      // Direct override for primitives and arrays
      merged[key] = specific[key];
    }
  }
  
  return merged;
}
```

**Modify parseSpec() function** (currently around lines 20-45):
```javascript
function parseSpec(specPath) {
  // ... existing path resolution ...
  
  const fileContent = fs.readFileSync(absolutePath, 'utf8');
  const parsed = matter(fileContent);
  
  // Load and merge shared frontmatter
  const shared = loadSharedFrontmatter(absolutePath);
  const frontmatter = mergeFrontmatter(shared, parsed.data);
  
  return {
    frontmatter,  // Use merged frontmatter instead of parsed.data
    body: parsed.content,
    path: absolutePath
  };
}
```

**Note:** parseSpecString() doesn't need changes (it's for already-rendered content without path context).

**Merge precedence rules:**
- Skill-specific primitives/arrays override shared (no merge)
- Skill-specific objects deep merge with shared objects
- Example: `tools.claude` in skill overrides `tools.claude` in shared (arrays replace, don't append)
  </action>
  <verify>
```bash
# Test frontmatter inheritance with gsd-help
node -e "
  const { parseSpec } = require('./bin/lib/template-system/spec-parser');
  const spec = parseSpec('specs/skills/gsd-help/SKILL.md');
  
  // Check if metadata was inherited from _shared.yml
  console.log('Has metadata.category:', !!spec.frontmatter.metadata?.category);
  console.log('Metadata category:', spec.frontmatter.metadata?.category);
  
  // Name should be from skill (not shared)
  console.log('Skill name:', spec.frontmatter.name);
  console.log('Has description:', !!spec.frontmatter.description);
  
  // Verify merge didn't break existing parsing
  console.log('Has body:', spec.body.length > 0);
"
```
  </verify>
  <done>
- Function loadSharedFrontmatter() exists in spec-parser.js
- Function mergeFrontmatter() handles deep merge for objects
- parseSpec() loads _shared.yml and merges with skill frontmatter
- Skill-specific values override shared values correctly
- Deep merge works for nested objects (metadata)
  </done>
</task>

## Verification

```bash
# Comprehensive test of inheritance mechanism
node -e "
  const { parseSpec } = require('./bin/lib/template-system/spec-parser');
  const fs = require('fs');
  
  // Test with gsd-help
  const spec = parseSpec('specs/skills/gsd-help/SKILL.md');
  
  console.log('=== Frontmatter Inheritance Test ===');
  console.log('✓ Inherited metadata.category:', spec.frontmatter.metadata?.category);
  console.log('✓ Skill-specific name:', spec.frontmatter.name);
  console.log('✓ Skill-specific description:', spec.frontmatter.description);
  console.log('✓ Has body content:', spec.body.length > 100);
  
  // Verify shared file exists
  const sharedExists = fs.existsSync('specs/skills/_shared.yml');
  console.log('✓ _shared.yml exists:', sharedExists);
  
  const allPassed = 
    spec.frontmatter.metadata?.category === 'gsd-command' &&
    spec.frontmatter.name === 'gsd-help' &&
    spec.body.length > 0 &&
    sharedExists;
  
  process.exit(allPassed ? 0 : 1);
"
```

## Success Criteria

- [x] File specs/skills/_shared.yml created with common frontmatter
- [x] spec-parser.js loads and merges _shared.yml automatically
- [x] Skill-specific values override shared values (merge precedence)
- [x] Deep merge works for nested objects (metadata)
- [x] Inheritance transparent to generateAgent() (no changes needed)
- [x] Requirement FOUN-07 satisfied

## Output

**Created:**
- `specs/skills/_shared.yml`: Common frontmatter definitions (~15 lines)

**Modified:**
- `bin/lib/template-system/spec-parser.js`: Added loadSharedFrontmatter() and mergeFrontmatter() functions, modified parseSpec() (~60 lines added)

**Technical notes:**
- Merge happens at parse time (before rendering conditionals)
- Inheritance is optional (skills without _shared.yml work unchanged)
- Deep merge for objects prevents metadata overwrite
- Arrays replace (don't append) to avoid tool list bloat
