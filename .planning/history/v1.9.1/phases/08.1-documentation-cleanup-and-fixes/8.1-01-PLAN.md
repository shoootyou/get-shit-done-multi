---
phase: 08.1-documentation-cleanup-and-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/install.js
  - scripts/migration/detect-old-structure.js
  - scripts/migration/backup-handler.js
  - scripts/migration/migration-flow.js
  - scripts/migration/migration-prompts.js
  - scripts/shared/git-operations.js
  - scripts/shared/progress-display.js
  - scripts/shared/user-prompts.js
  - docs/*.md (renamed to lowercase)
  - .gitignore
autonomous: true
must_haves:
  truths:
    - User can run `npm install get-shit-done-multi` and old structure is detected automatically
    - Backup is created in `.old-gsd-system/YYYY-MM-DD/` before any removal
    - Migration shows progress bar with percentage completion
    - Files in `/docs` folder are lowercase (e.g., troubleshooting.md, migration-guide.md)
    - All doc references updated before file renaming (no broken links)
    - Scripts are organized in functional subfolders (migration/, documentation/, audit/, shared/)
  artifacts:
    - scripts/migration/detect-old-structure.js (detection logic)
    - scripts/migration/backup-handler.js (backup operations with date folders)
    - scripts/migration/migration-flow.js (orchestrator)
    - scripts/migration/migration-prompts.js (user interaction)
    - scripts/shared/git-operations.js (git mv wrapper)
    - scripts/shared/progress-display.js (progress bar with CI fallback)
    - docs/ files renamed to lowercase
  wiring:
    - install.js calls migration-flow.js when old structure detected
    - migration-flow.js orchestrates: detect ‚Üí confirm ‚Üí backup ‚Üí reinstall
    - progress-display.js handles TTY detection and CI fallback
    - backup-handler.js creates date-based folders in .old-gsd-system/
  key_links:
    - Migration flow MUST complete backup before any destructive operations
    - File renaming MUST preserve git history via git mv
    - Doc references MUST be updated before renaming files
---

# Plan 8.1-01: Migration Mechanism & File Organization

## Objective

Implement automatic detection and migration from old GSD structure to new skill-based system. Reorganize scripts into functional subfolders. Rename documentation files to lowercase with git history preservation.

## Context

**Why this plan exists:**
- Users upgrading from pre-v1.9.1 have old `.github/skills/get-shit-done/commands` structure
- Current cleanup script is bash-only (not cross-platform)
- Root directory has scattered scripts that need organization
- Documentation files have inconsistent casing (TROUBLESHOOTING.md vs migration-guide.md)

**What we're building on:**
- Phase 8 established core documentation (README, CHANGELOG, guides)
- Research identified fs-extra, prompts, cli-progress as standard tools
- CONTEXT.md specifies migration flow: detect ‚Üí confirm ‚Üí backup ‚Üí reinstall
- Existing cleanup-legacy-commands.sh has bash logic to port

**What comes after:**
- Plan 02 will update documentation content
- Plan 03 will validate links and audit scripts

## Tasks

<task name="Install migration dependencies" type="auto">
  <files>package.json, package-lock.json</files>
  <action>
Install migration and file operation dependencies:

```bash
npm install fs-extra@11.3.3 prompts@2.4.2 cli-progress@3.12.0 chalk@5.6.2
```

Verify installation:
```bash
npm list fs-extra prompts cli-progress chalk
```
  </action>
  <verify>Dependencies appear in package.json and package-lock.json</verify>
  <done>Migration libraries installed and locked</done>
</task>

<task name="Create migration module structure" type="auto">
  <files>
    scripts/migration/detect-old-structure.js
    scripts/migration/backup-handler.js
    scripts/migration/migration-flow.js
    scripts/migration/migration-prompts.js
    scripts/shared/git-operations.js
    scripts/shared/progress-display.js
    scripts/shared/user-prompts.js
  </files>
  <action>
Create organized script structure per RESEARCH.md Pattern 1 (Safe Migration with Backup):

**1. Migration detection (scripts/migration/detect-old-structure.js):**
```javascript
const fs = require('fs-extra');
const path = require('path');

/**
 * Detect old GSD structure across all supported CLIs
 * Old: .github/skills/get-shit-done/commands (nested structure)
 * New: .github/skills/gsd-* (multiple skill folders in skills/)
 */
async function detectOldStructure(platform) {
  const patterns = {
    copilot: '.github/skills/get-shit-done/commands',
    claude: '.claude/get-shit-done/commands',
    codex: '.codex/skills/get-shit-done/commands'
  };
  
  const oldPath = patterns[platform];
  if (!oldPath) return null;
  
  const hasOld = await fs.pathExists(oldPath);
  if (!hasOld) return null;
  
  // Verify it's actually old structure (has commands folder)
  const files = await fs.readdir(oldPath).catch(() => []);
  
  return {
    platform,
    path: oldPath,
    fileCount: files.length,
    detected: true
  };
}

async function detectAllPlatforms() {
  const platforms = ['copilot', 'claude', 'codex'];
  const results = await Promise.all(
    platforms.map(p => detectOldStructure(p))
  );
  return results.filter(r => r !== null);
}

module.exports = { detectOldStructure, detectAllPlatforms };
```

**2. Backup handler with date folders (scripts/migration/backup-handler.js):**
```javascript
const fs = require('fs-extra');
const path = require('path');

/**
 * Create backup in .old-gsd-system/YYYY-MM-DD/ structure
 * Per RESEARCH.md decision: Use folder per date to preserve history
 */
async function createBackup(sourcePath, options = {}) {
  const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
  const backupBase = path.join(process.cwd(), '.old-gsd-system');
  const backupPath = path.join(backupBase, today);
  
  // Check if today's backup already exists
  const exists = await fs.pathExists(backupPath);
  if (exists && !options.overwrite) {
    throw new Error(`Backup already exists for ${today}. Use --overwrite to replace.`);
  }
  
  // Create backup with atomic copy
  await fs.copy(sourcePath, backupPath, {
    preserveTimestamps: true,
    errorOnExist: !options.overwrite,
    overwrite: options.overwrite
  });
  
  // Verify backup
  const sourceFiles = await countFiles(sourcePath);
  const backupFiles = await countFiles(backupPath);
  
  if (sourceFiles !== backupFiles) {
    throw new Error('Backup verification failed: file count mismatch');
  }
  
  return {
    backupPath,
    filesBackedUp: sourceFiles,
    date: today
  };
}

async function countFiles(dir) {
  const files = await fs.readdir(dir, { recursive: true });
  return files.filter(f => {
    const stat = fs.statSync(path.join(dir, f));
    return stat.isFile();
  }).length;
}

async function addToGitignore() {
  const gitignorePath = path.join(process.cwd(), '.gitignore');
  let gitignore = await fs.readFile(gitignorePath, 'utf8').catch(() => '');
  
  if (!gitignore.includes('.old-gsd-system')) {
    gitignore += '\n# GSD migration backup\n.old-gsd-system/\n';
    await fs.writeFile(gitignorePath, gitignore);
    return true;
  }
  return false;
}

module.exports = { createBackup, addToGitignore };
```

**3. Progress display with CI fallback (scripts/shared/progress-display.js):**
```javascript
const cliProgress = require('cli-progress');
const chalk = require('chalk');

function createProgressBar(label, total) {
  // Detect CI/non-TTY environment (per RESEARCH.md Pitfall 1)
  if (!process.stdout.isTTY || process.env.CI) {
    // Mock progress bar for CI
    let current = 0;
    return {
      start: () => console.log(`‚è≥ ${label} (0/${total})`),
      update: (value) => {
        current = value;
        if (value % Math.ceil(total / 5) === 0 || value === total) {
          const pct = Math.round((value / total) * 100);
          console.log(`‚è≥ ${label} (${value}/${total}) ${pct}%`);
        }
      },
      increment: () => {
        current++;
        if (current === total) {
          console.log(`‚úì ${label} complete (${total}/${total})`);
        }
      },
      stop: () => console.log(`‚úì ${label} complete`)
    };
  }
  
  const bar = new cliProgress.SingleBar({
    format: `${label} |${chalk.cyan('{bar}')}| {percentage}% | {value}/{total} files`,
    barCompleteChar: '\u2588',
    barIncompleteChar: '\u2591',
    hideCursor: true
  });
  
  return bar;
}

module.exports = { createProgressBar };
```

**4. Migration prompts (scripts/migration/migration-prompts.js):**
```javascript
const prompts = require('prompts');
const chalk = require('chalk');

async function confirmMigration(detectedStructures) {
  console.log(chalk.yellow('\n‚ö†  Old GSD structure detected:\n'));
  
  detectedStructures.forEach(structure => {
    console.log(`  ${chalk.cyan(structure.platform)}: ${structure.path}`);
    console.log(`    Files: ${structure.fileCount}`);
  });
  
  const today = new Date().toISOString().split('T')[0];
  console.log(`\n  Backup will be created at: ${chalk.green(`.old-gsd-system/${today}/`)}`);
  
  const response = await prompts({
    type: 'confirm',
    name: 'proceed',
    message: 'Backup old structure and migrate to new skill-based system?',
    initial: true
  });
  
  return response.proceed;
}

module.exports = { confirmMigration };
```

**5. Git operations wrapper (scripts/shared/git-operations.js):**
```javascript
const { execSync } = require('child_process');
const fs = require('fs-extra');

/**
 * Rename file with git history preservation
 * Per RESEARCH.md Pitfall 6: Use two-step rename for case-insensitive filesystems
 */
async function gitMv(oldPath, newPath) {
  const isCaseOnlyChange = oldPath.toLowerCase() === newPath.toLowerCase();
  
  try {
    if (isCaseOnlyChange) {
      // Two-step rename for case-insensitive filesystems
      const tempPath = oldPath + '.tmp';
      execSync(`git mv "${oldPath}" "${tempPath}"`, { stdio: 'pipe' });
      execSync(`git mv "${tempPath}" "${newPath}"`, { stdio: 'pipe' });
    } else {
      execSync(`git mv "${oldPath}" "${newPath}"`, { stdio: 'pipe' });
    }
    return { success: true, method: 'git' };
  } catch (err) {
    // Fallback to fs if not in git or file not tracked
    await fs.rename(oldPath, newPath);
    return { success: true, method: 'fs', warning: 'Not tracked by git' };
  }
}

module.exports = { gitMv };
```

**6. Migration flow orchestrator (scripts/migration/migration-flow.js):**
```javascript
const { detectAllPlatforms } = require('./detect-old-structure');
const { createBackup, addToGitignore } = require('./backup-handler');
const { confirmMigration } = require('./migration-prompts');
const { createProgressBar } = require('../shared/progress-display');
const fs = require('fs-extra');
const chalk = require('chalk');

async function runMigration() {
  console.log(chalk.cyan('\nüîç Checking for old GSD structure...\n'));
  
  // 1. Detection
  const detected = await detectAllPlatforms();
  
  if (detected.length === 0) {
    console.log(chalk.green('‚úì No migration needed - already on new structure'));
    return { migrated: false, reason: 'no-old-structure' };
  }
  
  // 2. Confirmation
  const proceed = await confirmMigration(detected);
  if (!proceed) {
    console.log(chalk.yellow('\n‚ö†  Migration cancelled by user'));
    return { migrated: false, reason: 'user-declined' };
  }
  
  // 3. Backup
  console.log(chalk.cyan('\nüì¶ Creating backup...\n'));
  const backupResults = [];
  
  for (const structure of detected) {
    const result = await createBackup(structure.path);
    backupResults.push({ platform: structure.platform, ...result });
    console.log(chalk.green(`‚úì Backed up ${structure.platform}: ${result.backupPath}`));
  }
  
  // 4. Add to .gitignore
  const gitignoreUpdated = await addToGitignore();
  if (gitignoreUpdated) {
    console.log(chalk.green('‚úì Added .old-gsd-system/ to .gitignore'));
  }
  
  // 5. Remove old structure
  console.log(chalk.cyan('\nüóë  Removing old structure...\n'));
  const progressBar = createProgressBar('Cleaning up', detected.length);
  progressBar.start(detected.length, 0);
  
  for (let i = 0; i < detected.length; i++) {
    await fs.remove(detected[i].path);
    progressBar.update(i + 1);
  }
  progressBar.stop();
  
  // 6. Success message
  console.log(chalk.green('\n‚úÖ Migration complete!'));
  console.log(chalk.dim(`\n   Old files backed up to: .old-gsd-system/${backupResults[0].date}/`));
  console.log(chalk.dim(`   Run installation again to set up new structure\n`));
  
  return {
    migrated: true,
    platforms: detected.map(d => d.platform),
    backups: backupResults,
    filesProcessed: detected.reduce((sum, d) => sum + d.fileCount, 0)
  };
}

module.exports = { runMigration };
```

**7. User prompts helper (scripts/shared/user-prompts.js):**
```javascript
const prompts = require('prompts');

async function confirmAction(message, defaultValue = true) {
  const response = await prompts({
    type: 'confirm',
    name: 'confirmed',
    message,
    initial: defaultValue
  });
  return response.confirmed;
}

async function selectOption(message, choices) {
  const response = await prompts({
    type: 'select',
    name: 'selected',
    message,
    choices
  });
  return response.selected;
}

module.exports = { confirmAction, selectOption };
```
  </action>
  <verify>
All 7 migration script files exist with proper module structure:
```bash
ls -la scripts/migration/
ls -la scripts/shared/
```
  </verify>
  <done>Migration module structure created with detection, backup, progress, and orchestration</done>
</task>

<task name="Integrate migration into install.js" type="auto">
  <files>bin/install.js</files>
  <action>
Add migration detection and execution to install.js:

1. Import migration flow at top of file:
```javascript
const { runMigration } = require('../scripts/migration/migration-flow');
```

2. Add migration check before installation (around line 50, before platform installation):
```javascript
// Check for old structure and migrate if needed
try {
  const migrationResult = await runMigration();
  if (migrationResult.migrated) {
    console.log('Migration completed. Proceeding with fresh installation...\n');
  }
} catch (err) {
  console.error('Migration failed:', err.message);
  console.error('Please backup manually and try again.');
  process.exit(1);
}
```

This ensures migration runs automatically during installation.
  </action>
  <verify>
Search install.js for runMigration call:
```bash
grep -n "runMigration" bin/install.js
```
  </verify>
  <done>Migration automatically runs during npm install when old structure detected</done>
</task>

<task name="Rename docs files to lowercase" type="auto">
  <files>docs/*.md, references to renamed files</files>
  <action>
Rename documentation files to lowercase with git history preservation per RESEARCH.md Pattern 2:

**Step 1: Update all references FIRST (before renaming)**

Scan and update references in all markdown files:
```bash
# Find all references to uppercase doc filenames
grep -r "TROUBLESHOOTING.md\|MIGRATION-GUIDE.md\|COMMAND-COMPARISON.md" . \
  --include="*.md" \
  --exclude-dir=node_modules \
  --exclude-dir=.git

# Update references (Claude will do this with edit tool for each file)
# Example patterns:
# TROUBLESHOOTING.md ‚Üí troubleshooting.md
# MIGRATION-GUIDE.md ‚Üí migration-guide.md  
# COMMAND-COMPARISON.md ‚Üí command-comparison.md
```

**Step 2: Rename files with git mv** (after references updated)

Use git mv for history preservation per RESEARCH.md Pitfall 6 (case-insensitive filesystems):

```javascript
// Create script: scripts/documentation/rename-to-lowercase.js
const { gitMv } = require('../shared/git-operations');
const path = require('path');
const fs = require('fs-extra');

async function renameDocsToLowercase() {
  const docsDir = path.join(process.cwd(), 'docs');
  const files = await fs.readdir(docsDir);
  
  const renamed = [];
  
  for (const file of files) {
    if (!file.endsWith('.md')) continue;
    
    const lowercase = file.toLowerCase();
    if (file !== lowercase) {
      const oldPath = path.join(docsDir, file);
      const newPath = path.join(docsDir, lowercase);
      
      console.log(`Renaming: ${file} ‚Üí ${lowercase}`);
      const result = await gitMv(oldPath, newPath);
      
      renamed.push({ old: file, new: lowercase, ...result });
    }
  }
  
  return renamed;
}

renameDocsToLowercase().then(results => {
  console.log(`\nRenamed ${results.length} files`);
  results.forEach(r => {
    const method = r.method === 'git' ? '‚úì' : '‚ö†';
    console.log(`${method} ${r.new}`);
  });
}).catch(err => {
  console.error('Error:', err.message);
  process.exit(1);
});
```

Run the script:
```bash
node scripts/documentation/rename-to-lowercase.js
```

**Step 3: Verify renames**
```bash
ls docs/*.md
git status docs/
```

All docs/ markdown files should now be lowercase.
  </action>
  <verify>
Check docs directory contains only lowercase .md files:
```bash
ls docs/*.md | grep -E '[A-Z]'
```
Should return no results (empty output = success).

Verify git history preserved:
```bash
git log --follow docs/troubleshooting.md
```
Should show history from when it was TROUBLESHOOTING.md.
  </verify>
  <done>Documentation files renamed to lowercase with git history preserved, all references updated</done>
</task>

<task name="Move scripts to organized subfolders" type="auto">
  <files>scripts/, root .js files</files>
  <action>
Organize scripts into functional subfolders per CONTEXT.md decision:

**Current state:** Several scripts scattered in root and scripts/
**Target structure:**
```
scripts/
‚îú‚îÄ‚îÄ migration/       (created above)
‚îú‚îÄ‚îÄ documentation/   (doc automation)
‚îú‚îÄ‚îÄ audit/          (script analysis)
‚îú‚îÄ‚îÄ validation/     (test runners)
‚îî‚îÄ‚îÄ shared/         (common utilities)
```

**Move existing scripts:**

1. Create documentation subfolder:
```bash
mkdir -p scripts/documentation
```

2. Move/create doc-related scripts:
```bash
# If test-generate.js exists in root, move it:
[ -f test-generate.js ] && git mv test-generate.js scripts/validation/test-generate.js

# Move any existing cleanup script:
[ -f scripts/cleanup-legacy-commands.sh ] && git mv scripts/cleanup-legacy-commands.sh scripts/migration/cleanup-legacy-commands.sh
```

3. Create audit subfolder (will be used in Plan 03):
```bash
mkdir -p scripts/audit
```

4. Create validation subfolder:
```bash
mkdir -p scripts/validation
```

5. Verify structure:
```bash
tree scripts/ -L 2
```

Expected output:
```
scripts/
‚îú‚îÄ‚îÄ migration/
‚îÇ   ‚îú‚îÄ‚îÄ detect-old-structure.js
‚îÇ   ‚îú‚îÄ‚îÄ backup-handler.js
‚îÇ   ‚îú‚îÄ‚îÄ migration-flow.js
‚îÇ   ‚îî‚îÄ‚îÄ migration-prompts.js
‚îú‚îÄ‚îÄ documentation/
‚îÇ   ‚îî‚îÄ‚îÄ rename-to-lowercase.js
‚îú‚îÄ‚îÄ audit/
‚îú‚îÄ‚îÄ validation/
‚îÇ   ‚îî‚îÄ‚îÄ test-generate.js (if exists)
‚îî‚îÄ‚îÄ shared/
    ‚îú‚îÄ‚îÄ git-operations.js
    ‚îú‚îÄ‚îÄ progress-display.js
    ‚îî‚îÄ‚îÄ user-prompts.js
```
  </action>
  <verify>
Check organized structure:
```bash
ls -la scripts/*/
```

All subdirectories should exist with appropriate files.
  </verify>
  <done>Scripts organized into functional subfolders (migration/, documentation/, audit/, validation/, shared/)</done>
</task>

<task name="Commit migration mechanism and file organization" type="auto">
  <files>.planning/phases/08.1-*/8.1-01-PLAN.md</files>
  <action>
Commit all changes from this plan:

```bash
# Source git identity helpers
if ! type commit_as_user >/dev/null 2>&1; then
    source /Users/rodolfo/croonix-github/get-shit-done/.github/get-shit-done/workflows/git-identity-helpers.sh
fi

# Stage all changes
git add \
  package.json \
  package-lock.json \
  scripts/ \
  docs/ \
  bin/install.js \
  .gitignore

# Commit with user identity preserved
commit_as_user "feat(8.1): migration mechanism and file organization

Phase 8.1 Plan 01:
- Migration module: Auto-detect old structure, backup to .old-gsd-system/YYYY-MM-DD/
- Progress display with CI fallback
- Git-aware file renaming preserves history
- Docs renamed to lowercase (TROUBLESHOOTING.md ‚Üí troubleshooting.md)
- Scripts organized: migration/, documentation/, audit/, validation/, shared/
- Dependencies: fs-extra@11.3.3, prompts@2.4.2, cli-progress@3.12.0, chalk@5.6.2"
```
  </action>
  <verify>
Check commit exists:
```bash
git log -1 --oneline
```
  </verify>
  <done>Migration mechanism, file organization, and doc renaming committed</done>
</task>

## Verification Criteria

**Migration Module:**
- [ ] `scripts/migration/` contains 4 files (detect, backup, flow, prompts)
- [ ] `scripts/shared/` contains 3 files (git ops, progress, prompts)
- [ ] Old structure detection works for all 3 platforms (claude, copilot, codex)
- [ ] Backup creates date-based folders in `.old-gsd-system/`
- [ ] Progress bar shows percentage completion (or text fallback in CI)
- [ ] Migration adds `.old-gsd-system/` to .gitignore

**File Organization:**
- [ ] Documentation files in `docs/` are lowercase
- [ ] Git history preserved for renamed files (`git log --follow docs/troubleshooting.md`)
- [ ] Scripts organized in 5 subfolders (migration/, documentation/, audit/, validation/, shared/)
- [ ] All doc references updated before file renaming

**Integration:**
- [ ] `install.js` calls `runMigration()` before platform installation
- [ ] Migration runs automatically during `npm install`
- [ ] Dependencies installed: fs-extra, prompts, cli-progress, chalk

## Success Criteria

**Observable behaviors (must_haves realized):**
1. User runs `npm install get-shit-done-multi` and old structure is detected automatically ‚úì
2. Backup is created in `.old-gsd-system/YYYY-MM-DD/` before any removal ‚úì
3. Migration shows progress bar with percentage completion ‚úì
4. Files in `/docs` folder are lowercase (e.g., troubleshooting.md) ‚úì
5. Doc references updated before file renaming (no broken links) ‚úì
6. Scripts organized in functional subfolders ‚úì

## Output Artifacts

**Created:**
- `scripts/migration/detect-old-structure.js` - Old structure detection
- `scripts/migration/backup-handler.js` - Backup with date folders
- `scripts/migration/migration-flow.js` - Migration orchestrator
- `scripts/migration/migration-prompts.js` - User interaction
- `scripts/shared/git-operations.js` - Git mv wrapper
- `scripts/shared/progress-display.js` - Progress bar with CI fallback
- `scripts/shared/user-prompts.js` - Prompt helpers
- `scripts/documentation/rename-to-lowercase.js` - Doc renaming script

**Modified:**
- `bin/install.js` - Added migration detection and execution
- `docs/*.md` - Renamed to lowercase
- `package.json` - Added migration dependencies
- `.gitignore` - Added `.old-gsd-system/` exclusion

**Structure:**
- `scripts/` organized into: migration/, documentation/, audit/, validation/, shared/
