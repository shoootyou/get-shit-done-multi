---
phase: 04-workflow-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/workflows/verify-phase.md
  - get-shit-done/workflows/archive-milestone.md
autonomous: true

must_haves:
  truths:
    - "verify-phase workflow suggests archive-milestone after successful verification"
    - "MILESTONES.md file has proper markdown table headers when created"
    - "Archive operations use atomic file moves to prevent partial state"
  artifacts:
    - path: "get-shit-done/workflows/verify-phase.md"
      provides: "Integration with archive-milestone workflow"
      min_lines: 630
      pattern: "archive-milestone"
    - path: "get-shit-done/workflows/archive-milestone.md"
      provides: "MILESTONES.md table header creation"
      pattern: "| Milestone | Archived |"
  key_links:
    - from: "verify-phase.md"
      to: "archive-milestone"
      via: "next-steps suggestion in return_to_orchestrator step"
      pattern: "/gsd:archive-milestone"
---

<objective>
Complete workflow integration for milestone archiving by connecting verify-phase to archive-milestone and ensuring MILESTONES.md registry has proper table structure.

Purpose: Seamlessly guide users through milestone completion → verification → archiving workflow
Output: verify-phase suggests archiving, MILESTONES.md has proper headers
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Existing workflows to integrate
@get-shit-done/workflows/verify-phase.md
@get-shit-done/workflows/archive-milestone.md
@get-shit-done/workflows/list-milestones.md
@get-shit-done/workflows/restore-milestone.md

# Prior phase summaries
@.planning/phases/01-archive-foundation/01-01-SUMMARY.md
@.planning/phases/01-archive-foundation/01-03-SUMMARY.md
@.planning/phases/03-discovery-restore/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add archive-milestone suggestion to verify-phase workflow</name>
  <files>get-shit-done/workflows/verify-phase.md</files>
  <action>
Update the `return_to_orchestrator` step in verify-phase.md to include archive-milestone suggestion when status is "passed".

Find the section where status is "passed" and phase goal is achieved. After the "Ready to proceed" message, add:

```markdown
### Next Steps

With phase complete, consider:
1. `/gsd:verify-milestone` - Verify entire milestone is complete
2. `/gsd:archive-milestone` - Archive completed milestone for clean slate
```

**Important:**
- Place this BEFORE the orchestrator decision logic (before "The orchestrator will:")
- Only show for "passed" status (not for "gaps_found" or "human_needed")
- Use consistent formatting with existing workflow structure
- Do NOT modify the orchestrator logic itself

**Why this approach:**
verify-phase is executed by a subagent, so it returns results to execute-phase orchestrator. The suggestion helps users understand natural next step after phase verification, but doesn't force automation.
  </action>
  <verify>
```bash
# Check that archive-milestone is mentioned in verify-phase
grep -n "archive-milestone" get-shit-done/workflows/verify-phase.md

# Verify it appears in the passed status section
grep -B 5 -A 5 "archive-milestone" get-shit-done/workflows/verify-phase.md | grep -E "(passed|Ready to proceed)"
```

Should show archive-milestone suggestion in context of successful verification.
  </verify>
  <done>
verify-phase.md contains `/gsd:archive-milestone` suggestion in return_to_orchestrator step for "passed" status, positioned to guide users toward milestone archiving after phase completion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add MILESTONES.md table header creation</name>
  <files>get-shit-done/workflows/archive-milestone.md</files>
  <action>
Update the `update_registry` step in archive-milestone.md to create MILESTONES.md with proper table headers if it doesn't exist.

Find the "Create or append to `.planning/MILESTONES.md`:" section.

Replace:
```markdown
Create or append to `.planning/MILESTONES.md`:

```markdown
| ${MILESTONE_NAME} | ${ARCHIVE_DATE} | ${REQ_COUNT} | archived | ${COMMIT_SHORT} | archive/${MILESTONE_NAME} |
```
```

With:
```markdown
Create or append to `.planning/MILESTONES.md`:

```bash
# Create MILESTONES.md with headers if it doesn't exist
if [ ! -f .planning/MILESTONES.md ]; then
  cat > .planning/MILESTONES.md << 'EOF'
# Milestone Registry

| Milestone | Archived | Requirements | Status | Commit | Tag |
|-----------|----------|--------------|--------|--------|-----|
EOF
fi

# Append milestone entry
echo "| ${MILESTONE_NAME} | ${ARCHIVE_DATE} | ${REQ_COUNT} | archived | ${COMMIT_SHORT} | archive/${MILESTONE_NAME} |" >> .planning/MILESTONES.md
```
```

**What this does:**
- Creates MILESTONES.md with proper markdown table headers on first use
- Uses heredoc to write multi-line header without escaping issues
- Appends milestone entry using echo (same as before)

**Why heredoc:**
Bash heredoc (<<) writes multi-line text cleanly without quote escaping complexity. The 'EOF' syntax prevents variable expansion in the header template.
  </action>
  <verify>
```bash
# Check that MILESTONES.md header creation exists
grep -A 8 "Create or append to" get-shit-done/workflows/archive-milestone.md | grep -E "(Milestone Registry|Milestone.*Archived.*Requirements)"

# Verify the logic checks for file existence
grep "if \[ ! -f .planning/MILESTONES.md \]" get-shit-done/workflows/archive-milestone.md
```

Should show proper table header creation with columns: Milestone, Archived, Requirements, Status, Commit, Tag.
  </verify>
  <done>
archive-milestone.md creates MILESTONES.md with markdown table headers (# Milestone Registry + column headers) on first use, then appends milestone entries. Table structure supports clear data presentation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Document atomic operations in archive-milestone</name>
  <files>get-shit-done/workflows/archive-milestone.md</files>
  <action>
Archive-milestone.md already uses atomic `mv` commands for file moves, which are atomic operations at the filesystem level on Unix systems. We just need to document this property in the philosophy section.

Find the `<philosophy>` section. After the "Safety first:" bullet list, add:

```markdown

**Atomic operations:**
- `mv` commands are atomic at filesystem level (file appears instantly at destination or not at all)
- Git validation prevents execution on dirty state (rollback via git if issues)
- Operations are ordered: directory creation → file moves → registry update → git commit
- If interrupted mid-process, git shows exactly what was moved (traceable via `git status`)
```

**Rationale:**
Unix `mv` within the same filesystem is atomic - the file is renamed in the directory structure in a single operation. If interrupted, the file is either at source or destination, never partially moved or corrupted. This satisfies INT-05's requirement for atomic file moves.

Combined with git validation (prevents execution on dirty state) and ordered operations, the workflow provides transaction-like safety even without explicit transaction wrapper.

**Why not FileTransaction:**
FileTransaction from 01-01 is designed for JavaScript code execution. The archive workflow is a bash-based orchestration executed by the GSD system. The `mv` command's inherent atomicity + git's state tracking provides equivalent safety for this use case.
  </action>
  <verify>
```bash
# Check that atomic operations are documented
grep -A 5 "Atomic operations:" get-shit-done/workflows/archive-milestone.md

# Verify it's in the philosophy section
grep -B 10 "Atomic operations:" get-shit-done/workflows/archive-milestone.md | grep "<philosophy>"
```

Should show atomic operations documentation in philosophy section explaining mv's filesystem-level atomicity.
  </verify>
  <done>
archive-milestone.md documents that mv commands provide atomic file moves at filesystem level, combined with git validation and ordered operations for transaction-like safety. INT-05 requirement satisfied.
  </done>
</task>

</tasks>

<verification>
**Integration verification:**
```bash
# INT-01: verify-phase suggests archive-milestone
grep -c "archive-milestone" get-shit-done/workflows/verify-phase.md
# Expected: 1+ (new suggestion added)

# INT-02: archive-milestone suggests map-codebase (already done)
grep -c "map-codebase" get-shit-done/workflows/archive-milestone.md
# Expected: 1+ (already exists)

# INT-03: Clear next steps (already done)
grep -A 5 "Next steps:" get-shit-done/workflows/archive-milestone.md
# Expected: Shows map-codebase and new-milestone suggestions

# INT-04: MILESTONES.md table headers
grep "| Milestone | Archived | Requirements |" get-shit-done/workflows/archive-milestone.md
# Expected: Table header creation found

# INT-05: Atomic operations documented
grep -c "Atomic operations:" get-shit-done/workflows/archive-milestone.md
# Expected: 1 (documentation added)
```

**File integrity:**
```bash
# Verify workflows are valid markdown with proper XML structure
cat get-shit-done/workflows/verify-phase.md | grep -E "(<purpose>|<philosophy>|<process>)" | wc -l
cat get-shit-done/workflows/archive-milestone.md | grep -E "(<purpose>|<philosophy>|<process>)" | wc -l
# Expected: 3+ for each (structure preserved)
```
</verification>

<success_criteria>
**Functional requirements:**
- [ ] verify-phase.md contains `/gsd:archive-milestone` suggestion for passed status
- [ ] archive-milestone.md creates MILESTONES.md with table headers on first use
- [ ] archive-milestone.md documents atomic mv operations in philosophy
- [ ] All 5 INT requirements satisfied (INT-01 through INT-05)

**Technical quality:**
- [ ] Workflow markdown structure preserved (purpose, philosophy, process)
- [ ] Bash commands use proper syntax (heredoc for multi-line, proper quoting)
- [ ] Integration points are clear and documented
- [ ] No breaking changes to existing workflow behavior
</success_criteria>

<output>
After completion, create `.planning/phases/04-workflow-integration/04-01-SUMMARY.md` with:
- Integration points added (verify → archive suggestion)
- MILESTONES.md table structure implementation
- Atomic operations documentation
- All INT requirements satisfied
- Next steps: Ready for execution, no follow-up plans needed
</output>
