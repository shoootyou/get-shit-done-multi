---
phase: 03-discovery-restore
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/gsd/restore-milestone.md
  - get-shit-done/workflows/restore-milestone.md
autonomous: false

must_haves:
  truths:
    - "User can restore archived milestone with /gsd:restore-milestone [name]"
    - "Restore validates git working directory is clean before proceeding"
    - "Restore moves files from history back to .planning/ root"
    - "MILESTONES.md updated to mark milestone as restored"
  artifacts:
    - path: "commands/gsd/restore-milestone.md"
      provides: "Command entry point for restoring milestones"
      contains: "name: gsd:restore-milestone"
      min_lines: 50
    - path: "get-shit-done/workflows/restore-milestone.md"
      provides: "Workflow that validates, moves files, updates registry"
      contains: "<purpose>"
      min_lines: 120
  key_links:
    - from: "commands/gsd/restore-milestone.md"
      to: "get-shit-done/workflows/restore-milestone.md"
      via: "@get-shit-done/workflows/restore-milestone.md reference"
      pattern: "@get-shit-done/workflows/restore-milestone"
    - from: "get-shit-done/workflows/restore-milestone.md"
      to: ".planning/history/[name]/"
      via: "moves files from archive"
      pattern: "mv.*\\.planning/history"
    - from: "get-shit-done/workflows/restore-milestone.md"
      to: ".planning/MILESTONES.md"
      via: "updates milestone status to restored"
      pattern: "MILESTONES\\.md"
---

<objective>
Create command and workflow for restoring archived milestones.

Purpose: Provide safety valve for archiving operations - users can recover archived milestones if needed.
Output: Working /gsd:restore-milestone command that safely moves files back and updates registry.
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@commands/gsd/archive-milestone.md
@get-shit-done/workflows/archive-milestone.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create restore-milestone command</name>
  <files>commands/gsd/restore-milestone.md</files>
  <action>
    Create `commands/gsd/restore-milestone.md` following the archive-milestone.md pattern:
    
    Frontmatter:
    ```yaml
    ---
    name: gsd:restore-milestone
    description: Restore archived milestone from history back to active planning
    argument-hint: "[milestone-name]"
    allowed-tools:
      - Read
      - Write
      - Bash
      - AskUserQuestion
    ---
    ```
    
    Sections:
    - `<objective>`: Restore archived milestone from .planning/history/[name]/ back to .planning/
    - `<execution_context>`: Reference @get-shit-done/workflows/restore-milestone.md
    - `<context>`: 
      - Milestone name: $ARGUMENTS (required)
      - Validate .planning/history/[name]/ exists
      - Check .planning/ is empty or prompt for overwrite confirmation
    - `<process>`:
      - Step 1: Validate milestone name argument provided
      - Step 2: Check archive exists
      - Step 3: Execute restore-milestone workflow with milestone name
      - Step 4: Display results and next steps
    - `<success_criteria>`: Files moved back, MILESTONES.md updated, user informed
    
    Include:
    - Prerequisites: Archive must exist, git working directory clean
    - Error Handling: Missing archive, existing active planning, uncommitted changes
    - Related Commands: /gsd:list-milestones, /gsd:archive-milestone
    
    Follow exact structure from archive-milestone.md.
  </action>
  <verify>
    Validate command structure:
    ```bash
    grep -q "name: gsd:restore-milestone" commands/gsd/restore-milestone.md && \
    grep -q "argument-hint: \"\[milestone-name\]\"" commands/gsd/restore-milestone.md && \
    grep -q "@get-shit-done/workflows/restore-milestone.md" commands/gsd/restore-milestone.md && \
    echo "Command structure OK"
    ```
  </verify>
  <done>
    - commands/gsd/restore-milestone.md exists with proper frontmatter
    - Command requires milestone name argument
    - Command references restore-milestone.md workflow
    - Structure matches archive-milestone.md pattern
    - Validation check passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create restore-milestone workflow</name>
  <files>get-shit-done/workflows/restore-milestone.md</files>
  <action>
    Create `get-shit-done/workflows/restore-milestone.md` following archive-milestone.md workflow pattern:
    
    Structure:
    - `<purpose>`: Restore archived milestone from history to active planning
    - `<philosophy>`: Safety valve for archiving, enables recovery, maintains audit trail
    - `<process>`:
    
    Steps (mirror archive-milestone.md but in reverse):
    
    1. `<step name="validate_prerequisites">`: Git working directory check
       ```bash
       git status --porcelain
       ```
       If not clean: Display error with file list, exit. (Same as archive-milestone.md)
    
    2. `<step name="check_archive_exists">`: Verify archive directory exists
       ```bash
       ls .planning/history/[milestone-name]/ 2>/dev/null
       ```
       If missing: "Archive not found. Use /gsd:list-milestones to see available archives." Exit.
       If exists: Continue to check_conflicts.
    
    3. `<step name="check_conflicts">`: Check if .planning/ has active milestone
       ```bash
       ls .planning/ROADMAP.md .planning/STATE.md 2>/dev/null
       ```
       If files exist: Prompt "Active planning files exist. Restoring will overwrite them. Continue? (y/n)"
       If 'n': Exit with "Restore cancelled."
       If 'y' or no conflicts: Continue to confirm_intent.
    
    4. `<step name="confirm_intent">`: Prompt user for confirmation
       ```
       Restore milestone '[milestone-name]' from archive?
       
       This will move files from .planning/history/[milestone-name]/ to .planning/:
       - ROADMAP.md
       - STATE.md
       - PROJECT.md
       - REQUIREMENTS.md
       - research/
       - phases/
       
       Type 'y' to proceed, 'n' to cancel:
       ```
       Wait for user input. If not 'y': Exit.
    
    5. `<step name="move_files">`: Move files from archive to .planning/ root
       ```bash
       # Move files back (reverse of archive)
       mv .planning/history/[milestone-name]/ROADMAP.md .planning/
       mv .planning/history/[milestone-name]/STATE.md .planning/
       mv .planning/history/[milestone-name]/PROJECT.md .planning/
       mv .planning/history/[milestone-name]/REQUIREMENTS.md .planning/ 2>/dev/null || true
       mv .planning/history/[milestone-name]/research .planning/ 2>/dev/null || true
       mv .planning/history/[milestone-name]/phases .planning/ 2>/dev/null || true
       
       # Keep empty archive directory as marker
       ```
    
    6. `<step name="update_registry">`: Update MILESTONES.md to mark as restored
       ```bash
       RESTORE_DATE=$(date +%Y-%m-%d)
       
       # Find milestone row in MILESTONES.md and update status from "archived" to "restored ([date])"
       # Use sed or awk to update the status column
       ```
    
    7. `<step name="commit_restore">`: Create git commit
       ```bash
       git add .planning/ROADMAP.md .planning/STATE.md .planning/PROJECT.md .planning/REQUIREMENTS.md
       git add .planning/research/ .planning/phases/ 2>/dev/null || true
       git add .planning/MILESTONES.md
       
       git commit -m "restore: [milestone-name]
       
       Restored from .planning/history/[milestone-name]/
       Status updated in MILESTONES.md"
       ```
    
    8. `<step name="offer_next">`: Display completion message
       ```
       ✓ Milestone '[milestone-name]' restored successfully
       
       Restored to: .planning/
       Archive location: .planning/history/[milestone-name]/ (kept for reference)
       
       Next steps:
       1. Review restored planning files
       2. /gsd:resume-project - Resume work on this milestone
       
       Archive is still available in history/ for reference.
       ```
    
    - `<success_criteria>`: Files moved, MILESTONES.md updated, git commit created, user informed
    
    Follow exact XML structure from archive-milestone.md workflow.
    Use SAME validation, confirmation, and error handling patterns.
  </action>
  <verify>
    Validate workflow structure:
    ```bash
    grep -q "<step name=\"validate_prerequisites\">" get-shit-done/workflows/restore-milestone.md && \
    grep -q "<step name=\"move_files\">" get-shit-done/workflows/restore-milestone.md && \
    grep -q "git commit" get-shit-done/workflows/restore-milestone.md && \
    echo "Workflow structure OK"
    ```
  </verify>
  <done>
    - get-shit-done/workflows/restore-milestone.md exists with proper XML structure
    - Workflow validates git clean state (same as archive)
    - Workflow checks archive exists before proceeding
    - Workflow prompts for confirmation before destructive operations
    - Files moved from history/ back to .planning/ root
    - MILESTONES.md updated with restore status and date
    - Git commit created with descriptive message
    - Validation check passes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    restore-milestone command and workflow that reverses archive operations
  </what-built>
  <how-to-verify>
    1. Check command file exists and follows pattern:
       ```bash
       cat commands/gsd/restore-milestone.md | grep -A 5 "^---"
       ```
       Should show frontmatter with name: gsd:restore-milestone
    
    2. Check workflow file exists and has all steps:
       ```bash
       grep "<step name=" get-shit-done/workflows/restore-milestone.md
       ```
       Should show: validate_prerequisites, check_archive_exists, check_conflicts, confirm_intent, move_files, update_registry, commit_restore, offer_next
    
    3. Verify workflow mirrors archive-milestone.md structure:
       - Same git validation step
       - Same confirmation prompts pattern
       - Reverse file movement (history → .planning instead of .planning → history)
       - Updates MILESTONES.md (like archive does)
    
    4. Check error handling covers:
       - Missing archive directory
       - Existing active planning (conflict detection)
       - Uncommitted git changes
    
    Expected: All files exist, structure matches archive pattern, steps are complete
  </how-to-verify>
  <resume-signal>
    Type "approved" if structure is correct, or describe issues to fix
  </resume-signal>
</task>

</tasks>

<verification>
Run validation checks from both tasks.
Verify command requires milestone name argument.
Confirm workflow has all 8 steps in correct order.
Check workflow mirrors archive-milestone.md safety patterns.
</verification>

<success_criteria>
- commands/gsd/restore-milestone.md exists with argument requirement
- get-shit-done/workflows/restore-milestone.md exists with 8 process steps
- Workflow validates git clean state before operations
- Workflow checks archive exists and handles conflicts
- Workflow moves files from .planning/history/[name]/ to .planning/
- Workflow updates MILESTONES.md status to "restored ([date])"
- Workflow creates git commit with descriptive message
- All requirements REST-01 through REST-04 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-discovery-restore/03-02-SUMMARY.md` documenting:
- Command and workflow file locations
- Restore process steps (mirrors archive but reversed)
- Git validation and conflict detection approach
- MILESTONES.md update strategy (status change)
- Edge cases handled (missing archive, existing planning, git dirty)
</output>
