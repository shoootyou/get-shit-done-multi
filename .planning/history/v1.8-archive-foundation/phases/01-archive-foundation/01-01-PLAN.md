---
phase: 01-archive-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib-ghcc/git-utils.js
  - lib-ghcc/file-transaction.js
autonomous: true

must_haves:
  truths:
    - "Git operations can be performed safely with error handling"
    - "File operations are atomic and can be rolled back"
    - "Transaction failures leave repository in clean state"
  artifacts:
    - path: "lib-ghcc/git-utils.js"
      provides: "Git command wrappers"
      exports: ["getCurrentBranch", "createBranch", "deleteBranch", "checkoutBranch"]
      min_lines: 80
    - path: "lib-ghcc/file-transaction.js"
      provides: "Atomic file operations with rollback"
      exports: ["FileTransaction"]
      min_lines: 60
  key_links:
    - from: "lib-ghcc/file-transaction.js"
      to: "lib-ghcc/git-utils.js"
      via: "imports git operations"
      pattern: "require.*git-utils"
---

<objective>
Create foundational utilities for safe git operations and atomic file transactions.

Purpose: Establish reliable primitives for archive workflow that prevent partial failures and repository corruption.
Output: Tested utility modules with error handling and rollback capabilities.
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create git utility module</name>
  <files>lib-ghcc/git-utils.js</files>
  <action>
    Create `lib-ghcc/git-utils.js` with functions wrapping git operations:
    
    - `getCurrentBranch()`: Returns current branch name, throws if detached HEAD
    - `createBranch(name)`: Creates new branch from current HEAD, throws if exists
    - `deleteBranch(name, force=false)`: Deletes branch, validates not current branch
    - `checkoutBranch(name)`: Switches to branch, validates branch exists
    
    All functions should:
    - Use execa to run git commands synchronously
    - Parse stdout/stderr for meaningful errors
    - Throw descriptive errors on failure (include git output)
    - Return normalized data (trimmed strings, no ANSI codes)
    
    Include JSDoc comments for each function with @param, @returns, @throws.
  </action>
  <verify>
    Run `node -e "const g = require('./lib-ghcc/git-utils'); console.log(g.getCurrentBranch())"` 
    Should print current branch name without errors.
  </verify>
  <done>
    - lib-ghcc/git-utils.js exists with 4 exported functions
    - Each function has JSDoc documentation
    - Functions throw errors on invalid operations
    - Can successfully get current branch name
  </done>
</task>

<task type="auto">
  <name>Task 2: Create file transaction module</name>
  <files>lib-ghcc/file-transaction.js</files>
  <action>
    Create `lib-ghcc/file-transaction.js` with FileTransaction class:
    
    Class structure:
    ```javascript
    class FileTransaction {
      constructor() // Initialize empty operations queue
      write(path, content) // Queue file write
      delete(path) // Queue file deletion
      move(from, to) // Queue file move
      async commit() // Execute all operations, rollback on any failure
      async rollback() // Undo all committed operations
    }
    ```
    
    Implementation requirements:
    - Track operations in array with {type, path, content, backup} objects
    - On commit: backup existing files before modification
    - On any error: automatically rollback completed operations
    - Use fs.promises for async file operations
    - Ensure atomic execution (all succeed or all rollback)
    - Clear operations queue after successful commit
    
    Include JSDoc with usage examples showing commit/rollback flow.
  </action>
  <verify>
    Run manual test:
    ```bash
    node -e "
    const FileTransaction = require('./lib-ghcc/file-transaction.js');
    const t = new FileTransaction();
    t.write('/tmp/test.txt', 'data');
    t.commit().then(() => console.log('OK'));
    "
    ```
    Should print "OK" and create /tmp/test.txt.
  </verify>
  <done>
    - lib-ghcc/file-transaction.js exists with FileTransaction class exported
    - Class has write, delete, move, commit, rollback methods
    - Commit performs atomic operations with automatic rollback on failure
    - Operations are backed up before execution
    - Manual test successfully creates file
  </done>
</task>

</tasks>

<verification>
Run both manual verification commands from tasks.
Check that git-utils functions are exported and callable.
Check that FileTransaction can queue and commit operations.
</verification>

<success_criteria>
- lib-ghcc/git-utils.js exists with 4 git operation functions
- lib-ghcc/file-transaction.js exists with FileTransaction class
- All functions have JSDoc documentation
- Error handling prevents partial failures
- Manual tests pass without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-archive-foundation/01-01-SUMMARY.md` documenting:
- Functions created and their signatures
- Error handling approach
- Usage examples from verification
- Any edge cases discovered during implementation
</output>
