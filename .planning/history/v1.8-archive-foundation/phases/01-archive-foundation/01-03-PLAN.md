---
phase: 01-archive-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - get-shit-done/workflows/archive-milestone.js
  - commands/gsd/archive-milestone.md
autonomous: false

must_haves:
  truths:
    - "User can invoke archive command via CLI"
    - "Command validates active milestone before proceeding"
    - "User confirms archival decision interactively"
    - "Validation failures produce clear error messages"
  artifacts:
    - path: "get-shit-done/workflows/archive-milestone.js"
      provides: "Archive workflow orchestration"
      exports: ["archiveMilestone"]
      min_lines: 100
    - path: "commands/gsd/archive-milestone.md"
      provides: "CLI command registration"
      contains: "/gsd:archive-milestone"
  key_links:
    - from: "get-shit-done/workflows/archive-milestone.js"
      to: "get-shit-done/workflows/milestone-registry.js"
      via: "imports MilestoneRegistry for validation"
      pattern: "require.*milestone-registry"
    - from: "commands/gsd/archive-milestone.md"
      to: "get-shit-done/workflows/archive-milestone.js"
      via: "invokes archiveMilestone function"
      pattern: "archiveMilestone"
---

<objective>
Create archive-milestone workflow and CLI command for user-initiated archival.

Purpose: Enable users to trigger milestone archival through conversational interface with validation and confirmation.
Output: Working /gsd:archive-milestone command with dry-run mode and interactive confirmation.
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-archive-foundation/01-01-SUMMARY.md
@.planning/phases/01-archive-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create archive workflow with validation</name>
  <files>get-shit-done/workflows/archive-milestone.js</files>
  <action>
    Create `get-shit-done/workflows/archive-milestone.js` with archiveMilestone function:
    
    Function signature:
    ```javascript
    async function archiveMilestone(options = {}) {
      // options: { dryRun: false, force: false, targetMilestone: null }
      // Returns: { success: boolean, message: string, archivedId?: string }
    }
    ```
    
    Workflow steps:
    
    1. **Validation Phase**:
       - Import MilestoneRegistry from ./milestone-registry.js
       - Get active milestone using registry.getActive()
       - If no active milestone: throw "No active milestone to archive"
       - If options.targetMilestone provided: validate it exists
       - Check if milestone has incomplete phases (stub for now - log warning)
    
    2. **Confirmation Phase** (if not force):
       - Return object with needsConfirmation: true
       - Include milestone details (id, name, phase count)
       - Include warning about incomplete work if applicable
    
    3. **Dry Run Mode** (if dryRun):
       - Log all operations that WOULD be performed
       - Return { success: true, dryRun: true, operations: [...] }
       - Don't modify any files
    
    4. **Pre-Archive State** (stub):
       - Log "TODO: Create archive branch"
       - Log "TODO: Move milestone directory"
       - Log "TODO: Update STATE.md"
       - Return { success: true, message: "Archive workflow ready (stub)" }
    
    Include JSDoc with:
    - @param {Object} options - Configuration object
    - @param {boolean} options.dryRun - Preview operations without executing
    - @param {boolean} options.force - Skip confirmation prompts
    - @returns {Promise<Object>} Result with success status and message
    - @throws {Error} If validation fails
    
    Error handling:
    - Catch MilestoneRegistry errors and re-throw with context
    - Validate options object structure
    - Handle missing .planning directory gracefully
  </action>
  <verify>
    Run workflow with dry-run:
    ```bash
    node -e "
    const { archiveMilestone } = require('./get-shit-done/workflows/archive-milestone.js');
    archiveMilestone({ dryRun: true })
      .then(result => console.log(JSON.stringify(result, null, 2)));
    "
    ```
    Should show validation passing and list of stub operations.
  </verify>
  <done>
    - get-shit-done/workflows/archive-milestone.js exists with archiveMilestone function
    - Function validates active milestone using MilestoneRegistry
    - Dry-run mode shows operations without executing
    - Returns structured result object with success/message
    - Verification command runs without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CLI command registration</name>
  <files>commands/gsd/archive-milestone.md</files>
  <action>
    Create `commands/gsd/archive-milestone.md` following GSD command structure:
    
    ```markdown
    # /gsd:archive-milestone
    
    Archives the current active milestone to preserve its state and prepare for the next milestone.
    
    ## What it does
    
    1. Validates current milestone is complete and ready for archival
    2. Confirms user intent to archive (unless --force flag used)
    3. Creates archive branch with milestone snapshot
    4. Moves milestone directory to archives/
    5. Updates STATE.md to clear active milestone
    6. Commits archive transaction atomically
    
    ## Usage
    
    ```
    /gsd:archive-milestone [options]
    ```
    
    ## Options
    
    - `--dry-run` - Preview archive operations without executing
    - `--force` - Skip confirmation prompt
    - `--milestone=<id>` - Archive specific milestone (defaults to active)
    
    ## Examples
    
    Preview what would be archived:
    ```
    /gsd:archive-milestone --dry-run
    ```
    
    Archive with confirmation:
    ```
    /gsd:archive-milestone
    ```
    
    Force archive without prompt:
    ```
    /gsd:archive-milestone --force
    ```
    
    ## Prerequisites
    
    - Active milestone must exist in STATE.md
    - Working directory must be clean (no uncommitted changes)
    - .planning/ directory must be initialized
    
    ## Output
    
    - Archive branch created: `archive/milestone-{id}-{timestamp}`
    - Milestone moved to: `.planning/archives/{id}/`
    - STATE.md updated: `active_milestone` cleared
    - Git commit created with archive transaction
    
    ## Error Handling
    
    - No active milestone: Exits with clear error message
    - Uncommitted changes: Prompts user to commit or stash
    - Archive directory conflict: Suggests manual cleanup
    - Transaction failure: Automatically rolls back all operations
    
    ## Related Commands
    
    - `/gsd:new-milestone` - Create new milestone after archiving
    - `/gsd:list-milestones` - View all milestones including archived
    - `/gsd:restore-milestone` - Restore from archive (future)
    ```
    
    Follow command documentation patterns from other GSD commands.
    Use clear, user-friendly language.
    Include error scenarios and solutions.
  </action>
  <verify>
    Check command file exists and is properly formatted:
    ```bash
    cat commands/gsd/archive-milestone.md | head -20
    ```
    Should show command header and description.
  </verify>
  <done>
    - commands/gsd/archive-milestone.md exists with complete documentation
    - Command usage and options clearly documented
    - Examples cover common use cases (dry-run, force, default)
    - Prerequisites and error handling documented
    - Verification shows proper markdown structure
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Archive milestone workflow and CLI command with validation:
    - archiveMilestone function with dry-run and force options
    - MilestoneRegistry integration for validation
    - CLI command documentation with usage examples
  </what-built>
  <how-to-verify>
    Test the workflow integration:
    
    1. Run dry-run mode:
       ```bash
       node -e "
       const { archiveMilestone } = require('./get-shit-done/workflows/archive-milestone.js');
       archiveMilestone({ dryRun: true })
         .then(result => console.log(JSON.stringify(result, null, 2)))
         .catch(err => console.error('Error:', err.message));
       "
       ```
       Expected: Shows validation passed, lists stub operations, returns success
    
    2. Check command documentation:
       ```bash
       cat commands/gsd/archive-milestone.md
       ```
       Expected: Complete documentation with usage, options, examples
    
    3. Verify integration points:
       ```bash
       grep -n "MilestoneRegistry" get-shit-done/workflows/archive-milestone.js
       grep -n "archiveMilestone" commands/gsd/archive-milestone.md
       ```
       Expected: Workflow imports registry, command references workflow
    
    Confirm:
    - Dry-run works without errors
    - Validation detects active milestone
    - Command documentation is complete and clear
    - Error messages are helpful
  </how-to-verify>
  <resume-signal>
    Type "approved" if verification passed, or describe any issues found for revision.
  </resume-signal>
</task>

</tasks>

<verification>
Run all three verification steps from Task 3 checkpoint.
Confirm workflow validates active milestone correctly.
Confirm dry-run mode shows operations without executing.
Confirm command documentation is complete.
</verification>

<success_criteria>
- get-shit-done/workflows/archive-milestone.js exists with archiveMilestone function
- Function integrates MilestoneRegistry for validation
- Dry-run mode previews operations safely
- Force mode skips confirmation
- commands/gsd/archive-milestone.md documents command fully
- Verification tests pass with expected output
- User can invoke command via CLI (documented path)
</success_criteria>

<output>
After completion, create `.planning/phases/01-archive-foundation/01-03-SUMMARY.md` documenting:
- Archive workflow implementation and validation logic
- Command options and usage patterns
- Integration with MilestoneRegistry
- Stub operations that will be implemented in future phases
- Verification test results
</output>
