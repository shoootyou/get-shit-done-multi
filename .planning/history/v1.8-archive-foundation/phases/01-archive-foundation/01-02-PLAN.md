---
phase: 01-archive-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - get-shit-done/workflows/milestone-registry.js
autonomous: true

must_haves:
  truths:
    - "System can track which milestone is currently active"
    - "Active milestone changes are persisted to STATE.md"
    - "Invalid milestone IDs are rejected with clear errors"
  artifacts:
    - path: "get-shit-done/workflows/milestone-registry.js"
      provides: "Milestone tracking and persistence"
      exports: ["MilestoneRegistry"]
      min_lines: 120
  key_links:
    - from: "get-shit-done/workflows/milestone-registry.js"
      to: ".planning/STATE.md"
      via: "reads/writes active_milestone field"
      pattern: "active_milestone"
    - from: "get-shit-done/workflows/milestone-registry.js"
      to: "lib-ghcc/file-transaction.js"
      via: "uses for atomic STATE.md updates"
      pattern: "FileTransaction"
---

<objective>
Create milestone registry for tracking active milestone and coordinating lifecycle transitions.

Purpose: Enable system to maintain single active milestone and provide lookup/validation before archival.
Output: MilestoneRegistry class with getActive, setActive, validateExists methods.
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-archive-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create milestone registry module</name>
  <files>get-shit-done/workflows/milestone-registry.js</files>
  <action>
    Create `get-shit-done/workflows/milestone-registry.js` with MilestoneRegistry class:
    
    Class structure:
    ```javascript
    class MilestoneRegistry {
      constructor(planningDir = '.planning') // Initialize with planning directory path
      
      async getActive() 
      // Returns {id, name, status} of current active milestone from STATE.md
      // Throws if no active milestone or STATE.md missing
      
      async setActive(milestoneId)
      // Updates STATE.md active_milestone field using FileTransaction
      // Validates milestone exists in milestones/ before updating
      // Throws if milestone ID invalid or directory missing
      
      async validateExists(milestoneId)
      // Checks if .planning/milestones/{id}/ directory exists
      // Returns true/false
      
      async listAll()
      // Returns array of all milestone IDs from milestones/ directory
      // Returns empty array if milestones/ doesn't exist
    }
    ```
    
    Implementation details:
    - Import FileTransaction from ../../lib-ghcc/file-transaction.js
    - Parse STATE.md as YAML to read/write active_milestone field
    - Use fs.promises.readdir to list milestone directories
    - Validate milestone ID format (alphanumeric + hyphens only)
    - Use FileTransaction for all STATE.md writes (atomic updates)
    - Include comprehensive JSDoc with @param, @returns, @throws
    
    Error messages should be specific:
    - "No active milestone set in STATE.md"
    - "Milestone {id} not found in .planning/milestones/"
    - "Invalid milestone ID format: {id}"
  </action>
  <verify>
    Run integration test:
    ```bash
    node -e "
    const MilestoneRegistry = require('./get-shit-done/workflows/milestone-registry.js');
    const registry = new MilestoneRegistry();
    registry.getActive().then(m => console.log('Active:', m.id));
    "
    ```
    Should print current active milestone from STATE.md.
  </verify>
  <done>
    - get-shit-done/workflows/milestone-registry.js exists with MilestoneRegistry class
    - Class exports getActive, setActive, validateExists, listAll methods
    - Uses FileTransaction for atomic STATE.md updates
    - Validates milestone existence before updates
    - Integration test successfully reads active milestone
  </done>
</task>

<task type="auto">
  <name>Task 2: Add error handling and edge cases</name>
  <files>get-shit-done/workflows/milestone-registry.js</files>
  <action>
    Enhance MilestoneRegistry with robust error handling:
    
    Add validation for:
    - STATE.md missing or unparseable (throw descriptive error)
    - active_milestone field missing (return null from getActive)
    - Milestone directory permissions (catch EACCES)
    - Concurrent writes to STATE.md (FileTransaction handles this)
    - Empty milestone ID (throw before validation)
    - Milestone ID with invalid characters (/, .., etc)
    
    Add helper methods:
    - `_parseSTATE()`: Reads and parses STATE.md, caches result
    - `_validateMilestoneId(id)`: Regex validation for safe IDs
    - `_getMilestonePath(id)`: Returns full path to milestone directory
    
    Update JSDoc with edge case documentation and examples showing:
    - Handling missing STATE.md
    - Checking if milestone exists before operations
    - Proper error catching patterns
  </action>
  <verify>
    Run edge case tests:
    ```bash
    node -e "
    const MilestoneRegistry = require('./get-shit-done/workflows/milestone-registry.js');
    const r = new MilestoneRegistry();
    r.validateExists('nonexistent-milestone-12345')
      .then(exists => console.log('Exists:', exists)); // Should print false
    "
    ```
  </verify>
  <done>
    - MilestoneRegistry handles missing STATE.md gracefully
    - Milestone ID validation rejects unsafe characters
    - Error messages are specific and actionable
    - Edge case test correctly returns false for nonexistent milestone
    - Helper methods improve code organization
  </done>
</task>

</tasks>

<verification>
Run both verification commands from tasks.
Test getActive() with current STATE.md.
Test validateExists() with both real and fake milestone IDs.
Check that setActive() would use FileTransaction (code review).
</verification>

<success_criteria>
- get-shit-done/workflows/milestone-registry.js exists with complete MilestoneRegistry class
- All methods have JSDoc documentation with examples
- Uses FileTransaction for atomic STATE.md updates
- Validates milestone existence and ID format
- Handles edge cases (missing files, invalid IDs)
- Integration tests pass with real STATE.md
</success_criteria>

<output>
After completion, create `.planning/phases/01-archive-foundation/01-02-SUMMARY.md` documenting:
- MilestoneRegistry API and method signatures
- State persistence approach (FileTransaction usage)
- Validation logic and error handling
- Example usage patterns for other workflows
</output>
