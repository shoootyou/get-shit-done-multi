---
phase: 02.1-exclusion-enforcement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/workflows/map-codebase.md
  - agents/gsd-codebase-mapper.md
autonomous: false

must_haves:
  truths:
    - "Empty directory with only .github/ produces documents with 0 files found"
    - "Agent uses exclusion list in all Grep/Glob/Bash tool calls"
    - "Workflow passes explicit exclusion list to each agent spawn"
    - "Custom .planning/map-config.json patterns are respected"
  artifacts:
    - path: "get-shit-done/workflows/map-codebase.md"
      provides: "Exclusion list builder and agent spawn logic"
      contains: "build_exclusion_list"
      min_lines: 300
    - path: "agents/gsd-codebase-mapper.md"
      provides: "Agent instructions using exclusion parameter"
      contains: "EXCLUDE_DIRS"
      min_lines: 900
  key_links:
    - from: "get-shit-done/workflows/map-codebase.md"
      to: "agents/gsd-codebase-mapper.md"
      via: "exclusion list in spawn prompt"
      pattern: "EXCLUDE_DIRS=.*spawn.*gsd-codebase-mapper"
---

<objective>
Fix exclusion enforcement in map-codebase workflow so agents actually exclude infrastructure directories when exploring codebase.

**Purpose:** Phase 2 was marked complete but exclusions don't work in practice. Agents ignore vague "Apply exclusions (see instructions)" directive and scan .github, .claude, .codex directories because they use Grep/Glob tools directly without exclusion parameters.

**Output:** Workflow that builds explicit exclusion list and passes it to each agent; agents that use the list in all tool calls.
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/debug/inconsistent-exclusions.md
@get-shit-done/workflows/map-codebase.md
@agents/gsd-codebase-mapper.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add exclusion list builder to workflow</name>
  <files>get-shit-done/workflows/map-codebase.md</files>
  <action>
Add new `build_exclusion_list` step BEFORE `spawn_agents` in map-codebase.md workflow.

**Location:** Insert after `check_config` step, before `spawn_agents` step.

**Implementation:**
1. Create new step that builds comma-separated exclusion list:
   - Default patterns: `.claude,.github,.codex,node_modules,.git,dist,build,out,target,coverage`
   - Load .gitignore patterns if file exists (parse and convert to comma-separated list)
   - Load .planning/map-config.json patterns if file exists (read JSON and extract exclude array)
   - Combine all patterns into single comma-separated string

2. Store result in bash variable `EXCLUDE_DIRS` for use in spawn_agents step

**Bash code pattern:**
```bash
# Build complete exclusion list
EXCLUDE_DIRS=".claude,.github,.codex,node_modules,.git,dist,build,out,target,coverage"

# Add .gitignore patterns
if [ -f .gitignore ]; then
  GITIGNORE_PATTERNS=$(grep -v '^#' .gitignore | grep -v '^$' | tr '\n' ',' | sed 's/,$//')
  if [ -n "$GITIGNORE_PATTERNS" ]; then
    EXCLUDE_DIRS="${EXCLUDE_DIRS},${GITIGNORE_PATTERNS}"
  fi
fi

# Add custom patterns from map-config.json
if [ -f .planning/map-config.json ]; then
  CUSTOM_PATTERNS=$(cat .planning/map-config.json | grep -oP '"exclude":\s*\[\s*\K[^\]]+' | tr -d '"' | tr -d ' ')
  if [ -n "$CUSTOM_PATTERNS" ]; then
    EXCLUDE_DIRS="${EXCLUDE_DIRS},${CUSTOM_PATTERNS}"
  fi
fi

echo "Exclusion list built: ${EXCLUDE_DIRS}"
```

**Why this approach:**
- Bash variable accessible in same workflow session
- Comma-separated format works for both Grep --exclude-dir and agent prompts
- Explicit list leaves no room for agent interpretation
  </action>
  <verify>
```bash
# Verify step exists in workflow
grep -A 20 "build_exclusion_list" get-shit-done/workflows/map-codebase.md

# Verify EXCLUDE_DIRS variable is set
grep "EXCLUDE_DIRS=" get-shit-done/workflows/map-codebase.md
```
  </verify>
  <done>
build_exclusion_list step exists between check_config and spawn_agents, builds EXCLUDE_DIRS variable from defaults + .gitignore + custom config
  </done>
</task>

<task type="auto">
  <name>Task 2: Pass exclusion list to agent spawns</name>
  <files>get-shit-done/workflows/map-codebase.md</files>
  <action>
Update all 4 agent spawn prompts in `spawn_agents` step to include explicit exclusion parameter.

**Location:** spawn_agents step, all 4 prompts (tech, arch, quality, concerns)

**Changes to each spawn prompt:**
Add this section BEFORE "Explore thoroughly" line:

```
**EXCLUDE these directories:** ${EXCLUDE_DIRS}

When using tools:
- Grep tool: Use path parameter to exclude these directories
- Glob tool: Verify results don't include excluded paths
- Bash tool: Use find/grep with -not -path patterns for each excluded dir
```

**Example for tech focus prompt:**
```
Focus: tech

Analyze this codebase for technology stack and external integrations.

Write these documents to .planning/codebase/:
- STACK.md - Languages, runtime, frameworks, dependencies, configuration
- INTEGRATIONS.md - External APIs, databases, auth providers, webhooks

**EXCLUDE these directories:** ${EXCLUDE_DIRS}

When using tools:
- Grep tool: Use path parameter to exclude these directories
- Glob tool: Verify results don't include excluded paths
- Bash tool: Use find/grep with -not -path patterns for each excluded dir

Explore thoroughly. Write documents directly using templates. Return confirmation only.
```

**Apply same pattern to arch, quality, and concerns prompts.**

**Why this works:**
- Explicit parameter in prompt (not vague "see instructions")
- Tool-specific guidance for Grep, Glob, Bash
- Agent receives exclusion list directly from workflow
  </action>
  <verify>
```bash
# Verify all 4 spawn prompts include EXCLUDE_DIRS
grep -c "EXCLUDE these directories.*EXCLUDE_DIRS" get-shit-done/workflows/map-codebase.md
# Should output: 4 (one for each agent)

# Verify tool-specific guidance exists
grep -c "Grep tool: Use path parameter" get-shit-done/workflows/map-codebase.md
# Should output: 4
```
  </verify>
  <done>
All 4 agent spawn prompts include "EXCLUDE these directories: ${EXCLUDE_DIRS}" parameter with tool-specific usage guidance
  </done>
</task>

<task type="auto">
  <name>Task 3: Update agent to use exclusion parameter</name>
  <files>agents/gsd-codebase-mapper.md</files>
  <action>
Update gsd-codebase-mapper agent to use exclusion parameter from spawn prompt instead of loading exclusions itself.

**Changes:**

1. **Update `load_exclusions` step (lines ~82-119):**
   - Replace entire step with simpler version that parses EXCLUDE_DIRS from prompt
   - Remove .gitignore loading (workflow handles this)
   - Remove map-config.json loading (workflow handles this)

   **New load_exclusions step:**
   ```markdown
   <step name="parse_exclusions">
   Parse exclusion list from spawn prompt parameter.
   
   The workflow passes exclusion list as: **EXCLUDE these directories:** .claude,.github,...
   
   Extract comma-separated list and store for use in exploration commands.
   
   **For Bash commands:**
   - Convert each dir to `-not -path '*/DIR/*'` format
   - Example: `.github` becomes `-not -path '*/.github/*'`
   
   **For Grep commands:**
   - Use `--exclude-dir={dir1,dir2,...}` format
   - Example: `--exclude-dir={.github,.claude,.codex,...}`
   
   **For Glob commands:**
   - Verify results don't include excluded paths
   - Filter out any matches in excluded directories
   </step>
   ```

2. **Update `explore_codebase` step (lines ~121-341):**
   - Keep existing bash command examples (they already have exclusions)
   - Update top CRITICAL note to reference parameter from prompt:

   **Replace existing CRITICAL note (lines ~124-128):**
   ```markdown
   **CRITICAL: Apply exclusions from spawn prompt:**
   The workflow provides: **EXCLUDE these directories:** [list]
   
   Use this list in ALL tool calls:
   - Grep tool: `--exclude-dir={dirs from list}`
   - Glob tool: Verify results don't include excluded paths
   - Bash tool: Add `-not -path '*/DIR/*'` for each excluded dir
   
   Example exclusions: .claude, .github, .codex, node_modules, .git, dist, build, out, target, coverage
   ```

**Why this works:**
- Single source of truth (workflow builds list)
- Agent receives explicit list, no interpretation needed
- Simpler agent logic (no file loading)
  </action>
  <verify>
```bash
# Verify parse_exclusions step exists
grep -A 10 "parse_exclusions" agents/gsd-codebase-mapper.md

# Verify updated CRITICAL note references spawn prompt
grep -A 5 "CRITICAL.*spawn prompt" agents/gsd-codebase-mapper.md

# Verify load_exclusions step is gone
grep -c "load_exclusions" agents/gsd-codebase-mapper.md
# Should output: 0
```
  </verify>
  <done>
Agent parse_exclusions step extracts list from spawn prompt parameter; explore_codebase step references this list; no more file loading logic in agent
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Fixed exclusion enforcement in map-codebase workflow:
- Workflow builds exclusion list from defaults + .gitignore + custom config
- Workflow passes explicit EXCLUDE_DIRS to each agent spawn
- Agent parses exclusion list from prompt parameter
- Agent applies exclusions in all Grep/Glob/Bash tool calls
  </what-built>
  <how-to-verify>
**Test Case 1: Empty directory with infrastructure only**

```bash
# Create test environment
mkdir /tmp/gsd-exclusion-test
cd /tmp/gsd-exclusion-test
git init

# Create only infrastructure directories
mkdir -p .github/workflows .claude .codex
echo "test: workflow" > .github/workflows/test.yml
echo "test: claude" > .claude/config.json
echo "test: codex" > .codex/settings.json

# Copy GSD into this test directory
cp -r /Users/rodolfo/croonix-github/get-shit-done/.github .
cp -r /Users/rodolfo/croonix-github/get-shit-done/.planning .
cp -r /Users/rodolfo/croonix-github/get-shit-done/get-shit-done .
cp -r /Users/rodolfo/croonix-github/get-shit-done/agents .

# Run map-codebase
# (Would need to invoke via GSD CLI)
```

**Expected results in .planning/codebase/ documents:**
- STACK.md: "Files analyzed: 0 files" or "Not detected"
- ARCHITECTURE.md: "Source files: 0 files"
- STRUCTURE.md: "Total files: 0 files"
- CONVENTIONS.md: "Files reviewed: 0 source files"
- TESTING.md: "Test files: 0 files"
- INTEGRATIONS.md: No .github infrastructure mentioned
- CONCERNS.md: "Files scanned: 0 files"

**Test Case 2: Verify .gitignore respected**

```bash
# Add .gitignore
cat > .gitignore << 'EOF'
vendor/
*.log
temp/
EOF

# Create vendor directory with code
mkdir -p vendor/package
echo "export const vendored = true;" > vendor/package/index.js

# Run map-codebase again
```

**Expected:** vendor/ files not counted in metrics

**Test Case 3: Verify custom config respected**

```bash
# Add custom exclusions
mkdir -p .planning
cat > .planning/map-config.json << 'EOF'
{
  "exclude": ["generated/", "*.generated.*"]
}
EOF

# Create generated directory
mkdir -p generated
echo "export const generated = true;" > generated/code.ts

# Run map-codebase again
```

**Expected:** generated/ files not counted in metrics

**Verification checklist:**
- [ ] Empty dir test produces 0 files across all 7 documents
- [ ] .gitignore patterns excluded from analysis
- [ ] Custom map-config.json patterns excluded
- [ ] No .github, .claude, .codex files mentioned in any document
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe issues found
  </resume-signal>
</task>

</tasks>

<verification>
**Overall phase verification:**

1. Run map-codebase in test environment (empty dir with .github/)
2. Check all 7 documents show 0 files analyzed
3. Verify exclusion list visible in workflow output
4. Verify agent spawn prompts include EXCLUDE_DIRS parameter
5. Grep agent markdown to confirm exclusion logic updated
</verification>

<success_criteria>
- [ ] build_exclusion_list step exists in map-codebase.md
- [ ] EXCLUDE_DIRS variable built from defaults + .gitignore + custom config
- [ ] All 4 agent spawn prompts include "EXCLUDE these directories: ${EXCLUDE_DIRS}"
- [ ] Agent parse_exclusions step extracts list from prompt
- [ ] Agent applies exclusions in all tool calls (Grep, Glob, Bash)
- [ ] Empty directory test produces 0 files in all documents
- [ ] .gitignore patterns respected
- [ ] Custom .planning/map-config.json patterns respected
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-exclusion-enforcement/02.1-01-SUMMARY.md`

Follow standard SUMMARY.md template with:
- Files modified: workflow + agent
- Tests performed: empty dir, .gitignore, custom config
- Verification: FIX-01 through FIX-04 coverage
- Affects: Phase 3, 4 (clean codebase maps for future work)
</output>
