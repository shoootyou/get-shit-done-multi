---
phase: 02-codebase-mapping-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/gsd-codebase-mapper.md
  - get-shit-done/workflows/map-codebase.md
autonomous: true

must_haves:
  truths:
    - "map-codebase excludes .claude, .github, .codex, node_modules, .git from analysis"
    - "map-codebase excludes dist, build, out, target, coverage from analysis"
    - "map-codebase respects .gitignore patterns when analyzing codebase"
    - "map-codebase reads .planning/map-config.json for custom exclusion patterns (optional)"
  artifacts:
    - path: "agents/gsd-codebase-mapper.md"
      provides: "Exclusion logic in agent exploration"
      min_lines: 750
      contains: "exclusion patterns"
    - path: "get-shit-done/workflows/map-codebase.md"
      provides: "Config file reading before agent spawn"
      contains: "map-config.json"
  key_links:
    - from: "get-shit-done/workflows/map-codebase.md"
      to: ".planning/map-config.json"
      via: "bash read config before spawning agents"
      pattern: "cat.*map-config\\.json"
    - from: "agents/gsd-codebase-mapper.md"
      to: "exclusion patterns"
      via: "grep/glob commands with exclusion flags"
      pattern: "--exclude.*node_modules"
---

<objective>
Implement exclusion system for codebase mapping that excludes infrastructure directories, respects .gitignore patterns, and supports custom exclusions via config file.

Purpose: Ensure codebase analysis reflects application code only, not tooling/infrastructure
Output: Updated agent and workflow with exclusion logic, config file support
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Architecture context
@agents/gsd-codebase-mapper.md
@get-shit-done/workflows/map-codebase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update gsd-codebase-mapper with exclusion patterns</name>
  <files>agents/gsd-codebase-mapper.md</files>
  <action>
Modify the `<process>` section in gsd-codebase-mapper.md to add exclusion logic:

1. Add new step after `parse_focus` called `load_exclusions`:
   - Read default exclusions: .claude, .github, .codex, node_modules, .git, dist, build, out, target, coverage
   - Load .gitignore patterns if file exists: `cat .gitignore 2>/dev/null`
   - Load custom patterns from .planning/map-config.json if exists (format: {"exclude": ["pattern1", "pattern2"]})
   - Combine all exclusions into bash-compatible patterns

2. Update `explore_codebase` step to apply exclusions in all commands:
   - For `find` commands: Add `-not -path '*/node_modules/*' -not -path '*/.git/*' -not -path '*/.claude/*' -not -path '*/.github/*' -not -path '*/.codex/*' -not -path '*/dist/*' -not -path '*/build/*' -not -path '*/out/*' -not -path '*/target/*' -not -path '*/coverage/*'`
   - For `grep` commands: Add `--exclude-dir={node_modules,.git,.claude,.github,.codex,dist,build,out,target,coverage}`
   - For `ls` commands: Use grep to filter out excluded paths in multi-line output
   - Add comment explaining why each pattern is excluded

3. Update exploration bash examples in all four focus areas (tech, arch, quality, concerns) to include exclusion patterns

4. Add note in `<philosophy>` section: "Exclude infrastructure directories to focus on application code only"

**Why exclude these patterns:**
- .claude, .github, .codex: CLI tooling, not application code
- node_modules, .git: Dependencies and version control
- dist, build, out, target, coverage: Generated artifacts

**Avoid:** Don't exclude src/, app/, lib/ or other common application directories
</action>
  <verify>
```bash
# Verify exclusion patterns present in agent
grep -n "exclude.*node_modules\|exclude-dir" agents/gsd-codebase-mapper.md
grep -n "map-config.json" agents/gsd-codebase-mapper.md
grep -n ".gitignore" agents/gsd-codebase-mapper.md

# Verify all focus areas have exclusion patterns
grep -A 20 "For tech focus:" agents/gsd-codebase-mapper.md | grep "exclude"
grep -A 20 "For arch focus:" agents/gsd-codebase-mapper.md | grep "exclude"
```
</verify>
  <done>
Agent file contains:
- load_exclusions step with default patterns, .gitignore parsing, map-config.json support
- All find/grep commands in explore_codebase include exclusion flags
- All four focus areas (tech, arch, quality, concerns) use exclusion patterns
</done>
</task>

<task type="auto">
  <name>Task 2: Update map-codebase workflow to support config file</name>
  <files>get-shit-done/workflows/map-codebase.md</files>
  <action>
Modify map-codebase.md workflow to check for optional config file before spawning agents:

1. Add new step after `create_structure` called `check_config`:
   ```bash
   # Check for optional exclusion config
   if [ -f .planning/map-config.json ]; then
     echo "Found custom exclusion config: .planning/map-config.json"
     cat .planning/map-config.json
   else
     echo "No custom config - using defaults (.claude, .github, .codex, node_modules, .git, dist, build, out, target, coverage)"
   fi
   ```

2. Update agent spawn prompts to mention config support:
   - Add to each agent prompt: "Apply exclusion patterns (see load_exclusions step in your instructions). If .planning/map-config.json exists, include custom patterns."

3. Add config file format documentation in workflow comment before spawn_agents step:
   ```
   # Config file format (.planning/map-config.json):
   # {
   #   "exclude": [
   #     "additional-pattern",
   #     "vendor/",
   #     "*.generated.*"
   #   ]
   # }
   ```

4. Update `offer_next` step to mention config option:
   - Add: "**Customize exclusions:** Create `.planning/map-config.json` with additional patterns"

**Avoid:** Don't make config file required. It's optional for advanced users only.
</action>
  <verify>
```bash
# Verify config check step added
grep -n "map-config.json" get-shit-done/workflows/map-codebase.md
grep -A 5 "check_config" get-shit-done/workflows/map-codebase.md

# Verify agent prompts mention config
grep -B 2 -A 5 "spawn_agents" get-shit-done/workflows/map-codebase.md | grep -i "exclusion\|config"
```
</verify>
  <done>
Workflow file contains:
- check_config step that reads map-config.json if present
- Agent spawn prompts mention exclusion patterns and config support
- Config file format documented in comments
- offer_next mentions customization option
</done>
</task>

<task type="auto">
  <name>Task 3: Create example map-config.json template</name>
  <files>get-shit-done/templates/map-config.example.json</files>
  <action>
Create a template config file showing the format:

```json
{
  "$schema": "https://json-schema.org/draft-07/schema",
  "description": "Custom exclusion patterns for codebase mapping",
  "exclude": [
    "vendor/",
    "third_party/",
    "*.generated.*",
    "**/__generated__/**"
  ]
}
```

Add comment at top explaining:
- Copy to .planning/map-config.json to use
- Patterns added to defaults (.claude, .github, .codex, node_modules, .git, dist, build, out, target, coverage)
- Supports glob patterns

**Location:** get-shit-done/templates/ (existing template directory)
</action>
  <verify>
```bash
# Verify template exists
ls -la get-shit-done/templates/map-config.example.json
cat get-shit-done/templates/map-config.example.json
```
</verify>
  <done>
Template file exists in get-shit-done/templates/ with:
- JSON format with "exclude" array
- Example patterns showing glob support
- Clear comments explaining usage
</done>
</task>

</tasks>

<verification>
Overall phase checks:

```bash
# Test exclusion patterns work
cd /tmp && mkdir test-map && cd test-map
mkdir -p src/app node_modules .github dist
echo "app code" > src/app/index.ts
echo "dep code" > node_modules/lib.js
echo "build code" > dist/bundle.js

# Run grep with exclusion patterns from agent
grep -r "code" . --exclude-dir={node_modules,dist,.github} --include="*.ts" --include="*.js"
# Should only find src/app/index.ts, not node_modules or dist

cd - && rm -rf /tmp/test-map
```

Test config file parsing:
```bash
# Create test config
echo '{"exclude": ["test-pattern/"]}' > /tmp/test-config.json
cat /tmp/test-config.json | grep -o '"exclude"'
rm /tmp/test-config.json
```
</verification>

<success_criteria>
- agents/gsd-codebase-mapper.md contains load_exclusions step with default patterns, .gitignore support, config file support
- All exploration commands (find, grep, ls) in agent use exclusion patterns
- get-shit-done/workflows/map-codebase.md checks for map-config.json before spawning agents
- Template config file exists showing format
- Default exclusions cover: .claude, .github, .codex, node_modules, .git, dist, build, out, target, coverage
- Requirements MAP-01 through MAP-08 satisfied (exclusion system complete)
</success_criteria>

<output>
After completion, create `.planning/phases/02-codebase-mapping-enhancement/02-01-SUMMARY.md`
</output>
