---
phase: 02-codebase-mapping-enhancement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/gsd-codebase-mapper.md
  - get-shit-done/workflows/map-codebase.md
autonomous: true

must_haves:
  truths:
    - "STRUCTURE.md includes directory tree visualization showing analyzed files only"
    - "All codebase documents include file count and line count metrics"
    - "Metrics reflect excluded directories (infrastructure not counted)"
  artifacts:
    - path: "agents/gsd-codebase-mapper.md"
      provides: "Tree generation and metrics collection logic"
      contains: "tree command"
      min_lines: 750
    - path: "get-shit-done/workflows/map-codebase.md"
      provides: "Summary with aggregated metrics"
      contains: "wc -l"
  key_links:
    - from: "agents/gsd-codebase-mapper.md (arch focus)"
      to: ".planning/codebase/STRUCTURE.md"
      via: "tree command with exclusions"
      pattern: "tree.*-I.*node_modules"
    - from: "agents/gsd-codebase-mapper.md (all focus)"
      to: "metrics in each document"
      via: "wc -l and find | wc -l commands"
      pattern: "wc -l"
---

<objective>
Add metrics collection and directory tree visualization to codebase mapping, ensuring counts reflect excluded directories (application code only).

Purpose: Provide quantitative insights into codebase size and structure for planning decisions
Output: Enhanced documents with metrics, STRUCTURE.md with tree visualization
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Architecture context
@agents/gsd-codebase-mapper.md
@get-shit-done/workflows/map-codebase.md
@.planning/codebase/STRUCTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tree visualization to arch focus in agent</name>
  <files>agents/gsd-codebase-mapper.md</files>
  <action>
Modify gsd-codebase-mapper.md to generate directory tree in STRUCTURE.md:

1. Update "For arch focus:" exploration section to add tree command:
   ```bash
   # Generate directory tree (excluding infrastructure)
   tree -L 3 -I 'node_modules|.git|.github|.claude|.codex|dist|build|out|target|coverage' --charset ascii 2>/dev/null || \
     find . -type d -not -path '*/node_modules/*' -not -path '*/.git/*' -not -path '*/.github/*' -not -path '*/.claude/*' -not -path '*/.codex/*' -not -path '*/dist/*' -not -path '*/build/*' -not -path '*/out/*' -not -path '*/target/*' -not -path '*/coverage/*' | head -100
   ```

2. Update STRUCTURE.md template to include metrics section before "Directory Layout":
   ```markdown
   ## Codebase Metrics
   
   **Analysis Date:** [YYYY-MM-DD]
   
   **Files Analyzed:**
   - Total files: [N] files
   - Source files: [N] files
   - Test files: [N] files
   - Config files: [N] files
   
   **Lines of Code:**
   - Total: [N] lines
   - Source: [N] lines
   - Tests: [N] lines
   
   **Excluded from analysis:**
   - Infrastructure: .claude, .github, .codex, node_modules, .git
   - Build artifacts: dist, build, out, target, coverage
   ```

3. Add bash commands in arch focus exploration to collect metrics:
   ```bash
   # Count files by type (excluding infrastructure)
   find . -type f -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | \
     grep -v "node_modules\|\.git\|\.github\|\.claude\|\.codex\|dist\|build\|out\|target\|coverage" | wc -l
   
   find . -type f -name "*.test.*" -o -name "*.spec.*" | \
     grep -v "node_modules\|\.git\|\.github\|\.claude\|\.codex\|dist\|build\|out\|target\|coverage" | wc -l
   
   # Count total lines (excluding infrastructure)
   find . -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" \) | \
     grep -v "node_modules\|\.git\|\.github\|\.claude\|\.codex\|dist\|build\|out\|target\|coverage" | \
     xargs wc -l 2>/dev/null | tail -1
   ```

4. Update STRUCTURE.md template section "## Directory Layout" to use actual tree output:
   - Replace placeholder tree with: "Insert tree command output here (use ```plaintext wrapper)"
   - Add note: "Generated with: tree -L 3 -I 'node_modules|.git|...' or find command fallback"

**Why this matters:** Directory tree gives visual overview, metrics quantify scope for planning

**Avoid:** Don't hardcode tree structure. Generate it dynamically from actual codebase.
</action>
  <verify>
```bash
# Verify tree command added to arch focus
grep -A 5 "For arch focus:" agents/gsd-codebase-mapper.md | grep "tree"

# Verify metrics section in template
grep -A 10 "Codebase Metrics" agents/gsd-codebase-mapper.md

# Verify metrics collection commands
grep "wc -l" agents/gsd-codebase-mapper.md | grep -v "node_modules"
```
</verify>
  <done>
Agent file contains:
- tree command in arch focus exploration with exclusion patterns
- Metrics section added to STRUCTURE.md template before Directory Layout
- Bash commands to collect file counts and line counts with exclusions
- Template instructions to insert actual tree output
</done>
</task>

<task type="auto">
  <name>Task 2: Add metrics collection to all focus areas</name>
  <files>agents/gsd-codebase-mapper.md</files>
  <action>
Add metrics sections to templates for other focus areas:

1. **STACK.md template** - Add after "Analysis Date":
   ```markdown
   **Codebase Size:**
   - Files analyzed: [N] files
   - Lines of code: [N] lines (excluding node_modules, build artifacts)
   ```
   
   Add exploration command in tech focus:
   ```bash
   # Quick size metrics
   find . -type f \( -name "*.ts" -o -name "*.js" -o -name "*.tsx" -o -name "*.jsx" \) | \
     grep -v "node_modules\|dist\|build\|\.git" | wc -l
   ```

2. **ARCHITECTURE.md template** - Add after "Analysis Date":
   ```markdown
   **Scope:**
   - Source files: [N] files
   - Primary language: [Language] ([N]% of codebase)
   - LOC: [N] lines
   ```
   
   Add exploration command in arch focus (reuse from Task 1)

3. **CONVENTIONS.md template** - Add after "Analysis Date":
   ```markdown
   **Analysis Scope:**
   - Files reviewed: [N] source files
   - Test files: [N] files
   ```
   
   Add exploration command in quality focus:
   ```bash
   # Count source and test files
   find . -type f \( -name "*.ts" -o -name "*.js" \) | \
     grep -v "node_modules\|dist\|build\|\.git\|\.test\.\|\.spec\." | wc -l
   
   find . -type f \( -name "*.test.*" -o -name "*.spec.*" \) | \
     grep -v "node_modules\|dist\|build\|\.git" | wc -l
   ```

4. **TESTING.md template** - Add after "Analysis Date":
   ```markdown
   **Test Coverage:**
   - Test files: [N] files
   - Source files: [N] files
   - Test ratio: [N]% (test files / source files)
   ```
   
   Add exploration command in quality focus (reuse from above)

5. **CONCERNS.md template** - Add after "Analysis Date":
   ```markdown
   **Analysis Scope:**
   - Files scanned: [N] files
   - TODO/FIXME found: [N] instances
   - Large files (>500 LOC): [N] files
   ```
   
   Add exploration command in concerns focus:
   ```bash
   # Count TODOs and large files
   grep -r "TODO\|FIXME\|HACK" . --include="*.ts" --include="*.js" \
     --exclude-dir={node_modules,.git,dist,build} | wc -l
   
   find . -type f \( -name "*.ts" -o -name "*.js" \) | \
     grep -v "node_modules\|dist\|build\|\.git" | \
     xargs wc -l 2>/dev/null | awk '$1 > 500' | wc -l
   ```

**Consistency:** All metrics commands must exclude same infrastructure directories
</action>
  <verify>
```bash
# Verify all templates have metrics sections
for template in STACK ARCHITECTURE CONVENTIONS TESTING CONCERNS; do
  echo "Checking $template.md template..."
  grep -A 3 "Analysis Date" agents/gsd-codebase-mapper.md | grep -A 5 "$template"
done

# Verify metrics commands in all focus areas
grep -c "wc -l" agents/gsd-codebase-mapper.md  # Should be multiple
grep "TODO.*wc -l" agents/gsd-codebase-mapper.md  # CONCERNS metrics
```
</verify>
  <done>
All document templates contain:
- Metrics section after "Analysis Date"
- Relevant metrics for each focus area (files, LOC, test coverage, TODOs, etc.)
- Exploration commands to collect metrics with exclusions
- Metrics reflect only analyzed code (infrastructure excluded)
</done>
</task>

<task type="auto">
  <name>Task 3: Add aggregate metrics to workflow summary</name>
  <files>get-shit-done/workflows/map-codebase.md</files>
  <action>
Update map-codebase.md workflow to include aggregate metrics in completion summary:

1. Update `verify_output` step to collect metrics:
   ```bash
   # Collect line counts for all documents
   wc -l .planning/codebase/*.md
   
   # Extract codebase metrics from STRUCTURE.md
   grep -A 10 "Codebase Metrics" .planning/codebase/STRUCTURE.md 2>/dev/null || echo "Metrics not found in STRUCTURE.md"
   ```

2. Update `offer_next` step output format to include metrics table:
   ```
   Codebase mapping complete.
   
   **Codebase Metrics:**
   - Files analyzed: [N] files
   - Lines of code: [N] lines
   - Test files: [N] files
   
   **Documents created** (.planning/codebase/):
   - STACK.md ([N] lines) - Technologies and dependencies
   - ARCHITECTURE.md ([N] lines) - System design and patterns
   - STRUCTURE.md ([N] lines) - Directory layout and organization
   - CONVENTIONS.md ([N] lines) - Code style and patterns
   - TESTING.md ([N] lines) - Test structure and practices
   - INTEGRATIONS.md ([N] lines) - External services and APIs
   - CONCERNS.md ([N] lines) - Technical debt and issues
   
   **Excluded from analysis:**
   Infrastructure: .claude, .github, .codex, node_modules, .git
   Build artifacts: dist, build, out, target, coverage
   ```

3. Add note in summary: "Metrics reflect application code only (infrastructure excluded)"

**Why:** High-level metrics help user understand codebase scale without reading all docs
</action>
  <verify>
```bash
# Verify metrics extraction in verify_output
grep -A 5 "verify_output" get-shit-done/workflows/map-codebase.md | grep "Codebase Metrics"

# Verify offer_next includes metrics
grep -A 15 "offer_next" get-shit-done/workflows/map-codebase.md | grep "Codebase Metrics\|Files analyzed"
```
</verify>
  <done>
Workflow file contains:
- verify_output step extracts metrics from STRUCTURE.md
- offer_next step includes Codebase Metrics table in output
- Summary clarifies metrics exclude infrastructure
- User sees aggregate metrics without reading all documents
</done>
</task>

</tasks>

<verification>
Overall phase checks:

```bash
# Verify STRUCTURE.md will have tree and metrics
grep -A 20 "STRUCTURE.md Template" agents/gsd-codebase-mapper.md | grep "Codebase Metrics"
grep -A 20 "STRUCTURE.md Template" agents/gsd-codebase-mapper.md | grep "tree"

# Verify all templates have metrics
for doc in STACK INTEGRATIONS ARCHITECTURE STRUCTURE CONVENTIONS TESTING CONCERNS; do
  echo "Checking $doc template..."
  grep -c "$doc.md Template" agents/gsd-codebase-mapper.md
done

# Verify workflow outputs metrics
grep "Codebase Metrics" get-shit-done/workflows/map-codebase.md
```
</verification>

<success_criteria>
- STRUCTURE.md template includes Codebase Metrics section and tree visualization placeholder
- Tree command in arch focus uses exclusion patterns (-I flag or grep filter)
- All document templates (STACK, ARCHITECTURE, CONVENTIONS, TESTING, CONCERNS, INTEGRATIONS) include metrics sections
- Exploration commands for each focus collect relevant metrics (file counts, line counts, test ratio, TODO counts)
- Workflow verify_output and offer_next steps extract and display aggregate metrics
- All metrics commands exclude infrastructure directories
- Requirements MAP-09 and MAP-10 satisfied (tree visualization and metrics complete)
</success_criteria>

<output>
After completion, create `.planning/phases/02-codebase-mapping-enhancement/02-02-SUMMARY.md`
</output>
