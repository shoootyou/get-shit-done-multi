---
phase: 02-flag-system-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/flag-parser.js (new)
  - bin/lib/old-flag-detector.js (new)
  - bin/lib/flag-validator.js (new)
  - bin/install.js
autonomous: true
must_haves:
  - FLAG-01: Platform flags (--claude, --copilot, --codex, --all) parse correctly
  - FLAG-02: Scope flags (--global, --local) parse correctly and default to local
  - FLAG-05: Old flags (--local, --global, --codex-global) detected before parsing
  - FLAG-06: Clear migration error shown for old flags with examples
  - Three-stage architecture: pre-parse detection → Commander parse → post-parse validation
---

# Phase 2, Plan 1: Core Flag Parsing Infrastructure

## Objective

Implement the Commander.js-based flag parsing system with three-stage architecture: pre-parse old flag detection, Commander.js parsing, and post-parse validation. Users can specify platforms and scopes via new flags, and old flags show clear migration warnings.

## Context

**From Phase 1:** Commander.js 14.0.2 and prompts 2.4.2 are installed and verified.

**Architecture pattern (from RESEARCH.md):**
1. **Pre-parse detection** (raw argv) → Detect old flags, show warnings, filter from argv
2. **Commander parsing** → Parse new flags into structured options
3. **Post-parse validation** → Validate combinations, collect platforms

**Old flag handling (resolved question):**
- Filter old flags from argv AFTER showing warning, BEFORE Commander parses
- Prevents "unknown option" errors while still showing migration guidance
- Function: `detectAndFilterOldFlags(argv)` returns cleaned argv

**Current state:** install.js has monolithic flag handling with old implicit assumptions.

## Tasks

<task name="create-old-flag-detector" type="auto">
  <files>bin/lib/old-flag-detector.js</files>
  <action>
Create pre-parse old flag detection module following Pattern 1 from RESEARCH.md.

Module exports: `detectAndFilterOldFlags(argv)`

**Detection logic:**
- Scan argv for OLD_FLAGS: `--local`, `--global`, `--codex-global`
- Build mapping to migration examples:
  - `--local` → `--claude --local`
  - `--global` → `--claude --global`
  - `--codex-global` → `--codex --local` (note: Codex local only)

**Warning format (from CONTEXT.md):**
```
⚠️  The following flags have been removed in v1.10.0: --local
    Use '--claude --local' instead of '--local'
    See MIGRATION.md for details
```

**Handling multiple old flags:**
- Single warning listing all found
- Show one example (use --claude --local as default)
- Keep warning minimal (3-4 lines max)

**Return cleaned argv:**
- Filter out all old flags from argv array
- Return new array without old flags
- Commander.js will parse cleaned argv

**Use existing colors.js:**
- Import from `../colors.js`
- Yellow for warning icon and message
- Standard formatting (see bin/lib/colors.js)
  </action>
  <verify>
```bash
node -e "
const detect = require('./bin/lib/old-flag-detector.js');

// Test 1: Old flag detected
const cleaned = detect(['node', 'install.js', '--local']);
console.log('Cleaned argv:', cleaned);
console.assert(cleaned.length === 2, 'Should remove --local');

// Test 2: Multiple old flags
const cleaned2 = detect(['node', 'install.js', '--local', '--global']);
console.assert(cleaned2.length === 2, 'Should remove both');

// Test 3: No old flags
const cleaned3 = detect(['node', 'install.js', '--claude']);
console.assert(cleaned3.length === 3, 'Should not remove new flags');
"
```
  </verify>
  <done>
Old flag detector module exists, detects old flags, shows migration warning, returns cleaned argv
  </done>
</task>

<task name="create-flag-parser" type="auto">
  <files>bin/lib/flag-parser.js</files>
  <action>
Create Commander.js flag parser module following Pattern 2 from RESEARCH.md.

Module exports: `parseFlags(argv)` - returns `{ platforms: [], scope: 'local'|'global', needsMenu: false }`

**Commander.js setup:**
```javascript
const { Command } = require('commander');
const program = new Command();

program
  .name('get-shit-done-multi')
  .description('Multi-platform AI assistant configuration')
  .version('1.10.0')
  .option('--claude', 'install for Claude Desktop')
  .option('--copilot', 'install for GitHub Copilot CLI')
  .option('--codex', 'install for Codex CLI')
  .option('--all', 'install for all platforms')
  .option('-g, --global', 'install globally (user home directory)')
  .option('-l, --local', 'install locally (current directory, default)');
```

**Post-parse processing (preAction hook):**
- Parse platforms into array
- If `--all`: platforms = ['claude', 'copilot', 'codex']
  - If specific platform flags also present, show info: "ℹ️  Using --all (specific platform flags ignored)"
- Else: accumulate platforms from individual flags
- Deduplicate platforms (handle `--claude --claude`)
  - If duplicates found, warn: "⚠️  Duplicate flags detected: --claude (will install once)"
- Determine scope: `opts.global ? 'global' : 'local'`
- If NO platforms selected: return `{ platforms: [], scope, needsMenu: true }`
  - This triggers interactive menu in Phase 3

**Return object:**
```javascript
{
  platforms: ['claude', 'copilot'],  // deduplicated
  scope: 'global',                    // or 'local'
  needsMenu: false                    // true if no platforms
}
```

**Do NOT validate conflicts here** - that's for flag-validator.js
  </action>
  <verify>
```bash
node -e "
const parse = require('./bin/lib/flag-parser.js');

// Test 1: Single platform + scope
const r1 = parse(['node', 'install.js', '--claude', '--global']);
console.assert(r1.platforms.includes('claude'), 'Should have claude');
console.assert(r1.scope === 'global', 'Should be global');

// Test 2: --all flag
const r2 = parse(['node', 'install.js', '--all']);
console.assert(r2.platforms.length === 3, 'Should have all 3 platforms');
console.assert(r2.scope === 'local', 'Should default to local');

// Test 3: No platforms (menu mode)
const r3 = parse(['node', 'install.js', '--global']);
console.assert(r3.needsMenu === true, 'Should trigger menu');
console.assert(r3.scope === 'global', 'Should preserve scope for menu');

// Test 4: Deduplication
const r4 = parse(['node', 'install.js', '--claude', '--claude']);
console.assert(r4.platforms.length === 1, 'Should deduplicate');
"
```
  </verify>
  <done>
Flag parser module exists, parses all platform/scope flags, returns structured config
  </done>
</task>

<task name="create-flag-validator" type="auto">
  <files>bin/lib/flag-validator.js</files>
  <action>
Create post-parse validation module for flag combinations.

Module exports: `validateFlags(config)` - validates parsed config, throws on errors

**Input:** `{ platforms: [], scope: 'local'|'global', needsMenu: boolean }`

**Validation rules (from CONTEXT.md):**

1. **Conflicting scopes** - check in raw argv since Commander already parsed:
   - This module receives PARSED config, so conflicting scopes already resolved by Commander
   - Actually, we need to check if BOTH --local AND --global were present
   - Import Commander instance or check raw argv in this module
   - If both present: error "Cannot use both --local and --global. Choose one."
   - Exit with code 2 (command misuse)

2. **No validation errors for:**
   - Duplicate platforms (already deduped by parser with warning)
   - --all with specific platforms (parser already handled)
   - Scope without platform (returns needsMenu: true)

**Error format:**
- Use colors.js red for errors
- Clear, actionable messages
- Include example of correct usage

**Return:** void (throws on error, or returns silently)

**Wait - let me reconsider:** Commander.js with `.option('-l, --local')` and `.option('-g, --global')` will NOT error on both being present. We need to manually check.

**Implementation:**
```javascript
function validateFlags(argv, config) {
  const { platforms, scope } = config;
  
  // Check conflicting scopes (check raw argv)
  const hasLocal = argv.includes('--local') || argv.includes('-l');
  const hasGlobal = argv.includes('--global') || argv.includes('-g');
  
  if (hasLocal && hasGlobal) {
    const { red, reset } = require('./colors');
    console.error(`${red}Error: Cannot use both --local and --global. Choose one.${reset}`);
    console.error(`Example: npx get-shit-done-multi --claude --global`);
    process.exit(2);  // Command misuse
  }
  
  // All other validations already handled by parser
}
```

Module signature: `validateFlags(argv, parsedConfig)`
  </action>
  <verify>
```bash
# Test conflicting scopes (should exit)
node -e "
const validate = require('./bin/lib/flag-validator.js');
try {
  validate(['--local', '--global'], { platforms: ['claude'], scope: 'local' });
  console.error('Should have thrown/exited');
} catch (e) {
  console.log('Correctly caught conflict');
}
" || echo "Exit code $? (expected 2)"
```
  </verify>
  <done>
Flag validator module exists, checks for conflicting scopes, exits with clear error
  </done>
</task>

<task name="integrate-into-install" type="auto">
  <files>bin/install.js</files>
  <action>
Integrate three-stage flag parsing into install.js.

**Current state:** install.js has old flag handling (search for existing flag checks)

**Integration points:**

1. **Add imports at top:**
```javascript
const detectAndFilterOldFlags = require('./lib/old-flag-detector.js');
const parseFlags = require('./lib/flag-parser.js');
const validateFlags = require('./lib/flag-validator.js');
```

2. **Early in main flow (before any logic):**
```javascript
// Stage 1: Pre-parse old flag detection
const cleanedArgv = detectAndFilterOldFlags(process.argv);

// Stage 2: Parse flags with Commander.js
const flagConfig = parseFlags(cleanedArgv);

// Stage 3: Validate flag combinations
validateFlags(process.argv, flagConfig);
```

3. **Use flagConfig for routing:**
```javascript
const { platforms, scope, needsMenu } = flagConfig;

if (needsMenu) {
  // TODO: Trigger interactive menu (Phase 3)
  console.log('Interactive menu will be implemented in Phase 3');
  console.log('For now, defaulting to: install all locally');
  platforms = ['claude', 'copilot', 'codex'];
  scope = 'local';
}

// Proceed with installation using platforms and scope
```

4. **Remove old flag handling code:**
- Search for existing `--local`, `--global` checks
- Comment out or remove (keep for reference if needed)
- Add comment: `// Old flag handling removed in v1.10.0 - see FLAG-05/FLAG-06`

**DO NOT change installation logic yet** - just flag parsing
**DO NOT implement actual installation** - that's Phase 4

**For now:** Just log the parsed config and exit
```javascript
console.log('Flag parsing complete:');
console.log(`  Platforms: ${platforms.join(', ')}`);
console.log(`  Scope: ${scope}`);
console.log('');
console.log('Installation logic will be updated in Phase 4');
process.exit(0);
```
  </action>
  <verify>
```bash
# Test new flag system
echo "Testing --claude --global:"
node bin/install.js --claude --global

echo ""
echo "Testing old flag (should warn):"
node bin/install.js --local

echo ""
echo "Testing --all:"
node bin/install.js --all

echo ""
echo "Testing conflict (should error):"
node bin/install.js --claude --local --global || echo "Correctly rejected conflict"
```
  </verify>
  <done>
install.js uses three-stage flag parsing, old flags warn, new flags parse correctly
  </done>
</task>

## Verification

After all tasks complete:

```bash
# Run all test commands
cd /workspace

# Test 1: Old flag detection
echo "=== Test 1: Old flag detection ==="
node bin/install.js --local 2>&1 | grep "removed in v1.10.0"

# Test 2: New flags parse
echo "=== Test 2: New flags ==="
node bin/install.js --claude --copilot --global 2>&1 | grep "Platforms:"

# Test 3: --all flag
echo "=== Test 3: --all flag ==="
node bin/install.js --all 2>&1 | grep "claude, copilot, codex"

# Test 4: Conflict detection
echo "=== Test 4: Conflict detection ==="
node bin/install.js --local --global 2>&1 | grep "Cannot use both"

# Test 5: Deduplication
echo "=== Test 5: Deduplication ==="
node bin/install.js --claude --claude 2>&1 | grep "Duplicate"
```

## Success Criteria

- ✅ Old flag detector warns and filters old flags from argv
- ✅ Commander.js parses platform flags (--claude, --copilot, --codex, --all)
- ✅ Commander.js parses scope flags (--global, --local, defaults to local)
- ✅ Validator catches conflicting scopes and exits with error
- ✅ Parser deduplicates duplicate platform flags with warning
- ✅ install.js integrates three-stage parsing
- ✅ Scope without platform sets needsMenu flag (Phase 3 integration point)
- ✅ All verification tests pass

## Output

**Files created:**
- `bin/lib/old-flag-detector.js` - Pre-parse old flag detection
- `bin/lib/flag-parser.js` - Commander.js flag parsing
- `bin/lib/flag-validator.js` - Post-parse validation

**Files modified:**
- `bin/install.js` - Integrated three-stage flag parsing

**Ready for:**
- Phase 3: Interactive menu (consumes needsMenu flag)
- Plan 2: Codex warning and edge case handling
