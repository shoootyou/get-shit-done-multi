---
phase: 02-flag-system-redesign
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - bin/lib/codex-warning.js (new)
  - bin/install.js
  - bin/lib/flag-validator.js
autonomous: false  # Has checkpoint for manual testing
must_haves:
  - FLAG-03: Codex global shows warning and installs locally
  - FLAG-04: --all --global installs Claude/Copilot globally, Codex locally with warning
  - MSG-02: Codex global warning displays with installation plan and confirmation
  - User can confirm or cancel installation after seeing Codex warning
  - Non-TTY environments auto-proceed without prompt
---

# Phase 2, Plan 2: Codex Global Warning & Edge Cases

## Objective

Implement Codex global warning system with user confirmation. When user specifies `--codex --global` or `--all --global`, show clear warning that Codex only supports local installation, display installation plan, and prompt for confirmation before proceeding.

## Context

**From Plan 1:** Three-stage flag parsing complete. `flagConfig` contains `{ platforms, scope, needsMenu }`.

**Resolved question (from planning_context):**
- `--all --global` behavior: Install Claude/Copilot globally, Codex locally (with warning)
- This is explicitly specified in FLAG-04, not an open question

**Warning UX (from CONTEXT.md):**
- Show warning before installation starts
- Display installation plan showing where each platform will install
- Prompt for confirmation (y/n)
- Non-TTY: auto-proceed without prompt
- User can cancel with 'n' or Ctrl+C

**From RESEARCH.md Pattern 3:** Use prompts library with TTY detection

## Tasks

<task name="create-codex-warning-module" type="auto">
  <files>bin/lib/codex-warning.js</files>
  <action>
Create Codex global warning module with confirmation prompt.

Module exports: `async warnAndConfirmCodexLocal(platforms, scope)`

**Returns:** boolean (true = proceed, false = cancelled)

**Logic:**

1. **Check if warning needed:**
```javascript
if (!platforms.includes('codex') || scope !== 'global') {
  return true;  // No warning needed
}
```

2. **Show warning (from MSG-02):**
```
⚠️  Global installation not supported for Codex.
    Installing locally in current folder instead.
```

3. **Show installation plan:**
```
Installation plan:
  • Claude → ~/.claude/ (global)
  • Copilot → ~/.copilot/ (global)
  • Codex → [repo-root]/.codex/ (local)
```

Format:
- For each platform in platforms array
- If platform === 'codex': always show local path
- Else: show path based on scope
- Paths from REQUIREMENTS.md PATH-01, PATH-02, PATH-03

4. **TTY detection:**
```javascript
if (!process.stdout.isTTY) {
  console.log('(auto-proceeding in non-interactive mode)');
  return true;
}
```

5. **Confirmation prompt (use prompts library):**
```javascript
const prompts = require('prompts');

const response = await prompts({
  type: 'confirm',
  name: 'continue',
  message: 'Continue with installation?',
  initial: true
});

// Handle cancellation (Ctrl+C, ESC)
if (response.continue === undefined) {
  console.log('Installation cancelled');
  return false;
}

return response.continue;
```

**Use colors.js:**
- Yellow for warning icon and message
- Cyan for info (installation plan)
- Reset after each section

**Reference:** RESEARCH.md "Codex Global Warning with Confirmation" code example
  </action>
  <verify>
```bash
node -e "
const warn = require('./bin/lib/codex-warning.js');

// Test 1: No warning needed (claude only)
warn(['claude'], 'global').then(result => {
  console.assert(result === true, 'Should proceed without warning');
});

// Test 2: Codex local (no warning)
warn(['codex'], 'local').then(result => {
  console.assert(result === true, 'Should proceed without warning');
});

// Test 3: Codex global in non-TTY (auto-proceed)
// This test will show warning and auto-proceed
" 
```
  </verify>
  <done>
Codex warning module exists, detects Codex+global, shows warning and installation plan, prompts for confirmation
  </done>
</task>

<task name="integrate-codex-warning" type="auto">
  <files>bin/install.js</files>
  <action>
Integrate Codex warning into install.js after flag parsing.

**Add import:**
```javascript
const warnAndConfirmCodexLocal = require('./lib/codex-warning.js');
```

**After flag validation, before installation logic:**
```javascript
// Stage 4: Codex global warning (if applicable)
const shouldProceed = await warnAndConfirmCodexLocal(platforms, scope);
if (!shouldProceed) {
  console.log('Installation cancelled by user');
  process.exit(0);
}
```

**Update main function to async:**
- Wrap main logic in async function if not already
- Or use top-level await if Node version supports

**Update scope for Codex:**
After confirmation (if user proceeded):
```javascript
// Adjust scope for Codex (always local)
const effectiveScope = (platform) => {
  return platform === 'codex' ? 'local' : scope;
};
```

This function will be used in Phase 4 when actual installation happens.
For now, update the logging to reflect effective scope:

```javascript
console.log('Flag parsing complete:');
platforms.forEach(platform => {
  const finalScope = effectiveScope(platform);
  console.log(`  ${platform} → ${finalScope}`);
});
```
  </action>
  <verify>
```bash
# Manual test (will prompt)
echo "Testing Codex global warning:"
node bin/install.js --codex --global

echo ""
echo "Testing --all --global (should show plan):"
node bin/install.js --all --global
```
  </verify>
  <done>
install.js shows Codex warning when applicable, prompts for confirmation, proceeds or cancels based on user input
  </done>
</task>

<task name="handle-all-global-edge-case" type="auto">
  <files>bin/lib/flag-validator.js</files>
  <action>
Update validator to document --all --global behavior (no code changes needed).

**Add comment at top of flag-validator.js:**
```javascript
/**
 * Flag Validator - Post-parse validation
 * 
 * Validates parsed flag combinations and exits on errors.
 * 
 * Edge cases handled:
 * - Conflicting scopes (--local --global): ERROR, exit 2
 * - Duplicate platforms: Handled by parser (warn + dedupe)
 * - --all with specific platforms: Handled by parser (info + ignore specific)
 * - --all --global: ALLOWED - Claude/Copilot global, Codex local (see codex-warning.js)
 * - Scope without platform: ALLOWED - triggers menu (needsMenu: true)
 */
```

This documents the design decision without changing behavior.

**From FLAG-04:** `--all --global` installs Claude/Copilot globally, Codex locally with warning.
This is NOT an error condition - it's expected and handled by codex-warning.js.
  </action>
  <verify>
```bash
# Verify --all --global doesn't error (just shows warning)
node bin/install.js --all --global 2>&1 | grep -v "Error:" | grep "Installation plan"
```
  </verify>
  <done>
Validator documentation clarifies --all --global is allowed and handled by codex-warning
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Codex global warning system with:
- Detection of Codex + global scope
- Warning message with installation plan
- User confirmation prompt (or auto-proceed in non-TTY)
- Integration with install.js flag parsing flow
  </what-built>
  <how-to-verify>
Run these manual tests:

**Test 1: Codex global warning**
```bash
cd /workspace
node bin/install.js --codex --global
```
Expected:
- Warning message: "⚠️  Global installation not supported for Codex"
- Installation plan showing: "Codex → [repo-root]/.codex/ (local)"
- Prompt: "Continue with installation? (y/n)"
- Enter 'y' to proceed or 'n' to cancel

**Test 2: --all --global (mixed scopes)**
```bash
node bin/install.js --all --global
```
Expected:
- Warning about Codex
- Installation plan showing:
  - Claude → ~/.claude/ (global)
  - Copilot → ~/.copilot/ (global)
  - Codex → [repo-root]/.codex/ (local)
- Prompt for confirmation
- Enter 'y'

**Test 3: Cancel workflow**
```bash
node bin/install.js --codex --global
```
- When prompted, enter 'n'
- Expected: "Installation cancelled" and exit

**Test 4: No warning when not needed**
```bash
node bin/install.js --claude --global
```
Expected:
- NO Codex warning
- Just normal flag parsing output

**Test 5: Non-TTY auto-proceed**
```bash
echo "" | node bin/install.js --codex --global
```
Expected:
- Warning shown
- Auto-proceeds without waiting for input
- Message: "(auto-proceeding in non-interactive mode)"

Check:
- [ ] Warning displays correctly (yellow, readable)
- [ ] Installation plan is clear and accurate
- [ ] Confirmation prompt works (y/n)
- [ ] Cancel works (n or Ctrl+C)
- [ ] Non-TTY auto-proceeds
- [ ] No warning when not applicable
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe any issues found
  </resume-signal>
</task>

## Verification

After approval, run automated tests:

```bash
# Verify flag parsing still works
node bin/install.js --claude --copilot --local 2>&1 | grep "Platforms:"

# Verify old flags still warn
node bin/install.js --local 2>&1 | grep "removed in v1.10.0"

# Verify conflicts still error
node bin/install.js --local --global 2>&1 | grep "Cannot use both" || echo "Conflict check failed"
```

## Success Criteria

- ✅ Codex warning module detects Codex + global scope
- ✅ Warning shows clear message and installation plan
- ✅ Confirmation prompt works in TTY environments
- ✅ Non-TTY auto-proceeds without prompt
- ✅ User can cancel installation
- ✅ --all --global installs Claude/Copilot globally, Codex locally
- ✅ No warning shown when Codex not selected or scope is local
- ✅ Manual testing checkpoint passed

## Output

**Files created:**
- `bin/lib/codex-warning.js` - Codex global warning with confirmation

**Files modified:**
- `bin/install.js` - Integrated Codex warning after flag parsing
- `bin/lib/flag-validator.js` - Documentation of edge case handling

**Ready for:**
- Phase 3: Interactive menu (no flags → menu)
- Phase 4: Platform paths (actual installation using parsed flags)
