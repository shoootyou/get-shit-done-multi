---
phase: 07.2-codebase-cleanup-and-publishing-fixes
plan: 04
type: execute
wave: 4
depends_on: [07.2-01, 07.2-02, 07.2-03]
files_modified: []
autonomous: false
must_haves:
  - npm pack creates tarball without errors
  - Tarball contains templates/ directory
  - Tarball contains bin/ directory with install.js
  - Tarball does NOT contain audit-functions.*, hooks/, scripts/, coverage/
  - Tarball size is <1MB
  - bin/install.js executes from extracted tarball
  - install.js --help works from extracted package
  - All production dependencies resolve in extracted package
---

# Phase 7.2 Plan 04: Publishing Verification

## Objective

Validate npm publishing configuration through end-to-end testing: create tarball with npm pack, extract to isolated directory, verify contents, and test bin/install.js execution. Human verification checkpoint confirms installation works correctly.

## Context

**Depends on:** Plans 01, 02, 03 (all cleanup and fixes must be complete)

**Why wave 4:** Verification must happen last, after all changes are complete. This is the final quality gate before npm publish.

**Why autonomous: false:** Contains human-verify checkpoint to test bin/install.js interactively.

**From research (RESEARCH.md):**
- Validation workflow: npm pack → extract → verify contents → test execution
- Target tarball size: <1MB (templates ~1.2MB compressed, bin ~328KB)
- Critical verification: templates/ present (was missing in files array)
- Test both --help (non-interactive) and interactive modes
- Simulate npx execution flow (production dependencies only)

**From decisions (CONTEXT.md):**
- Test in isolated folder under /tmp (don't modify source)
- Validate with npm pack → extract → test workflow
- Test both interactive and non-interactive install modes
- Confirm bin/install.js works with minimal dependencies

## Tasks

<task name="create-and-inspect-tarball" type="auto">
  <files>N/A (reads package.json, creates tarball)</files>
  <action>
Create npm tarball and inspect contents:

**1. Clean any previous test artifacts:**
```bash
rm -f get-shit-done-multi-*.tgz
rm -rf /tmp/gsd-pack-test-*
```

**2. Verify package.json state:**
```bash
echo "=== Verifying package.json configuration ==="

# Verify files array correct
echo "Files array:"
grep -A 3 '"files"' package.json

# Verify prepublishOnly removed
echo "Checking for prepublishOnly:"
grep "prepublishOnly" package.json && echo "ERROR: prepublishOnly still exists!" || echo "✓ prepublishOnly removed"

# Verify Node 20 requirement
echo "Node version requirement:"
grep -A 1 '"engines"' package.json | grep "node"
```

**3. Create tarball:**
```bash
echo "=== Creating tarball with npm pack ==="
npm pack

# Get tarball name
TARBALL=$(ls -t get-shit-done-multi-*.tgz | head -1)
echo "Created: $TARBALL"
```

**4. Inspect tarball contents:**
```bash
echo "=== Tarball contents ==="

# List all files
echo "Full file list:"
tar -tzf "$TARBALL" | head -30

# Check for critical directories
echo ""
echo "Checking critical paths..."
tar -tzf "$TARBALL" | grep "package/templates/" | head -5 && echo "✓ templates/ present" || echo "✗ templates/ MISSING (CRITICAL BUG)"
tar -tzf "$TARBALL" | grep "package/bin/" && echo "✓ bin/ present" || echo "✗ bin/ missing"

# Check for unwanted files
echo ""
echo "Checking for unwanted files (should not be present)..."
tar -tzf "$TARBALL" | grep -E "audit-functions|hooks/|scripts/|coverage/|\.github/|node_modules/" && echo "✗ Unwanted files found" || echo "✓ No unwanted files"

# Check tarball size
echo ""
echo "Tarball size:"
ls -lh "$TARBALL"
SIZE_KB=$(du -k "$TARBALL" | cut -f1)
if [ $SIZE_KB -lt 1024 ]; then
  echo "✓ Size OK: ${SIZE_KB}KB (< 1MB)"
else
  echo "⚠ Size: ${SIZE_KB}KB (>1MB - check for large files)"
fi
```

**5. Save tarball name for next tasks:**
```bash
echo "$TARBALL" > /tmp/gsd-tarball-name.txt
```
  </action>
  <verify>
```bash
# Verify tarball created
TARBALL=$(cat /tmp/gsd-tarball-name.txt)
test -f "$TARBALL" && echo "✓ Tarball exists: $TARBALL"

# Critical checks
tar -tzf "$TARBALL" | grep -q "package/templates/" && echo "✓ templates/ in tarball"
tar -tzf "$TARBALL" | grep -q "package/bin/install.js" && echo "✓ bin/install.js in tarball"
! tar -tzf "$TARBALL" | grep -q "audit-functions" && echo "✓ No audit files"
! tar -tzf "$TARBALL" | grep -q "hooks/" && echo "✓ No hooks/"
```
  </verify>
  <done>Tarball created and contents verified (templates present, unwanted files absent)</done>
</task>

<task name="extract-and-verify-package" type="auto">
  <files>N/A (extracts tarball to /tmp)</files>
  <action>
Extract tarball to isolated directory and verify package structure:

**1. Create isolated test directory:**
```bash
TIMESTAMP=$(date +%s)
TEST_DIR="/tmp/gsd-pack-test-${TIMESTAMP}"
mkdir -p "$TEST_DIR"
echo "Test directory: $TEST_DIR"
```

**2. Extract tarball:**
```bash
TARBALL=$(cat /tmp/gsd-tarball-name.txt)
echo "=== Extracting $TARBALL to $TEST_DIR ==="
tar -xzf "$TARBALL" -C "$TEST_DIR"

# npm pack creates package/ subdirectory
PACKAGE_DIR="$TEST_DIR/package"
cd "$PACKAGE_DIR"
pwd
```

**3. Verify directory structure:**
```bash
echo "=== Verifying package structure ==="

# Check directories exist
test -d templates && echo "✓ templates/ exists" || echo "✗ templates/ missing (CRITICAL)"
test -d bin && echo "✓ bin/ exists" || echo "✗ bin/ missing (CRITICAL)"
test -f bin/install.js && echo "✓ bin/install.js exists" || echo "✗ bin/install.js missing"

# Check templates/ contents
echo ""
echo "Templates structure:"
ls -la templates/
test -d templates/skills && echo "✓ templates/skills/ exists" || echo "✗ templates/skills/ missing"
test -d templates/agents && echo "✓ templates/agents/ exists" || echo "✗ templates/agents/ missing"

# Count templates
SKILLS_COUNT=$(find templates/skills -name "SKILL.md" 2>/dev/null | wc -l)
AGENTS_COUNT=$(find templates/agents -name "*.agent.md" 2>/dev/null | wc -l)
echo "Found: $SKILLS_COUNT skills, $AGENTS_COUNT agents"

# Verify shebang in bin/install.js
echo ""
echo "Checking bin/install.js shebang:"
head -1 bin/install.js
```

**4. Verify unwanted files absent:**
```bash
echo ""
echo "=== Verifying unwanted files not present ==="
test ! -f audit-functions.json && echo "✓ No audit-functions.json"
test ! -f audit-functions.md && echo "✓ No audit-functions.md"
test ! -d hooks && echo "✓ No hooks/"
test ! -d scripts && echo "✓ No scripts/"
test ! -d coverage && echo "✓ No coverage/"
test ! -d .github && echo "✓ No .github/"
test ! -d node_modules && echo "✓ No node_modules/ (expected at this stage)"
```

**5. Save package directory for next tasks:**
```bash
echo "$PACKAGE_DIR" > /tmp/gsd-package-dir.txt
```
  </action>
  <verify>
```bash
# Verify extraction successful
PACKAGE_DIR=$(cat /tmp/gsd-package-dir.txt)
test -d "$PACKAGE_DIR" && echo "✓ Package extracted to $PACKAGE_DIR"

# Verify critical structure
test -d "$PACKAGE_DIR/templates" && echo "✓ templates/ present"
test -f "$PACKAGE_DIR/bin/install.js" && echo "✓ bin/install.js present"

# Verify clean (no unwanted files)
test ! -f "$PACKAGE_DIR/audit-functions.json" && echo "✓ Clean package"
```
  </verify>
  <done>Package extracted and structure verified in isolated directory</done>
</task>

<task name="install-dependencies-and-test" type="auto">
  <files>N/A (operates in /tmp)</files>
  <action>
Install production dependencies in extracted package and test bin/install.js:

**1. Navigate to extracted package:**
```bash
PACKAGE_DIR=$(cat /tmp/gsd-package-dir.txt)
cd "$PACKAGE_DIR"
pwd
```

**2. Install production dependencies only:**
```bash
echo "=== Installing production dependencies ==="
npm install --omit=dev --quiet

# Verify critical dependencies installed
echo ""
echo "Verifying critical dependencies:"
test -d node_modules/commander && echo "✓ commander installed"
test -d node_modules/@clack && echo "✓ @clack/prompts installed"
test -d node_modules/fs-extra && echo "✓ fs-extra installed"
test -d node_modules/chalk && echo "✓ chalk installed"
```

**3. Test bin/install.js --help (non-interactive):**
```bash
echo ""
echo "=== Testing bin/install.js --help ==="
node bin/install.js --help

# Capture exit code
HELP_EXIT=$?
if [ $HELP_EXIT -eq 0 ]; then
  echo "✓ --help succeeded (exit code 0)"
else
  echo "✗ --help failed (exit code $HELP_EXIT)"
fi
```

**4. Test bin/install.js --version:**
```bash
echo ""
echo "=== Testing bin/install.js --version ==="
node bin/install.js --version

VERSION_EXIT=$?
if [ $VERSION_EXIT -eq 0 ]; then
  echo "✓ --version succeeded (exit code 0)"
else
  echo "✗ --version failed (exit code $VERSION_EXIT)"
fi
```

**5. Test that executable is marked correctly:**
```bash
echo ""
echo "=== Testing executable permissions ==="
ls -l bin/install.js | grep -E "^-r.xr.xr.x" && echo "✓ install.js is executable" || echo "Note: Not executable yet (npm will fix on install)"
```

**6. Summary:**
```bash
echo ""
echo "=== Verification Summary ==="
echo "Package directory: $PACKAGE_DIR"
echo "Templates present: $(test -d templates && echo YES || echo NO)"
echo "Bin working: $(test $HELP_EXIT -eq 0 && echo YES || echo NO)"
echo "Dependencies: $(test -d node_modules && echo INSTALLED || echo MISSING)"
echo ""
echo "Ready for human verification checkpoint."
```
  </action>
  <verify>
```bash
PACKAGE_DIR=$(cat /tmp/gsd-package-dir.txt)

# Verify dependencies installed
test -d "$PACKAGE_DIR/node_modules" && echo "✓ Dependencies installed"

# Verify bin/install.js works
cd "$PACKAGE_DIR"
node bin/install.js --help >/dev/null 2>&1 && echo "✓ bin/install.js --help works"
```
  </verify>
  <done>Production dependencies installed, bin/install.js tested and working</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete npm publishing configuration with verified tarball:
- package.json files array fixed (templates/ added, wrong entries removed)
- prepublishOnly script removed
- Node 20 requirement set
- All development tooling cleaned up
- Tarball created, extracted, and tested in /tmp
  </what-built>
  <how-to-verify>
**1. Check tarball was created successfully:**
```bash
ls -lh get-shit-done-multi-*.tgz
```
Expected: Tarball exists, size <1MB

**2. Review automated verification output above** - confirm:
- ✓ templates/ present in tarball
- ✓ bin/ present in tarball
- ✓ No audit-functions.*, hooks/, scripts/ in tarball
- ✓ bin/install.js --help works
- ✓ bin/install.js --version works

**3. Test interactive mode (OPTIONAL but recommended):**
```bash
# Navigate to extracted package
PACKAGE_DIR=$(cat /tmp/gsd-package-dir.txt)
cd "$PACKAGE_DIR"

# Try interactive mode (will prompt for platform selection)
node bin/install.js
```
- Select a platform (e.g., claude)
- Select scope (global or local)
- Let it attempt installation (can cancel after prompts)
- Verify prompts display correctly

**4. Verify package.json changes in source:**
```bash
cd /path/to/get-shit-done-multi  # Return to source
git diff package.json
```
Expected changes:
- files array: ["bin", "templates"]
- prepublishOnly line removed
- engines.node: ">=20.0.0"

**5. Check git log for commits:**
```bash
git log --oneline -5
```
Expected: 3+ commits from Plans 01-03 (publishing fixes, cleanup, dev tooling)

**What to look for:**
- ✓ Tarball extracts cleanly
- ✓ templates/ directory present with skills and agents
- ✓ bin/install.js executes without errors
- ✓ --help and --version flags work
- ✓ Interactive prompts display (if tested)
- ✗ Any errors or missing files = ISSUE, describe below
  </how-to-verify>
  <resume-signal>
Type **"approved"** if all verifications pass and package is ready for npm publish.

If issues found, describe them:
- What failed?
- What error messages appeared?
- What's missing or broken?
  </resume-signal>
</task>

<task name="cleanup-test-artifacts" type="auto">
  <files>N/A (cleanup /tmp and tarball)</files>
  <action>
Clean up test artifacts after verification:

**1. Remove test directory:**
```bash
PACKAGE_DIR=$(cat /tmp/gsd-package-dir.txt)
TEST_DIR=$(dirname "$PACKAGE_DIR")
echo "Removing test directory: $TEST_DIR"
rm -rf "$TEST_DIR"
```

**2. Keep or remove tarball (user choice):**
```bash
TARBALL=$(cat /tmp/gsd-tarball-name.txt)

echo ""
echo "Tarball location: $TARBALL"
echo "You can:"
echo "  - Keep it for reference: cp $TARBALL ~/Desktop/"
echo "  - Remove it: rm $TARBALL"
echo ""
echo "Leaving tarball in place for now. Remove manually if desired."
```

**3. Clean temp files:**
```bash
rm -f /tmp/gsd-package-dir.txt
rm -f /tmp/gsd-tarball-name.txt
```

**4. Final status:**
```bash
echo ""
echo "=== Phase 7.2 Complete ==="
echo "✓ npm publishing configuration fixed"
echo "✓ Obsolete code removed"
echo "✓ Development tooling cleaned up"
echo "✓ Package verified with npm pack workflow"
echo ""
echo "Next step: npm publish when ready"
```
  </action>
  <verify>
```bash
# Verify temp files cleaned
test ! -f /tmp/gsd-package-dir.txt && echo "✓ Temp files cleaned"

# Tarball can remain for user inspection
ls get-shit-done-multi-*.tgz >/dev/null 2>&1 && echo "ℹ Tarball still present (optional cleanup)"
```
  </verify>
  <done>Test artifacts cleaned up, tarball available for inspection</done>
</task>

## Success Criteria

- [ ] npm pack creates tarball without errors
- [ ] Tarball size <1MB
- [ ] Tarball contains package/templates/ directory with skills and agents
- [ ] Tarball contains package/bin/install.js with shebang
- [ ] Tarball does NOT contain audit-functions.*, hooks/, scripts/, coverage/, .github/
- [ ] Package extracts to /tmp successfully
- [ ] Production dependencies install without errors
- [ ] bin/install.js --help executes successfully (exit code 0)
- [ ] bin/install.js --version executes successfully (exit code 0)
- [ ] Human verification confirms interactive mode works
- [ ] Test artifacts cleaned up

## Verification Commands

```bash
# After checkpoint approval, verify final state:

# 1. Check package.json in source
grep -A 3 '"files"' package.json
grep "prepublishOnly" package.json  # Should return nothing
grep -A 1 '"engines"' package.json

# 2. Verify git commits
git log --oneline --graph --all -10

# 3. Verify tests pass
npm test

# 4. Final npm pack check
npm pack --dry-run
```

## Output

**Artifacts created:**
- get-shit-done-multi-X.Y.Z.tgz (tarball for inspection or publishing)

**Verification results:**
- Tarball contents verified (templates/ present, unwanted files absent)
- bin/install.js tested and working
- Package ready for npm publish

**Next steps:**
```bash
# When ready to publish:
npm login  # If not already logged in
npm publish  # Publishes to npm registry

# Or test with npx first:
npx get-shit-done-multi@latest --help
```

---

**Phase 7.2 Complete:** All 11 success criteria addressed, package verified and ready for publishing.
