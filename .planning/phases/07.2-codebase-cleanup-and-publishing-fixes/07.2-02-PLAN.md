---
phase: 07.2-codebase-cleanup-and-publishing-fixes
plan: 02
type: execute
wave: 2
depends_on: [07.2-01]
files_modified:
  - audit-functions.json
  - audit-functions.md
  - scripts/audit-functions.js
  - bin/lib/platforms/binary-detector.js
  - bin/lib/installer/orchestrator.js
  - bin/lib/platforms/detector.js
autonomous: true
must_haves:
  - No audit-functions.* files in root directory
  - scripts/ directory deleted (only contained audit-functions.js)
  - Empty catch block has error code checking
  - No ALLOW_SYMLINKS environment variable usage
  - TODO comments explain current implementation
  - All tests pass after changes
---

# Phase 7.2 Plan 02: Code Cleanup and Error Handling

## Objective

Delete obsolete audit files and scripts, improve error handling in binary detector, remove ALLOW_SYMLINKS environment variable, and update TODO comments to explain current implementation.

## Context

**Depends on:** Plan 01 (package.json must be fixed first)

**Why wave 2:** These cleanup tasks are independent and can proceed in parallel once package.json is fixed. No inter-dependencies between tasks in this plan.

**From research (RESEARCH.md):**
- audit-functions.* files are 5MB+ development artifacts (never needed in production)
- Only 1 empty catch block found: binary-detector.js line 21-23
- ALLOW_SYMLINKS only used in orchestrator.js line 208 (redundant with skipPrompts)
- Only 1 TODO comment found: detector.js line 22 (references Phase 6 but we're past that)

**From decisions (CONTEXT.MD):**
- Delete obsolete code immediately - git history preserves everything
- Separate commits per concern (audit files, error handling, env vars, TODOs)
- Atomic deletions: code + its tests in same commit
- TODO format: "Previously TODO: X. Current implementation: Y because Z"
- Error handling: fail-fast, specific error codes (ENOENT, timeout) only
- Env vars: Remove ALLOW_SYMLINKS entirely (no production use case)

## Tasks

<task name="delete-audit-files-and-scripts" type="auto">
  <files>audit-functions.json, audit-functions.md, scripts/audit-functions.js, scripts/</files>
  <action>
Delete audit-functions.* files and scripts directory:

**Files to delete:**
1. `audit-functions.json` (5MB - development artifact)
2. `audit-functions.md` (35KB - documentation for above)
3. `scripts/audit-functions.js` (14KB - script that generates above files)
4. `scripts/` directory (only contains audit-functions.js)

**Verification before deletion:**
```bash
# Confirm these files exist and are safe to delete
ls -lh audit-functions.json audit-functions.md scripts/audit-functions.js

# Confirm scripts/ only contains audit-functions.js
ls scripts/

# Confirm no code imports these files
grep -r "audit-functions" bin/ tests/ --include="*.js" | grep -v node_modules
```

**Safe to delete because:**
- None are imported by bin/ code (confirmed via grep)
- None are referenced in package.json scripts (prepublishOnly removed in Plan 01)
- Development artifacts only (generated for analysis, not production)
- Git history preserves everything (can recover if needed)

**Deletion commands:**
```bash
# Delete files
git rm audit-functions.json audit-functions.md
git rm -r scripts/

# Commit immediately (atomic deletion)
git commit -m "chore(cleanup): delete audit-functions artifacts and scripts

- Delete audit-functions.json (5MB development artifact)
- Delete audit-functions.md (documentation)
- Delete scripts/audit-functions.js (generator script)
- Delete scripts/ directory (now empty)

These files are development artifacts not needed in published package.
Git history preserves them if needed.

Addresses: SC6, SC7
Phase: 07.2-codebase-cleanup-and-publishing-fixes"
```
  </action>
  <verify>
```bash
# Verify files deleted
test ! -f audit-functions.json && echo "✓ audit-functions.json deleted"
test ! -f audit-functions.md && echo "✓ audit-functions.md deleted"
test ! -d scripts && echo "✓ scripts/ directory deleted"

# Verify no broken imports
npm test 2>&1 | head -20

# Verify git tracked the deletions
git status --short | grep -E "^D.*audit-functions|^D.*scripts"
```
  </verify>
  <done>audit-functions.* files and scripts/ directory deleted and committed</done>
</task>

<task name="fix-empty-catch-block" type="auto">
  <files>bin/lib/platforms/binary-detector.js</files>
  <action>
Fix empty catch block in binary-detector.js (lines 21-23):

**Current code (line 21-23):**
```javascript
try {
  await execAsync(checkCmd, { timeout: 2000 });
  return true;
} catch {
  return false;
}
```

**Problem:** Empty catch block - no error parameter, silently swallows all errors without inspection.

**Solution:** Add error parameter and comment explaining why catch-all is acceptable here.

**New code:**
```javascript
try {
  await execAsync(checkCmd, { timeout: 2000 });
  return true;
} catch (error) {
  // Any error means binary not available - this is expected behavior
  // Common errors: ENOENT (command not found), timeout (process.killed), EACCES (no permission)
  // For binary detection, we don't need to distinguish - any error = "not available"
  return false;
}
```

**Rationale (from research):**
- This is binary detection (checking if command exists), not critical path
- Any error legitimately means "binary not available" for our purposes
- ENOENT (not found), timeout, EACCES all should result in false
- But adding error parameter + comment documents the decision
- Follows research recommendation: "Option 2 - Add comment explaining why catch-all is OK here"

**Context:** This function checks if CLI binaries (claude, copilot, codex) exist in PATH. Any failure to execute = not installed.

**Commit message:**
```
fix(error-handling): add error context to binary detector catch block

Add error parameter and explanatory comment to catch block in
binary-detector.js. Catch-all behavior is correct for binary
detection (any error = not available), but now documented.

Addresses: SC8
Phase: 07.2-codebase-cleanup-and-publishing-fixes
```
  </action>
  <verify>
```bash
# Verify catch block now has error parameter
grep -A 5 "} catch (error)" bin/lib/platforms/binary-detector.js

# Verify comment exists
grep "Any error means binary not available" bin/lib/platforms/binary-detector.js

# Verify tests still pass
npm test -- binary-detector.test.js
```
  </verify>
  <done>Empty catch block fixed with error parameter and explanatory comment</done>
</task>

<task name="remove-allow-symlinks-env-var" type="auto">
  <files>bin/lib/installer/orchestrator.js</files>
  <action>
Remove ALLOW_SYMLINKS environment variable usage from orchestrator.js:

**Current code (lines 207-208):**
```javascript
// Check if we're in non-interactive mode (skipPrompts = true or ALLOW_SYMLINKS env var)
const allowSymlinks = skipPrompts || process.env.ALLOW_SYMLINKS === 'true';
```

**Problem:** Redundant environment variable - skipPrompts already handles non-interactive mode.

**Decision (from CONTEXT.md):**
- Remove ALLOW_SYMLINKS entirely - no production use case
- Policy: No env vars - all behavior via CLI flags or config
- Exception: Standard Node.js vars (NODE_ENV, DEBUG) acceptable
- No migration path needed - no public API contract

**New code:**
```javascript
// Non-interactive mode skips all prompts including symlink confirmations
const allowSymlinks = skipPrompts;
```

**Also update comment if needed** - search for any references to ALLOW_SYMLINKS in comments.

**Verification before change:**
```bash
# Find all ALLOW_SYMLINKS references
grep -rn "ALLOW_SYMLINKS" bin/ tests/ --include="*.js"

# Should only find orchestrator.js line 207-208
```

**After change:**
```bash
# Verify no ALLOW_SYMLINKS references remain
grep -rn "ALLOW_SYMLINKS" bin/ tests/ --include="*.js"

# Expected: no output (all references removed)
```

**Commit message:**
```
refactor(env): remove ALLOW_SYMLINKS environment variable

Remove redundant ALLOW_SYMLINKS env var from orchestrator.js.
skipPrompts flag already handles non-interactive mode.

Policy: All behavior controlled via CLI flags, not env vars.
Exception: Standard Node.js vars (NODE_ENV, DEBUG) acceptable.

Addresses: SC9
Phase: 07.2-codebase-cleanup-and-publishing-fixes
```
  </action>
  <verify>
```bash
# Verify ALLOW_SYMLINKS removed from code
grep -r "ALLOW_SYMLINKS" bin/ tests/ --include="*.js"

# Expected: no output (exit code 1)

# Verify orchestrator still works
npm test -- orchestrator.test.js

# Verify logic still correct (skipPrompts controls behavior)
grep "allowSymlinks.*skipPrompts" bin/lib/installer/orchestrator.js
```
  </verify>
  <done>ALLOW_SYMLINKS environment variable removed from codebase</done>
</task>

<task name="update-todo-comments" type="auto">
  <files>bin/lib/platforms/detector.js</files>
  <action>
Update TODO comment in detector.js (line 22) to explain current implementation:

**Current comment (line 22):**
```javascript
// TODO: Read version from manifest (Phase 6 - VERSION-02)
```

**Problem:** Comment says "Phase 6" but we're past that phase (currently Phase 7.2). Misleading for future maintainers.

**Decision (from CONTEXT.md):**
- UPDATE comments to explain current implementation (don't delete)
- Format: "// Previously TODO: X. Current implementation: Y because Z"
- Preserve context for future maintainers

**New comment:**
```javascript
// Previously TODO: Read version from manifest (Phase 6 - VERSION-02)
// Current implementation: Version detection not yet implemented.
// Detection only checks for manifest file presence (pathExists check).
// Version reading deferred - full version comparison not currently needed.
// Manifest structure supports version field, but reading it is future work.
```

**Context:** Look at surrounding code to understand what detection actually does vs what TODO wanted.

**Verification:**
```bash
# View context around line 22
sed -n '15,30p' bin/lib/platforms/detector.js

# Understand what detectInstallations actually returns
grep -A 20 "export.*detectInstallations" bin/lib/platforms/detector.js
```

**Commit message:**
```
docs(todo): update version detection TODO to explain current state

Replace outdated TODO (referencing Phase 6) with explanation of
current implementation. Version detection checks manifest presence
but doesn't read version field yet. Reading deferred to future work.

Addresses: SC5
Phase: 07.2-codebase-cleanup-and-publishing-fixes
```
  </action>
  <verify>
```bash
# Verify TODO replaced with "Previously TODO"
grep "Previously TODO" bin/lib/platforms/detector.js

# Verify old TODO removed
grep "^[[:space:]]*// TODO:" bin/lib/platforms/detector.js | wc -l

# Expected: 0 (or at least 1 less than before)

# Check if there are other TODOs that need attention
grep -rn "// TODO:" bin/ --include="*.js" | grep -v node_modules
```
  </verify>
  <done>TODO comment updated to explain current implementation</done>
</task>

## Success Criteria

- [ ] audit-functions.json deleted from root
- [ ] audit-functions.md deleted from root
- [ ] scripts/ directory deleted (contained only audit-functions.js)
- [ ] No broken imports (grep confirms no references to deleted files)
- [ ] Binary detector catch block has error parameter and comment
- [ ] ALLOW_SYMLINKS removed from orchestrator.js
- [ ] No ALLOW_SYMLINKS references remain in codebase
- [ ] TODO comment in detector.js updated to explain current implementation
- [ ] All changes committed in separate atomic commits
- [ ] All tests pass after changes

## Verification Commands

```bash
# Verify deletions
test ! -f audit-functions.json && test ! -f audit-functions.md && test ! -d scripts && echo "✓ Files deleted"

# Verify no broken references
grep -r "audit-functions\|ALLOW_SYMLINKS" bin/ tests/ --include="*.js" | grep -v "Previously TODO"

# Expected: no output (all references removed)

# Verify catch block fixed
grep -A 5 "} catch (error)" bin/lib/platforms/binary-detector.js

# Verify TODO updated
grep "Previously TODO" bin/lib/platforms/detector.js

# Run tests
npm test
```

## Output

**Files deleted:**
- audit-functions.json (5MB)
- audit-functions.md (35KB)
- scripts/audit-functions.js (14KB)
- scripts/ directory

**Files modified:**
- bin/lib/platforms/binary-detector.js (catch block improved)
- bin/lib/installer/orchestrator.js (ALLOW_SYMLINKS removed)
- bin/lib/platforms/detector.js (TODO updated)

**Git commits:** 4 separate commits (audit deletion, error handling, env var removal, TODO update)

---

**Next:** Plan 03 (Wave 3) - Development Tooling Cleanup
