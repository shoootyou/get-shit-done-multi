---
phase: 04-agent-translation
plan: 06
type: execute
wave: 2
depends_on: [04-05]
files_modified:
  - bin/lib/command-system/executor.js
  - commands/gsd/invoke-agent.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can invoke agents through GSD command system"
    - "Command executor imports and uses agent-invoker module"
    - "invoke-agent command exists and is user-facing"
    - "Agent invocation integrated into command execution flow"
    - "Users receive agent results through command output"
  artifacts:
    - path: "bin/lib/command-system/executor.js"
      provides: "Agent invoker integration"
      min_lines: 120
    - path: "commands/gsd/invoke-agent.md"
      provides: "User-facing agent invocation command"
      min_lines: 30
  key_links:
    - from: "commands/gsd/invoke-agent.md"
      to: "bin/lib/orchestration/agent-invoker.js"
      via: "require and invokeAgent call"
      pattern: "invokeAgent"
    - from: "bin/lib/command-system/executor.js"
      to: "bin/lib/orchestration/agent-invoker.js"
      via: "import for agent commands"
      pattern: "agent-invoker"
---

<objective>
Wire agent invoker into GSD command system to enable user-facing agent invocation through commands.

Purpose: Close verification gap #2 (no command integration) by creating user-facing agent invocation command and integrating agent-invoker into command execution flow.

Output: Users can invoke agents via `/gsd:invoke-agent` command with agent results returned through standard command output.
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-agent-translation/04-VERIFICATION.md
@.planning/phases/04-agent-translation/04-01-SUMMARY.md
@.planning/phases/04-agent-translation/04-05-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create invoke-agent command file</name>
  <files>commands/gsd/invoke-agent.md</files>
  <action>
Create new command file at `commands/gsd/invoke-agent.md` with YAML-like frontmatter and command prompt:

```markdown
---
name: invoke-agent
description: Invoke a GSD agent with a custom prompt across any CLI
category: orchestration
arguments:
  - name: agent
    description: Agent name (e.g., gsd-executor, gsd-planner, gsd-verifier)
    required: true
  - name: prompt
    description: Prompt to send to agent (quoted string)
    required: true
examples:
  - command: "/gsd:invoke-agent gsd-executor 'Implement authentication'"
    description: Invoke executor agent with custom prompt
  - command: "/gsd:invoke-agent gsd-planner 'Plan phase 3'"
    description: Invoke planner agent for phase planning
---

# Invoke Agent

You are invoking the **{agent}** agent with the following prompt:

**Prompt:** {prompt}

## Agent Invocation

The agent invoker will:
1. Detect the current CLI (Claude, Copilot, or Codex)
2. Load the agent registry to validate agent existence
3. Use the CLI-specific adapter to invoke the agent
4. Return the agent's response with performance metrics

## Instructions

Execute the agent invocation and return the result to the user.

**Technical implementation:**
```javascript
const { invokeAgent } = require('./bin/lib/orchestration/agent-invoker.js');
const AgentRegistry = require('./bin/lib/orchestration/agent-registry.js');

const registry = new AgentRegistry();
const agent = registry.getAgent(args[0]); // First arg is agent name

if (!agent) {
  throw new Error(`Agent not found: ${args[0]}. Run /gsd:help to see available agents.`);
}

const prompt = args.slice(1).join(' '); // Join remaining args as prompt
const result = await invokeAgent(agent, prompt);

if (result.success) {
  console.log(`\n✅ Agent ${result.agent} completed on ${result.cli}:\n`);
  console.log(result.result);
  console.log(`\n⏱️  Duration: ${result.duration}ms`);
} else {
  console.error(`\n❌ Agent ${result.agent} failed on ${result.cli}:\n`);
  console.error(result.error);
  if (result.stderr) {
    console.error(`\nStderr: ${result.stderr}`);
  }
  process.exit(1);
}
```

Execute this agent invocation now.
```

Key details:
- Follows existing command file structure (frontmatter + prompt)
- Provides clear examples for users
- Includes technical implementation in prompt for command handler
- Handles success and failure cases with clear output
  </action>
  <verify>
```bash
# Verify command file exists and has correct structure
test -f commands/gsd/invoke-agent.md && echo "✅ Command file created" || echo "❌ File missing"

# Check frontmatter
grep -q "name: invoke-agent" commands/gsd/invoke-agent.md && echo "✅ Frontmatter present"

# Check it references agent-invoker
grep -q "agent-invoker" commands/gsd/invoke-agent.md && echo "✅ Agent invoker referenced"
```

Expect: All checks pass.
  </verify>
  <done>
invoke-agent.md command file exists with frontmatter, prompt, and agent invocation logic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test command loading and registration</name>
  <files>bin/lib/command-system/executor.js</files>
  <action>
No code changes needed - verify that existing command loader will automatically discover and register the new invoke-agent command.

Test that the command system can load the new command:

```bash
# Run the CLI to test command loading
node bin/gsd-cli.js gsd:help | grep -i "invoke-agent"
```

If command appears in help output, loading works correctly. The existing loader (bin/lib/command-system/loader.js) automatically discovers .md files in commands/gsd/ and registers them.

If command does NOT appear:
1. Check loader.js loads from commands/gsd/ directory
2. Verify frontmatter parsing handles "name: invoke-agent"
3. Check registry.register() is called for each discovered command

Document findings for next task.
  </action>
  <verify>
```bash
# Verify command is registered
node bin/gsd-cli.js gsd:help 2>&1 | grep -i "invoke-agent" && echo "✅ Command registered" || echo "⚠️  Command not in help (may need handler implementation)"

# Count total commands
node bin/gsd-cli.js gsd:help 2>&1 | grep -c "gsd:" || echo "Command count"
```

Expect: invoke-agent appears in command listing or we understand why it doesn't (pending handler).
  </verify>
  <done>
Command loading verified - invoke-agent discoverable by loader or gaps identified for handler implementation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire agent-invoker into command handler</name>
  <files>commands/gsd/invoke-agent.md</files>
  <action>
Update invoke-agent.md to ensure the command handler can execute agent invocation.

The command prompt already includes JavaScript code for agent invocation. Verify the handler section has correct module paths and error handling.

If the command system uses a different pattern (e.g., separate handler files), create:
- `commands/gsd/invoke-agent-handler.js` with the implementation
- Or update the command file to reference the handler

Based on existing commands in commands/gsd/, follow the established pattern:

1. Check existing command files for handler patterns
2. If they use embedded JavaScript (in markdown), keep current approach
3. If they use separate handler files, create invoke-agent-handler.js
4. Ensure agent-invoker import path is correct relative to command location

Implementation should:
- Parse args[0] as agent name
- Join args[1+] as prompt
- Call invokeAgent with registry lookup
- Format output with success/failure indicators
- Include performance metrics (duration)
  </action>
  <verify>
```bash
# Check if command can be invoked (will fail on missing agent/prompt, but that proves integration)
node bin/gsd-cli.js gsd:invoke-agent 2>&1 | grep -E "(Agent not found|No command provided|arguments required)" && echo "✅ Command integrated" || echo "⚠️  Check command execution"

# Verify agent-invoker is importable from command context
node -e "
const path = require('path');
const invokerPath = path.join(__dirname, 'bin', 'lib', 'orchestration', 'agent-invoker.js');
console.log('Agent invoker path:', invokerPath);
require(invokerPath);
console.log('✅ Agent invoker importable');
" || echo "❌ Import failed"
```

Expect: Command responds to invocation (even if with error due to missing args).
  </verify>
  <done>
invoke-agent command fully integrated - users can invoke agents through GSD command system.
  </done>
</task>

</tasks>

<verification>
End-to-end test of agent invocation through command system:

```bash
# Test help includes new command
echo "=== Testing command registration ==="
node bin/gsd-cli.js gsd:help | grep "invoke-agent"

# Test command responds to invocation
echo "=== Testing command execution ==="
node bin/gsd-cli.js gsd:invoke-agent gsd-executor "Test prompt" 2>&1 | head -20

# Expected: Either agent result OR clear error (CLI not found, agent not available)
# NOT: "Command not found" or module import errors
```
</verification>

<success_criteria>
1. commands/gsd/invoke-agent.md exists with frontmatter and prompt
2. Command appears in `/gsd:help` output
3. Command executor can import agent-invoker module
4. Running invoke-agent attempts agent invocation (may fail if CLI unavailable, but integration works)
5. Users receive clear output (success or failure) when invoking agents
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-translation/04-06-SUMMARY.md` documenting:
- Command creation and structure
- Integration with command system
- Agent invoker wiring
- End-to-end test results
</output>
