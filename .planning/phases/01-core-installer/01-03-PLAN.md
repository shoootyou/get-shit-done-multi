---
phase: 01-core-installer
plan: 03
type: execute
wave: 3
depends_on: [01, 02]
files_modified:
  - test/integration-test.sh
  - test/verify-installation.sh
  - .github/workflows/test.yml (optional)
autonomous: false
user_setup:
  - Mock HOME environment for testing (exports HOME=/tmp/gsd-test-*/home)
  - Requires /tmp write access
must_haves:
  observables:
    - Run test/integration-test.sh → creates /tmp/gsd-test-*/ with isolated HOME
    - Installation succeeds with all 28 skills + 13 agents + 1 shared dir
    - Template variables replaced correctly (no {{VARIABLES}} in output)
    - Real ~/.claude/ directory untouched during tests
  artifacts:
    - test/integration-test.sh (isolated test with mock HOME)
    - test/verify-installation.sh (validates installation contents)
  wiring:
    - integration-test.sh sets HOME=/tmp/gsd-test-*/home
    - integration-test.sh calls npx with --claude flag
    - verify-installation.sh checks output directory structure
  key_links:
    - integration-test.sh → mock HOME → installer
    - verify-installation.sh → installed files → validation
---

# Phase 1, Plan 3: Integration Testing & Verification

## Objective

Create integration test that validates complete installation flow using mock HOME directory in /tmp. Test confirms all 28 skills, 13 agents, and shared directory install correctly with template variables replaced.

## Context

Plans 1 and 2 created the installer. Plan 3 creates isolated testing that never touches real directories. Uses mock HOME approach to test installation without polluting developer environment.

**Critical constraint:**
- ALL tests execute under /tmp directory only
- Each test gets unique folder /tmp/gsd-test-{timestamp}/
- Never test in source directory or current working directory
- Source files never modified during testing

**Research findings:**
- Mock HOME approach recommended for testing isolation
- Export HOME=/tmp/gsd-test-*/home before running installer
- Prevents pollution of real ~/.claude/ installations
- Safe parallel testing (unique timestamps)

## Tasks

<task name="create-integration-test" type="auto">
  <files>test/integration-test.sh</files>
  <action>
Create integration test script with mock HOME:

**Script: test/integration-test.sh**
```bash
#!/bin/bash

set -e  # Exit on error

echo "================================"
echo "Phase 1 Integration Test"
echo "================================"
echo ""

# Generate unique test directory
TEST_ID=$(date +%s)
TEST_DIR="/tmp/gsd-test-${TEST_ID}"

echo "Test directory: $TEST_DIR"
echo ""

# Setup test environment
mkdir -p "$TEST_DIR/home"
mkdir -p "$TEST_DIR/package"

# Copy package to test location (avoid testing in source)
echo "→ Copying package to test location..."
cp -r "$(pwd)"/* "$TEST_DIR/package/" 2>/dev/null || true
cp -r "$(pwd)"/.[!.]* "$TEST_DIR/package/" 2>/dev/null || true

cd "$TEST_DIR/package"

# Install dependencies
echo "→ Installing dependencies..."
npm install --silent

# Build templates
echo "→ Building templates..."
npm run build:templates

# Mock HOME directory for testing
export HOME="$TEST_DIR/home"
echo "→ Mock HOME: $HOME"
echo ""

# Run installer
echo "→ Running installer (--claude --global)..."
./bin/install.js --claude --global

echo ""
echo "================================"
echo "Verifying Installation"
echo "================================"
echo ""

EXIT_CODE=0

# Check skills directory
SKILLS_DIR="$HOME/.claude/skills"
if [ -d "$SKILLS_DIR" ]; then
  SKILL_COUNT=$(find "$SKILLS_DIR" -type d -name "gsd-*" | wc -l | tr -d ' ')
  echo "✓ Skills directory exists: $SKILLS_DIR"
  echo "  Found $SKILL_COUNT skill directories"
  
  if [ "$SKILL_COUNT" -ne 28 ]; then
    echo "✗ Expected 28 skills, found $SKILL_COUNT"
    EXIT_CODE=1
  else
    echo "✓ Correct number of skills (28)"
  fi
else
  echo "✗ Skills directory not found: $SKILLS_DIR"
  EXIT_CODE=1
fi

# Check agents directory
AGENTS_DIR="$HOME/.claude/agents"
if [ -d "$AGENTS_DIR" ]; then
  AGENT_COUNT=$(find "$AGENTS_DIR" -type f -name "*.agent.md" | wc -l | tr -d ' ')
  echo "✓ Agents directory exists: $AGENTS_DIR"
  echo "  Found $AGENT_COUNT agent files"
  
  if [ "$AGENT_COUNT" -ne 13 ]; then
    echo "✗ Expected 13 agents, found $AGENT_COUNT"
    EXIT_CODE=1
  else
    echo "✓ Correct number of agents (13)"
  fi
else
  echo "✗ Agents directory not found: $AGENTS_DIR"
  EXIT_CODE=1
fi

# Check shared directory
SHARED_DIR="$HOME/.claude/get-shit-done"
if [ -d "$SHARED_DIR" ]; then
  echo "✓ Shared directory exists: $SHARED_DIR"
  
  # Check for manifest
  MANIFEST="$SHARED_DIR/.gsd-install-manifest.json"
  if [ -f "$MANIFEST" ]; then
    echo "✓ Manifest exists: $MANIFEST"
    
    # Check manifest doesn't contain template variables
    if grep -q "{{" "$MANIFEST"; then
      echo "✗ Manifest contains unreplaced template variables"
      EXIT_CODE=1
    else
      echo "✓ Manifest variables replaced correctly"
    fi
  else
    echo "✗ Manifest not found: $MANIFEST"
    EXIT_CODE=1
  fi
else
  echo "✗ Shared directory not found: $SHARED_DIR"
  EXIT_CODE=1
fi

# Check for unreplaced template variables in random skill
SAMPLE_SKILL=$(find "$SKILLS_DIR" -name "SKILL.md" | head -1)
if [ -f "$SAMPLE_SKILL" ]; then
  echo ""
  echo "→ Checking sample skill for template variables..."
  
  if grep -q "{{PLATFORM_ROOT}}" "$SAMPLE_SKILL"; then
    echo "✗ Found unreplaced {{PLATFORM_ROOT}} in $SAMPLE_SKILL"
    EXIT_CODE=1
  elif grep -q "{{COMMAND_PREFIX}}" "$SAMPLE_SKILL"; then
    echo "✗ Found unreplaced {{COMMAND_PREFIX}} in $SAMPLE_SKILL"
    EXIT_CODE=1
  else
    echo "✓ Template variables replaced correctly"
  fi
  
  # Check variables were replaced with correct values
  if grep -q ".claude/" "$SAMPLE_SKILL"; then
    echo "✓ {{PLATFORM_ROOT}} replaced with .claude/"
  else
    echo "⚠ Warning: .claude/ not found in skill (might be expected)"
  fi
  
  if grep -q "/gsd-" "$SAMPLE_SKILL"; then
    echo "✓ {{COMMAND_PREFIX}} replaced with /gsd-"
  else
    echo "⚠ Warning: /gsd- not found in skill (might be expected)"
  fi
fi

echo ""
echo "================================"

# Cleanup on success
if [ $EXIT_CODE -eq 0 ]; then
  echo "✓ All tests passed"
  echo ""
  echo "→ Cleaning up test directory..."
  rm -rf "$TEST_DIR"
  echo "✓ Test directory removed"
else
  echo "✗ Tests failed"
  echo ""
  echo "⚠ Test artifacts left at: $TEST_DIR"
  echo "   (for debugging - remove manually when done)"
fi

echo ""
exit $EXIT_CODE
```

**Make executable:**
```bash
chmod +x test/integration-test.sh
```

**Implementation notes:**
- Creates unique /tmp/gsd-test-{timestamp} directory
- Copies package to test location (never tests in source)
- Mocks HOME to /tmp/gsd-test-*/home
- Verifies all 28 skills + 13 agents + shared directory installed
- Checks template variables replaced correctly
- Cleans up on success, leaves artifacts on failure for debugging
  </action>
  <verify>
Run integration test:

```bash
# From project root
./test/integration-test.sh
```

Verify:
- Test runs in /tmp/gsd-test-* directory
- All 28 skills installed
- All 13 agents installed
- Shared directory with manifest
- Template variables replaced
- Test directory cleaned up on success
- Real ~/.claude/ directory untouched
  </verify>
  <done>
✓ Integration test created with mock HOME isolation
✓ Tests never touch real directories or source files
✓ Verifies all installation requirements
✓ Cleanup handled automatically
  </done>
</task>

<task name="create-verification-script" type="auto">
  <files>test/verify-installation.sh</files>
  <action>
Create verification script for detailed installation checking:

**Script: test/verify-installation.sh**
```bash
#!/bin/bash

# Verify installation completeness and correctness
# Usage: ./verify-installation.sh <installation-path>

set -e

INSTALL_PATH="${1:-$HOME/.claude}"

echo "================================"
echo "Installation Verification"
echo "================================"
echo ""
echo "Checking: $INSTALL_PATH"
echo ""

EXIT_CODE=0

# Function to check directory exists
check_dir() {
  local dir="$1"
  local desc="$2"
  
  if [ -d "$dir" ]; then
    echo "✓ $desc: $dir"
    return 0
  else
    echo "✗ $desc not found: $dir"
    EXIT_CODE=1
    return 1
  fi
}

# Function to check file exists
check_file() {
  local file="$1"
  local desc="$2"
  
  if [ -f "$file" ]; then
    echo "✓ $desc: $file"
    return 0
  else
    echo "✗ $desc not found: $file"
    EXIT_CODE=1
    return 1
  fi
}

# Function to count items
count_items() {
  local pattern="$1"
  local expected="$2"
  local desc="$3"
  
  local count=$(find "$INSTALL_PATH" -path "$pattern" | wc -l | tr -d ' ')
  
  if [ "$count" -eq "$expected" ]; then
    echo "✓ $desc: $count (expected $expected)"
    return 0
  else
    echo "✗ $desc: $count (expected $expected)"
    EXIT_CODE=1
    return 1
  fi
}

echo "--- Directory Structure ---"
check_dir "$INSTALL_PATH/skills" "Skills directory"
check_dir "$INSTALL_PATH/agents" "Agents directory"
check_dir "$INSTALL_PATH/get-shit-done" "Shared directory"

echo ""
echo "--- File Counts ---"
count_items "$INSTALL_PATH/skills/gsd-*" 28 "Skills"
count_items "$INSTALL_PATH/agents/*.agent.md" 13 "Agents"

echo ""
echo "--- Critical Files ---"
check_file "$INSTALL_PATH/get-shit-done/.gsd-install-manifest.json" "Installation manifest"

echo ""
echo "--- Sample Skills ---"
check_dir "$INSTALL_PATH/skills/gsd-new-project" "gsd-new-project"
check_file "$INSTALL_PATH/skills/gsd-new-project/SKILL.md" "gsd-new-project/SKILL.md"
check_dir "$INSTALL_PATH/skills/gsd-execute-phase" "gsd-execute-phase"
check_file "$INSTALL_PATH/skills/gsd-execute-phase/SKILL.md" "gsd-execute-phase/SKILL.md"

echo ""
echo "--- Sample Agents ---"
check_file "$INSTALL_PATH/agents/gsd-planner.agent.md" "gsd-planner.agent.md"
check_file "$INSTALL_PATH/agents/gsd-executor.agent.md" "gsd-executor.agent.md"

echo ""
echo "--- Template Variables ---"

# Check for unreplaced variables
UNREPLACED_COUNT=$(grep -r "{{[A-Z_]*}}" "$INSTALL_PATH" 2>/dev/null | wc -l | tr -d ' ')

if [ "$UNREPLACED_COUNT" -eq 0 ]; then
  echo "✓ No unreplaced template variables found"
else
  echo "✗ Found $UNREPLACED_COUNT unreplaced template variables:"
  grep -r "{{[A-Z_]*}}" "$INSTALL_PATH" 2>/dev/null | head -5
  EXIT_CODE=1
fi

# Check for correct replacements
PLATFORM_ROOT_COUNT=$(grep -r "\.claude/" "$INSTALL_PATH" 2>/dev/null | wc -l | tr -d ' ')
if [ "$PLATFORM_ROOT_COUNT" -gt 0 ]; then
  echo "✓ {{PLATFORM_ROOT}} replaced correctly (found .claude/ in $PLATFORM_ROOT_COUNT files)"
else
  echo "⚠ Warning: .claude/ not found (might be expected)"
fi

COMMAND_PREFIX_COUNT=$(grep -r "/gsd-" "$INSTALL_PATH" 2>/dev/null | wc -l | tr -d ' ')
if [ "$COMMAND_PREFIX_COUNT" -gt 0 ]; then
  echo "✓ {{COMMAND_PREFIX}} replaced correctly (found /gsd- in $COMMAND_PREFIX_COUNT files)"
else
  echo "⚠ Warning: /gsd- not found (might be expected)"
fi

echo ""
echo "--- Manifest Contents ---"

MANIFEST="$INSTALL_PATH/get-shit-done/.gsd-install-manifest.json"
if [ -f "$MANIFEST" ]; then
  echo "Manifest content:"
  cat "$MANIFEST"
  
  # Check manifest has expected fields
  if grep -q '"version"' "$MANIFEST" && \
     grep -q '"platform"' "$MANIFEST" && \
     grep -q '"installedAt"' "$MANIFEST"; then
    echo ""
    echo "✓ Manifest has required fields"
  else
    echo ""
    echo "✗ Manifest missing required fields"
    EXIT_CODE=1
  fi
else
  echo "✗ Manifest not found"
  EXIT_CODE=1
fi

echo ""
echo "================================"

if [ $EXIT_CODE -eq 0 ]; then
  echo "✓ Installation verified successfully"
else
  echo "✗ Installation verification failed"
fi

echo ""
exit $EXIT_CODE
```

**Make executable:**
```bash
chmod +x test/verify-installation.sh
```

**Implementation notes:**
- Detailed verification of installation structure
- Counts skills, agents, shared directory contents
- Checks for unreplaced template variables
- Validates manifest content
- Can be used standalone or in integration test
  </action>
  <verify>
Run verification script (after installation):

```bash
# In test environment
./test/verify-installation.sh /tmp/gsd-test-*/home/.claude

# Or after real installation
./test/verify-installation.sh ~/.claude
```

Verify:
- All directory checks pass
- File counts correct (28 skills, 13 agents)
- No unreplaced template variables
- Manifest validated
  </verify>
  <done>
✓ Verification script created for detailed checking
✓ Can verify any installation path
✓ Validates structure, counts, and template replacement
  </done>
</task>

<task name="test-cli-flags" type="auto">
  <action>
Test CLI flags and error handling:

Create test script for CLI flag validation:

**Script: test/test-cli-flags.sh**
```bash
#!/bin/bash

echo "================================"
echo "CLI Flags Test"
echo "================================"
echo ""

EXIT_CODE=0

# Test --help
echo "→ Testing --help flag..."
./bin/install.js --help > /dev/null 2>&1
if [ $? -eq 0 ]; then
  echo "✓ --help works"
else
  echo "✗ --help failed"
  EXIT_CODE=1
fi

# Test --version
echo "→ Testing --version flag..."
OUTPUT=$(./bin/install.js --version 2>&1)
if echo "$OUTPUT" | grep -q "2.0.0"; then
  echo "✓ --version shows 2.0.0"
else
  echo "✗ --version doesn't show version"
  EXIT_CODE=1
fi

# Test unsupported platform (--copilot)
echo "→ Testing unsupported platform (--copilot)..."
OUTPUT=$(./bin/install.js --copilot 2>&1)
if echo "$OUTPUT" | grep -q "not supported"; then
  echo "✓ --copilot shows 'not supported' error"
else
  echo "✗ --copilot should show error"
  EXIT_CODE=1
fi

# Test unsupported platform (--codex)
echo "→ Testing unsupported platform (--codex)..."
OUTPUT=$(./bin/install.js --codex 2>&1)
if echo "$OUTPUT" | grep -q "not supported"; then
  echo "✓ --codex shows 'not supported' error"
else
  echo "✗ --codex should show error"
  EXIT_CODE=1
fi

# Test no platform specified
echo "→ Testing no platform specified..."
OUTPUT=$(./bin/install.js 2>&1)
if echo "$OUTPUT" | grep -q "No platform specified"; then
  echo "✓ Shows 'No platform specified' error"
else
  echo "✗ Should show error when no platform"
  EXIT_CODE=1
fi

echo ""
echo "================================"

if [ $EXIT_CODE -eq 0 ]; then
  echo "✓ All CLI flag tests passed"
else
  echo "✗ Some CLI flag tests failed"
fi

echo ""
exit $EXIT_CODE
```

**Make executable:**
```bash
chmod +x test/test-cli-flags.sh
```

Run tests:
```bash
./test/test-cli-flags.sh
```
  </action>
  <verify>
Run CLI flag tests:

```bash
./test/test-cli-flags.sh
```

Verify:
- --help works without error
- --version shows 2.0.0
- --copilot shows "not supported" error
- --codex shows "not supported" error
- No platform shows error with usage hint
  </verify>
  <done>
✓ CLI flag tests created and passing
✓ Error messages validated
✓ Version display working
  </done>
</task>

<task name="create-test-runner" type="auto">
  <files>test/run-all-tests.sh</files>
  <action>
Create master test runner script:

**Script: test/run-all-tests.sh**
```bash
#!/bin/bash

echo "================================"
echo "Phase 1 Test Suite"
echo "================================"
echo ""

EXIT_CODE=0

# Ensure we're in project root
if [ ! -f "package.json" ]; then
  echo "✗ Run from project root"
  exit 1
fi

# Run CLI flags test
echo "1. CLI Flags Test"
echo "================================"
./test/test-cli-flags.sh
if [ $? -ne 0 ]; then
  EXIT_CODE=1
fi
echo ""

# Run integration test
echo "2. Integration Test"
echo "================================"
./test/integration-test.sh
if [ $? -ne 0 ]; then
  EXIT_CODE=1
fi
echo ""

echo "================================"
echo "Test Suite Complete"
echo "================================"

if [ $EXIT_CODE -eq 0 ]; then
  echo "✓ All tests passed"
else
  echo "✗ Some tests failed"
fi

exit $EXIT_CODE
```

**Make executable:**
```bash
chmod +x test/run-all-tests.sh
```

**Add npm script:**
```json
{
  "scripts": {
    "test": "bash test/run-all-tests.sh"
  }
}
```
  </action>
  <verify>
Run full test suite:

```bash
npm test
```

Verify:
- All tests run in sequence
- Exit code reflects overall pass/fail
- Summary shows which tests passed/failed
  </verify>
  <done>
✓ Master test runner created
✓ npm test command configured
✓ All tests run in sequence with summary
  </done>
</task>

<task name="verify-phase-goals" type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 1 installer with:
- Template build system (prepublishOnly hook)
- CLI entry point with Commander
- Installation orchestrator
- Template rendering with runtime variables
- Integration tests with mock HOME isolation
  </what-built>
  <how-to-verify>
1. **Build templates:**
   ```bash
   npm run build:templates
   ```
   - Verify templates/ directory created
   - Check templates/skills/ has 28 directories
   - Check templates/agents/ has 13 files
   - Check templates/get-shit-done/ exists

2. **Test CLI flags:**
   ```bash
   ./bin/install.js --help
   ./bin/install.js --version
   ```
   - Verify help text shows available flags
   - Verify version shows 2.0.0

3. **Run integration test:**
   ```bash
   npm test
   ```
   - Verify all tests pass
   - Verify test runs in /tmp (not source directory)
   - Verify real ~/.claude/ untouched

4. **Manual installation test (optional):**
   ```bash
   # Create backup first!
   mv ~/.claude ~/.claude-backup 2>/dev/null || true
   
   # Test installation
   ./bin/install.js --claude --global
   
   # Verify installation
   ./test/verify-installation.sh ~/.claude
   
   # Restore backup
   rm -rf ~/.claude
   mv ~/.claude-backup ~/.claude 2>/dev/null || true
   ```
   - Verify all 28 skills installed
   - Verify all 13 agents installed
   - Verify shared directory with manifest
   - Verify template variables replaced

5. **Check package.json:**
   - Verify "type": "module"
   - Verify "engines": ">=16.7.0"
   - Verify "bin" entry points to ./bin/install.js
   - Verify "prepublishOnly" hook configured
   - Verify "files" includes bin/, templates/

6. **Verify Phase 1 Success Criteria (from ROADMAP.md):**
   - [ ] User runs `npx get-shit-done-multi --claude` → installs to ~/.claude/skills/gsd-*/
   - [ ] All 29 skills from `.github/skills/` converted to templates and installed (28 skills, 1 is get-shit-done shared directory)
   - [ ] All 13 agents from `.github/agents/` converted to templates and installed
   - [ ] Shared directory (`get-shit-done/`) copies to `.claude/get-shit-done/` with manifest template
   - [ ] Template variables replaced correctly in output files
   - [ ] Skill structure: `.claude/skills/gsd-<name>/SKILL.md` (directory-based)
   - [ ] Installation completes in <30 seconds
   - [ ] `--help` and `--version` flags work correctly
   - [ ] Version displays as 2.0.0
  </how-to-verify>
  <resume-signal>
Type "approved" if all verification steps pass, or describe any issues found.
  </resume-signal>
</task>

## Success Criteria

- [ ] Integration test runs in /tmp with mock HOME isolation
- [ ] All 28 skills install correctly to mock ~/.claude/skills/
- [ ] All 13 agents install correctly to mock ~/.claude/agents/
- [ ] Shared directory with manifest installs to mock ~/.claude/get-shit-done/
- [ ] Template variables replaced correctly (no {{VARIABLES}} in output)
- [ ] Real ~/.claude/ directory never touched during tests
- [ ] CLI flags tested (--help, --version, error cases)
- [ ] Test cleanup removes /tmp directories on success
- [ ] Test artifacts preserved on failure for debugging
- [ ] npm test command runs full test suite

## Output

Phase 1 complete with:
- ✓ Template build system (prepublishOnly hook)
- ✓ Core modules (file operations, paths, output)
- ✓ Template rendering (runtime variable substitution)
- ✓ Installation orchestrator (skills, agents, shared directory)
- ✓ CLI entry point with Commander
- ✓ Integration tests with mock HOME isolation
- ✓ Verification scripts for installation validation

Ready for Phase 2: Multi-Platform Support (adapt for Copilot and Codex)
