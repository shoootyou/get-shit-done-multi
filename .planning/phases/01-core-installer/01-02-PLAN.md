---
phase: 01-core-installer
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - bin/install.js
  - bin/lib/installer/installer.js
  - bin/lib/platforms/platform-detector.js
  - templates/ (generated by build-templates.js)
autonomous: true
must_haves:
  observable_truths:
    - User can run `npx get-shit-done-multi --claude` and skills install
    - User sees --help with usage information
    - User sees --version with installer version
    - User sees progress during installation
    - User sees success message with next steps after installation
    - Templates directory exists with converted skills and agents
  required_artifacts:
    - bin/install.js (CLI entry point with commander setup)
    - bin/lib/installer/installer.js (installation orchestration logic)
    - bin/lib/platforms/platform-detector.js (detect existing GSD installations)
    - templates/skills/ (29 skill directories with {{VARIABLES}})
    - templates/agents/ (13 agent files with {{VARIABLES}})
    - templates/get-shit-done/ (shared directory)
  required_wiring:
    - install.js uses commander for CLI parsing
    - install.js delegates to installer.js for business logic
    - installer.js uses modules from Plan 1 (file-operations, template-renderer, etc.)
    - installer.js orchestrates: validate → render → copy → report
    - platform-detector checks for existing ~/.claude/skills/gsd-*/ directories
    - templates/ populated by running npm run prepublishOnly
  key_links:
    - CLI flags (--claude, --help, --version, --no-color) all work
    - Error handling catches filesystem errors and formats with errors.js
    - Success message includes next steps per CONTEXT.md
---

# Phase 1, Plan 2: Template System & CLI Output

## Objective

Build the CLI entry point (install.js) that parses flags with Commander, the installer orchestrator (installer.js) that coordinates template loading/rendering/installation, and the platform detector (platform-detector.js) that checks for existing installations. Generate templates/ directory using the build script from Plan 1. Wire everything together so `npx get-shit-done-multi --claude` completes a full installation to ~/.claude/skills/gsd/.

## Context

**Why this matters:** This is where all the foundation modules from Plan 1 come together into a working installer. Users will interact with the CLI, and the installer orchestrator is responsible for coordinating validation, rendering, and file copying.

**What exists:** 
- From Plan 1: file-operations, path-resolver, template-renderer, template-validator, output, errors modules
- From Plan 1: build-templates.js script and prepublishOnly hook
- From repository: .github/skills/ with 29 skills, .github/agents/ with 13 agents

**Decisions from context:**
- CLI uses commander for flag parsing, help generation, typo suggestions (from RESEARCH.md)
- Installation orchestrator is thin layer that delegates to domain modules (from RESEARCH.md)
- Platform detector checks for existing GSD installations via paths, not CLI binaries (from REQUIREMENTS.md PLATFORM-01)
- Phase 1 only supports --claude flag, other platforms error with "coming in Phase 2" message (from CONTEXT.md)
- Success message includes next steps: "Run /gsd-new-project to start" (from CONTEXT.md)
- Progress shows moderate verbosity with checkmarks (from CONTEXT.md)

**Requirements covered:**
- INSTALL-01: NPX entry point
- INSTALL-02: File system operations (orchestrated)
- INSTALL-03: Template rendering (orchestrated)
- CLI-02: Platform selection flags (--claude)
- CLI-05: Help and version flags
- PLATFORM-01: Platform detection (existing installations)
- TEMPLATE-01: Use templates/ as source

**Dependencies:** 
- Plan 1 must complete first (needs all foundation modules)

## Tasks

<task name="generate-templates-directory" type="auto">
  <files>templates/</files>
  <action>
Run the build script from Plan 1 to generate templates/ directory from .github/ source:

```bash
# Run build script (invokes scripts/build-templates.js)
npm run prepublishOnly
```

This will:
1. Clean existing templates/ directory
2. Copy all 29 skills from .github/skills/ to templates/skills/
3. Copy all 13 agents from .github/agents/ to templates/agents/
4. Copy get-shit-done/ shared directory to templates/get-shit-done/
5. Convert all files by replacing hardcoded values with {{VARIABLES}}:
   - .github/ → {{PLATFORM_ROOT}}
   - /gsd- → {{COMMAND_PREFIX}}
   - Version numbers → {{VERSION}}

Expected structure after build:
```
templates/
├── skills/
│   ├── gsd-new-project/
│   │   └── SKILL.md
│   ├── gsd-plan-phase/
│   │   └── SKILL.md
│   └── ... (27 more)
├── agents/
│   ├── gsd-planner.agent.md
│   ├── gsd-executor.agent.md
│   └── ... (11 more)
└── get-shit-done/
    ├── references/
    ├── workflows/
    └── ...
```

Rationale from RESEARCH.md: Pre-build templates at package time ensures NPM package is self-contained and users don't need .github/ source files.
  </action>
  <verify>
```bash
# Verify templates directory structure
test -d templates/skills && echo "✓ Skills directory exists"
test -d templates/agents && echo "✓ Agents directory exists"
test -d templates/get-shit-done && echo "✓ Shared directory exists"

# Count skills and agents
SKILL_COUNT=$(find templates/skills -type d -name "gsd-*" | wc -l)
AGENT_COUNT=$(find templates/agents -name "*.agent.md" | wc -l)

echo "Skills: $SKILL_COUNT (expected: 29)"
echo "Agents: $AGENT_COUNT (expected: 13)"

# Verify variable substitution in sample file
SAMPLE_SKILL=$(find templates/skills -name "SKILL.md" | head -1)
if [ -f "$SAMPLE_SKILL" ]; then
  grep -q "{{PLATFORM_ROOT}}" "$SAMPLE_SKILL" && echo "✓ PLATFORM_ROOT variable present"
  grep -q "{{COMMAND_PREFIX}}" "$SAMPLE_SKILL" && echo "✓ COMMAND_PREFIX variable present"
fi
```
  </verify>
  <done>templates/ directory exists with 29 skills, 13 agents, and shared directory, all with {{VARIABLES}} substituted</done>
</task>

<task name="create-platform-detector" type="auto">
  <files>bin/lib/platforms/platform-detector.js</files>
  <action>
Create platform detection module to find existing GSD installations.

**detectInstallation(platform, scope):**
- Check if GSD installation exists at platform path
- platform: 'claude' (Phase 1 only)
- scope: 'global' or 'local'
- Check for existing skills directory: ~/.claude/skills/gsd-*/ (at least one skill present)
- Return: { exists: boolean, path: string, skillCount: number }

**detectAllInstallations():**
- Check all possible installation locations:
  - Global: ~/.claude/skills/
  - Local: ./.claude/skills/
- Return array of detected installations
- Phase 1: Only check Claude paths
- Phase 5 will enhance to read manifest versions

**Implementation:**
```javascript
import { existsSync, readdirSync } from 'fs';
import { join } from 'path';
import { normalizeHomePath } from '../paths/path-resolver.js';

export async function detectInstallation(platform, scope) {
  if (platform !== 'claude') {
    throw new Error(`Platform ${platform} not supported in Phase 1`);
  }
  
  const basePath = scope === 'global' 
    ? normalizeHomePath('~/.claude/skills/')
    : './.claude/skills/';
  
  if (!existsSync(basePath)) {
    return { exists: false, path: basePath, skillCount: 0 };
  }
  
  // Count gsd-* directories
  const entries = readdirSync(basePath, { withFileTypes: true });
  const gsdSkills = entries.filter(e => 
    e.isDirectory() && e.name.startsWith('gsd-')
  );
  
  return {
    exists: gsdSkills.length > 0,
    path: basePath,
    skillCount: gsdSkills.length
  };
}

export async function detectAllInstallations() {
  const installations = [];
  
  // Check global
  const globalInstall = await detectInstallation('claude', 'global');
  if (globalInstall.exists) {
    installations.push({ ...globalInstall, scope: 'global', platform: 'claude' });
  }
  
  // Check local
  const localInstall = await detectInstallation('claude', 'local');
  if (localInstall.exists) {
    installations.push({ ...localInstall, scope: 'local', platform: 'claude' });
  }
  
  return installations;
}
```

Rationale from REQUIREMENTS.md PLATFORM-01: Detection uses GSD-specific paths (.github/skills/gsd-*), not CLI binary detection.
  </action>
  <verify>
```bash
# Test platform detector in isolated /tmp (per TEST-01)
TEST_DIR="/tmp/gsd-test-$(date +%s)"
mkdir -p "$TEST_DIR"
cd "$TEST_DIR"

# Create mock installation
mkdir -p .claude/skills/gsd-test-skill

# Test detection
node -e "
import { detectInstallation, detectAllInstallations } from '$OLDPWD/bin/lib/platforms/platform-detector.js';

const localInstall = await detectInstallation('claude', 'local');
console.assert(localInstall.exists === true, 'Local installation not detected');
console.assert(localInstall.skillCount >= 1, 'Skill count incorrect');

const all = await detectAllInstallations();
console.assert(all.length >= 1, 'detectAllInstallations failed');

console.log('✓ Platform detection works');
"

# Cleanup
cd "$OLDPWD"
rm -rf "$TEST_DIR"
```
  </verify>
  <done>bin/lib/platforms/platform-detector.js exists with detectInstallation and detectAllInstallations functions</done>
</task>

<task name="create-installer-orchestrator" type="auto">
  <files>bin/lib/installer/installer.js</files>
  <action>
Create installer orchestration module that coordinates the installation process.

**install(options):**
Main installation function that orchestrates:
1. Validate options (require --claude flag in Phase 1)
2. Detect existing installation
3. Validate templates (pre-flight check)
4. Render templates with variables
5. Copy skills to target directory
6. Copy agents to target directory
7. Copy shared directory
8. Report success with next steps

**Implementation structure:**
```javascript
import { copyFile, copyDirectory, ensureDirectory } from '../io/file-operations.js';
import { getSkillsPath, normalizeHomePath } from '../paths/path-resolver.js';
import { renderTemplate, renderFile, getDefaultVariables } from '../templates/template-renderer.js';
import { validateTemplateDirectory } from '../templates/template-validator.js';
import { progress, success, warning, info, createProgressReporter } from '../cli/output.js';
import { formatError, isExpectedError } from '../cli/errors.js';
import { detectInstallation } from '../platforms/platform-detector.js';
import { readdirSync, readFileSync, writeFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

export async function install(options) {
  try {
    // 1. Validate options
    if (!options.claude) {
      throw new Error('Phase 1 requires --claude flag. Other platforms coming in Phase 2.');
    }
    
    const platform = 'claude';
    const scope = options.local ? 'local' : 'global';
    
    // 2. Detect existing installation
    const existing = await detectInstallation(platform, scope);
    if (existing.exists) {
      warning(`Existing installation found at ${existing.path} (${existing.skillCount} skills)`);
      info('Files will be overwritten');
    }
    
    // 3. Validate templates (pre-flight)
    progress('Validating templates...');
    const templateDir = join(__dirname, '../../templates');
    const validationResult = await validateTemplateDirectory(templateDir, [
      'PLATFORM_ROOT', 'VERSION', 'COMMAND_PREFIX', 
      'INSTALL_DATE', 'USER', 'PLATFORM_NAME'
    ]);
    
    if (validationResult.issueCount > 0) {
      throw new Error(`Template validation failed: ${validationResult.issueCount} issues found`);
    }
    
    // 4. Prepare variables
    const variables = getDefaultVariables();
    
    // 5. Determine target paths
    const targetBase = scope === 'global' 
      ? normalizeHomePath('~/.claude/') 
      : './.claude/';
    const skillsPath = join(targetBase, 'skills/gsd/');
    const agentsPath = join(targetBase, 'agents/');
    const sharedPath = join(targetBase, 'get-shit-done/');
    
    // 6. Create base directories
    progress('Creating directories...');
    await ensureDirectory(skillsPath);
    await ensureDirectory(agentsPath);
    await ensureDirectory(sharedPath);
    
    // 7. Install skills (29 directories)
    progress('Installing skills...');
    const skillsTemplateDir = join(templateDir, 'skills');
    const skillDirs = readdirSync(skillsTemplateDir, { withFileTypes: true })
      .filter(e => e.isDirectory());
    
    for (const skillDir of skillDirs) {
      const srcPath = join(skillsTemplateDir, skillDir.name);
      const destPath = join(skillsPath, skillDir.name);
      
      // Copy directory structure
      await ensureDirectory(destPath);
      
      // Render and copy SKILL.md
      const skillFile = join(srcPath, 'SKILL.md');
      const renderedContent = await renderFile(skillFile, variables);
      const destFile = join(destPath, 'SKILL.md');
      
      await writeFileSync(destFile, renderedContent, 'utf-8');
    }
    
    // 8. Install agents (13 flat files)
    progress('Installing agents...');
    const agentsTemplateDir = join(templateDir, 'agents');
    const agentFiles = readdirSync(agentsTemplateDir)
      .filter(f => f.endsWith('.agent.md'));
    
    for (const agentFile of agentFiles) {
      const srcPath = join(agentsTemplateDir, agentFile);
      const renderedContent = await renderFile(srcPath, variables);
      const destFile = join(agentsPath, agentFile);
      
      await writeFileSync(destFile, renderedContent, 'utf-8');
    }
    
    // 9. Copy shared directory
    progress('Installing shared resources...');
    const sharedTemplateDir = join(templateDir, 'get-shit-done');
    await copyDirectory(sharedTemplateDir, sharedPath);
    
    // 10. Report success
    success('Installation complete!', {
      installedTo: scope === 'global' ? '~/.claude/' : './.claude/',
      skills: skillDirs.length,
      agents: agentFiles.length
    });
    
    // Show next steps from CONTEXT.md
    console.log('\nNext steps:');
    console.log('- Restart Claude Code or reload skills');
    console.log('- Run /gsd-new-project to start a new project');
    
  } catch (error) {
    if (isExpectedError(error)) {
      console.error(formatError(error));
    } else {
      console.error(`✗ Installation failed: ${error.message}`);
    }
    throw error;
  }
}
```

Progress format from CONTEXT.md: Moderate verbosity with checkmarks.

Error handling: Use formatError() for expected errors (EACCES, ENOSPC), show stack trace for unexpected.
  </action>
  <verify>
```bash
# Test installer in isolated /tmp directory (per TEST-01)
TEST_DIR="/tmp/gsd-test-$(date +%s)"
mkdir -p "$TEST_DIR"
cd "$TEST_DIR"

# Create minimal templates for testing
mkdir -p templates/skills/gsd-test
echo "Skill: {{PLATFORM_ROOT}} {{VERSION}}" > templates/skills/gsd-test/SKILL.md

mkdir -p templates/agents
echo "Agent: {{COMMAND_PREFIX}}" > templates/agents/gsd-test.agent.md

mkdir -p templates/get-shit-done
echo "Shared" > templates/get-shit-done/README.md

# Test installation (this is a dry-run test, won't execute full installer yet)
# Full integration test in Plan 3

# Verify module can be imported
node -e "
import { install } from '$OLDPWD/bin/lib/installer/installer.js';
console.log('✓ Installer module importable');
"

# Cleanup
cd "$OLDPWD"
rm -rf "$TEST_DIR"
```
  </verify>
  <done>bin/lib/installer/installer.js exists with install() function that orchestrates validation → rendering → copying → reporting</done>
</task>

<task name="create-cli-entry-point" type="auto">
  <files>bin/install.js</files>
  <action>
Create CLI entry point using Commander for flag parsing.

**Features:**
- Parse CLI flags: --claude, --help, --version, --no-color, --local
- Generate help text automatically via Commander
- Handle --version to show installer version and detected installations
- Delegate to installer.js for business logic
- Catch and format errors

**Implementation:**
```javascript
#!/usr/bin/env node

import { Command } from 'commander';
import { readFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';
import { install } from './lib/installer/installer.js';
import { detectAllInstallations } from './lib/platforms/platform-detector.js';
import chalk from 'chalk';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Read package.json for version
const packageJson = JSON.parse(
  readFileSync(join(__dirname, '../package.json'), 'utf-8')
);

const program = new Command();

program
  .name('get-shit-done-multi')
  .description('Install GSD skills and agents to AI coding assistants')
  .version(packageJson.version, '-v, --version', 'Show version and detected installations')
  .option('--claude', 'Install to Claude Code (~/.claude/)')
  .option('--local', 'Install to current directory (./.claude/) instead of global (~/.claude/)')
  .option('--no-color', 'Disable colored output')
  .addHelpText('after', `
Examples:
  $ npx get-shit-done-multi --claude
  $ npx get-shit-done-multi --claude --local
  
Phase 1 supports Claude Code only. Copilot and Codex support coming in Phase 2.
  `)
  .action(async (options) => {
    try {
      // Handle --version manually to show detected installations
      if (options.version) {
        console.log(`get-shit-done-multi v${packageJson.version}\n`);
        
        const installations = await detectAllInstallations();
        if (installations.length > 0) {
          console.log('Detected installations:');
          installations.forEach(inst => {
            console.log(`  - ${inst.platform} (${inst.scope}): ${inst.skillCount} skills at ${inst.path}`);
          });
        } else {
          console.log('No existing installations detected.');
        }
        
        process.exit(0);
      }
      
      await install(options);
      process.exit(0);
    } catch (error) {
      // Error already formatted and logged by installer
      process.exit(1);
    }
  });

// Handle invalid flags with suggestions (Commander does this automatically)
program.showHelpAfterError('(add --help for additional information)');

program.parse();
```

**Make executable:**
```bash
chmod +x bin/install.js
```

**Shebang:** `#!/usr/bin/env node`

Help text structure from CONTEXT.md:
- Brief help by default
- Examples showing common usage
- Note about Phase 1 supporting Claude only

Invalid flag handling: Commander automatically suggests closest match.
  </action>
  <verify>
```bash
# Test CLI entry point (don't actually install, just verify parsing)

# Test --help
node bin/install.js --help | grep "Install to Claude Code" && echo "✓ Help text shows"

# Test --version (will show "No installations" if run in source directory)
node bin/install.js --version | grep "get-shit-done-multi v" && echo "✓ Version shows"

# Test invalid flag suggestion (Commander handles this)
node bin/install.js --clude 2>&1 | grep -i "unknown option" && echo "✓ Invalid flag caught"

# Verify executable bit
test -x bin/install.js && echo "✓ install.js is executable"

# Verify shebang
head -1 bin/install.js | grep "#!/usr/bin/env node" && echo "✓ Shebang present"
```
  </verify>
  <done>bin/install.js exists with Commander setup, --claude/--help/--version flags, and delegates to installer.js</done>
</task>

## Verification

After completing all tasks, verify the complete installation flow:

```bash
# 1. Verify templates generated
test -d templates/skills && echo "✓ Templates exist"
test -d templates/agents && echo "✓ Agents exist"

# 2. Test CLI help and version
node bin/install.js --help | grep "Install to Claude Code"
node bin/install.js --version | grep "v2.0.0"

# 3. Test full installation in isolated /tmp (per TEST-01)
TEST_DIR="/tmp/gsd-test-$(date +%s)"
mkdir -p "$TEST_DIR"
cd "$TEST_DIR"

# Run installation to local directory
node "$OLDPWD/bin/install.js" --claude --local

# Verify installation
test -d .claude/skills/gsd && echo "✓ Skills installed"
test -d .claude/agents && echo "✓ Agents installed"
test -d .claude/get-shit-done && echo "✓ Shared directory copied"

# Verify variable substitution in installed files
INSTALLED_SKILL=$(find .claude/skills/gsd -name "SKILL.md" | head -1)
if [ -f "$INSTALLED_SKILL" ]; then
  grep -v "{{" "$INSTALLED_SKILL" | grep -q "\.claude/" && echo "✓ Variables rendered"
fi

# Count installed files
SKILL_COUNT=$(find .claude/skills/gsd -type d -name "gsd-*" | wc -l)
AGENT_COUNT=$(find .claude/agents -name "*.agent.md" | wc -l)

echo "Installed: $SKILL_COUNT skills, $AGENT_COUNT agents"

# Cleanup
cd "$OLDPWD"
rm -rf "$TEST_DIR"

# 4. Test that source files were NOT modified (TEST-01 requirement)
git status --porcelain .github/ | grep "^ M" && echo "✗ Source files modified!" || echo "✓ Source files unchanged"
```

## Success Criteria

**Observable outcomes:**
- [ ] User can run `npx get-shit-done-multi --claude` and skills install to ~/.claude/skills/gsd/
- [ ] User runs `npx get-shit-done-multi --help` and sees usage information
- [ ] User runs `npx get-shit-done-multi --version` and sees installer version + detected installations
- [ ] User sees progress messages during installation (✓ Validating templates, ✓ Installing skills, etc.)
- [ ] User sees success message with next steps: "Run /gsd-new-project to start"
- [ ] Templates directory exists with 29 skills and 13 agents with {{VARIABLES}}
- [ ] Variables are replaced correctly ({{PLATFORM_ROOT}} → .claude/, {{VERSION}} → 2.0.0)

**Required artifacts:**
- [x] bin/install.js with Commander CLI setup
- [x] bin/lib/installer/installer.js with install() orchestration function
- [x] bin/lib/platforms/platform-detector.js with detection functions
- [x] templates/skills/ with 29 skill directories
- [x] templates/agents/ with 13 agent files
- [x] templates/get-shit-done/ shared directory

**Wiring validated:**
- [x] CLI delegates to installer.js
- [x] Installer uses all Plan 1 modules (file-operations, template-renderer, etc.)
- [x] Templates validated before any file writes
- [x] Variables rendered during installation
- [x] Progress and success messages use output.js from Plan 1
- [x] Errors formatted with errors.js from Plan 1

**Key links functional:**
- [x] `npm run prepublishOnly` generates templates/
- [x] `node bin/install.js --help` shows usage
- [x] `node bin/install.js --version` shows version and detected installations
- [x] `node bin/install.js --claude --local` installs to ./.claude/
- [x] Source files (.github/, get-shit-done/) never modified during testing

## Output

**Files created:**
- `bin/install.js` — CLI entry point with Commander
- `bin/lib/installer/installer.js` — Installation orchestrator
- `bin/lib/platforms/platform-detector.js` — Platform detection
- `templates/skills/` — 29 skill directories (generated)
- `templates/agents/` — 13 agent files (generated)
- `templates/get-shit-done/` — Shared directory (generated)

**Next step:** Plan 3 will create comprehensive integration tests to verify the complete installation flow end-to-end, test error scenarios, and ensure all requirements are met.
