---
phase: 11-skill-validation-and-adapter-system
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - bin/lib/frontmatter/claude-validator.js
  - bin/lib/frontmatter/copilot-validator.js
  - bin/lib/frontmatter/codex-validator.js
  - bin/lib/installer/install-skills.js
  - tests/integration/skill-validation.test.js
autonomous: true

must_haves:
  truths:
    - "Claude validator validates skills with optional allowed-tools and argument-hint fields"
    - "Copilot validator validates skills with optional allowed-tools and argument-hint fields"
    - "Codex validator validates skills with optional allowed-tools and argument-hint fields"
    - "Invalid required fields stop installation with formatted error"
    - "Invalid optional fields generate warnings but continue installation"
    - "Validation runs after template variable replacement in install-skills.js"
    - "Integration tests verify validation catches common errors"
  artifacts:
    - path: "bin/lib/frontmatter/claude-validator.js"
      provides: "Claude-specific skill validator"
      exports: ["ClaudeValidator"]
      min_lines: 50
    - path: "bin/lib/frontmatter/copilot-validator.js"
      provides: "Copilot-specific skill validator"
      exports: ["CopilotValidator"]
      min_lines: 50
    - path: "bin/lib/frontmatter/codex-validator.js"
      provides: "Codex-specific skill validator"
      exports: ["CodexValidator"]
      min_lines: 50
    - path: "bin/lib/installer/install-skills.js"
      provides: "Skill installation with validation"
      contains: "validateSkillFrontmatter"
      min_lines: 100
    - path: "tests/integration/skill-validation.test.js"
      provides: "Integration tests for skill validation"
      min_lines: 150
  key_links:
    - from: "bin/lib/frontmatter/claude-validator.js"
      to: "bin/lib/frontmatter/base-validator.js"
      via: "extends BaseValidator"
      pattern: "extends BaseValidator"
    - from: "bin/lib/installer/install-skills.js"
      to: "bin/lib/frontmatter/claude-validator.js"
      via: "imports and uses validator"
      pattern: "import.*Validator.*from.*frontmatter"
    - from: "bin/lib/installer/install-skills.js"
      to: "ValidationError"
      via: "catches and handles validation errors"
      pattern: "catch.*ValidationError"
---

<objective>
Create platform-specific skill validators and integrate validation into skill installation pipeline.

**Purpose:** Complete the validation system by implementing Claude, Copilot, and Codex validators that extend the base validator, then wire validation into install-skills.js to catch malformed frontmatter during installation.

**Output:**
- Three platform-specific validators with optional field validation
- Integrated validation in install-skills.js processTemplateFile function
- Integration tests verifying validation behavior
- Skills validated after template variable replacement but before file write
</objective>

<execution_context>
@.github/get-shit-done/workflows/execute-plan.md
@.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-skill-validation-and-adapter-system/11-01-CONTEXT.md
@.planning/phases/11-skill-validation-and-adapter-system/11-RESEARCH.md

# Prior work from 11-01
@.planning/phases/11-skill-validation-and-adapter-system/11-01-SUMMARY.md

# Existing code to integrate with
@bin/lib/installer/install-skills.js
@bin/lib/platforms/claude-adapter.js
@bin/lib/platforms/copilot-adapter.js
@bin/lib/platforms/codex-adapter.js
@bin/lib/platforms/platform-names.js
@tests/integration/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create platform-specific validators</name>
  <files>
    bin/lib/frontmatter/claude-validator.js
    bin/lib/frontmatter/copilot-validator.js
    bin/lib/frontmatter/codex-validator.js
  </files>
  <action>
Create `bin/lib/frontmatter/claude-validator.js`:
- Import BaseValidator from './base-validator.js'
- Import CLAUDE from '../platforms/platform-names.js'
- Export class `ClaudeValidator extends BaseValidator`
- Constructor: `super(CLAUDE)`
- Static property `supportedPlatforms = [CLAUDE]`
- Implement `validateOptionalFields(frontmatter, context)`:
  - Validate `allowed-tools` if present (comma-separated string, capitalized: "Read, Write, Bash")
  - Validate `argument-hint` if present (string or array)
  - On invalid optional field: console.warn() with formatted warning, continue (do NOT throw)
  - Warning format: "⚠️  VALIDATION WARNING: [template] - [field]: [issue]"
- Implement `validateUnknownFields(frontmatter, context)`:
  - Get known fields: name, description, allowed-tools, argument-hint
  - Find unknown fields: `Object.keys(frontmatter).filter(k => !knownFields.includes(k))`
  - For each unknown: console.warn() with message (do NOT throw)
  - Warning: "⚠️  Unknown field '[field]' in [template] (may be ignored by platform)"

Create `bin/lib/frontmatter/copilot-validator.js`:
- Same structure as Claude validator
- Import COPILOT from platform-names.js
- Static property `supportedPlatforms = [COPILOT]`
- Same optional field validation (allowed-tools, argument-hint)
- Same unknown field handling

Create `bin/lib/frontmatter/codex-validator.js`:
- Same structure as Claude validator  
- Import CODEX from platform-names.js
- Static property `supportedPlatforms = [CODEX]`
- Same optional field validation (allowed-tools, argument-hint)
- Same unknown field handling

**Important:** 
- Optional field validation uses console.warn(), NOT throw
- Required field validation (name, description) inherited from BaseValidator - those THROW
- Unknown fields warn but don't fail
- Each validator is isolated (code duplication acceptable per architecture decision)
  </action>
  <verify>
```bash
# Verify files created
ls -la bin/lib/frontmatter/*-validator.js

# Verify exports and structure
for file in claude copilot codex; do
  echo "Checking ${file}-validator.js:"
  grep "export class ${file^}Validator extends BaseValidator" "bin/lib/frontmatter/${file}-validator.js"
  grep "validateOptionalFields" "bin/lib/frontmatter/${file}-validator.js"
  grep "validateUnknownFields" "bin/lib/frontmatter/${file}-validator.js"
  grep "supportedPlatforms" "bin/lib/frontmatter/${file}-validator.js"
done

# Test validator instantiation
node -e "
  Promise.all([
    import('./bin/lib/frontmatter/claude-validator.js'),
    import('./bin/lib/frontmatter/copilot-validator.js'),
    import('./bin/lib/frontmatter/codex-validator.js')
  ]).then(([claude, copilot, codex]) => {
    const cv = new claude.ClaudeValidator();
    const cpv = new copilot.CopilotValidator();
    const cdv = new codex.CodexValidator();
    console.log('✓ All validators instantiate');
    console.log('Claude platform:', cv.platformName);
    console.log('Copilot platform:', cpv.platformName);
    console.log('Codex platform:', cdv.platformName);
  }).catch(e => {
    console.error('✗ Error:', e.message);
    process.exit(1);
  });
"
```
  </verify>
  <done>
- Three validator files created (claude, copilot, codex)
- Each extends BaseValidator
- Each implements validateOptionalFields() with console.warn on invalid
- Each implements validateUnknownFields() with console.warn
- Each has supportedPlatforms static property
- Validators instantiate without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate validators into install-skills.js and add tests</name>
  <files>
    bin/lib/installer/install-skills.js
    tests/integration/skill-validation.test.js
  </files>
  <action>
Update `bin/lib/installer/install-skills.js`:

1. Add imports at top:
```javascript
import matter from 'gray-matter';
import { ClaudeValidator } from '../frontmatter/claude-validator.js';
import { CopilotValidator } from '../frontmatter/copilot-validator.js';
import { CodexValidator } from '../frontmatter/codex-validator.js';
import { ValidationError } from '../frontmatter/validation-error.js';
```

2. Create validator registry map:
```javascript
const validators = {
  'claude': new ClaudeValidator(),
  'copilot': new CopilotValidator(),
  'codex': new CodexValidator()
};
```

3. Add helper function `validateSkillFrontmatter(content, templateName, filePath, platform)`:
```javascript
function validateSkillFrontmatter(content, templateName, filePath, platform) {
  // Parse frontmatter
  const { data: frontmatter } = matter(content);
  
  // Get validator for platform
  const validator = validators[platform];
  if (!validator) {
    throw new Error(`No validator found for platform: ${platform}`);
  }
  
  // Validate with context
  const context = { templateName, filePath, platform };
  validator.validate(frontmatter, context);
}
```

4. Update `processTemplateFile()` function to call validation AFTER variable replacement but BEFORE cleanFrontmatter:
```javascript
async function processTemplateFile(filePath, variables, isVerbose, platform) {
  const content = await readFile(filePath, 'utf8');
  
  // Find unknown variables and warn
  const unknown = findUnknownVariables(content, variables);
  if (unknown.length > 0 && isVerbose) {
    logger.warn(`Unknown variables in ${filePath}: ${unknown.join(', ')}`);
  }
  
  // Replace template variables
  const processed = replaceVariables(content, variables);
  
  // === NEW: Validate frontmatter after variable replacement ===
  const templateName = basename(dirname(filePath));
  try {
    validateSkillFrontmatter(processed, templateName, filePath, platform);
  } catch (error) {
    if (error instanceof ValidationError) {
      // Print formatted error and exit
      console.error(error.toConsoleOutput());
      process.exit(1);
    }
    throw error; // Re-throw non-validation errors
  }
  
  // Clean frontmatter (existing code)
  const cleaned = cleanFrontmatter(processed, platform);
  
  await writeFile(filePath, cleaned);
}
```

5. Update function signature to pass platform through the chain:
```javascript
export async function installSkills(templatesDir, targetDir, variables, multiBar, isVerbose, platform)
```

Create `tests/integration/skill-validation.test.js`:
```javascript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { mkdtemp, rm, writeFile, mkdir } from 'fs/promises';
import { join } from 'path';
import { tmpdir } from 'os';
import { ClaudeValidator } from '../../bin/lib/frontmatter/claude-validator.js';
import { ValidationError } from '../../bin/lib/frontmatter/validation-error.js';

describe('Skill Validation', () => {
  let tempDir;
  
  beforeEach(async () => {
    tempDir = await mkdtemp(join(tmpdir(), 'skill-validation-test-'));
  });
  
  afterEach(async () => {
    await rm(tempDir, { recursive: true, force: true });
  });
  
  describe('Required Field Validation', () => {
    it('should reject skill with missing name', () => {
      const validator = new ClaudeValidator();
      const frontmatter = { description: 'Test description' };
      const context = { templateName: 'test-skill', filePath: 'test.md', platform: 'claude' };
      
      expect(() => validator.validate(frontmatter, context)).toThrow(ValidationError);
    });
    
    it('should reject skill with missing description', () => {
      const validator = new ClaudeValidator();
      const frontmatter = { name: 'test-skill' };
      const context = { templateName: 'test-skill', filePath: 'test.md', platform: 'claude' };
      
      expect(() => validator.validate(frontmatter, context)).toThrow(ValidationError);
    });
    
    it('should reject name with invalid characters', () => {
      const validator = new ClaudeValidator();
      const frontmatter = { name: 'invalid!name', description: 'Test' };
      const context = { templateName: 'test-skill', filePath: 'test.md', platform: 'claude' };
      
      expect(() => validator.validate(frontmatter, context)).toThrow(ValidationError);
    });
    
    it('should reject name over 64 characters', () => {
      const validator = new ClaudeValidator();
      const longName = 'a'.repeat(65);
      const frontmatter = { name: longName, description: 'Test' };
      const context = { templateName: 'test-skill', filePath: 'test.md', platform: 'claude' };
      
      expect(() => validator.validate(frontmatter, context)).toThrow(ValidationError);
    });
    
    it('should reject description over 1024 characters', () => {
      const validator = new ClaudeValidator();
      const longDesc = 'a'.repeat(1025);
      const frontmatter = { name: 'test-skill', description: longDesc };
      const context = { templateName: 'test-skill', filePath: 'test.md', platform: 'claude' };
      
      expect(() => validator.validate(frontmatter, context)).toThrow(ValidationError);
    });
  });
  
  describe('Valid Frontmatter', () => {
    it('should accept valid skill frontmatter', () => {
      const validator = new ClaudeValidator();
      const frontmatter = {
        name: 'gsd-test-skill',
        description: 'A valid test skill'
      };
      const context = { templateName: 'test-skill', filePath: 'test.md', platform: 'claude' };
      
      expect(() => validator.validate(frontmatter, context)).not.toThrow();
    });
    
    it('should accept valid optional fields', () => {
      const validator = new ClaudeValidator();
      const frontmatter = {
        name: 'gsd-test-skill',
        description: 'A valid test skill',
        'allowed-tools': 'Read, Write, Bash',
        'argument-hint': '[project-name]'
      };
      const context = { templateName: 'test-skill', filePath: 'test.md', platform: 'claude' };
      
      expect(() => validator.validate(frontmatter, context)).not.toThrow();
    });
  });
  
  describe('ValidationError Formatting', () => {
    it('should format error with all context', () => {
      const error = new ValidationError('Test error message', {
        template: 'gsd-test-skill',
        platform: 'claude',
        field: 'name',
        value: 'bad!name',
        expected: 'Letters, numbers, and hyphens only',
        spec: 'https://agentskills.io/specification#name-field'
      });
      
      const output = error.toConsoleOutput();
      expect(output).toContain('❌ VALIDATION ERROR');
      expect(output).toContain('Template: gsd-test-skill');
      expect(output).toContain('Platform: claude');
      expect(output).toContain('Field: name');
      expect(output).toContain('bad!name');
      expect(output).toContain('https://agentskills.io/specification');
      expect(output).toContain('github.com/shoootyou/get-shit-done-multi/issues');
    });
  });
});
```

Add to package.json scripts if not present:
```json
"test:validation": "vitest run tests/integration/skill-validation.test.js"
```
  </action>
  <verify>
```bash
# Verify install-skills.js updated
grep "validateSkillFrontmatter" bin/lib/installer/install-skills.js
grep "ValidationError" bin/lib/installer/install-skills.js
grep "ClaudeValidator" bin/lib/installer/install-skills.js

# Verify validator imports
grep "from.*frontmatter.*validator" bin/lib/installer/install-skills.js

# Verify test file created
ls -la tests/integration/skill-validation.test.js

# Run validation tests
npm run test:validation

# Expected output: All tests pass
# - Required field validation catches missing name
# - Required field validation catches missing description
# - Name validation catches invalid characters
# - Name validation catches length violations
# - Description validation catches length violations
# - Valid frontmatter passes without errors
# - ValidationError formats output correctly
```
  </verify>
  <done>
- install-skills.js imports validators and ValidationError
- validateSkillFrontmatter() helper function added
- processTemplateFile() calls validation after variable replacement
- Validation errors print formatted output and exit with code 1
- Integration test file with 8+ test cases
- All tests pass: invalid skills rejected, valid skills accepted
- ValidationError formatting verified
  </done>
</task>

</tasks>

<verification>
After completion, verify complete validation system:

```bash
# 1. All validator files exist
ls -la bin/lib/frontmatter/*.js

# 2. Integration complete
grep "validateSkillFrontmatter" bin/lib/installer/install-skills.js

# 3. Run full test suite
npm run test:validation

# 4. Test with actual templates (smoke test)
node -e "
  import { ClaudeValidator } from './bin/lib/frontmatter/claude-validator.js';
  import { readFile } from 'fs/promises';
  import matter from 'gray-matter';
  
  const validator = new ClaudeValidator();
  
  // Load a real skill template
  readFile('./templates/skills/gsd-new-project/SKILL.md', 'utf8').then(content => {
    const { data } = matter(content);
    const context = { 
      templateName: 'gsd-new-project', 
      filePath: 'templates/skills/gsd-new-project/SKILL.md',
      platform: 'claude'
    };
    
    try {
      validator.validate(data, context);
      console.log('✓ Real template validates successfully');
    } catch (e) {
      console.error('✗ Real template failed validation:', e.message);
      process.exit(1);
    }
  });
"

# 5. Verify error output format
node -e "
  import { ValidationError } from './bin/lib/frontmatter/validation-error.js';
  const err = new ValidationError('Name contains invalid characters', {
    template: 'gsd-test',
    platform: 'claude',
    field: 'name',
    value: 'bad!name',
    spec: 'https://agentskills.io/specification#name-field'
  });
  const output = err.toConsoleOutput();
  if (!output.includes('❌ VALIDATION ERROR')) {
    console.error('✗ Error format missing header');
    process.exit(1);
  }
  if (!output.includes('github.com/shoootyou/get-shit-done-multi/issues')) {
    console.error('✗ Error format missing issue link');
    process.exit(1);
  }
  console.log('✓ Error format complete');
"
```

Expected state:
- 3 platform validators (Claude, Copilot, Codex)
- Validation integrated into install-skills.js
- All integration tests pass
- Real templates validate successfully
- Error output includes all required context
</verification>

<success_criteria>
Skill validation system complete when:

1. **Platform validators created:**
   - ClaudeValidator extends BaseValidator
   - CopilotValidator extends BaseValidator
   - CodexValidator extends BaseValidator
   - Each implements validateOptionalFields() with warnings
   - Each implements validateUnknownFields() with warnings

2. **Integration complete:**
   - install-skills.js imports all validators
   - validateSkillFrontmatter() helper function added
   - processTemplateFile() validates after variable replacement
   - ValidationError caught and formatted output printed
   - Process exits with code 1 on validation error

3. **Tests created and passing:**
   - 8+ integration test cases
   - Tests cover: missing name, missing description, invalid name chars, name length, description length, valid skills, optional fields, error formatting
   - All tests pass with `npm run test:validation`

4. **Real templates validate:**
   - Existing skill templates pass validation
   - No false positives on production templates

5. **Error output complete:**
   - Includes template name, platform, field, value, spec URL
   - Includes GitHub issue URL for reporting
   - Includes system information
   - Formatted with decorative lines and emoji

6. **Optional fields warn but don't fail:**
   - Invalid allowed-tools generates warning
   - Invalid argument-hint generates warning
   - Installation continues after warnings

7. **Unknown fields handled gracefully:**
   - Unknown fields generate warnings
   - Installation continues
</success_criteria>

<output>
After completion, create `.planning/phases/11-skill-validation-and-adapter-system/11-02-SUMMARY.md`

Document:
- Platform validators created (Claude, Copilot, Codex)
- Integration point: install-skills.js processTemplateFile()
- Validation flow: template load → variable replacement → validation → clean → write
- Test coverage: 8+ integration tests
- Error handling: ValidationError with formatted console output
- Warnings: Optional fields and unknown fields warn but don't block
- Next step: Phase 11 complete - skill validation fully integrated
</output>
