# Phase 6.1: Old Version Detection & Migration (INSERTED)

**Status:** ðŸ”µ Ready to Plan  
**Type:** Urgent insertion - Discovered during Phase 6 completion  
**Goal:** Detect old v1.x installations, offer upgrade with automatic backup, and install v2.0.0

---

## Why This Phase Was Inserted

During Phase 6 (Update Detection) completion, we discovered that v2.0.0 has a **completely incompatible structure** with v1.x installations. Users with v1.x cannot upgrade without migration.

**Critical issue:** Without detection and migration, users will experience:
- Silent installation failures
- Mixed old/new file structures
- Broken workflows
- Confusion about what went wrong

**This blocks successful v2.0.0 adoption** for existing v1.x users.

---

## Old vs New Structure

### Old Structure (v1.x)
- **Claude:** `.claude/commands/gsd/` (30+ files), `.claude/hooks/` (3 files), single `VERSION` file
- **Copilot:** `.github/skills/get-shit-done/` (monolithic), single `VERSION` file  
- **Codex:** `.codex/skills/get-shit-done/` (monolithic), single `VERSION` file

### New Structure (v2.0.0)
- **All platforms:** Individual skills `gsd-*/`, per-skill `version.json`, no hooks
- **Agent naming:** All use `.agent.md` suffix (Claude was `.md` only in v1.x)

**Reference:** See `06.1-RESEARCH.md` for detailed structural analysis

---

## Migration Flow

User experience when running installer with v1.x detected:

```
1. Detect old version (e.g., v1.8.0)
   â†“
2. Show warning:
   "Version 1.8.0 detected (incompatible with v2.0.0)"
   "Would you like to:"
   " - Create backup of v1.8.0"
   " - Install v2.0.0"
   
   [Yes, upgrade] [No, exit]
   â†“
3a. User confirms:
    - Create ~/.gsd-backup/v1.8.0-20260128-0142/
    - Move all old files to backup
    - Show: "Backup saved to: [path]"
    - Show: "You can delete manually after verifying"
    - Continue with v2.0.0 installation
    
3b. User declines:
    - Show: "Installation cancelled"
    - Show: "v1.x is incompatible with v2.0.0"
    - Exit cleanly
```

---

## Requirements

### Detection (R1-R3)
1. Detect old v1.x installations across all 3 platforms
2. Support detection in global (`~/`), local (`.`), and custom-path scopes
3. Read version from old structure (single VERSION file)

### User Experience (R4-R8)
4. Clear warning message about incompatibility
5. Single confirmation prompt for upgrade
6. Automatic backup creation (no manual steps)
7. Clear messaging about backup location and manual deletion
8. Graceful exit with explanation if user declines

### Backup (R9-R12)
9. Backup directory: `~/.gsd-backup/v{version}-{timestamp}/`
10. Preserve all old files (commands, agents, hooks, settings)
11. Atomic backup operation (all or nothing)
12. Timestamp format: `YYYYMMDD-HHmm` (sortable)

### Installation (R13-R15)
13. Continue with regular v2.0.0 installation after backup
14. No mixing of old and new structures
15. Verify backup succeeded before deleting source

### Error Handling (R16-R18)
16. Handle backup failures gracefully
17. Don't delete old files if backup fails
18. Show clear error messages with recovery steps

---

## Technical Approach

### Module 1: Old Version Detector

**Location:** `bin/lib/version/old-version-detector.js`

**Functions:**
```javascript
export async function detectOldVersion(platform, targetDir)
// Returns: { isOld: boolean, version: string, paths: string[] }

export async function readOldVersion(platform, targetDir)
// Returns: version string from old VERSION file

export async function getOldInstallationPaths(platform, targetDir)
// Returns: array of paths to backup
```

**Detection Logic:**

| Platform | Primary Marker | Secondary Markers |
|----------|---------------|-------------------|
| Claude | `.claude/get-shit-done/VERSION` | `.claude/commands/gsd/` OR `.claude/hooks/gsd-check-update.js` |
| Copilot | `.github/skills/get-shit-done/VERSION` | `.github/skills/get-shit-done/SKILL.md` |
| Codex | `.codex/skills/get-shit-done/VERSION` | `.codex/skills/get-shit-done/SKILL.md` |

### Module 2: Migration Manager

**Location:** `bin/lib/migration/migration-manager.js`

**Functions:**
```javascript
export async function promptMigration(platform, oldVersion)
// Shows warning, gets user confirmation
// Returns: { confirmed: boolean }

export async function createBackupDir(oldVersion)
// Creates ~/.gsd-backup/v{version}-{timestamp}/
// Returns: backup directory path

export async function moveToBackup(sourcePaths, backupDir)
// Moves files atomically
// Returns: { success: boolean, failed: string[] }

export async function showBackupConfirmation(backupPath)
// Displays backup location and manual deletion instructions
```

### Integration Points

1. **Orchestrator pre-check** (`bin/lib/installer/orchestrator.js`)
   - Before `validateVersionBeforeInstall()`
   - If old version detected â†’ run migration flow
   
2. **Interactive mode** (`bin/lib/cli/interactive.js`)
   - After platform detection
   - Before platform/scope prompts
   
3. **Check-updates** (`bin/lib/updater/check-update.js`)
   - Detect old versions
   - Show special incompatibility message

---

## Tasks Breakdown

### Task 1: Create Old Version Detector
- File: `bin/lib/version/old-version-detector.js`
- Tests: `tests/unit/old-version-detector.test.js`
- Estimate: 2 hours

### Task 2: Create Migration Manager
- File: `bin/lib/migration/migration-manager.js`
- Tests: `tests/unit/migration-manager.test.js`
- Estimate: 3 hours

### Task 3: Integrate with Orchestrator
- File: `bin/lib/installer/orchestrator.js` (pre-installation check)
- Estimate: 1 hour

### Task 4: Integrate with Interactive Mode
- File: `bin/lib/cli/interactive.js`
- Estimate: 1 hour

### Task 5: Update Check-Updates Flow
- Files: `bin/lib/updater/check-update.js`, `bin/lib/updater/update-messages.js`
- Estimate: 1 hour

### Task 6: Integration Tests
- File: `tests/integration/migration-flow.test.js`
- Scenarios: confirm migration, decline, backup failure, mixed versions
- Estimate: 2 hours

### Task 7: Documentation
- File: `README.md` (new section: "Upgrading from v1.x")
- Estimate: 1 hour

**Total estimate:** ~11 hours

---

## Success Criteria

- [ ] Old v1.x installations detected across all 3 platforms
- [ ] Clear warning shown with version info (e.g., "v1.8.0 detected")
- [ ] Single confirmation prompt: "Create backup and upgrade?"
- [ ] Automatic backup to `~/.gsd-backup/v{version}-{timestamp}/`
- [ ] All old files moved to backup (verified complete)
- [ ] Clear message showing backup location
- [ ] Instructions for manual deletion after verification
- [ ] v2.0.0 installation proceeds after backup
- [ ] Graceful exit with explanation if user declines
- [ ] Backup failure preserves old files (no deletion)
- [ ] Integration tests pass for all scenarios
- [ ] README updated with upgrade guide

---

## Files to Modify

- `bin/lib/installer/orchestrator.js` - Add pre-installation migration check
- `bin/lib/cli/interactive.js` - Add migration prompt before platform selection
- `bin/lib/updater/check-update.js` - Detect and warn about old versions
- `bin/lib/updater/update-messages.js` - Add old version incompatibility message

## Files to Create

- `bin/lib/version/old-version-detector.js` - Detection logic
- `bin/lib/migration/migration-manager.js` - Migration and backup logic
- `tests/unit/old-version-detector.test.js` - Detector tests
- `tests/unit/migration-manager.test.js` - Migration tests
- `tests/integration/migration-flow.test.js` - End-to-end migration tests

---

## Dependencies

- Existing: `fs-extra` (file operations)
- Existing: `@clack/prompts` (confirmation dialog)
- Existing: `path` (directory resolution)
- No new packages required

---

## Edge Cases

1. **Multiple scopes:** User has v1.x in both global and local
   - Solution: Detect and migrate each scope independently
   
2. **Partial installation:** Some platforms v1.x, others v2.x
   - Solution: Only migrate platforms with old versions
   
3. **Backup already exists:** `~/.gsd-backup/v1.8.0-*` directory exists
   - Solution: Add timestamp suffix to make unique
   
4. **Disk space:** Not enough space for backup
   - Solution: Check space before backup, show clear error
   
5. **Permissions:** Can't create backup directory
   - Solution: Show permission error, suggest sudo or different location

---

## Notes

- Phase inserted as **6.1** because it's urgent work that must happen before Phase 7
- Backup location in home directory avoids conflicts with project directories
- Migration is **one-way** (v1.x â†’ v2.0.0), no downgrade support
- Claude-specific: `settings.json` hooks configuration included in backup
- Manual deletion of backup gives users time to verify new installation works
