---
phase: 06.1-old-version-detection-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
files_created:
  - bin/lib/version/old-version-detector.js
  - tests/unit/old-version-detector.test.js
autonomous: true
must_haves:
  observables:
    - old_version_detected: Installer detects v1.x by checking for monolithic structure markers
    - version_read: Reads version string from old VERSION file across all platforms
    - platform_specific: Detects Claude (commands/gsd), Copilot (skills/get-shit-done), Codex (skills/get-shit-done)
    - multi_scope: Checks both global (~/) and local (.) paths
  artifacts:
    - old-version-detector.js with detection functions
    - Unit tests validating detection across all platforms and scopes
  wiring:
    - Exports detectOldVersion, readOldVersion, getOldInstallationPaths functions
  key_links:
    - Detection must work with orchestrator pre-check flow
    - Must not modify existing version detection modules
---

# Phase 06.1 Plan 01: Old Version Detector Module

## Objective

Create detection module that identifies v1.x installations across Claude, Copilot, and Codex platforms in both global and local scopes. Module is independent and reusable by orchestrator, interactive mode, and check-updates.

## Context

**From CONTEXT.md:**
- D3.3: Migration module MUST be independent (separate directory)
- D4.1: Handle multiple scopes (global + local) - detect both, migrate one at a time
- D4.2: Multiple platforms at different versions - show all old versions detected

**From RESEARCH.md:**
- Old structure markers:
  - Claude: `.claude/get-shit-done/VERSION` + `.claude/commands/gsd/` OR `.claude/hooks/gsd-check-update.js`
  - Copilot: `.github/skills/get-shit-done/SKILL.md` + `.github/skills/get-shit-done/VERSION`
  - Codex: `.codex/skills/get-shit-done/SKILL.md` + `.codex/skills/get-shit-done/VERSION`
- Version file contains single line: "1.8.0"

**From ROADMAP.md:**
- Requirement VERSION-04: Compatibility with older versions (migration path)
- Requirement UX-06: Clear error messages for incompatible installations

**Existing modules to reuse:**
- `bin/lib/io/file-operations.js` - pathExists, readFile
- `bin/lib/platforms/detector.js` - platform path patterns
- `bin/lib/errors/install-error.js` - InstallError base class

## Tasks

<task id="1.1" type="create">
  <files>bin/lib/version/old-version-detector.js</files>
  <action>
Create old version detector module with three core functions:

**1. detectOldVersion(platform, targetDir, options = {})**
Returns: `{ isOld: boolean, version: string | null, paths: string[] }`

Detection logic per platform:
- **Claude:** Check `.claude/get-shit-done/VERSION` exists AND (`.claude/commands/gsd/` exists OR `.claude/hooks/gsd-check-update.js` exists)
- **Copilot:** Check `.github/skills/get-shit-done/SKILL.md` exists AND `.github/skills/get-shit-done/VERSION` exists
- **Codex:** Check `.codex/skills/get-shit-done/SKILL.md` exists AND `.codex/skills/get-shit-done/VERSION` exists

If old version detected, call readOldVersion() and getOldInstallationPaths()

**2. readOldVersion(platform, targetDir)**
Returns: version string (e.g., "1.8.0")

Read VERSION file from:
- Claude: `${targetDir}/.claude/get-shit-done/VERSION`
- Copilot: `${targetDir}/.github/skills/get-shit-done/VERSION`
- Codex: `${targetDir}/.codex/skills/get-shit-done/VERSION`

Trim whitespace, return raw version string

**3. getOldInstallationPaths(platform, targetDir)**
Returns: array of paths to include in backup

Paths per platform:
- **Claude:** 
  - `.claude/commands/gsd/`
  - `.claude/agents/gsd-*.md` (not .agent.md)
  - `.claude/hooks/gsd-check-update.js`
  - `.claude/hooks/pre-commit-docs`
  - `.claude/hooks/statusline.js`
  - `.claude/get-shit-done/`
  - `.claude/settings.json` (if exists)
- **Copilot:**
  - `.github/skills/get-shit-done/`
  - `.github/agents/gsd-*.agent.md`
  - `.github/ISSUE_TEMPLATE/gsd-*.yml` (if exists)
  - `.github/copilot-instructions.md` (if exists)
- **Codex:**
  - `.codex/skills/get-shit-done/`
  - `.codex/agents/gsd-*.agent.md` (if exists)

Use fs-extra pathExists to filter only existing paths

**4. detectAllOldVersions(targetDir = '.')**
Returns: array of `{ platform, scope, version, paths }`

Check all platforms (claude, copilot, codex) in target directory
For each found, add to results array
Used by interactive mode and check-updates

**Error handling:**
- Wrap in try-catch, return { isOld: false, version: null, paths: [] } on errors
- Don't throw - detection failures should not block installation

**Imports:**
```javascript
import { pathExists, readFile } from '../io/file-operations.js';
import { resolve, join } from 'path';
import { glob } from 'glob';
```
  </action>
  <verify>
```bash
# Check file created
ls -lh bin/lib/version/old-version-detector.js

# Check exports
grep "export async function" bin/lib/version/old-version-detector.js
```
  </verify>
  <done>
File bin/lib/version/old-version-detector.js created with detectOldVersion, readOldVersion, getOldInstallationPaths, detectAllOldVersions functions
  </done>
</task>

<task id="1.2" type="test">
  <files>tests/unit/old-version-detector.test.js</files>
  <action>
Create unit tests for old version detector covering:

**Test suites:**

1. **detectOldVersion() - Claude**
   - ✓ Detects v1.x with VERSION file + commands/gsd directory
   - ✓ Detects v1.x with VERSION file + hooks/gsd-check-update.js
   - ✓ Returns false when VERSION missing
   - ✓ Returns false when both commands and hooks missing
   - ✓ Reads version correctly ("1.8.0")
   - ✓ Returns all installation paths

2. **detectOldVersion() - Copilot**
   - ✓ Detects v1.x with SKILL.md + VERSION file
   - ✓ Returns false when SKILL.md missing
   - ✓ Returns false when VERSION missing
   - ✓ Returns correct paths (skills, agents, issue templates)

3. **detectOldVersion() - Codex**
   - ✓ Detects v1.x with SKILL.md + VERSION file
   - ✓ Returns false when markers missing
   - ✓ Returns correct paths (skills, agents)

4. **getOldInstallationPaths()**
   - ✓ Returns only existing paths (filters missing files)
   - ✓ Handles glob patterns for agents (gsd-*.md, gsd-*.agent.md)
   - ✓ Returns empty array when no old files found

5. **detectAllOldVersions()**
   - ✓ Detects multiple platforms in same directory
   - ✓ Returns array with platform, scope, version, paths
   - ✓ Returns empty array when no old versions

6. **Error handling**
   - ✓ Returns { isOld: false } on file read errors
   - ✓ Doesn't throw on permission errors

**Test fixtures:**
Create temporary test directories with v1.x structure:
```javascript
// tests/fixtures/old-version/claude/
//   .claude/get-shit-done/VERSION
//   .claude/commands/gsd/gsd-test.md
//   .claude/hooks/gsd-check-update.js
```

Use `/tmp/gsd-test-{timestamp}` pattern per TEST-01 requirement

**Assertions:**
- Use vitest expect() assertions
- Test both positive and negative cases
- Verify path arrays contain expected files
  </action>
  <verify>
```bash
# Run tests
npm test -- old-version-detector.test.js

# Check coverage
npm test -- --coverage old-version-detector.test.js
```
  </verify>
  <done>
Tests pass, detection logic validated across all platforms and scopes, edge cases covered
  </done>
</task>

## Verification Criteria

- [ ] Module created in `bin/lib/version/old-version-detector.js`
- [ ] Four functions exported: detectOldVersion, readOldVersion, getOldInstallationPaths, detectAllOldVersions
- [ ] Detection works for Claude (commands/gsd OR hooks markers)
- [ ] Detection works for Copilot and Codex (SKILL.md + VERSION)
- [ ] Version reading from single VERSION file
- [ ] Path collection filters only existing files
- [ ] Unit tests pass with >90% coverage
- [ ] Error handling prevents detection failures from blocking installation

## Success Criteria

**Observable:**
1. Running detectOldVersion('claude', '/tmp/test-v1') on v1.x installation returns `{ isOld: true, version: '1.8.0', paths: [...] }`
2. Running on v2.0 installation returns `{ isOld: false, version: null, paths: [] }`
3. Multi-platform detection finds all old versions in directory

**Technical:**
1. Module integrates cleanly with orchestrator (no modification to orchestrator needed yet)
2. Unit tests validate all detection scenarios
3. No new dependencies added (reuses existing modules)

## Output

- `bin/lib/version/old-version-detector.js` - Detection module
- `tests/unit/old-version-detector.test.js` - Comprehensive unit tests
- Detection ready for integration in Wave 2
