---
phase: 06.1-old-version-detection-migration
plan: 01
subsystem: version-management
tags: [detection, version-checking, migration, fs-extra, vitest]

# Dependency graph
requires:
  - phase: 03-installer-validation-cli
    provides: file-operations module with pathExists and readFile
  - phase: 05-path-resolution
    provides: platform path patterns and naming conventions
provides:
  - Old version detection module (detectOldVersion, readOldVersion, getOldInstallationPaths, detectAllOldVersions)
  - Platform-specific v1.x structure markers
  - Version file reading across all platforms
  - Path collection for backup purposes
affects: [06.1-02-backup-manager, 06.1-03-orchestrator-integration, updater, installer]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Detection returns graceful { isOld: false } on errors rather than throwing"
    - "Platform-specific marker patterns (Claude: commands OR hooks, Copilot/Codex: SKILL.md + VERSION)"
    - "Glob-like filtering using fs.readdir for agent files (gsd-*.md, gsd-*.agent.md)"

key-files:
  created:
    - bin/lib/version/old-version-detector.js
    - tests/unit/old-version-detector.test.js
  modified: []

key-decisions:
  - "Use graceful error handling (return false) instead of throwing to prevent detection failures from blocking installation"
  - "Separate Claude agent detection: .md files only (old v1.x), exclude .agent.md (new v2.0)"
  - "detectAllOldVersions determines scope (global/local) based on targetDir === homedir"
  - "Filter paths with pathExists to only include existing files in backup list"

patterns-established:
  - "Platform detection pattern: Check multiple markers with AND/OR logic"
  - "Version reading pattern: Read single VERSION file, trim whitespace"
  - "Path collection pattern: Static paths + dynamic glob patterns filtered by existence"

# Metrics
duration: 4min
completed: 2026-01-28
---

# Phase 6.1 Plan 01: Old Version Detector Module Summary

**Old version detection module with platform-specific v1.x structure markers, version reading, and path collection for backup across Claude, Copilot, and Codex**

## Performance

- **Duration:** 4 min
- **Started:** 2026-01-28T10:03:57Z
- **Completed:** 2026-01-28T10:07:45Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- Created detection module that identifies v1.x installations across all platforms
- Implemented platform-specific detection logic (Claude: commands OR hooks markers; Copilot/Codex: SKILL.md + VERSION)
- Version reading from single VERSION file with whitespace trimming
- Path collection with glob patterns for agent files (filters existing paths only)
- Comprehensive test suite with 23 tests covering all platforms, error handling, and edge cases

## Task Commits

Each task was committed atomically:

1. **Task 1.1: Create old version detector module** - `3b4d780` (feat)
2. **Task 1.2: Create unit tests** - `7400eca` (test)
3. **Bug fix: ES module import** - `c282918` (fix)

## Files Created/Modified
- `bin/lib/version/old-version-detector.js` - Detection module with four exported functions
- `tests/unit/old-version-detector.test.js` - 23 unit tests validating all detection scenarios

## Decisions Made
- **Graceful error handling:** Detection failures return `{ isOld: false, version: null, paths: [] }` rather than throwing, preventing detection issues from blocking installation
- **Platform-specific markers:** Claude requires VERSION file AND (commands/gsd directory OR hooks/gsd-check-update.js); Copilot/Codex require SKILL.md AND VERSION in skills directory
- **Agent file filtering:** Claude detects old `.md` agents (gsd-*.md) but excludes new `.agent.md` files; Copilot/Codex detect `.agent.md` files
- **Scope determination:** detectAllOldVersions determines scope by comparing resolved targetDir with home directory
- **Path filtering:** getOldInstallationPaths filters paths using pathExists to only include existing files in backup list

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed CommonJS require in ES module**
- **Found during:** Task verification (testing detectAllOldVersions)
- **Issue:** Used `require('os').homedir()` in ES module, causing ERR_AMBIGUOUS_MODULE_SYNTAX error
- **Fix:** Changed to `import { homedir } from 'os'` at module top
- **Files modified:** bin/lib/version/old-version-detector.js
- **Verification:** All tests pass (23/23), multi-platform detection works correctly
- **Committed in:** c282918 (dedicated fix commit)

---

**Total deviations:** 1 auto-fixed (1 bug)
**Impact on plan:** Bug fix necessary for module to function correctly. No scope creep.

## Issues Encountered
None - implementation proceeded smoothly following file-operations and platform path patterns from previous phases.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Detection module complete and tested
- Ready for Wave 2: Backup Manager integration (06.1-02)
- Module exports four functions ready for orchestrator pre-check flow
- No modifications needed to existing version detection modules

**Integration notes for next phase:**
- detectOldVersion(platform, targetDir) returns { isOld, version, paths }
- detectAllOldVersions(targetDir) returns array for multi-platform checks
- getOldInstallationPaths(platform, targetDir) for backup path collection
- All functions handle errors gracefully (return empty/false on failures)

---
*Phase: 06.1-old-version-detection-migration*
*Completed: 2026-01-28*
