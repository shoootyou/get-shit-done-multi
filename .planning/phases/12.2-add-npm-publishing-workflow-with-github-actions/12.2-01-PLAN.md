---
phase: 12.2-add-npm-publishing-workflow-with-github-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/publish-main.yml
  - .github/workflows/publish-dev.yml
autonomous: true

must_haves:
  truths:
    - "Maintainer can trigger publish workflow from main branch for stable releases"
    - "Maintainer can trigger publish workflow from dev branch for pre-releases"
    - "Workflow validates version format before any operations"
    - "Workflow prevents publishing if tag already exists"
    - "Workflow runs tests and build before publishing"
    - "Workflow creates git tag and GitHub release automatically"
    - "Package publishes to NPM with correct version"
  artifacts:
    - path: ".github/workflows/publish-main.yml"
      provides: "Stable release workflow for main branch"
      min_lines: 100
    - path: ".github/workflows/publish-dev.yml"
      provides: "Pre-release workflow for dev branch"
      min_lines: 100
  key_links:
    - from: ".github/workflows/publish-main.yml"
      to: "package.json"
      via: "jq version update"
      pattern: "jq.*\\.version"
    - from: ".github/workflows/publish-dev.yml"
      to: "npm registry"
      via: "npm publish with NODE_AUTH_TOKEN"
      pattern: "npm publish"
---

<objective>
Create two GitHub Actions workflows for publishing get-shit-done-multi to NPM: one for stable releases from main branch (admin-only), and one for pre-releases from dev branch.

Purpose: Enable maintainers to publish new versions via manual workflow triggers with comprehensive validation, automatic tagging, and GitHub release creation.

Output: Two production-ready workflow files that handle the complete release pipeline from version validation through NPM publishing.
</objective>

<execution_context>
@.github/get-shit-done/workflows/execute-plan.md
@.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/12.2-add-npm-publishing-workflow-with-github-actions/12.2-01-CONTEXT.md
@.planning/phases/12.2-add-npm-publishing-workflow-with-github-actions/12.2-RESEARCH.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stable release workflow for main branch</name>
  <files>.github/workflows/publish-main.yml</files>
  <action>
Create GitHub Actions workflow for publishing stable releases from main branch.

**Workflow structure:**
- Name: "Publish to NPM (Main Branch)"
- Trigger: `workflow_dispatch` with version input (string, required)
- Concurrency: `npm-publish-main` (no cancel-in-progress)
- Job permissions: `contents: write`, `id-token: write`
- Runner: ubuntu-latest

**Execution order (per CONTEXT.md and RESEARCH.md):**
1. Checkout code (`actions/checkout@v4`)
2. Setup Node.js (`actions/setup-node@v6` with node 20.x, registry-url: https://registry.npmjs.org)
3. Validate version format (regex: `^[0-9]+\.[0-9]+\.[0-9]+$` - NO pre-release suffixes on main)
4. Check tag doesn't exist (`git ls-remote --tags origin | grep "refs/tags/v${version}$"`)
5. Validate against current package.json version (input must be higher using `sort -V`)
6. Verify package.json has `files` field (`jq -e '.files'`)
7. Update package.json version using jq (ephemeral, not committed back)
8. Install dependencies (`npm ci`)
9. Run tests (`npm test`)
10. Build if build script exists (`if jq -e '.scripts.build' then npm run build`)
11. Create and test tarball (`npm pack`, install in temp dir, validate, cleanup)
12. Dry-run publish (`npm publish --dry-run`)
13. Create git tag (`git tag -a "v${version}" -m "Release v${version}"`, push to origin)
14. Create GitHub release (`gh release create "v${version}"` with title and notes)
15. Publish to NPM (`npm publish` with NODE_AUTH_TOKEN from secrets.NPM_TOKEN)

**Key implementation details:**
- Use `${{ inputs.version }}` for version input
- Git config: `user.name: "github-actions[bot]"`, `user.email: "github-actions[bot]@users.noreply.github.com"`
- GitHub CLI uses `GH_TOKEN: ${{ github.token }}` environment variable
- NPM publish uses `NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}`
- All validation steps must exit 1 on failure with clear error messages
- Version comparison uses printf + sort -V pattern from research
- Tarball test creates unique temp dir `/tmp/npm-test-$$`, installs tarball, then cleans up

**Error messages:**
- Invalid version: "Invalid version format: must be X.Y.Z (no pre-release suffixes on main)"
- Tag exists: "Tag v${version} already exists"
- Version not higher: "Input version ${version} must be higher than current ${current}"
- Missing files: "package.json must have 'files' field"
- Version update failed: "Failed to update package.json version"

Follow research Pattern 1 (manual workflow), Pattern 2 (NPM auth), Pattern 3 (validate before tag), Pattern 4 (atomic tag/release), Pattern 5 (pre-flight checks), Pattern 6 (update package.json), Pattern 7 (concurrency control).
  </action>
  <verify>
```bash
# Verify workflow file exists and is valid YAML
cat .github/workflows/publish-main.yml | head -20
yamllint .github/workflows/publish-main.yml 2>/dev/null || echo "yamllint not installed, skipping"

# Verify key workflow elements
grep -q "workflow_dispatch" .github/workflows/publish-main.yml
grep -q "actions/setup-node@v6" .github/workflows/publish-main.yml
grep -q "npm publish" .github/workflows/publish-main.yml
grep -q "gh release create" .github/workflows/publish-main.yml
```
  </verify>
  <done>
- `.github/workflows/publish-main.yml` exists with 100+ lines
- Workflow has 15 steps in correct order (validate → test → build → tag → release → publish)
- Version validation rejects pre-release suffixes (regex check)
- All pre-flight checks present (tag exists, version comparison, files field)
- Git tag creation uses annotated tags with message
- GitHub release created with gh CLI
- NPM publish uses NODE_AUTH_TOKEN from secrets
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pre-release workflow for dev branch</name>
  <files>.github/workflows/publish-dev.yml</files>
  <action>
Create GitHub Actions workflow for publishing pre-releases from dev branch.

**Workflow structure:**
- Name: "Publish to NPM (Dev Branch)"
- Trigger: `workflow_dispatch` with version input (string, required)
- Concurrency: `npm-publish-dev` (no cancel-in-progress)
- Job permissions: `contents: write`, `id-token: write`
- Runner: ubuntu-latest

**Key differences from main workflow:**
1. Version validation ALLOWS pre-release suffixes (regex: `^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$`)
2. Version format validation includes optional pre-release suffix
3. NPM publish uses `--tag beta` (not `latest`) for pre-release versions
4. Detect if version has pre-release suffix, use appropriate dist-tag:
   - If version contains `-`: `npm publish --tag beta`
   - If version is stable (no `-`): `npm publish --tag latest`

**Execution order:** (same as main workflow, steps 1-15)
1. Checkout code
2. Setup Node.js
3. Validate version format (allows pre-release: `1.9.1-beta.1`, `2.0.0-alpha.2`)
4. Check tag doesn't exist
5. Validate against current package.json version
6. Verify package.json has `files` field
7. Update package.json version
8. Install dependencies
9. Run tests
10. Build if build script exists
11. Create and test tarball
12. Dry-run publish
13. Create git tag
14. Create GitHub release
15. Publish to NPM (with conditional dist-tag based on version)

**Dist-tag logic:**
```bash
if [[ "${{ inputs.version }}" =~ - ]]; then
  npm publish --tag beta
else
  npm publish --tag latest
fi
```

**Error messages:**
- Invalid version: "Invalid version format: must be X.Y.Z or X.Y.Z-prerelease"
- Other errors same as main workflow

Copy structure from publish-main.yml, modify version validation regex and NPM publish step.
  </action>
  <verify>
```bash
# Verify workflow file exists and is valid YAML
cat .github/workflows/publish-dev.yml | head -20

# Verify key differences from main workflow
grep -q "X.Y.Z-prerelease" .github/workflows/publish-dev.yml  # Allows pre-release
grep -q "npm publish --tag" .github/workflows/publish-dev.yml  # Conditional dist-tag

# Verify pre-release regex pattern
grep -E '\^[0-9]\+.*-.*\$' .github/workflows/publish-dev.yml
```
  </verify>
  <done>
- `.github/workflows/publish-dev.yml` exists with 100+ lines
- Version validation allows pre-release suffixes (regex includes optional `-suffix`)
- NPM publish step includes conditional dist-tag logic (beta for pre-release, latest for stable)
- Version format error message mentions pre-release support
- All other validation steps match main workflow
  </done>
</task>

<task type="auto">
  <name>Task 3: Create releasing documentation</name>
  <files>docs/releasing.md</files>
  <action>
Create comprehensive releasing guide for maintainers.

**Document structure:**

# Releasing get-shit-done-multi

## Overview
Brief explanation of two-workflow approach (main for stable, dev for pre-release).

## Prerequisites
- NPM_TOKEN configured in GitHub repository secrets
- Admin access for main branch releases
- Write access for dev branch releases

## Stable Releases (Main Branch)
Step-by-step instructions:
1. Navigate to Actions → "Publish to NPM (Main Branch)"
2. Click "Run workflow"
3. Select branch: `main`
4. Enter version (e.g., `1.9.1` - no pre-release suffixes)
5. Click "Run workflow" button
6. Wait for workflow completion (typically 2-3 minutes)
7. Verify success: Check NPM, GitHub releases, and git tags

## Pre-Releases (Dev Branch)
Step-by-step instructions:
1. Navigate to Actions → "Publish to NPM (Dev Branch)"
2. Click "Run workflow"
3. Select branch: `dev`
4. Enter version (e.g., `2.0.0-beta.1` or `1.9.2-alpha.1`)
5. Click "Run workflow" button
6. Wait for workflow completion
7. Verify success: Check NPM with `@beta` tag

## Version Numbering Conventions
- Stable: `X.Y.Z` (e.g., `1.9.1`, `2.0.0`)
- Pre-release: `X.Y.Z-suffix.N` (e.g., `2.0.0-beta.1`, `1.9.2-alpha.2`)
- Follow semantic versioning (semver.org)
- Main branch: Only stable versions allowed
- Dev branch: Both stable and pre-release allowed

## Troubleshooting
Common failure scenarios and solutions:
- "Tag already exists": Tag was created manually or previous run, delete tag if needed
- "Version not higher": Update input version to be higher than current package.json
- "Tests failed": Fix failing tests before publishing
- "NPM_TOKEN invalid": Regenerate token in NPM, update GitHub secret
- "Authentication error": Verify NPM_TOKEN has publish permission for package
- Orphaned tag (tag exists but npm not published): Document manual cleanup process

## NPM Token Setup
Instructions for maintainers to create/rotate NPM_TOKEN:
1. Go to npmjs.com → Access Tokens
2. Create "Granular Access Token" (preferred) or "Classic Automation Token"
3. Permissions: Read and write (publish permission required)
4. Scope to package: `get-shit-done-multi`
5. Expiration: 1 year recommended
6. Copy token
7. Add to GitHub: Settings → Secrets → Actions → New repository secret
8. Name: `NPM_TOKEN`, Value: (paste token)

## Workflow Behavior
What happens during a release:
1. Validation phase (can fail safely)
2. Testing and building (can fail safely)
3. Point of no return: Git tag creation (immutable)
4. GitHub release creation
5. NPM publish

## Manual Recovery
If workflow fails after tag creation:
1. Identify failure point from workflow logs
2. If tag exists but package not published: Fix issue, re-run workflow (will fail on tag, document tag deletion process)
3. Tag deletion: `git tag -d vX.Y.Z && git push origin :refs/tags/vX.Y.Z`
4. After fixing: Re-run workflow with same version

Include screenshots placeholders for GitHub Actions UI, successful release output, error examples.
  </action>
  <verify>
```bash
# Verify documentation exists and has key sections
cat docs/releasing.md | grep -E "^## " | head -10

# Verify critical sections present
grep -q "Stable Releases" docs/releasing.md
grep -q "Pre-Releases" docs/releasing.md
grep -q "Troubleshooting" docs/releasing.md
grep -q "NPM Token Setup" docs/releasing.md
```
  </verify>
  <done>
- `docs/releasing.md` exists with comprehensive releasing guide
- Document covers both stable and pre-release workflows
- Step-by-step instructions with examples
- Troubleshooting section addresses common failures (tag exists, auth errors, orphaned tags)
- NPM token setup instructions included
- Version numbering conventions clearly documented
- Manual recovery procedures documented
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Workflow validation:**
```bash
# Both workflow files exist
ls -la .github/workflows/publish-*.yml

# Workflows are syntactically valid YAML
for f in .github/workflows/publish-*.yml; do
  echo "Checking $f"
  cat "$f" | python3 -c "import sys, yaml; yaml.safe_load(sys.stdin)" && echo "✓ Valid YAML" || echo "✗ Invalid YAML"
done
```

2. **Manual workflow structure review:**
- Open both workflow files
- Verify 15-step execution order matches research
- Confirm version validation differs (main: no pre-release, dev: allows pre-release)
- Verify concurrency control present
- Check NPM auth via setup-node with NODE_AUTH_TOKEN
- Confirm git tag creation before GitHub release
- Verify GitHub release uses gh CLI (not deprecated actions)

3. **Documentation completeness:**
```bash
# Check doc has all required sections
grep -E "^## " docs/releasing.md
```

4. **Manual testing prerequisites:**
- NPM_TOKEN must be configured as GitHub repository secret
- Workflow files committed and pushed to repository
- Can be tested with dry-run: workflow will fail at NPM publish without token (expected)
</verification>

<success_criteria>
**Measurable outcomes:**

1. `.github/workflows/publish-main.yml` exists with:
   - 15 validation and publish steps
   - Rejects pre-release versions (regex check)
   - Creates annotated git tags with message
   - Uses gh CLI for GitHub releases
   - Publishes to NPM with `latest` dist-tag

2. `.github/workflows/publish-dev.yml` exists with:
   - Same 15 steps as main workflow
   - Allows pre-release versions (optional `-suffix` in regex)
   - Conditional dist-tag based on version (beta for pre-release, latest for stable)

3. `docs/releasing.md` exists with:
   - Prerequisites section (NPM_TOKEN setup)
   - Stable release instructions (main branch)
   - Pre-release instructions (dev branch)
   - Version numbering conventions
   - Troubleshooting section (5+ common failures)
   - Manual recovery procedures (orphaned tag cleanup)

4. Workflows follow research best practices:
   - Validate before point-of-no-return (tag creation)
   - Use official actions (setup-node@v6, checkout@v4)
   - Use gh CLI instead of deprecated create-release action
   - Concurrency control prevents race conditions
   - Comprehensive pre-flight checks

5. Ready for manual testing (requires NPM_TOKEN in repository secrets)
</success_criteria>

<output>
After completion, create `.planning/phases/12.2-add-npm-publishing-workflow-with-github-actions/12.2-01-SUMMARY.md` following the standard summary template.
</output>
