---
phase: 05.1-codebase-architecture-optimization
plan: 02-02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - bin/lib/platforms/** (adapters migrated)
  - bin/lib/configuration/** (config files migrated)
  - bin/lib/templating/** (doc-generator migrated)
  - bin/lib/installation/** (install workflow migrated)
  - bin/lib/testing/** (test helpers organized)
  - bin/** (import paths updated)
  - package.json (scripts updated)
autonomous: true
must_haves:
  - structure: All platform adapters in bin/lib/platforms/ with base-adapter.js interface
  - structure: Configuration files in bin/lib/configuration/ (flags, paths, menu, routing)
  - structure: doc-generator migrated to bin/lib/templating/ with working imports
  - structure: Installation workflow in bin/lib/installation/ (reporter, colors, CLI detection)
  - structure: Test utilities in bin/lib/testing/ with fixtures support
  - quality: All tests pass after each domain migration (no regressions)
  - quality: Import paths correctly updated throughout codebase
  - key_links:
    - from: "bin/lib/platforms/claude.js"
      to: "install.js"
      via: "require('./lib/platforms/claude')"
      purpose: "Install.js orchestrates platform-specific installations"
    - from: "bin/lib/templating/doc-generator/"
      to: "package.json scripts"
      via: "bin/lib/templating/doc-generator/generate.js"
      purpose: "Doc generator invoked via npm scripts"
    - from: "bin/lib/configuration/flag-parser.js"
      to: "install.js"
      via: "require('./lib/configuration/flag-parser')"
      purpose: "Flags parsed before installation workflow"
---

# Phase 5.1 Plan 02-02: Domain Migration

## Objective

Migrate all code into the domain-based structure created in Plan 02-01. Move files from flat bin/lib/ and scattered subdirectories into organized feature domains. Update all import paths and verify functionality after each domain migration.

## Context

**Starting state (from Plan 02-01):**
- Clean codebase with no circular dependencies
- No unused files or dependencies
- Empty domain directories created

**Target architecture:**
```
bin/lib/
├── platforms/          # Claude, Copilot, Codex adapters (+ future GPT-4All, Mistral, Gemini)
├── installation/       # Install workflow, validation, file operations
├── configuration/      # Flags, paths, menu, routing
├── templating/         # Doc generator, template engine (moved from bin/doc-generator/)
└── testing/            # Shared test utilities, mocks, fixtures
```

**Migration strategy:** One domain at a time, with test verification between stages. Use `git mv` to preserve history and let IDE help with import paths.

## Tasks

<task name="migrate-platforms-domain" type="auto">
  <files>bin/lib/platforms/**, bin/lib/adapters/**</files>
  <action>
Migrate platform adapters to bin/lib/platforms/:

```bash
# Move adapters to platforms/
echo "Migrating platforms domain..."

# Move adapter files
git mv bin/lib/adapters/claude.js bin/lib/platforms/
git mv bin/lib/adapters/copilot.js bin/lib/platforms/
git mv bin/lib/adapters/codex.js bin/lib/platforms/

# Move shared adapter utilities
if [ -d "bin/lib/adapters/shared" ]; then
  git mv bin/lib/adapters/shared bin/lib/platforms/
fi

# Remove empty adapters directory
rmdir bin/lib/adapters 2>/dev/null || true

# Update imports in moved files
# OLD: require('../../adapters/claude')
# NEW: require('../platforms/claude')
find bin/lib/platforms/ -name "*.js" -type f -exec sed -i.bak \
  -e "s|require(['\"]\.\.\/\.\.\/adapters\/|require('\.\./|g" \
  -e "s|require(['\"]\.\/shared\/|require('\.\./platforms/shared/|g" \
  {} \;

# Update imports in files that reference adapters
find bin/ -name "*.js" -type f ! -path "*/platforms/*" -exec sed -i.bak \
  -e "s|require(['\"]\.\/lib\/adapters\/|require('\./lib/platforms/|g" \
  -e "s|require(['\"]\.\.\/adapters\/|require('\.\./platforms/|g" \
  {} \;

# Remove backup files
find bin/ -name "*.js.bak" -delete

# Run tests
npm test

# Source git identity helpers
if ! type commit_as_user >/dev/null 2>&1; then
    source /workspace/.github/get-shit-done/workflows/git-identity-helpers.sh
fi

# Commit
git add -A
commit_as_user "refactor: migrate platforms domain to bin/lib/platforms/

- Moved Claude, Copilot, Codex adapters
- Updated all import paths
- Tests pass (no regressions)"
```
  </action>
  <verify>
```bash
# Verify files moved and tests pass
ls -la bin/lib/platforms/
npm test
```
  </verify>
  <done>Platform adapters migrated to bin/lib/platforms/ with all tests passing</done>
</task>

<task name="migrate-configuration-domain" type="auto">
  <files>bin/lib/configuration/**</files>
  <action>
Migrate configuration-related files to bin/lib/configuration/:

```bash
echo "Migrating configuration domain..."

# Identify configuration files (flags, paths, menu, routing)
CONFIG_FILES=(
  "flag-parser.js"
  "flag-validator.js"
  "old-flag-detector.js"
  "path-validator.js"
  "paths.js"
  "conflict-resolver.js"
)

# Move configuration files
for file in "${CONFIG_FILES[@]}"; do
  if [ -f "bin/lib/$file" ]; then
    git mv "bin/lib/$file" bin/lib/configuration/
  fi
done

# Move menu subdirectory
if [ -d "bin/lib/menu" ]; then
  git mv bin/lib/menu/* bin/lib/configuration/
  rmdir bin/lib/menu
fi

# Update import paths throughout codebase
find bin/ -name "*.js" -type f -exec sed -i.bak \
  -e "s|require(['\"]\.\/lib\/menu\/|require('\./lib/configuration/|g" \
  -e "s|require(['\"]\.\.\/menu\/|require('\.\./configuration/|g" \
  -e "s|require(['\"]\.\/lib\/flag-parser|require('\./lib/configuration/flag-parser|g" \
  -e "s|require(['\"]\.\/lib\/paths|require('\./lib/configuration/paths|g" \
  {} \;

find bin/ -name "*.js.bak" -delete

# Run tests
npm test

# Source git identity helpers
if ! type commit_as_user >/dev/null 2>&1; then
    source /workspace/.github/get-shit-done/workflows/git-identity-helpers.sh
fi

git add -A
commit_as_user "refactor: migrate configuration domain

- Flags, paths, menu, routing in bin/lib/configuration/
- All import paths updated
- Tests pass"
```
  </action>
  <verify>
```bash
ls -la bin/lib/configuration/
npm test
```
  </verify>
  <done>Configuration domain migrated to bin/lib/configuration/ with working imports</done>
</task>

<task name="migrate-templating-domain" type="auto">
  <files>bin/lib/templating/**, bin/doc-generator/**</files>
  <action>
Migrate doc-generator and template system to bin/lib/templating/:

```bash
echo "Migrating templating domain..."

# Move doc-generator from bin/ to bin/lib/templating/
if [ -d "bin/doc-generator" ]; then
  git mv bin/doc-generator bin/lib/templating/doc-generator
fi

# Move template-system if exists
if [ -d "bin/lib/template-system" ]; then
  # Merge with templating or keep separate
  git mv bin/lib/template-system/* bin/lib/templating/
  rmdir bin/lib/template-system 2>/dev/null || true
fi

# Update import paths (scripts that reference doc-generator)
find bin/ -name "*.js" -type f -exec sed -i.bak \
  -e "s|require(['\"]\.\/doc-generator\/|require('\./lib/templating/doc-generator/|g" \
  -e "s|bin/doc-generator|bin/lib/templating/doc-generator|g" \
  {} \;

# Update package.json scripts
sed -i.bak 's|bin/doc-generator/|bin/lib/templating/doc-generator/|g' package.json
rm package.json.bak

find bin/ -name "*.js.bak" -delete

# Run tests
npm test

# Source git identity helpers
if ! type commit_as_user >/dev/null 2>&1; then
    source /workspace/.github/get-shit-done/workflows/git-identity-helpers.sh
fi

git add -A
commit_as_user "refactor: migrate templating domain

- Moved doc-generator to bin/lib/templating/
- Updated package.json scripts
- Import paths corrected
- Tests pass"
```
  </action>
  <verify>
```bash
ls -la bin/lib/templating/
npm test
npm run docs:generate  # Verify doc-generator still works
```
  </verify>
  <done>Templating domain migrated with doc-generator working in new location</done>
</task>

<task name="migrate-installation-domain" type="auto">
  <files>bin/lib/installation/**</files>
  <action>
Migrate installation-related files to bin/lib/installation/:

```bash
echo "Migrating installation domain..."

# Move output formatting (Reporter, etc.)
if [ -d "bin/lib/output" ]; then
  git mv bin/lib/output/* bin/lib/installation/
  rmdir bin/lib/output 2>/dev/null || true
fi

# Move other installation files
INSTALL_FILES=(
  "upgrade.js"
  "colors.js"
  "cli-detection"
  "migration"
)

for item in "${INSTALL_FILES[@]}"; do
  if [ -e "bin/lib/$item" ]; then
    git mv "bin/lib/$item" bin/lib/installation/
  fi
done

# Update import paths
find bin/ -name "*.js" -type f -exec sed -i.bak \
  -e "s|require(['\"]\.\/lib\/output\/|require('\./lib/installation/|g" \
  -e "s|require(['\"]\.\.\/output\/|require('\.\./installation/|g" \
  -e "s|require(['\"]\.\/lib\/colors|require('\./lib/installation/colors|g" \
  {} \;

find bin/ -name "*.js.bak" -delete

# Run tests
npm test

# Source git identity helpers
if ! type commit_as_user >/dev/null 2>&1; then
    source /workspace/.github/get-shit-done/workflows/git-identity-helpers.sh
fi

git add -A
commit_as_user "refactor: migrate installation domain

- Reporter, colors, CLI detection in bin/lib/installation/
- Import paths updated
- Tests pass"
```
  </action>
  <verify>
```bash
ls -la bin/lib/installation/
npm test
```
  </verify>
  <done>Installation domain migrated with all workflow files organized</done>
</task>

<task name="organize-test-helpers" type="auto">
  <files>bin/lib/testing/**</files>
  <action>
Consolidate test utilities in bin/lib/testing/:

```bash
echo "Organizing test utilities..."

# Move test-helpers if exists
if [ -d "bin/lib/test-helpers" ]; then
  git mv bin/lib/test-helpers/* bin/lib/testing/
  rmdir bin/lib/test-helpers 2>/dev/null || true
fi

# Create fixtures directory for test data
mkdir -p bin/lib/testing/fixtures

# Update import paths in test files
find bin/ __tests__/ -name "*.test.js" -type f -exec sed -i.bak \
  -e "s|require(['\"]\.\.\/test-helpers\/|require('\.\./testing/|g" \
  -e "s|require(['\"]\.\/lib\/test-helpers\/|require('\./lib/testing/|g" \
  {} \;

find bin/ __tests__/ -name "*.js.bak" -delete

# Run tests
npm test

# Source git identity helpers
if ! type commit_as_user >/dev/null 2>&1; then
    source /workspace/.github/get-shit-done/workflows/git-identity-helpers.sh
fi

git add -A
commit_as_user "refactor: organize test utilities in bin/lib/testing/

- Test helpers and fixtures centralized
- Import paths updated
- Tests pass"
```
  </action>
  <verify>
```bash
ls -la bin/lib/testing/
npm test
```
  </verify>
  <done>Test utilities organized in bin/lib/testing/ with fixtures support</done>
</task>

## Verification

After completion, verify these observable truths:

1. **Platforms migrated:** `ls bin/lib/platforms/` shows claude.js, copilot.js, codex.js
2. **Configuration migrated:** `ls bin/lib/configuration/` shows flag-parser.js, paths.js, etc.
3. **Templating migrated:** `ls bin/lib/templating/doc-generator/` exists
4. **Installation migrated:** `ls bin/lib/installation/` shows reporter.js, colors.js, etc.
5. **Testing organized:** `ls bin/lib/testing/` shows test helpers
6. **Tests pass:** `npm test` exits 0 with all tests passing
7. **Doc generator works:** `npm run docs:generate` completes successfully

## Success Criteria

- ✅ All 5 domains populated with migrated code
- ✅ Platform adapters in bin/lib/platforms/
- ✅ Configuration in bin/lib/configuration/
- ✅ doc-generator in bin/lib/templating/
- ✅ Installation workflow in bin/lib/installation/
- ✅ Test utilities in bin/lib/testing/
- ✅ All import paths correctly updated
- ✅ All tests passing after each migration
- ✅ Package.json scripts updated
- ✅ No broken references

## Output

Fully populated domain structure with:
- All code migrated into appropriate domains
- Working import paths
- All tests passing
- Ready for test structure unification
