---
phase: 05.1-codebase-architecture-optimization
plan: 02-01
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - bin/lib/** (circular deps fixed)
  - lib-ghcc/** (evaluated)
  - package.json (unused deps removed)
  - bin/lib/platforms/ (domain created)
  - bin/lib/installation/ (domain created)
  - bin/lib/configuration/ (domain created)
  - bin/lib/templating/ (domain created)
  - bin/lib/testing/ (domain created)
autonomous: true
must_haves:
  - cleanup: All circular dependencies resolved (empty madge --circular output)
  - cleanup: All unused files removed from codebase
  - cleanup: All unused npm dependencies uninstalled
  - structure: bin/lib/ organized by domain directories created (platforms/, installation/, configuration/, templating/, testing/)
  - quality: All tests pass after cleanup (no regressions)
  - key_links:
    - from: "bin/lib/platforms/claude.js"
      to: "install.js"
      via: "require('./lib/platforms/claude')"
      purpose: "Install.js orchestrates platform-specific installations"
    - from: "bin/lib/templating/doc-generator/"
      to: "package.json scripts"
      via: "bin/lib/templating/doc-generator/generate.js"
      purpose: "Doc generator invoked via npm scripts"
    - from: "bin/lib/configuration/flag-parser.js"
      to: "install.js"
      via: "require('./lib/configuration/flag-parser')"
      purpose: "Flags parsed before installation workflow"
---

# Phase 5.1 Plan 02-01: Foundation & Cleanup

## Objective

Fix circular dependencies, remove unused files and npm dependencies, and create the target domain structure. This establishes a clean foundation for migrating code into domains.

## Context

**Starting state (from Wave 1 analysis):**
- Dependency tree mapped from install.js
- Unused files identified
- Circular dependencies detected (count known)
- Baseline coverage recorded

**What we're doing:**
1. Resolve any circular dependencies (blocking issue)
2. Remove unused files and npm packages (strict audit)
3. Create empty domain directories for migration

**Critical constraint:** All tests MUST run in /tmp (never touch real .claude/, .copilot/, .codex/). Test isolation protects user installations during development.

**Test environment:** Tests use temporary directories created by Jest setup. See `__tests__/setup.js` for /tmp configuration. DO NOT modify test setup - it already enforces /tmp isolation.

## Tasks

<task name="fix-circular-dependencies" type="auto">
  <files>bin/lib/**, lib-ghcc/**</files>
  <action>
Fix any circular dependencies identified in Wave 1 analysis:

```bash
# Check if circular dependencies exist
CIRCULAR_COUNT=$(grep -c "bin\|lib-ghcc" analysis-circular-deps.txt 2>/dev/null || echo "0")

if [ "$CIRCULAR_COUNT" -gt 0 ]; then
  echo "Fixing $CIRCULAR_COUNT circular dependencies..."
  
  # Display circular deps for manual resolution
  cat analysis-circular-deps.txt
  
  # Common fixes:
  # 1. Extract shared utilities to new file
  # 2. Combine tightly coupled files
  # 3. Use dependency injection to break cycle
  # 4. Move shared types/interfaces to separate file
  
  # After each fix, verify:
  # npx madge --circular bin/ lib-ghcc/
  
  echo "Manual intervention: Review circular deps and apply appropriate fix pattern"
else
  echo "✓ No circular dependencies found - proceeding"
fi

# Verify resolution
npx madge --circular bin/ lib-ghcc/ > circular-check-after-fix.txt
if [ -s circular-check-after-fix.txt ]; then
  echo "❌ Circular dependencies still exist after fix attempt"
  exit 1
fi

echo "✅ All circular dependencies resolved"
```

**Blocking:** Cannot proceed with restructuring until circular deps are resolved.
  </action>
  <verify>
```bash
# Must return empty (no circular deps)
npx madge --circular bin/ lib-ghcc/
echo "Exit code should be 0: $?"
```
  </verify>
  <done>All circular dependencies resolved with empty madge --circular output</done>
</task>

<task name="remove-unused-files-and-deps" type="auto">
  <files>bin/**, lib-ghcc/**, package.json</files>
  <action>
Remove unused files and npm dependencies based on Wave 1 analysis:

```bash
# 1. Remove unused npm dependencies
if [ -f analysis-unused-deps.txt ]; then
  echo "Removing unused npm dependencies..."
  
  # Extract unused dependencies from depcheck output
  UNUSED_DEPS=$(grep -A 100 "Unused dependencies" analysis-unused-deps.txt | grep "^\*" | sed 's/\* //' || echo "")
  
  if [ -n "$UNUSED_DEPS" ]; then
    for dep in $UNUSED_DEPS; do
      echo "Removing: $dep"
      npm uninstall "$dep"
    done
  else
    echo "✓ No unused dependencies to remove"
  fi
fi

# 2. Remove unused source files (strict audit)
if [ -f analysis-unused-files.txt ]; then
  echo "Reviewing unused files for removal..."
  
  # Get files not in dependency tree (excluding test files for now)
  UNUSED_FILES=$(grep -E "^(bin|lib-ghcc)/.*\.js$" analysis-unused-files.txt | grep -v "\.test\.js$" || echo "")
  
  if [ -n "$UNUSED_FILES" ]; then
    echo "Files to remove (not in dependency tree):"
    echo "$UNUSED_FILES"
    
    # Strict audit: Remove files not in dependency tree
    echo "$UNUSED_FILES" | while read file; do
      if [ -f "$file" ]; then
        # Double-check file is not imported anywhere
        REFERENCES=$(grep -r "require.*$(basename $file .js)" bin/ lib-ghcc/ 2>/dev/null | wc -l)
        
        if [ "$REFERENCES" -eq 0 ]; then
          echo "  Removing: $file (0 references)"
          git rm "$file"
        else
          echo "  Keeping: $file ($REFERENCES references found)"
        fi
      fi
    done
  else
    echo "✓ No unused files to remove"
  fi
fi

# 3. Run tests to verify no breakage (tests run in /tmp automatically via Jest setup)
npm test

# 4. Commit cleanup
git commit -m "refactor: remove unused files and dependencies

- Removed unused npm packages identified by depcheck
- Removed source files not in dependency tree
- All tests pass (no regressions)"
```

**Safety:** Git history preserves everything. Can restore if needed.
  </action>
  <verify>
```bash
# Tests should still pass
npm test

# Verify files removed
git log -1 --stat | grep -E "delete|remove"
```
  </verify>
  <done>Unused files and dependencies removed with all tests passing</done>
</task>

<task name="create-domain-structure" type="auto">
  <files>bin/lib/**</files>
  <action>
Create target directory structure for feature/domain organization:

```bash
# Create domain folders under bin/lib/
mkdir -p bin/lib/platforms
mkdir -p bin/lib/installation
mkdir -p bin/lib/configuration
mkdir -p bin/lib/templating
mkdir -p bin/lib/testing

# Keep existing directories that fit the model
# bin/lib/adapters → will be moved to platforms/
# bin/lib/menu → will be moved to configuration/
# bin/lib/output → will be moved to installation/ (or configuration/, TBD)
# bin/lib/orchestration → stays as-is (special case for GSD orchestration)

# Source git identity helpers
if ! type commit_as_user >/dev/null 2>&1; then
    source /workspace/.github/get-shit-done/workflows/git-identity-helpers.sh
fi

# Commit structure
git add bin/lib/platforms bin/lib/installation bin/lib/configuration bin/lib/templating bin/lib/testing
commit_as_user "refactor: create domain-based directory structure

- platforms/: AI platform adapters (Claude, Copilot, Codex + future)
- installation/: Install workflow, validation, file operations
- configuration/: Flags, paths, menu, routing
- templating/: Doc generator, template engine
- testing/: Shared test utilities, mocks, fixtures"
```
  </action>
  <verify>
```bash
# Verify directories created
ls -ld bin/lib/{platforms,installation,configuration,templating,testing}
```
  </verify>
  <done>Domain-based directory structure created under bin/lib/</done>
</task>

## Verification

After completion, verify these observable truths:

1. **No circular deps:** `npx madge --circular bin/` returns empty
2. **Tests pass:** `npm test` exits 0 with all tests passing (in /tmp)
3. **Unused removed:** Files from analysis-unused-files.txt no longer exist
4. **Domains created:** `ls bin/lib/` shows platforms/, installation/, configuration/, templating/, testing/
5. **Git commits:** Clean commit history showing removals and structure creation

## Success Criteria

- ✅ All circular dependencies resolved (empty madge output)
- ✅ All unused files and dependencies removed
- ✅ Domain structure created (5 top-level folders)
- ✅ All tests pass (no regressions)
- ✅ Clean foundation ready for domain migration

## Output

Clean codebase with:
- No circular dependencies
- No unused code
- Empty domain directories ready for migration
- All tests passing
