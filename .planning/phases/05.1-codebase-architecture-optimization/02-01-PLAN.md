---
phase: 05.1-codebase-architecture-optimization
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - bin/lib/** (restructured into domains)
  - lib-ghcc/** (evaluated and organized)
  - bin/doc-generator/** (moved to bin/lib/templating/)
  - package.json (unused deps removed)
  - jest.config.js (multi-location test patterns)
  - __tests__/** (integration tests organized)
  - bin/lib/**/*.test.js (unit tests colocated)
  - .gitignore (coverage/ added)
autonomous: true
must_haves:
  - structure: bin/lib/ organized by domain (platforms/, installation/, configuration/, templating/, testing/)
  - structure: install.js remains central entry point with no logic moved
  - structure: All platform adapters in bin/lib/platforms/ with base-adapter.js interface
  - structure: doc-generator migrated to bin/lib/templating/ with working imports
  - cleanup: All circular dependencies resolved (empty madge --circular output)
  - cleanup: All unused files removed from codebase
  - cleanup: All unused npm dependencies uninstalled
  - tests: Integration tests in __tests__/ with clear naming
  - tests: Unit tests colocated in bin/lib/ next to implementation
  - tests: Jest config supports both locations with *.test.js pattern
  - tests: coverage/ removed from git and added to .gitignore
  - quality: All tests pass after restructuring (no regressions)
  - quality: Test coverage within ±5% of baseline
---

# Phase 5.1 Plan 02: Restructure & Cleanup

## Objective

Restructure bin/ and lib-ghcc/ into clean feature/domain-based architecture, remove all low-value files, eliminate circular dependencies, and unify test structure. This implements SOLID principles and prepares codebase for future AI platform integrations (GPT-4All, Mistral, Gemini).

## Context

**Starting state (from Wave 1 analysis):**
- Dependency tree mapped from install.js
- Unused files identified
- Circular dependencies detected (count known)
- Baseline coverage recorded

**Target architecture:**
```
bin/lib/
├── platforms/           # Claude, Copilot, Codex adapters (+ future GPT-4All, Mistral, Gemini)
├── installation/        # Install workflow, validation, file operations
├── configuration/       # Flags, paths, menu, routing
├── templating/          # Doc generator, template engine (moved from bin/doc-generator/)
└── testing/             # Shared test utilities, mocks, fixtures
```

**User decisions applied:**
- Strict audit: Remove anything not in dependency tree
- Feature/domain organization (not technical layers)
- Split tests: Integration in __tests__/, unit tests colocated
- Preserve install.js as central orchestrator

**Critical constraint:** All tests must pass after each domain migration. Incremental approach with green tests between stages.

## Tasks

<task name="fix-circular-dependencies" type="auto">
  <files>bin/lib/**, lib-ghcc/**</files>
  <action>
Fix any circular dependencies identified in Wave 1 analysis:

```bash
# Check if circular dependencies exist
CIRCULAR_COUNT=$(grep -c "bin\|lib-ghcc" analysis-circular-deps.txt 2>/dev/null || echo "0")

if [ "$CIRCULAR_COUNT" -gt 0 ]; then
  echo "Fixing $CIRCULAR_COUNT circular dependencies..."
  
  # Display circular deps for manual resolution
  cat analysis-circular-deps.txt
  
  # Common fixes:
  # 1. Extract shared utilities to new file
  # 2. Combine tightly coupled files
  # 3. Use dependency injection to break cycle
  # 4. Move shared types/interfaces to separate file
  
  # After each fix, verify:
  # npx madge --circular bin/ lib-ghcc/
  
  echo "Manual intervention: Review circular deps and apply appropriate fix pattern"
else
  echo "✓ No circular dependencies found - proceeding"
fi

# Verify resolution
npx madge --circular bin/ lib-ghcc/ > circular-check-after-fix.txt
if [ -s circular-check-after-fix.txt ]; then
  echo "❌ Circular dependencies still exist after fix attempt"
  exit 1
fi

echo "✅ All circular dependencies resolved"
```

**Blocking:** Cannot proceed with restructuring until circular deps are resolved.
  </action>
  <verify>
```bash
# Must return empty (no circular deps)
npx madge --circular bin/ lib-ghcc/
echo "Exit code should be 0: $?"
```
  </verify>
  <done>All circular dependencies resolved with empty madge --circular output</done>
</task>

<task name="remove-unused-files-and-deps" type="auto">
  <files>bin/**, lib-ghcc/**, package.json</files>
  <action>
Remove unused files and npm dependencies based on Wave 1 analysis:

```bash
# 1. Remove unused npm dependencies
if [ -f analysis-unused-deps.txt ]; then
  echo "Removing unused npm dependencies..."
  
  # Extract unused dependencies from depcheck output
  UNUSED_DEPS=$(grep -A 100 "Unused dependencies" analysis-unused-deps.txt | grep "^\*" | sed 's/\* //' || echo "")
  
  if [ -n "$UNUSED_DEPS" ]; then
    for dep in $UNUSED_DEPS; do
      echo "Removing: $dep"
      npm uninstall "$dep"
    done
  else
    echo "✓ No unused dependencies to remove"
  fi
fi

# 2. Remove unused source files (strict audit)
if [ -f analysis-unused-files.txt ]; then
  echo "Reviewing unused files for removal..."
  
  # Get files not in dependency tree (excluding test files for now)
  UNUSED_FILES=$(grep -E "^(bin|lib-ghcc)/.*\.js$" analysis-unused-files.txt | grep -v "\.test\.js$" || echo "")
  
  if [ -n "$UNUSED_FILES" ]; then
    echo "Files to remove (not in dependency tree):"
    echo "$UNUSED_FILES"
    
    # Strict audit: Remove files not in dependency tree
    echo "$UNUSED_FILES" | while read file; do
      if [ -f "$file" ]; then
        # Double-check file is not imported anywhere
        REFERENCES=$(grep -r "require.*$(basename $file .js)" bin/ lib-ghcc/ 2>/dev/null | wc -l)
        
        if [ "$REFERENCES" -eq 0 ]; then
          echo "  Removing: $file (0 references)"
          git rm "$file"
        else
          echo "  Keeping: $file ($REFERENCES references found)"
        fi
      fi
    done
  else
    echo "✓ No unused files to remove"
  fi
fi

# 3. Run tests to verify no breakage
npm test

# 4. Commit cleanup
git commit -m "refactor: remove unused files and dependencies

- Removed unused npm packages identified by depcheck
- Removed source files not in dependency tree
- All tests pass (no regressions)"
```

**Safety:** Git history preserves everything. Can restore if needed.
  </action>
  <verify>
```bash
# Tests should still pass
npm test

# Verify files removed
git log -1 --stat | grep -E "delete|remove"
```
  </verify>
  <done>Unused files and dependencies removed with all tests passing</done>
</task>

<task name="create-domain-structure" type="auto">
  <files>bin/lib/**</files>
  <action>
Create target directory structure for feature/domain organization:

```bash
# Create domain folders under bin/lib/
mkdir -p bin/lib/platforms
mkdir -p bin/lib/installation
mkdir -p bin/lib/configuration
mkdir -p bin/lib/templating
mkdir -p bin/lib/testing

# Keep existing directories that fit the model
# bin/lib/adapters → will be moved to platforms/
# bin/lib/menu → will be moved to configuration/
# bin/lib/output → will be moved to installation/ (or configuration/, TBD)
# bin/lib/orchestration → stays as-is (special case for GSD orchestration)

# Commit structure
git add bin/lib/platforms bin/lib/installation bin/lib/configuration bin/lib/templating bin/lib/testing
git commit -m "refactor: create domain-based directory structure

- platforms/: AI platform adapters (Claude, Copilot, Codex + future)
- installation/: Install workflow, validation, file operations
- configuration/: Flags, paths, menu, routing
- templating/: Doc generator, template engine
- testing/: Shared test utilities, mocks, fixtures"
```
  </action>
  <verify>
```bash
# Verify directories created
ls -ld bin/lib/{platforms,installation,configuration,templating,testing}
```
  </verify>
  <done>Domain-based directory structure created under bin/lib/</done>
</task>

<task name="migrate-platforms-domain" type="auto">
  <files>bin/lib/platforms/**, bin/lib/adapters/**</files>
  <action>
Migrate platform adapters to bin/lib/platforms/:

```bash
# Move adapters to platforms/
echo "Migrating platforms domain..."

# Move adapter files
git mv bin/lib/adapters/claude.js bin/lib/platforms/
git mv bin/lib/adapters/copilot.js bin/lib/platforms/
git mv bin/lib/adapters/codex.js bin/lib/platforms/

# Move shared adapter utilities
if [ -d "bin/lib/adapters/shared" ]; then
  git mv bin/lib/adapters/shared bin/lib/platforms/
fi

# Remove empty adapters directory
rmdir bin/lib/adapters 2>/dev/null || true

# Update imports in moved files
# OLD: require('../../adapters/claude')
# NEW: require('../platforms/claude')
find bin/lib/platforms/ -name "*.js" -type f -exec sed -i.bak \
  -e "s|require(['\"]\.\.\/\.\.\/adapters\/|require('\.\./|g" \
  -e "s|require(['\"]\.\/shared\/|require('\.\./platforms/shared/|g" \
  {} \;

# Update imports in files that reference adapters
find bin/ -name "*.js" -type f ! -path "*/platforms/*" -exec sed -i.bak \
  -e "s|require(['\"]\.\/lib\/adapters\/|require('\./lib/platforms/|g" \
  -e "s|require(['\"]\.\.\/adapters\/|require('\.\./platforms/|g" \
  {} \;

# Remove backup files
find bin/ -name "*.js.bak" -delete

# Run tests
npm test

# Commit
git add -A
git commit -m "refactor: migrate platforms domain to bin/lib/platforms/

- Moved Claude, Copilot, Codex adapters
- Updated all import paths
- Tests pass (no regressions)"
```
  </action>
  <verify>
```bash
# Verify files moved and tests pass
ls -la bin/lib/platforms/
npm test
```
  </verify>
  <done>Platform adapters migrated to bin/lib/platforms/ with all tests passing</done>
</task>

<task name="migrate-configuration-domain" type="auto">
  <files>bin/lib/configuration/**</files>
  <action>
Migrate configuration-related files to bin/lib/configuration/:

```bash
echo "Migrating configuration domain..."

# Identify configuration files (flags, paths, menu, routing)
CONFIG_FILES=(
  "flag-parser.js"
  "flag-validator.js"
  "old-flag-detector.js"
  "path-validator.js"
  "paths.js"
  "conflict-resolver.js"
)

# Move configuration files
for file in "${CONFIG_FILES[@]}"; do
  if [ -f "bin/lib/$file" ]; then
    git mv "bin/lib/$file" bin/lib/configuration/
  fi
done

# Move menu subdirectory
if [ -d "bin/lib/menu" ]; then
  git mv bin/lib/menu/* bin/lib/configuration/
  rmdir bin/lib/menu
fi

# Update import paths throughout codebase
find bin/ -name "*.js" -type f -exec sed -i.bak \
  -e "s|require(['\"]\.\/lib\/menu\/|require('\./lib/configuration/|g" \
  -e "s|require(['\"]\.\.\/menu\/|require('\.\./configuration/|g" \
  -e "s|require(['\"]\.\/lib\/flag-parser|require('\./lib/configuration/flag-parser|g" \
  -e "s|require(['\"]\.\/lib\/paths|require('\./lib/configuration/paths|g" \
  {} \;

find bin/ -name "*.js.bak" -delete

# Run tests
npm test

git add -A
git commit -m "refactor: migrate configuration domain

- Flags, paths, menu, routing in bin/lib/configuration/
- All import paths updated
- Tests pass"
```
  </action>
  <verify>
```bash
ls -la bin/lib/configuration/
npm test
```
  </verify>
  <done>Configuration domain migrated to bin/lib/configuration/ with working imports</done>
</task>

<task name="migrate-templating-domain" type="auto">
  <files>bin/lib/templating/**, bin/doc-generator/**</files>
  <action>
Migrate doc-generator and template system to bin/lib/templating/:

```bash
echo "Migrating templating domain..."

# Move doc-generator from bin/ to bin/lib/templating/
if [ -d "bin/doc-generator" ]; then
  git mv bin/doc-generator bin/lib/templating/doc-generator
fi

# Move template-system if exists
if [ -d "bin/lib/template-system" ]; then
  # Merge with templating or keep separate
  git mv bin/lib/template-system/* bin/lib/templating/
  rmdir bin/lib/template-system 2>/dev/null || true
fi

# Update import paths (scripts that reference doc-generator)
find bin/ -name "*.js" -type f -exec sed -i.bak \
  -e "s|require(['\"]\.\/doc-generator\/|require('\./lib/templating/doc-generator/|g" \
  -e "s|bin/doc-generator|bin/lib/templating/doc-generator|g" \
  {} \;

# Update package.json scripts
sed -i.bak 's|bin/doc-generator/|bin/lib/templating/doc-generator/|g' package.json
rm package.json.bak

find bin/ -name "*.js.bak" -delete

# Run tests
npm test

git add -A
git commit -m "refactor: migrate templating domain

- Moved doc-generator to bin/lib/templating/
- Updated package.json scripts
- Import paths corrected
- Tests pass"
```
  </action>
  <verify>
```bash
ls -la bin/lib/templating/
npm test
npm run docs:generate  # Verify doc-generator still works
```
  </verify>
  <done>Templating domain migrated with doc-generator working in new location</done>
</task>

<task name="migrate-installation-domain" type="auto">
  <files>bin/lib/installation/**</files>
  <action>
Migrate installation-related files to bin/lib/installation/:

```bash
echo "Migrating installation domain..."

# Move output formatting (Reporter, etc.)
if [ -d "bin/lib/output" ]; then
  git mv bin/lib/output/* bin/lib/installation/
  rmdir bin/lib/output 2>/dev/null || true
fi

# Move other installation files
INSTALL_FILES=(
  "upgrade.js"
  "colors.js"
  "cli-detection"
  "migration"
)

for item in "${INSTALL_FILES[@]}"; do
  if [ -e "bin/lib/$item" ]; then
    git mv "bin/lib/$item" bin/lib/installation/
  fi
done

# Update import paths
find bin/ -name "*.js" -type f -exec sed -i.bak \
  -e "s|require(['\"]\.\/lib\/output\/|require('\./lib/installation/|g" \
  -e "s|require(['\"]\.\.\/output\/|require('\.\./installation/|g" \
  -e "s|require(['\"]\.\/lib\/colors|require('\./lib/installation/colors|g" \
  {} \;

find bin/ -name "*.js.bak" -delete

# Run tests
npm test

git add -A
git commit -m "refactor: migrate installation domain

- Reporter, colors, CLI detection in bin/lib/installation/
- Import paths updated
- Tests pass"
```
  </action>
  <verify>
```bash
ls -la bin/lib/installation/
npm test
```
  </verify>
  <done>Installation domain migrated with all workflow files organized</done>
</task>

<task name="organize-test-helpers" type="auto">
  <files>bin/lib/testing/**</files>
  <action>
Consolidate test utilities in bin/lib/testing/:

```bash
echo "Organizing test utilities..."

# Move test-helpers if exists
if [ -d "bin/lib/test-helpers" ]; then
  git mv bin/lib/test-helpers/* bin/lib/testing/
  rmdir bin/lib/test-helpers 2>/dev/null || true
fi

# Create fixtures directory for test data
mkdir -p bin/lib/testing/fixtures

# Update import paths in test files
find bin/ __tests__/ -name "*.test.js" -type f -exec sed -i.bak \
  -e "s|require(['\"]\.\.\/test-helpers\/|require('\.\./testing/|g" \
  -e "s|require(['\"]\.\/lib\/test-helpers\/|require('\./lib/testing/|g" \
  {} \;

find bin/ __tests__/ -name "*.js.bak" -delete

# Run tests
npm test

git add -A
git commit -m "refactor: organize test utilities in bin/lib/testing/

- Test helpers and fixtures centralized
- Import paths updated
- Tests pass"
```
  </action>
  <verify>
```bash
ls -la bin/lib/testing/
npm test
```
  </verify>
  <done>Test utilities organized in bin/lib/testing/ with fixtures support</done>
</task>

<task name="unify-test-structure" type="auto">
  <files>jest.config.js, __tests__/**, bin/lib/**/*.test.js</files>
  <action>
Implement split test strategy: integration in __tests__/, unit tests colocated:

```bash
echo "Unifying test structure..."

# 1. Update Jest configuration for multi-location support
cat > jest.config.js << 'EOF'
module.exports = {
  testEnvironment: 'node',
  testMatch: [
    '**/__tests__/**/*.test.js',   // Integration tests
    '**/bin/**/*.test.js',          // Unit tests (colocated)
  ],
  collectCoverageFrom: [
    'bin/**/*.js',
    'lib-ghcc/**/*.js',
    '!bin/**/*.test.js',            // Exclude tests from coverage
    '!**/node_modules/**',
    '!**/coverage/**',
  ],
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
  testPathIgnorePatterns: [
    '/node_modules/',
    '/coverage/',
  ],
  coverageThreshold: {
    global: {
      statements: 80,
      branches: 75,
      functions: 80,
      lines: 80,
    },
  },
};
EOF

# 2. Categorize existing tests
echo "Categorizing tests by type..."

# Integration tests (full workflows) - keep in __tests__/
# Unit tests (single module) - move next to implementation

# Move unit tests to colocated positions
UNIT_TESTS=(
  "flag-parser.test.js"
  "flag-validator.test.js"
  "old-flag-detector.test.js"
  "path-validator.test.js"
  "paths.test.js"
  "conflict-resolver.test.js"
)

for test in "${UNIT_TESTS[@]}"; do
  if [ -f "bin/lib/$test" ]; then
    # Already colocated or needs domain migration
    BASE=$(basename "$test" .test.js)
    
    # Find corresponding implementation
    IMPL=$(find bin/lib/ -name "${BASE}.js" ! -name "*.test.js" | head -1)
    
    if [ -n "$IMPL" ]; then
      IMPL_DIR=$(dirname "$IMPL")
      if [ -f "bin/lib/$test" ] && [ "$IMPL_DIR" != "bin/lib" ]; then
        git mv "bin/lib/$test" "$IMPL_DIR/"
      fi
    fi
  fi
done

# 3. Run tests with new config
npm test

git add -A
git commit -m "test: unify test structure with split strategy

- Jest config supports __tests__/ (integration) and bin/ (unit)
- Unit tests colocated next to implementation
- Integration tests in __tests__/
- Coverage threshold enforced (80%)
- All tests pass"
```
  </action>
  <verify>
```bash
# Verify Jest finds tests in both locations
npm test -- --listTests | grep -E "(__tests__|bin/lib)" | wc -l

# Run tests
npm test
```
  </verify>
  <done>Test structure unified with integration in __tests__/ and unit tests colocated</done>
</task>

<task name="cleanup-coverage-directory" type="auto">
  <files>.gitignore, coverage/**</files>
  <action>
Remove coverage/ from git tracking and add to .gitignore:

```bash
echo "Cleaning up coverage directory..."

# 1. Check if coverage is tracked
if git ls-files coverage/ | grep -q .; then
  echo "Removing coverage/ from git..."
  git rm -r coverage/
else
  echo "✓ coverage/ not tracked in git"
fi

# 2. Add to .gitignore if not present
if ! grep -q "^coverage/$" .gitignore 2>/dev/null; then
  echo "" >> .gitignore
  echo "# Test coverage output" >> .gitignore
  echo "coverage/" >> .gitignore
  echo "*.lcov" >> .gitignore
fi

# 3. Remove .DS_Store and other cruft
find . -name ".DS_Store" -type f -delete 2>/dev/null || true

git add .gitignore
git commit -m "chore: remove coverage/ from git tracking

- Added coverage/ to .gitignore
- Coverage reports are local artifacts, not versioned
- Removed .DS_Store files"
```
  </action>
  <verify>
```bash
# Verify coverage not tracked
git ls-files coverage/ | wc -l  # Should be 0

# Verify .gitignore contains coverage/
grep "coverage" .gitignore
```
  </verify>
  <done>Coverage directory removed from git and added to .gitignore</done>
</task>

<task name="verify-restructure-complete" type="auto">
  <files>analysis-dep-tree-after.txt, architecture-after.png</files>
  <action>
Verify restructuring complete with no regressions:

```bash
echo "Verifying restructure complete..."

# 1. Run full test suite
npm test -- --coverage > coverage-after-restructure.txt 2>&1

# 2. Check no circular dependencies
npx madge --circular bin/ lib-ghcc/ > circular-check-final.txt

if [ -s circular-check-final.txt ]; then
  echo "❌ FAIL: Circular dependencies still exist"
  cat circular-check-final.txt
  exit 1
fi

echo "✓ No circular dependencies"

# 3. Generate new dependency graph
npx madge --image architecture-after.png bin/lib/ 2>/dev/null || true

# 4. Compare coverage with baseline
BASELINE_COV=$(grep "% Lines" baseline-coverage.txt | head -1 | grep -oE "[0-9]+\.[0-9]+" || echo "0")
CURRENT_COV=$(grep "% Lines" coverage-after-restructure.txt | head -1 | grep -oE "[0-9]+\.[0-9]+" || echo "0")

echo "Coverage comparison:"
echo "  Baseline: ${BASELINE_COV}%"
echo "  Current:  ${CURRENT_COV}%"

# Allow ±5% variance
DIFF=$(echo "$CURRENT_COV - $BASELINE_COV" | bc 2>/dev/null || echo "0")
ABS_DIFF=$(echo "$DIFF" | tr -d '-')

if (( $(echo "$ABS_DIFF > 5.0" | bc -l) )); then
  echo "⚠️  Coverage changed by ${DIFF}% (threshold: ±5%)"
else
  echo "✓ Coverage maintained within threshold"
fi

# 5. Verify domain structure
echo ""
echo "Domain structure verification:"
for domain in platforms installation configuration templating testing; do
  COUNT=$(find "bin/lib/$domain" -name "*.js" 2>/dev/null | wc -l)
  echo "  $domain: $COUNT files"
done

# 6. Summary
echo ""
echo "=== Restructure Complete ==="
echo "✓ All tests pass"
echo "✓ No circular dependencies"
echo "✓ Coverage maintained"
echo "✓ Domain structure verified"
```
  </action>
  <verify>
```bash
# All tests should pass
npm test

# Check final structure
tree -I 'node_modules|coverage' -L 3 bin/lib/
```
  </verify>
  <done>Restructure verified complete with all tests passing and coverage maintained</done>
</task>

## Verification

After completion, verify these observable truths:

1. **Domain structure exists:** `ls bin/lib/` shows platforms/, installation/, configuration/, templating/, testing/
2. **Platform adapters migrated:** `ls bin/lib/platforms/` shows claude.js, copilot.js, codex.js
3. **Doc-generator moved:** `ls bin/lib/templating/doc-generator/` exists
4. **No circular deps:** `npx madge --circular bin/` returns empty
5. **Tests pass:** `npm test` exits 0 with all tests passing
6. **Coverage maintained:** Coverage within ±5% of baseline
7. **Jest multi-location:** `npm test -- --listTests` shows tests from both __tests__/ and bin/
8. **Coverage ignored:** `git ls-files coverage/` returns empty
9. **Unused files removed:** Files from analysis-unused-files.txt no longer exist

## Success Criteria

- ✅ Feature/domain architecture implemented (5 top-level folders)
- ✅ install.js unchanged (remains central orchestrator)
- ✅ All platform adapters in bin/lib/platforms/
- ✅ doc-generator migrated to bin/lib/templating/
- ✅ All circular dependencies resolved (empty madge output)
- ✅ All unused files and dependencies removed
- ✅ Test structure unified (integration + colocated unit tests)
- ✅ Jest config supports both test locations
- ✅ coverage/ removed from git and .gitignore updated
- ✅ All tests pass (no regressions)
- ✅ Coverage within ±5% of baseline
- ✅ Architecture diagram generated (before/after comparison)

## Output

Restructured codebase with:
- Clean domain-based architecture
- No circular dependencies
- Unified test structure
- Lean dependency tree
- All functionality preserved
