---
phase: 05.1-codebase-architecture-optimization
plan: 02-03
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - jest.config.js (multi-location test patterns)
  - __tests__/** (integration tests organized)
  - bin/lib/**/*.test.js (unit tests colocated)
  - .gitignore (coverage/ added)
  - analysis-dep-tree-after.txt
  - architecture-after.png
autonomous: true
must_haves:
  - tests: Integration tests in __tests__/ with clear naming
  - tests: Unit tests colocated in bin/lib/ next to implementation
  - tests: Jest config supports both locations with *.test.js pattern
  - tests: coverage/ removed from git and added to .gitignore
  - quality: All tests pass after restructuring (no regressions)
  - quality: Test coverage within ±5% of baseline
  - quality: No circular dependencies (verified with madge)
  - documentation: Architecture diagram generated (architecture-after.png)
---

# Phase 5.1 Plan 02-03: Test Unification & Verification

## Objective

Unify test structure with split strategy (integration in __tests__/, unit tests colocated), remove coverage/ from git tracking, and verify the complete restructuring maintains quality with no regressions.

## Context

**Starting state (from Plan 02-02):**
- All domains fully populated with migrated code
- All import paths updated
- Tests passing

**What we're doing:**
1. Update Jest config for multi-location test support
2. Categorize and move tests (integration vs unit)
3. Remove coverage/ from git tracking
4. Final verification (no circular deps, coverage maintained)

**Test isolation reminder:** All tests already run in /tmp via Jest setup (see `__tests__/setup.js`). This is MANDATORY for safety - tests never touch real .claude/, .copilot/, .codex/ directories.

## Tasks

<task name="unify-test-structure" type="auto">
  <files>jest.config.js, __tests__/**, bin/lib/**/*.test.js</files>
  <action>
Implement split test strategy: integration in __tests__/, unit tests colocated:

```bash
echo "Unifying test structure..."

# 1. Update Jest configuration for multi-location support
cat > jest.config.js << 'EOF'
module.exports = {
  testEnvironment: 'node',
  testMatch: [
    '**/__tests__/**/*.test.js',   // Integration tests
    '**/bin/**/*.test.js',          // Unit tests (colocated)
  ],
  collectCoverageFrom: [
    'bin/**/*.js',
    'lib-ghcc/**/*.js',
    '!bin/**/*.test.js',            // Exclude tests from coverage
    '!**/node_modules/**',
    '!**/coverage/**',
  ],
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
  testPathIgnorePatterns: [
    '/node_modules/',
    '/coverage/',
  ],
  coverageThreshold: {
    global: {
      statements: 80,
      branches: 75,
      functions: 80,
      lines: 80,
    },
  },
};
EOF

# 2. Categorize existing tests
echo "Categorizing tests by type..."

# Integration tests (full workflows) - keep in __tests__/
# Unit tests (single module) - move next to implementation

# Move unit tests to colocated positions
UNIT_TESTS=(
  "flag-parser.test.js"
  "flag-validator.test.js"
  "old-flag-detector.test.js"
  "path-validator.test.js"
  "paths.test.js"
  "conflict-resolver.test.js"
)

for test in "${UNIT_TESTS[@]}"; do
  if [ -f "bin/lib/$test" ]; then
    # Already colocated or needs domain migration
    BASE=$(basename "$test" .test.js)
    
    # Find corresponding implementation
    IMPL=$(find bin/lib/ -name "${BASE}.js" ! -name "*.test.js" | head -1)
    
    if [ -n "$IMPL" ]; then
      IMPL_DIR=$(dirname "$IMPL")
      if [ -f "bin/lib/$test" ] && [ "$IMPL_DIR" != "bin/lib" ]; then
        git mv "bin/lib/$test" "$IMPL_DIR/"
      fi
    fi
  fi
done

# 3. Run tests with new config
npm test

# Source git identity helpers
if ! type commit_as_user >/dev/null 2>&1; then
    source /workspace/.github/get-shit-done/workflows/git-identity-helpers.sh
fi

git add -A
commit_as_user "test: unify test structure with split strategy

- Jest config supports __tests__/ (integration) and bin/ (unit)
- Unit tests colocated next to implementation
- Integration tests in __tests__/
- Coverage threshold enforced (80%)
- All tests pass"
```
  </action>
  <verify>
```bash
# Verify Jest finds tests in both locations
npm test -- --listTests | grep -E "(__tests__|bin/lib)" | wc -l

# Run tests
npm test
```
  </verify>
  <done>Test structure unified with integration in __tests__/ and unit tests colocated</done>
</task>

<task name="cleanup-coverage-directory" type="auto">
  <files>.gitignore, coverage/**</files>
  <action>
Remove coverage/ from git tracking and add to .gitignore:

```bash
echo "Cleaning up coverage directory..."

# 1. Check if coverage is tracked
if git ls-files coverage/ | grep -q .; then
  echo "Removing coverage/ from git..."
  git rm -r coverage/
else
  echo "✓ coverage/ not tracked in git"
fi

# 2. Add to .gitignore if not present
if ! grep -q "^coverage/$" .gitignore 2>/dev/null; then
  echo "" >> .gitignore
  echo "# Test coverage output" >> .gitignore
  echo "coverage/" >> .gitignore
  echo "*.lcov" >> .gitignore
fi

# 3. Remove .DS_Store and other cruft
find . -name ".DS_Store" -type f -delete 2>/dev/null || true

# Source git identity helpers
if ! type commit_as_user >/dev/null 2>&1; then
    source /workspace/.github/get-shit-done/workflows/git-identity-helpers.sh
fi

git add .gitignore
commit_as_user "chore: remove coverage/ from git tracking

- Added coverage/ to .gitignore
- Coverage reports are local artifacts, not versioned
- Removed .DS_Store files"
```
  </action>
  <verify>
```bash
# Verify coverage not tracked
git ls-files coverage/ | wc -l  # Should be 0

# Verify .gitignore contains coverage/
grep "coverage" .gitignore
```
  </verify>
  <done>Coverage directory removed from git and added to .gitignore</done>
</task>

<task name="verify-restructure-complete" type="auto">
  <files>analysis-dep-tree-after.txt, architecture-after.png</files>
  <action>
Verify restructuring complete with no regressions:

```bash
echo "Verifying restructure complete..."

# 1. Run full test suite
npm test -- --coverage > coverage-after-restructure.txt 2>&1

# 2. Check no circular dependencies
npx madge --circular bin/ lib-ghcc/ > circular-check-final.txt

if [ -s circular-check-final.txt ]; then
  echo "❌ FAIL: Circular dependencies still exist"
  cat circular-check-final.txt
  exit 1
fi

echo "✓ No circular dependencies"

# 3. Generate new dependency graph
npx madge --image architecture-after.png bin/lib/ 2>/dev/null || true

# 4. Compare coverage with baseline
BASELINE_COV=$(grep "% Lines" baseline-coverage.txt | head -1 | grep -oE "[0-9]+\.[0-9]+" || echo "0")
CURRENT_COV=$(grep "% Lines" coverage-after-restructure.txt | head -1 | grep -oE "[0-9]+\.[0-9]+" || echo "0")

echo "Coverage comparison:"
echo "  Baseline: ${BASELINE_COV}%"
echo "  Current:  ${CURRENT_COV}%"

# Allow ±5% variance
DIFF=$(echo "$CURRENT_COV - $BASELINE_COV" | bc 2>/dev/null || echo "0")
ABS_DIFF=$(echo "$DIFF" | tr -d '-')

if (( $(echo "$ABS_DIFF > 5.0" | bc -l) )); then
  echo "⚠️  Coverage changed by ${DIFF}% (threshold: ±5%)"
else
  echo "✓ Coverage maintained within threshold"
fi

# 5. Verify domain structure
echo ""
echo "Domain structure verification:"
for domain in platforms installation configuration templating testing; do
  COUNT=$(find "bin/lib/$domain" -name "*.js" 2>/dev/null | wc -l)
  echo "  $domain: $COUNT files"
done

# 6. Summary
echo ""
echo "=== Restructure Complete ==="
echo "✓ All tests pass"
echo "✓ No circular dependencies"
echo "✓ Coverage maintained"
echo "✓ Domain structure verified"
```
  </action>
  <verify>
```bash
# All tests should pass
npm test

# Check final structure
tree -I 'node_modules|coverage' -L 3 bin/lib/
```
  </verify>
  <done>Restructure verified complete with all tests passing and coverage maintained</done>
</task>

## Verification

After completion, verify these observable truths:

1. **Jest multi-location:** `npm test -- --listTests` shows tests from both __tests__/ and bin/
2. **Tests pass:** `npm test` exits 0 with all tests passing
3. **Coverage maintained:** Coverage within ±5% of baseline
4. **Coverage ignored:** `git ls-files coverage/` returns empty
5. **No circular deps:** `npx madge --circular bin/` returns empty
6. **Architecture diagram:** architecture-after.png exists
7. **Domain structure verified:** All 5 domains populated with expected file counts

## Success Criteria

- ✅ Test structure unified (integration + colocated unit tests)
- ✅ Jest config supports both test locations
- ✅ coverage/ removed from git and .gitignore updated
- ✅ All tests pass (no regressions)
- ✅ Coverage within ±5% of baseline
- ✅ No circular dependencies (verified)
- ✅ Architecture diagram generated (before/after comparison available)
- ✅ Restructuring complete and verified

## Output

Complete restructured codebase with:
- Clean domain-based architecture
- Unified test structure
- No circular dependencies
- Coverage maintained
- All functionality preserved
- Ready for Wave 3 (dependency modernization)
