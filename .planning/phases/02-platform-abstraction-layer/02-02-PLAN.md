---
phase: 02-platform-abstraction-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/template-system/context-builder.js
  - bin/lib/template-system/field-transformer.js
  - bin/lib/template-system/field-transformer.test.js
  - bin/lib/template-system/context-builder.test.js
autonomous: true

must_haves:
  truths:
    - "Context builder includes detailed platform capability flags"
    - "Model field conditionally included based on platform support"
    - "Hooks field only appears in Claude configs"
    - "MCP configuration handled appropriately per platform"
    - "Field transformers convert spec metadata to platform-specific format"
  artifacts:
    - path: "bin/lib/template-system/field-transformer.js"
      provides: "Platform-specific field transformation logic"
      exports: ["transformFields", "FIELD_RULES"]
      min_lines: 100
    - path: "bin/lib/template-system/context-builder.js"
      provides: "Enhanced platform capabilities (updated from 01-02)"
      contains: "supportsModel.*supportsHooks.*supportsMCP"
      min_lines: 160
  key_links:
    - from: "field-transformer.js"
      to: "PITFALLS.md"
      via: "platform capability research"
      pattern: "model.*hooks.*mcp-servers"
    - from: "context-builder.js"
      to: "field-transformer.js"
      via: "capability flags inform transformer rules (logical dependency, not import)"
      pattern: "supportsModel.*supportsHooks"
---

<objective>
Extend platform abstraction with detailed capability flags and field transformers that handle platform-specific metadata differences (model, hooks, MCP config).

Purpose: Enable conditional rendering of platform-specific fields so specs remain clean while outputs are optimized per platform.
Output: Enhanced context builder and field transformer module handling all platform metadata differences.
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PITFALLS.md
@.planning/research/ARCHITECTURE.md
@.planning/phases/01-template-engine-foundation/01-02-SUMMARY.md
@bin/lib/template-system/context-builder.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create field transformer module for platform-specific metadata</name>
  <files>bin/lib/template-system/field-transformer.js</files>
  <action>
    Create field-transformer.js implementing platform-specific field transformation rules from PITFALLS.md:
    
    1. FIELD_RULES constant defining platform support:
       ```javascript
       {
         model: { claude: true, copilot: false },  // Pitfall 3
         hooks: { claude: true, copilot: false },  // Pitfall 10
         skills: { claude: true, copilot: false }, // Pitfall 10
         disallowedTools: { claude: true, copilot: false }, // Pitfall 4
         'mcp-servers': { claude: false, copilot: true }, // Pitfall 8
         tools: { claude: true, copilot: true },
         description: { claude: true, copilot: true }
       }
       ```
    
    2. transformFields(frontmatter, platform) function:
       - Input: Raw frontmatter object from spec, target platform
       - Output: Transformed frontmatter with platform-specific fields
       - Remove unsupported fields (e.g., model on Copilot)
       - Add platform-specific fields if needed
       - Preserve common fields unchanged
    
    3. validateFieldSupport(fieldName, platform) function:
       - Returns: { supported, warning, suggestion }
       - Warn when using model field on Copilot (Pitfall 3)
       - Warn when using hooks/skills on Copilot (Pitfall 10)
       - Suggest alternatives (hooks → prompt text, disallowedTools → allowlist)
    
    4. addPlatformMetadata(frontmatter, platform, options) function:
       - Add generation metadata comments
       - Include platform identifier
       - Add source spec path if provided
       - Embed template version and generation timestamp
    
    Implementation considerations:
    - Never silently remove fields - always generate warning
    - Preserve unknown fields with warning (forward compatibility)
    - Use structured warnings: { field, reason, impact, suggestion }
    - Export constants and functions as CommonJS
  </action>
  <verify>
    node -e "
    const ft = require('./bin/lib/template-system/field-transformer');
    const spec = { model: 'haiku', tools: ['Bash'], hooks: {on_create: 'test'} };
    console.log('Claude:', JSON.stringify(ft.transformFields(spec, 'claude'), null, 2));
    console.log('Copilot:', JSON.stringify(ft.transformFields(spec, 'copilot'), null, 2));
    "
    
    Claude output should include model and hooks.
    Copilot output should exclude model and hooks with warnings.
  </verify>
  <done>
    - FIELD_RULES constant defines platform support for all metadata fields
    - transformFields() correctly includes/excludes fields per platform
    - validateFieldSupport() returns warnings for unsupported field usage
    - addPlatformMetadata() embeds generation context
    - All functions handle edge cases (null frontmatter, unknown fields, invalid platforms)
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance context-builder with detailed capability flags</name>
  <files>bin/lib/template-system/context-builder.js</files>
  <action>
    Update context-builder.js (from Phase 1 Plan 02) with more granular capability flags based on PITFALLS.md research:
    
    1. Expand platform capabilities beyond basic flags:
       
       Claude capabilities:
       - supportsModel: true (can use model field for optimization)
       - supportsHooks: true (lifecycle events available)
       - supportsSkills: true (content injection via skills)
       - supportsMCP: true (inherits from global MCP config)
       - supportsDisallowedTools: true (denylist available)
       - supportsWildcards: false (no tools: ['*'] syntax)
       - maxPromptLength: 200000 (character limit)
       - toolCaseSensitive: true (exact case required)
       
       Copilot capabilities:
       - supportsModel: false (model field ignored)
       - supportsHooks: false (no lifecycle events)
       - supportsSkills: false (no skills)
       - supportsMCP: true (org/enterprise via mcp-servers frontmatter)
       - supportsDisallowedTools: false (only allowlist)
       - supportsWildcards: true (tools: ["*"] means all tools)
       - maxPromptLength: 30000 (character limit per PITFALLS.md)
       - toolCaseSensitive: false (case-insensitive tool names)
       
       Codex capabilities (placeholder for future):
       - Keep existing basic flags, add comment: "To be refined based on Codex specifications"
    
    2. Add capability helper functions:
       - supportsField(platform, fieldName) - query if field is supported
       - getFieldWarning(platform, fieldName) - get warning message if unsupported
       - getPlatformLimits(platform) - return { maxPromptLength, maxTools, etc. }
    
    3. Update buildContext() to include new capabilities in returned context object
    
    4. Maintain backward compatibility:
       - Keep existing isClaude, isCopilot, isCodex flags
       - Keep existing paths integration
       - All existing tests from 01-02 should still pass
    
    Do NOT import field-transformer yet (that's for integration in 02-03).
  </action>
  <verify>
    node -e "
    const cb = require('./bin/lib/template-system/context-builder');
    const ctx = cb.buildContext('claude');
    console.log('Supports model:', ctx.supportsModel);
    console.log('Supports hooks:', ctx.supportsHooks);
    console.log('Tool case sensitive:', ctx.toolCaseSensitive);
    console.log('Max prompt length:', ctx.maxPromptLength);
    "
    
    node bin/lib/template-system/context-builder.test.js
    
    All existing tests plus new capability checks should pass.
  </verify>
  <done>
    - Claude context includes all 8 detailed capability flags
    - Copilot context includes all 8 detailed capability flags with correct values
    - Codex retains basic flags with refinement note
    - Helper functions supportsField(), getFieldWarning(), getPlatformLimits() work correctly
    - All Phase 1 tests still pass (backward compatible)
    - Context objects include new capabilities without breaking existing usage
  </done>
</task>

<task type="auto">
  <name>Task 3: Add comprehensive tests for field transformer and enhanced capabilities</name>
  <files>bin/lib/template-system/field-transformer.test.js, bin/lib/template-system/context-builder.test.js</files>
  <action>
    Create field-transformer.test.js and update context-builder.test.js:
    
    field-transformer.test.js (new file):
    
    1. Field transformation tests:
       - transformFields() preserves common fields (tools, description) on both platforms
       - transformFields() includes model field for Claude
       - transformFields() excludes model field for Copilot
       - transformFields() includes hooks/skills for Claude only
       - transformFields() handles mcp-servers appropriately per platform
       - transformFields() converts disallowedTools to warning on Copilot
    
    2. Field validation tests:
       - validateFieldSupport('model', 'claude') returns supported: true
       - validateFieldSupport('model', 'copilot') returns supported: false with warning
       - validateFieldSupport('hooks', 'copilot') suggests using prompt text instead
       - validateFieldSupport('unknown-field', 'claude') returns warning about unknown field
    
    3. Metadata addition tests:
       - addPlatformMetadata() includes platform identifier
       - addPlatformMetadata() includes generation timestamp
       - addPlatformMetadata() preserves existing frontmatter
    
    4. PITFALLS.md scenario tests:
       - Pitfall 3: model field handled correctly (included Claude, excluded Copilot with warning)
       - Pitfall 4: disallowedTools warning generated for Copilot
       - Pitfall 8: MCP config differences handled
       - Pitfall 10: hooks/skills Claude-only with warnings
    
    Target: 15-18 test cases
    
    context-builder.test.js updates (existing file):
    
    5. Add new capability flag tests:
       - Claude context has supportsModel: true
       - Copilot context has supportsModel: false
       - Claude context has supportsHooks: true
       - Copilot context has supportsHooks: false
       - maxPromptLength differs (200k Claude, 30k Copilot)
       - toolCaseSensitive differs (true Claude, false Copilot)
    
    6. Add helper function tests:
       - supportsField('claude', 'model') returns true
       - supportsField('copilot', 'model') returns false
       - getFieldWarning provides helpful messages
       - getPlatformLimits returns structured limit object
    
    Target: Add 8-10 new tests to existing suite
    
    Maintain all existing tests from Phase 1 (should still pass).
  </action>
  <verify>
    node bin/lib/template-system/field-transformer.test.js
    node bin/lib/template-system/context-builder.test.js
    
    All tests should pass:
    - field-transformer: 15-18 new tests ✓
    - context-builder: 9 existing + 8-10 new = 17-19 total tests ✓
  </verify>
  <done>
    - field-transformer.test.js created with 15+ tests passing
    - context-builder.test.js updated with 8+ new tests passing
    - All Phase 1 context-builder tests still pass (backward compatible)
    - PITFALLS.md scenarios verified through tests
    - Field support validation working correctly
    - Platform capability flags tested for Claude and Copilot
  </done>
</task>

</tasks>

<verification>
Run all template system tests to ensure backward compatibility:

```bash
# All unit tests
node bin/lib/template-system/spec-parser.test.js
node bin/lib/template-system/context-builder.test.js
node bin/lib/template-system/engine.test.js
node bin/lib/template-system/field-transformer.test.js

# Integration tests (should still pass)
node bin/lib/template-system/integration.test.js

# Quick capability check
node -e "
const cb = require('./bin/lib/template-system/context-builder');
const ft = require('./bin/lib/template-system/field-transformer');
console.log('Claude capabilities:', cb.buildContext('claude'));
console.log('Field rules:', ft.FIELD_RULES);
"
```

Phase 1 functionality should remain intact while new capabilities are added.
</verification>

<success_criteria>
1. Field transformer correctly handles platform-specific metadata differences
2. Context builder includes detailed capability flags (8+ per platform)
3. Model field conditionally included based on platform (Pitfall 3 solved)
4. Hooks/skills handled as Claude-only (Pitfall 10 solved)
5. MCP configuration differences understood (Pitfall 8 documented)
6. All unit tests passing (15+ field-transformer, 17+ context-builder)
7. Backward compatibility maintained (Phase 1 tests still pass)
8. Platform differences isolated in abstraction layer (ready for integration)
</success_criteria>

<output>
After completion, create `.planning/phases/02-platform-abstraction-layer/02-02-SUMMARY.md` documenting:
- Enhanced platform capability flags
- Field transformation rules
- PITFALLS.md scenarios addressed
- Integration notes for generator pipeline
</output>
