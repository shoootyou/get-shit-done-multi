---
phase: 05-cross-platform-testing-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/test-agent-generation.js
  - scripts/test-agent-installation.js
autonomous: true
must_haves:
  - "Running `node bin/test-agent-generation.js` generates all 11 agents for both Claude and Copilot"
  - "Generation test validates frontmatter compliance (tools arrays, metadata, descriptions)"
  - "Running `node scripts/test-agent-installation.js` simulates installation to temp directories"
  - "Installation test verifies files land in correct platform paths"
  - "Both tests exit 0 on success, exit 1 on failure with descriptive errors"
---

# Objective

Create generation and installation test suites that validate the template→agent pipeline produces correct outputs for both platforms.

## Context

**What Exists:**
- Template system with `generateAgent()` function
- 11 agent specs in `agents/*.md`
- Installation adapters (claude.js, copilot.js) with `installFiles()` methods
- Custom test framework pattern (console-based, no npm dependencies)

**What's Needed:**
- Test suite to generate all agents and validate outputs
- Test suite to simulate installation and verify file placement
- Both tests following existing test conventions (✅/❌ console output)

**Phase Goal:** End-to-end validation through actual installation and invocation.

## Tasks

<task name="create-generation-test" type="auto">
  <files>bin/test-agent-generation.js</files>
  <action>
Create test suite that validates agent generation for all platforms.

**Test Structure:**
```javascript
const { generateAgent } = require('./lib/template-system/generator');
const fs = require('fs');
const path = require('path');
const os = require('os');

async function runTests() {
  let passed = 0;
  let failed = 0;
  
  console.log('=== Agent Generation Tests ===\n');
  
  const agents = [
    'gsd-executor', 'gsd-planner', 'gsd-verifier',
    'gsd-codebase-mapper', 'gsd-debugger', 'gsd-roadmapper',
    'gsd-phase-researcher', 'gsd-plan-checker', 'gsd-integration-checker',
    'gsd-project-researcher', 'gsd-research-synthesizer'
  ];
  
  const testDir = path.join(os.tmpdir(), 'agent-generation-test-' + Date.now());
  fs.mkdirSync(testDir, { recursive: true });
  
  try {
    for (const platform of ['claude', 'copilot']) {
      console.log(`\nPlatform: ${platform}\n`);
      
      for (const agentName of agents) {
        const specPath = path.join('agents', `${agentName}.md`);
        const outputPath = path.join(testDir, platform, `${agentName}.md`);
        
        try {
          // Generate agent
          const result = await generateAgent(specPath, platform, outputPath);
          
          // Validate result
          if (!result || !result.success) {
            console.log(`❌ ${agentName}: Generation failed`);
            failed++;
            continue;
          }
          
          // Validate file exists
          if (!fs.existsSync(outputPath)) {
            console.log(`❌ ${agentName}: Output file not created`);
            failed++;
            continue;
          }
          
          // Validate content structure
          const content = fs.readFileSync(outputPath, 'utf8');
          const hasFrontmatter = content.startsWith('---');
          const hasTools = content.includes('tools:');
          const hasDescription = content.includes('description:');
          
          if (!hasFrontmatter || !hasTools || !hasDescription) {
            console.log(`❌ ${agentName}: Invalid frontmatter structure`);
            failed++;
            continue;
          }
          
          // Platform-specific validation
          if (platform === 'copilot') {
            const hasMetadata = content.includes('metadata:');
            if (!hasMetadata) {
              console.log(`❌ ${agentName}: Missing metadata field (Copilot requires metadata)`);
              failed++;
              continue;
            }
          }
          
          console.log(`✅ ${agentName}: Generated successfully`);
          passed++;
          
        } catch (err) {
          console.log(`❌ ${agentName}: ${err.message}`);
          failed++;
        }
      }
    }
    
    console.log('\n' + '='.repeat(60));
    console.log(`Total agents tested: ${agents.length * 2} (11 agents × 2 platforms)`);
    console.log(`✅ Passed: ${passed}`);
    console.log(`❌ Failed: ${failed}`);
    console.log('='.repeat(60));
    
    // Cleanup
    fs.rmSync(testDir, { recursive: true, force: true });
    
    process.exit(failed > 0 ? 1 : 0);
    
  } catch (err) {
    console.error('Test suite error:', err);
    process.exit(1);
  }
}

if (require.main === module) {
  runTests().catch(err => {
    console.error('Fatal error:', err);
    process.exit(1);
  });
}

module.exports = { runTests };
```

**Test Coverage:**
- All 11 agent specs
- Both platforms (Claude and Copilot)
- Frontmatter validation (structure, required fields)
- Platform-specific features (metadata on Copilot)
- Tool mapping verification (tools array formatted correctly)

**Exit Codes:**
- 0 if all tests pass
- 1 if any test fails
  </action>
  <verify>
```bash
node bin/test-agent-generation.js
# Should show: 22 tests passed (11 agents × 2 platforms)
# Exit code: 0
```
  </verify>
  <done>
Generation test exists, validates all 11 agents on both platforms, follows test conventions, exits with correct codes.
  </done>
</task>

<task name="create-installation-test" type="auto">
  <files>scripts/test-agent-installation.js</files>
  <action>
Create test suite that validates installation to correct platform directories.

**Test Structure:**
```javascript
const { generateAgent } = require('./lib/template-system/generator');
const claudeAdapter = require('./lib/adapters/claude');
const copilotAdapter = require('./lib/adapters/copilot');
const fs = require('fs');
const path = require('path');
const os = require('os');

async function runTests() {
  let passed = 0;
  let failed = 0;
  
  console.log('=== Agent Installation Tests ===\n');
  
  const testDir = path.join(os.tmpdir(), 'agent-installation-test-' + Date.now());
  fs.mkdirSync(testDir, { recursive: true });
  
  try {
    // Test 1: Claude local installation
    console.log('Test 1: Claude local installation\n');
    
    const claudeLocalDir = path.join(testDir, 'claude-local');
    const claudeDirs = {
      agents: path.join(claudeLocalDir, '.claude', 'agents'),
      commands: path.join(claudeLocalDir, '.claude', 'commands', 'gsd'),
      getShitDone: path.join(claudeLocalDir, '.claude', 'get-shit-done')
    };
    
    // Create directories
    for (const dir of Object.values(claudeDirs)) {
      fs.mkdirSync(dir, { recursive: true });
    }
    
    // Generate test agent
    const testAgentPath = path.join(testDir, 'test-agent-claude.md');
    await generateAgent('agents/gsd-executor.md', 'claude', testAgentPath);
    
    // Simulate installation
    try {
      const files = [{
        source: testAgentPath,
        target: path.join(claudeDirs.agents, 'gsd-executor.md')
      }];
      
      for (const file of files) {
        fs.copyFileSync(file.source, file.target);
      }
      
      // Verify installation
      const installed = fs.existsSync(path.join(claudeDirs.agents, 'gsd-executor.md'));
      if (installed) {
        console.log('✅ Claude: Agent installed to .claude/agents/');
        passed++;
      } else {
        console.log('❌ Claude: Agent not found in expected location');
        failed++;
      }
    } catch (err) {
      console.log(`❌ Claude: Installation failed: ${err.message}`);
      failed++;
    }
    
    // Test 2: Copilot installation
    console.log('\nTest 2: Copilot installation\n');
    
    const copilotLocalDir = path.join(testDir, 'copilot-local');
    const copilotDirs = {
      agents: path.join(copilotLocalDir, '.github', 'copilot', 'agents')
    };
    
    // Create directories
    for (const dir of Object.values(copilotDirs)) {
      fs.mkdirSync(dir, { recursive: true });
    }
    
    // Generate test agent
    const testAgentCopilotPath = path.join(testDir, 'test-agent-copilot.md');
    await generateAgent('agents/gsd-executor.md', 'copilot', testAgentCopilotPath);
    
    // Simulate installation
    try {
      const files = [{
        source: testAgentCopilotPath,
        target: path.join(copilotDirs.agents, 'gsd-executor.md')
      }];
      
      for (const file of files) {
        fs.copyFileSync(file.source, file.target);
      }
      
      // Verify installation
      const installed = fs.existsSync(path.join(copilotDirs.agents, 'gsd-executor.md'));
      if (installed) {
        console.log('✅ Copilot: Agent installed to .github/copilot/agents/');
        passed++;
      } else {
        console.log('❌ Copilot: Agent not found in expected location');
        failed++;
      }
    } catch (err) {
      console.log(`❌ Copilot: Installation failed: ${err.message}`);
      failed++;
    }
    
    // Test 3: Validate installed content
    console.log('\nTest 3: Validate installed content\n');
    
    const claudeContent = fs.readFileSync(path.join(claudeDirs.agents, 'gsd-executor.md'), 'utf8');
    const copilotContent = fs.readFileSync(path.join(copilotDirs.agents, 'gsd-executor.md'), 'utf8');
    
    // Claude: tools should be comma-separated string
    const claudeToolsMatch = claudeContent.match(/tools:\s*(.+)/);
    if (claudeToolsMatch && !claudeToolsMatch[1].includes('[')) {
      console.log('✅ Claude: Tools formatted as string (not array)');
      passed++;
    } else {
      console.log('❌ Claude: Tools should be comma-separated string');
      failed++;
    }
    
    // Copilot: tools should be array
    const copilotToolsMatch = copilotContent.match(/tools:\s*\[(.+)\]/);
    if (copilotToolsMatch) {
      console.log('✅ Copilot: Tools formatted as array');
      passed++;
    } else {
      console.log('❌ Copilot: Tools should be array format');
      failed++;
    }
    
    // Copilot: should have metadata
    if (copilotContent.includes('metadata:')) {
      console.log('✅ Copilot: Metadata field present');
      passed++;
    } else {
      console.log('❌ Copilot: Missing metadata field');
      failed++;
    }
    
    console.log('\n' + '='.repeat(60));
    console.log(`✅ Passed: ${passed}`);
    console.log(`❌ Failed: ${failed}`);
    console.log('='.repeat(60));
    
    // Cleanup
    fs.rmSync(testDir, { recursive: true, force: true });
    
    process.exit(failed > 0 ? 1 : 0);
    
  } catch (err) {
    console.error('Test suite error:', err);
    process.exit(1);
  }
}

if (require.main === module) {
  runTests().catch(err => {
    console.error('Fatal error:', err);
    process.exit(1);
  });
}

module.exports = { runTests };
```

**Test Coverage:**
- Claude local installation (`.claude/agents/`)
- Copilot installation (`.github/copilot/agents/`)
- Platform-specific formatting (string vs array tools)
- Metadata presence validation (Copilot only)
- File system operations

**Exit Codes:**
- 0 if all tests pass
- 1 if any test fails
  </action>
  <verify>
```bash
node scripts/test-agent-installation.js
# Should show: 5 tests passed
# Exit code: 0
```
  </verify>
  <done>
Installation test exists, simulates installation to both platforms, validates formatting, follows test conventions.
  </done>
</task>

## Verification

**Success Criteria:**
- [ ] `bin/test-agent-generation.js` exists and runs
- [ ] Generation test validates all 11 agents × 2 platforms = 22 tests
- [ ] `scripts/test-agent-installation.js` exists and runs
- [ ] Installation test validates platform-specific paths and formatting
- [ ] Both tests use custom framework pattern (console output, exit codes)
- [ ] Both tests clean up temp files after execution
- [ ] Running both tests shows clear ✅/❌ output with summaries

**Commands:**
```bash
# Run generation tests
node bin/test-agent-generation.js

# Run installation tests
node scripts/test-agent-installation.js

# Both should exit 0
echo $?
```

## Success Criteria

Phase 5 Plan 1 complete when:
- Generation test validates all agents generate correctly for both platforms
- Installation test validates files land in correct platform directories
- Platform-specific formatting verified (tools string vs array, metadata presence)
- Tests follow established conventions (console output, exit codes, cleanup)
- All tests pass locally

## Output

Files created:
- `bin/test-agent-generation.js` - Validates template→agent generation
- `scripts/test-agent-installation.js` - Validates installation paths and formatting
