---
phase: 05-message-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - bin/lib/output/reporter.js (create)
  - bin/lib/output/formatter.js (create)
  - bin/lib/output/symbols.js (create)
  - bin/lib/output/reporter.test.js (create)
autonomous: true
must_haves:
  observable_truths:
    - "npm install succeeds with boxen@^8.0.1"
    - "Reporter class methods accept context and produce formatted output"
    - "Warning boxes display with Unicode borders"
    - "Multi-platform summary shows succeeded and failed platforms"
    - "Tests verify Reporter produces expected output format"
  required_artifacts:
    - package.json with boxen@^8.0.1 dependency
    - bin/lib/output/reporter.js implementing Reporter class
    - bin/lib/output/symbols.js exporting standardized Unicode constants
    - bin/lib/output/formatter.js with indentation utilities
    - bin/lib/output/reporter.test.js with comprehensive test coverage
  required_wiring:
    - Reporter class exports working constructor and message methods
    - Formatter exports indent/outdent utilities
    - Symbols exports SUCCESS, ERROR, WARNING, PROGRESS constants
  key_links:
    - Reporter.platformStart() sets indentation context
    - Reporter.warning() uses boxen for box-drawing
    - Reporter.summary() formats multi-platform results
---

# Phase 5, Plan 1: Reporter Infrastructure

**Objective**: Build centralized message management infrastructure with boxen for context-aware output

**Context**: Phase 4 completed path resolution and conflict detection. Current install.js has scattered console.log calls throughout. Research identified boxen as the standard library for terminal box-drawing (8.0.1, 1M+ weekly downloads). Reporter pattern is established in npm, yarn, cargo for managing CLI output.

## Tasks

<task name="install-boxen" type="auto">
  <files>package.json</files>
  <action>
Install boxen library for terminal box-drawing:

```bash
npm install boxen@^8.0.1
```

Verify installation:
```bash
node -e "const boxen = require('boxen'); console.log(boxen('Test', {borderStyle: 'single'}))"
```

Expected: Box-drawing characters display correctly.
  </action>
  <verify>
```bash
# Check package.json has boxen
grep '"boxen"' package.json

# Verify importable
node -e "const boxen = require('boxen'); console.log('boxen loaded')"
```
  </verify>
  <done>boxen@^8.0.1 installed in package.json and importable</done>
</task>

<task name="create-symbols-module" type="auto">
  <files>bin/lib/output/symbols.js</files>
  <action>
Create bin/lib/output/ directory and symbols.js:

```javascript
// bin/lib/output/symbols.js
/**
 * Standardized Unicode symbols for CLI output
 * As per MSG-03 requirement
 */

module.exports = {
  SUCCESS: '✓',
  ERROR: '✗',
  WARNING: '⚠️',
  PROGRESS: '⠿',
  
  // Aliases for convenience
  CHECK: '✓',
  CROSS: '✗',
  WARN: '⚠️'
};
```

No tests needed - simple constant exports.
  </action>
  <verify>
```bash
# Verify file exists and exports symbols
node -e "const s = require('./bin/lib/output/symbols'); console.log(s.SUCCESS, s.ERROR, s.WARNING, s.PROGRESS)"
```

Expected output: `✓ ✗ ⚠️ ⠿`
  </verify>
  <done>symbols.js created with SUCCESS, ERROR, WARNING, PROGRESS constants</done>
</task>

<task name="create-formatter-utilities" type="auto">
  <files>bin/lib/output/formatter.js</files>
  <action>
Create formatter.js with indentation utilities:

```javascript
// bin/lib/output/formatter.js
/**
 * Text formatting utilities for CLI output
 */

/**
 * Create indented string
 * @param {string} text - Text to indent
 * @param {number} level - Indentation level (each level = 2 spaces)
 * @returns {string} Indented text
 */
function indent(text, level = 1) {
  const spaces = '  '.repeat(level);
  return text.split('\n').map(line => spaces + line).join('\n');
}

/**
 * Wrap text in box with padding
 * @param {string} text - Text to wrap
 * @param {object} options - boxen options
 * @returns {string} Boxed text
 */
function box(text, options = {}) {
  const boxen = require('boxen');
  return boxen(text, {
    padding: 1,
    borderStyle: 'single',
    ...options
  });
}

module.exports = {
  indent,
  box
};
```
  </action>
  <verify>
```bash
# Test indent function
node -e "const f = require('./bin/lib/output/formatter'); console.log(f.indent('test', 2))"

# Test box function
node -e "const f = require('./bin/lib/output/formatter'); console.log(f.box('test'))"
```
  </verify>
  <done>formatter.js created with indent() and box() utilities</done>
</task>

<task name="create-reporter-class" type="auto">
  <files>bin/lib/output/reporter.js</files>
  <action>
Create Reporter class following research pattern:

```javascript
// bin/lib/output/reporter.js
const boxen = require('boxen');
const prompts = require('prompts');
const symbols = require('./symbols');
const { indent } = require('./formatter');
const { cyan, green, yellow, dim, reset } = require('../colors');

/**
 * Centralized message manager for CLI output
 * Follows Reporter pattern from npm/yarn/cargo
 */
class Reporter {
  constructor(options = {}) {
    this.indentLevel = 0;
    this.write = options.write || ((msg) => process.stdout.write(msg));
    this.silent = options.silent || false;
    this.context = {
      platform: null,
      scope: null,
      os: null,
      multiPlatform: false
    };
  }

  /**
   * Set context for conditional messaging
   */
  setContext(context) {
    this.context = { ...this.context, ...context };
  }

  /**
   * Start platform installation
   */
  platformStart(platform, scope) {
    this.setContext({ platform, scope });
    this._write(`  ${cyan}Installing ${platform} (${scope})...${reset}\n`);
    this.indentLevel++;
  }

  /**
   * Platform installation success
   */
  platformSuccess(platform, details) {
    const msg = `${green}${symbols.SUCCESS}${reset} Installed to ${cyan}${details.path}${reset}`;
    const counts = [];
    if (details.commands) counts.push(`${details.commands} commands`);
    if (details.agents) counts.push(`${details.agents} agents`);
    if (details.skills) counts.push(`${details.skills} skills`);
    
    const fullMsg = counts.length > 0 
      ? `${msg} (${counts.join(', ')})\n`
      : `${msg}\n`;
    
    this._writeIndented(fullMsg);
    this.indentLevel--;
  }

  /**
   * Platform installation error
   */
  platformError(platform, error) {
    this._writeIndented(`${yellow}${symbols.ERROR}${reset} Error: ${error.message}\n`);
    this.indentLevel--;
  }

  /**
   * Display warning box with optional confirmation
   */
  async warning(message, options = {}) {
    const box = boxen(`${symbols.WARNING}  WARNING\n${message}`, {
      padding: 1,
      borderStyle: 'single',
      borderColor: 'yellow'
    });
    this._write('\n' + box + '\n');

    if (options.confirm) {
      const response = await prompts({
        type: 'confirm',
        name: 'continue',
        message: 'Continue?',
        initial: false
      }, {
        onCancel: () => {
          this._write('\nInstallation cancelled\n');
          process.exit(1);
        }
      });
      return response.continue;
    }
    return true;
  }

  /**
   * Multi-platform installation summary
   */
  summary(results) {
    const succeeded = results.filter(r => r.success);
    const failed = results.filter(r => !r.success);
    
    this._write('\n');
    
    if (succeeded.length > 0) {
      const names = succeeded.map(r => r.platform).join(', ');
      this._write(`  ${green}${symbols.SUCCESS} ${names} installed${reset}\n`);
    }
    
    if (failed.length > 0) {
      this._write(`  ${yellow}${symbols.ERROR} Errors:${reset}\n`);
      failed.forEach(r => {
        this._write(`    ${r.platform}: ${r.error.message}\n`);
      });
    }
  }

  /**
   * Generic success message
   */
  success(message) {
    this._write(`  ${green}${symbols.SUCCESS}${reset} ${message}\n`);
  }

  /**
   * Generic error message
   */
  error(message) {
    this._write(`  ${yellow}${symbols.ERROR}${reset} ${message}\n`);
  }

  /**
   * Generic info message
   */
  info(message) {
    this._write(`  ${dim}${message}${reset}\n`);
  }

  /**
   * Write with current indentation
   */
  _writeIndented(message) {
    const indentStr = '  '.repeat(this.indentLevel);
    this._write(indentStr + message);
  }

  /**
   * Write to output (respects silent mode)
   */
  _write(message) {
    if (!this.silent) {
      this.write(message);
    }
  }
}

module.exports = Reporter;
```

Implementation notes:
- Constructor accepts write function for testing (injected dependency)
- Context tracking for conditional messages (phase, platform, scope, OS)
- Indentation management for grouped output
- boxen integration for warning boxes
- prompts integration for confirmations
- Color support using existing colors module
  </action>
  <verify>
```bash
# Test Reporter instantiation
node -e "const Reporter = require('./bin/lib/output/reporter'); const r = new Reporter(); console.log('Reporter loaded')"

# Test basic methods exist
node -e "const Reporter = require('./bin/lib/output/reporter'); const r = new Reporter({silent: true}); r.platformStart('claude', 'global'); r.platformSuccess('claude', {path: '~/.claude/', commands: 5}); console.log('Methods work')"
```
  </verify>
  <done>Reporter class created with platformStart, platformSuccess, platformError, warning, summary methods</done>
</task>

<task name="test-reporter" type="auto">
  <files>bin/lib/output/reporter.test.js</files>
  <action>
Create comprehensive test suite for Reporter:

```javascript
// bin/lib/output/reporter.test.js
const Reporter = require('./reporter');

describe('Reporter', () => {
  let output;
  let reporter;

  beforeEach(() => {
    output = [];
    reporter = new Reporter({
      write: (msg) => output.push(msg),
      silent: false
    });
  });

  describe('constructor', () => {
    test('creates reporter with default options', () => {
      const r = new Reporter();
      expect(r.indentLevel).toBe(0);
      expect(r.silent).toBe(false);
    });

    test('accepts custom write function', () => {
      const customOutput = [];
      const r = new Reporter({
        write: (msg) => customOutput.push(msg)
      });
      r.success('test');
      expect(customOutput.length).toBeGreaterThan(0);
    });

    test('respects silent mode', () => {
      const r = new Reporter({ silent: true, write: (msg) => output.push(msg) });
      r.success('test');
      expect(output.length).toBe(0);
    });
  });

  describe('platformStart', () => {
    test('outputs platform name and scope', () => {
      reporter.platformStart('claude', 'global');
      const text = output.join('');
      expect(text).toContain('Installing claude (global)');
    });

    test('increments indent level', () => {
      reporter.platformStart('claude', 'global');
      expect(reporter.indentLevel).toBe(1);
    });

    test('sets context', () => {
      reporter.platformStart('claude', 'global');
      expect(reporter.context.platform).toBe('claude');
      expect(reporter.context.scope).toBe('global');
    });
  });

  describe('platformSuccess', () => {
    test('outputs success with path', () => {
      reporter.platformStart('claude', 'global');
      reporter.platformSuccess('claude', { path: '~/.claude/' });
      const text = output.join('');
      expect(text).toContain('✓');
      expect(text).toContain('~/.claude/');
    });

    test('includes counts when provided', () => {
      reporter.platformStart('claude', 'global');
      reporter.platformSuccess('claude', {
        path: '~/.claude/',
        commands: 5,
        agents: 13,
        skills: 2
      });
      const text = output.join('');
      expect(text).toContain('5 commands');
      expect(text).toContain('13 agents');
      expect(text).toContain('2 skills');
    });

    test('decrements indent level', () => {
      reporter.platformStart('claude', 'global');
      reporter.platformSuccess('claude', { path: '~/.claude/' });
      expect(reporter.indentLevel).toBe(0);
    });

    test('indents output under platform', () => {
      reporter.platformStart('claude', 'global');
      output = []; // Clear start message
      reporter.platformSuccess('claude', { path: '~/.claude/' });
      const text = output.join('');
      expect(text).toMatch(/^  /); // Starts with 2 spaces
    });
  });

  describe('platformError', () => {
    test('outputs error message', () => {
      reporter.platformStart('claude', 'global');
      reporter.platformError('claude', new Error('Permission denied'));
      const text = output.join('');
      expect(text).toContain('✗');
      expect(text).toContain('Permission denied');
    });

    test('decrements indent level', () => {
      reporter.platformStart('claude', 'global');
      reporter.platformError('claude', new Error('test'));
      expect(reporter.indentLevel).toBe(0);
    });
  });

  describe('warning', () => {
    test('displays boxed warning', async () => {
      await reporter.warning('Test warning', { confirm: false });
      const text = output.join('');
      expect(text).toContain('WARNING');
      expect(text).toContain('Test warning');
      expect(text).toContain('─'); // Box border
    });

    test('returns true when no confirmation needed', async () => {
      const result = await reporter.warning('Test', { confirm: false });
      expect(result).toBe(true);
    });
  });

  describe('summary', () => {
    test('shows succeeded platforms', () => {
      const results = [
        { platform: 'claude', success: true },
        { platform: 'copilot', success: true }
      ];
      reporter.summary(results);
      const text = output.join('');
      expect(text).toContain('✓');
      expect(text).toContain('claude, copilot');
    });

    test('shows failed platforms with errors', () => {
      const results = [
        { platform: 'claude', success: true },
        { platform: 'copilot', success: false, error: new Error('Failed') }
      ];
      reporter.summary(results);
      const text = output.join('');
      expect(text).toContain('claude installed');
      expect(text).toContain('✗ Errors:');
      expect(text).toContain('copilot: Failed');
    });

    test('handles all successes', () => {
      const results = [
        { platform: 'claude', success: true },
        { platform: 'copilot', success: true },
        { platform: 'codex', success: true }
      ];
      reporter.summary(results);
      const text = output.join('');
      expect(text).toContain('claude, copilot, codex installed');
      expect(text).not.toContain('Errors');
    });

    test('handles all failures', () => {
      const results = [
        { platform: 'claude', success: false, error: new Error('E1') },
        { platform: 'copilot', success: false, error: new Error('E2') }
      ];
      reporter.summary(results);
      const text = output.join('');
      expect(text).not.toContain('installed');
      expect(text).toContain('Errors:');
      expect(text).toContain('claude: E1');
      expect(text).toContain('copilot: E2');
    });
  });

  describe('success', () => {
    test('outputs success message', () => {
      reporter.success('Operation complete');
      const text = output.join('');
      expect(text).toContain('✓');
      expect(text).toContain('Operation complete');
    });
  });

  describe('error', () => {
    test('outputs error message', () => {
      reporter.error('Something went wrong');
      const text = output.join('');
      expect(text).toContain('✗');
      expect(text).toContain('Something went wrong');
    });
  });

  describe('info', () => {
    test('outputs info message', () => {
      reporter.info('Additional context');
      const text = output.join('');
      expect(text).toContain('Additional context');
    });
  });
});
```

Run tests:
```bash
npm test -- bin/lib/output/reporter.test.js
```
  </action>
  <verify>
```bash
# Run test suite
npm test -- bin/lib/output/reporter.test.js

# Check coverage
npm test -- bin/lib/output/reporter.test.js --coverage --collectCoverageFrom=bin/lib/output/reporter.js
```

Expected: All tests pass, >80% coverage
  </verify>
  <done>Reporter test suite created with 20+ tests covering all methods and edge cases</done>
</task>

## Verification

After all tasks complete:

```bash
# Verify boxen installed
grep boxen package.json

# Verify output directory structure
ls -la bin/lib/output/

# Run all tests
npm test -- bin/lib/output/

# Test Reporter in isolation
node -e "
const Reporter = require('./bin/lib/output/reporter');
const r = new Reporter();
r.platformStart('claude', 'global');
r.platformSuccess('claude', {path: '~/.claude/', commands: 5, agents: 13, skills: 2});
const results = [{platform: 'claude', success: true}];
r.summary(results);
"
```

Expected:
- boxen@^8.0.1 in package.json
- bin/lib/output/ contains reporter.js, formatter.js, symbols.js, reporter.test.js
- All tests pass with >80% coverage
- Reporter produces formatted output with Unicode symbols and indentation

## Success Criteria

- [x] boxen@^8.0.1 installed and importable
- [x] Reporter class created with platformStart, platformSuccess, platformError, warning, summary methods
- [x] Symbols module exports SUCCESS, ERROR, WARNING, PROGRESS constants
- [x] Formatter module exports indent and box utilities
- [x] Reporter test suite with 20+ tests and >80% coverage
- [x] Reporter uses boxen for warning boxes
- [x] Reporter manages indentation for grouped output
- [x] Reporter supports injected write function for testing

## Output

Phase 5, Plan 1 deliverables:
- **Reporter infrastructure**: Centralized message management module
- **boxen integration**: Box-drawing for warning displays
- **Standardized symbols**: Unicode constants (✓ ✗ ⚠️ ⠿)
- **Test coverage**: Comprehensive test suite for Reporter
- **Foundation**: Ready for install.js integration in Plan 2
