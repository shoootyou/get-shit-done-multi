---
phase: 02-core-installer-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - bin/lib/io/file-operations.js
  - bin/lib/paths/path-resolver.js
  - bin/lib/rendering/template-renderer.js
  - bin/lib/cli/progress.js
  - bin/lib/cli/logger.js
autonomous: true
must_haves:
  - file-ops: File operations module can copy directories recursively with fs-extra
  - path-security: Path resolver validates and normalizes paths, rejects traversal attempts
  - template-rendering: Template renderer replaces {{VARIABLES}} in file content
  - progress-bars: Progress utilities create multi-bar displays for phases
  - logging: Logger formats messages with colors and structure
---

# Phase 02 Plan 02: Core Modules

## Objective

Create the five core modules that handle installation mechanics: file operations (recursive copy with fs-extra), path resolution (validation and normalization), template rendering (variable replacement), progress display (cli-progress integration), and logging (chalk-based formatting). These modules are the building blocks for the orchestration layer in Plan 03.

## Context

**From Plan 01:** bin structure exists, cli-progress installed, error types defined

**Architecture pattern:** Separation of concerns — each module has single responsibility, exports clean interface

**Tech decisions from Research:**
- fs-extra for file operations (recursive copy, ensure directories)
- Built-in path module for normalization
- Simple string replacement for template variables (not full templating engine)
- cli-progress for multi-bar progress displays
- chalk for colored output

**Phase 2 scope:** Claude only, so template variables are `{{PLATFORM_ROOT}}` → `.claude/`, `{{COMMAND_PREFIX}}` → `/gsd-`

## Tasks

<task name="create-file-operations-module" type="auto">
  <files>bin/lib/io/file-operations.js</files>
  <action>
    Create file operations wrapper using fs-extra:
    
    ```javascript
    // bin/lib/io/file-operations.js
    
    import fs from 'fs-extra';
    import { join, dirname } from 'path';
    import { homedir } from 'os';
    import { permissionDenied, insufficientSpace } from '../errors/install-error.js';
    
    /**
     * Copy directory recursively with permission preservation
     * @param {string} src - Source directory
     * @param {string} dest - Destination directory
     * @param {Object} options - Copy options
     * @returns {Promise<void>}
     */
    export async function copyDirectory(src, dest, options = {}) {
      try {
        await fs.copy(src, dest, {
          overwrite: options.overwrite ?? true,
          errorOnExist: false,
          preserveTimestamps: true,
          ...options
        });
      } catch (error) {
        if (error.code === 'EACCES' || error.code === 'EPERM') {
          throw permissionDenied(`Permission denied: ${dest}`, { path: dest, error });
        }
        if (error.code === 'ENOSPC') {
          throw insufficientSpace(`Insufficient disk space: ${dest}`, { path: dest, error });
        }
        throw error;
      }
    }
    
    /**
     * Ensure directory exists (create if missing)
     * @param {string} dir - Directory path
     * @returns {Promise<void>}
     */
    export async function ensureDirectory(dir) {
      try {
        await fs.ensureDir(dir);
      } catch (error) {
        if (error.code === 'EACCES' || error.code === 'EPERM') {
          throw permissionDenied(`Permission denied: ${dir}`, { path: dir, error });
        }
        throw error;
      }
    }
    
    /**
     * Write file with directory creation
     * @param {string} filePath - File path
     * @param {string} content - File content
     * @returns {Promise<void>}
     */
    export async function writeFile(filePath, content) {
      try {
        await fs.ensureDir(dirname(filePath));
        await fs.writeFile(filePath, content, 'utf8');
      } catch (error) {
        if (error.code === 'EACCES' || error.code === 'EPERM') {
          throw permissionDenied(`Permission denied: ${filePath}`, { path: filePath, error });
        }
        throw error;
      }
    }
    
    /**
     * Read file content
     * @param {string} filePath - File path
     * @returns {Promise<string>}
     */
    export async function readFile(filePath) {
      return fs.readFile(filePath, 'utf8');
    }
    
    /**
     * Check if path exists
     * @param {string} path - Path to check
     * @returns {Promise<boolean>}
     */
    export async function pathExists(path) {
      return fs.pathExists(path);
    }
    
    /**
     * Get available disk space in bytes
     * @param {string} path - Path to check
     * @returns {Promise<number>}
     */
    export async function getAvailableSpace(path) {
      // Simplified check - use fs.stat for basic validation
      // Full disk space checking can be added with child_process (df/PowerShell)
      try {
        await fs.access(path);
        return Infinity; // Assume sufficient space for now
      } catch {
        return 0;
      }
    }
    
    /**
     * Resolve home directory
     * @returns {string}
     */
    export function getHomeDirectory() {
      return homedir();
    }
    ```
    
    Test file operations:
    ```bash
    # Create test in /tmp
    node -e "
    import('./bin/lib/io/file-operations.js').then(async m => {
      await m.ensureDirectory('/tmp/gsd-test');
      await m.writeFile('/tmp/gsd-test/test.txt', 'hello');
      const content = await m.readFile('/tmp/gsd-test/test.txt');
      console.log('✓ File ops work:', content);
    });
    "
    ```
  </action>
  <verify>
    ```bash
    test -f bin/lib/io/file-operations.js && echo "✓ File ops module exists"
    grep -q "export async function copyDirectory" bin/lib/io/file-operations.js && echo "✓ copyDirectory defined"
    grep -q "export async function ensureDirectory" bin/lib/io/file-operations.js && echo "✓ ensureDirectory defined"
    grep -q "export async function writeFile" bin/lib/io/file-operations.js && echo "✓ writeFile defined"
    
    # Test import
    node -e "import('./bin/lib/io/file-operations.js').then(() => console.log('✓ Module loads'))" 2>&1 | grep -q "Module loads"
    ```
  </verify>
  <done>bin/lib/io/file-operations.js with copyDirectory, ensureDirectory, writeFile, readFile, pathExists functions using fs-extra</done>
</task>

<task name="create-path-resolver-module" type="auto">
  <files>bin/lib/paths/path-resolver.js</files>
  <action>
    Create path validation and resolution module:
    
    ```javascript
    // bin/lib/paths/path-resolver.js
    
    import { join, resolve, normalize, isAbsolute } from 'path';
    import { homedir } from 'os';
    import { invalidArgs } from '../errors/install-error.js';
    
    /**
     * Resolve installation target directory
     * @param {boolean} isGlobal - Global vs local installation
     * @param {string} platform - Platform name (e.g., 'claude')
     * @returns {string} Resolved path
     */
    export function resolveTargetDirectory(isGlobal, platform = 'claude') {
      if (isGlobal) {
        return join(homedir(), `.${platform}`);
      } else {
        return join(process.cwd(), `.${platform}`);
      }
    }
    
    /**
     * Validate path for security (prevent traversal)
     * @param {string} targetPath - Path to validate
     * @param {string} basePath - Base path that target must be under
     * @throws {InstallError} If path is invalid or outside base
     */
    export function validatePath(targetPath, basePath) {
      const normalizedTarget = normalize(resolve(targetPath));
      const normalizedBase = normalize(resolve(basePath));
      
      // Check for path traversal
      if (!normalizedTarget.startsWith(normalizedBase)) {
        throw invalidArgs(
          `Invalid path: ${targetPath} is outside target directory`,
          { target: normalizedTarget, base: normalizedBase }
        );
      }
      
      // Check for suspicious patterns
      if (targetPath.includes('..')) {
        throw invalidArgs(
          `Invalid path: contains traversal pattern (..)`,
          { path: targetPath }
        );
      }
    }
    
    /**
     * Normalize path for cross-platform compatibility
     * @param {string} path - Path to normalize
     * @returns {string} Normalized path
     */
    export function normalizePath(path) {
      return normalize(path);
    }
    
    /**
     * Join paths safely
     * @param {...string} paths - Paths to join
     * @returns {string} Joined path
     */
    export function joinPaths(...paths) {
      return join(...paths);
    }
    
    /**
     * Get templates directory path
     * @param {string} scriptDir - Script directory (__dirname)
     * @returns {string} Templates directory path
     */
    export function getTemplatesDirectory(scriptDir) {
      // From bin/install.js, templates/ is ../templates/
      return join(scriptDir, '..', 'templates');
    }
    ```
    
    Test path resolver:
    ```bash
    node -e "
    import('./bin/lib/paths/path-resolver.js').then(m => {
      const target = m.resolveTargetDirectory(false, 'claude');
      console.log('✓ Target resolved:', target);
      
      try {
        m.validatePath('/tmp/test/../etc/passwd', '/tmp/test');
        console.log('✗ Should have thrown');
      } catch (e) {
        console.log('✓ Path validation works');
      }
    });
    "
    ```
  </action>
  <verify>
    ```bash
    test -f bin/lib/paths/path-resolver.js && echo "✓ Path resolver exists"
    grep -q "export function resolveTargetDirectory" bin/lib/paths/path-resolver.js && echo "✓ resolveTargetDirectory defined"
    grep -q "export function validatePath" bin/lib/paths/path-resolver.js && echo "✓ validatePath defined"
    
    # Test import
    node -e "import('./bin/lib/paths/path-resolver.js').then(() => console.log('✓ Module loads'))" 2>&1 | grep -q "Module loads"
    ```
  </verify>
  <done>bin/lib/paths/path-resolver.js with resolveTargetDirectory, validatePath, normalizePath, getTemplatesDirectory functions</done>
</task>

<task name="create-template-renderer-module" type="auto">
  <files>bin/lib/rendering/template-renderer.js</files>
  <action>
    Create template variable replacement module:
    
    ```javascript
    // bin/lib/rendering/template-renderer.js
    
    /**
     * Template variable replacement
     * Replaces {{VARIABLE}} patterns in file content
     */
    
    /**
     * Render template by replacing variables
     * @param {string} content - Template content
     * @param {Object} variables - Variable values
     * @returns {string} Rendered content
     */
    export function renderTemplate(content, variables) {
      let rendered = content;
      
      for (const [key, value] of Object.entries(variables)) {
        const pattern = new RegExp(`\\{\\{${key}\\}\\}`, 'g');
        rendered = rendered.replace(pattern, value);
      }
      
      return rendered;
    }
    
    /**
     * Get platform-specific variables for Claude
     * @param {boolean} isGlobal - Global vs local installation
     * @returns {Object} Variable mappings
     */
    export function getClaudeVariables(isGlobal) {
      return {
        PLATFORM_ROOT: isGlobal ? '~/.claude' : '.claude',
        COMMAND_PREFIX: '/gsd-',
        VERSION: '2.0.0',
        PLATFORM_NAME: 'claude'
      };
    }
    
    /**
     * Find unknown variables in template
     * @param {string} content - Template content
     * @returns {string[]} Array of unknown variable names
     */
    export function findUnknownVariables(content, knownVariables) {
      const pattern = /\{\{(\w+)\}\}/g;
      const found = new Set();
      let match;
      
      while ((match = pattern.exec(content)) !== null) {
        const varName = match[1];
        if (!knownVariables.hasOwnProperty(varName)) {
          found.add(varName);
        }
      }
      
      return Array.from(found);
    }
    ```
    
    Test template renderer:
    ```bash
    node -e "
    import('./bin/lib/rendering/template-renderer.js').then(m => {
      const vars = m.getClaudeVariables(false);
      const rendered = m.renderTemplate('Install to {{PLATFORM_ROOT}}', vars);
      console.log('✓ Rendered:', rendered);
      
      const unknown = m.findUnknownVariables('{{PLATFORM_ROOT}} {{UNKNOWN}}', vars);
      console.log('✓ Unknown vars:', unknown);
    });
    "
    ```
  </action>
  <verify>
    ```bash
    test -f bin/lib/rendering/template-renderer.js && echo "✓ Template renderer exists"
    grep -q "export function renderTemplate" bin/lib/rendering/template-renderer.js && echo "✓ renderTemplate defined"
    grep -q "export function getClaudeVariables" bin/lib/rendering/template-renderer.js && echo "✓ getClaudeVariables defined"
    
    # Test import
    node -e "import('./bin/lib/rendering/template-renderer.js').then(() => console.log('✓ Module loads'))" 2>&1 | grep -q "Module loads"
    ```
  </verify>
  <done>bin/lib/rendering/template-renderer.js with renderTemplate, getClaudeVariables, findUnknownVariables functions</done>
</task>

<task name="create-progress-utilities" type="auto">
  <files>bin/lib/cli/progress.js</files>
  <action>
    Create progress bar utilities using cli-progress:
    
    ```javascript
    // bin/lib/cli/progress.js
    
    import cliProgress from 'cli-progress';
    import chalk from 'chalk';
    
    /**
     * Create multi-bar progress display
     * @returns {Object} Multi-bar instance
     */
    export function createMultiBar() {
      return new cliProgress.MultiBar({
        format: chalk.cyan('{bar}') + ' | {phase} | {percentage}% | {value}/{total}',
        barCompleteChar: '█',
        barIncompleteChar: '░',
        hideCursor: true,
        clearOnComplete: false,
        stopOnComplete: true
      });
    }
    
    /**
     * Create single progress bar
     * @param {string} phase - Phase name
     * @param {number} total - Total items
     * @returns {Object} Progress bar instance
     */
    export function createProgressBar(multiBar, phase, total) {
      return multiBar.create(total, 0, { phase });
    }
    
    /**
     * Update progress
     * @param {Object} bar - Progress bar instance
     * @param {number} value - Current value
     */
    export function updateProgress(bar, value) {
      bar.update(value);
    }
    
    /**
     * Complete progress
     * @param {Object} bar - Progress bar instance
     */
    export function completeProgress(bar) {
      bar.stop();
    }
    
    /**
     * Stop all progress bars
     * @param {Object} multiBar - Multi-bar instance
     */
    export function stopAllProgress(multiBar) {
      multiBar.stop();
    }
    ```
    
    Test progress utilities:
    ```bash
    node -e "
    import('./bin/lib/cli/progress.js').then(async m => {
      const multi = m.createMultiBar();
      const bar1 = m.createProgressBar(multi, 'Test', 100);
      
      for (let i = 0; i <= 100; i += 20) {
        m.updateProgress(bar1, i);
        await new Promise(r => setTimeout(r, 100));
      }
      
      m.stopAllProgress(multi);
      console.log('✓ Progress bars work');
    });
    "
    ```
  </action>
  <verify>
    ```bash
    test -f bin/lib/cli/progress.js && echo "✓ Progress module exists"
    grep -q "export function createMultiBar" bin/lib/cli/progress.js && echo "✓ createMultiBar defined"
    grep -q "export function createProgressBar" bin/lib/cli/progress.js && echo "✓ createProgressBar defined"
    
    # Test import
    node -e "import('./bin/lib/cli/progress.js').then(() => console.log('✓ Module loads'))" 2>&1 | grep -q "Module loads"
    ```
  </verify>
  <done>bin/lib/cli/progress.js with createMultiBar, createProgressBar, updateProgress, completeProgress functions using cli-progress</done>
</task>

<task name="create-logger-utilities" type="auto">
  <files>bin/lib/cli/logger.js</files>
  <action>
    Create logging utilities with chalk:
    
    ```javascript
    // bin/lib/cli/logger.js
    
    import chalk from 'chalk';
    
    /**
     * Log info message
     * @param {string} message - Message to log
     */
    export function info(message) {
      console.log(chalk.blue('ℹ'), message);
    }
    
    /**
     * Log success message
     * @param {string} message - Message to log
     */
    export function success(message) {
      console.log(chalk.green('✓'), message);
    }
    
    /**
     * Log warning message
     * @param {string} message - Message to log
     */
    export function warn(message) {
      console.warn(chalk.yellow('⚠'), message);
    }
    
    /**
     * Log error message
     * @param {string} message - Message to log
     */
    export function error(message) {
      console.error(chalk.red('✗'), message);
    }
    
    /**
     * Log verbose message (only if verbose mode)
     * @param {string} message - Message to log
     * @param {boolean} isVerbose - Verbose mode flag
     */
    export function verbose(message, isVerbose) {
      if (isVerbose) {
        console.log(chalk.gray('  →'), message);
      }
    }
    
    /**
     * Print section header
     * @param {string} title - Section title
     */
    export function header(title) {
      console.log();
      console.log(chalk.bold.cyan(title));
      console.log(chalk.cyan('─'.repeat(title.length)));
    }
    
    /**
     * Print final summary
     * @param {Object} stats - Installation statistics
     */
    export function summary(stats) {
      console.log();
      success(`${stats.skills} skills, ${stats.agents} agents installed to ${stats.target}`);
      info('Try /gsd-help to get started');
    }
    ```
    
    Test logger:
    ```bash
    node -e "
    import('./bin/lib/cli/logger.js').then(m => {
      m.header('Test Header');
      m.info('Info message');
      m.success('Success message');
      m.warn('Warning message');
      m.error('Error message');
      m.verbose('Verbose message', true);
      m.summary({ skills: 29, agents: 13, target: '.claude/' });
    });
    "
    ```
  </action>
  <verify>
    ```bash
    test -f bin/lib/cli/logger.js && echo "✓ Logger module exists"
    grep -q "export function info" bin/lib/cli/logger.js && echo "✓ info defined"
    grep -q "export function success" bin/lib/cli/logger.js && echo "✓ success defined"
    grep -q "export function warn" bin/lib/cli/logger.js && echo "✓ warn defined"
    grep -q "export function error" bin/lib/cli/logger.js && echo "✓ error defined"
    
    # Test import
    node -e "import('./bin/lib/cli/logger.js').then(() => console.log('✓ Module loads'))" 2>&1 | grep -q "Module loads"
    ```
  </verify>
  <done>bin/lib/cli/logger.js with info, success, warn, error, verbose, header, summary functions using chalk</done>
</task>

## Verification

After completing all tasks:

```bash
# 1. Check all modules exist
ls bin/lib/io/file-operations.js
ls bin/lib/paths/path-resolver.js
ls bin/lib/rendering/template-renderer.js
ls bin/lib/cli/progress.js
ls bin/lib/cli/logger.js

# 2. Test each module loads
for module in io/file-operations paths/path-resolver rendering/template-renderer cli/progress cli/logger; do
  node -e "import('./bin/lib/${module}.js').then(() => console.log('✓ ${module}'))"
done

# 3. Integration test - template rendering
node -e "
import('./bin/lib/rendering/template-renderer.js').then(m => {
  const vars = m.getClaudeVariables(false);
  const result = m.renderTemplate('{{COMMAND_PREFIX}}help → {{PLATFORM_ROOT}}/get-shit-done/', vars);
  console.log('Result:', result);
});
"
```

Expected outcomes:
- All 5 modules exist and load without errors
- Template rendering produces: "/gsd-help → .claude/get-shit-done/"

## Success Criteria

- [ ] file-operations.js: copyDirectory, ensureDirectory, writeFile, readFile, pathExists functions
- [ ] file-operations.js: Permission errors converted to InstallError with PERMISSION_DENIED code
- [ ] path-resolver.js: resolveTargetDirectory, validatePath, normalizePath, getTemplatesDirectory functions
- [ ] path-resolver.js: Path traversal attempts rejected with InvalidArgs error
- [ ] template-renderer.js: renderTemplate, getClaudeVariables, findUnknownVariables functions
- [ ] template-renderer.js: Simple string replacement (not full templating engine)
- [ ] progress.js: createMultiBar, createProgressBar, updateProgress, stopAllProgress functions
- [ ] progress.js: Uses cli-progress with custom format and chalk styling
- [ ] logger.js: info, success, warn, error, verbose, header, summary functions
- [ ] logger.js: Uses chalk for colored output with unicode symbols

## Output

**Files Created:**
- bin/lib/io/file-operations.js
- bin/lib/paths/path-resolver.js
- bin/lib/rendering/template-renderer.js
- bin/lib/cli/progress.js
- bin/lib/cli/logger.js

**Modules Ready:** All core building blocks exist and tested independently

**Next:** Plan 03 will wire these modules together in bin/install.js with commander CLI parsing and installation orchestration
