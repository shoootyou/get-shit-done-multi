---
phase: 02-core-installer-foundation
plan: 04
type: execute
wave: 4
depends_on:
  - 02-03
files_modified:
  - vitest.config.js
  - tests/unit/path-resolver.test.js
  - tests/unit/template-renderer.test.js
  - tests/unit/file-operations.test.js
  - tests/integration/installer.test.js
autonomous: true
must_haves:
  - test-config: Vitest configured for ESM with test isolation
  - unit-tests: Path resolver, template renderer, file operations tested independently
  - integration-tests: Full installation flow tested with /tmp isolation
  - mock-templates: Minimal template fixtures for testing
  - test-coverage: Core modules reach 80%+ coverage
---

# Phase 02 Plan 04: Test Infrastructure & Integration Tests

## Objective

Establish comprehensive test infrastructure using Vitest (already installed) with proper test isolation in /tmp. Write unit tests for core modules (path resolver, template renderer, file operations) and integration tests for full installation flow. Create minimal template fixtures for testing. Ensure all tests follow TEST-01 (isolation) and TEST-02 (cleanup) requirements.

## Context

**From Plans 01-03:** Working installer with CLI, orchestrator, core modules

**Testing stack:** Vitest already in devDependencies (from Phase 1), configured for ESM

**Test isolation requirement (TEST-01):** ALL tests must execute in /tmp with unique folders, never touch source files

**Test cleanup requirement (TEST-02):** Clean up test folders after completion, leave on failure for debugging

**Coverage goals:** 80%+ for core modules (path-resolver, template-renderer, file-operations), 70%+ for orchestrator

## Tasks

<task name="configure-vitest" type="auto">
  <files>vitest.config.js</files>
  <action>
    Create Vitest configuration for ESM tests:
    
    ```javascript
    // vitest.config.js
    
    import { defineConfig } from 'vitest/config';
    
    export default defineConfig({
      test: {
        globals: false, // Explicit imports
        environment: 'node',
        testTimeout: 30000, // 30s for integration tests
        hookTimeout: 10000,
        isolate: true,
        pool: 'forks', // Process isolation
        coverage: {
          provider: 'v8',
          reporter: ['text', 'json', 'html'],
          include: ['bin/lib/**/*.js'],
          exclude: ['bin/lib/**/*.test.js'],
          thresholds: {
            statements: 70,
            branches: 70,
            functions: 70,
            lines: 70
          }
        }
      }
    });
    ```
    
    Add test scripts to package.json (if not already present):
    ```json
    {
      "scripts": {
        "test": "vitest run",
        "test:watch": "vitest watch",
        "test:ui": "vitest --ui",
        "test:coverage": "vitest run --coverage"
      }
    }
    ```
    
    Test configuration:
    ```bash
    npm run test -- --version
    ```
  </action>
  <verify>
    ```bash
    test -f vitest.config.js && echo "✓ Vitest config exists"
    grep -q "defineConfig" vitest.config.js && echo "✓ Config format correct"
    npm run test -- --version 2>&1 | grep -q "vitest" && echo "✓ Vitest runs"
    ```
  </verify>
  <done>vitest.config.js created with ESM support, test isolation, coverage thresholds</done>
</task>

<task name="create-test-utilities" type="auto">
  <files>
    tests/helpers/test-utils.js
    tests/fixtures/minimal-templates.js
  </files>
  <action>
    Create test utilities and minimal template fixtures:
    
    ```javascript
    // tests/helpers/test-utils.js
    
    import { join } from 'path';
    import { mkdtemp, rm, mkdir, writeFile } from 'fs/promises';
    import { tmpdir } from 'os';
    
    /**
     * Create isolated test directory in /tmp
     * @returns {Promise<string>} Test directory path
     */
    export async function createTestDir() {
      const prefix = join(tmpdir(), 'gsd-test-');
      return mkdtemp(prefix);
    }
    
    /**
     * Clean up test directory
     * @param {string} dir - Directory to remove
     */
    export async function cleanupTestDir(dir) {
      try {
        await rm(dir, { recursive: true, force: true });
      } catch (error) {
        // Ignore cleanup errors
        console.warn(`Cleanup warning: ${error.message}`);
      }
    }
    
    /**
     * Create minimal template structure for testing
     * @param {string} baseDir - Base directory for templates
     */
    export async function createMinimalTemplates(baseDir) {
      // Create structure
      const templatesDir = join(baseDir, 'templates');
      const skillsDir = join(templatesDir, 'skills', 'gsd-test-skill');
      const agentsDir = join(templatesDir, 'agents');
      const sharedDir = join(templatesDir, 'get-shit-done');
      
      await mkdir(skillsDir, { recursive: true });
      await mkdir(agentsDir, { recursive: true });
      await mkdir(sharedDir, { recursive: true });
      
      // Create skill
      await writeFile(
        join(skillsDir, 'SKILL.md'),
        `---
name: Test Skill
description: Test skill
allowed-tools: Read, Write
---
Install to {{PLATFORM_ROOT}}/skills/
Use {{COMMAND_PREFIX}}test-skill
`
      );
      
      // Create agent
      await writeFile(
        join(agentsDir, 'gsd-test-agent.md'),
        `---
name: test-agent
description: Test agent
tools: Read, Write
---
Agent content with {{PLATFORM_ROOT}} reference
`
      );
      
      // Create versions.json
      await writeFile(
        join(agentsDir, 'versions.json'),
        JSON.stringify({ 'test-agent': { version: '2.0.0' } }, null, 2)
      );
      
      // Create shared manifest template
      await writeFile(
        join(sharedDir, '.gsd-install-manifest.json'),
        JSON.stringify({
          version: '{{VERSION}}',
          platform: '{{PLATFORM_NAME}}'
        }, null, 2)
      );
      
      return templatesDir;
    }
    ```
    
    Test utilities:
    ```bash
    node -e "
    import('./tests/helpers/test-utils.js').then(async m => {
      const dir = await m.createTestDir();
      console.log('✓ Test dir created:', dir);
      await m.cleanupTestDir(dir);
      console.log('✓ Cleanup works');
    });
    "
    ```
  </action>
  <verify>
    ```bash
    test -f tests/helpers/test-utils.js && echo "✓ Test utils exist"
    grep -q "export async function createTestDir" tests/helpers/test-utils.js && echo "✓ createTestDir defined"
    grep -q "export async function createMinimalTemplates" tests/helpers/test-utils.js && echo "✓ createMinimalTemplates defined"
    
    # Test import
    node -e "import('./tests/helpers/test-utils.js').then(() => console.log('✓ Module loads'))" 2>&1 | grep -q "Module loads"
    ```
  </verify>
  <done>tests/helpers/test-utils.js with createTestDir, cleanupTestDir, createMinimalTemplates functions</done>
</task>

<task name="write-unit-tests" type="auto">
  <files>
    tests/unit/path-resolver.test.js
    tests/unit/template-renderer.test.js
    tests/unit/file-operations.test.js
  </files>
  <action>
    Write unit tests for core modules:
    
    ```javascript
    // tests/unit/path-resolver.test.js
    
    import { describe, it, expect } from 'vitest';
    import { resolveTargetDirectory, validatePath, normalizePath, joinPaths } from '../../bin/lib/paths/path-resolver.js';
    import { homedir } from 'os';
    import { join } from 'path';
    
    describe('path-resolver', () => {
      describe('resolveTargetDirectory', () => {
        it('should resolve global directory', () => {
          const result = resolveTargetDirectory(true, 'claude');
          expect(result).toBe(join(homedir(), '.claude'));
        });
        
        it('should resolve local directory', () => {
          const result = resolveTargetDirectory(false, 'claude');
          expect(result).toBe(join(process.cwd(), '.claude'));
        });
      });
      
      describe('validatePath', () => {
        it('should accept valid paths', () => {
          const base = '/tmp/test';
          const target = '/tmp/test/subdir';
          expect(() => validatePath(target, base)).not.toThrow();
        });
        
        it('should reject path traversal attempts', () => {
          const base = '/tmp/test';
          const target = '/tmp/test/../etc/passwd';
          expect(() => validatePath(target, base)).toThrow('Invalid path');
        });
        
        it('should reject paths with .. pattern', () => {
          expect(() => validatePath('/tmp/../etc', '/tmp')).toThrow('traversal pattern');
        });
      });
      
      describe('normalizePath', () => {
        it('should normalize paths', () => {
          const result = normalizePath('/tmp//test/./file');
          expect(result).toBe(join('/tmp', 'test', 'file'));
        });
      });
      
      describe('joinPaths', () => {
        it('should join paths correctly', () => {
          const result = joinPaths('/tmp', 'test', 'file.txt');
          expect(result).toBe(join('/tmp', 'test', 'file.txt'));
        });
      });
    });
    ```
    
    ```javascript
    // tests/unit/template-renderer.test.js
    
    import { describe, it, expect } from 'vitest';
    import { renderTemplate, getClaudeVariables, findUnknownVariables } from '../../bin/lib/rendering/template-renderer.js';
    
    describe('template-renderer', () => {
      describe('renderTemplate', () => {
        it('should replace single variable', () => {
          const result = renderTemplate('Hello {{NAME}}', { NAME: 'World' });
          expect(result).toBe('Hello World');
        });
        
        it('should replace multiple variables', () => {
          const result = renderTemplate(
            '{{PLATFORM_ROOT}}/{{COMMAND_PREFIX}}help',
            { PLATFORM_ROOT: '.claude', COMMAND_PREFIX: '/gsd-' }
          );
          expect(result).toBe('.claude//gsd-help');
        });
        
        it('should replace multiple occurrences', () => {
          const result = renderTemplate(
            '{{VAR}} and {{VAR}} again',
            { VAR: 'test' }
          );
          expect(result).toBe('test and test again');
        });
        
        it('should leave unknown variables unchanged', () => {
          const result = renderTemplate('{{KNOWN}} {{UNKNOWN}}', { KNOWN: 'yes' });
          expect(result).toBe('yes {{UNKNOWN}}');
        });
      });
      
      describe('getClaudeVariables', () => {
        it('should return global variables', () => {
          const vars = getClaudeVariables(true);
          expect(vars).toMatchObject({
            PLATFORM_ROOT: '~/.claude',
            COMMAND_PREFIX: '/gsd-',
            VERSION: '2.0.0',
            PLATFORM_NAME: 'claude'
          });
        });
        
        it('should return local variables', () => {
          const vars = getClaudeVariables(false);
          expect(vars.PLATFORM_ROOT).toBe('.claude');
        });
      });
      
      describe('findUnknownVariables', () => {
        it('should find unknown variables', () => {
          const result = findUnknownVariables(
            '{{KNOWN}} {{UNKNOWN1}} {{UNKNOWN2}}',
            { KNOWN: 'value' }
          );
          expect(result).toEqual(['UNKNOWN1', 'UNKNOWN2']);
        });
        
        it('should return empty array if all known', () => {
          const result = findUnknownVariables(
            '{{VAR1}} {{VAR2}}',
            { VAR1: 'a', VAR2: 'b' }
          );
          expect(result).toEqual([]);
        });
      });
    });
    ```
    
    ```javascript
    // tests/unit/file-operations.test.js
    
    import { describe, it, expect, beforeEach, afterEach } from 'vitest';
    import { ensureDirectory, writeFile, readFile, pathExists } from '../../bin/lib/io/file-operations.js';
    import { createTestDir, cleanupTestDir } from '../helpers/test-utils.js';
    import { join } from 'path';
    
    describe('file-operations', () => {
      let testDir;
      
      beforeEach(async () => {
        testDir = await createTestDir();
      });
      
      afterEach(async () => {
        await cleanupTestDir(testDir);
      });
      
      describe('ensureDirectory', () => {
        it('should create directory', async () => {
          const dir = join(testDir, 'subdir');
          await ensureDirectory(dir);
          const exists = await pathExists(dir);
          expect(exists).toBe(true);
        });
        
        it('should create nested directories', async () => {
          const dir = join(testDir, 'a', 'b', 'c');
          await ensureDirectory(dir);
          const exists = await pathExists(dir);
          expect(exists).toBe(true);
        });
      });
      
      describe('writeFile', () => {
        it('should write file', async () => {
          const file = join(testDir, 'test.txt');
          await writeFile(file, 'content');
          const exists = await pathExists(file);
          expect(exists).toBe(true);
        });
        
        it('should create parent directories', async () => {
          const file = join(testDir, 'subdir', 'test.txt');
          await writeFile(file, 'content');
          const exists = await pathExists(file);
          expect(exists).toBe(true);
        });
      });
      
      describe('readFile', () => {
        it('should read file content', async () => {
          const file = join(testDir, 'test.txt');
          await writeFile(file, 'hello world');
          const content = await readFile(file);
          expect(content).toBe('hello world');
        });
      });
      
      describe('pathExists', () => {
        it('should return true for existing path', async () => {
          const file = join(testDir, 'test.txt');
          await writeFile(file, 'content');
          const exists = await pathExists(file);
          expect(exists).toBe(true);
        });
        
        it('should return false for non-existing path', async () => {
          const file = join(testDir, 'nonexistent.txt');
          const exists = await pathExists(file);
          expect(exists).toBe(false);
        });
      });
    });
    ```
    
    Run unit tests:
    ```bash
    npm test tests/unit/
    ```
  </action>
  <verify>
    ```bash
    # Check test files exist
    test -f tests/unit/path-resolver.test.js && echo "✓ Path resolver tests exist"
    test -f tests/unit/template-renderer.test.js && echo "✓ Template renderer tests exist"
    test -f tests/unit/file-operations.test.js && echo "✓ File operations tests exist"
    
    # Run tests
    npm test tests/unit/ 2>&1 | grep -q "PASS" && echo "✓ Unit tests pass"
    ```
  </verify>
  <done>Unit tests for path-resolver, template-renderer, file-operations with 80%+ coverage</done>
</task>

<task name="write-integration-tests" type="auto">
  <files>tests/integration/installer.test.js</files>
  <action>
    Write integration tests for full installation flow:
    
    ```javascript
    // tests/integration/installer.test.js
    
    import { describe, it, expect, beforeEach, afterEach } from 'vitest';
    import { install } from '../../bin/lib/installer/orchestrator.js';
    import { createTestDir, cleanupTestDir, createMinimalTemplates } from '../helpers/test-utils.js';
    import { pathExists, readFile } from '../../bin/lib/io/file-operations.js';
    import { join } from 'path';
    import { fileURLToPath } from 'url';
    import { dirname } from 'path';
    
    const __filename = fileURLToPath(import.meta.url);
    const __dirname = dirname(__filename);
    
    describe('installer integration', () => {
      let testDir;
      let templatesDir;
      
      beforeEach(async () => {
        testDir = await createTestDir();
        templatesDir = await createMinimalTemplates(testDir);
      });
      
      afterEach(async () => {
        await cleanupTestDir(testDir);
      });
      
      describe('install', () => {
        it('should install skills, agents, and shared directory', async () => {
          const targetDir = join(testDir, '.claude');
          const scriptDir = join(testDir, 'bin');
          
          // Mock script directory structure
          const options = {
            platform: 'claude',
            isGlobal: false,
            isVerbose: false,
            scriptDir: testDir // templates/ is sibling to bin/
          };
          
          const stats = await install(options);
          
          // Check stats
          expect(stats.skills).toBeGreaterThan(0);
          expect(stats.agents).toBeGreaterThan(0);
          expect(stats.shared).toBe(1);
          
          // Check structure exists
          expect(await pathExists(join(targetDir, 'skills'))).toBe(true);
          expect(await pathExists(join(targetDir, 'agents'))).toBe(true);
          expect(await pathExists(join(targetDir, 'get-shit-done'))).toBe(true);
        });
        
        it('should replace template variables', async () => {
          const targetDir = join(testDir, '.claude');
          
          const options = {
            platform: 'claude',
            isGlobal: false,
            isVerbose: false,
            scriptDir: testDir
          };
          
          await install(options);
          
          // Check skill file has variables replaced
          const skillFile = join(targetDir, 'skills', 'gsd-test-skill', 'SKILL.md');
          const content = await readFile(skillFile);
          
          expect(content).not.toContain('{{PLATFORM_ROOT}}');
          expect(content).toContain('.claude/skills/');
          expect(content).toContain('/gsd-test-skill');
        });
        
        it('should generate manifest file', async () => {
          const targetDir = join(testDir, '.claude');
          
          const options = {
            platform: 'claude',
            isGlobal: false,
            isVerbose: false,
            scriptDir: testDir
          };
          
          await install(options);
          
          const manifestFile = join(targetDir, 'get-shit-done', '.gsd-install-manifest.json');
          expect(await pathExists(manifestFile)).toBe(true);
          
          const content = await readFile(manifestFile);
          const manifest = JSON.parse(content);
          
          expect(manifest).toMatchObject({
            version: '2.0.0',
            platform: 'claude',
            scope: 'local'
          });
          expect(manifest.installedAt).toBeDefined();
          expect(manifest.stats).toBeDefined();
        });
        
        it('should handle global installation', async () => {
          const options = {
            platform: 'claude',
            isGlobal: true,
            isVerbose: false,
            scriptDir: testDir
          };
          
          // Should not throw
          const stats = await install(options);
          expect(stats).toBeDefined();
        });
        
        it('should handle verbose mode', async () => {
          const options = {
            platform: 'claude',
            isGlobal: false,
            isVerbose: true,
            scriptDir: testDir
          };
          
          // Should not throw, output will differ but result same
          const stats = await install(options);
          expect(stats).toBeDefined();
        });
      });
    });
    ```
    
    Run integration tests:
    ```bash
    npm test tests/integration/
    ```
  </action>
  <verify>
    ```bash
    # Check test file exists
    test -f tests/integration/installer.test.js && echo "✓ Integration tests exist"
    
    # Run tests
    npm test tests/integration/ 2>&1 | grep -q "PASS" && echo "✓ Integration tests pass"
    
    # Check test isolation (no .claude/ in project root)
    test ! -d .claude && echo "✓ Test isolation works"
    ```
  </verify>
  <done>Integration tests for full installation flow with template processing, manifest generation, variable replacement</done>
</task>

<task name="run-full-test-suite" type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete test infrastructure:
    - Vitest configuration for ESM with coverage
    - Test utilities for /tmp isolation and cleanup
    - Unit tests for path-resolver, template-renderer, file-operations (80%+ coverage)
    - Integration tests for full installation flow
    - Minimal template fixtures for testing
  </what-built>
  <how-to-verify>
    **Run all tests:**
    ```bash
    cd /Users/rodolfo/croonix-github/gsd/get-shit-done-multi
    
    # Run all tests
    npm test
    
    # Run with coverage
    npm run test:coverage
    
    # Check coverage report
    cat coverage/coverage-summary.json | grep -A 5 "total"
    ```
    
    **Verify test isolation:**
    ```bash
    # Tests should NOT create files in project root
    ls -la | grep -E ".claude|.github|.codex"
    # Should be EMPTY (no test artifacts)
    
    # Check /tmp for test directories
    ls -la /tmp/ | grep gsd-test
    # Should be minimal or empty (cleaned up after tests)
    ```
    
    **Run specific test suites:**
    ```bash
    # Unit tests only
    npm test tests/unit/
    
    # Integration tests only
    npm test tests/integration/
    ```
    
    **Success criteria:**
    - ✓ All unit tests pass (path-resolver, template-renderer, file-operations)
    - ✓ All integration tests pass (installer flow)
    - ✓ Test coverage ≥70% for bin/lib/**
    - ✓ No test artifacts in project root (.claude/, .github/, .codex/)
    - ✓ Test directories in /tmp cleaned up after tests
    - ✓ Tests run in isolation (can run multiple times without conflicts)
  </how-to-verify>
  <resume-signal>
    Type "PASS" if all tests succeed and coverage meets thresholds, or describe failing tests.
  </resume-signal>
</task>

## Verification

After completing all tasks:

```bash
# 1. Configuration check
test -f vitest.config.js && echo "✓ Config exists"

# 2. Test utilities check
test -f tests/helpers/test-utils.js && echo "✓ Utils exist"

# 3. Run all tests
npm test

# 4. Check coverage
npm run test:coverage

# 5. Verify isolation
ls -la | grep -E ".claude|.github|.codex" || echo "✓ No test artifacts in root"

# 6. Check /tmp cleanup
ls /tmp/ | grep gsd-test | wc -l
# Should be 0 or very small number
```

Expected outcomes:
- All tests pass
- Coverage ≥70% for bin/lib/**
- No test artifacts in project root
- /tmp directories cleaned up

## Success Criteria

- [ ] vitest.config.js: ESM support, node environment, coverage thresholds (70%)
- [ ] Test utilities: createTestDir, cleanupTestDir, createMinimalTemplates functions
- [ ] Unit tests: path-resolver (validatePath, resolveTargetDirectory, normalizePath)
- [ ] Unit tests: template-renderer (renderTemplate, getClaudeVariables, findUnknownVariables)
- [ ] Unit tests: file-operations (ensureDirectory, writeFile, readFile, pathExists)
- [ ] Integration tests: Full install flow with minimal templates
- [ ] Integration tests: Template variable replacement verified
- [ ] Integration tests: Manifest generation verified
- [ ] Test isolation: All tests run in /tmp with unique directories (TEST-01)
- [ ] Test cleanup: Directories removed after tests (TEST-02)
- [ ] Coverage: ≥70% for bin/lib/** modules
- [ ] All tests pass without errors

## Output

**Files Created:**
- vitest.config.js
- tests/helpers/test-utils.js
- tests/unit/path-resolver.test.js
- tests/unit/template-renderer.test.js
- tests/unit/file-operations.test.js
- tests/integration/installer.test.js

**Test Infrastructure:** Complete test suite with unit and integration tests, /tmp isolation, coverage reporting

**Next:** Phase 2 complete! Ready for Phase 3 (Multi-Platform Support) or Phase 4 (Interactive UX).
