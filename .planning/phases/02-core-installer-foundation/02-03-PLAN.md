---
phase: 02-core-installer-foundation
plan: 03
type: execute
wave: 3
depends_on:
  - 02-01
  - 02-02
files_modified:
  - bin/install.js
  - bin/lib/installer/orchestrator.js
autonomous: true
must_haves:
  - cli-parser: Commander parses --claude, --global, --local, --verbose flags
  - orchestration: Installation orchestrator coordinates all phases (skills, agents, shared)
  - template-processing: Templates read from /templates/, variables replaced, written to target
  - manifest-generation: .gsd-install-manifest.json created with installation metadata
  - error-handling: Errors caught, formatted, exit with appropriate codes
  - progress-display: Multi-bar progress shows phases with percentages
---

# Phase 02 Plan 03: CLI Integration & Installation Orchestration

## Objective

Wire all core modules together into a functioning installer. Implement commander-based CLI argument parsing, create installation orchestrator that coordinates the three phases (skills, agents, shared directory), integrate progress bars and logging, handle errors with appropriate exit codes, and generate installation manifest. This produces a working `npx get-shit-done-multi --claude` command.

## Context

**From Plan 01:** bin structure, error types, cli-progress dependency
**From Plan 02:** File operations, path resolver, template renderer, progress, logger modules

**What we're wiring:** CLI flags → path resolution → template loading → variable replacement → file copying → progress display → manifest generation

**Installation phases:**
1. Skills: Copy templates/skills/* → target/skills/ (29 directories)
2. Agents: Copy templates/agents/* → target/agents/ (13 files)
3. Shared: Copy templates/get-shit-done → target/get-shit-done (references, workflows)

**Flow:** Parse flags → validate args → detect existing → confirm overwrite → install phases → generate manifest → show summary

## Tasks

<task name="implement-cli-parser" type="auto">
  <files>bin/install.js</files>
  <action>
    Update bin/install.js with commander CLI parsing:
    
    ```javascript
    #!/usr/bin/env node
    
    /**
     * get-shit-done-multi installer
     * Entry point for npx get-shit-done-multi
     */
    
    import { Command } from 'commander';
    import { fileURLToPath } from 'url';
    import { dirname } from 'path';
    import { InstallError, EXIT_CODES } from './lib/errors/install-error.js';
    import * as logger from './lib/cli/logger.js';
    import { install } from './lib/installer/orchestrator.js';
    
    // Get script directory in ESM (replaces __dirname)
    const __filename = fileURLToPath(import.meta.url);
    const __dirname = dirname(__filename);
    
    async function main() {
      const program = new Command();
      
      program
        .name('get-shit-done-multi')
        .version('2.0.0')
        .description('Install get-shit-done skills and agents to AI coding assistants')
        .requiredOption('--claude', 'Install for Claude Code')
        .option('--global', 'Install globally to ~/.claude/ (default: local)')
        .option('--local', 'Install locally to .claude/ (explicit)')
        .option('--verbose', 'Show detailed file-by-file progress')
        .parse(process.argv);
    
      const options = program.opts();
      
      // Validate flags
      if (!options.claude) {
        logger.error('Missing required flag: --claude');
        logger.info('Usage: npx get-shit-done-multi --claude [--global|--local] [--verbose]');
        process.exit(EXIT_CODES.INVALID_ARGS);
      }
      
      // Determine scope (default to local if neither specified)
      const isGlobal = options.global === true;
      const isLocal = options.local === true;
      
      if (isGlobal && isLocal) {
        logger.error('Cannot specify both --global and --local');
        process.exit(EXIT_CODES.INVALID_ARGS);
      }
      
      // Show banner
      logger.header('get-shit-done-multi v2.0.0');
      logger.info(`Installing to Claude Code (${isGlobal ? 'global' : 'local'})`);
      
      // Run installation
      const stats = await install({
        platform: 'claude',
        isGlobal,
        isVerbose: options.verbose || false,
        scriptDir: __dirname
      });
      
      // Show summary
      logger.summary(stats);
    }
    
    // Execute with proper error handling
    main().catch(error => {
      if (error instanceof InstallError) {
        logger.error(error.message);
        if (error.details) {
          logger.verbose(JSON.stringify(error.details, null, 2), true);
        }
        process.exit(error.code);
      } else {
        logger.error(`Unexpected error: ${error.message}`);
        console.error(error.stack);
        process.exit(EXIT_CODES.GENERAL_ERROR);
      }
    });
    ```
    
    Test CLI parsing:
    ```bash
    # Should show error (missing --claude)
    node bin/install.js
    
    # Should show banner and attempt install
    node bin/install.js --claude --local --verbose
    ```
  </action>
  <verify>
    ```bash
    # Check commander integration
    grep -q "new Command()" bin/install.js && echo "✓ Commander integrated"
    grep -q "requiredOption('--claude'" bin/install.js && echo "✓ --claude required"
    grep -q "option('--global'" bin/install.js && echo "✓ --global option"
    grep -q "option('--local'" bin/install.js && echo "✓ --local option"
    grep -q "option('--verbose'" bin/install.js && echo "✓ --verbose option"
    
    # Test --help
    node bin/install.js --help | grep -q "Install for Claude Code" && echo "✓ Help text works"
    
    # Test --version
    node bin/install.js --version | grep -q "2.0.0" && echo "✓ Version works"
    ```
  </verify>
  <done>bin/install.js updated with commander CLI parsing, flag validation, banner display, error handling with exit codes</done>
</task>

<task name="create-installation-orchestrator" type="auto">
  <files>bin/lib/installer/orchestrator.js</files>
  <action>
    Create installation orchestrator module:
    
    ```javascript
    // bin/lib/installer/orchestrator.js
    
    import { join } from 'path';
    import { resolveTargetDirectory, getTemplatesDirectory, validatePath } from '../paths/path-resolver.js';
    import { copyDirectory, ensureDirectory, writeFile, pathExists } from '../io/file-operations.js';
    import { renderTemplate, getClaudeVariables, findUnknownVariables } from '../rendering/template-renderer.js';
    import { createMultiBar, createProgressBar, updateProgress, stopAllProgress } from '../cli/progress.js';
    import * as logger from '../cli/logger.js';
    import { missingTemplates } from '../errors/install-error.js';
    import { readdir, readFile } from 'fs/promises';
    
    /**
     * Main installation orchestrator
     * @param {Object} options - Installation options
     * @returns {Promise<Object>} Installation statistics
     */
    export async function install(options) {
      const { platform, isGlobal, isVerbose, scriptDir } = options;
      
      // Resolve paths
      const targetDir = resolveTargetDirectory(isGlobal, platform);
      const templatesDir = getTemplatesDirectory(scriptDir);
      
      logger.info(`Target directory: ${targetDir}`);
      logger.verbose(`Templates directory: ${templatesDir}`, isVerbose);
      
      // Validate templates exist
      await validateTemplates(templatesDir);
      
      // Check for existing installation
      const manifestPath = join(targetDir, 'get-shit-done', '.gsd-install-manifest.json');
      const hasExisting = await pathExists(manifestPath);
      
      if (hasExisting) {
        logger.warn('Existing installation detected');
        logger.warn('Installation will overwrite existing files');
        // In Phase 4, we'll add interactive confirmation here
        // For now, proceed with overwrite
      }
      
      // Get template variables
      const variables = getClaudeVariables(isGlobal);
      
      // Create target directory
      await ensureDirectory(targetDir);
      
      // Initialize progress tracking
      const stats = { skills: 0, agents: 0, shared: 0, target: targetDir };
      
      if (!isVerbose) {
        // Multi-bar progress for non-verbose mode
        const multiBar = createMultiBar();
        
        try {
          // Phase 1: Install skills
          stats.skills = await installSkills(templatesDir, targetDir, variables, multiBar, isVerbose);
          
          // Phase 2: Install agents
          stats.agents = await installAgents(templatesDir, targetDir, variables, multiBar, isVerbose);
          
          // Phase 3: Install shared directory
          stats.shared = await installShared(templatesDir, targetDir, variables, multiBar, isVerbose);
          
          stopAllProgress(multiBar);
        } catch (error) {
          stopAllProgress(multiBar);
          throw error;
        }
      } else {
        // Verbose mode: no progress bars, show files
        logger.header('Installing Skills');
        stats.skills = await installSkills(templatesDir, targetDir, variables, null, isVerbose);
        
        logger.header('Installing Agents');
        stats.agents = await installAgents(templatesDir, targetDir, variables, null, isVerbose);
        
        logger.header('Installing Shared Directory');
        stats.shared = await installShared(templatesDir, targetDir, variables, null, isVerbose);
      }
      
      // Generate installation manifest
      await generateManifest(targetDir, stats, isGlobal);
      
      return stats;
    }
    
    /**
     * Validate templates directory exists
     */
    async function validateTemplates(templatesDir) {
      const skillsDir = join(templatesDir, 'skills');
      const agentsDir = join(templatesDir, 'agents');
      const sharedDir = join(templatesDir, 'get-shit-done');
      
      const skillsExist = await pathExists(skillsDir);
      const agentsExist = await pathExists(agentsDir);
      const sharedExist = await pathExists(sharedDir);
      
      if (!skillsExist || !agentsExist || !sharedExist) {
        throw missingTemplates(
          'Templates directory incomplete',
          { skillsExist, agentsExist, sharedExist, path: templatesDir }
        );
      }
    }
    
    /**
     * Install skills from templates
     */
    async function installSkills(templatesDir, targetDir, variables, multiBar, isVerbose) {
      const skillsTemplateDir = join(templatesDir, 'skills');
      const skillsTargetDir = join(targetDir, 'skills');
      
      // Get skill directories
      const skillDirs = await readdir(skillsTemplateDir, { withFileTypes: true });
      const skills = skillDirs.filter(d => d.isDirectory() && d.name.startsWith('gsd-'));
      
      const total = skills.length;
      const bar = multiBar ? createProgressBar(multiBar, 'Skills', total) : null;
      
      let count = 0;
      for (const skill of skills) {
        const srcDir = join(skillsTemplateDir, skill.name);
        const destDir = join(skillsTargetDir, skill.name);
        
        // Copy skill directory
        await copyDirectory(srcDir, destDir);
        
        // Process SKILL.md file
        const skillFile = join(destDir, 'SKILL.md');
        await processTemplateFile(skillFile, variables, isVerbose);
        
        count++;
        if (bar) updateProgress(bar, count);
        logger.verbose(`  → ${skill.name}`, isVerbose);
      }
      
      return count;
    }
    
    /**
     * Install agents from templates
     */
    async function installAgents(templatesDir, targetDir, variables, multiBar, isVerbose) {
      const agentsTemplateDir = join(templatesDir, 'agents');
      const agentsTargetDir = join(targetDir, 'agents');
      
      await ensureDirectory(agentsTargetDir);
      
      // Get agent files
      const agentFiles = await readdir(agentsTemplateDir);
      const agents = agentFiles.filter(f => f.startsWith('gsd-') && f.endsWith('.md'));
      
      const total = agents.length + 1; // +1 for versions.json
      const bar = multiBar ? createProgressBar(multiBar, 'Agents', total) : null;
      
      let count = 0;
      for (const agent of agents) {
        const srcFile = join(agentsTemplateDir, agent);
        const destFile = join(agentsTargetDir, agent);
        
        // Read, process, write
        const content = await readFile(srcFile, 'utf8');
        const processed = renderTemplate(content, variables);
        await writeFile(destFile, processed);
        
        count++;
        if (bar) updateProgress(bar, count);
        logger.verbose(`  → ${agent}`, isVerbose);
      }
      
      // Copy versions.json
      const versionsFile = join(agentsTemplateDir, 'versions.json');
      if (await pathExists(versionsFile)) {
        const content = await readFile(versionsFile, 'utf8');
        const processed = renderTemplate(content, variables);
        await writeFile(join(agentsTargetDir, 'versions.json'), processed);
        count++;
        if (bar) updateProgress(bar, count);
        logger.verbose('  → versions.json', isVerbose);
      }
      
      return agents.length;
    }
    
    /**
     * Install shared directory from templates
     */
    async function installShared(templatesDir, targetDir, variables, multiBar, isVerbose) {
      const sharedTemplateDir = join(templatesDir, 'get-shit-done');
      const sharedTargetDir = join(targetDir, 'get-shit-done');
      
      const bar = multiBar ? createProgressBar(multiBar, 'Shared', 1) : null;
      
      // Copy entire directory
      await copyDirectory(sharedTemplateDir, sharedTargetDir);
      
      // Process manifest template
      const manifestFile = join(sharedTargetDir, '.gsd-install-manifest.json');
      if (await pathExists(manifestFile)) {
        await processTemplateFile(manifestFile, variables, isVerbose);
      }
      
      if (bar) updateProgress(bar, 1);
      logger.verbose('  → get-shit-done/', isVerbose);
      
      return 1;
    }
    
    /**
     * Process template file (read, replace variables, write)
     */
    async function processTemplateFile(filePath, variables, isVerbose) {
      const content = await readFile(filePath, 'utf8');
      
      // Find unknown variables and warn
      const unknown = findUnknownVariables(content, variables);
      if (unknown.length > 0 && isVerbose) {
        logger.warn(`Unknown variables in ${filePath}: ${unknown.join(', ')}`);
      }
      
      const processed = renderTemplate(content, variables);
      await writeFile(filePath, processed);
    }
    
    /**
     * Generate installation manifest
     */
    async function generateManifest(targetDir, stats, isGlobal) {
      const manifestPath = join(targetDir, 'get-shit-done', '.gsd-install-manifest.json');
      
      const manifest = {
        version: '2.0.0',
        platform: 'claude',
        scope: isGlobal ? 'global' : 'local',
        installedAt: new Date().toISOString(),
        stats: {
          skills: stats.skills,
          agents: stats.agents
        }
      };
      
      await writeFile(manifestPath, JSON.stringify(manifest, null, 2));
    }
    ```
    
    Test orchestrator (will fail without templates, but should import):
    ```bash
    node -e "import('./bin/lib/installer/orchestrator.js').then(() => console.log('✓ Orchestrator loads'))"
    ```
  </action>
  <verify>
    ```bash
    # Check orchestrator exists
    test -f bin/lib/installer/orchestrator.js && echo "✓ Orchestrator exists"
    
    # Check key functions
    grep -q "export async function install" bin/lib/installer/orchestrator.js && echo "✓ install function defined"
    grep -q "async function installSkills" bin/lib/installer/orchestrator.js && echo "✓ installSkills defined"
    grep -q "async function installAgents" bin/lib/installer/orchestrator.js && echo "✓ installAgents defined"
    grep -q "async function installShared" bin/lib/installer/orchestrator.js && echo "✓ installShared defined"
    grep -q "async function generateManifest" bin/lib/installer/orchestrator.js && echo "✓ generateManifest defined"
    
    # Test import
    node -e "import('./bin/lib/installer/orchestrator.js').then(() => console.log('✓ Module loads'))" 2>&1 | grep -q "Module loads"
    ```
  </verify>
  <done>bin/lib/installer/orchestrator.js with install() function coordinating skills, agents, shared installation, progress bars, and manifest generation</done>
</task>

<task name="end-to-end-manual-test" type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete installer for Claude Code:
    - CLI with commander (--claude, --global, --local, --verbose flags)
    - Installation orchestrator (3 phases: skills, agents, shared)
    - Template processing (variable replacement)
    - Progress bars (cli-progress multi-bar display)
    - Error handling (custom errors with exit codes)
    - Manifest generation (.gsd-install-manifest.json)
  </what-built>
  <how-to-verify>
    **Test 1: Local installation (default)**
    ```bash
    # Run installer
    cd /tmp && mkdir gsd-test-local && cd gsd-test-local
    node /Users/rodolfo/croonix-github/gsd/get-shit-done-multi/bin/install.js --claude --local
    
    # Verify structure
    ls -la .claude/
    ls .claude/skills/ | head -5
    ls .claude/agents/ | head -5
    ls .claude/get-shit-done/
    
    # Check manifest
    cat .claude/get-shit-done/.gsd-install-manifest.json
    
    # Check template variables were replaced
    grep "PLATFORM_ROOT" .claude/skills/gsd-new-project/SKILL.md
    # Should be EMPTY (variables replaced)
    
    # Check actual content
    grep ".claude" .claude/skills/gsd-new-project/SKILL.md | head -3
    # Should show .claude paths
    ```
    
    **Test 2: Global installation**
    ```bash
    # Run installer (WARNING: modifies ~/.claude/)
    # Skip if you have existing Claude installation
    node /path/to/bin/install.js --claude --global
    
    # Verify structure
    ls ~/.claude/skills/ | head -5
    ls ~/.claude/agents/ | head -5
    
    # Check manifest
    cat ~/.claude/get-shit-done/.gsd-install-manifest.json
    ```
    
    **Test 3: Verbose mode**
    ```bash
    cd /tmp && mkdir gsd-test-verbose && cd gsd-test-verbose
    node /path/to/bin/install.js --claude --local --verbose
    
    # Should show file-by-file progress instead of progress bars
    # Check terminal output shows individual files
    ```
    
    **Test 4: Error handling**
    ```bash
    # Missing --claude flag
    node /path/to/bin/install.js
    # Should show error and exit code 2
    
    # Help text
    node /path/to/bin/install.js --help
    # Should show usage information
    
    # Version
    node /path/to/bin/install.js --version
    # Should show 2.0.0
    ```
    
    **Success criteria:**
    - ✓ Skills installed to .claude/skills/gsd-*/ (29 directories)
    - ✓ Agents installed to .claude/agents/gsd-*.md (13 files)
    - ✓ Shared directory at .claude/get-shit-done/
    - ✓ Manifest file created with correct metadata
    - ✓ Template variables replaced (no {{PLATFORM_ROOT}} in output)
    - ✓ Progress bars show during installation
    - ✓ Summary message shows counts and next steps
    - ✓ --verbose shows file-by-file progress
    - ✓ Error handling works (missing --claude shows error)
  </how-to-verify>
  <resume-signal>
    Type "PASS" if all tests succeed, or describe issues found.
  </resume-signal>
</task>

## Verification

After completing tasks 1-2:

```bash
# 1. CLI parsing test
node bin/install.js --help
node bin/install.js --version
node bin/install.js 2>&1 | grep -q "Missing required flag"

# 2. Orchestrator integration test
node -e "import('./bin/lib/installer/orchestrator.js').then(() => console.log('OK'))"

# 3. Full installer structure check
ls -R bin/lib/

# 4. Dependency check
npm list cli-progress commander chalk fs-extra
```

Expected outcomes:
- Help and version work
- Missing --claude shows error
- Orchestrator module loads
- All dependencies installed

**Manual checkpoint (Task 3):** Will verify end-to-end installation flow with actual templates.

## Success Criteria

- [ ] bin/install.js: commander CLI parsing with --claude, --global, --local, --verbose flags
- [ ] bin/install.js: Flag validation (error if --claude missing, error if both --global and --local)
- [ ] bin/install.js: Banner display with version
- [ ] bin/install.js: Error handling with InstallError and exit codes
- [ ] orchestrator.js: install() function coordinates all phases
- [ ] orchestrator.js: installSkills() copies 29 skills with template processing
- [ ] orchestrator.js: installAgents() copies 13 agents + versions.json with template processing
- [ ] orchestrator.js: installShared() copies get-shit-done directory
- [ ] orchestrator.js: Progress bars in non-verbose mode, file-by-file in verbose mode
- [ ] orchestrator.js: generateManifest() creates .gsd-install-manifest.json with metadata
- [ ] Template variables replaced: {{PLATFORM_ROOT}}, {{COMMAND_PREFIX}}, {{VERSION}}
- [ ] Unknown variables logged as warnings (not errors)
- [ ] Existing installation detected and warning shown

## Output

**Files Created:**
- bin/lib/installer/orchestrator.js

**Files Updated:**
- bin/install.js (commander integration, orchestration call, error handling)

**Functionality:** Working `npx get-shit-done-multi --claude` command that installs skills, agents, and shared directory with progress feedback

**Next:** Plan 04 will add comprehensive test infrastructure and integration test suites
