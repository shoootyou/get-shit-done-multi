---
phase: 12-unify-frontmatter-structure-and-apply-adapter-pattern
plan: 02
type: execute
wave: 2
depends_on: [12-01]
files_modified:
  - bin/lib/serialization/claude-serializer.js
  - bin/lib/serialization/copilot-serializer.js
  - bin/lib/serialization/codex-serializer.js
  - bin/lib/serialization/claude-cleaner.js
  - bin/lib/serialization/copilot-cleaner.js
  - bin/lib/serialization/codex-cleaner.js
  - bin/lib/platforms/claude-adapter.js
  - bin/lib/platforms/copilot-adapter.js
  - bin/lib/platforms/codex-adapter.js
  - bin/lib/templates/template-renderer.js
autonomous: true

must_haves:
  truths:
    - "Each platform has its own serializer with full logic (no shared conditional code)"
    - "Each platform has its own cleaner importing its own serializer"
    - "Platform adapters import platform-specific serializers/cleaners"
    - "Template renderer is in templates/ module (not serialization/)"
    - "Code runs without errors after split"
  artifacts:
    - path: "bin/lib/serialization/claude-serializer.js"
      provides: "Claude YAML serialization logic"
      exports: ["serializeFrontmatter"]
      min_lines: 100
    - path: "bin/lib/serialization/copilot-serializer.js"
      provides: "Copilot YAML serialization logic"
      exports: ["serializeFrontmatter"]
      min_lines: 100
    - path: "bin/lib/serialization/codex-serializer.js"
      provides: "Codex YAML serialization logic"
      exports: ["serializeFrontmatter"]
      min_lines: 100
    - path: "bin/lib/serialization/claude-cleaner.js"
      provides: "Claude frontmatter cleaning"
      exports: ["cleanFrontmatter"]
      min_lines: 30
    - path: "bin/lib/serialization/copilot-cleaner.js"
      provides: "Copilot frontmatter cleaning"
      exports: ["cleanFrontmatter"]
      min_lines: 30
    - path: "bin/lib/serialization/codex-cleaner.js"
      provides: "Codex frontmatter cleaning"
      exports: ["cleanFrontmatter"]
      min_lines: 30
    - path: "bin/lib/templates/template-renderer.js"
      provides: "General EJS template rendering"
      min_lines: 20
  key_links:
    - from: "bin/lib/platforms/claude-adapter.js"
      to: "../serialization/claude-serializer.js"
      via: "explicit import"
      pattern: "from ['\"]../serialization/claude-serializer"
    - from: "bin/lib/platforms/copilot-adapter.js"
      to: "../serialization/copilot-serializer.js"
      via: "explicit import"
      pattern: "from ['\"]../serialization/copilot-serializer"
    - from: "bin/lib/platforms/codex-adapter.js"
      to: "../serialization/codex-serializer.js"
      via: "explicit import"
      pattern: "from ['\"]../serialization/codex-serializer"
    - from: "bin/lib/serialization/claude-cleaner.js"
      to: "./claude-serializer.js"
      via: "cleaner uses serializer"
      pattern: "from ['\"]./claude-serializer"
---

<objective>
Split shared frontmatter serializer and cleaner into per-platform files following Phase 11 validator pattern, and relocate template-renderer.js to bin/lib/templates/

**Purpose:** Achieve platform isolation (changes to Claude don't affect Copilot), consistent with Phase 11 architecture

**Output:** 6 per-platform files (3 serializers + 3 cleaners), template-renderer in correct module, adapters using platform-specific imports
</objective>

<execution_context>
@.github/get-shit-done/workflows/execute-plan.md
@.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-unify-frontmatter-structure-and-apply-adapter-pattern/12-01-CONTEXT.md
@.planning/phases/12-unify-frontmatter-structure-and-apply-adapter-pattern/12-RESEARCH.md

# Reference Phase 11's per-platform pattern
@.planning/phases/11-skill-validation-and-adapter-system/11-02-SUMMARY.md

# Current shared implementation to split
@bin/lib/serialization/frontmatter-serializer.js
@bin/lib/serialization/frontmatter-cleaner.js

# Platform adapters that will import per-platform serializers
@bin/lib/platforms/claude-adapter.js
@bin/lib/platforms/copilot-adapter.js
@bin/lib/platforms/codex-adapter.js
</context>

<tasks>

<task type="auto">
  <name>Task 2: Split frontmatter-serializer.js into per-platform serializers</name>
  <files>
    bin/lib/serialization/claude-serializer.js
    bin/lib/serialization/copilot-serializer.js
    bin/lib/serialization/codex-serializer.js
  </files>
  <action>
Read the current shared serializer to understand platform-specific logic:
```bash
cat bin/lib/serialization/frontmatter-serializer.js
```

Create three new serializers, each with FULL serialization logic (duplicate code, not shared):

**bin/lib/serialization/claude-serializer.js:**
```javascript
export function serializeFrontmatter(data) {
  // Full serialization logic from current shared serializer
  // Claude-specific: arrays as block style (multi-line)
  // Example: skills:\n  - gsd-help\n  - gsd-verify
  // No platform parameter needed - logic is baked in
}
```

**bin/lib/serialization/copilot-serializer.js:**
```javascript
export function serializeFrontmatter(data) {
  // Full serialization logic (duplicated from claude)
  // Copilot-specific: arrays as flow style (single-line with brackets)
  // Example: skills: ['gsd-help', 'gsd-verify']
}
```

**bin/lib/serialization/codex-serializer.js:**
```javascript
export function serializeFrontmatter(data) {
  // Full serialization logic (duplicated)
  // Codex-specific: flow style + special quoting rules
}
```

**Key principles (from Phase 11 pattern):**
- Each serializer is fully independent (no shared imports between them)
- Code duplication is acceptable and preferred over coupling
- No platform parameter - platform logic is baked into each serializer
- If Claude serializer needs a fix, only claude-serializer.js changes

**Platform-specific array formatting:**
- Claude: Block style YAML (multi-line)
- Copilot: Flow style YAML (single-line with brackets)
- Codex: Flow style YAML with special quoting

Do NOT delete the shared frontmatter-serializer.js yet (Wave 3 cleanup after adapters updated).
  </action>
  <verify>
```bash
# 1. Three serializers exist
ls -1 bin/lib/serialization/*-serializer.js | wc -l
# Expected: 4 (claude, copilot, codex, + old shared one still there)

# 2. Each exports serializeFrontmatter
for file in bin/lib/serialization/claude-serializer.js bin/lib/serialization/copilot-serializer.js bin/lib/serialization/codex-serializer.js; do
  grep -q "export function serializeFrontmatter" "$file" || echo "Missing export in $file"
done

# 3. Syntax check
node --check bin/lib/serialization/claude-serializer.js
node --check bin/lib/serialization/copilot-serializer.js
node --check bin/lib/serialization/codex-serializer.js
```
  </verify>
  <done>
- Three platform-specific serializers created (claude, copilot, codex)
- Each contains full serialization logic (no shared imports)
- Each has platform-specific array formatting logic
- All files pass syntax validation
- Old shared serializer still present (deleted after adapters updated)
  </done>
</task>

<task type="auto">
  <name>Task 3: Split frontmatter-cleaner.js into per-platform cleaners and update adapter imports</name>
  <files>
    bin/lib/serialization/claude-cleaner.js
    bin/lib/serialization/copilot-cleaner.js
    bin/lib/serialization/codex-cleaner.js
    bin/lib/platforms/claude-adapter.js
    bin/lib/platforms/copilot-adapter.js
    bin/lib/platforms/codex-adapter.js
  </files>
  <action>
Read the current shared cleaner:
```bash
cat bin/lib/serialization/frontmatter-cleaner.js
```

Create three platform-specific cleaners, each importing its own serializer:

**bin/lib/serialization/claude-cleaner.js:**
```javascript
import { serializeFrontmatter } from './claude-serializer.js';

export function cleanFrontmatter(content) {
  // Parse frontmatter from content
  // Remove unsupported fields
  // Rebuild using claude-serializer
  // Return complete content with cleaned frontmatter
}
```

**bin/lib/serialization/copilot-cleaner.js:**
```javascript
import { serializeFrontmatter } from './copilot-serializer.js';

export function cleanFrontmatter(content) {
  // Same logic, uses copilot-serializer
}
```

**bin/lib/serialization/codex-cleaner.js:**
```javascript
import { serializeFrontmatter } from './codex-serializer.js';

export function cleanFrontmatter(content) {
  // Same logic, uses codex-serializer
}
```

Update platform adapters to use platform-specific serializers and cleaners:

**bin/lib/platforms/claude-adapter.js:**
- Change: `from '../serialization/frontmatter-serializer.js'` → `from '../serialization/claude-serializer.js'`
- Change: `from '../serialization/frontmatter-cleaner.js'` → `from '../serialization/claude-cleaner.js'`

**bin/lib/platforms/copilot-adapter.js:**
- Change: `from '../serialization/frontmatter-serializer.js'` → `from '../serialization/copilot-serializer.js'`
- Change: `from '../serialization/frontmatter-cleaner.js'` → `from '../serialization/copilot-cleaner.js'`

**bin/lib/platforms/codex-adapter.js:**
- Change: `from '../serialization/frontmatter-serializer.js'` → `from '../serialization/codex-serializer.js'`
- Change: `from '../serialization/frontmatter-cleaner.js'` → `from '../serialization/codex-cleaner.js'`

After adapters updated, delete old shared files:
```bash
rm bin/lib/serialization/frontmatter-serializer.js
rm bin/lib/serialization/frontmatter-cleaner.js
```

Verify no references to old shared files remain:
```bash
grep -r "frontmatter-serializer.js" bin/ tests/ --include="*.js"
grep -r "frontmatter-cleaner.js" bin/ tests/ --include="*.js"
# Expected: No results (or only test files, which will be updated in Plan 03)
```
  </action>
  <verify>
```bash
# 1. Three cleaners exist
ls -1 bin/lib/serialization/*-cleaner.js | wc -l
# Expected: 3 (claude, copilot, codex)

# 2. Each cleaner imports its own serializer
grep -q "from './claude-serializer" bin/lib/serialization/claude-cleaner.js
grep -q "from './copilot-serializer" bin/lib/serialization/copilot-cleaner.js
grep -q "from './codex-serializer" bin/lib/serialization/codex-cleaner.js

# 3. Platform adapters use platform-specific imports
grep -q "from '../serialization/claude-serializer" bin/lib/platforms/claude-adapter.js
grep -q "from '../serialization/copilot-serializer" bin/lib/platforms/copilot-adapter.js
grep -q "from '../serialization/codex-serializer" bin/lib/platforms/codex-adapter.js

# 4. Old shared files deleted
! ls bin/lib/serialization/frontmatter-serializer.js 2>/dev/null
! ls bin/lib/serialization/frontmatter-cleaner.js 2>/dev/null

# 5. Syntax check all modified files
find bin/lib/serialization/ bin/lib/platforms/ -name "*.js" -exec node --check {} \;
```
  </verify>
  <done>
- Three platform-specific cleaners created
- Each cleaner imports its own platform serializer
- All three platform adapters updated to use platform-specific imports
- Old shared frontmatter-serializer.js and frontmatter-cleaner.js deleted
- No references to old shared files remain in bin/
- All files pass syntax validation
- Platform isolation achieved (claude changes don't affect copilot)
  </done>
</task>

<task type="auto">
  <name>Task 4: Move template-renderer.js to bin/lib/templates/ and update imports</name>
  <files>
    bin/lib/templates/template-renderer.js
    bin/lib/installer/install-shared.js
    bin/lib/installer/install-platform-instructions.js
    bin/lib/installer/install-agents.js
    bin/lib/installer/install-skills.js
  </files>
  <action>
Create bin/lib/templates/ directory:
```bash
mkdir -p bin/lib/templates
```

Move template-renderer.js using git to preserve history:
```bash
git mv bin/lib/serialization/template-renderer.js bin/lib/templates/
```

Find all files importing template-renderer:
```bash
grep -r "template-renderer.js" bin/ tests/ --include="*.js" -l
```

Update imports in installer modules:
- Change: `from '../serialization/template-renderer.js'` → `from '../templates/template-renderer.js'`

Files likely affected:
- bin/lib/installer/install-shared.js
- bin/lib/installer/install-platform-instructions.js
- bin/lib/installer/install-agents.js
- bin/lib/installer/install-skills.js

Verify no old path references remain:
```bash
grep -r "serialization/template-renderer" bin/ tests/ --include="*.js"
# Expected: No results
```

Syntax check:
```bash
node --check bin/lib/templates/template-renderer.js
find bin/lib/installer/ -name "*.js" -exec node --check {} \;
```

**Why separate templates/ module:**
- template-renderer.js handles general EJS rendering (not YAML serialization)
- Separation of concerns: serialization/ is frontmatter-specific, templates/ is general
- Clearer architecture: rendering templates ≠ serializing YAML
  </action>
  <verify>
```bash
# 1. template-renderer.js moved to templates/
ls bin/lib/templates/template-renderer.js

# 2. Old location empty
! ls bin/lib/serialization/template-renderer.js 2>/dev/null

# 3. All imports updated
grep -r "from.*templates/template-renderer" bin/lib/installer/ --include="*.js" | wc -l
# Expected: 4+ (number of installer modules using it)

# 4. No old serialization/template-renderer references
! grep -r "serialization/template-renderer" bin/ tests/ --include="*.js"

# 5. Syntax validation
node --check bin/lib/templates/template-renderer.js
find bin/lib/installer/ -name "*.js" -exec node --check {} \; 2>&1 | grep -i error && exit 1 || exit 0
```
  </verify>
  <done>
- bin/lib/templates/ directory created
- template-renderer.js moved to templates/ with git history preserved
- All installer module imports updated (4+ files)
- No references to old serialization/template-renderer path remain
- All files pass syntax validation
- Module structure finalized: frontmatter/ (validators), serialization/ (per-platform serializers/cleaners), templates/ (general rendering)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Per-platform isolation:**
   - 3 serializers: claude, copilot, codex (each with full logic)
   - 3 cleaners: claude, copilot, codex (each importing its own serializer)
   - No shared serialization code with platform conditionals

2. **Adapter integration:**
   - claude-adapter.js imports claude-serializer.js and claude-cleaner.js
   - copilot-adapter.js imports copilot-serializer.js and copilot-cleaner.js
   - codex-adapter.js imports codex-serializer.js and codex-cleaner.js

3. **Module structure:**
   - bin/lib/serialization/ contains only per-platform serializers and cleaners
   - bin/lib/templates/ contains template-renderer.js
   - No shared frontmatter-serializer.js or frontmatter-cleaner.js

4. **Import integrity:**
   - All imports reference platform-specific files
   - No broken import paths
   - All files pass syntax validation

5. **Pattern consistency:**
   - Serialization follows same per-platform pattern as Phase 11 validators
   - Code duplication over coupling
   - Platform changes are isolated
</verification>

<success_criteria>
Wave 2-3 migration complete when:
- [ ] 3 platform serializers created with full logic
- [ ] 3 platform cleaners created importing their own serializers
- [ ] All 3 platform adapters use platform-specific imports
- [ ] Old shared serializer/cleaner deleted
- [ ] template-renderer.js moved to bin/lib/templates/
- [ ] All installer imports updated
- [ ] All files pass syntax validation
- [ ] Platform isolation verified (changes to one platform don't affect others)
- [ ] Ready for Wave 4 (documentation and full testing)
</success_criteria>

<output>
After completion, create `.planning/phases/12-unify-frontmatter-structure-and-apply-adapter-pattern/12-02-SUMMARY.md`

Include:
- Files created (6 per-platform files)
- Files moved (template-renderer.js)
- Files deleted (2 shared files)
- Import updates count
- Platform isolation verification
- Readiness for Wave 4 (documentation and testing)
</output>
