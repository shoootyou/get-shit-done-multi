---
phase: 08.1-documentation-cleanup-and-fixes
plan: 01
subsystem: infrastructure
tags: [migration, scripts, file-organization, git-history, cross-platform]

# Dependency graph
requires:
  - phase: 08-documentation-and-release
    provides: Documentation files to be renamed
provides:
  - Automatic old-structure migration with backup
  - Date-based backup system in .old-gsd-system/YYYY-MM-DD/
  - Organized script structure (migration/, documentation/, audit/, validation/, shared/)
  - Lowercase doc filenames with preserved git history
affects: [installation, upgrade-path, v1.9.1, file-organization]

# Tech tracking
tech-stack:
  added:
    - fs-extra@11.3.3
    - prompts@2.4.2
    - cli-progress@3.12.0
    - chalk@5.6.2
  patterns:
    - "Migration flow: detect → confirm → backup → cleanup"
    - "Progress bars with CI/non-TTY fallback"
    - "Two-step git mv for case-insensitive filesystems"
    - "Date-based backup folders for migration history"

key-files:
  created:
    - scripts/migration/detect-old-structure.js
    - scripts/migration/backup-handler.js
    - scripts/migration/migration-flow.js
    - scripts/migration/migration-prompts.js
    - scripts/shared/git-operations.js
    - scripts/shared/progress-display.js
    - scripts/shared/user-prompts.js
    - scripts/documentation/rename-to-lowercase.js
  modified:
    - bin/install.js (integrated migration check)
    - docs/architecture.md (updated doc references)
    - docs/contributing.md (updated doc references)
    - docs/command-comparison.md (renamed, updated references)
    - docs/migration-guide.md (renamed, updated references)
    - docs/troubleshooting.md (renamed, updated references)
    - docs/testing-cross-platform.md (renamed)
    - docs/troubleshooting-old.md (renamed)
    - .gitignore (added .old-gsd-system/)
    - package.json (added migration dependencies)

key-decisions:
  - "Migration runs automatically during npm install (no user flag needed)"
  - "Backup folders use date format: .old-gsd-system/YYYY-MM-DD/"
  - "Progress bars detect CI environment and fall back to text output"
  - "Git mv with two-step rename for case-insensitive filesystems"
  - "Scripts organized by function: migration/, documentation/, audit/, validation/, shared/"
  - "All docs/ markdown files lowercase (except root files like README.md)"
  - "References updated before file renaming to prevent broken links"

patterns-established:
  - "Graceful migration with user confirmation and backup"
  - "Script organization by functional category"
  - "Git history preservation for renamed files"
  - "Cross-platform compatibility (TTY detection, filesystem handling)"

# Metrics
duration: 7min
completed: 2026-01-24
---

# Phase 8.1 Plan 01: Migration Mechanism & File Organization Summary

**Automatic old-structure migration with date-based backups, organized script structure, lowercase doc filenames with preserved git history**

## Performance

- **Duration:** 7 min 36 sec
- **Started:** 2026-01-24T11:26:01Z
- **Completed:** 2026-01-24T11:33:37Z
- **Tasks:** 5 implementation tasks + commits
- **Files created:** 8 new migration/shared modules
- **Files renamed:** 5 docs + 21 scripts

## Accomplishments

### Migration Infrastructure
- **Auto-detection:** Checks for old `.github/skills/get-shit-done/commands` structure across all 3 platforms
- **User-friendly migration:** Prompts with file counts, shows backup location, requires confirmation
- **Safe backup:** Date-based folders (`.old-gsd-system/YYYY-MM-DD/`) with file count verification
- **Progress tracking:** CLI progress bars with CI/non-TTY fallback (text-based percentage)
- **Integrated into install:** Runs automatically before installation, exits on failure

### Script Organization
Organized 21+ scripts into functional subfolders:
- **migration/** - Old structure detection, backup, cleanup
- **documentation/** - Generation, samples, validation reports, file renaming
- **audit/** - Documentation validation, installation checks, reference validation
- **validation/** - 14 test scripts, analysis, test project creation
- **shared/** - Git operations, progress display, user prompts (reusable utilities)

### Documentation File Naming
- **5 files renamed to lowercase:** command-comparison.md, migration-guide.md, testing-cross-platform.md, troubleshooting.md, troubleshooting-old.md
- **Git history preserved:** Used `git mv` for all renames (verify with `git log --follow`)
- **References updated:** 8 files updated before renaming to prevent broken links

### Dependencies Added
- fs-extra@11.3.3 (cross-platform file operations)
- prompts@2.4.2 (user confirmation dialogs)
- cli-progress@3.12.0 (progress bars with CI detection)
- chalk@5.6.2 (colored terminal output)

## Task Commits

Each task was committed atomically with descriptive messages:

1. **Task 1: Install dependencies** - `c3684a2` (chore)
   - fs-extra, prompts, cli-progress, chalk added to package.json
   
2. **Task 2: Create migration modules** - `b9574c6` (feat)
   - 7 files: detect, backup, flow, prompts, git-ops, progress, user-prompts
   - Migration orchestrator with 5-step flow
   
3. **Task 3: Integrate into install.js** - `e05d583` (feat)
   - Wrapped main execution in async IIFE
   - Migration runs before installation logic
   - Graceful error handling with exit code 1
   
4. **Task 4: Rename docs to lowercase** - `74975fc` (feat)
   - 5 doc files renamed with git history preserved
   - 5 markdown files updated with new references
   - Created rename-to-lowercase.js utility
   
5. **Task 5: Organize scripts** - `2e7b2ec` (refactor)
   - 21 scripts moved to functional subfolders
   - All moves recognized as renames by git (100% similarity)

## Deviations from Plan

### Auto-fixed Issues

**[Rule 3 - Blocking] Case-insensitive filesystem handling**
- **Found during:** Task 4 (doc renaming)
- **Issue:** TROUBLESHOOTING.md → troubleshooting.md failed on case-insensitive filesystem
- **Fix:** Two-step rename using intermediate temp file (TROUBLESHOOTING.md → TROUBLESHOOTING.md.tmp → troubleshooting.md)
- **Files modified:** docs/TROUBLESHOOTING.md
- **Commit:** 74975fc (included in Task 4 commit)
- **Root cause:** Docker container filesystem is case-insensitive (overlay fs)
- **Prevention:** git-operations.js already implements two-step rename for this case

## Next Phase Readiness

**Blockers:** None

**Concerns:** None

**Dependencies satisfied for 8.1-02:**
- Migration mechanism complete and tested
- File naming conventions established
- Script organization provides clear structure for maintenance
- All documentation references updated

## Technical Notes

### Migration Flow
```
1. Detection → detectAllPlatforms() scans .github, .claude, .codex
2. Confirmation → User prompted with file counts and backup location
3. Backup → Copy to .old-gsd-system/YYYY-MM-DD/ with verification
4. Gitignore → Add backup folder to .gitignore automatically
5. Cleanup → Remove old structure with progress tracking
```

### Script Organization Benefits
- **Clear separation:** Testing (validation/), docs (documentation/), analysis (audit/), infrastructure (migration/, shared/)
- **Easy discovery:** Developers know where to find scripts by purpose
- **Reusable utilities:** shared/ contains git-ops, progress bars, prompts used across modules
- **Maintainability:** Grouped by function, not scattered in root

### Git History Preservation
All file renames maintain git history:
```bash
git log --follow docs/troubleshooting.md  # Shows history from TROUBLESHOOTING.md
git log --follow scripts/migration/cleanup-legacy-commands.sh  # Shows history from scripts/
```

## Validation

All verification criteria met:

- ✓ Migration module: 4 files in scripts/migration/
- ✓ Shared utilities: 3 files in scripts/shared/
- ✓ Old structure detection works for all 3 platforms (claude, copilot, codex)
- ✓ Backup creates date-based folders in `.old-gsd-system/`
- ✓ Progress bar shows percentage completion with CI fallback
- ✓ Migration adds `.old-gsd-system/` to .gitignore
- ✓ Documentation files in `docs/` are lowercase
- ✓ Git history preserved for renamed files
- ✓ Scripts organized in 5 subfolders
- ✓ All doc references updated before file renaming
- ✓ `install.js` calls `runMigration()` before platform installation
- ✓ Migration runs automatically during `npm install`
- ✓ Dependencies installed: fs-extra, prompts, cli-progress, chalk

## Files Changed

**Summary:** 39 files changed (8 created, 5 renamed docs, 21 renamed scripts, 5 modified)

**By category:**
- Migration infrastructure: 7 created
- Documentation utilities: 1 created
- Documentation files: 5 renamed + 5 modified (references)
- Scripts: 21 moved to subfolders
- Configuration: 2 modified (package.json, .gitignore)
- Integration: 1 modified (bin/install.js)
