---
phase: 10-milestone-completion-workflow-unification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/skills/gsd-complete-milestone/SKILL.md
  - templates/get-shit-done/workflows/complete-milestone.md
autonomous: true

must_haves:
  truths:
    - "gsd-complete-milestone archives directly to history/v{X.Y}/ with mirrored .planning/ structure"
    - "User receives combined readiness + archive confirmation via AskUserQuestion"
    - "Optional git tag creation uses AskUserQuestion"
    - "Workspace is clean after completion (only PROJECT, MILESTONES, config, codebase remain)"
    - "All file moves are atomic with git tracking"
  artifacts:
    - path: "templates/skills/gsd-complete-milestone/SKILL.md"
      provides: "Unified completion workflow with direct history/ archiving"
      min_lines: 100
    - path: "templates/get-shit-done/workflows/complete-milestone.md"
      provides: "Atomic file operations for history/ archiving"
      min_lines: 50
  key_links:
    - from: "templates/skills/gsd-complete-milestone/SKILL.md"
      to: "templates/get-shit-done/workflows/complete-milestone.md"
      via: "@-reference in execution_context"
      pattern: "@.*complete-milestone\\.md"
    - from: "templates/get-shit-done/workflows/complete-milestone.md"
      to: "git-identity-helpers.sh"
      via: "source command for commit_as_user"
      pattern: "source.*git-identity-helpers"
---

<objective>
Refactor gsd-complete-milestone to archive directly to history/v{X.Y}/ with mirrored .planning/ structure and unified user confirmations via AskUserQuestion.

Purpose: Eliminate multi-step archive workflow (complete → archive → restore) in favor of single atomic operation that archives to permanent history/.
Output: Updated SKILL.md and workflow.md that archive directly to history/ with AskUserQuestion confirmations.
</objective>

<execution_context>
@.github/get-shit-done/workflows/execute-plan.md
@.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-milestone-completion-workflow-unification/10-01-CONTEXT.md
@.planning/phases/10-milestone-completion-workflow-unification/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor complete-milestone SKILL.md</name>
  <files>templates/skills/gsd-complete-milestone/SKILL.md</files>
  <action>
Update gsd-complete-milestone SKILL.md to implement unified workflow:

**Key changes:**
1. Update objective to reflect direct history/ archiving
2. Add confirmation step using AskUserQuestion with combined readiness + archive confirmation:
   - Header: "Ready to Complete?"
   - Question: "Complete milestone v{X.Y}? This will archive all files to history/v{X.Y}/"
   - Show milestone stats (phases, plans, requirements)
   - Options: "Complete and archive" or "Cancel"
3. Replace archive reference with direct history/ operations:
   - Create `.planning/history/v{X.Y}/` directory
   - Move ROADMAP, STATE, PROJECT, REQUIREMENTS to history/v{X.Y}/
   - Move phases/, research/, todos/ subdirectories to history/v{X.Y}/
   - Use `2>/dev/null || true` for optional files (research/, todos/)
4. Add git tag confirmation step using AskUserQuestion:
   - Header: "Git Tag"
   - Question: "Create git tag v{X.Y}?"
   - Options: "Create tag" or "Skip"
5. Update success criteria to reflect clean workspace (only PROJECT, MILESTONES, config, codebase remain)
6. Update execution_context to reference complete-milestone.md workflow
7. Remove any references to archive-milestone or restore-milestone commands

**Pattern to follow:**
- Use AskUserQuestion for all confirmations (per RESEARCH.md Pattern 2)
- Source git-identity-helpers.sh before git operations (per RESEARCH.md Pattern 3)
- Use atomic `mv` operations (per RESEARCH.md Pattern 1)
- Display stage banner for completion (per RESEARCH.md Pattern 4)

**What to avoid:**
- Manual text prompts like "Type 'yes' to continue"
- Individual file move confirmations (use bulk confirmation)
- Non-atomic operations (no cp then rm)
  </action>
  <verify>
```bash
# Check SKILL.md has AskUserQuestion confirmations
grep -q "AskUserQuestion" templates/skills/gsd-complete-milestone/SKILL.md

# Check history/ archiving logic present
grep -q "history/v" templates/skills/gsd-complete-milestone/SKILL.md

# Check git-identity-helpers sourcing
grep -q "git-identity-helpers" templates/skills/gsd-complete-milestone/SKILL.md

# Check no references to deprecated commands
! grep -q "archive-milestone\|restore-milestone" templates/skills/gsd-complete-milestone/SKILL.md
```
  </verify>
  <done>
SKILL.md uses AskUserQuestion for confirmations, archives directly to history/v{X.Y}/ with mirrored structure, uses git-identity-helpers for commits, and has no references to deprecated commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update complete-milestone workflow</name>
  <files>templates/get-shit-done/workflows/complete-milestone.md</files>
  <action>
Update complete-milestone workflow to implement atomic archiving to history/:

**Key changes:**
1. Update workflow objective to reflect direct history/ archiving
2. Add section for creating history/v{X.Y}/ directory structure
3. Update file move operations to target history/v{X.Y}/:
   - `mkdir -p .planning/history/v{X.Y}/`
   - `mv .planning/ROADMAP.md .planning/history/v{X.Y}/`
   - `mv .planning/STATE.md .planning/history/v{X.Y}/`
   - `mv .planning/PROJECT.md .planning/history/v{X.Y}/`
   - `mv .planning/REQUIREMENTS.md .planning/history/v{X.Y}/ 2>/dev/null || true`
   - `mv .planning/phases .planning/history/v{X.Y}/ 2>/dev/null || true`
   - `mv .planning/research .planning/history/v{X.Y}/ 2>/dev/null || true`
   - `mv .planning/todos .planning/history/v{X.Y}/ 2>/dev/null || true`
4. Update git operations:
   - `git add .planning/history/v{X.Y}/`
   - `git add -u .planning/` (stages deletions)
   - Use `commit_as_user` with descriptive message
5. Add optional git tag creation with `git tag v{X.Y}`
6. Update workspace verification to confirm only PROJECT, MILESTONES, config, codebase remain
7. Remove any references to milestones/ directory or archive-milestone workflow

**Pattern to follow:**
- Atomic `mv` operations (per RESEARCH.md Pattern 1)
- Git identity preservation (per RESEARCH.md Pattern 3)
- Batch git operations (all adds before commit)

**What to avoid:**
- Non-atomic operations (cp then rm)
- Missing optional file handling (|| true pattern)
- Forgetting git add -u for deletions
  </action>
  <verify>
```bash
# Check workflow has history/ directory creation
grep -q "history/v" templates/get-shit-done/workflows/complete-milestone.md

# Check atomic mv operations present
grep -q "mv .planning/" templates/get-shit-done/workflows/complete-milestone.md

# Check optional file handling
grep -q "2>/dev/null || true" templates/get-shit-done/workflows/complete-milestone.md

# Check git operations include deletions
grep -q "git add -u" templates/get-shit-done/workflows/complete-milestone.md

# Check no references to milestones/ directory
! grep -q "milestones/" templates/get-shit-done/workflows/complete-milestone.md
```
  </verify>
  <done>
Workflow implements atomic file moves to history/v{X.Y}/ with mirrored structure, git tracking includes deletions, optional files handled safely, and no references to deprecated milestones/ directory.
  </done>
</task>

</tasks>

<verification>
After completion:
1. Read updated SKILL.md to confirm AskUserQuestion usage and history/ logic
2. Read updated workflow.md to confirm atomic operations and git tracking
3. Verify no references to deprecated commands remain
4. Check git-identity-helpers.sh sourcing is present
</verification>

<success_criteria>
- gsd-complete-milestone SKILL.md archives directly to history/v{X.Y}/
- AskUserQuestion used for all user confirmations
- Atomic mv operations with git tracking
- Optional files handled with || true pattern
- Git commits use commit_as_user function
- No references to deprecated archive/restore commands
- Workspace clean after completion (only PROJECT, MILESTONES, config, codebase)
</success_criteria>

<output>
After completion, create `.planning/phases/10-milestone-completion-workflow-unification/10-01-SUMMARY.md`
</output>
