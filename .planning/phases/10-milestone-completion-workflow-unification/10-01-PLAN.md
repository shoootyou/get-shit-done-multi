---
phase: 10-milestone-completion-workflow-unification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/skills/gsd-complete-milestone/SKILL.md
  - templates/get-shit-done/workflows/complete-milestone.md
autonomous: true

must_haves:
  truths:
    - "gsd-complete-milestone archives directly to history/v{X.Y}/ with mirrored .planning/ structure"
    - "User receives combined readiness + archive confirmation via AskUserQuestion"
    - "Optional git tag creation uses AskUserQuestion"
    - "Workspace is clean after completion (only PROJECT.md, MILESTONES.md, config.json, codebase/ remain)"
    - "All file moves are atomic with git tracking"
  artifacts:
    - path: "templates/skills/gsd-complete-milestone/SKILL.md"
      provides: "Unified completion workflow with direct history/ archiving"
      min_lines: 100
    - path: "templates/get-shit-done/workflows/complete-milestone.md"
      provides: "Atomic file operations for history/ archiving"
      min_lines: 50
  key_links:
    - from: "templates/skills/gsd-complete-milestone/SKILL.md"
      to: "templates/get-shit-done/workflows/complete-milestone.md"
      via: "@-reference in execution_context"
      pattern: "@.*complete-milestone\\.md"
    - from: "templates/get-shit-done/workflows/complete-milestone.md"
      to: "git-identity-helpers.sh"
      via: "source command for commit_as_user"
      pattern: "source.*git-identity-helpers"
---

<objective>
Refactor gsd-complete-milestone to archive directly to history/v{X.Y}/ with mirrored .planning/ structure and unified user confirmations via AskUserQuestion.

Purpose: Eliminate multi-step archive workflow (complete → archive → restore) in favor of single atomic operation that archives to permanent history/.
Output: Updated SKILL.md and workflow.md that archive directly to history/ with AskUserQuestion confirmations.
</objective>

<execution_context>
@.github/get-shit-done/workflows/execute-plan.md
@.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-milestone-completion-workflow-unification/10-01-CONTEXT.md
@.planning/phases/10-milestone-completion-workflow-unification/10-RESEARCH.md

Current complete-milestone workflow:
@templates/skills/gsd-complete-milestone/SKILL.md
@templates/get-shit-done/workflows/complete-milestone.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor complete-milestone SKILL.md with AI-first instructions</name>
  <files>templates/skills/gsd-complete-milestone/SKILL.md</files>
  <action>
Update gsd-complete-milestone SKILL.md to implement unified workflow using natural language instructions (AI-first approach).

**Key changes:**

1. **Update objective** to reflect direct history/ archiving (not milestones/)

2. **Add combined confirmation step** using AskUserQuestion:
   ```markdown
   <step name="confirm_completion">
   Use AskUserQuestion:
   - header: "Ready to Complete Milestone?"
   - question: "Complete v{X.Y}? This will archive all files to history/v{X.Y}/"
   - Show milestone stats: {N} phases, {M} plans, {K} requirements
   - options:
     - "Complete and archive" — Archive to history/ and mark complete
     - "Cancel" — Exit without changes
   
   If "Cancel": Exit with message.
   If "Complete and archive": Continue to archive_to_history step.
   </step>
   ```

3. **Update archive process** with natural language bash instructions:
   ```markdown
   <step name="archive_to_history">
   Archive all milestone files directly to history/v{X.Y}/ using bash commands:
   
   ```bash
   # Source git helpers
   if ! type commit_as_user >/dev/null 2>&1; then
       source {{PLATFORM_ROOT}}/get-shit-done/workflows/git-identity-helpers.sh
   fi
   
   # Create destination with mirrored structure
   mkdir -p .planning/history/v{X.Y}/
   
   # Move required files atomically
   mv .planning/ROADMAP.md .planning/history/v{X.Y}/
   mv .planning/STATE.md .planning/history/v{X.Y}/
   mv .planning/PROJECT.md .planning/history/v{X.Y}/
   
   # Move optional files (don't fail if missing)
   mv .planning/REQUIREMENTS.md .planning/history/v{X.Y}/ 2>/dev/null || true
   
   # Move directories (preserves structure)
   mv .planning/phases .planning/history/v{X.Y}/ 2>/dev/null || true
   mv .planning/research .planning/history/v{X.Y}/ 2>/dev/null || true
   mv .planning/todos .planning/history/v{X.Y}/ 2>/dev/null || true
   
   # Stage all changes
   git add .planning/history/v{X.Y}/
   git add -u .planning/  # Stages deletions
   
   # Commit with user identity
   commit_as_user "milestone: archive v{X.Y} to history
   
   Moved to .planning/history/v{X.Y}/:
   - ROADMAP.md, STATE.md, PROJECT.md
   - REQUIREMENTS.md
   - phases/, research/, todos/
   
   Workspace ready for next milestone."
   ```
   
   **Note:** Instructions use {{PLATFORM_ROOT}} variable which gets replaced with .github, .claude, or .codex during installation.
   </step>
   ```

4. **Add git tag confirmation** using AskUserQuestion:
   ```markdown
   <step name="confirm_git_tag">
   Use AskUserQuestion:
   - header: "Git Tag"
   - question: "Create git tag v{X.Y}?"
   - options:
     - "Create tag v{X.Y}" — Tag this version
     - "Skip tag" — No git tag
   
   If "Create tag v{X.Y}": Run `git tag v{X.Y} && git push origin v{X.Y}`
   If "Skip tag": Continue to next step.
   </step>
   ```

5. **Add success banner** using stage banner pattern:
   ```markdown
   <step name="show_completion">
   Display stage banner:
   
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    GSD ► MILESTONE COMPLETE ✓
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   **v{X.Y} {MILESTONE_NAME}** — {N} phases complete
   
   Archived to: .planning/history/v{X.Y}/
   Git tag: v{X.Y} {if created}
   
   Workspace clean: PROJECT.md, MILESTONES.md, config.json, codebase/
   
   ───────────────────────────────────────────────────────────────
   
   ## ▶ Next Up
   
   **New Milestone** — Start planning next version
   
   `{{COMMAND_PREFIX}}new-milestone`
   
   <sub>`/clear` first → fresh context window</sub>
   
   ───────────────────────────────────────────────────────────────
   ```
   </step>
   ```

6. **Update execution_context** to reference complete-milestone.md workflow:
   ```markdown
   <execution_context>
   @{{PLATFORM_ROOT}}/get-shit-done/workflows/complete-milestone.md
   @{{PLATFORM_ROOT}}/get-shit-done/references/ui-brand.md
   </execution_context>
   ```

7. **Remove references** to archive-milestone and restore-milestone commands

8. **Update success criteria**:
   ```markdown
   <success_criteria>
   - [ ] All milestone files archived to .planning/history/v{X.Y}/
   - [ ] Directory structure mirrored (phases/, research/, todos/)
   - [ ] Git commit preserves user identity
   - [ ] Optional git tag created based on user choice
   - [ ] Workspace contains only: PROJECT.md, MILESTONES.md, config.json, codebase/
   - [ ] User knows next command ({{COMMAND_PREFIX}}new-milestone)
   </success_criteria>
   ```

**AI-first principles applied:**
- Natural language instructions in SKILL.md (not scripts)
- Bash commands shown inline (AI executes these directly)
- Use AskUserQuestion tool (not manual text prompts)
- Reference workflows with @-syntax
- Template variables ({{PLATFORM_ROOT}}, {{COMMAND_PREFIX}})
- Keep SKILL.md concise and AI-readable

**What to avoid:**
- Creating separate scripts (AI can execute bash directly)
- Manual text prompts like "Type 'yes' to continue"
- Non-atomic operations (no cp then rm, use mv)
- Missing git identity preservation
  </action>
  <verify>
```bash
# Check SKILL.md uses AskUserQuestion (not manual prompts)
grep -q "AskUserQuestion" templates/skills/gsd-complete-milestone/SKILL.md

# Check bash commands are inline (not referenced scripts)
grep -q "mkdir -p .planning/history" templates/skills/gsd-complete-milestone/SKILL.md

# Check git identity helpers sourced
grep -q "commit_as_user" templates/skills/gsd-complete-milestone/SKILL.md

# Check stage banner pattern used
grep -q "GSD ► MILESTONE COMPLETE" templates/skills/gsd-complete-milestone/SKILL.md

# Verify no references to archive-milestone or restore-milestone
! grep -q "archive-milestone\|restore-milestone" templates/skills/gsd-complete-milestone/SKILL.md
```
  </verify>
  <done>
SKILL.md refactored with:
- AskUserQuestion for all confirmations (no manual prompts)
- Inline bash commands for file operations (no separate scripts)
- Git identity preservation via commit_as_user
- Stage banner for completion message
- Direct history/ archiving (no milestones/ reference)
- Template variables ({{PLATFORM_ROOT}}, {{COMMAND_PREFIX}})
  </done>
</task>

<task type="auto">
  <name>Task 2: Create complete-milestone workflow with AI-first patterns</name>
  <files>templates/get-shit-done/workflows/complete-milestone.md</files>
  <action>
Create or update complete-milestone.md workflow with natural language bash instructions (AI-first approach).

**Structure:**

```markdown
# Complete Milestone Workflow

**Purpose:** Archive current milestone to history/v{X.Y}/ with mirrored .planning/ structure

**Called by:** gsd-complete-milestone skill

---

## Archive Operations

### 1. Source Git Identity Helpers

```bash
# Idempotent check (safe to call multiple times)
if ! type commit_as_user >/dev/null 2>&1; then
    source {{PLATFORM_ROOT}}/get-shit-done/workflows/git-identity-helpers.sh
fi
```

### 2. Create Archive Directory

```bash
# Mirror .planning/ structure in history/
VERSION="1.0"  # Example, passed from skill
mkdir -p .planning/history/v${VERSION}/
```

### 3. Move Files Atomically

**Required files:**
```bash
# These must exist
mv .planning/ROADMAP.md .planning/history/v${VERSION}/
mv .planning/STATE.md .planning/history/v${VERSION}/
mv .planning/PROJECT.md .planning/history/v${VERSION}/
```

**Optional files:**
```bash
# Don't fail if missing (2>/dev/null || true)
mv .planning/REQUIREMENTS.md .planning/history/v${VERSION}/ 2>/dev/null || true
```

**Directories:**
```bash
# Move entire directories (preserves structure)
mv .planning/phases .planning/history/v${VERSION}/ 2>/dev/null || true
mv .planning/research .planning/history/v${VERSION}/ 2>/dev/null || true
mv .planning/todos .planning/history/v${VERSION}/ 2>/dev/null || true
```

### 4. Git Tracking

```bash
# Stage additions and deletions
git add .planning/history/v${VERSION}/
git add -u .planning/

# Commit with user identity
commit_as_user "milestone: archive v${VERSION} to history

Moved to .planning/history/v${VERSION}/:
- ROADMAP.md, STATE.md, PROJECT.md
- REQUIREMENTS.md
- phases/, research/, todos/

Workspace ready for next milestone."
```

### 5. Update MILESTONES.md Registry

```bash
# Append to registry (create if doesn't exist)
cat >> .planning/MILESTONES.md << EOF

## v${VERSION} — ${MILESTONE_NAME}

**Completed:** $(date +%Y-%m-%d)
**Phases:** ${PHASE_COUNT}
**Plans:** ${PLAN_COUNT}

**Key Accomplishments:**
- ${ACCOMPLISHMENT_1}
- ${ACCOMPLISHMENT_2}
- ${ACCOMPLISHMENT_3}

**Location:** .planning/history/v${VERSION}/

EOF

git add .planning/MILESTONES.md
commit_as_user "milestone: register v${VERSION} completion"
```

### 6. Optional Git Tag

```bash
# Only if user confirmed
git tag v${VERSION}
git push origin v${VERSION}
```

---

## Expected State After Completion

**Workspace contains only:**
- `.planning/PROJECT.md` (untouched)
- `.planning/MILESTONES.md` (updated with entry)
- `.planning/config.json` (untouched)
- `.planning/codebase/` (untouched)
- `.planning/history/v${VERSION}/` (new archive)

**Archived to history/v${VERSION}/:**
- `ROADMAP.md`
- `STATE.md`
- `PROJECT.md`
- `REQUIREMENTS.md` (if exists)
- `phases/` (if exists)
- `research/` (if exists)
- `todos/` (if exists)

---

## Notes

- All operations are atomic at filesystem level (mv appears instantly or not at all)
- Git tracks the moves, allowing rollback if needed
- Optional files use `2>/dev/null || true` to prevent failures
- Directories moved whole (preserves internal structure)
- Template variables ({{PLATFORM_ROOT}}) replaced during installation
```

**AI-first principles:**
- Natural language explanations
- Bash commands shown inline (AI can execute these)
- Comments explain intent
- Template variables documented
- No scripts required (AI composes bash as needed)
  </action>
  <verify>
```bash
# Check workflow file created
test -f templates/get-shit-done/workflows/complete-milestone.md

# Check contains bash examples
grep -q "mkdir -p .planning/history" templates/get-shit-done/workflows/complete-milestone.md

# Check references git helpers
grep -q "commit_as_user" templates/get-shit-done/workflows/complete-milestone.md

# Check documents atomic operations
grep -q "atomic" templates/get-shit-done/workflows/complete-milestone.md

# Check template variables documented
grep -q "{{PLATFORM_ROOT}}" templates/get-shit-done/workflows/complete-milestone.md
```
  </verify>
  <done>
Workflow file created with:
- Natural language bash instructions (AI-readable)
- Atomic file operations documented
- Git identity preservation patterns
- Template variables explained
- No separate scripts needed (AI executes bash directly)
  </done>
</task>

</tasks>

<verification>
- gsd-complete-milestone SKILL.md uses AskUserQuestion for all confirmations
- Bash commands are inline in SKILL.md (not separate scripts)
- Git identity helpers sourced and commit_as_user used
- Stage banner follows ui-brand.md patterns
- Archives directly to history/v{X.Y}/ (not milestones/)
- Workflow file documents atomic operations with bash examples
- No references to deprecated archive-milestone or restore-milestone
- Template variables ({{PLATFORM_ROOT}}, {{COMMAND_PREFIX}}) used consistently
</verification>

<success_criteria>
- [ ] SKILL.md refactored with natural language instructions (AI-first)
- [ ] AskUserQuestion used for all confirmations (no manual text prompts)
- [ ] Bash commands inline in SKILL.md (AI executes directly)
- [ ] complete-milestone.md workflow created with atomic operation patterns
- [ ] Git identity preservation via commit_as_user
- [ ] Archives to history/v{X.Y}/ with mirrored structure
- [ ] Workspace clean after completion (only PROJECT, MILESTONES, config, codebase)
- [ ] No separate scripts created (AI-first principle maintained)
</success_criteria>

<output>
After completion, create `.planning/phases/10-milestone-completion-workflow-unification/10-01-SUMMARY.md`
</output>
