---
phase: 12.1-refactor-to-per-platform-directory-structure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/platforms/codex/adapter.js
  - bin/lib/platforms/codex/validator.js
  - bin/lib/platforms/codex/serializer.js
  - bin/lib/platforms/codex/cleaner.js
  - bin/lib/installer/install-skills.js
  - tests/unit/platforms/codex/serializer.test.js
autonomous: true

must_haves:
  truths:
    - Codex platform files are in platforms/codex/ directory
    - All imports to Codex platform files resolve correctly
    - Install test with --codex flag succeeds
  artifacts:
    - path: "bin/lib/platforms/codex/adapter.js"
      provides: "CodexAdapter class"
      exports: ["CodexAdapter"]
    - path: "bin/lib/platforms/codex/validator.js"
      provides: "CodexValidator class"
      exports: ["CodexValidator"]
    - path: "bin/lib/platforms/codex/serializer.js"
      provides: "serializeFrontmatter function"
      exports: ["serializeFrontmatter"]
    - path: "bin/lib/platforms/codex/cleaner.js"
      provides: "cleanFrontmatter function"
      exports: ["cleanFrontmatter"]
    - path: "tests/unit/platforms/codex/serializer.test.js"
      provides: "Codex serializer tests"
      min_lines: 100
  key_links:
    - from: "bin/lib/platforms/codex/adapter.js"
      to: "./serializer.js"
      via: "import statement"
      pattern: "from.*serializer\\.js"
    - from: "bin/lib/installer/install-skills.js"
      to: "../platforms/codex/validator.js"
      via: "import statement"
      pattern: "from.*codex/validator"
---

<objective>
Migrate Codex platform files from domain-based structure (frontmatter/, serialization/, platforms/) to platform-based structure (platforms/codex/).

Purpose: Improve encapsulation and make adding new platforms easier by grouping all Codex-specific code together.
Output: Codex platform files in platforms/codex/ with all imports updated and working.
</objective>

<execution_context>
@.github/get-shit-done/workflows/execute-plan.md
@.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.1-refactor-to-per-platform-directory-structure/12.1-01-CONTEXT.md
@.planning/phases/12.1-refactor-to-per-platform-directory-structure/12.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Migrate Codex platform source files</name>
  <files>
    bin/lib/platforms/codex/adapter.js
    bin/lib/platforms/codex/validator.js
    bin/lib/platforms/codex/serializer.js
    bin/lib/platforms/codex/cleaner.js
  </files>
  <action>
Create target directory and move Codex platform files using git mv to preserve history:

1. Create directory:
   ```bash
   mkdir -p bin/lib/platforms/codex
   ```

2. Move files (preserves git history):
   ```bash
   git mv bin/lib/frontmatter/codex-validator.js bin/lib/platforms/codex/validator.js
   git mv bin/lib/serialization/codex-serializer.js bin/lib/platforms/codex/serializer.js
   git mv bin/lib/serialization/codex-cleaner.js bin/lib/platforms/codex/cleaner.js
   git mv bin/lib/platforms/codex-adapter.js bin/lib/platforms/codex/adapter.js
   ```

3. Update internal imports within moved files:
   - In adapter.js: Change `from '../serialization/codex-serializer.js'` to `from './serializer.js'` (same directory now)
   - In validator.js: Keep base-validator import as-is (will be updated in Plan 04)
   - Pattern: Use sed to update paths

Named exports remain unchanged (CodexAdapter, CodexValidator, serializeFrontmatter, cleanFrontmatter).
  </action>
  <verify>
Run: `ls -la bin/lib/platforms/codex/` shows 4 files (adapter.js, validator.js, serializer.js, cleaner.js)
Run: `git status` shows 4 renames (R) for Codex files
Run: `node --eval "import('./bin/lib/platforms/codex/adapter.js').then(() => console.log('OK'))"` succeeds
  </verify>
  <done>
Codex platform files exist in platforms/codex/ directory with git rename history preserved.
  </done>
</task>

<task type="auto">
  <name>Migrate Codex platform test files</name>
  <files>tests/unit/platforms/codex/serializer.test.js</files>
  <action>
Create test directory and move Codex test files using git mv:

1. Create directory:
   ```bash
   mkdir -p tests/unit/platforms/codex
   ```

2. Move test file:
   ```bash
   git mv tests/unit/codex-serializer.test.js tests/unit/platforms/codex/serializer.test.js
   ```

3. Update imports in test file:
   - Change `from '../../bin/lib/serialization/codex-serializer.js'` to `from '../../../../bin/lib/platforms/codex/serializer.js'`
   - Use sed for path updates

Test structure now mirrors source structure (bin/lib/platforms/codex → tests/unit/platforms/codex).
  </action>
  <verify>
Run: `ls -la tests/unit/platforms/codex/` shows serializer.test.js
Run: `git status` shows rename (R) for test file
Run: `grep -r "from.*serialization/codex" tests/unit/` returns nothing (old import paths removed)
  </verify>
  <done>
Codex test files exist in tests/unit/platforms/codex/ mirroring source structure.
  </done>
</task>

<task type="auto">
  <name>Update imports in files that use Codex platform</name>
  <files>bin/lib/installer/install-skills.js</files>
  <action>
Update all imports that reference Codex platform files:

1. Find all files that import Codex modules:
   ```bash
   grep -r "from.*frontmatter/codex-validator" bin/lib/ --include="*.js"
   grep -r "from.*serialization/codex-serializer" bin/lib/ --include="*.js"
   grep -r "from.*serialization/codex-cleaner" bin/lib/ --include="*.js"
   ```

2. Update imports in install-skills.js:
   - `from '../frontmatter/codex-validator.js'` → `from '../platforms/codex/validator.js'`
   - `from '../serialization/codex-cleaner.js'` → `from '../platforms/codex/cleaner.js'`

3. Use sed for updates (handles both quote types):
   ```bash
   sed -i '' "s|['\"]../frontmatter/codex-validator.js['\"]|'../platforms/codex/validator.js'|g" bin/lib/installer/install-skills.js
   sed -i '' "s|['\"]../serialization/codex-cleaner.js['\"]|'../platforms/codex/cleaner.js'|g" bin/lib/installer/install-skills.js
   ```

4. Verify no old imports remain:
   ```bash
   grep -r "frontmatter/codex\|serialization/codex" bin/lib/ tests/ --include="*.js"
   ```
   Should return no results.
  </action>
  <verify>
Run: `grep -r "from.*platforms/codex/validator" bin/lib/installer/install-skills.js` succeeds
Run: `grep -r "frontmatter/codex\|serialization/codex" bin/lib/ tests/ --include="*.js"` returns no results
Run: `node bin/lib/installer/install-skills.js` (dry run if possible) or validate imports resolve
  </verify>
  <done>
All files that use Codex platform import from new locations (platforms/codex/).
  </done>
</task>

<task type="auto">
  <name>Validate Codex migration with install test</name>
  <files>N/A</files>
  <action>
Test the migration by running a full install test in /tmp:

1. Create test directory:
   ```bash
   mkdir -p /tmp/gsd-test-codex-migration
   cd /tmp/gsd-test-codex-migration
   ```

2. Run installer with absolute path:
   ```bash
   node /Users/rodolfo/croonix-github/gsd/get-shit-done-multi/bin/install.js --codex --yes
   ```

3. Verify installation succeeds (exit code 0)

4. Check that Codex skills/agents were installed:
   ```bash
   ls -la .codex/skills/ .codex/agents/
   ```

5. Clean up test directory:
   ```bash
   cd /
   rm -rf /tmp/gsd-test-codex-migration
   ```

If install fails, rollback migration:
```bash
git reset --hard HEAD  # if uncommitted
# or
git reset --hard HEAD~1  # if already committed
```
  </action>
  <verify>
Install test succeeds with exit code 0
Test directory contains .codex/skills/ and .codex/agents/ directories
No errors in install output
  </verify>
  <done>
Codex platform migration validated with successful install test in /tmp.
  </done>
</task>

</tasks>

<verification>
1. All Codex platform files exist in bin/lib/platforms/codex/
2. All Codex test files exist in tests/unit/platforms/codex/
3. No files remain in bin/lib/frontmatter/ or bin/lib/serialization/ with 'codex' in name
4. All imports to Codex platform files use new paths
5. Git history preserved (git log --follow shows original commits)
6. Install test with --codex succeeds
</verification>

<success_criteria>
- Codex platform completely migrated to platforms/codex/ directory
- All imports updated and resolving correctly
- Git rename history preserved for all moved files
- Install test validates migration success
- No references to old paths (frontmatter/codex-*, serialization/codex-*) remain in codebase
</success_criteria>

<output>
After completion, create `.planning/phases/12.1-refactor-to-per-platform-directory-structure/12.1-03-SUMMARY.md`
</output>
