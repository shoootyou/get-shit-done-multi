# Phase 12.1: Refactor to per-platform directory structure - Context

**Gathered:** 2026-02-01
**Status:** Ready for planning

<domain>
## Phase Boundary

Reorganize module structure from domain-based (frontmatter/, serialization/, platforms/) to platform-based (platforms/claude/, platforms/copilot/, platforms/codex/, platforms/_shared/) for better encapsulation and easier platform addition. This is a structural refactor with NO logic changes - only moving files and updating imports.

</domain>

<decisions>
## Implementation Decisions

### Migration Strategy
- **Phased approach**: Migrate one platform at a time (Claude → Copilot → Codex)
- **Git history preservation**: Use `git mv` for all file moves (preserves rename history)
- **Testing between phases**: After each platform migration, run install test in /tmp:
  ```bash
  mkdir -p /tmp/gsd-test-{platform}
  cd /tmp/gsd-test-{platform}
  node /Users/rodolfo/croonix-github/gsd/get-shit-done-multi/bin/install.js --{platform}
  # Validate installation succeeded
  ```
- **Test timing**: Full test suite runs ONLY after all platforms migrated (most efficient)
- **Commit strategy**: Two commits total
  - Commit 1: All platform migrations (Claude + Copilot + Codex)
  - Commit 2: Cleanup (delete empty frontmatter/ and serialization/ directories)

### Shared Code Organization
- **Rule**: Base classes and reusable code in `_shared/`, utilities in `platforms/` root
- **platforms/_shared/**: Code that platforms EXTEND (inherit from)
  - base-validator.js
  - base-adapter.js
  - field-validators.js
  - validation-error.js
- **platforms/ root**: Code that platforms USE but don't extend
  - registry.js
  - detector.js
  - binary-detector.js
  - platform-names.js
  - platform-paths.js
  - instruction-paths.js
- **Structure**: Keep _shared/ flat (all 4 files in one directory, no subdirectories)

### File Naming Within Platform Directories
- **Drop platform prefixes**: 
  - claude-adapter.js → adapter.js
  - claude-validator.js → validator.js
  - claude-serializer.js → serializer.js
  - claude-cleaner.js → cleaner.js
- **Keep named exports unchanged**: 
  - Files still export `ClaudeAdapter`, `ClaudeValidator`, etc.
  - Class names keep platform prefix even though filenames don't
- **Update all imports**: Change from `../platforms/claude-adapter.js` to `../platforms/claude/adapter.js`
- **No compatibility layer**: Direct import updates, no index.js re-exports

### Test File Organization
- **Mirror source structure**: 
  - tests/unit/claude-serializer.test.js → tests/unit/platforms/claude/serializer.test.js
  - tests/unit/copilot-adapter.test.js → tests/unit/platforms/copilot/adapter.test.js
- **Move with code**: Tests move together with their platform's source code (same wave)
- **Shared tests**: Follow same pattern (tests/unit/platforms/_shared/ if needed)

### Per-Platform Migration Order
For each platform (Claude, then Copilot, then Codex):
1. Create platform directory: `bin/lib/platforms/{platform}/`
2. Move source files using `git mv`:
   - bin/lib/frontmatter/{platform}-validator.js → bin/lib/platforms/{platform}/validator.js
   - bin/lib/serialization/{platform}-serializer.js → bin/lib/platforms/{platform}/serializer.js
   - bin/lib/serialization/{platform}-cleaner.js → bin/lib/platforms/{platform}/cleaner.js
   - bin/lib/platforms/{platform}-adapter.js → bin/lib/platforms/{platform}/adapter.js
3. Create test directory: `tests/unit/platforms/{platform}/`
4. Move test files using `git mv`:
   - tests/unit/{platform}-*.test.js → tests/unit/platforms/{platform}/*.test.js
5. Update imports in source files (within platform directory)
6. Update imports in test files
7. Update imports in other files that use this platform
8. Run install validation test in /tmp
9. If test passes → proceed to next platform

### Claude's Discretion
- Exact order of import updates (can batch or do incrementally)
- Whether to create all platform directories upfront or one at a time
- Specific git commit messages for each step
- Error handling approach if install test fails

</decisions>

<specifics>
## Specific Ideas

- Migration affects ~15 source files (4 per platform × 3 platforms + shared files)
- Migration affects ~10 test files (3-4 per platform)
- Import updates needed in ~15 locations (installers, adapters, orchestrator, tests)
- Install test command must use full absolute path to bin/install.js
- Empty directories (frontmatter/, serialization/) deleted AFTER all migrations complete
- Current exports (ClaudeAdapter, CopilotValidator, etc.) must remain unchanged

**Target structure:**
```
bin/lib/platforms/
├── _shared/
│   ├── base-validator.js
│   ├── base-adapter.js
│   ├── field-validators.js
│   └── validation-error.js
├── registry.js
├── detector.js
├── binary-detector.js
├── platform-names.js
├── platform-paths.js
├── instruction-paths.js
├── claude/
│   ├── adapter.js        (exports ClaudeAdapter)
│   ├── validator.js      (exports ClaudeValidator)
│   ├── serializer.js     (exports serializeFrontmatter)
│   └── cleaner.js        (exports cleanFrontmatter)
├── copilot/
│   ├── adapter.js
│   ├── validator.js
│   ├── serializer.js
│   └── cleaner.js
└── codex/
    ├── adapter.js
    ├── validator.js
    ├── serializer.js
    └── cleaner.js
```

**Test structure:**
```
tests/unit/platforms/
├── _shared/
│   └── (shared tests if needed)
├── claude/
│   ├── adapter.test.js
│   ├── validator.test.js
│   ├── serializer.test.js
│   └── cleaner.test.js
├── copilot/
│   └── (similar structure)
└── codex/
    └── (similar structure)
```

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 12.1-refactor-to-per-platform-directory-structure*
*Context gathered: 2026-02-01*
