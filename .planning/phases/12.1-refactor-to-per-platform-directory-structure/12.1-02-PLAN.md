---
phase: 12.1-refactor-to-per-platform-directory-structure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/platforms/copilot/adapter.js
  - bin/lib/platforms/copilot/validator.js
  - bin/lib/platforms/copilot/serializer.js
  - bin/lib/platforms/copilot/cleaner.js
  - bin/lib/installer/install-skills.js
  - tests/unit/platforms/copilot/serializer.test.js
autonomous: true

must_haves:
  truths:
    - Copilot platform files are in platforms/copilot/ directory
    - All imports to Copilot platform files resolve correctly
    - Install test with --copilot flag succeeds
  artifacts:
    - path: "bin/lib/platforms/copilot/adapter.js"
      provides: "CopilotAdapter class"
      exports: ["CopilotAdapter"]
    - path: "bin/lib/platforms/copilot/validator.js"
      provides: "CopilotValidator class"
      exports: ["CopilotValidator"]
    - path: "bin/lib/platforms/copilot/serializer.js"
      provides: "serializeFrontmatter function"
      exports: ["serializeFrontmatter"]
    - path: "bin/lib/platforms/copilot/cleaner.js"
      provides: "cleanFrontmatter function"
      exports: ["cleanFrontmatter"]
    - path: "tests/unit/platforms/copilot/serializer.test.js"
      provides: "Copilot serializer tests"
      min_lines: 100
  key_links:
    - from: "bin/lib/platforms/copilot/adapter.js"
      to: "./serializer.js"
      via: "import statement"
      pattern: "from.*serializer\\.js"
    - from: "bin/lib/installer/install-skills.js"
      to: "../platforms/copilot/validator.js"
      via: "import statement"
      pattern: "from.*copilot/validator"
---

<objective>
Migrate Copilot platform files from domain-based structure (frontmatter/, serialization/, platforms/) to platform-based structure (platforms/copilot/).

Purpose: Improve encapsulation and make adding new platforms easier by grouping all Copilot-specific code together.
Output: Copilot platform files in platforms/copilot/ with all imports updated and working.
</objective>

<execution_context>
@.github/get-shit-done/workflows/execute-plan.md
@.github/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.1-refactor-to-per-platform-directory-structure/12.1-01-CONTEXT.md
@.planning/phases/12.1-refactor-to-per-platform-directory-structure/12.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Migrate Copilot platform source files</name>
  <files>
    bin/lib/platforms/copilot/adapter.js
    bin/lib/platforms/copilot/validator.js
    bin/lib/platforms/copilot/serializer.js
    bin/lib/platforms/copilot/cleaner.js
  </files>
  <action>
Create target directory and move Copilot platform files using git mv to preserve history:

1. Create directory:
   ```bash
   mkdir -p bin/lib/platforms/copilot
   ```

2. Move files (preserves git history):
   ```bash
   git mv bin/lib/frontmatter/copilot-validator.js bin/lib/platforms/copilot/validator.js
   git mv bin/lib/serialization/copilot-serializer.js bin/lib/platforms/copilot/serializer.js
   git mv bin/lib/serialization/copilot-cleaner.js bin/lib/platforms/copilot/cleaner.js
   git mv bin/lib/platforms/copilot-adapter.js bin/lib/platforms/copilot/adapter.js
   ```

3. Update internal imports within moved files:
   - In adapter.js: Change `from '../serialization/copilot-serializer.js'` to `from './serializer.js'` (same directory now)
   - In validator.js: Keep base-validator import as-is (will be updated in Plan 04)
   - Pattern: Use sed to update paths

Named exports remain unchanged (CopilotAdapter, CopilotValidator, serializeFrontmatter, cleanFrontmatter).
  </action>
  <verify>
Run: `ls -la bin/lib/platforms/copilot/` shows 4 files (adapter.js, validator.js, serializer.js, cleaner.js)
Run: `git status` shows 4 renames (R) for Copilot files
Run: `node --eval "import('./bin/lib/platforms/copilot/adapter.js').then(() => console.log('OK'))"` succeeds
  </verify>
  <done>
Copilot platform files exist in platforms/copilot/ directory with git rename history preserved.
  </done>
</task>

<task type="auto">
  <name>Migrate Copilot platform test files</name>
  <files>tests/unit/platforms/copilot/serializer.test.js</files>
  <action>
Create test directory and move Copilot test files using git mv:

1. Create directory:
   ```bash
   mkdir -p tests/unit/platforms/copilot
   ```

2. Move test file:
   ```bash
   git mv tests/unit/copilot-serializer.test.js tests/unit/platforms/copilot/serializer.test.js
   ```

3. Update imports in test file:
   - Change `from '../../bin/lib/serialization/copilot-serializer.js'` to `from '../../../../bin/lib/platforms/copilot/serializer.js'`
   - Use sed for path updates

Test structure now mirrors source structure (bin/lib/platforms/copilot → tests/unit/platforms/copilot).
  </action>
  <verify>
Run: `ls -la tests/unit/platforms/copilot/` shows serializer.test.js
Run: `git status` shows rename (R) for test file
Run: `grep -r "from.*serialization/copilot" tests/unit/` returns nothing (old import paths removed)
  </verify>
  <done>
Copilot test files exist in tests/unit/platforms/copilot/ mirroring source structure.
  </done>
</task>

<task type="auto">
  <name>Update imports in files that use Copilot platform</name>
  <files>bin/lib/installer/install-skills.js</files>
  <action>
Update all imports that reference Copilot platform files:

1. Find all files that import Copilot modules:
   ```bash
   grep -r "from.*frontmatter/copilot-validator" bin/lib/ --include="*.js"
   grep -r "from.*serialization/copilot-serializer" bin/lib/ --include="*.js"
   grep -r "from.*serialization/copilot-cleaner" bin/lib/ --include="*.js"
   ```

2. Update imports in install-skills.js:
   - `from '../frontmatter/copilot-validator.js'` → `from '../platforms/copilot/validator.js'`
   - `from '../serialization/copilot-cleaner.js'` → `from '../platforms/copilot/cleaner.js'`

3. Use sed for updates (handles both quote types):
   ```bash
   sed -i '' "s|['\"]../frontmatter/copilot-validator.js['\"]|'../platforms/copilot/validator.js'|g" bin/lib/installer/install-skills.js
   sed -i '' "s|['\"]../serialization/copilot-cleaner.js['\"]|'../platforms/copilot/cleaner.js'|g" bin/lib/installer/install-skills.js
   ```

4. Verify no old imports remain:
   ```bash
   grep -r "frontmatter/copilot\|serialization/copilot" bin/lib/ tests/ --include="*.js"
   ```
   Should return no results.
  </action>
  <verify>
Run: `grep -r "from.*platforms/copilot/validator" bin/lib/installer/install-skills.js` succeeds
Run: `grep -r "frontmatter/copilot\|serialization/copilot" bin/lib/ tests/ --include="*.js"` returns no results
Run: `node bin/lib/installer/install-skills.js` (dry run if possible) or validate imports resolve
  </verify>
  <done>
All files that use Copilot platform import from new locations (platforms/copilot/).
  </done>
</task>

<task type="auto">
  <name>Validate Copilot migration with install test</name>
  <files>N/A</files>
  <action>
Test the migration by running a full install test in /tmp:

1. Create test directory:
   ```bash
   mkdir -p /tmp/gsd-test-copilot-migration
   cd /tmp/gsd-test-copilot-migration
   ```

2. Run installer with absolute path:
   ```bash
   node /Users/rodolfo/croonix-github/gsd/get-shit-done-multi/bin/install.js --copilot --yes
   ```

3. Verify installation succeeds (exit code 0)

4. Check that Copilot skills/agents were installed:
   ```bash
   ls -la .github/skills/ .github/agents/
   ```

5. Clean up test directory:
   ```bash
   cd /
   rm -rf /tmp/gsd-test-copilot-migration
   ```

If install fails, rollback migration:
```bash
git reset --hard HEAD  # if uncommitted
# or
git reset --hard HEAD~1  # if already committed
```
  </action>
  <verify>
Install test succeeds with exit code 0
Test directory contains .github/skills/ and .github/agents/ directories
No errors in install output
  </verify>
  <done>
Copilot platform migration validated with successful install test in /tmp.
  </done>
</task>

</tasks>

<verification>
1. All Copilot platform files exist in bin/lib/platforms/copilot/
2. All Copilot test files exist in tests/unit/platforms/copilot/
3. No files remain in bin/lib/frontmatter/ or bin/lib/serialization/ with 'copilot' in name
4. All imports to Copilot platform files use new paths
5. Git history preserved (git log --follow shows original commits)
6. Install test with --copilot succeeds
</verification>

<success_criteria>
- Copilot platform completely migrated to platforms/copilot/ directory
- All imports updated and resolving correctly
- Git rename history preserved for all moved files
- Install test validates migration success
- No references to old paths (frontmatter/copilot-*, serialization/copilot-*) remain in codebase
</success_criteria>

<output>
After completion, create `.planning/phases/12.1-refactor-to-per-platform-directory-structure/12.1-02-SUMMARY.md`
</output>
