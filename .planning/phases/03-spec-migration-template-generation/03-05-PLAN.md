---
phase: 03-spec-migration-template-generation
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/template-system/field-transformer.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Claude agents have NO metadata fields (_platform, _generated)"
    - "Copilot agents have metadata object containing _platform and _generated"
    - "Generated agents conform to platform-specific frontmatter specifications"
  artifacts:
    - path: "bin/lib/template-system/field-transformer.js"
      provides: "Platform-specific metadata handling"
      exports: ["addPlatformMetadata"]
  key_links:
    - from: "generator.js"
      to: "addPlatformMetadata()"
      via: "field transformation pipeline"
      pattern: "addPlatformMetadata\\(.*\\)"
---

<objective>
Fix metadata field structure to conform to platform specifications.

Purpose: Claude should have NO metadata fields at root level; Copilot should nest metadata under metadata object
Output: Platform-compliant frontmatter structure
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/03-spec-migration-template-generation/03-VERIFICATION.md
@bin/lib/template-system/field-transformer.js
@test-output/claude/gsd-planner.md
@test-output/copilot/gsd-verifier.md

## Gap Context

**Issue 4 - Claude metadata field issue (CRITICAL)**
- Current: Has `_platform` and `_generated` at root level
- Expected: NO metadata fields at all in Claude agents
- Reason: Claude spec does not support metadata field
- Reference: https://code.claude.com/docs/en/sub-agents#supported-frontmatter-fields

**Issue 5 - Copilot metadata structure issue (CRITICAL)**
- Current: `_platform` and `_generated` at root level
- Expected: Under `metadata:` object
- Reference: https://docs.github.com/en/copilot/reference/custom-agents-configuration

## Current Implementation

In field-transformer.js (lines 185-210), `addPlatformMetadata()` function:

```javascript
function addPlatformMetadata(frontmatter, platform, options = {}) {
  const metadata = {
    _platform: platform,
    _generated: new Date().toISOString(),
    // ...
  };
  
  return {
    ...frontmatter,
    ...metadata  // Added at root level for ALL platforms
  };
}
```

Problem: Metadata fields added at root level regardless of platform.

## Solution Approach

Modify `addPlatformMetadata()` to:
1. For Claude: Return frontmatter unchanged (no metadata)
2. For Copilot: Nest metadata fields under `metadata` object

## Official Platform Specs

**Claude frontmatter fields (supported):**
- name
- description
- color
- tools
- model (optional)
- hooks (optional)
- skills (optional)
- disallowedTools (optional)

**NO metadata field in Claude spec.**

**Copilot frontmatter fields (supported):**
- name
- description
- tools
- metadata (object) - can contain arbitrary fields
- mcp-servers (optional)

**Metadata MUST be nested under metadata object in Copilot.**
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix metadata structure for platform specifications</name>
  <files>bin/lib/template-system/field-transformer.js</files>
  <action>
Modify the `addPlatformMetadata()` function in field-transformer.js (lines 185-210):

**Replace the entire function with:**

```javascript
/**
 * Add platform-specific generation metadata to frontmatter
 * @param {Object} frontmatter - Transformed frontmatter object
 * @param {string} platform - Target platform ('claude' or 'copilot')
 * @param {Object} options - Generation options
 * @param {string} options.specPath - Path to source spec file
 * @param {string} options.version - Template system version
 * @returns {Object} Frontmatter with metadata added (platform-specific)
 */
function addPlatformMetadata(frontmatter, platform, options = {}) {
  if (!frontmatter || typeof frontmatter !== 'object') {
    return frontmatter;
  }

  // Claude: NO metadata fields (not in official spec)
  // Reference: https://code.claude.com/docs/en/sub-agents#supported-frontmatter-fields
  if (platform === 'claude') {
    return frontmatter;  // Return unchanged
  }

  // Copilot: Metadata MUST be nested under 'metadata' object
  // Reference: https://docs.github.com/en/copilot/reference/custom-agents-configuration
  if (platform === 'copilot') {
    const metadata = {
      _platform: platform,
      _generated: new Date().toISOString(),
      ...(options.version && { _templateVersion: options.version }),
      ...(options.specPath && { _sourceSpec: options.specPath })
    };
    
    return {
      ...frontmatter,
      metadata: metadata  // Nested under metadata object
    };
  }

  // Unknown platform - return unchanged with no metadata
  return frontmatter;
}
```

**Key changes:**
1. Early return for Claude (no metadata added)
2. For Copilot, nest under `metadata:` object
3. Unknown platforms get no metadata (safe default)

**Why this approach:**
- Claude spec explicitly lists supported fields, metadata not included
- Copilot spec shows metadata as nested object for custom fields
- Prevents Claude agents from having unsupported fields
- Makes Copilot agents conform to expected structure

**Do NOT:**
- Add metadata to Claude agents (violates spec)
- Keep metadata at root level for Copilot (wrong structure)
- Remove the metadata information entirely (useful for debugging)
  </action>
  <verify>
Run existing tests to ensure no breakage:
```bash
cd bin/lib/template-system
node field-transformer.test.js
node integration.test.js
```

Test metadata handling:
```bash
node -e "
const {addPlatformMetadata} = require('./field-transformer.js');

// Test Claude (should have NO metadata)
const claudeFm = {name: 'test', tools: ['Bash']};
const claudeResult = addPlatformMetadata(claudeFm, 'claude');
console.log('Claude has _platform?', '_platform' in claudeResult);  // Should be false
console.log('Claude has metadata?', 'metadata' in claudeResult);    // Should be false

// Test Copilot (should have nested metadata)
const copilotFm = {name: 'test', tools: ['bash']};
const copilotResult = addPlatformMetadata(copilotFm, 'copilot');
console.log('Copilot has _platform at root?', '_platform' in copilotResult);  // Should be false
console.log('Copilot has metadata object?', 'metadata' in copilotResult);      // Should be true
console.log('Copilot metadata._platform?', copilotResult.metadata?._platform); // Should be 'copilot'
"
```

Generate sample agents and check structure:
```bash
node generate-samples.js
grep -A2 "^_platform\\|^metadata:" test-output/claude/gsd-planner.md
grep -A2 "^_platform\\|^metadata:" test-output/copilot/gsd-verifier.md
```

Expected:
- Claude: No matches (no metadata fields)
- Copilot: Should match "metadata:" line with nested fields
  </verify>
  <done>
- addPlatformMetadata() returns unchanged frontmatter for Claude
- addPlatformMetadata() nests metadata under metadata: object for Copilot
- Claude test agents have NO _platform or _generated fields
- Copilot test agents have metadata: object containing _platform and _generated
- All existing unit tests pass
- All 26 integration tests pass
  </done>
</task>

</tasks>

<verification>
Generate fresh samples and verify structure:

```bash
cd bin/lib/template-system
rm -rf test-output/*
node generate-samples.js

echo "=== Claude frontmatter (should have NO metadata) ==="
head -20 test-output/claude/gsd-planner.md

echo "=== Copilot frontmatter (should have metadata object) ==="
head -20 test-output/copilot/gsd-verifier.md
```

Check:
- [ ] Claude agents have NO _platform field
- [ ] Claude agents have NO _generated field
- [ ] Claude agents have NO metadata object
- [ ] Copilot agents have metadata: object
- [ ] Copilot metadata object contains _platform
- [ ] Copilot metadata object contains _generated
</verification>

<success_criteria>
1. Claude agents have zero metadata fields (clean frontmatter)
2. Copilot agents have metadata object with _platform and _generated
3. Generated Claude agents conform to https://code.claude.com/docs/en/sub-agents#supported-frontmatter-fields
4. Generated Copilot agents conform to https://docs.github.com/en/copilot/reference/custom-agents-configuration
5. All tests pass (field-transformer.test.js and integration.test.js)
</success_criteria>

<output>
After completion, create `.planning/phases/03-spec-migration-template-generation/03-05-SUMMARY.md`
</output>
