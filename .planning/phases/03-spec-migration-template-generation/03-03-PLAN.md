---
phase: 03-spec-migration-template-generation
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - bin/lib/template-system/integration.test.js
  - test-output/claude/gsd-planner.md
  - test-output/copilot/gsd-planner.md
autonomous: true

must_haves:
  truths:
    - "Template specs generate valid Claude agent format"
    - "Template specs generate valid Copilot agent format"
    - "Generated agents contain platform-specific optimizations"
    - "Claude output includes WebFetch, MCP tools, model field"
    - "Copilot output excludes Claude-only features, uses lowercase tools"
    - "Generated agents preserve all functionality from original"
    - "Platform-specific generation is automated and repeatable"
  artifacts:
    - path: "bin/lib/template-system/integration.test.js"
      provides: "Platform generation tests (Phase 1-3)"
      contains: "Phase 3 generation tests"
      min_lines: 400
    - path: "test-output/claude/gsd-planner.md"
      provides: "Sample Claude-generated agent"
      min_lines: 600
    - path: "test-output/copilot/gsd-planner.md"
      provides: "Sample Copilot-generated agent"
      min_lines: 500
  key_links:
    - from: "specs/agents/gsd-planner.md"
      to: "bin/lib/template-system/generator.js"
      via: "generateAgent renders spec with platform context"
      pattern: "generateAgent.*gsd-planner.*claude"
    - from: "bin/lib/template-system/generator.js"
      to: "bin/lib/template-system/validators.js"
      via: "validates generated output per platform"
      pattern: "validateClaudeSpec|validateCopilotSpec"
    - from: "test-output/claude/gsd-planner.md"
      to: "agents/gsd-planner.md"
      via: "functionally equivalent to original"
      pattern: "all original content preserved"
---

<objective>
Generate and validate platform-specific agents from template specs for both Claude and Copilot.

Purpose: Prove that the spec-as-template system produces valid, optimized agents for both platforms with correct platform-specific features and no functionality loss.

Output:
- Integration tests validating platform-specific generation
- Sample generated agents for both Claude and Copilot
- Validation report showing all agents generate correctly
- Documentation of platform differences in generated output
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/research/SUMMARY.md

# Phase 3 Plans
@.planning/phases/03-spec-migration-template-generation/03-01-PLAN.md
@.planning/phases/03-spec-migration-template-generation/03-02-PLAN.md

# Template Specs (now available)
@specs/agents/gsd-planner.md
@specs/agents/gsd-executor.md
@specs/agents/gsd-verifier.md

# Generation Pipeline
@bin/lib/template-system/generator.js
@bin/lib/template-system/validators.js
@bin/lib/template-system/tool-mapper.js
@bin/lib/template-system/field-transformer.js

# Existing Integration Tests
@bin/lib/template-system/integration.test.js
</context>

<tasks>

<task type="auto">
  <name>Add Phase 3 platform generation tests</name>
  <files>bin/lib/template-system/integration.test.js</files>
  <action>
Add comprehensive integration tests for platform-specific generation from template specs.

**Extend existing integration.test.js** (currently has 16 tests from Phase 1-2)

**Add Phase 3 test suite (10+ new tests):**

```javascript
describe('Phase 3: Spec-as-Template Platform Generation', () => {
  
  test('generates Claude agent from template spec with conditionals', async () => {
    const specPath = 'specs/agents/gsd-planner.md';
    const result = generateAgent(specPath, 'claude', { workDir: '/workspace' });
    
    expect(result.success).toBe(true);
    expect(result.output).toContain('tools:');
    expect(result.output).toContain('WebFetch'); // Claude-specific
    expect(result.output).toContain('mcp__context7__'); // Claude MCP
    expect(result.output).toContain('model:'); // Claude-specific field
    expect(result.output).not.toContain('{{#isClaude}}'); // Conditionals resolved
    expect(result.output).not.toContain('{{#isCopilot}}'); // Other platform removed
    
    // Parse and validate frontmatter
    const parsed = matter(result.output);
    expect(parsed.data.tools).toContain('WebFetch');
    expect(parsed.data.tools).not.toContain('webfetch'); // Case preserved
    expect(parsed.data.name).toBe('gsd-planner');
  });

  test('generates Copilot agent from same spec with different output', async () => {
    const specPath = 'specs/agents/gsd-planner.md';
    const result = generateAgent(specPath, 'copilot', { workDir: '.github/skills/get-shit-done' });
    
    expect(result.success).toBe(true);
    expect(result.output).toContain('tools:');
    expect(result.output).not.toContain('WebFetch'); // Excluded for Copilot
    expect(result.output).not.toContain('mcp__context7__'); // Excluded
    expect(result.output).not.toContain('model:'); // Copilot doesn't support
    expect(result.output).not.toContain('{{#isCopilot}}'); // Conditionals resolved
    
    // Parse and validate frontmatter
    const parsed = matter(result.output);
    expect(parsed.data.tools).not.toContain('WebFetch');
    expect(parsed.data.tools.every(t => t === t.toLowerCase())).toBe(true); // Lowercase tools
  });

  test('Claude and Copilot outputs differ appropriately', () => {
    const specPath = 'specs/agents/gsd-planner.md';
    const claudeResult = generateAgent(specPath, 'claude');
    const copilotResult = generateAgent(specPath, 'copilot');
    
    expect(claudeResult.output).not.toBe(copilotResult.output); // Different outputs
    
    // Claude has features Copilot doesn't
    expect(claudeResult.output.includes('WebFetch')).toBe(true);
    expect(copilotResult.output.includes('WebFetch')).toBe(false);
    
    expect(claudeResult.output.includes('model:')).toBe(true);
    expect(copilotResult.output.includes('model:')).toBe(false);
  });

  test('generated Claude agent validates against Claude spec', () => {
    const specPath = 'specs/agents/gsd-planner.md';
    const result = generateAgent(specPath, 'claude');
    
    const parsed = matter(result.output);
    const validation = validateClaudeSpec(parsed.data);
    
    expect(validation.valid).toBe(true);
    expect(validation.errors).toHaveLength(0);
  });

  test('generated Copilot agent validates against Copilot spec', () => {
    const specPath = 'specs/agents/gsd-planner.md';
    const result = generateAgent(specPath, 'copilot');
    
    const parsed = matter(result.output);
    const validation = validateCopilotSpec(parsed.data);
    
    expect(validation.valid).toBe(true);
    expect(validation.errors).toHaveLength(0);
  });

  test('template variables fully resolved in output', () => {
    const specPath = 'specs/agents/gsd-planner.md';
    const result = generateAgent(specPath, 'claude');
    
    // No template syntax should remain
    expect(result.output).not.toContain('{{');
    expect(result.output).not.toContain('}}');
    expect(result.output).not.toContain('{{#if');
    expect(result.output).not.toContain('{{/if');
  });

  test('generates all 11 agents successfully for Claude', () => {
    const agentNames = [
      'gsd-planner', 'gsd-executor', 'gsd-verifier',
      'gsd-codebase-mapper', 'gsd-debugger', 'gsd-phase-researcher',
      'gsd-plan-checker', 'gsd-project-researcher', 'gsd-research-synthesizer',
      'gsd-roadmapper', 'gsd-integration-checker'
    ];
    
    const results = agentNames.map(name => {
      const specPath = `specs/agents/${name}.md`;
      return { name, result: generateAgent(specPath, 'claude') };
    });
    
    const allSuccess = results.every(r => r.result.success);
    expect(allSuccess).toBe(true);
    
    const failed = results.filter(r => !r.result.success);
    if (failed.length > 0) {
      console.error('Failed agents:', failed.map(f => f.name));
    }
  });

  test('generates all 11 agents successfully for Copilot', () => {
    const agentNames = [
      'gsd-planner', 'gsd-executor', 'gsd-verifier',
      'gsd-codebase-mapper', 'gsd-debugger', 'gsd-phase-researcher',
      'gsd-plan-checker', 'gsd-project-researcher', 'gsd-research-synthesizer',
      'gsd-roadmapper', 'gsd-integration-checker'
    ];
    
    const results = agentNames.map(name => {
      const specPath = `specs/agents/${name}.md`;
      return { name, result: generateAgent(specPath, 'copilot') };
    });
    
    const allSuccess = results.every(r => r.result.success);
    expect(allSuccess).toBe(true);
  });

  test('original agent content preserved in generated output', () => {
    const specPath = 'specs/agents/gsd-planner.md';
    const spec = fs.readFileSync(specPath, 'utf8');
    const original = fs.readFileSync('agents/gsd-planner.md', 'utf8');
    
    const result = generateAgent(specPath, 'claude');
    
    // Extract markdown body from both (skip frontmatter)
    const specBody = spec.split('---').slice(2).join('---').trim();
    const originalBody = original.split('---').slice(2).join('---').trim();
    const generatedBody = result.output.split('---').slice(2).join('---').trim();
    
    // Generated body should match original body (content preserved)
    expect(generatedBody).toContain('<role>');
    expect(generatedBody.length).toBeGreaterThan(originalBody.length * 0.95); // ~95% match (minor formatting)
  });

  test('platform-specific context variables substituted', () => {
    const specPath = 'specs/agents/gsd-planner.md';
    
    // If spec contains {{workDir}}, it should be substituted
    const claudeResult = generateAgent(specPath, 'claude', { workDir: '/test/claude' });
    const copilotResult = generateAgent(specPath, 'copilot', { workDir: '/test/copilot' });
    
    // Check for variable substitution (if spec uses workDir)
    expect(claudeResult.output).not.toContain('{{workDir}}');
    expect(copilotResult.output).not.toContain('{{workDir}}');
  });

});
```

**Run tests:**
```bash
npm test -- integration.test.js
```

Expected: 26+ tests passing (16 Phase 1-2 + 10 Phase 3)
  </action>
  <verify>
npm test -- integration.test.js 2>&1 | tail -20
# Should show 26+ tests passing, 0 failing
  </verify>
  <done>10+ Phase 3 integration tests added and passing, validating platform-specific generation from template specs</done>
</task>

<task type="auto">
  <name>Generate sample agents for both platforms</name>
  <files>
    test-output/claude/gsd-planner.md
    test-output/copilot/gsd-planner.md
  </files>
  <action>
Generate sample agents from template specs to demonstrate platform-specific output.

**Create output directory:**
```bash
mkdir -p test-output/claude test-output/copilot
```

**Generate Claude-optimized agent:**
```bash
node -e "
const { generateAgent } = require('./bin/lib/template-system/generator');
const fs = require('fs');

const result = generateAgent(
  'specs/agents/gsd-planner.md',
  'claude',
  { workDir: '/workspace', validate: true }
);

if (!result.success) {
  console.error('Generation failed:', result.errors);
  process.exit(1);
}

fs.writeFileSync('test-output/claude/gsd-planner.md', result.output, 'utf8');
console.log('✓ Generated Claude agent:', result.output.length, 'bytes');
"
```

**Generate Copilot-optimized agent:**
```bash
node -e "
const { generateAgent } = require('./bin/lib/template-system/generator');
const fs = require('fs');

const result = generateAgent(
  'specs/agents/gsd-planner.md',
  'copilot',
  { workDir: '.github/skills/get-shit-done', validate: true }
);

if (!result.success) {
  console.error('Generation failed:', result.errors);
  process.exit(1);
}

fs.writeFileSync('test-output/copilot/gsd-planner.md', result.output, 'utf8');
console.log('✓ Generated Copilot agent:', result.output.length, 'bytes');
"
```

**Validate outputs:**
```bash
# Verify files exist and have content
test -f test-output/claude/gsd-planner.md && echo "✓ Claude output exists"
test -f test-output/copilot/gsd-planner.md && echo "✓ Copilot output exists"

# Check Claude output has Claude-specific features
grep -q "WebFetch" test-output/claude/gsd-planner.md && echo "✓ Claude has WebFetch"
grep -q "model:" test-output/claude/gsd-planner.md && echo "✓ Claude has model field"

# Check Copilot output excludes Claude-specific features
! grep -q "WebFetch" test-output/copilot/gsd-planner.md && echo "✓ Copilot excludes WebFetch"
! grep -q "model:" test-output/copilot/gsd-planner.md && echo "✓ Copilot excludes model field"

# Verify lowercase tools in Copilot output
grep "tools:" test-output/copilot/gsd-planner.md | grep -q "bash" && echo "✓ Copilot uses lowercase tools"
```

**Diff analysis:**
```bash
# Show platform differences
echo "=== Platform Differences ==="
diff test-output/claude/gsd-planner.md test-output/copilot/gsd-planner.md || true
```

**Expected differences:**
- Claude: `tools: [Read, Write, Bash, WebFetch, mcp__context7__*]`
- Copilot: `tools: [read, write, bash, grep, glob]`
- Claude: `model: sonnet` (present)
- Copilot: (model field absent)
- Claude: Case-preserved tools
- Copilot: Lowercase tools

Both outputs should:
- Parse as valid YAML frontmatter + markdown
- Contain identical markdown body (agent logic)
- Have name, description, color fields
- Be 500-700 lines (substantive)
  </action>
  <verify>
# Files exist
test -f test-output/claude/gsd-planner.md && test -f test-output/copilot/gsd-planner.md

# Files are substantive (500+ lines each)
test $(wc -l < test-output/claude/gsd-planner.md) -gt 500
test $(wc -l < test-output/copilot/gsd-planner.md) -gt 500

# Platform-specific features present/absent
grep -q "WebFetch" test-output/claude/gsd-planner.md
! grep -q "WebFetch" test-output/copilot/gsd-planner.md
  </verify>
  <done>Sample agents generated for both platforms, demonstrating platform-specific optimizations and preserved functionality</done>
</task>

<task type="auto">
  <name>Create platform generation validation report</name>
  <files>test-output/VALIDATION-REPORT.md</files>
  <action>
Generate a comprehensive validation report documenting platform-specific generation results.

**Create validation script:**
```bash
node -e "
const fs = require('fs');
const { generateAgent } = require('./bin/lib/template-system/generator');
const { validateClaudeSpec, validateCopilotSpec } = require('./bin/lib/template-system/validators');
const matter = require('gray-matter');

const agentNames = [
  'gsd-planner', 'gsd-executor', 'gsd-verifier',
  'gsd-codebase-mapper', 'gsd-debugger', 'gsd-phase-researcher',
  'gsd-plan-checker', 'gsd-project-researcher', 'gsd-research-synthesizer',
  'gsd-roadmapper', 'gsd-integration-checker'
];

const report = [];
report.push('# Platform Generation Validation Report');
report.push('');
report.push('**Generated:** ' + new Date().toISOString());
report.push('**Agents tested:** ' + agentNames.length);
report.push('');

// Test each agent on both platforms
const results = { claude: [], copilot: [] };

for (const name of agentNames) {
  const specPath = \`specs/agents/\${name}.md\`;
  
  // Generate for Claude
  const claudeResult = generateAgent(specPath, 'claude');
  results.claude.push({
    name,
    success: claudeResult.success,
    size: claudeResult.success ? claudeResult.output.length : 0,
    errors: claudeResult.errors || [],
    warnings: claudeResult.warnings || []
  });
  
  // Validate Claude output
  if (claudeResult.success) {
    const parsed = matter(claudeResult.output);
    const validation = validateClaudeSpec(parsed.data);
    results.claude[results.claude.length - 1].valid = validation.valid;
    results.claude[results.claude.length - 1].validationErrors = validation.errors || [];
  }
  
  // Generate for Copilot
  const copilotResult = generateAgent(specPath, 'copilot');
  results.copilot.push({
    name,
    success: copilotResult.success,
    size: copilotResult.success ? copilotResult.output.length : 0,
    errors: copilotResult.errors || [],
    warnings: copilotResult.warnings || []
  });
  
  // Validate Copilot output
  if (copilotResult.success) {
    const parsed = matter(copilotResult.output);
    const validation = validateCopilotSpec(parsed.data);
    results.copilot[results.copilot.length - 1].valid = validation.valid;
    results.copilot[results.copilot.length - 1].validationErrors = validation.errors || [];
  }
}

// Summary stats
const claudeSuccess = results.claude.filter(r => r.success).length;
const claudeValid = results.claude.filter(r => r.valid).length;
const copilotSuccess = results.copilot.filter(r => r.success).length;
const copilotValid = results.copilot.filter(r => r.valid).length;

report.push('## Summary');
report.push('');
report.push('| Platform | Generated | Valid | Success Rate |');
report.push('|----------|-----------|-------|--------------|');
report.push(\`| Claude | \${claudeSuccess}/\${agentNames.length} | \${claudeValid}/\${claudeSuccess} | \${Math.round(claudeSuccess/agentNames.length*100)}% |\`);
report.push(\`| Copilot | \${copilotSuccess}/\${agentNames.length} | \${copilotValid}/\${copilotSuccess} | \${Math.round(copilotSuccess/agentNames.length*100)}% |\`);
report.push('');

// Claude results
report.push('## Claude Generation Results');
report.push('');
report.push('| Agent | Status | Size | Valid | Issues |');
report.push('|-------|--------|------|-------|--------|');
for (const r of results.claude) {
  const status = r.success ? '✓' : '✗';
  const valid = r.valid ? '✓' : (r.success ? '✗' : '-');
  const issues = [...r.errors, ...r.validationErrors].length;
  report.push(\`| \${r.name} | \${status} | \${r.size} | \${valid} | \${issues} |\`);
}
report.push('');

// Copilot results
report.push('## Copilot Generation Results');
report.push('');
report.push('| Agent | Status | Size | Valid | Issues |');
report.push('|-------|--------|------|-------|--------|');
for (const r of results.copilot) {
  const status = r.success ? '✓' : '✗';
  const valid = r.valid ? '✓' : (r.success ? '✗' : '-');
  const issues = [...r.errors, ...r.validationErrors].length;
  report.push(\`| \${r.name} | \${status} | \${r.size} | \${valid} | \${issues} |\`);
}
report.push('');

// Platform differences
report.push('## Platform Differences');
report.push('');
report.push('**Claude-specific features:**');
report.push('- Case-sensitive tool names (Bash, Read, Write)');
report.push('- WebFetch tool');
report.push('- MCP wildcard tools (mcp__context7__*)');
report.push('- Model field (sonnet, haiku, opus)');
report.push('- Hooks and skills support');
report.push('');
report.push('**Copilot-specific features:**');
report.push('- Lowercase tool names (bash, read, write)');
report.push('- MCP server configuration (mcp-servers field)');
report.push('- Excludes model, hooks, skills fields');
report.push('');

// Write report
fs.writeFileSync('test-output/VALIDATION-REPORT.md', report.join('\\n'), 'utf8');
console.log('✓ Validation report generated: test-output/VALIDATION-REPORT.md');
console.log('Claude: ' + claudeSuccess + '/' + agentNames.length + ' generated, ' + claudeValid + '/' + claudeSuccess + ' valid');
console.log('Copilot: ' + copilotSuccess + '/' + agentNames.length + ' generated, ' + copilotValid + '/' + copilotSuccess + ' valid');

// Exit with error if any failures
if (claudeSuccess < agentNames.length || copilotSuccess < agentNames.length) {
  console.error('Some agents failed to generate!');
  process.exit(1);
}
if (claudeValid < claudeSuccess || copilotValid < copilotSuccess) {
  console.error('Some agents failed validation!');
  process.exit(1);
}
"
```

Expected output: All 11 agents generate successfully and validate for both platforms (100% success rate).
  </action>
  <verify>
test -f test-output/VALIDATION-REPORT.md

# Check for success summary in report
grep -q "11/11" test-output/VALIDATION-REPORT.md || grep -q "100%" test-output/VALIDATION-REPORT.md
  </verify>
  <done>Validation report generated showing all 11 agents generate successfully and validate for both Claude and Copilot</done>
</task>

</tasks>

<verification>
**Structural checks:**
- [ ] integration.test.js has 26+ tests (16 Phase 1-2 + 10 Phase 3)
- [ ] test-output/claude/gsd-planner.md exists (600+ lines)
- [ ] test-output/copilot/gsd-planner.md exists (500+ lines)
- [ ] test-output/VALIDATION-REPORT.md exists

**Functional checks:**
- [ ] All integration tests pass (26+/26+ passing)
- [ ] Claude output contains WebFetch, model field
- [ ] Copilot output excludes WebFetch, model field
- [ ] Copilot tools are lowercase, Claude tools case-preserved

**Validation checks:**
- [ ] Generated Claude agents validate with validateClaudeSpec()
- [ ] Generated Copilot agents validate with validateCopilotSpec()
- [ ] Validation report shows 11/11 success for both platforms
- [ ] No template variables remain in generated output ({{}} resolved)

**Preservation checks:**
- [ ] Generated agents contain all original markdown body content
- [ ] Agent functionality preserved (spot check 3 agents)
- [ ] No content loss during template rendering
</verification>

<success_criteria>
1. Template specs generate valid Claude agent format (YAML + markdown)
2. Template specs generate valid Copilot agent format (YAML + markdown)
3. Claude outputs include platform-specific features (WebFetch, model, hooks)
4. Copilot outputs exclude Claude-only features and use lowercase tools
5. All 11 agents generate successfully for both platforms (22 outputs total)
6. Generated agents validate against respective platform specs
7. Platform-specific generation is automated via template system pipeline
8. Original agent functionality 100% preserved in generated output
</success_criteria>

<output>
After completion, create `.planning/phases/03-spec-migration-template-generation/03-03-SUMMARY.md` documenting:
- Platform generation test results (26+ tests passing)
- Sample agent generation (Claude vs Copilot differences)
- Validation report summary (11/11 agents successful)
- Platform-specific optimizations demonstrated
- Confirmation that functionality is preserved
</output>
