---
phase: 03-spec-migration-template-generation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - specs/agents/gsd-planner.md
  - specs/agents/gsd-executor.md
  - specs/agents/gsd-verifier.md
  - specs/agents/gsd-codebase-mapper.md
  - specs/agents/gsd-debugger.md
  - specs/agents/gsd-phase-researcher.md
  - specs/agents/gsd-plan-checker.md
  - specs/agents/gsd-project-researcher.md
  - specs/agents/gsd-research-synthesizer.md
  - specs/agents/gsd-roadmapper.md
  - specs/agents/gsd-integration-checker.md
  - bin/lib/template-system/migrate-agents.js
autonomous: true

must_haves:
  truths:
    - "All 11 agents exist as spec-as-template files in specs/agents/"
    - "Each spec contains template variables for platform differences"
    - "Specs preserve 100% of original agent content (no loss)"
    - "Pilot agent (gsd-planner) validates approach before bulk migration"
    - "Migration script automates conversion for remaining agents"
  artifacts:
    - path: "specs/agents/gsd-planner.md"
      provides: "Pilot template spec (first conversion)"
      min_lines: 600
      contains: "{{#isClaude}}"
    - path: "specs/agents/*.md"
      provides: "All 11 agent template specs"
      count: 11
    - path: "bin/lib/template-system/migrate-agents.js"
      provides: "Bulk migration script"
      exports: ["migrateAllAgents", "validateMigration"]
      min_lines: 100
  key_links:
    - from: "specs/agents/gsd-planner.md"
      to: "agents/gsd-planner.md"
      via: "converted from original using agent-converter"
      pattern: "content matches original with added conditionals"
    - from: "bin/lib/template-system/migrate-agents.js"
      to: "bin/lib/template-system/agent-converter.js"
      via: "uses convertAgentToSpec for each agent"
      pattern: "require.*agent-converter"
    - from: "specs/agents/*.md"
      to: "bin/lib/template-system/spec-parser.js"
      via: "all specs are valid and parseable"
      pattern: "parseSpec succeeds for all files"
---

<objective>
Convert all 11 existing agents to spec-as-template format with platform-specific template variables.

Purpose: Migrate the entire agent library from single-platform (Claude-optimized) format to dual-platform template format that generates optimized agents for both Claude and Copilot.

Output:
- All 11 agents converted to template specs in `specs/agents/`
- Pilot agent (gsd-planner) validated before bulk migration
- Migration script for automating conversion of remaining agents
- All specs validated as parseable and ready for generation
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Phase 3 Plan 1
@.planning/phases/03-spec-migration-template-generation/03-01-PLAN.md

# Conversion Utility
@bin/lib/template-system/agent-converter.js

# Current Agents (for reference)
@agents/gsd-planner.md
@agents/gsd-executor.md
@agents/gsd-verifier.md

# Template System
@bin/lib/template-system/spec-parser.js
@bin/lib/template-system/tool-mapper.js
@bin/lib/template-system/field-transformer.js
</context>

<tasks>

<task type="auto">
  <name>Convert pilot agent (gsd-planner) to spec-as-template</name>
  <files>specs/agents/gsd-planner.md</files>
  <action>
Convert gsd-planner as the pilot agent to validate the conversion approach before bulk migration.

**Steps:**

1. **Read original agent:**
   ```bash
   cat agents/gsd-planner.md
   ```

2. **Run conversion:**
   ```javascript
   const { convertAgentToSpec } = require('./bin/lib/template-system/agent-converter');
   const result = convertAgentToSpec('agents/gsd-planner.md');
   ```

3. **Manual review of conversion:**
   - Check that all content is preserved
   - Verify template variables are correctly placed:
     - `tools` field wrapped with {{#isClaude}}/{{#isCopilot}} conditionals
     - Claude-specific tools (WebFetch, mcp__context7__*) in {{#isClaude}} block
     - Shared tools (Read, Write, Bash, Glob, Grep) in both blocks
   - Verify frontmatter fields like `model`, `hooks`, `skills` are conditionally included
   - Check markdown body is untouched

4. **Write to specs/agents/:**
   ```bash
   # Output from converter
   echo "$result.spec" > specs/agents/gsd-planner.md
   ```

5. **Validate spec:**
   ```javascript
   const { parseSpec } = require('./bin/lib/template-system/spec-parser');
   parseSpec('specs/agents/gsd-planner.md'); // Should succeed
   ```

**Expected spec structure:**
```markdown
---
name: gsd-planner
description: Creates executable phase plans...
{{#isClaude}}
tools: [Read, Write, Bash, Glob, Grep, WebFetch, mcp__context7__*]
model: sonnet
{{/isClaude}}
{{#isCopilot}}
tools: [read, write, bash, glob, grep]
{{/isCopilot}}
color: green
---

<role>
You are a GSD planner...
</role>

<!-- Rest of markdown body unchanged -->
```

**Validation criteria:**
- Spec parses without errors
- Original content 100% preserved (diff shows only template additions)
- Template variables correctly positioned
- Ready for platform-specific generation

If pilot succeeds, this validates the approach for bulk migration of remaining 10 agents.
  </action>
  <verify>
# Spec exists and parses
test -f specs/agents/gsd-planner.md && node -e "require('./bin/lib/template-system/spec-parser').parseSpec('specs/agents/gsd-planner.md')"

# Contains template variables
grep -q "{{#isClaude}}" specs/agents/gsd-planner.md && grep -q "{{#isCopilot}}" specs/agents/gsd-planner.md
  </verify>
  <done>gsd-planner.md spec exists, contains template conditionals, parses successfully, preserves all original content</done>
</task>

<task type="auto">
  <name>Create bulk migration script</name>
  <files>bin/lib/template-system/migrate-agents.js</files>
  <action>
Create a migration script that automates conversion of all remaining agents.

**Module:** `bin/lib/template-system/migrate-agents.js`

**Exports:**
- `migrateAllAgents(sourceDir, targetDir, options)` - Migrate all agents in directory
- `validateMigration(specsDir)` - Validate all specs are parseable
- `generateMigrationReport()` - Report on migration success/warnings

**Implementation:**

```javascript
const fs = require('fs');
const path = require('path');
const { convertAgentToSpec } = require('./agent-converter');
const { parseSpec } = require('./spec-parser');

/**
 * Migrate all agents from source directory to target directory
 * @param {string} sourceDir - Path to agents/ directory
 * @param {string} targetDir - Path to specs/agents/ directory
 * @param {object} options - {dryRun, verbose, skipExisting}
 * @returns {object} {success: boolean, migrated: [], warnings: [], errors: []}
 */
function migrateAllAgents(sourceDir = 'agents', targetDir = 'specs/agents', options = {}) {
  const results = { migrated: [], warnings: [], errors: [] };
  
  // Get all .md files from source directory
  const agentFiles = fs.readdirSync(sourceDir)
    .filter(f => f.endsWith('.md'))
    .sort(); // Consistent order

  for (const file of agentFiles) {
    const sourcePath = path.join(sourceDir, file);
    const targetPath = path.join(targetDir, file);
    
    // Skip if target exists and skipExisting=true
    if (options.skipExisting && fs.existsSync(targetPath)) {
      results.warnings.push(`Skipped ${file} (already exists)`);
      continue;
    }

    try {
      // Convert agent to spec
      const conversionResult = convertAgentToSpec(sourcePath);
      
      if (!conversionResult.success) {
        results.errors.push({ file, errors: conversionResult.errors });
        continue;
      }

      // Dry run: don't write files
      if (options.dryRun) {
        results.migrated.push({ file, dryRun: true });
        if (options.verbose) {
          console.log(`[DRY RUN] Would migrate: ${file}`);
        }
        continue;
      }

      // Write spec to target directory
      fs.writeFileSync(targetPath, conversionResult.spec, 'utf8');
      
      // Validate written spec
      try {
        parseSpec(targetPath);
        results.migrated.push({ file, success: true });
        if (options.verbose) {
          console.log(`✓ Migrated: ${file}`);
        }
      } catch (validationError) {
        results.errors.push({ file, error: 'Validation failed after write', details: validationError.message });
        fs.unlinkSync(targetPath); // Remove invalid spec
      }

      // Collect warnings from conversion
      if (conversionResult.warnings && conversionResult.warnings.length > 0) {
        results.warnings.push({ file, warnings: conversionResult.warnings });
      }

    } catch (error) {
      results.errors.push({ file, error: error.message });
    }
  }

  results.success = results.errors.length === 0;
  return results;
}

/**
 * Validate all specs in directory are parseable
 */
function validateMigration(specsDir = 'specs/agents') {
  const results = { valid: [], invalid: [] };
  
  const specFiles = fs.readdirSync(specsDir)
    .filter(f => f.endsWith('.md'));

  for (const file of specFiles) {
    const specPath = path.join(specsDir, file);
    try {
      parseSpec(specPath);
      results.valid.push(file);
    } catch (error) {
      results.invalid.push({ file, error: error.message });
    }
  }

  return results;
}

module.exports = {
  migrateAllAgents,
  validateMigration,
};
```

**Usage:**
```bash
# Dry run to preview
node -e "const m = require('./bin/lib/template-system/migrate-agents'); console.log(JSON.stringify(m.migrateAllAgents('agents', 'specs/agents', {dryRun: true, verbose: true}), null, 2))"

# Actual migration
node -e "const m = require('./bin/lib/template-system/migrate-agents'); console.log(JSON.stringify(m.migrateAllAgents('agents', 'specs/agents', {verbose: true}), null, 2))"

# Validate all specs
node -e "const m = require('./bin/lib/template-system/migrate-agents'); console.log(JSON.stringify(m.validateMigration('specs/agents'), null, 2))"
```
  </action>
  <verify>
# Script exists and exports functions
node -e "const m = require('./bin/lib/template-system/migrate-agents'); console.log(typeof m.migrateAllAgents, typeof m.validateMigration)"
# Should output: function function
  </verify>
  <done>migrate-agents.js exists, exports migration functions, integrates with agent-converter and spec-parser</done>
</task>

<task type="auto">
  <name>Migrate remaining 10 agents</name>
  <files>
    specs/agents/gsd-executor.md
    specs/agents/gsd-verifier.md
    specs/agents/gsd-codebase-mapper.md
    specs/agents/gsd-debugger.md
    specs/agents/gsd-phase-researcher.md
    specs/agents/gsd-plan-checker.md
    specs/agents/gsd-project-researcher.md
    specs/agents/gsd-research-synthesizer.md
    specs/agents/gsd-roadmapper.md
    specs/agents/gsd-integration-checker.md
  </files>
  <action>
Run bulk migration for all remaining agents using the migration script.

**Pre-flight check:**
```bash
# Verify pilot agent exists and is valid
test -f specs/agents/gsd-planner.md || exit 1
node -e "require('./bin/lib/template-system/spec-parser').parseSpec('specs/agents/gsd-planner.md')" || exit 1
echo "✓ Pilot agent validated"
```

**Dry run first:**
```bash
node -e "
const { migrateAllAgents } = require('./bin/lib/template-system/migrate-agents');
const result = migrateAllAgents('agents', 'specs/agents', { 
  dryRun: true, 
  verbose: true, 
  skipExisting: true 
});
console.log('Dry run results:');
console.log('Would migrate:', result.migrated.length);
console.log('Warnings:', result.warnings.length);
console.log('Errors:', result.errors.length);
if (result.errors.length > 0) {
  console.error('Errors:', JSON.stringify(result.errors, null, 2));
  process.exit(1);
}
"
```

**Actual migration:**
```bash
node -e "
const { migrateAllAgents } = require('./bin/lib/template-system/migrate-agents');
const result = migrateAllAgents('agents', 'specs/agents', { 
  verbose: true, 
  skipExisting: true  // Don't overwrite gsd-planner.md
});

console.log('\nMigration complete!');
console.log('Migrated:', result.migrated.length, 'agents');
console.log('Warnings:', result.warnings.length);
console.log('Errors:', result.errors.length);

if (result.warnings.length > 0) {
  console.log('\nWarnings:');
  result.warnings.forEach(w => console.log(' -', JSON.stringify(w)));
}

if (result.errors.length > 0) {
  console.error('\nErrors:');
  result.errors.forEach(e => console.error(' -', JSON.stringify(e)));
  process.exit(1);
}

if (!result.success) {
  console.error('Migration failed!');
  process.exit(1);
}
"
```

**Validation:**
```bash
node -e "
const { validateMigration } = require('./bin/lib/template-system/migrate-agents');
const result = validateMigration('specs/agents');

console.log('\nValidation results:');
console.log('Valid specs:', result.valid.length);
console.log('Invalid specs:', result.invalid.length);

if (result.invalid.length > 0) {
  console.error('\nInvalid specs:');
  result.invalid.forEach(i => console.error(' -', i.file, ':', i.error));
  process.exit(1);
}

console.log('\n✓ All', result.valid.length, 'specs are valid');
"
```

**Verify all 11 agents migrated:**
```bash
# Should list 11 .md files
ls -1 specs/agents/*.md | wc -l

# Should output: 11
```

**Expected files:**
- specs/agents/gsd-planner.md
- specs/agents/gsd-executor.md
- specs/agents/gsd-verifier.md
- specs/agents/gsd-codebase-mapper.md
- specs/agents/gsd-debugger.md
- specs/agents/gsd-phase-researcher.md
- specs/agents/gsd-plan-checker.md
- specs/agents/gsd-project-researcher.md
- specs/agents/gsd-research-synthesizer.md
- specs/agents/gsd-roadmapper.md
- specs/agents/gsd-integration-checker.md

Each spec should:
- Parse successfully with spec-parser
- Contain template variables ({{#isClaude}}, {{#isCopilot}})
- Preserve 100% of original agent content
  </action>
  <verify>
# Count specs (should be 11)
test $(ls -1 specs/agents/*.md | wc -l) -eq 11

# Validate all specs parse
node -e "const {validateMigration} = require('./bin/lib/template-system/migrate-agents'); const r = validateMigration('specs/agents'); console.log(r.valid.length, 'valid,', r.invalid.length, 'invalid'); process.exit(r.invalid.length > 0 ? 1 : 0)"

# Check for template variables in all specs
for f in specs/agents/*.md; do grep -q "{{#isClaude}}" "$f" || echo "Missing template vars: $f"; done
  </verify>
  <done>All 11 agents converted to spec-as-template format, all specs validate successfully, template variables present in all files</done>
</task>

</tasks>

<verification>
**Structural checks:**
- [ ] specs/agents/ contains exactly 11 .md files
- [ ] Each spec file is 200+ lines (substantive content)
- [ ] migrate-agents.js exists with 100+ lines

**Content checks:**
- [ ] All specs contain {{#isClaude}} conditionals
- [ ] All specs contain {{#isCopilot}} conditionals
- [ ] All specs parse successfully with spec-parser

**Functional checks:**
- [ ] Pilot agent (gsd-planner) validated before bulk migration
- [ ] Migration script automated remaining 10 agents
- [ ] validateMigration() reports 11 valid, 0 invalid specs

**Preservation checks:**
- [ ] Original agent content preserved (spot check 3 agents)
- [ ] Template variables added without content loss
- [ ] Markdown bodies unchanged
</verification>

<success_criteria>
1. All 11 agents exist as template specs in specs/agents/
2. Pilot agent (gsd-planner) successfully validates conversion approach
3. Bulk migration script automates conversion of remaining 10 agents
4. All 11 specs parse successfully (validateMigration reports 0 invalid)
5. Template variables correctly placed for platform differences
6. 100% of original agent content preserved (no functionality loss)
</success_criteria>

<output>
After completion, create `.planning/phases/03-spec-migration-template-generation/03-02-SUMMARY.md` documenting:
- Migration approach (pilot → bulk)
- Number of agents converted (11/11)
- Validation results (all specs parse successfully)
- Template variable patterns used
- Any warnings encountered during migration
</output>
