---
phase: 03-spec-migration-template-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - specs/agents/.gitkeep
  - bin/lib/template-system/agent-converter.js
  - bin/lib/template-system/agent-converter.test.js
autonomous: true

must_haves:
  truths:
    - "specs/agents/ directory exists and is ready for template files"
    - "Converter utility can parse existing agent files"
    - "Converter identifies platform-specific content for templating"
    - "Converted spec preserves all original agent content"
    - "Unit tests verify conversion logic for all agent patterns"
  artifacts:
    - path: "specs/agents/"
      provides: "Template spec storage directory"
      min_lines: 0
    - path: "bin/lib/template-system/agent-converter.js"
      provides: "Agent-to-spec conversion utility"
      exports: ["convertAgentToSpec", "extractPlatformVariables"]
      min_lines: 150
    - path: "bin/lib/template-system/agent-converter.test.js"
      provides: "Conversion utility tests"
      min_lines: 100
  key_links:
    - from: "bin/lib/template-system/agent-converter.js"
      to: "bin/lib/template-system/spec-parser.js"
      via: "uses parseSpec to validate output"
      pattern: "require.*spec-parser"
    - from: "bin/lib/template-system/agent-converter.js"
      to: "gray-matter"
      via: "parses existing agent frontmatter"
      pattern: "require.*gray-matter"
---

<objective>
Create spec-as-template infrastructure and conversion utilities for migrating existing agents to template format.

Purpose: Establish the foundation for agent migration by creating the storage structure and automated conversion tools that preserve all agent functionality while adding platform-specific templating.

Output: 
- `specs/agents/` directory ready for template files
- Conversion utility that transforms existing agents to spec-as-template format
- Test suite validating conversion preserves content and adds proper template variables
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/research/SUMMARY.md
@.planning/research/ARCHITECTURE.md

# Phase 1 & 2 Foundation
@.planning/phases/01-template-engine-foundation/01-03-SUMMARY.md
@.planning/phases/02-platform-abstraction-layer/02-03-SUMMARY.md

# Template System Modules
@bin/lib/template-system/spec-parser.js
@bin/lib/template-system/tool-mapper.js
@bin/lib/template-system/field-transformer.js

# Example Current Agent
@agents/gsd-planner.md
</context>

<tasks>

<task type="auto">
  <name>Create specs directory structure</name>
  <files>specs/agents/.gitkeep</files>
  <action>
Create the specs directory structure that will hold template-format agent specs:

1. Create `specs/agents/` directory
2. Add `.gitkeep` to ensure directory is tracked in git
3. Update `.gitignore` if needed to ensure specs/ is tracked (not ignored like agents/)

The spec-as-template pattern means agent spec files ARE the templates - they contain YAML frontmatter + markdown body with template variables like `{{platform}}`, `{{#isClaude}}...{{/isClaude}}`, etc.

Directory structure after this task:
```
specs/
└── agents/
    └── .gitkeep
```
  </action>
  <verify>ls -la specs/agents/ shows directory exists with .gitkeep</verify>
  <done>specs/agents/ directory created and ready to receive template files</done>
</task>

<task type="auto">
  <name>Create agent-to-spec converter utility</name>
  <files>bin/lib/template-system/agent-converter.js</files>
  <action>
Create a conversion utility that transforms existing agent files into spec-as-template format.

**Module:** `bin/lib/template-system/agent-converter.js`

**Exports:**
- `convertAgentToSpec(agentPath, options)` - Main conversion function
- `extractPlatformVariables(agentContent)` - Identifies platform-specific content
- `wrapWithConditionals(content, platform)` - Wraps content in template conditionals

**Conversion Logic:**

1. **Parse existing agent:**
   - Use gray-matter to extract YAML frontmatter + markdown body
   - Preserve all content exactly as-is (no loss)

2. **Identify platform-specific content:**
   - Tool names that differ by platform (case sensitivity, availability)
   - Claude-specific: WebFetch, mcp__context7__*, model field, hooks field, skills field
   - Copilot-specific: mcp-servers configuration
   - Shared tools: Bash, Read, Write, Edit, Glob, Grep

3. **Add template variables:**
   - Replace platform-specific tools with conditionals:
     ```yaml
     {{#isClaude}}
     tools: [Read, Write, Bash, WebFetch, mcp__context7__*]
     {{/isClaude}}
     {{#isCopilot}}
     tools: [read, write, bash]
     {{/isCopilot}}
     ```
   - Add platform field conditionals for model, hooks, skills (Claude-only)
   - Wrap mcp-servers in {{#isCopilot}} conditional

4. **Validate output:**
   - Use spec-parser.parseSpecString() to ensure output is valid
   - Return structured result: `{success, spec, warnings, errors}`

**Important:**
- Preserve ALL original content (comments, formatting, etc.)
- Default to {{#isClaude}} for ambiguous content (backward compatibility)
- Add comments explaining template variables for future maintainers
- Handle edge cases: empty frontmatter, missing tools, etc.

**Integration:**
- Import spec-parser for validation
- Import gray-matter for parsing
- Export functions for use by migration scripts
  </action>
  <verify>
node -e "const c = require('./bin/lib/template-system/agent-converter'); console.log(typeof c.convertAgentToSpec, typeof c.extractPlatformVariables)"
Should output: function function
  </verify>
  <done>agent-converter.js exists, exports conversion functions, integrates with spec-parser for validation</done>
</task>

<task type="auto">
  <name>Create converter unit tests</name>
  <files>bin/lib/template-system/agent-converter.test.js</files>
  <action>
Create comprehensive unit tests for the agent-converter module.

**Test file:** `bin/lib/template-system/agent-converter.test.js`

**Test coverage (15+ tests):**

1. **Basic Conversion:**
   - Converts simple agent with shared tools only
   - Preserves frontmatter fields (name, description, color)
   - Preserves markdown body exactly

2. **Platform-Specific Tools:**
   - Converts Claude-specific tools (WebFetch, MCP wildcards) to conditionals
   - Converts mixed tools (shared + platform-specific)
   - Handles lowercase vs case-preserved tools

3. **Platform-Specific Fields:**
   - Wraps model field in {{#isClaude}} conditional
   - Wraps hooks field in {{#isClaude}} conditional
   - Wraps skills field in {{#isClaude}} conditional
   - Wraps mcp-servers in {{#isCopilot}} conditional

4. **Edge Cases:**
   - Handles agent with no tools field
   - Handles agent with empty frontmatter
   - Handles agent with only markdown (no frontmatter)
   - Handles invalid YAML gracefully

5. **Validation:**
   - Output spec parses correctly with spec-parser
   - Round-trip: convert → render with context → matches original behavior
   - Warns when ambiguous content detected

**Test pattern:**
```javascript
test('converts agent with Claude-specific tools to conditionals', () => {
  const input = `---
name: test-agent
tools: [Read, Write, WebFetch, mcp__context7__*]
---
<role>Test</role>`;

  const result = convertAgentToSpec(input);
  
  expect(result.success).toBe(true);
  expect(result.spec).toContain('{{#isClaude}}');
  expect(result.spec).toContain('WebFetch');
  expect(result.spec).toContain('{{/isClaude}}');
});
```

Run tests with: `npm test -- agent-converter.test.js`
  </action>
  <verify>npm test -- agent-converter.test.js shows all tests passing</verify>
  <done>15+ unit tests pass, covering all conversion scenarios and edge cases</done>
</task>

</tasks>

<verification>
**Structural checks:**
- [ ] specs/agents/ directory exists
- [ ] agent-converter.js exists with 150+ lines
- [ ] agent-converter.test.js exists with 100+ lines
- [ ] Exports verified: convertAgentToSpec, extractPlatformVariables

**Functional checks:**
- [ ] Unit tests pass (15+ tests)
- [ ] Converter imports spec-parser and gray-matter
- [ ] Output specs are valid (parseable by spec-parser)

**Integration checks:**
- [ ] No breaking changes to existing template system
- [ ] Converter integrates with Phase 1 & 2 modules
</verification>

<success_criteria>
1. specs/agents/ directory created and tracked in git
2. agent-converter.js successfully converts existing agents to spec-as-template format
3. Platform-specific content wrapped in template conditionals ({{#isClaude}}, {{#isCopilot}})
4. All original agent content preserved (no loss of functionality)
5. 15+ unit tests verify conversion logic for all patterns
6. Converted specs validate with spec-parser (no syntax errors)
</success_criteria>

<output>
After completion, create `.planning/phases/03-spec-migration-template-generation/03-01-SUMMARY.md` documenting:
- Spec directory structure created
- Converter utility capabilities and exports
- Test coverage metrics
- Key decisions about template variable patterns
</output>
