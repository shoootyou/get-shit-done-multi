---
phase: 03-interactive-menu
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/menu/interactive-menu.js
  - bin/lib/menu/interactive-menu.test.js
  - bin/install.js
autonomous: false
must_haves:
  - truth: "Running install.js without platform flags shows interactive checkbox menu for platform selection"
    artifact: bin/lib/menu/interactive-menu.js
    wiring: install.js calls showInteractiveMenu when needsMenu is true
    key_link: needsMenu flag integration
  - truth: "Users can select multiple platforms using Space key and confirm with Enter"
    artifact: bin/lib/menu/interactive-menu.js
    wiring: Prompts multiselect type with validation
    key_link: Platform multiselect prompt
  - truth: "After platform selection, users see radio menu for Local/Global scope (Local default)"
    artifact: bin/lib/menu/interactive-menu.js
    wiring: Sequential prompts array with scope select
    key_link: Scope select prompt
  - truth: "Selecting 'All' overrides individual platform selections, results in all three platforms"
    artifact: bin/lib/menu/interactive-menu.js
    wiring: Post-prompt transform logic checks for 'all' in platforms array
    key_link: All platform override
  - truth: "Empty platform selection shows inline error 'At least one platform must be selected' and re-prompts"
    artifact: bin/lib/menu/interactive-menu.js
    wiring: Prompts validate function on multiselect
    key_link: Empty selection validation
  - truth: "Non-TTY environment (CI/CD, piped input) shows error and exits with code 1"
    artifact: bin/lib/menu/interactive-menu.js
    wiring: process.stdin.isTTY check before prompts
    key_link: TTY detection guard
  - truth: "Menu returns same format as flag parser: { platforms, scope, needsMenu: false }"
    artifact: bin/lib/menu/interactive-menu.js
    wiring: Return object matches Phase 2 flag-parser output structure
    key_link: Phase 2 integration compatibility
---

# Phase 3, Plan 1: Interactive Menu Implementation

**Objective:** Implement Prompts-based interactive menu for platform and scope selection when no flags provided

## Context

Phase 2 completed the flag parsing system with a `needsMenu` flag that triggers when no platform flags are provided. Phase 3 implements the interactive menu that activates in this mode.

The menu must:
- Use Prompts 2.4.2 library (already installed in Phase 1)
- Show checkbox multiselect for platforms (Claude, Copilot, Codex, All)
- Show radio select for scope (Local, Global) with Local default
- Handle "All" as override (not additive)
- Validate empty selections and re-prompt
- Detect non-TTY and error (not auto-proceed)
- Return flag-parser-compatible format

Integration point: `install.js` line 179-184 where `needsMenu` is checked.

## Tasks

<task name="create-menu-module" type="auto">
  <files>bin/lib/menu/interactive-menu.js</files>
  <action>
    Create interactive menu module using Prompts 2.4.2 library.

    Module exports: `showInteractiveMenu(scopeFromFlags = null)`
    
    Implementation requirements:
    
    1. **TTY Detection** (first, before prompts):
       - Check `!process.stdin.isTTY` before showing prompts
       - If non-TTY, throw error: "Interactive menu requires TTY. Use explicit flags for non-interactive environments."
       - This prevents hanging in CI/CD, Docker, piped input
    
    2. **Sequential Prompts** (use array pattern):
       ```javascript
       const questions = [
         {
           type: 'multiselect',
           name: 'platforms',
           message: 'Select platforms to install (Space to toggle, Enter to confirm):',
           choices: [
             { title: 'Claude', value: 'claude' },
             { title: 'Copilot', value: 'copilot' },
             { title: 'Codex', value: 'codex' },
             { title: 'All', value: 'all' }
           ],
           instructions: false,
           validate: value => value.length === 0 
             ? 'At least one platform must be selected' 
             : true
         },
         {
           type: () => scopeFromFlags ? null : 'select',  // Skip if scope preset
           name: 'scope',
           message: 'Select installation scope:',
           choices: [
             { title: 'Local', value: 'local' },
             { title: 'Global', value: 'global' }
           ],
           initial: 0  // Default to Local
         }
       ];
       ```
    
    3. **Cancel Handling**:
       - Use onCancel callback in prompts options
       - Show message: "Installation cancelled"
       - Exit with code 0 (user choice, not error)
       ```javascript
       const response = await prompts(questions, {
         onCancel: () => {
           console.log('\nInstallation cancelled');
           process.exit(0);
         }
       });
       ```
    
    4. **"All" Platform Override**:
       - After prompts complete, check if 'all' in platforms array
       - If yes, replace with ['claude', 'copilot', 'codex']
       - This is override behavior, not additive
       ```javascript
       let platforms = response.platforms;
       if (platforms.includes('all')) {
         platforms = ['claude', 'copilot', 'codex'];
       }
       ```
    
    5. **Return Flag-Parser Format**:
       ```javascript
       return {
         platforms,  // Array of strings
         scope: scopeFromFlags || response.scope,
         needsMenu: false  // Menu complete
       };
       ```
    
    Reference: `.planning/phases/03-interactive-menu/03-RESEARCH.md` for complete menu module pattern
    Reference: `.planning/phases/03-interactive-menu/03-CONTEXT.md` for menu behavior decisions
  </action>
  <verify>
    1. File exists: `bin/lib/menu/interactive-menu.js`
    2. Module exports `showInteractiveMenu` function
    3. Function is async (returns Promise)
    4. TTY check is first operation (before prompts)
    5. Uses prompts array pattern (not separate calls)
    6. Validate function on multiselect (empty check)
    7. onCancel handler present
    8. "All" override logic after prompts
    9. Return format matches: `{ platforms: [], scope: '', needsMenu: false }`
  </verify>
  <done>
    Interactive menu module created with TTY detection, sequential prompts, validation, cancel handling, and flag-parser-compatible output
  </done>
</task>

<task name="integrate-menu-into-install" type="auto">
  <files>bin/install.js</files>
  <action>
    Replace the temporary Phase 3 placeholder (lines 179-184) with actual menu integration.

    Current code (lines 179-184):
    ```javascript
    if (needsMenu) {
      console.log(`  ${cyan}ℹ️  Interactive menu will be implemented in Phase 3${reset}`);
      console.log(`  ${dim}For now, defaulting to: install all platforms locally${reset}\n`);
      platforms = ['claude', 'copilot', 'codex'];
      scope = 'local';
    }
    ```

    Replace with:
    ```javascript
    if (needsMenu) {
      const { showInteractiveMenu } = require('./lib/menu/interactive-menu');
      try {
        const menuConfig = await showInteractiveMenu(scope);
        platforms = menuConfig.platforms;
        scope = menuConfig.scope;
      } catch (err) {
        console.error(`  ${yellow}${err.message}${reset}`);
        process.exit(1);
      }
    }
    ```

    Notes:
    - The main function is already async (line 159), so await works
    - Error handling catches TTY detection errors and menu failures
    - `scope` parameter passed to menu (handles scope-only flag case: `--global`)
    - Menu returns same format as flag parser, downstream code unchanged
  </action>
  <verify>
    1. Temporary placeholder removed (lines 179-184)
    2. Menu module imported: `require('./lib/menu/interactive-menu')`
    3. Menu called with await: `await showInteractiveMenu(scope)`
    4. Try/catch block wraps menu call
    5. Error message uses yellow color and resets
    6. Exit code 1 on error
    7. platforms and scope updated from menuConfig
  </verify>
  <done>
    Interactive menu integrated into install.js, replacing temporary placeholder with actual Prompts-based menu
  </done>
</task>

<task name="test-menu-module" type="auto">
  <files>bin/lib/menu/interactive-menu.test.js</files>
  <action>
    Create comprehensive test suite for interactive menu module.

    Use Jest with prompts.inject() for programmatic answer injection (testing pattern).

    Test coverage:

    **TTY Detection Tests** (5 tests):
    1. Throws error when `process.stdin.isTTY` is falsy
    2. Error message matches expected: "Interactive menu requires TTY..."
    3. Does not throw when TTY is present
    4. Mock stdin.isTTY as undefined (CI/CD behavior)
    5. Mock stdin.isTTY as false (piped input behavior)

    **Platform Selection Tests** (8 tests):
    1. Single platform selection (inject ['claude'])
    2. Multiple platform selection (inject ['claude', 'copilot'])
    3. All three platforms individually (inject ['claude', 'copilot', 'codex'])
    4. "All" selection overrides to all three platforms
    5. "All" plus individual selections → still results in all three (override, not additive)
    6. Empty selection validation (inject [], expect re-prompt via validate function)
    7. Platform array returned in response.platforms
    8. needsMenu is false in return value

    **Scope Selection Tests** (5 tests):
    1. Local scope selected (inject 'local')
    2. Global scope selected (inject 'global')
    3. Default is Local when Enter pressed immediately
    4. Scope returned in response.scope
    5. When scopeFromFlags provided, scope prompt skipped (type returns null)

    **Scope Preset Tests** (3 tests):
    1. `showInteractiveMenu('global')` skips scope prompt
    2. Return value uses provided scope: `response.scope === 'global'`
    3. `showInteractiveMenu('local')` skips scope prompt

    **Cancel Handling Tests** (2 tests):
    1. Cancel during platform selection exits with code 0
    2. onCancel callback logs "Installation cancelled"

    **Integration Format Tests** (3 tests):
    1. Return format matches flag parser: `{ platforms, scope, needsMenu }`
    2. platforms is array of strings
    3. scope is string ('local' or 'global')

    Test setup pattern:
    ```javascript
    const prompts = require('prompts');
    const { showInteractiveMenu } = require('./interactive-menu');

    // Mock TTY
    beforeEach(() => {
      process.stdin.isTTY = true;
      process.stdout.isTTY = true;
    });

    afterEach(() => {
      prompts.inject([]);  // Clear injected values
    });

    test('single platform selection', async () => {
      prompts.inject([
        ['claude'],  // multiselect answer (array)
        'local'      // select answer (string)
      ]);
      
      const result = await showInteractiveMenu();
      
      expect(result.platforms).toEqual(['claude']);
      expect(result.scope).toBe('local');
      expect(result.needsMenu).toBe(false);
    });
    ```

    Reference: Phase 2 test patterns in `bin/lib/flag-parser.test.js` for console mocking
    Reference: `.planning/phases/03-interactive-menu/03-RESEARCH.md` for prompts.inject() usage
  </action>
  <verify>
    1. Test file created: `bin/lib/menu/interactive-menu.test.js`
    2. All test categories present (TTY, platform, scope, preset, cancel, format)
    3. Uses prompts.inject() for answer injection
    4. TTY is mocked in beforeEach
    5. At least 26 tests total
    6. All tests pass: `npm test -- interactive-menu.test.js`
    7. Coverage >80% for interactive-menu.js
  </verify>
  <done>
    Comprehensive test suite created covering TTY detection, platform/scope selection, validation, cancel handling, and integration format
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Interactive menu system with Prompts library
    - Checkbox multiselect for platforms (Space/Enter controls)
    - Radio select for scope (Local default)
    - TTY detection and non-TTY error
    - Empty selection validation
    - "All" platform override logic
    - Cancel handling (Ctrl+C, Esc)
    - Integration with Phase 2 flag parser format
  </what-built>
  <how-to-verify>
    **Test 1: Basic menu flow**
    1. Run: `cd /workspace && node bin/install.js`
    2. Should see platform selection menu with checkboxes
    3. Use Space to toggle "Claude", press Enter
    4. Should see scope selection menu with radio buttons
    5. Press Enter (Local is default)
    6. Should see parsed configuration output
    
    **Test 2: Multi-platform selection**
    1. Run: `node bin/install.js`
    2. Space on "Claude", Space on "Copilot", Enter
    3. Arrow down to "Global", Enter
    4. Verify output shows: `claude → global` and `copilot → global`
    
    **Test 3: "All" platform override**
    1. Run: `node bin/install.js`
    2. Space on "All", Enter
    3. Arrow down to "Global", Enter
    4. Verify output shows all three: `claude → global`, `copilot → global`, `codex → local` (with warning)
    
    **Test 4: Empty selection validation**
    1. Run: `node bin/install.js`
    2. Press Enter without selecting any platforms
    3. Should see error: "At least one platform must be selected"
    4. Menu should re-prompt (not exit)
    5. Select a platform and verify it continues
    
    **Test 5: Cancel handling**
    1. Run: `node bin/install.js`
    2. Press Ctrl+C or Esc
    3. Should see: "Installation cancelled"
    4. Should exit cleanly (no stack trace)
    
    **Test 6: Non-TTY error**
    1. Run: `echo "" | node bin/install.js`
    2. Should see error: "Interactive menu requires TTY. Use explicit flags for non-interactive environments."
    3. Should exit with code 1
    
    **Test 7: Scope-only flag (partial flags)**
    1. Run: `node bin/install.js --global`
    2. Should see platform menu ONLY (no scope menu)
    3. Select "Claude", Enter
    4. Verify output: `claude → global` (scope from flag, not menu)
    
    **Test 8: Platform flag skips menu**
    1. Run: `node bin/install.js --claude`
    2. Should NOT see menu (flag parser handles it)
    3. Should see: `claude → local` (default scope)
    
    Expected behavior:
    - Menu is clean and readable (no ANSI artifacts)
    - Instructions are clear ("Space to toggle, Enter to confirm")
    - Checkbox visual: `[ ]` unchecked, `[✓]` checked
    - Radio visual: `( )` unselected, `(•)` selected
    - Colors match GSD theme (cyan for prompts)
    - All platforms route to existing codex warning logic
  </how-to-verify>
  <resume-signal>
    Type "approved" to continue, or describe any issues found
  </resume-signal>
</task>

## Verification

<verification>
  <requirement id="MENU-01">
    <status>covered</status>
    <evidence>
      Task 2 integrates menu at `needsMenu` check point (install.js line 179)
      TTY detection in Task 1 prevents non-TTY from showing prompts
    </evidence>
  </requirement>
  
  <requirement id="MENU-02">
    <status>covered</status>
    <evidence>
      Task 1 implements multiselect with four choices (Claude, Copilot, Codex, All)
      Checkbox UI via prompts type: 'multiselect'
    </evidence>
  </requirement>
  
  <requirement id="MENU-03">
    <status>covered</status>
    <evidence>
      Task 1 implements select type with two choices (Local, Global)
      Default: Local (initial: 0)
      Sequential prompts execute platform → scope
    </evidence>
  </requirement>
  
  <requirement id="MENU-04">
    <status>covered</status>
    <evidence>
      Task 1 TTY detection throws error in non-TTY (not auto-proceed)
      Error message: "Interactive menu requires TTY. Use explicit flags for non-interactive environments."
      Exit code: 1
    </evidence>
  </requirement>
</verification>

## Success Criteria

Phase 3 is complete when:

1. ✅ Interactive menu shows when no platform flags provided
2. ✅ Platform selection uses multiselect (Space/Enter)
3. ✅ Scope selection uses radio (Arrow/Enter) with Local default
4. ✅ "All" selection results in all three platforms
5. ✅ Empty selection shows error and re-prompts
6. ✅ Non-TTY shows error and exits (no auto-proceed)
7. ✅ Cancel (Ctrl+C, Esc) exits cleanly
8. ✅ Scope-only flags trigger platform menu only
9. ✅ Menu output matches flag parser format
10. ✅ Tests cover all scenarios with >80% coverage
11. ✅ Manual verification checkpoint passed

## Output

At completion:
- `bin/lib/menu/interactive-menu.js` - Menu module with TTY detection, prompts, validation
- `bin/lib/menu/interactive-menu.test.js` - Comprehensive test suite (26+ tests)
- `bin/install.js` - Menu integrated at needsMenu check point
- All tests passing
- Manual QA confirms menu works as expected
