---
phase: 06-orchestration-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/orchestration/structured-return-parser.js
  - bin/lib/orchestration/parallel-spawn-validator.js
  - bin/lib/orchestration/structured-return-parser.test.js
  - bin/lib/orchestration/parallel-spawn-validator.test.js
autonomous: true
must_haves:
  - Parser extracts status from ## RESEARCH COMPLETE, ## PLAN COMPLETE, ## EXECUTION COMPLETE blocks
  - Parser handles malformed returns (missing headers, duplicate headers, wrong format)
  - Parallel spawn validator measures execution time to verify concurrent execution
  - Parallel spawn validator confirms all expected agents are spawned
  - Test suite validates gsd-new-project parallel spawning (4 researcher agents)
---

# Phase 6, Plan 1: Structured Returns + Parallel Spawning

## Objective

Create validators for structured return parsing and parallel subagent spawning. These are the foundational patterns for orchestration: orchestrators spawn multiple agents concurrently and parse their markdown output to route next actions.

## Context

**From RESEARCH.md:**
- Orchestrators use Task() to spawn subagents, which return structured markdown
- Return format: `## RESEARCH COMPLETE`, `## PLAN COMPLETE`, `## EXECUTION COMPLETE`
- Parallel spawning: gsd-new-project spawns 4 researcher agents concurrently
- Infrastructure exists in `bin/lib/orchestration/` (result-validator.js, equivalence-test.js, agent-invoker.js)

**Wave 1 scope:** Build parsing and parallel validation modules, test against gsd-new-project (simplest parallel orchestrator).

**Next waves:** Plan 2 adds sequential spawning validation, Plan 3 creates comprehensive test suite.

## Tasks

<task name="create-structured-return-parser" type="auto">
  <files>bin/lib/orchestration/structured-return-parser.js</files>
  <action>
Create structured return parser module that extracts status blocks from agent markdown output.

**Function: parseStructuredReturn(markdown)**

Input: Agent output markdown string
Output: Object with { status, content, raw }

**Logic:**
1. Search for patterns: `/^## RESEARCH COMPLETE$/m`, `/^## PLAN COMPLETE$/m`, `/^## EXECUTION COMPLETE$/m`, `/^## RESEARCH BLOCKED$/m`
2. Extract header and content section (from header to next ## or end of string)
3. Parse status: "RESEARCH COMPLETE" → "research_complete"
4. Return object: `{ status: 'research_complete', content: '...', raw: markdown }`
5. If no match: return `{ status: 'unknown', content: markdown, raw: markdown }`

**Error handling:**
- Malformed markdown (missing ##): status = 'unknown'
- Multiple headers: use first match
- Empty content: content = ''

**Reference pattern:** RESEARCH.md Pattern 1 (lines 77-114)

**No external dependencies:** Use built-in String.match(), regex only
  </action>
  <verify>
```bash
node -e "
const parser = require('./bin/lib/orchestration/structured-return-parser');

// Test valid return
const valid = '## RESEARCH COMPLETE\n\nPhase: 1\nFiles created: X';
const result = parser.parseStructuredReturn(valid);
console.assert(result.status === 'research_complete', 'Status should be research_complete');
console.assert(result.content.includes('Phase: 1'), 'Content should include phase info');

// Test malformed return
const malformed = 'No structured header here';
const result2 = parser.parseStructuredReturn(malformed);
console.assert(result2.status === 'unknown', 'Malformed should return unknown status');

// Test multiple headers
const multi = '## RESEARCH COMPLETE\n\nData\n\n## PLAN COMPLETE\n\nMore';
const result3 = parser.parseStructuredReturn(multi);
console.assert(result3.status === 'research_complete', 'Should use first match');

console.log('✓ Structured return parser working');
"
```
  </verify>
  <done>
Parser correctly extracts status and content from structured markdown returns, handles malformed input gracefully.
  </done>
</task>

<task name="create-parallel-spawn-validator" type="auto">
  <files>bin/lib/orchestration/parallel-spawn-validator.js</files>
  <action>
Create parallel spawning validator that verifies multiple Task() calls execute concurrently.

**Function: validateParallelSpawning(orchestratorCmd, expectedAgents, testPrompt)**

Input: 
- orchestratorCmd: Command name (e.g., 'gsd-new-project')
- expectedAgents: Array of agent names expected to spawn
- testPrompt: Prompt to pass to orchestrator

Output: Object with { success: boolean, duration: number, agents: string[], parallel: boolean }

**Logic:**
1. Record start time
2. Invoke orchestrator (use existing bin/lib/orchestration/agent-invoker.js if available)
3. Track spawned agents (watch for Task() invocations in output)
4. Record end time
5. Verify all expectedAgents were spawned
6. Calculate parallelism: duration < sequentialEstimate * 0.7
7. Return result object

**Parallelism check:**
- Sequential: duration ≈ sum of individual agent durations
- Parallel: duration ≈ max(individual agent durations)
- Threshold: parallel if duration < 70% of sequential estimate

**Reference pattern:** RESEARCH.md Pattern 2 (lines 116-155)

**Integration:** Reuse agent-invoker.js if exists, else implement basic child_process.spawn()

**Error handling:**
- Orchestrator error: success = false, capture error message
- Missing agents: list which agents didn't spawn
- Timing failure: log actual vs expected duration
  </action>
  <verify>
```bash
# Check module exports correct interface
node -e "
const validator = require('./bin/lib/orchestration/parallel-spawn-validator');
console.assert(typeof validator.validateParallelSpawning === 'function', 'Should export validateParallelSpawning');
console.log('✓ Parallel spawn validator module loaded');
"

# Manual test will be added in task 3 (unit tests)
```
  </verify>
  <done>
Parallel spawn validator module exists, provides function to measure and verify concurrent agent execution.
  </done>
</task>

<task name="write-unit-tests" type="auto">
  <files>
    bin/lib/orchestration/structured-return-parser.test.js
    bin/lib/orchestration/parallel-spawn-validator.test.js
  </files>
  <action>
Create unit tests for both modules using Node.js assert.

**structured-return-parser.test.js:**
Test cases:
1. Valid RESEARCH COMPLETE block
2. Valid PLAN COMPLETE block
3. Valid EXECUTION COMPLETE block
4. Malformed markdown (no header)
5. Multiple headers (uses first)
6. Empty content after header
7. Header at end of string

**parallel-spawn-validator.test.js:**
Test cases:
1. Module loads and exports function
2. Function signature validation
3. Mock parallelism calculation logic
4. Error handling for missing agents

**Test structure:**
```javascript
const assert = require('assert');
const module = require('./module-name');

async function runTests() {
  console.log('Testing module-name...');
  
  // Test 1
  const result1 = module.function(input);
  assert.strictEqual(result1.expected, value, 'Description');
  
  // Test 2...
  
  console.log('✓ All tests passed');
}

runTests().catch(err => {
  console.error('Test failed:', err);
  process.exit(1);
});
```

**Run tests:**
```bash
node bin/lib/orchestration/structured-return-parser.test.js
node bin/lib/orchestration/parallel-spawn-validator.test.js
```

**Reference:** Phase 5.1 verification patterns, STATE.md mentions 208 passing tests
  </action>
  <verify>
```bash
# Run both test suites
echo "Running structured-return-parser tests..."
node bin/lib/orchestration/structured-return-parser.test.js

echo ""
echo "Running parallel-spawn-validator tests..."
node bin/lib/orchestration/parallel-spawn-validator.test.js

echo ""
echo "✓ All unit tests passed"
```
  </verify>
  <done>
Unit tests exist and pass, covering happy path and error cases for both modules.
  </done>
</task>

## Verification

After all tasks complete, verify:

```bash
# 1. Check all files created
ls -l bin/lib/orchestration/structured-return-parser.js \
      bin/lib/orchestration/parallel-spawn-validator.js \
      bin/lib/orchestration/structured-return-parser.test.js \
      bin/lib/orchestration/parallel-spawn-validator.test.js

# 2. Run tests
node bin/lib/orchestration/structured-return-parser.test.js
node bin/lib/orchestration/parallel-spawn-validator.test.js

# 3. Test against actual command output (manual)
# Example: Run gsd-new-project and capture output, verify parser extracts status
```

## Success Criteria

- [ ] Parser extracts status from ## RESEARCH COMPLETE, ## PLAN COMPLETE, ## EXECUTION COMPLETE
- [ ] Parser returns 'unknown' status for malformed markdown
- [ ] Parallel spawn validator provides timing-based parallelism verification
- [ ] Unit tests pass for both modules
- [ ] Modules follow existing bin/lib/orchestration/ patterns

## Output

Two new validation modules in `bin/lib/orchestration/`:
1. **structured-return-parser.js** - Parse agent markdown returns
2. **parallel-spawn-validator.js** - Verify concurrent spawning

Foundation ready for Plan 2 (sequential spawning) and Plan 3 (integration suite).
