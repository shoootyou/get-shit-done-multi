---
phase: 02-adapter-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/adapters/claude.js
  - bin/lib/adapters/copilot.js
  - bin/lib/adapters/codex.js
  - bin/lib/adapters/shared/path-rewriter.js
  - bin/lib/adapters/shared/format-converter.js
autonomous: true

must_haves:
  truths:
    - "Each CLI has a dedicated adapter module with consistent interface"
    - "Path replacement works for all path reference variations"
    - "Agent-to-skill format conversion preserves content and structure"
    - "Adapters use Phase 1 path utilities for consistency"
  artifacts:
    - path: "bin/lib/adapters/claude.js"
      provides: "Claude adapter with getTargetDirs, convertContent, verify"
      exports: ["claudeAdapter"]
      min_lines: 60
    - path: "bin/lib/adapters/copilot.js"
      provides: "Copilot adapter with getTargetDirs, convertContent, verify"
      exports: ["copilotAdapter"]
      min_lines: 80
    - path: "bin/lib/adapters/codex.js"
      provides: "Codex adapter with getTargetDirs, convertContent, verify"
      exports: ["codexAdapter"]
      min_lines: 100
    - path: "bin/lib/adapters/shared/path-rewriter.js"
      provides: "Path replacement utility"
      exports: ["replaceClaudePaths"]
      min_lines: 40
    - path: "bin/lib/adapters/shared/format-converter.js"
      provides: "Agent-to-skill conversion"
      exports: ["agentToSkill"]
      min_lines: 50
  key_links:
    - from: "bin/lib/adapters/claude.js"
      to: "bin/lib/paths.js"
      via: "getConfigPaths import"
      pattern: "require\\(['\"]\\.\\.\\/paths['\"]\\)"
    - from: "bin/lib/adapters/copilot.js"
      to: "bin/lib/adapters/shared/path-rewriter.js"
      via: "replaceClaudePaths import"
      pattern: "require\\(['\"]\\.\\.\\/adapters\\/shared\\/path-rewriter['\"]\\)"
    - from: "bin/lib/adapters/codex.js"
      to: "bin/lib/adapters/shared/format-converter.js"
      via: "agentToSkill import"
      pattern: "require\\(['\"]\\.\\.\\/adapters\\/shared\\/format-converter['\"]\\)"
---

<objective>
Create adapter layer architecture that enables GSD to deploy to all three target CLIs (Claude, Copilot, Codex) with correct format and directory structure for each platform.

Purpose: Establish the foundational adapter architecture that will power multi-CLI deployment, replacing ad-hoc path replacement with structured, testable adapter modules.

Output: Three CLI-specific adapters (claude.js, copilot.js, codex.js) and two shared utilities (path-rewriter.js, format-converter.js) that handle all platform-specific transformations.
</objective>

<execution_context>
@.github/skills/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-adapter-implementation/02-RESEARCH.md

# Phase 1 infrastructure
@bin/lib/paths.js
@bin/lib/detect.js
@bin/lib/upgrade.js

# Existing install logic to understand current pattern
@bin/install.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared path rewriting utility</name>
  <files>bin/lib/adapters/shared/path-rewriter.js</files>
  <action>
Extract path replacement logic from bin/install.js (lines 150-177) into dedicated module at bin/lib/adapters/shared/path-rewriter.js.

Create replaceClaudePaths(content, targetPrefix, options) function that:
- Replaces ~/.claude/get-shit-done/ → targetPrefix
- Replaces ./.claude/get-shit-done/ → targetPrefix  
- Replaces .claude/get-shit-done/ → targetPrefix
- Handles both with and without trailing slashes
- Replaces ~/.claude/commands/gsd/ → targetPrefix/commands/gsd/
- Replaces ~/.claude/agents/ → .github/agents/ when options.isLocal = true
- Uses progressive replacement stages (directory refs first, then commands, then agents)
- Returns updated content string

Use research Pattern 2 (Progressive Path Replacement) from 02-RESEARCH.md.

Add JSDoc with clear param and return documentation. Export { replaceClaudePaths }.

Why path-rewriter.js and not keep inline: Adapter modules for Copilot and Codex need to reuse this logic. Centralizing prevents duplication and enables easier testing.
  </action>
  <verify>node -e "const {replaceClaudePaths} = require('./bin/lib/adapters/shared/path-rewriter'); const result = replaceClaudePaths('~/.claude/get-shit-done/workflows/test.md', '.github/skills/get-shit-done/', {isLocal: true}); console.log(result.includes('.github/skills/get-shit-done/') ? 'PASS' : 'FAIL')"</verify>
  <done>replaceClaudePaths() correctly transforms all path variations from Claude format to target CLI format</done>
</task>

<task type="auto">
  <name>Task 2: Create shared format converter utility</name>
  <files>bin/lib/adapters/shared/format-converter.js</files>
  <action>
Create bin/lib/adapters/shared/format-converter.js with agentToSkill(agentContent, agentName) function.

Function should:
- Parse YAML frontmatter using regex: /^---\n([\s\S]+?)\n---/
- Extract name and description fields from frontmatter
- Remove GitHub Copilot-specific 'target' field if present
- Keep all other frontmatter fields (Agent Skills spec is 90% compatible)
- Preserve body content after frontmatter
- Return formatted SKILL.md content with structure:
  ```
  ---
  {codex-friendly frontmatter}
  ---
  
  # {name}
  
  {description}
  
  {body}
  ```

Use research Pattern 3 (Agent-to-Skill Conversion) from 02-RESEARCH.md (lines 140-180).

Add JSDoc documenting the minimal conversion (90% compatible, only removes 'target' field). Export { agentToSkill }.

Why minimal conversion: Research confirms Agent Skills spec is 90% compatible across CLIs. Heavy conversion would introduce fragility.
  </action>
  <verify>node -e "const {agentToSkill} = require('./bin/lib/adapters/shared/format-converter'); const agent = '---\nname: test\ntarget: copilot\n---\nbody'; const skill = agentToSkill(agent, 'test'); console.log(skill.includes('target') ? 'FAIL: target not removed' : 'PASS')"</verify>
  <done>agentToSkill() converts .agent.md to SKILL.md format by removing GitHub Copilot-specific fields while preserving all content</done>
</task>

<task type="auto">
  <name>Task 3: Create three CLI adapter modules</name>
  <files>bin/lib/adapters/claude.js, bin/lib/adapters/copilot.js, bin/lib/adapters/codex.js</files>
  <action>
Create three adapter modules following research Pattern 1 (Adapter Interface) from 02-RESEARCH.md (lines 56-138).

Each adapter exports object with three methods:

**1. getTargetDirs(isGlobal)** - Returns {skills, agents, commands}
- Use getConfigPaths() from bin/lib/paths.js to get base path
- Join paths using path.join() (never string concatenation)
- Claude: skills = {base}/get-shit-done, agents = {base}/agents, commands = {base}/commands/gsd
- Copilot: skills = {base}/skills/get-shit-done, agents = {base}/agents, commands = null (commands in skills/)
- Codex: skills = {base}/skills/get-shit-done, agents = {base}/skills/get-shit-done/agents, commands = os.homedir()/.codex/prompts/gsd (only for global, null for local per research Pitfall 3)

**2. convertContent(content, type)** - Returns converted content string
- Import replaceClaudePaths from shared/path-rewriter.js
- Claude: No conversion needed, return content as-is
- Copilot: Call replaceClaudePaths(content, '.github/skills/get-shit-done/', true) to replace paths
- Codex: Call replaceClaudePaths(content, '.codex/skills/get-shit-done/', true), then if type === 'agent', apply agentToSkill() from shared/format-converter.js

**3. verify(dirs)** - Returns {success: boolean, errors: string[]}
- Check all paths in dirs exist using fs.existsSync()
- Check required files exist:
  - Claude: {dirs.skills}/SKILL.md, at least 1 .agent.md in {dirs.agents}
  - Copilot: {dirs.skills}/SKILL.md, at least 1 .agent.md in {dirs.agents}
  - Codex: {dirs.skills}/SKILL.md, check dirs.agents has subfolder structure (each agent gets folder)
- Return {success: true, errors: []} if all checks pass
- Return {success: false, errors: ['Missing X', 'Missing Y']} if checks fail

Add JSDoc to each method. Use require('fs'), require('path'), require('os') built-ins only.

Import getConfigPaths from '../paths' in all three adapters for base path resolution.

Why three separate files not one with switch: Each CLI has unique behavior (Codex converts agents to skills, Copilot uses flat agent structure, Claude is source format). Separate files enable easier testing and maintenance per research Common Pitfalls.
  </action>
  <verify>
node -e "const c = require('./bin/lib/adapters/claude'); console.log(c.getTargetDirs ? 'claude OK' : 'FAIL')"
node -e "const c = require('./bin/lib/adapters/copilot'); console.log(c.getTargetDirs ? 'copilot OK' : 'FAIL')"
node -e "const c = require('./bin/lib/adapters/codex'); console.log(c.getTargetDirs ? 'codex OK' : 'FAIL')"
  </verify>
  <done>Three adapter modules export consistent interface (getTargetDirs, convertContent, verify) with CLI-specific behavior for directory structure, path conversion, and format conversion</done>
</task>

</tasks>

<verification>
Run adapter smoke tests:
```bash
# Test path rewriter
node -e "const {replaceClaudePaths} = require('./bin/lib/adapters/shared/path-rewriter'); \
const test = '~/.claude/get-shit-done/test.md and ~/.claude/agents/x.md'; \
const result = replaceClaudePaths(test, '.codex/skills/get-shit-done/', {isLocal: true}); \
console.log(result.includes('.codex') && result.includes('.github/agents') ? 'PASS' : 'FAIL: ' + result)"

# Test format converter
node -e "const {agentToSkill} = require('./bin/lib/adapters/shared/format-converter'); \
const agent = '---\nname: TestAgent\ntarget: copilot\ndescription: Test\n---\nBody content'; \
const skill = agentToSkill(agent, 'TestAgent'); \
console.log(!skill.includes('target:') && skill.includes('# TestAgent') ? 'PASS' : 'FAIL')"

# Test all three adapters load and export correct interface
node -e "['claude', 'copilot', 'codex'].forEach(cli => { \
const adapter = require(\`./bin/lib/adapters/\${cli}\`); \
const hasInterface = adapter.getTargetDirs && adapter.convertContent && adapter.verify; \
console.log(\`\${cli}: \${hasInterface ? 'PASS' : 'FAIL'}\`); \
})"
```

Expected output:
- Path rewriter: PASS
- Format converter: PASS  
- claude: PASS
- copilot: PASS
- codex: PASS
</verification>

<success_criteria>
1. Path rewriter correctly replaces all path variations (~/.claude/, ./.claude/, .claude/) to target prefix
2. Format converter transforms .agent.md to SKILL.md format, removing 'target' field
3. All three adapters export getTargetDirs(), convertContent(), verify() methods
4. Claude adapter returns source format paths (no conversion)
5. Copilot adapter uses .github/ paths and flat agent structure
6. Codex adapter uses .codex/ paths and converts agents to skill format
7. All adapters use Phase 1 path utilities (getConfigPaths) for consistency
8. Verification methods check content existence, not just directories
</success_criteria>

<output>
After completion, create `.planning/phases/02-adapter-implementation/02-01-SUMMARY.md`

Document:
- Adapter architecture established (3 adapters + 2 shared utilities)
- Interface contract (getTargetDirs, convertContent, verify)
- CLI-specific differences handled (directory structure, format conversion)
- Path rewriting centralized for consistency
- Ready for integration into install.js in Plan 02-02
</output>
