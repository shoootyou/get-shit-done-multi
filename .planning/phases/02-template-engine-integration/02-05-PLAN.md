---
phase: 02-template-engine-integration
plan: 05
type: execute
wave: 4
depends_on: [02-01, 02-02, 02-03]
files_modified:
  - bin/install.js
  - test-output/claude/skills/gsd-help/SKILL.md
  - test-output/copilot/skills/gsd-help/SKILL.md
  - test-output/codex/skills/gsd-help/SKILL.md
autonomous: true
gap_closure: true
must_haves:
  goal: "Fix skill output structure to use folder/SKILL.md pattern and verify with safe testing"
  truths:
    - Generated skills use {name}/SKILL.md structure not flat {name}.md files
    - All testing happens in test-output/ directories only
    - Protected directories (.claude/, .codex/, .github/copilot/) untouched during testing
    - All 3 platforms generate correct folder structure
    - Test verification uses scripts/generate-skill-outputs.js as reference
  artifacts:
    - bin/install.js with generateSkillsFromSpecs() creating folder/SKILL.md
    - test-output/claude/skills/gsd-help/SKILL.md exists (not gsd-help.md)
    - test-output/copilot/skills/gsd-help/SKILL.md exists
    - test-output/codex/skills/gsd-help/SKILL.md exists
  wiring:
    - generateSkillsFromSpecs() creates skill directory before writing SKILL.md
    - Test script uses test-output/{platform}/skills/ as output directory
  key_links:
    - "generateSkillsFromSpecs() output path: outputDir + skillDir + 'SKILL.md'"
    - "Test verification: test-output/{platform}/skills/{skill}/SKILL.md structure"
---

# Phase 2 Plan 05: Fix Skill Output Structure (Gap Closure)

**Objective:** Fix generateSkillsFromSpecs() to create correct folder/SKILL.md structure and verify using safe test-output approach

## Context

**Issues discovered during Phase 2 Wave 3 execution:**

1. **Issue 1: Wrong output structure**
   - Current: Generates flat files `gsd-help.md`
   - Required: Folder structure `gsd-help/SKILL.md`
   - Reference: https://code.claude.com/docs/en/slash-commands#automatic-discovery-from-nested-directories

2. **Issue 2: Testing in protected directories**
   - Current: Tests modify `.claude/`, `.codex/`, `.github/copilot/`
   - Required: All testing in `test-output/{platform}/skills/` only

**Root cause:** Plan 02-01 implementation at line 338-339 in bin/install.js uses:
```javascript
const outputName = `${skillDir}.md`;
const outputPath = path.join(outputDir, outputName);
```

Should be:
```javascript
const skillOutputDir = path.join(outputDir, skillDir);
const outputPath = path.join(skillOutputDir, 'SKILL.md');
```

**Working reference:** `scripts/generate-skill-outputs.js` demonstrates correct test-output approach (lines 186-191)

## Tasks

<task name="fix-generateSkillsFromSpecs" type="auto">
  <files>bin/install.js</files>
  <action>
    Fix generateSkillsFromSpecs() function (lines 308-369) to create folder/SKILL.md structure:

    1. **Change output path logic (lines 337-340):**
       
       OLD:
       ```javascript
       // Output name: gsd-help.md (folder name + .md)
       const outputName = `${skillDir}.md`;
       const outputPath = path.join(outputDir, outputName);
       fs.writeFileSync(outputPath, result.output, 'utf8');
       ```

       NEW:
       ```javascript
       // Output structure: gsd-help/SKILL.md (folder per skill)
       const skillOutputDir = path.join(outputDir, skillDir);
       fs.mkdirSync(skillOutputDir, { recursive: true });
       const outputPath = path.join(skillOutputDir, 'SKILL.md');
       fs.writeFileSync(outputPath, result.output, 'utf8');
       ```

    2. **Keep all other code unchanged:**
       - Platform integration (lines 647, 886, 1092)
       - Codex support (added in commit 20fa968)
       - Frontmatter inheritance system
       - generateAgent() template processing

    Verify change matches Claude documentation pattern:
    - Correct: `.claude/skills/gsd-help/SKILL.md`
    - Wrong: `.claude/skills/gsd-help.md`
  </action>
  <verify>
    ```bash
    # Verify function change
    grep -A5 "Output structure:" bin/install.js | head -10
    ```

    Expected: See "skillOutputDir", "mkdirSync", "SKILL.md" in output path logic
  </verify>
  <done>generateSkillsFromSpecs() creates folder/SKILL.md structure</done>
</task>

<task name="test-with-safe-output" type="auto">
  <files>test-output/*/skills/gsd-help/SKILL.md</files>
  <action>
    Test skill generation using test-output/ approach (NEVER touch protected directories):

    1. **Use existing test script as verification:**
       ```bash
       # Generate using reference script (already correct)
       node scripts/generate-skill-outputs.js gsd-help
       ```

    2. **Create temporary test for install.js:**
       ```bash
       # Create temp directory for install test
       mkdir -p test-output/install-test/claude/skills
       mkdir -p test-output/install-test/copilot/skills
       mkdir -p test-output/install-test/codex/skills
       
       # Test generateSkillsFromSpecs directly (requires small wrapper script)
       # OR: Manually verify structure after running with mocked paths
       ```

    3. **Verify all 3 platforms generate correct structure:**
       ```bash
       # Check folder structure exists
       ls -la test-output/claude/skills/gsd-help/SKILL.md
       ls -la test-output/copilot/skills/gsd-help/SKILL.md
       ls -la test-output/codex/skills/gsd-help/SKILL.md
       
       # Verify NOT flat files
       ! test -f test-output/claude/skills/gsd-help.md
       ! test -f test-output/copilot/skills/gsd-help.md
       ! test -f test-output/codex/skills/gsd-help.md
       ```

    4. **Confirm protected directories untouched:**
       ```bash
       # Verify no test artifacts in production paths
       git status .claude/ .codex/ .github/copilot/
       ```

    Expected: No uncommitted changes in protected directories
  </action>
  <verify>
    ```bash
    # Verify folder structure (not flat files)
    find test-output -name "SKILL.md" -type f | grep gsd-help
    
    # Should show:
    # test-output/claude/skills/gsd-help/SKILL.md
    # test-output/copilot/skills/gsd-help/SKILL.md
    # test-output/codex/skills/gsd-help/SKILL.md
    
    # Verify NO flat files
    find test-output -name "gsd-help.md" -type f
    # Should show nothing
    ```
  </verify>
  <done>All 3 platforms generate gsd-help/SKILL.md structure in test-output/</done>
</task>

<task name="verify-gap-closure" type="auto">
  <files>test-output/*/skills/gsd-help/SKILL.md</files>
  <action>
    Confirm both gaps closed:

    1. **Gap 1 closed - Correct folder structure:**
       ```bash
       # Verify folder/SKILL.md pattern exists
       for platform in claude copilot codex; do
         if [ -f "test-output/${platform}/skills/gsd-help/SKILL.md" ]; then
           echo "✓ ${platform}: Correct structure"
         else
           echo "✗ ${platform}: Missing folder structure"
           exit 1
         fi
       done
       ```

    2. **Gap 2 closed - Safe testing:**
       ```bash
       # Verify protected directories clean
       if git diff --quiet .claude/ .codex/ .github/copilot/ 2>/dev/null; then
         echo "✓ Protected directories untouched"
       else
         echo "✗ Protected directories modified"
         git status .claude/ .codex/ .github/copilot/
         exit 1
       fi
       ```

    3. **Compare with reference implementation:**
       ```bash
       # Verify test-output matches scripts/generate-skill-outputs.js behavior
       diff test-output/claude/skills/gsd-help/SKILL.md \
            <(node -e "
              const gen = require('./scripts/generate-skill-outputs.js');
              const output = gen.generateOutput('specs/skills/gsd-help/SKILL.md', 
                { name: 'claude', flag: 'isClaude', toolMap: {} });
              console.log(output);
            ")
       ```

    Expected: Output structure matches reference implementation
  </action>
  <verify>
    ```bash
    # Final structure verification
    tree test-output/claude/skills/gsd-help/
    tree test-output/copilot/skills/gsd-help/
    tree test-output/codex/skills/gsd-help/
    
    # Should show:
    # gsd-help/
    # └── SKILL.md
    ```
  </verify>
  <done>Both gaps closed: folder structure correct, testing safe</done>
</task>

## Success Criteria

**Gap 1 - Correct Output Structure:**
- [ ] generateSkillsFromSpecs() creates `{name}/SKILL.md` not `{name}.md`
- [ ] test-output/claude/skills/gsd-help/SKILL.md exists
- [ ] test-output/copilot/skills/gsd-help/SKILL.md exists
- [ ] test-output/codex/skills/gsd-help/SKILL.md exists
- [ ] No flat files (gsd-help.md) exist in test-output

**Gap 2 - Safe Testing:**
- [ ] All testing in test-output/ directories only
- [ ] Protected directories (.claude/, .codex/, .github/copilot/) have no uncommitted changes
- [ ] Testing approach matches scripts/generate-skill-outputs.js pattern

**Integration:**
- [ ] Fix does not break existing functionality (platform integration, Codex support)
- [ ] Generated content still correct (frontmatter, conditionals, metadata)
- [ ] Ready for Phase 2 completion (Wave 3 checkpoint can now pass)

## Output

**Files Modified:**
- `bin/install.js` — generateSkillsFromSpecs() fixed to create folder/SKILL.md

**Test Artifacts:**
- `test-output/claude/skills/gsd-help/SKILL.md` — Correct folder structure
- `test-output/copilot/skills/gsd-help/SKILL.md` — Correct folder structure  
- `test-output/codex/skills/gsd-help/SKILL.md` — Correct folder structure

**Verification:**
- No test artifacts in protected directories
- Structure matches Claude documentation spec
- Phase 2 gaps closed, ready for Wave 3 verification
