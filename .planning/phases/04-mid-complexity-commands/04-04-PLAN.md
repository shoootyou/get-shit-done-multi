---
phase: 04-mid-complexity-commands
plan: 04
type: execute
wave: 3
depends_on: [04-01, 04-02, 04-03]
files_modified:
  - specs/skills/gsd-plan-phase/SKILL.md
  - .claude/skills/gsd-plan-phase.md (generated)
autonomous: true
must_haves:
  goal: "Migrate plan-phase orchestrator preserving verification loop, flag matrix, and 11 @-references"
  truths:
    - File specs/skills/gsd-plan-phase/SKILL.md exists with complete spec
    - 3-iteration verification loop preserved (planner → checker → revision, max 3 times)
    - All 4 flags handled correctly (--research, --skip-research, --gaps, --skip-verify)
    - All 11 @-references preserved exactly (ui-brand.md, STATE.md, ROADMAP.md, REQUIREMENTS.md, CONTEXT.md, RESEARCH.md, VERIFICATION.md, UAT.md, etc.)
    - Sequential spawning pattern documented (NOT parallel like Phase 3)
    - 3 agent types spawned correctly (gsd-phase-researcher, gsd-planner, gsd-plan-checker)
    - Phase normalization handles integers, decimals, padding edge cases
    - Gap closure mode (--gaps) reads VERIFICATION.md/UAT.md instead of RESEARCH.md
    - Generated command installs to .claude/skills/ successfully
  artifacts:
    - specs/skills/gsd-plan-phase/SKILL.md
    - .claude/skills/gsd-plan-phase.md (generated output)
  wiring:
    - Frontmatter includes Task, Read, Write, Bash, AskUserQuestion tools
    - Body contains unmodified orchestration logic from legacy (475 lines)
    - Sequential spawning with iteration counter and max safeguard
  key_links:
    - SKILL.md → install.js::generateSkillsFromSpecs → .claude/skills/gsd-plan-phase.md
---

# Phase 4 Plan 04: Migrate plan-phase Orchestrator

**Objective:** Migrate gsd-plan-phase to spec format, preserving verification loop, flag matrix, and all @-references—most complex Phase 4 command

## Context

The plan-phase orchestrator (475 lines, 11 @-references, 4 spawns, 4 flags) is Tier 3 complexity—the anchor command of Phase 4 and most complex mid-tier orchestrator. It orchestrates the core planning workflow: research → plan → verify → iterate (max 3 times). Referenced by 13 other commands, so breaking it cascades failures.

**From Research (04-RESEARCH.md):**
- Pattern: 3-iteration verification loop with max safeguard
- Spawns: 4 total (gsd-phase-researcher, gsd-planner, gsd-plan-checker, gsd-planner revision)
- Flags: 4 (--research, --skip-research, --gaps, --skip-verify) with 16 combinations
- @-references: 11 (most in Phase 4)
- Conditionals: 31 (most complex branching logic)
- Incoming refs: 13 commands depend on plan-phase

**From Waves 1-2 learnings:**
- Checkpoint continuation validated (04-01 research-phase)
- Parallel spawn conversion validated (04-02 map-codebase)
- Session persistence validated (04-03 debug)
- Template system preserves @-references and spawns

**Why Wave 3:**
- Most complex Phase 4 command (475 lines, 4 flags, verification loop)
- Depends on all Wave 1-2 pattern validations
- Referenced by 13 commands—must migrate correctly to avoid cascade failures
- Must complete before Phase 5 (simpler commands) and Phase 6 (orchestration validation)

**Risk mitigation:**
- Preserve iteration counter EXACTLY (prevents runaway costs)
- Test all 4 flags individually (16 combinations is excessive, test common paths)
- Verify all 11 @-references preserved (count before/after)
- Don't simplify verification loop logic (it handles real edge cases)

## Tasks

<task name="create-plan-phase-spec-structure" type="auto">
  <files>specs/skills/gsd-plan-phase/SKILL.md</files>
  <action>
Create folder-per-skill structure and SKILL.md frontmatter for gsd-plan-phase.

```bash
# Create folder
mkdir -p specs/skills/gsd-plan-phase

# Create SKILL.md with frontmatter
cat > specs/skills/gsd-plan-phase/SKILL.md << 'EOF'
---
name: gsd-plan-phase
description: Orchestrate phase planning with research, planning, and verification loop
skill_version: 1.9.1
requires_version: 1.9.0+
platforms:
  - claude
  - copilot
  - codex
tools:
  - name: task
    required: true
    reason: Spawn gsd-phase-researcher, gsd-planner, gsd-plan-checker agents sequentially
  - name: read
    required: true
    reason: Load project state, roadmap, requirements, research, verification artifacts
  - name: write
    required: true
    reason: Update ROADMAP.md with plan details, create marker files
  - name: bash
    required: true
    reason: Phase normalization, argument parsing, file validation, git operations
  - name: ask_user_question
    required: true
    reason: User intervention at max iterations, confirmation of breakdown
arguments:
  - name: phase
    type: string
    required: true
    description: Phase number or name to plan
  - name: --research
    type: flag
    required: false
    description: Force re-research (ignore existing RESEARCH.md)
  - name: --skip-research
    type: flag
    required: false
    description: Skip research entirely (go straight to planning)
  - name: --gaps
    type: flag
    required: false
    description: Gap closure mode (plan from VERIFICATION.md/UAT.md failures)
  - name: --skip-verify
    type: flag
    required: false
    description: Skip verification loop (trust planner output)
metadata:
  generated: {{generated}}
  platform: {{platform}}
  version: {{version}}
---
EOF

echo "✓ Created specs/skills/gsd-plan-phase/SKILL.md with frontmatter"
```
  </action>
  <verify>
```bash
# Verify folder and file exist
[ -d "specs/skills/gsd-plan-phase" ] && echo "✓ Folder exists"
[ -f "specs/skills/gsd-plan-phase/SKILL.md" ] && echo "✓ SKILL.md exists"

# Verify frontmatter is valid YAML
node -e "
const fs = require('fs');
const yaml = require('js-yaml');
const content = fs.readFileSync('specs/skills/gsd-plan-phase/SKILL.md', 'utf8');
const frontmatter = content.match(/^---\n([\s\S]+?)\n---/);
if (frontmatter) {
  const parsed = yaml.load(frontmatter[1]);
  console.log('✓ Frontmatter valid:', parsed.name);
  console.log('✓ Tools declared:', parsed.tools.length);
  console.log('✓ Arguments declared:', parsed.arguments.length);
  
  // Verify all 4 flags present
  const flags = parsed.arguments.filter(a => a.type === 'flag');
  console.log('✓ Flags declared:', flags.length, '-', flags.map(f => f.name).join(', '));
  
  if (flags.length !== 4) {
    throw new Error('Expected 4 flags, found ' + flags.length);
  }
} else {
  throw new Error('No frontmatter found');
}
"
```
  </verify>
  <done>Folder specs/skills/gsd-plan-phase/ exists with valid SKILL.md frontmatter including all 4 flags</done>
</task>

<task name="migrate-plan-phase-body" type="auto">
  <files>specs/skills/gsd-plan-phase/SKILL.md</files>
  <action>
Migrate complete body content from legacy commands/gsd/plan-phase.md to spec body.

**CRITICAL preservation (highest-risk items):**
1. **3-iteration verification loop** (lines 295-419): iteration_count, max 3, user intervention after max
2. **All 4 flags** (--research, --skip-research, --gaps, --skip-verify): parse and handle correctly
3. **All 11 @-references**: ui-brand.md, STATE.md, ROADMAP.md, REQUIREMENTS.md, CONTEXT.md, RESEARCH.md, VERIFICATION.md, UAT.md, etc.
4. **Phase normalization** (lines 66-74): handles integers, decimals, padding
5. **Gap closure mode** (--gaps flag): reads VERIFICATION.md/UAT.md instead of RESEARCH.md
6. **Sequential spawning**: researcher → planner → checker → planner (revision), NOT parallel

**Migration steps:**

```bash
# Extract body content from legacy (everything after frontmatter)
sed -n '/^---$/,/^---$/!p' commands/gsd/plan-phase.md | tail -n +2 > /tmp/plan-phase-body.md

# Append to SKILL.md (after frontmatter)
cat /tmp/plan-phase-body.md >> specs/skills/gsd-plan-phase/SKILL.md

echo "✓ Migrated body content from legacy command"
echo ""
echo "Body size: $(wc -l < /tmp/plan-phase-body.md) lines"
```

**Verify CRITICAL patterns preserved:**

```bash
echo ""
echo "=== CRITICAL Pattern Verification ==="

# 1. Iteration counter and max 3 safeguard
if grep -q "iteration_count" specs/skills/gsd-plan-phase/SKILL.md && \
   grep -q "max.*3" specs/skills/gsd-plan-phase/SKILL.md; then
  echo "✓ Iteration counter and max 3 safeguard present"
else
  echo "✗ CRITICAL: Iteration logic missing or incomplete"
  exit 1
fi

# 2. All 4 flags handled
echo "Flag handling:"
for flag in "--research" "--skip-research" "--gaps" "--skip-verify"; do
  if grep -q "$flag" specs/skills/gsd-plan-phase/SKILL.md; then
    echo "  ✓ $flag"
  else
    echo "  ✗ $flag MISSING"
    exit 1
  fi
done

# 3. @-reference count (should be 11+)
ref_count=$(grep -c "@" specs/skills/gsd-plan-phase/SKILL.md || echo 0)
if [ "$ref_count" -ge 11 ]; then
  echo "✓ @-references preserved: $ref_count (expected 11+)"
else
  echo "✗ CRITICAL: Only $ref_count @-references found (expected 11+)"
  exit 1
fi

# 4. Phase normalization logic
if grep -q "printf.*%02d" specs/skills/gsd-plan-phase/SKILL.md; then
  echo "✓ Phase normalization logic preserved"
else
  echo "✗ CRITICAL: Phase normalization missing"
  exit 1
fi

# 5. Gap closure mode (reads VERIFICATION.md/UAT.md)
if grep -q "VERIFICATION\.md" specs/skills/gsd-plan-phase/SKILL.md && \
   grep -q "UAT\.md" specs/skills/gsd-plan-phase/SKILL.md; then
  echo "✓ Gap closure mode artifacts referenced"
else
  echo "⚠ Gap closure mode may be incomplete"
fi

# 6. Task() spawn calls (should be 4: researcher, planner, checker, planner-revision)
task_count=$(grep -c "Task(" specs/skills/gsd-plan-phase/SKILL.md || echo 0)
if [ "$task_count" -ge 3 ]; then
  echo "✓ Task spawn calls preserved: $task_count (expected 3-4)"
else
  echo "✗ CRITICAL: Only $task_count Task() calls (expected 3-4)"
  exit 1
fi

# 7. All 3 agent types
echo "Agent types:"
for agent in "gsd-phase-researcher" "gsd-planner" "gsd-plan-checker"; do
  if grep -q "$agent" specs/skills/gsd-plan-phase/SKILL.md; then
    echo "  ✓ $agent"
  else
    echo "  ✗ $agent MISSING"
    exit 1
  fi
done

# 8. Verification loop pattern (VERIFICATION PASSED, ISSUES FOUND)
if grep -q "VERIFICATION PASSED" specs/skills/gsd-plan-phase/SKILL.md && \
   grep -q "ISSUES FOUND" specs/skills/gsd-plan-phase/SKILL.md; then
  echo "✓ Verification loop return patterns present"
else
  echo "⚠ Verification loop may be incomplete"
fi
```
  </action>
  <verify>
```bash
# Verify file structure
echo ""
echo "=== File Statistics ==="
wc -l specs/skills/gsd-plan-phase/SKILL.md
echo ""

# Critical sections check
echo "=== Critical Sections Check ==="
grep -c "<objective>" specs/skills/gsd-plan-phase/SKILL.md | xargs -I {} echo "✓ <objective> sections: {}"
grep -c "<process>" specs/skills/gsd-plan-phase/SKILL.md | xargs -I {} echo "✓ <process> sections: {}"
grep -c "## [0-9]" specs/skills/gsd-plan-phase/SKILL.md | xargs -I {} echo "✓ Process steps: {}"
grep -c "Task(" specs/skills/gsd-plan-phase/SKILL.md | xargs -I {} echo "✓ Task() calls: {}"
grep -c "@" specs/skills/gsd-plan-phase/SKILL.md | xargs -I {} echo "✓ @-references: {}"

# Flag handling check
echo ""
echo "=== Flag Handling Check ==="
for flag in "--research" "--skip-research" "--gaps" "--skip-verify"; do
  count=$(grep -c "$flag" specs/skills/gsd-plan-phase/SKILL.md || echo 0)
  echo "$flag: $count references"
done

# Verification loop check
echo ""
echo "=== Verification Loop Check ==="
if grep -q "iteration_count" specs/skills/gsd-plan-phase/SKILL.md; then
  echo "✓ Iteration counter present"
fi
if grep -q "< 3" specs/skills/gsd-plan-phase/SKILL.md || grep -q "<= 3" specs/skills/gsd-plan-phase/SKILL.md; then
  echo "✓ Max iteration check present"
fi
if grep -q "AskUserQuestion" specs/skills/gsd-plan-phase/SKILL.md; then
  echo "✓ User intervention logic present"
fi

# Compare line count with legacy
legacy_lines=$(wc -l < commands/gsd/plan-phase.md)
spec_lines=$(wc -l < specs/skills/gsd-plan-phase/SKILL.md)
echo ""
echo "Legacy: $legacy_lines lines"
echo "Spec: $spec_lines lines"
echo "Difference: $((spec_lines - legacy_lines)) lines (should be ~30-50 for expanded frontmatter)"

if [ $spec_lines -lt 450 ]; then
  echo "⚠ WARNING: Spec seems too short (expected ~500-520 lines)"
fi
```
  </verify>
  <done>Body content migrated with verification loop, all flags, all @-references, and phase normalization preserved</done>
</task>

<task name="generate-and-verify-plan-phase" type="auto">
  <files>bin/install.js</files>
  <action>
Generate plan-phase skill using template system and perform comprehensive validation.

```bash
# Run skill generation
echo "Generating gsd-plan-phase skill..."
node bin/install.js --skills-only --platform claude 2>&1 | tee /tmp/plan-phase-gen.log

# Check for errors
if grep -i "error" /tmp/plan-phase-gen.log; then
  echo "✗ Generation errors found"
  exit 1
else
  echo "✓ Generation completed without errors"
fi

# Verify generated file exists
if [ -f ".claude/skills/gsd-plan-phase.md" ]; then
  echo "✓ Generated file exists: .claude/skills/gsd-plan-phase.md"
  wc -l .claude/skills/gsd-plan-phase.md
else
  echo "✗ Generated file not found"
  exit 1
fi
```

**Comprehensive validation:**

```bash
echo ""
echo "=== CRITICAL Validation (Must Pass) ==="

# 1. Iteration counter preserved
if grep -q "iteration_count" .claude/skills/gsd-plan-phase.md && \
   grep -q "max.*3\|< 3\|<= 3" .claude/skills/gsd-plan-phase.md; then
  echo "✓ PASS: Iteration counter and max 3 safeguard in generated output"
else
  echo "✗ FAIL: Iteration logic missing"
  exit 1
fi

# 2. All 4 flags preserved
echo "Flags in generated output:"
flag_failures=0
for flag in "--research" "--skip-research" "--gaps" "--skip-verify"; do
  if grep -q "$flag" .claude/skills/gsd-plan-phase.md; then
    echo "  ✓ $flag"
  else
    echo "  ✗ $flag MISSING"
    flag_failures=$((flag_failures + 1))
  fi
done
if [ $flag_failures -gt 0 ]; then
  echo "✗ FAIL: $flag_failures flags missing"
  exit 1
fi

# 3. @-reference count
ref_count=$(grep -c "@" .claude/skills/gsd-plan-phase.md || echo 0)
if [ "$ref_count" -ge 11 ]; then
  echo "✓ PASS: @-references in generated output: $ref_count (expected 11+)"
else
  echo "✗ FAIL: Only $ref_count @-references (expected 11+)"
  exit 1
fi

# 4. Phase normalization
if grep -q "printf.*%02d" .claude/skills/gsd-plan-phase.md; then
  echo "✓ PASS: Phase normalization in generated output"
else
  echo "✗ FAIL: Phase normalization missing"
  exit 1
fi

# 5. Task() spawn count
task_count=$(grep -c "Task(" .claude/skills/gsd-plan-phase.md || echo 0)
if [ "$task_count" -ge 3 ]; then
  echo "✓ PASS: Task() calls in generated output: $task_count"
else
  echo "✗ FAIL: Only $task_count Task() calls (expected 3-4)"
  exit 1
fi

# 6. All 3 agent types
echo "Agent types in generated output:"
agent_failures=0
for agent in "gsd-phase-researcher" "gsd-planner" "gsd-plan-checker"; do
  if grep -q "$agent" .claude/skills/gsd-plan-phase.md; then
    echo "  ✓ $agent"
  else
    echo "  ✗ $agent MISSING"
    agent_failures=$((agent_failures + 1))
  fi
done
if [ $agent_failures -gt 0 ]; then
  echo "✗ FAIL: $agent_failures agent types missing"
  exit 1
fi

echo ""
echo "=== MEDIUM Priority Validation ==="

# 7. Gap closure mode artifacts
if grep -q "VERIFICATION\.md" .claude/skills/gsd-plan-phase.md && \
   grep -q "UAT\.md" .claude/skills/gsd-plan-phase.md; then
  echo "✓ Gap closure mode artifacts present"
else
  echo "⚠ Gap closure mode may be incomplete"
fi

# 8. Verification loop return patterns
if grep -q "VERIFICATION PASSED" .claude/skills/gsd-plan-phase.md && \
   grep -q "ISSUES FOUND" .claude/skills/gsd-plan-phase.md; then
  echo "✓ Verification loop return patterns present"
else
  echo "⚠ Verification loop patterns may be missing"
fi

# 9. User intervention at max iterations
if grep -q "AskUserQuestion" .claude/skills/gsd-plan-phase.md || \
   grep -q "max.*iteration" .claude/skills/gsd-plan-phase.md; then
  echo "✓ User intervention logic present"
else
  echo "⚠ User intervention may be missing"
fi

echo ""
echo "=== Line Count Validation ==="
spec_lines=$(wc -l < specs/skills/gsd-plan-phase/SKILL.md)
gen_lines=$(wc -l < .claude/skills/gsd-plan-phase.md)
diff=$((gen_lines - spec_lines))
echo "Spec: $spec_lines lines"
echo "Generated: $gen_lines lines"
echo "Difference: $diff lines"

if [ $diff -gt -50 ] && [ $diff -lt 50 ]; then
  echo "✓ Line count similar"
else
  echo "⚠ Line count differs significantly"
fi
```
  </action>
  <verify>
```bash
# Final verification summary
echo ""
echo "=== Migration Verification Summary ==="
echo ""
echo "Files created:"
ls -lh specs/skills/gsd-plan-phase/SKILL.md
ls -lh .claude/skills/gsd-plan-phase.md
echo ""

# Critical preservation summary
echo "Critical patterns preserved:"
echo "  Iteration counter: $(grep -c 'iteration_count' .claude/skills/gsd-plan-phase.md) references"
echo "  Max 3 safeguard: $(grep -c 'max.*3\|< 3\|<= 3' .claude/skills/gsd-plan-phase.md) checks"
echo "  Task() spawns: $(grep -c 'Task(' .claude/skills/gsd-plan-phase.md)"
echo "  @-references: $(grep -c '@' .claude/skills/gsd-plan-phase.md)"
echo "  Phase normalization: $(grep -c 'printf.*%02d' .claude/skills/gsd-plan-phase.md) blocks"
echo ""

# Flag summary
echo "Flags preserved:"
for flag in "--research" "--skip-research" "--gaps" "--skip-verify"; do
  count=$(grep -c "$flag" .claude/skills/gsd-plan-phase.md || echo 0)
  echo "  $flag: $count refs"
done
echo ""

# Agent type summary
echo "Agent types:"
for agent in "gsd-phase-researcher" "gsd-planner" "gsd-plan-checker"; do
  count=$(grep -c "$agent" .claude/skills/gsd-plan-phase.md || echo 0)
  echo "  $agent: $count refs"
done
echo ""

echo "✓ Migration complete - plan-phase ready for testing"
echo ""
echo "⚠ IMPORTANT: Test all 4 flags individually before Phase 5"
echo "   • /gsd:plan-phase 1"
echo "   • /gsd:plan-phase 1 --research"
echo "   • /gsd:plan-phase 1 --skip-research"
echo "   • /gsd:plan-phase 1 --gaps"
echo "   • /gsd:plan-phase 1 --skip-verify"
```
  </verify>
  <done>Generated .claude/skills/gsd-plan-phase.md validates verification loop, all flags, all @-references, and sequential spawning</done>
</task>

## Success Criteria

**Phase 4 Success Criteria (plan-phase completes all):**
- [x] Commands plan-phase, research-phase, debug, map-codebase migrated to spec format ✓
- [x] Subagent spawning (1-2 agents) works correctly in all commands ✓
- [x] Argument handling preserved (--research, --gaps-only, etc.) ✓
- [x] Process subsections (<phase>, <step>) maintained in structure ✓
- [x] Embedded bash validation blocks preserved and functional ✓

**Plan-specific verification (plan-phase is highest complexity):**
- [ ] 3-iteration verification loop works (planner → checker → revision, max 3)
- [ ] All 4 flags work individually (--research, --skip-research, --gaps, --skip-verify)
- [ ] All 11 @-references load correctly
- [ ] Phase normalization handles integers (8 → 08), decimals (2.1 → 02.1), padding (08 → 08)
- [ ] Gap closure mode (--gaps) reads VERIFICATION.md/UAT.md instead of RESEARCH.md
- [ ] Sequential spawning clear (NOT parallel)
- [ ] User intervention triggers after max 3 iterations
- [ ] 13 downstream commands still work (new-project, execute-phase, plan-milestone-gaps, etc.)

## Output

```
Phase 4 Plan 04 — COMPLETE

Files created:
  • specs/skills/gsd-plan-phase/SKILL.md (~520 lines)
  • .claude/skills/gsd-plan-phase.md (generated)

Patterns preserved:
  ✓ 3-iteration verification loop with max safeguard
  ✓ All 4 flags (--research, --skip-research, --gaps, --skip-verify)
  ✓ All 11 @-references (ui-brand, STATE, ROADMAP, REQUIREMENTS, CONTEXT, RESEARCH, VERIFICATION, UAT, etc.)
  ✓ Phase normalization (integers, decimals, padding)
  ✓ Gap closure mode (reads VERIFICATION.md/UAT.md)
  ✓ Sequential spawning (researcher → planner → checker → planner)

Critical validations:
  ⚠ Test all 4 flags before Phase 5
  ⚠ Verify downstream commands (13 references)
  ⚠ Test gap closure mode (plan-milestone-gaps depends on this)

Ready for:
  • Wave 4 (04-05) - E2E verification checkpoint
  • Manual testing: /gsd:plan-phase 1 (with all flag variations)
```
