---
phase: 04-mid-complexity-commands
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - specs/skills/gsd-research-phase/SKILL.md
  - .claude/skills/gsd-research-phase.md (generated)
autonomous: true
must_haves:
  goal: "Migrate research-phase command preserving checkpoint continuation pattern"
  truths:
    - File specs/skills/gsd-research-phase/SKILL.md exists with complete spec
    - Checkpoint continuation pattern preserved (spawn → checkpoint → respawn with prior state)
    - @-reference to RESEARCH.md file preserved for continuation agent
    - Sequential spawning pattern documented (not parallel like Phase 3)
    - Mode parameter handling preserved (ecosystem research mode)
    - Generated command installs to .claude/skills/ successfully
  artifacts:
    - specs/skills/gsd-research-phase/SKILL.md
    - .claude/skills/gsd-research-phase.md (generated output)
  wiring:
    - Frontmatter includes Task, Read, Write, Bash tools
    - Body contains unmodified orchestration logic from legacy
    - gsd-phase-researcher agent spawning preserved exactly
  key_links:
    - SKILL.md → install.js::generateSkillsFromSpecs → .claude/skills/gsd-research-phase.md
---

# Phase 4 Plan 01: Migrate research-phase Command

**Objective:** Migrate gsd-research-phase to spec format, preserving checkpoint continuation pattern and sequential spawning

## Context

The research-phase command (180 lines, 1 @-reference, 2 spawns) is Tier 1 complexity—simpler than plan-phase but with a critical checkpoint continuation pattern that must work correctly. It spawns gsd-phase-researcher, which may return with a checkpoint requiring user input, then respawns with prior state loaded via @-reference.

**From Research (04-RESEARCH.md):**
- Pattern: Checkpoint-based continuation with file persistence
- Structure: Sequential spawn → checkpoint → continuation spawn
- Spawns: gsd-phase-researcher (initial + continuation if checkpoint)
- @-references: 1 (RESEARCH.md file for continuation context)
- Flags: None (simplest flag matrix)

**From Phase 3:**
- Proven migration pattern from execute-phase, new-project, new-milestone
- Folder-per-skill structure established
- Template system handles @-references automatically
- Platform conditionals for tool declarations

**Why Wave 1:**
- Independent of other Phase 4 commands
- Simplest checkpoint pattern (validates continuation before debug's more complex version)
- Referenced by plan-phase, so must complete before 04-04

## Tasks

<task name="create-research-phase-spec-structure" type="auto">
  <files>specs/skills/gsd-research-phase/SKILL.md</files>
  <action>
Create folder-per-skill structure and SKILL.md frontmatter for gsd-research-phase.

```bash
# Create folder
mkdir -p specs/skills/gsd-research-phase

# Create SKILL.md with frontmatter
cat > specs/skills/gsd-research-phase/SKILL.md << 'EOF'
---
name: gsd-research-phase
description: Research implementation approach for phase before planning
skill_version: 1.9.1
requires_version: 1.9.0+
platforms:
  - claude
  - copilot
  - codex
tools:
  - name: task
    required: true
    reason: Spawn gsd-phase-researcher agent for ecosystem research
  - name: read
    required: true
    reason: Load phase context and existing research files
  - name: write
    required: false
    reason: Optional - agents write RESEARCH.md directly
  - name: bash
    required: true
    reason: Phase normalization, directory validation, file checks
arguments:
  - name: phase
    type: string
    required: true
    description: Phase number or name to research
metadata:
  generated: {{generated}}
  platform: {{platform}}
  version: {{version}}
---
EOF

echo "✓ Created specs/skills/gsd-research-phase/SKILL.md with frontmatter"
```
  </action>
  <verify>
```bash
# Verify folder and file exist
[ -d "specs/skills/gsd-research-phase" ] && echo "✓ Folder exists"
[ -f "specs/skills/gsd-research-phase/SKILL.md" ] && echo "✓ SKILL.md exists"

# Verify frontmatter is valid YAML
node -e "
const fs = require('fs');
const yaml = require('js-yaml');
const content = fs.readFileSync('specs/skills/gsd-research-phase/SKILL.md', 'utf8');
const frontmatter = content.match(/^---\n([\s\S]+?)\n---/);
if (frontmatter) {
  const parsed = yaml.load(frontmatter[1]);
  console.log('✓ Frontmatter valid:', parsed.name);
} else {
  throw new Error('No frontmatter found');
}
"
```
  </verify>
  <done>Folder specs/skills/gsd-research-phase/ exists with valid SKILL.md frontmatter</done>
</task>

<task name="migrate-research-phase-body" type="auto">
  <files>specs/skills/gsd-research-phase/SKILL.md</files>
  <action>
Migrate complete body content from legacy commands/gsd/research-phase.md to spec body.

**Critical preservation:**
1. Phase normalization logic (lines 36-44: handles integers, decimals, padding)
2. Checkpoint continuation pattern (lines 73-171: spawn → parse return → respawn with prior_state)
3. @-reference to RESEARCH.md file (continuation agent loads prior work)
4. Sequential spawning (NOT parallel—one agent at a time)
5. Mode parameter (ecosystem research mode passed to agent)

**Migration steps:**

```bash
# Extract body content from legacy (everything after frontmatter)
sed -n '/^---$/,/^---$/!p' commands/gsd/research-phase.md | tail -n +2 > /tmp/research-phase-body.md

# Append to SKILL.md (after frontmatter)
cat /tmp/research-phase-body.md >> specs/skills/gsd-research-phase/SKILL.md

echo "✓ Migrated body content from legacy command"
```

**Verify critical patterns preserved:**

```bash
# 1. Check phase normalization logic present
grep -q "printf.*%02d" specs/skills/gsd-research-phase/SKILL.md && echo "✓ Phase normalization logic preserved"

# 2. Check Task() spawn calls (should be 2: initial + continuation)
task_count=$(grep -c "Task(" specs/skills/gsd-research-phase/SKILL.md || echo 0)
if [ "$task_count" -ge 2 ]; then
  echo "✓ Task spawn calls preserved ($task_count found)"
else
  echo "✗ Expected 2+ Task() calls, found $task_count"
fi

# 3. Check @-reference to RESEARCH.md for continuation
grep -q "@.*RESEARCH.md" specs/skills/gsd-research-phase/SKILL.md && echo "✓ @-reference to RESEARCH.md preserved"

# 4. Check checkpoint handling (CHECKPOINT REACHED pattern)
grep -q "CHECKPOINT REACHED" specs/skills/gsd-research-phase/SKILL.md && echo "✓ Checkpoint handling preserved"

# 5. Check gsd-phase-researcher agent type
grep -q "gsd-phase-researcher" specs/skills/gsd-research-phase/SKILL.md && echo "✓ Agent type preserved"
```
  </action>
  <verify>
```bash
# Verify file structure
echo "=== File Statistics ==="
wc -l specs/skills/gsd-research-phase/SKILL.md
echo ""

# Verify critical sections exist
echo "=== Critical Sections Check ==="
grep -c "<objective>" specs/skills/gsd-research-phase/SKILL.md | xargs -I {} echo "✓ <objective> sections: {}"
grep -c "<process>" specs/skills/gsd-research-phase/SKILL.md | xargs -I {} echo "✓ <process> sections: {}"
grep -c "Task(" specs/skills/gsd-research-phase/SKILL.md | xargs -I {} echo "✓ Task() calls: {}"
grep -c "@" specs/skills/gsd-research-phase/SKILL.md | xargs -I {} echo "✓ @-references: {}"

# Compare line count with legacy (should be similar: ~180 + frontmatter ~30 = ~210)
legacy_lines=$(wc -l < commands/gsd/research-phase.md)
spec_lines=$(wc -l < specs/skills/gsd-research-phase/SKILL.md)
echo ""
echo "Legacy: $legacy_lines lines"
echo "Spec: $spec_lines lines"
echo "Difference: $((spec_lines - legacy_lines)) lines (should be ~30 for expanded frontmatter)"
```
  </verify>
  <done>Body content migrated with phase normalization, checkpoint continuation, @-references, and sequential spawning preserved</done>
</task>

<task name="generate-and-verify-research-phase" type="auto">
  <files>bin/install.js</files>
  <action>
Generate research-phase skill using template system and verify output.

```bash
# Run skill generation
echo "Generating gsd-research-phase skill..."
node bin/install.js --skills-only --platform claude 2>&1 | tee /tmp/research-phase-gen.log

# Check for errors
if grep -i "error" /tmp/research-phase-gen.log; then
  echo "✗ Generation errors found"
  exit 1
else
  echo "✓ Generation completed without errors"
fi

# Verify generated file exists
if [ -f ".claude/skills/gsd-research-phase.md" ]; then
  echo "✓ Generated file exists: .claude/skills/gsd-research-phase.md"
  wc -l .claude/skills/gsd-research-phase.md
else
  echo "✗ Generated file not found"
  exit 1
fi
```

**Validation checks:**

```bash
echo ""
echo "=== Validation Checks ==="

# 1. Verify Task() calls preserved in generated output
task_count=$(grep -c "Task(" .claude/skills/gsd-research-phase.md || echo 0)
if [ "$task_count" -ge 2 ]; then
  echo "✓ Task() calls in generated output: $task_count"
else
  echo "✗ Task() calls missing in generated output"
fi

# 2. Verify @-references preserved
ref_count=$(grep -c "@" .claude/skills/gsd-research-phase.md || echo 0)
if [ "$ref_count" -ge 1 ]; then
  echo "✓ @-references in generated output: $ref_count"
else
  echo "✗ @-references missing in generated output"
fi

# 3. Verify checkpoint pattern preserved
if grep -q "CHECKPOINT REACHED" .claude/skills/gsd-research-phase.md; then
  echo "✓ Checkpoint pattern in generated output"
else
  echo "✗ Checkpoint pattern missing"
fi

# 4. Verify phase normalization bash block preserved
if grep -q "printf.*%02d" .claude/skills/gsd-research-phase.md; then
  echo "✓ Phase normalization logic in generated output"
else
  echo "✗ Phase normalization missing"
fi

# 5. Compare line counts (generated should be similar to spec)
spec_lines=$(wc -l < specs/skills/gsd-research-phase/SKILL.md)
gen_lines=$(wc -l < .claude/skills/gsd-research-phase.md)
diff=$((gen_lines - spec_lines))
if [ $diff -gt -50 ] && [ $diff -lt 50 ]; then
  echo "✓ Line count similar (spec: $spec_lines, gen: $gen_lines, diff: $diff)"
else
  echo "⚠ Line count differs significantly (diff: $diff lines)"
fi
```
  </action>
  <verify>
```bash
# Final verification summary
echo ""
echo "=== Migration Verification Summary ==="
echo ""
echo "Files created:"
ls -lh specs/skills/gsd-research-phase/SKILL.md
ls -lh .claude/skills/gsd-research-phase.md
echo ""

# Test pattern preservation
echo "Pattern preservation:"
echo "  Phase normalization: $(grep -c 'printf.*%02d' .claude/skills/gsd-research-phase.md) blocks"
echo "  Task spawns: $(grep -c 'Task(' .claude/skills/gsd-research-phase.md) calls"
echo "  @-references: $(grep -c '@' .claude/skills/gsd-research-phase.md) references"
echo "  Checkpoint handling: $(grep -c 'CHECKPOINT REACHED' .claude/skills/gsd-research-phase.md) patterns"
echo ""

echo "✓ Migration complete - research-phase ready for testing"
```
  </verify>
  <done>Generated .claude/skills/gsd-research-phase.md validates checkpoint continuation pattern and sequential spawning preserved</done>
</task>

## Success Criteria

**Phase 4 Success Criteria (subset for research-phase):**
- [x] Command research-phase migrated to spec format ✓
- [x] Subagent spawning (1-2 agents) works correctly ✓ (gsd-phase-researcher: 2 spawns)
- [x] Argument handling preserved ✓ (phase argument)
- [x] Process subsections maintained in structure ✓
- [x] Embedded bash validation blocks preserved ✓

**Plan-specific verification:**
- [ ] Checkpoint continuation pattern works (spawn → user input → respawn)
- [ ] @-reference loads prior RESEARCH.md correctly
- [ ] Phase normalization handles integers, decimals, padding
- [ ] Sequential spawning clear (NOT parallel like Phase 3)
- [ ] Mode parameter passes to agent correctly

## Output

```
Phase 4 Plan 01 — COMPLETE

Files created:
  • specs/skills/gsd-research-phase/SKILL.md (~210 lines)
  • .claude/skills/gsd-research-phase.md (generated)

Patterns preserved:
  ✓ Checkpoint continuation (spawn → checkpoint → respawn with prior_state)
  ✓ Phase normalization (integers, decimals, padding)
  ✓ @-reference to RESEARCH.md for continuation agent
  ✓ Sequential spawning (NOT parallel)
  ✓ Mode parameter handling (ecosystem research mode)

Ready for:
  • Wave 1 continues with 04-02 (map-codebase)
  • Manual testing: /gsd:research-phase 1
```
