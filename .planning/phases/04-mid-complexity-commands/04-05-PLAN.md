---
phase: 04-mid-complexity-commands
plan: 05
type: checkpoint:human-verify
wave: 4
depends_on: [04-01, 04-02, 04-03, 04-04]
files_modified: []
autonomous: false
gate: blocking
must_haves:
  goal: "Verify all 4 Phase 4 commands work correctly with subagent spawning, checkpoints, and flag handling"
  truths:
    - All 4 commands install successfully to .claude/skills/
    - research-phase checkpoint continuation works (spawn → checkpoint → respawn)
    - map-codebase parallel spawning works (4 agents, 7 files created)
    - debug session persistence works (file-based state, resume session)
    - plan-phase verification loop works (max 3 iterations, user intervention)
    - All flags tested (plan-phase: 4 flags work individually)
    - Downstream commands still work (execute-phase suggests plan-phase, new-project offers plan-phase)
  artifacts:
    - Test results documented for each command
    - Flag matrix tested for plan-phase
    - Downstream integration confirmed
  wiring:
    - Claude executor tests each command end-to-end
    - Human verifies outputs, file creation, checkpoint behavior
  key_links:
    - Migration validation before Phase 5 begins
---

# Phase 4 Plan 05: E2E Verification Checkpoint

**Objective:** Human verification of all 4 Phase 4 commands working correctly with subagent spawning, checkpoints, and complex flag handling

## Context

Phase 4 migrated 4 mid-complexity commands with diverse patterns: checkpoint continuation (research-phase), parallel spawning (map-codebase), session persistence (debug), and verification loops (plan-phase). Before proceeding to Phase 5 (bulk migration of 19 simpler commands), we must verify these patterns work end-to-end.

**From Phase 4 Plans:**
- 04-01: research-phase (checkpoint continuation)
- 04-02: map-codebase (prose → explicit parallel spawns)
- 04-03: debug (session persistence)
- 04-04: plan-phase (verification loop, 4 flags, 11 @-references)

**Critical validation areas:**
1. **Subagent spawning**: 1-4 agents per command spawn correctly
2. **Checkpoints**: Continuation pattern works (research-phase, debug)
3. **Session persistence**: File-based state across context resets (debug)
4. **Verification loops**: Max iterations, user intervention (plan-phase)
5. **Flag handling**: All 4 plan-phase flags work individually
6. **Downstream integration**: Commands that reference plan-phase still work

**What we're NOT testing:**
- Template system itself (validated in Phase 2-3)
- Agent specs (those are unchanged, tested separately)
- Simple cases covered in Phase 3 (parallel spawning of 5+ agents)

## What Claude Built

Claude executed Plans 04-01 through 04-04, creating 4 skill specs and generating 4 Claude commands:

1. **research-phase** (04-01):
   - Spec: specs/skills/gsd-research-phase/SKILL.md (~210 lines)
   - Generated: .claude/skills/gsd-research-phase.md
   - Pattern: Checkpoint continuation (spawn → checkpoint → respawn with prior state)

2. **map-codebase** (04-02):
   - Spec: specs/skills/gsd-map-codebase/SKILL.md (~180 lines)
   - Generated: .claude/skills/gsd-map-codebase.md
   - Pattern: Prose → 4 explicit parallel Task() calls with focus differentiation

3. **debug** (04-03):
   - Spec: specs/skills/gsd-debug/SKILL.md (~190 lines)
   - Generated: .claude/skills/gsd-debug.md
   - Pattern: Session persistence, multi-question symptom gathering, checkpoint continuation

4. **plan-phase** (04-04):
   - Spec: specs/skills/gsd-plan-phase/SKILL.md (~520 lines)
   - Generated: .claude/skills/gsd-plan-phase.md
   - Pattern: 3-iteration verification loop, 4 flags, 11 @-references, sequential spawning

## How to Verify

### Test 1: research-phase Checkpoint Continuation

**What to test:** Checkpoint handling and continuation spawning

```bash
# Test in test workspace (not live project)
cd /tmp
mkdir test-research-phase
cd test-research-phase

# Initialize minimal project structure
mkdir -p .planning/phases/01-test-phase
echo "# Roadmap" > .planning/ROADMAP.md
echo "### Phase 1: Test Phase" >> .planning/ROADMAP.md

# Run research-phase
/gsd:research-phase 1
```

**Expected behavior:**
1. Command spawns gsd-phase-researcher agent
2. Agent may return with "## CHECKPOINT REACHED" (if complex domain)
3. If checkpoint: user prompted for input, agent respawns with @-reference to prior RESEARCH.md
4. Final output: .planning/phases/01-test-phase/01-RESEARCH.md exists

**Verification checklist:**
- [ ] Command runs without errors
- [ ] gsd-phase-researcher agent spawns
- [ ] If checkpoint reached: continuation spawn works with prior state loaded
- [ ] RESEARCH.md file created in correct location
- [ ] File contains expected sections (Standard Stack, Architecture Patterns, Don't Hand-Roll)

### Test 2: map-codebase Parallel Spawning

**What to test:** 4 parallel agents spawn with different focuses, 7 files created

```bash
# Test in /workspace (real codebase)
cd /workspace

# Run map-codebase (may overwrite existing .planning/codebase/)
/gsd:map-codebase
```

**Expected behavior:**
1. Command checks for existing .planning/codebase/ (offers refresh or skip)
2. Spawns 4 parallel gsd-codebase-mapper agents:
   - Agent 1: tech focus → STACK.md, INTEGRATIONS.md
   - Agent 2: arch focus → ARCHITECTURE.md, STRUCTURE.md
   - Agent 3: quality focus → CONVENTIONS.md, TESTING.md
   - Agent 4: concerns focus → CONCERNS.md
3. Waits for all 4 agents to complete
4. Verifies all 7 files created
5. Commits codebase map

**Verification checklist:**
- [ ] Command runs without errors
- [ ] 4 agents spawn in parallel (visible in output)
- [ ] All 7 files created: STACK.md, INTEGRATIONS.md, ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, CONCERNS.md
- [ ] Files contain expected content (not stubs)
- [ ] Git commit successful

**Quick file check:**
```bash
ls -lh .planning/codebase/*.md
wc -l .planning/codebase/*.md
```

### Test 3: debug Session Persistence

**What to test:** Session management, symptom gathering, file persistence, resume

```bash
# Test new debug session
cd /workspace
/gsd:debug "Template system generates empty files"
```

**Expected behavior:**
1. If active sessions exist: offers to resume or start new
2. For new issue: prompts 5 symptom questions (expected, actual, errors, timeline, reproduction)
3. Creates slug from issue description (e.g., "template-system-generates-empty-files")
4. Creates .planning/debug/{slug}.md
5. Spawns gsd-debugger with symptoms and persistence file
6. Agent investigates, may reach checkpoint
7. If checkpoint: user responds, agent respawns with @-reference to debug file

**Verification checklist:**
- [ ] Symptom gathering: 5 questions asked
- [ ] Debug file created: .planning/debug/{slug}.md
- [ ] gsd-debugger agent spawns
- [ ] File persists investigation findings
- [ ] If checkpoint: continuation spawn loads prior state

**Test resume:**
```bash
# Run without arguments to see active sessions
/gsd:debug

# Expected: Lists active sessions, offers resume
# Select existing session to resume
```

- [ ] Active sessions listed
- [ ] Resume works (loads prior state from debug file)

### Test 4: plan-phase Verification Loop

**What to test:** Verification loop with max 3 iterations, all 4 flags

```bash
# Test default flow (with verification)
cd /workspace
/gsd:plan-phase 1
```

**Expected behavior:**
1. Parses arguments, normalizes phase (1 → 01)
2. Checks for existing RESEARCH.md (uses if exists, spawns researcher if not)
3. Spawns gsd-planner agent
4. Planner creates PLAN.md file(s)
5. Spawns gsd-plan-checker agent
6. If checker finds issues: respawn planner with feedback (max 3 iterations)
7. If max iterations: user intervention prompt
8. Updates ROADMAP.md with plan details

**Verification checklist:**
- [ ] Phase normalization works (1 → 01)
- [ ] Researcher spawn conditional on existing RESEARCH.md
- [ ] gsd-planner spawns and creates PLAN.md
- [ ] gsd-plan-checker spawns and verifies plan
- [ ] If issues: revision loop works (max 3 iterations)
- [ ] ROADMAP.md updated
- [ ] Git commit successful

**Test flags individually:**

```bash
# Test --research flag (force re-research)
/gsd:plan-phase 2 --research
# Expected: Spawns researcher even if RESEARCH.md exists

# Test --skip-research flag
/gsd:plan-phase 3 --skip-research
# Expected: Skips researcher, goes straight to planner

# Test --skip-verify flag
/gsd:plan-phase 4 --skip-verify
# Expected: Skips checker, trusts planner output

# Test --gaps flag (gap closure mode)
# Prerequisites: Need VERIFICATION.md with gaps
# /gsd:plan-phase 1 --gaps
# Expected: Reads VERIFICATION.md/UAT.md instead of RESEARCH.md
```

**Flag verification checklist:**
- [ ] `--research`: Forces re-research
- [ ] `--skip-research`: Skips researcher entirely
- [ ] `--skip-verify`: Skips checker loop
- [ ] `--gaps`: Reads VERIFICATION.md/UAT.md (if available to test)

### Test 5: Downstream Integration

**What to test:** Commands that reference plan-phase still work

```bash
# Test execute-phase suggests plan-phase if no plans
/gsd:execute-phase 5
# Expected: If no plans exist, suggests running /gsd:plan-phase 5

# Test new-project offers plan-phase at completion
# (Skip if don't want to create new project)
# /gsd:new-project
# Expected: At end, offers "Plan first phase? /gsd:plan-phase 1"
```

**Verification checklist:**
- [ ] execute-phase references plan-phase correctly
- [ ] new-project references plan-phase correctly
- [ ] No broken references or command not found errors

### Test 6: Installation Verification

**What to test:** All 4 commands installed to correct location

```bash
# Verify all 4 generated files exist
ls -lh .claude/skills/gsd-research-phase.md
ls -lh .claude/skills/gsd-map-codebase.md
ls -lh .claude/skills/gsd-debug.md
ls -lh .claude/skills/gsd-plan-phase.md

# Verify line counts reasonable
wc -l .claude/skills/gsd-research-phase.md  # ~210
wc -l .claude/skills/gsd-map-codebase.md    # ~180
wc -l .claude/skills/gsd-debug.md           # ~190
wc -l .claude/skills/gsd-plan-phase.md      # ~520
```

**Verification checklist:**
- [ ] All 4 files exist in .claude/skills/
- [ ] Line counts reasonable (not empty, not truncated)
- [ ] Files have proper frontmatter (if checking manually)

## Resume Signal

After completing all tests above, report results:

**If all tests pass:**
```
Type: "approved - all 4 commands working"

Summary of tests:
✓ research-phase: [brief result]
✓ map-codebase: [brief result]
✓ debug: [brief result]
✓ plan-phase: [brief result]
✓ Flags: [which flags tested]
✓ Downstream: [which commands tested]
```

**If issues found:**
```
Type: "issues - [describe issues]"

Failed tests:
✗ [command]: [what failed]
...

Error details:
[paste error messages or unexpected behavior]
```

## Next Steps After Approval

- **If approved**: Phase 4 complete, proceed to Phase 5 (simple command migration)
- **If issues**: Create gap closure plan to fix specific issues before Phase 5

## Success Criteria

All Phase 4 Success Criteria from ROADMAP.md verified:
- [ ] Commands plan-phase, research-phase, debug, map-codebase migrated to spec format
- [ ] Subagent spawning (1-2 agents) works correctly in all commands
- [ ] Argument handling preserved (--research, --gaps-only, etc.)
- [ ] Process subsections (<phase>, <step>) maintained in structure
- [ ] Embedded bash validation blocks preserved and functional

Additional E2E criteria:
- [ ] Checkpoint continuation works (research-phase, debug)
- [ ] Parallel spawning works (map-codebase: 4 agents, 7 files)
- [ ] Session persistence works (debug: .planning/debug/{slug}.md)
- [ ] Verification loop works (plan-phase: max 3 iterations)
- [ ] All flags work (plan-phase: 4 flags tested individually)
- [ ] Downstream integration intact (execute-phase, new-project reference plan-phase)
