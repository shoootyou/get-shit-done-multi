---
phase: 04-mid-complexity-commands
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - specs/skills/gsd-map-codebase/SKILL.md
  - .claude/skills/gsd-map-codebase.md (generated)
autonomous: true
must_haves:
  goal: "Migrate map-codebase command converting prose spawning to explicit Task() calls"
  truths:
    - File specs/skills/gsd-map-codebase/SKILL.md exists with complete spec
    - Prose spawn description converted to 4 explicit Task() calls (tech, arch, quality, concerns)
    - Parallel spawning pattern documented (4 agents spawn simultaneously)
    - @-reference to workflow file preserved (~/.claude/get-shit-done/workflows/map-codebase.md)
    - All 7 output files documented (STACK, INTEGRATIONS, ARCHITECTURE, STRUCTURE, CONVENTIONS, TESTING, CONCERNS)
    - Generated command installs to .claude/skills/ successfully
  artifacts:
    - specs/skills/gsd-map-codebase/SKILL.md
    - .claude/skills/gsd-map-codebase.md (generated output)
  wiring:
    - Frontmatter includes Task, Read, Write, Bash, Glob, Grep tools
    - Body contains 4 explicit Task() calls for parallel mapper spawning
    - gsd-codebase-mapper agent spawning with different focus parameters
  key_links:
    - SKILL.md → install.js::generateSkillsFromSpecs → .claude/skills/gsd-map-codebase.md
---

# Phase 4 Plan 02: Migrate map-codebase Command

**Objective:** Migrate gsd-map-codebase to spec format, converting prose spawn description to explicit parallel Task() calls

## Context

The map-codebase command (71 lines, 1 @-reference, 4 prose spawns) is Tier 1 complexity—shortest in Phase 4 but requires converting prose spawn description ("Spawn 4 parallel agents...") into explicit Task() calls. This validates the parallel spawn pattern for mid-tier commands before tackling plan-phase's sequential spawning with verification loops.

**From Research (04-RESEARCH.md):**
- Pattern: Prose spawn description needs conversion to explicit Task() calls
- Spawns: 4 parallel gsd-codebase-mapper agents with different focus areas
- Focus areas: tech, arch, quality, concerns
- Output: 7 files in .planning/codebase/
- @-references: 1 (workflow file with agent prompt templates)

**From legacy (commands/gsd/map-codebase.md lines 54-58):**
```markdown
3. Spawn 4 parallel gsd-codebase-mapper agents:
   - Agent 1: tech focus → writes STACK.md, INTEGRATIONS.md
   - Agent 2: arch focus → writes ARCHITECTURE.md, STRUCTURE.md
   - Agent 3: quality focus → writes CONVENTIONS.md, TESTING.md
   - Agent 4: concerns focus → writes CONCERNS.md
```

**Why Wave 1:**
- Independent of other Phase 4 commands
- Simplest command by line count (71 lines)
- Tests prose → explicit conversion pattern
- Parallel spawning (like Phase 3), not sequential (unlike debug/research-phase)

## Tasks

<task name="create-map-codebase-spec-structure" type="auto">
  <files>specs/skills/gsd-map-codebase/SKILL.md</files>
  <action>
Create folder-per-skill structure and SKILL.md frontmatter for gsd-map-codebase.

```bash
# Create folder
mkdir -p specs/skills/gsd-map-codebase

# Create SKILL.md with frontmatter
cat > specs/skills/gsd-map-codebase/SKILL.md << 'EOF'
---
name: gsd-map-codebase
description: Analyze codebase with parallel mapper agents to produce structured documentation
skill_version: 1.9.1
requires_version: 1.9.0+
platforms:
  - claude
  - copilot
  - codex
tools:
  - name: task
    required: true
    reason: Spawn 4 parallel gsd-codebase-mapper agents with different focuses
  - name: read
    required: true
    reason: Load project state and check existing codebase maps
  - name: write
    required: false
    reason: Agents write codebase documents directly
  - name: bash
    required: true
    reason: Directory creation, file validation, git operations
  - name: glob
    required: true
    reason: Discover existing codebase files
  - name: grep
    required: true
    reason: Search codebase for patterns during mapping
arguments:
  - name: area
    type: string
    required: false
    description: Optional specific area to map (e.g., 'api', 'auth')
metadata:
  generated: {{generated}}
  platform: {{platform}}
  version: {{version}}
---
EOF

echo "✓ Created specs/skills/gsd-map-codebase/SKILL.md with frontmatter"
```
  </action>
  <verify>
```bash
# Verify folder and file exist
[ -d "specs/skills/gsd-map-codebase" ] && echo "✓ Folder exists"
[ -f "specs/skills/gsd-map-codebase/SKILL.md" ] && echo "✓ SKILL.md exists"

# Verify frontmatter is valid YAML
node -e "
const fs = require('fs');
const yaml = require('js-yaml');
const content = fs.readFileSync('specs/skills/gsd-map-codebase/SKILL.md', 'utf8');
const frontmatter = content.match(/^---\n([\s\S]+?)\n---/);
if (frontmatter) {
  const parsed = yaml.load(frontmatter[1]);
  console.log('✓ Frontmatter valid:', parsed.name);
  console.log('✓ Tools declared:', parsed.tools.length);
} else {
  throw new Error('No frontmatter found');
}
"
```
  </verify>
  <done>Folder specs/skills/gsd-map-codebase/ exists with valid SKILL.md frontmatter</done>
</task>

<task name="migrate-map-codebase-with-explicit-spawns" type="auto">
  <files>specs/skills/gsd-map-codebase/SKILL.md</files>
  <action>
Migrate body content from legacy, CONVERTING prose spawn description to explicit Task() calls.

**Critical conversion:**
Legacy prose (lines 54-58):
```
3. Spawn 4 parallel gsd-codebase-mapper agents:
   - Agent 1: tech focus → writes STACK.md, INTEGRATIONS.md
   ...
```

Must become explicit Task() calls with focus parameter differentiation.

**Migration steps:**

```bash
# Extract body content from legacy
sed -n '/^---$/,/^---$/!p' commands/gsd/map-codebase.md | tail -n +2 > /tmp/map-codebase-body.md

# Append to SKILL.md
cat /tmp/map-codebase-body.md >> specs/skills/gsd-map-codebase/SKILL.md

echo "✓ Migrated body content from legacy command"
```

**Now convert prose to explicit spawns:**

```bash
# Create temporary file with conversion
cat > /tmp/spawn-conversion.txt << 'SPAWNS'

**Spawn 4 parallel gsd-codebase-mapper agents:**

```javascript
// Agent 1: Tech focus
Task({
  prompt: `
<objective>
Map codebase technology stack and integrations
</objective>

<focus>tech</focus>

<area>${FOCUS_AREA || "entire codebase"}</area>

<writes>
- .planning/codebase/STACK.md
- .planning/codebase/INTEGRATIONS.md
</writes>

<workflow>
@~/.claude/get-shit-done/workflows/map-codebase.md
</workflow>
  `,
  agent_type: "gsd-codebase-mapper",
  description: "Map tech stack and integrations"
});

// Agent 2: Architecture focus
Task({
  prompt: `
<objective>
Map codebase architecture and structure
</objective>

<focus>arch</focus>

<area>${FOCUS_AREA || "entire codebase"}</area>

<writes>
- .planning/codebase/ARCHITECTURE.md
- .planning/codebase/STRUCTURE.md
</writes>

<workflow>
@~/.claude/get-shit-done/workflows/map-codebase.md
</workflow>
  `,
  agent_type: "gsd-codebase-mapper",
  description: "Map architecture and structure"
});

// Agent 3: Quality focus
Task({
  prompt: `
<objective>
Map codebase conventions and testing practices
</objective>

<focus>quality</focus>

<area>${FOCUS_AREA || "entire codebase"}</area>

<writes>
- .planning/codebase/CONVENTIONS.md
- .planning/codebase/TESTING.md
</writes>

<workflow>
@~/.claude/get-shit-done/workflows/map-codebase.md
</workflow>
  `,
  agent_type: "gsd-codebase-mapper",
  description: "Map conventions and testing"
});

// Agent 4: Concerns focus
Task({
  prompt: `
<objective>
Identify codebase concerns and issues
</objective>

<focus>concerns</focus>

<area>${FOCUS_AREA || "entire codebase"}</area>

<writes>
- .planning/codebase/CONCERNS.md
</writes>

<workflow>
@~/.claude/get-shit-done/workflows/map-codebase.md
</workflow>
  `,
  agent_type: "gsd-codebase-mapper",
  description: "Identify concerns and issues"
});
```

SPAWNS

echo "✓ Created explicit spawn conversion"
echo ""
echo "Manual step: Replace prose spawn section in SKILL.md with explicit Task() calls"
echo "Location: Find '3. Spawn 4 parallel gsd-codebase-mapper agents:' in SKILL.md"
echo "Replace with: Content from /tmp/spawn-conversion.txt"
```

**Verify critical patterns:**

```bash
echo ""
echo "=== Verification Checks ==="

# Count Task() calls (should be 4 after manual conversion)
task_count=$(grep -c "Task(" specs/skills/gsd-map-codebase/SKILL.md || echo 0)
echo "Task() calls found: $task_count (expect 4 after conversion)"

# Check for focus parameter differentiation
for focus in tech arch quality concerns; do
  if grep -q "<focus>$focus</focus>" specs/skills/gsd-map-codebase/SKILL.md; then
    echo "✓ Focus '$focus' present in Task() call"
  else
    echo "⚠ Focus '$focus' not found - may need conversion"
  fi
done

# Check @-reference to workflow file
if grep -q "@.*workflows/map-codebase.md" specs/skills/gsd-map-codebase/SKILL.md; then
  echo "✓ @-reference to workflow file preserved"
else
  echo "⚠ @-reference missing - verify workflow reference"
fi

# Check all 7 output files mentioned
for file in STACK INTEGRATIONS ARCHITECTURE STRUCTURE CONVENTIONS TESTING CONCERNS; do
  if grep -q "${file}.md" specs/skills/gsd-map-codebase/SKILL.md; then
    echo "✓ Output file $file.md documented"
  fi
done
```
  </action>
  <verify>
```bash
# Verify conversion complete
echo "=== Prose → Explicit Conversion Verification ==="

# Must have 4 Task() calls
task_count=$(grep -c "Task(" specs/skills/gsd-map-codebase/SKILL.md || echo 0)
if [ "$task_count" -eq 4 ]; then
  echo "✓ Exactly 4 Task() calls present (prose converted)"
else
  echo "✗ Expected 4 Task() calls, found $task_count"
  exit 1
fi

# Must have all 4 focus types
for focus in tech arch quality concerns; do
  if ! grep -q "<focus>$focus</focus>" specs/skills/gsd-map-codebase/SKILL.md; then
    echo "✗ Missing focus: $focus"
    exit 1
  fi
done
echo "✓ All 4 focus types present (tech, arch, quality, concerns)"

# Verify gsd-codebase-mapper agent type
mapper_count=$(grep -c "gsd-codebase-mapper" specs/skills/gsd-map-codebase/SKILL.md || echo 0)
if [ "$mapper_count" -ge 4 ]; then
  echo "✓ Agent type gsd-codebase-mapper referenced $mapper_count times"
else
  echo "✗ Expected 4+ references to gsd-codebase-mapper, found $mapper_count"
fi

# Line count check (should be ~150-200: legacy 71 + frontmatter 30 + explicit spawns ~50-100)
spec_lines=$(wc -l < specs/skills/gsd-map-codebase/SKILL.md)
echo ""
echo "Spec line count: $spec_lines (expect 150-250 after conversion)"
```
  </verify>
  <done>Body migrated with prose spawns converted to 4 explicit Task() calls with focus differentiation</done>
</task>

<task name="generate-and-verify-map-codebase" type="auto">
  <files>bin/install.js</files>
  <action>
Generate map-codebase skill using template system and verify parallel spawning preserved.

```bash
# Run skill generation
echo "Generating gsd-map-codebase skill..."
node bin/install.js --skills-only --platform claude 2>&1 | tee /tmp/map-codebase-gen.log

# Check for errors
if grep -i "error" /tmp/map-codebase-gen.log; then
  echo "✗ Generation errors found"
  exit 1
else
  echo "✓ Generation completed without errors"
fi

# Verify generated file exists
if [ -f ".claude/skills/gsd-map-codebase.md" ]; then
  echo "✓ Generated file exists: .claude/skills/gsd-map-codebase.md"
  wc -l .claude/skills/gsd-map-codebase.md
else
  echo "✗ Generated file not found"
  exit 1
fi
```

**Validation checks:**

```bash
echo ""
echo "=== Parallel Spawn Validation ==="

# 1. Verify 4 Task() calls preserved in generated output
task_count=$(grep -c "Task(" .claude/skills/gsd-map-codebase.md || echo 0)
if [ "$task_count" -eq 4 ]; then
  echo "✓ Exactly 4 Task() calls in generated output"
else
  echo "✗ Expected 4 Task() calls, found $task_count"
  exit 1
fi

# 2. Verify all focus types preserved
echo "Focus types in generated output:"
for focus in tech arch quality concerns; do
  if grep -q "<focus>$focus</focus>" .claude/skills/gsd-map-codebase.md; then
    echo "  ✓ $focus"
  else
    echo "  ✗ $focus MISSING"
    exit 1
  fi
done

# 3. Verify @-reference to workflow preserved
if grep -q "@.*workflows/map-codebase.md" .claude/skills/gsd-map-codebase.md; then
  echo "✓ @-reference to workflow file preserved"
else
  echo "✗ @-reference missing in generated output"
fi

# 4. Verify all 7 output files documented
echo "Output files documented:"
for file in STACK INTEGRATIONS ARCHITECTURE STRUCTURE CONVENTIONS TESTING CONCERNS; do
  if grep -q "${file}.md" .claude/skills/gsd-map-codebase.md; then
    echo "  ✓ $file.md"
  else
    echo "  ⚠ $file.md not mentioned"
  fi
done

# 5. Verify agent type
mapper_count=$(grep -c "gsd-codebase-mapper" .claude/skills/gsd-map-codebase.md || echo 0)
if [ "$mapper_count" -ge 4 ]; then
  echo "✓ Agent type gsd-codebase-mapper referenced $mapper_count times"
else
  echo "✗ Agent type references insufficient: $mapper_count"
fi
```
  </action>
  <verify>
```bash
# Final verification summary
echo ""
echo "=== Migration Verification Summary ==="
echo ""
echo "Files created:"
ls -lh specs/skills/gsd-map-codebase/SKILL.md
ls -lh .claude/skills/gsd-map-codebase.md
echo ""

# Pattern preservation summary
echo "Pattern preservation:"
echo "  Task() calls: $(grep -c 'Task(' .claude/skills/gsd-map-codebase.md)"
echo "  Focus areas: $(grep -c '<focus>' .claude/skills/gsd-map-codebase.md)"
echo "  @-references: $(grep -c '@' .claude/skills/gsd-map-codebase.md)"
echo "  Agent type: gsd-codebase-mapper ($(grep -c 'gsd-codebase-mapper' .claude/skills/gsd-map-codebase.md) refs)"
echo ""

# Conversion verification
echo "Prose → Explicit conversion:"
if grep -q "Spawn 4 parallel" .claude/skills/gsd-map-codebase.md && \
   [ "$(grep -c 'Task(' .claude/skills/gsd-map-codebase.md)" -lt 4 ]; then
  echo "  ✗ FAILED - Prose still present, not converted"
  exit 1
elif [ "$(grep -c 'Task(' .claude/skills/gsd-map-codebase.md)" -eq 4 ]; then
  echo "  ✓ SUCCESS - 4 explicit Task() calls present"
else
  echo "  ⚠ PARTIAL - Check Task() count"
fi

echo ""
echo "✓ Migration complete - map-codebase ready for testing"
```
  </verify>
  <done>Generated .claude/skills/gsd-map-codebase.md validates 4 parallel Task() calls with focus differentiation</done>
</task>

## Success Criteria

**Phase 4 Success Criteria (subset for map-codebase):**
- [x] Command map-codebase migrated to spec format ✓
- [x] Subagent spawning (4 parallel agents) works correctly ✓
- [x] Argument handling preserved ✓ (optional area parameter)
- [x] Process subsections maintained in structure ✓
- [x] Parallel spawn pattern documented ✓

**Plan-specific verification:**
- [ ] Prose spawning converted to 4 explicit Task() calls
- [ ] Focus differentiation present (tech, arch, quality, concerns)
- [ ] @-reference to workflow file preserved
- [ ] All 7 output files documented (STACK, INTEGRATIONS, ARCHITECTURE, STRUCTURE, CONVENTIONS, TESTING, CONCERNS)
- [ ] Parallel spawning (NOT sequential) clear

## Output

```
Phase 4 Plan 02 — COMPLETE

Files created:
  • specs/skills/gsd-map-codebase/SKILL.md (~180 lines)
  • .claude/skills/gsd-map-codebase.md (generated)

Patterns preserved:
  ✓ Prose spawn converted to 4 explicit Task() calls
  ✓ Focus differentiation (tech, arch, quality, concerns)
  ✓ @-reference to workflow file
  ✓ Parallel spawning pattern (4 simultaneous agents)
  ✓ All 7 output files documented

Ready for:
  • Wave 2 begins with 04-03 (debug)
  • Manual testing: /gsd:map-codebase
```
