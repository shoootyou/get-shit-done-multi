---
phase: 04-mid-complexity-commands
plan: 03
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - specs/skills/gsd-debug/SKILL.md
  - .claude/skills/gsd-debug.md (generated)
autonomous: true
must_haves:
  goal: "Migrate debug command preserving session persistence and multi-turn checkpoint pattern"
  truths:
    - File specs/skills/gsd-debug/SKILL.md exists with complete spec
    - Session persistence pattern preserved (file-based state in .planning/debug/)
    - Slug generation logic documented (converts issue description to filename)
    - Multi-question symptom gathering preserved (expected, actual, errors, timeline, reproduction)
    - Checkpoint continuation pattern working (resume from prior session)
    - @-reference to debug file for session state loading
    - Generated command installs to .claude/skills/ successfully
  artifacts:
    - specs/skills/gsd-debug/SKILL.md
    - .claude/skills/gsd-debug.md (generated output)
  wiring:
    - Frontmatter includes Task, Read, Write, Bash tools
    - Body contains session management logic and checkpoint handling
    - gsd-debugger agent spawning with session persistence
  key_links:
    - SKILL.md → install.js::generateSkillsFromSpecs → .claude/skills/gsd-debug.md
---

# Phase 4 Plan 03: Migrate debug Command

**Objective:** Migrate gsd-debug to spec format, preserving session persistence and multi-turn checkpoint patterns

## Context

The debug command (149 lines, 1 @-reference, 2 spawns) is Tier 2 complexity—more complex than research-phase due to session persistence and multi-question symptom gathering. It manages debug sessions across context resets using file-based state (.planning/debug/{slug}.md) and supports resuming existing sessions or starting new investigations.

**From Research (04-RESEARCH.md):**
- Pattern: File-based session persistence across context resets
- Spawns: gsd-debugger (initial + continuation if checkpoint)
- Complexity: Multi-question symptom gathering (5 AskUserQuestion calls)
- Persistence: .planning/debug/{slug}.md stores investigation state
- @-references: 1 (debug file for continuation context)
- Flags: None

**From Wave 1 learnings:**
- Checkpoint continuation pattern validated in research-phase (04-01)
- Parallel spawn pattern validated in map-codebase (04-02)
- Template system handles @-references correctly

**Why Wave 2:**
- Depends on Wave 1 checkpoint pattern validation (04-01)
- More complex than research-phase (session management + multi-question flow)
- Simpler than plan-phase (no verification loops, no flag matrix)
- Must complete before plan-phase which references debug

## Tasks

<task name="create-debug-spec-structure" type="auto">
  <files>specs/skills/gsd-debug/SKILL.md</files>
  <action>
Create folder-per-skill structure and SKILL.md frontmatter for gsd-debug.

```bash
# Create folder
mkdir -p specs/skills/gsd-debug

# Create SKILL.md with frontmatter
cat > specs/skills/gsd-debug/SKILL.md << 'EOF'
---
name: gsd-debug
description: Structured debugging workflow with session persistence and investigation tracking
skill_version: 1.9.1
requires_version: 1.9.0+
platforms:
  - claude
  - copilot
  - codex
tools:
  - name: task
    required: true
    reason: Spawn gsd-debugger agent for investigation
  - name: read
    required: true
    reason: Load existing debug sessions and project context
  - name: write
    required: true
    reason: Create debug session files for persistence
  - name: bash
    required: true
    reason: Session discovery, slug generation, file validation
  - name: ask_user_question
    required: true
    reason: Gather symptoms (expected, actual, errors, timeline, reproduction)
arguments:
  - name: issue
    type: string
    required: false
    description: Issue description (if omitted, shows active sessions for resume)
metadata:
  generated: {{generated}}
  platform: {{platform}}
  version: {{version}}
---
EOF

echo "✓ Created specs/skills/gsd-debug/SKILL.md with frontmatter"
```
  </action>
  <verify>
```bash
# Verify folder and file exist
[ -d "specs/skills/gsd-debug" ] && echo "✓ Folder exists"
[ -f "specs/skills/gsd-debug/SKILL.md" ] && echo "✓ SKILL.md exists"

# Verify frontmatter is valid YAML
node -e "
const fs = require('fs');
const yaml = require('js-yaml');
const content = fs.readFileSync('specs/skills/gsd-debug/SKILL.md', 'utf8');
const frontmatter = content.match(/^---\n([\s\S]+?)\n---/);
if (frontmatter) {
  const parsed = yaml.load(frontmatter[1]);
  console.log('✓ Frontmatter valid:', parsed.name);
  console.log('✓ Tools declared:', parsed.tools.length);
  console.log('✓ ask_user_question tool present:', !!parsed.tools.find(t => t.name === 'ask_user_question'));
} else {
  throw new Error('No frontmatter found');
}
"
```
  </verify>
  <done>Folder specs/skills/gsd-debug/ exists with valid SKILL.md frontmatter including ask_user_question tool</done>
</task>

<task name="migrate-debug-body" type="auto">
  <files>specs/skills/gsd-debug/SKILL.md</files>
  <action>
Migrate complete body content from legacy commands/gsd/debug.md to spec body.

**Critical preservation:**
1. Session discovery logic (check for active sessions in .planning/debug/)
2. Slug generation (convert issue description to filename-safe slug)
3. Multi-question symptom gathering (5 AskUserQuestion calls: expected, actual, errors, timeline, reproduction)
4. Session persistence pattern (write state to .planning/debug/{slug}.md)
5. Checkpoint continuation (respawn with @-reference to prior state)
6. Resume vs new issue routing

**Migration steps:**

```bash
# Extract body content from legacy (everything after frontmatter)
sed -n '/^---$/,/^---$/!p' commands/gsd/debug.md | tail -n +2 > /tmp/debug-body.md

# Append to SKILL.md (after frontmatter)
cat /tmp/debug-body.md >> specs/skills/gsd-debug/SKILL.md

echo "✓ Migrated body content from legacy command"
```

**Verify critical patterns preserved:**

```bash
echo ""
echo "=== Critical Pattern Verification ==="

# 1. Check session discovery (ls .planning/debug/*.md)
if grep -q "\.planning/debug/.*\.md" specs/skills/gsd-debug/SKILL.md; then
  echo "✓ Session discovery logic preserved"
else
  echo "⚠ Session discovery may be missing"
fi

# 2. Check slug generation logic
if grep -q "slug" specs/skills/gsd-debug/SKILL.md; then
  echo "✓ Slug generation logic present"
else
  echo "⚠ Slug generation missing"
fi

# 3. Check symptom gathering questions (should have 5: expected, actual, errors, timeline, reproduction)
symptom_count=$(grep -c -E "(expected|actual|errors|timeline|reproduction)" specs/skills/gsd-debug/SKILL.md || echo 0)
if [ "$symptom_count" -ge 5 ]; then
  echo "✓ Symptom gathering questions preserved ($symptom_count references)"
else
  echo "⚠ Symptom questions may be incomplete ($symptom_count found)"
fi

# 4. Check Task() spawn calls (should be 2: initial + continuation)
task_count=$(grep -c "Task(" specs/skills/gsd-debug/SKILL.md || echo 0)
if [ "$task_count" -ge 2 ]; then
  echo "✓ Task spawn calls preserved ($task_count found)"
else
  echo "⚠ Expected 2+ Task() calls, found $task_count"
fi

# 5. Check @-reference to debug file
if grep -q "@.*debug.*\.md" specs/skills/gsd-debug/SKILL.md; then
  echo "✓ @-reference to debug file preserved"
else
  echo "⚠ @-reference missing"
fi

# 6. Check checkpoint handling
if grep -q "CHECKPOINT REACHED" specs/skills/gsd-debug/SKILL.md; then
  echo "✓ Checkpoint handling preserved"
else
  echo "⚠ Checkpoint handling may be missing"
fi

# 7. Check gsd-debugger agent type
if grep -q "gsd-debugger" specs/skills/gsd-debug/SKILL.md; then
  echo "✓ Agent type gsd-debugger preserved"
else
  echo "✗ Agent type missing"
fi
```
  </action>
  <verify>
```bash
# Verify file structure
echo ""
echo "=== File Statistics ==="
wc -l specs/skills/gsd-debug/SKILL.md
echo ""

# Verify critical sections exist
echo "=== Critical Sections Check ==="
grep -c "<objective>" specs/skills/gsd-debug/SKILL.md | xargs -I {} echo "✓ <objective> sections: {}"
grep -c "<process>" specs/skills/gsd-debug/SKILL.md | xargs -I {} echo "✓ <process> sections: {}"
grep -c "Task(" specs/skills/gsd-debug/SKILL.md | xargs -I {} echo "✓ Task() calls: {}"
grep -c "@" specs/skills/gsd-debug/SKILL.md | xargs -I {} echo "✓ @-references: {}"
grep -c "AskUserQuestion" specs/skills/gsd-debug/SKILL.md | xargs -I {} echo "✓ AskUserQuestion calls: {}"

# Session persistence verification
echo ""
echo "=== Session Persistence Check ==="
if grep -q "\.planning/debug/" specs/skills/gsd-debug/SKILL.md; then
  echo "✓ Debug directory path present"
fi
if grep -q "slug" specs/skills/gsd-debug/SKILL.md; then
  echo "✓ Slug generation logic present"
fi
if grep -q "active.*session" specs/skills/gsd-debug/SKILL.md; then
  echo "✓ Active session logic present"
fi

# Compare line count with legacy
legacy_lines=$(wc -l < commands/gsd/debug.md)
spec_lines=$(wc -l < specs/skills/gsd-debug/SKILL.md)
echo ""
echo "Legacy: $legacy_lines lines"
echo "Spec: $spec_lines lines"
echo "Difference: $((spec_lines - legacy_lines)) lines (should be ~30-40 for frontmatter)"
```
  </verify>
  <done>Body content migrated with session persistence, slug generation, symptom gathering, and checkpoint continuation preserved</done>
</task>

<task name="generate-and-verify-debug" type="auto">
  <files>bin/install.js</files>
  <action>
Generate debug skill using template system and verify session management preserved.

```bash
# Run skill generation
echo "Generating gsd-debug skill..."
node bin/install.js --skills-only --platform claude 2>&1 | tee /tmp/debug-gen.log

# Check for errors
if grep -i "error" /tmp/debug-gen.log; then
  echo "✗ Generation errors found"
  exit 1
else
  echo "✓ Generation completed without errors"
fi

# Verify generated file exists
if [ -f ".claude/skills/gsd-debug.md" ]; then
  echo "✓ Generated file exists: .claude/skills/gsd-debug.md"
  wc -l .claude/skills/gsd-debug.md
else
  echo "✗ Generated file not found"
  exit 1
fi
```

**Session management validation:**

```bash
echo ""
echo "=== Session Management Validation ==="

# 1. Verify session discovery logic
if grep -q "\.planning/debug/.*\.md" .claude/skills/gsd-debug.md; then
  echo "✓ Session discovery in generated output"
else
  echo "✗ Session discovery missing"
fi

# 2. Verify slug generation
if grep -q "slug" .claude/skills/gsd-debug.md; then
  echo "✓ Slug generation in generated output"
else
  echo "✗ Slug generation missing"
fi

# 3. Verify symptom questions present
echo "Symptom questions in generated output:"
for symptom in expected actual errors timeline reproduction; do
  if grep -iq "$symptom" .claude/skills/gsd-debug.md; then
    echo "  ✓ $symptom"
  else
    echo "  ⚠ $symptom not found"
  fi
done

# 4. Verify Task() calls (should be 2)
task_count=$(grep -c "Task(" .claude/skills/gsd-debug.md || echo 0)
if [ "$task_count" -ge 2 ]; then
  echo "✓ Task() calls in generated output: $task_count"
else
  echo "✗ Expected 2+ Task() calls, found $task_count"
fi

# 5. Verify @-reference to debug file
if grep -q "@.*debug.*\.md" .claude/skills/gsd-debug.md; then
  echo "✓ @-reference to debug file in generated output"
else
  echo "✗ @-reference missing"
fi

# 6. Verify checkpoint pattern
if grep -q "CHECKPOINT REACHED" .claude/skills/gsd-debug.md; then
  echo "✓ Checkpoint pattern in generated output"
else
  echo "⚠ Checkpoint pattern may be missing"
fi

# 7. Verify agent type
debugger_count=$(grep -c "gsd-debugger" .claude/skills/gsd-debug.md || echo 0)
if [ "$debugger_count" -ge 2 ]; then
  echo "✓ Agent type gsd-debugger referenced $debugger_count times"
else
  echo "⚠ Agent type references: $debugger_count (expected 2+)"
fi

# 8. Compare line counts
spec_lines=$(wc -l < specs/skills/gsd-debug/SKILL.md)
gen_lines=$(wc -l < .claude/skills/gsd-debug.md)
diff=$((gen_lines - spec_lines))
if [ $diff -gt -50 ] && [ $diff -lt 50 ]; then
  echo "✓ Line count similar (spec: $spec_lines, gen: $gen_lines, diff: $diff)"
else
  echo "⚠ Line count differs significantly (diff: $diff lines)"
fi
```
  </action>
  <verify>
```bash
# Final verification summary
echo ""
echo "=== Migration Verification Summary ==="
echo ""
echo "Files created:"
ls -lh specs/skills/gsd-debug/SKILL.md
ls -lh .claude/skills/gsd-debug.md
echo ""

# Pattern preservation summary
echo "Pattern preservation:"
echo "  Task() spawns: $(grep -c 'Task(' .claude/skills/gsd-debug.md)"
echo "  @-references: $(grep -c '@' .claude/skills/gsd-debug.md)"
echo "  Checkpoint handling: $(grep -c 'CHECKPOINT REACHED' .claude/skills/gsd-debug.md) patterns"
echo "  Agent type: gsd-debugger ($(grep -c 'gsd-debugger' .claude/skills/gsd-debug.md) refs)"
echo ""

# Session persistence summary
echo "Session persistence:"
echo "  Debug directory refs: $(grep -c '.planning/debug' .claude/skills/gsd-debug.md)"
echo "  Slug logic: $(grep -c 'slug' .claude/skills/gsd-debug.md) references"
echo "  Symptom questions: $(grep -c -E '(expected|actual|errors|timeline|reproduction)' .claude/skills/gsd-debug.md) mentions"
echo ""

echo "✓ Migration complete - debug ready for testing"
```
  </verify>
  <done>Generated .claude/skills/gsd-debug.md validates session persistence and multi-turn checkpoint patterns</done>
</task>

## Success Criteria

**Phase 4 Success Criteria (subset for debug):**
- [x] Command debug migrated to spec format ✓
- [x] Subagent spawning (1-2 agents) works correctly ✓ (gsd-debugger: 2 spawns)
- [x] Argument handling preserved ✓ (optional issue argument)
- [x] Process subsections maintained in structure ✓
- [x] Embedded bash validation blocks preserved ✓

**Plan-specific verification:**
- [ ] Session persistence works (.planning/debug/{slug}.md created)
- [ ] Slug generation from issue description works
- [ ] Multi-question symptom gathering (5 questions) works
- [ ] Resume existing session works
- [ ] Checkpoint continuation with @-reference works
- [ ] Active session listing when no argument provided

## Output

```
Phase 4 Plan 03 — COMPLETE

Files created:
  • specs/skills/gsd-debug/SKILL.md (~190 lines)
  • .claude/skills/gsd-debug.md (generated)

Patterns preserved:
  ✓ Session persistence (.planning/debug/{slug}.md)
  ✓ Slug generation (issue → filename-safe slug)
  ✓ Multi-question symptom gathering (5 questions)
  ✓ Checkpoint continuation with @-reference to prior state
  ✓ Active session discovery and resume logic

Ready for:
  • Wave 3 begins with 04-04 (plan-phase - most complex)
  • Manual testing: /gsd:debug "server won't start"
  • Manual testing: /gsd:debug (resume existing session)
```
