---
phase: 04.1-installation-quality-copilot-spec-compliance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - specs/agents/gsd-codebase-mapper.md
  - specs/agents/gsd-planner.md
autonomous: true
must_haves:
  truths:
    - Agent prompt content uses platform-specific tool names
    - Claude agents reference "Bash tool", "Grep tool", "Glob tool"
    - Copilot agents reference "execute tool", "search tool"
    - Platform conditionals use Mustache syntax ({{#isClaude}}...{{/isClaude}})
  artifacts:
    - specs/agents/gsd-codebase-mapper.md with Mustache conditionals
    - specs/agents/gsd-planner.md with Mustache conditionals
  wiring:
    - Mustache conditionals render based on platform context (isClaude, isCopilot)
    - Tool references match output of mapTools() for that platform
  key_links:
    - isClaude context flag → Claude-specific content
    - isCopilot context flag → Copilot-specific content
    - Tool references → platform PRIMARY names
---

# Phase 04.1 Plan 02: Update Tool References in Agent Prompts

## Objective

Replace hardcoded tool references in agent prompt content with platform-specific names using Mustache conditionals.

## Context

**Problem:**
- Agent prompt content mentions "Bash tool", "Grep tool", "Glob tool"
- These are Claude names, but Copilot calls them "execute tool", "search tool"
- Generates confusion when Copilot users read "use the Bash tool" but only have "execute"

**Instances Found:**
1. `specs/agents/gsd-codebase-mapper.md:115` - "Grep tool: --exclude-dir"
2. `specs/agents/gsd-codebase-mapper.md:116` - "Glob tool: Verify results"
3. `specs/agents/gsd-codebase-mapper.md:117` - "Bash tool: Add -not -path"
4. `specs/agents/gsd-planner.md:594` - "use Bash tool"

**Solution:**
Use Mustache conditionals to render platform-specific tool names:

```markdown
{{#isClaude}}
Use the Bash tool to run commands.
The Grep tool searches code.
{{/isClaude}}
{{#isCopilot}}
Use the execute tool to run commands.
The search tool searches code.
{{/isCopilot}}
```

**Template Context:**
Generator provides `isClaude` and `isCopilot` boolean flags in context.

**Reference:**
- bin/lib/template-system/engine.js (Mustache rendering)
- bin/lib/template-system/context-builder.js (platform flags)

## Tasks

<task name="update-gsd-codebase-mapper-prompts" type="auto">
  <files>specs/agents/gsd-codebase-mapper.md</files>
  <action>
    Replace hardcoded tool references with Mustache conditionals in gsd-codebase-mapper.md.
    
    **Locate the exclusion verification section (lines ~115-117):**
    
    ```markdown
    **Verify exclusions work:**
    - Grep tool: `--exclude-dir={dirs from list}`
    - Glob tool: Verify results don't include excluded paths
    - Bash tool: Add `-not -path '*/DIR/*'` for each excluded dir
    ```
    
    **Replace with platform-specific conditionals:**
    
    ```markdown
    **Verify exclusions work:**
    {{#isClaude}}
    - Grep tool: `--exclude-dir={dirs from list}`
    - Glob tool: Verify results don't include excluded paths
    - Bash tool: Add `-not -path '*/DIR/*'` for each excluded dir
    {{/isClaude}}
    {{#isCopilot}}
    - search tool: `--exclude-dir={dirs from list}`
    - search tool: Verify results don't include excluded paths (note: search combines grep + glob)
    - execute tool: Add `-not -path '*/DIR/*'` for each excluded dir
    {{/isCopilot}}
    ```
    
    **Rationale:**
    - Copilot users see "search tool" (PRIMARY alias, deduplicated Grep+Glob)
    - Claude users see "Grep tool" and "Glob tool" (separate tools)
    - Execute vs Bash distinction clear
  </action>
  <verify>
    ```bash
    # Check conditionals exist
    grep -n "{{#isClaude}}" specs/agents/gsd-codebase-mapper.md
    grep -n "{{#isCopilot}}" specs/agents/gsd-codebase-mapper.md
    
    # Should find 1 pair of conditionals around line 115
    
    # Verify no hardcoded references remain
    grep -n "Grep tool\|Glob tool\|Bash tool" specs/agents/gsd-codebase-mapper.md
    
    # Should only find matches inside {{#isClaude}} blocks
    ```
  </verify>
  <done>gsd-codebase-mapper.md uses Mustache conditionals, tool references platform-specific</done>
</task>

<task name="update-gsd-planner-prompts" type="auto">
  <files>specs/agents/gsd-planner.md</files>
  <action>
    Replace hardcoded tool references with Mustache conditionals in gsd-planner.md.
    
    **Locate the checkpoint anti-patterns section (line ~594):**
    
    ```markdown
    **Bad - Asking human to automate:**
    ```xml
    <task type="checkpoint:human-action">
      <action>Deploy to Vercel</action>
      <instructions>Visit vercel.com, import repo, click deploy...</instructions>
    </task>
    ```
    Why bad: Vercel has a CLI. Claude should run `vercel --yes`.
    ```
    
    **Replace "Claude should run" with platform-agnostic:**
    
    ```markdown
    **Bad - Asking human to automate:**
    ```xml
    <task type="checkpoint:human-action">
      <action>Deploy to Vercel</action>
      <instructions>Visit vercel.com, import repo, click deploy...</instructions>
    </task>
    ```
    {{#isClaude}}
    Why bad: Vercel has a CLI. Claude should run `vercel --yes` using the Bash tool.
    {{/isClaude}}
    {{#isCopilot}}
    Why bad: Vercel has a CLI. Use the execute tool to run `vercel --yes`.
    {{/isCopilot}}
    ```
    
    **Additional references to update:**
    
    Search for other instances of "Bash tool", "use Bash", "using Bash":
    
    ```bash
    grep -n "Bash tool\|use Bash\|using Bash" specs/agents/gsd-planner.md
    ```
    
    Replace each with:
    ```markdown
    {{#isClaude}}using the Bash tool{{/isClaude}}{{#isCopilot}}using the execute tool{{/isCopilot}}
    ```
    
    Or for inline mentions:
    ```markdown
    {{#isClaude}}Bash{{/isClaude}}{{#isCopilot}}execute{{/isCopilot}} tool
    ```
  </action>
  <verify>
    ```bash
    # Check conditionals exist
    grep -n "{{#isClaude}}" specs/agents/gsd-planner.md
    grep -n "{{#isCopilot}}" specs/agents/gsd-planner.md
    
    # Should find at least 1 pair around line 594
    
    # Verify no bare "Bash tool" outside conditionals
    grep -n "Bash tool" specs/agents/gsd-planner.md | grep -v "{{#isClaude}}"
    
    # Should return empty (all inside conditionals)
    ```
  </verify>
  <done>gsd-planner.md uses Mustache conditionals, Bash/execute references platform-specific</done>
</task>

<task name="test-conditional-rendering" type="auto">
  <action>
    Test that Mustache conditionals render correctly for both platforms.
    
    **Generate test agents:**
    
    ```bash
    # Generate Claude version of gsd-codebase-mapper
    node -e "
    const { generateAgent } = require('./bin/lib/template-system/generator.js');
    const result = generateAgent('gsd-codebase-mapper', {
      platform: 'claude',
      outputDir: './test-output/claude/agents'
    });
    console.log('Claude:', result.success ? 'OK' : result.errors);
    "
    
    # Generate Copilot version
    node -e "
    const { generateAgent } = require('./bin/lib/template-system/generator.js');
    const result = generateAgent('gsd-codebase-mapper', {
      platform: 'copilot',
      outputDir: './test-output/copilot/agents'
    });
    console.log('Copilot:', result.success ? 'OK' : result.errors);
    "
    ```
    
    **Verify rendered output:**
    
    ```bash
    # Claude should have "Bash tool", "Grep tool", "Glob tool"
    grep "Bash tool" test-output/claude/agents/gsd-codebase-mapper.md
    grep "Grep tool" test-output/claude/agents/gsd-codebase-mapper.md
    
    # Copilot should have "execute tool", "search tool"
    grep "execute tool" test-output/copilot/agents/gsd-codebase-mapper.agent.md
    grep "search tool" test-output/copilot/agents/gsd-codebase-mapper.agent.md
    
    # Copilot should NOT have "Bash tool" or "Grep tool"
    ! grep "Bash tool" test-output/copilot/agents/gsd-codebase-mapper.agent.md
    ! grep "Grep tool" test-output/copilot/agents/gsd-codebase-mapper.agent.md
    ```
    
    Expected: Claude version has Claude names, Copilot version has Copilot names, no cross-contamination.
  </action>
  <verify>
    ```bash
    # Run generation test
    node -e "
    const { generateAgent } = require('./bin/lib/template-system/generator.js');
    
    // Generate both versions
    const claude = generateAgent('gsd-codebase-mapper', { platform: 'claude', outputDir: './test-output/claude/agents' });
    const copilot = generateAgent('gsd-codebase-mapper', { platform: 'copilot', outputDir: './test-output/copilot/agents' });
    
    const fs = require('fs');
    const claudeContent = fs.readFileSync('./test-output/claude/agents/gsd-codebase-mapper.md', 'utf8');
    const copilotContent = fs.readFileSync('./test-output/copilot/agents/gsd-codebase-mapper.agent.md', 'utf8');
    
    // Verify Claude has Claude names
    console.log('Claude has Bash tool:', claudeContent.includes('Bash tool'));
    console.log('Claude has Grep tool:', claudeContent.includes('Grep tool'));
    
    // Verify Copilot has Copilot names
    console.log('Copilot has execute tool:', copilotContent.includes('execute tool'));
    console.log('Copilot has search tool:', copilotContent.includes('search tool'));
    
    // Verify NO cross-contamination
    console.log('Copilot clean (no Bash):', !copilotContent.includes('Bash tool'));
    console.log('Copilot clean (no Grep):', !copilotContent.includes('Grep tool'));
    "
    
    # All checks should be true
    ```
  </verify>
  <done>Mustache conditionals render correctly, Claude/Copilot versions have correct tool names</done>
</task>

## Verification

**After all tasks complete:**

```bash
# 1. Check specs have conditionals
echo "=== Checking conditionals in specs ==="
grep -c "{{#isClaude}}" specs/agents/gsd-codebase-mapper.md
grep -c "{{#isCopilot}}" specs/agents/gsd-codebase-mapper.md
grep -c "{{#isClaude}}" specs/agents/gsd-planner.md
grep -c "{{#isCopilot}}" specs/agents/gsd-planner.md

# Expected: At least 1 of each per file

# 2. Generate both platform versions
echo "=== Generating agents ==="
mkdir -p test-output/claude/agents test-output/copilot/agents

node -e "
const { generateAgent } = require('./bin/lib/template-system/generator.js');
['gsd-codebase-mapper', 'gsd-planner'].forEach(agent => {
  generateAgent(agent, { platform: 'claude', outputDir: './test-output/claude/agents' });
  generateAgent(agent, { platform: 'copilot', outputDir: './test-output/copilot/agents' });
});
"

# 3. Verify platform-specific tool names
echo "=== Verifying Claude versions ==="
grep -c "Bash tool" test-output/claude/agents/gsd-codebase-mapper.md
grep -c "Grep tool" test-output/claude/agents/gsd-codebase-mapper.md

echo "=== Verifying Copilot versions ==="
grep -c "execute tool" test-output/copilot/agents/gsd-codebase-mapper.agent.md
grep -c "search tool" test-output/copilot/agents/gsd-codebase-mapper.agent.md

# 4. Verify no cross-contamination
echo "=== Checking no cross-contamination ==="
grep "Bash tool" test-output/copilot/agents/*.agent.md && echo "ERROR: Found Bash tool in Copilot" || echo "OK: No Bash tool in Copilot"
grep "execute tool" test-output/claude/agents/*.md | grep -v "agent.md" && echo "ERROR: Found execute tool in Claude" || echo "OK: No execute tool in Claude"
```

## Success Criteria

- [ ] gsd-codebase-mapper.md has Mustache conditionals for tool references
- [ ] gsd-planner.md has Mustache conditionals for tool references
- [ ] Claude-generated agents reference "Bash tool", "Grep tool", "Glob tool"
- [ ] Copilot-generated agents reference "execute tool", "search tool"
- [ ] No hardcoded tool names outside conditionals in specs
- [ ] No cross-contamination (Copilot agents don't mention "Bash tool")
- [ ] Generator test passes for both platforms

## Output

**Files Modified:**
- `specs/agents/gsd-codebase-mapper.md` - Mustache conditionals for Grep/Glob/Bash references
- `specs/agents/gsd-planner.md` - Mustache conditionals for Bash references

**Platform Rendering:**
- Claude agents: "Use the Bash tool...", "Grep tool...", "Glob tool..."
- Copilot agents: "Use the execute tool...", "search tool..." (deduplicated)

**Next:** Plan 03 will verify installation produces zero warnings.
