---
phase: 04.1-installation-quality-copilot-spec-compliance
plan: 01
subsystem: template-system
tags: [tool-mapper, field-transformer, copilot-compliance, PRIMARY-aliases, deduplication]

# Dependency graph
requires:
  - phase: 04-installation-workflow-integration
    provides: Installation integration with platform flags
provides:
  - Bidirectional tool name lookup (accepts any case/alias)
  - PRIMARY Copilot aliases (execute, edit, search, agent)
  - Grep+Glob deduplication to single 'search' on Copilot
  - Color field filtering for Copilot frontmatter
affects: [04.1-02-tool-references, 04.1-03-zero-warnings-validation]

# Tech tracking
tech-stack:
  added: []
  patterns: [REVERSE_TOOL_INDEX for bidirectional lookup, two-pass building for canonical precedence]

key-files:
  created: []
  modified: [bin/lib/template-system/tool-mapper.js, bin/lib/template-system/tool-mapper.test.js, bin/lib/template-system/field-transformer.js]

key-decisions:
  - "REVERSE_TOOL_INDEX maps all variants (uppercase, lowercase, aliases) to canonical names"
  - "Two-pass REVERSE_INDEX building: non-canonical first, canonical second for precedence"
  - "PRIMARY Copilot aliases: execute (not bash), edit (not write), search (not grep/glob), agent (not task)"
  - "Deduplication via Set for Copilot to handle Grep+Glob → search"
  - "Color field filtered from Copilot (not in official spec)"
  - "Case-insensitive lookup via toLowerCase() and toUpperCase() mappings"

patterns-established:
  - "REVERSE_INDEX pattern: ALL input variants → canonical → platform PRIMARY"
  - "Two-pass building: ensures canonical tools override non-canonical conflicts"
  - "Set-based deduplication for Copilot platform"

# Metrics
duration: 9min
completed: 2026-01-22
---

# Phase 04.1 Plan 01: Bidirectional Tool Mapper + Copilot PRIMARY Aliases Summary

**Tool mapper now accepts all name variants and outputs Copilot PRIMARY aliases with deduplication**

## Performance

- **Duration:** 9 min
- **Started:** 2026-01-22T09:37:22Z
- **Completed:** 2026-01-22T09:46:11Z
- **Tasks:** 3/3 (Task 2 merged into Task 1)
- **Files modified:** 3

## Accomplishments
- REVERSE_TOOL_INDEX provides bidirectional tool name lookup
- Accepts uppercase (Bash), lowercase (bash), and aliases (execute, shell)
- Outputs PRIMARY Copilot aliases (execute, edit, search, agent)
- Grep + Glob deduplicate to single 'search' on Copilot
- Color field filtered from Copilot frontmatter
- 34 new tests added (9 REVERSE_INDEX + 15 PRIMARY + 10 deduplication)
- All 63 tool-mapper tests passing (29 original + 34 new)
- All 20 field-transformer tests passing

## Task Commits

1. **Task 1: Create REVERSE_INDEX for bidirectional lookup** - `f09b883` (feat)
   - Create REVERSE_TOOL_INDEX mapping all variants to canonical names
   - Build index in two passes (non-canonical first, canonical second)
   - Update mapTools() to use REVERSE_INDEX for input resolution
   - Add case-insensitive lookup (toLowerCase, toUpperCase)
   - Update TOOL_COMPATIBILITY_MATRIX with PRIMARY Copilot aliases
   - Add Set-based deduplication for Copilot
   - Export REVERSE_TOOL_INDEX for testing

2. **Task 3: Filter color field for Copilot** - `13b6b55` (feat)
   - Add color field to FIELD_RULES (Claude: true, Copilot: false)
   - transformFields() now filters color for Copilot agents
   - Warning logged when color excluded from Copilot frontmatter

3. **Task 4: Update tool-mapper tests** - `3278060` (feat)
   - Add 9 REVERSE_TOOL_INDEX tests (bidirectional lookup, case-insensitive)
   - Add 15 PRIMARY alias tests (execute, edit, search, agent)
   - Add 10 deduplication tests (Grep+Glob → search)
   - Update 5 existing tests to expect PRIMARY aliases
   - Total: 63 tests passing (29 original + 34 new)

## Files Created/Modified
- `bin/lib/template-system/tool-mapper.js` - REVERSE_INDEX + PRIMARY aliases
  - REVERSE_TOOL_INDEX constant (two-pass building, 130 lines)
  - Updated TOOL_COMPATIBILITY_MATRIX (PRIMARY copilot names)
  - Updated mapTools() with REVERSE_INDEX lookup and deduplication
  - Fixed alias conflicts (Edit vs Write canonical tools)
  
- `bin/lib/template-system/tool-mapper.test.js` - 34 new tests
  - 9 REVERSE_TOOL_INDEX tests
  - 15 PRIMARY alias tests
  - 10 deduplication tests
  - 5 existing tests updated for PRIMARY aliases
  
- `bin/lib/template-system/field-transformer.js` - Color field rule
  - Added color field to FIELD_RULES
  - Claude: true (preserves color)
  - Copilot: false (filters color with warning)

## Decisions Made
- **REVERSE_TOOL_INDEX**: Bidirectional lookup accepts any variant (Bash, bash, execute, shell) → canonical
- **Two-pass building**: Non-canonical tools first, then canonical override to resolve Edit vs Write conflict
- **PRIMARY Copilot aliases**: Use official PRIMARY names (execute, edit, search, agent) not compatible aliases (bash, write, grep, task)
- **Deduplication via Set**: Both Grep and Glob map to 'search', deduplicate with `new Set()`
- **Color field filtering**: Not in Copilot official spec, filter with warning
- **Case-insensitive**: Add toLowerCase() and toUpperCase() variants for complete case-insensitivity

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Edit/Write canonical tool conflict**
- **Found during:** Task 1 - Building REVERSE_INDEX
- **Issue:** Both Edit and Write are canonical tools, but Write had Edit in aliases, causing Edit to map to Write
- **Fix:** Two-pass REVERSE_INDEX building (non-canonical first, canonical second) ensures canonical tools take precedence
- **Files modified:** bin/lib/template-system/tool-mapper.js
- **Commit:** f09b883

**2. [Rule 1 - Bug] Incomplete case-insensitive support**
- **Found during:** Task 4 - Testing REVERSE_INDEX
- **Issue:** Only lowercase variants added to index, uppercase (BASH, EXECUTE) returned undefined
- **Fix:** Add both toLowerCase() and toUpperCase() mappings for all variants
- **Files modified:** bin/lib/template-system/tool-mapper.js
- **Commit:** 3278060

**3. [Rule 1 - Bug] Test expectations for PRIMARY aliases**
- **Found during:** Task 4 - Running tests
- **Issue:** 5 existing tests expected compatible aliases (bash, task) instead of PRIMARY aliases (execute, agent)
- **Fix:** Updated test assertions to expect PRIMARY aliases
- **Files modified:** bin/lib/template-system/tool-mapper.test.js
- **Commit:** 3278060

## Next Phase Readiness

**Phase 04.1 Plan 02: Update Tool References in Prompts**
- ✅ Tool mapper accepts all variants (uppercase, lowercase, aliases)
- ✅ Tool mapper outputs PRIMARY Copilot aliases
- ✅ Deduplication working (Grep+Glob → search)
- ✅ Color field filtered for Copilot
- ✅ Ready for prompt content updates with Mustache conditionals

**Verification:**
- 63/63 tool-mapper tests passing
- 20/20 field-transformer tests passing
- End-to-end verification: lowercase input → PRIMARY output
- Deduplication verified: ['Grep', 'Glob'] → ['search']
- Color filtering verified: Copilot removes with warning

## Technical Notes

**REVERSE_TOOL_INDEX Architecture:**
- Maps ALL variants (canonical, platform names, aliases, any case) to canonical name
- Two-pass building ensures canonical tools override non-canonical in conflicts
- Example: 'edit' (lowercase) → 'Edit' (canonical), not 'Write' (non-canonical)

**PRIMARY vs Compatible Aliases:**
- PRIMARY: Official names from Copilot docs (execute, edit, search, agent)
- Compatible: Backward-compatible aliases (bash, write, grep, task)
- We use PRIMARY for spec compliance

**Deduplication Strategy:**
- Only applies to Copilot (Claude keeps both Grep and Glob)
- Uses `new Set(mapped)` to remove duplicates after mapping
- Preserves first occurrence order

**Test Coverage:**
- 29 original tests (unchanged logic)
- 34 new tests:
  - 9 REVERSE_INDEX (bidirectional, case-insensitive)
  - 15 PRIMARY aliases (execute, edit, search, agent)
  - 10 deduplication (Grep+Glob, order preservation)
- 5 updated tests (PRIMARY alias expectations)
- Total: 63 tool-mapper + 20 field-transformer = 83 tests passing
