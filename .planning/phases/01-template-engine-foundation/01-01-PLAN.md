---
phase: 01-template-engine-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - bin/lib/template-system/spec-parser.js
autonomous: true

must_haves:
  truths:
    - "Dependencies gray-matter and js-yaml are installed"
    - "Spec parser extracts YAML frontmatter and markdown body"
    - "Parser handles errors gracefully with helpful messages"
  artifacts:
    - path: "package.json"
      contains: "gray-matter"
      provides: "Template system dependencies"
    - path: "bin/lib/template-system/spec-parser.js"
      provides: "YAML frontmatter parsing"
      exports: ["parseSpec"]
      min_lines: 50
  key_links:
    - from: "bin/lib/template-system/spec-parser.js"
      to: "gray-matter"
      via: "require and matter.read()"
      pattern: "matter\\.read\\("
---

<objective>
Install template system dependencies and create the spec parser module that extracts YAML frontmatter and markdown body from agent spec files.

Purpose: Foundation for template-based agent generation. Without robust parsing, the entire template system fails.

Output: Working spec-parser module with gray-matter and js-yaml installed.
</objective>

<execution_context>
@.github/skills/get-shit-done/get-shit-done/workflows/execute-plan.md
@.github/skills/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@.planning/research/ARCHITECTURE.md
@.planning/research/STACK.md

# Existing codebase structure
@bin/install.js
@bin/lib/adapters/claude.js
@bin/lib/adapters/copilot.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Install template system dependencies</name>
  <files>package.json, package-lock.json</files>
  <action>
Install gray-matter and js-yaml as production dependencies:

```bash
npm install gray-matter@^4.0.3 js-yaml@^4.1.1 --save
```

These versions are specified in research/STACK.md as battle-tested and actively maintained.

**Why these versions:**
- gray-matter@^4.0.3: Industry standard for frontmatter parsing, handles edge cases regex parsers miss
- js-yaml@^4.1.1: YAML serialization library (updated Nov 2025), needed for writing valid YAML with proper escaping

**Do NOT install:**
- mustache (optional, only if complexity grows beyond template literals)
- front-matter package (deprecated, gray-matter is the successor)
- Build-step template engines (Nunjucks, Pug - violates "no build step" constraint)
  </action>
  <verify>
```bash
npm list gray-matter js-yaml
```
Both should appear in dependency tree with correct versions.
  </verify>
  <done>
package.json contains gray-matter@^4.0.3 and js-yaml@^4.1.1 in dependencies section. node_modules populated.
  </done>
</task>

<task type="auto">
  <name>Create template-system directory and spec-parser module</name>
  <files>bin/lib/template-system/spec-parser.js</files>
  <action>
Create `bin/lib/template-system/` directory and implement spec-parser.js:

**Directory structure:**
```bash
mkdir -p bin/lib/template-system
```

**Module implementation (spec-parser.js):**

The module must:
1. Use gray-matter to parse spec files (YAML frontmatter + markdown body)
2. Return structured object: `{frontmatter, body, path}`
3. Provide helpful error messages with file path and line number on parse failures
4. Handle both file path and string content input
5. Export CommonJS (project uses `"type": "commonjs"`)

**Key requirements from research:**
- Use `matter.read(filePath)` for file input → returns {data, content}
- Use `matter(stringContent)` for string input
- Wrap in try/catch to provide context on parsing errors
- Extract line numbers from gray-matter error objects when available
- Return null or throw descriptive error (decide on error strategy)

**Error handling pattern:**
When gray-matter fails, it provides error.mark.line. Extract this and include file path for actionable errors: "Failed to parse YAML frontmatter in [path] at line [N]: [message]"

**Exports:**
- `parseSpec(filePath)` - primary function
- `parseSpecString(content, sourcePath)` - for testing/advanced use

**Do NOT:**
- Use regex for frontmatter extraction (unreliable)
- Return raw gray-matter output without normalization
- Swallow parse errors silently
  </action>
  <verify>
```bash
# Verify file exists and has correct structure
node -e "const parser = require('./bin/lib/template-system/spec-parser'); console.log(typeof parser.parseSpec)"
```
Should output "function"

Create a test spec file and verify parsing:
```bash
cat > /tmp/test-spec.md << 'EOF'
---
name: test-agent
description: Test agent
tools: ['Bash', 'Read']
---

# Test Agent

This is test content.
EOF

node -e "
const {parseSpec} = require('./bin/lib/template-system/spec-parser');
const result = parseSpec('/tmp/test-spec.md');
console.log('frontmatter:', result.frontmatter);
console.log('body length:', result.body.length);
"
```
Should output parsed frontmatter object and body text.
  </verify>
  <done>
bin/lib/template-system/spec-parser.js exists with parseSpec and parseSpecString exports. Module successfully parses YAML frontmatter and markdown body. Error handling provides file path and line numbers.
  </done>
</task>

<task type="auto">
  <name>Add basic unit tests for spec-parser</name>
  <files>bin/lib/template-system/spec-parser.test.js</files>
  <action>
Create basic unit tests to verify spec-parser functionality:

**Test cases:**
1. **Valid spec with frontmatter and body** - Returns {frontmatter, body} correctly
2. **Invalid YAML frontmatter** - Throws error with line number
3. **Missing frontmatter delimiters** - Handles gracefully
4. **Empty file** - Returns appropriate structure
5. **File not found** - Throws descriptive error with path

**Test structure:**
```javascript
const assert = require('assert');
const {parseSpec, parseSpecString} = require('./spec-parser');
const fs = require('fs');
const path = require('path');
const os = require('os');

// Create temp directory for test files
const testDir = path.join(os.tmpdir(), 'spec-parser-tests');

// Test cases...
```

**Run tests:**
```bash
node bin/lib/template-system/spec-parser.test.js
```

**Do NOT:**
- Use external test frameworks (project has no test dependencies)
- Skip edge case testing (empty files, malformed YAML)
- Use Jest/Mocha (not in package.json dependencies)

Use Node.js built-in `assert` module for simple assertion-based tests.
  </action>
  <verify>
```bash
node bin/lib/template-system/spec-parser.test.js
```
All tests should pass with no assertion errors.
  </verify>
  <done>
spec-parser.test.js exists with 5+ test cases. Running the test file produces "All tests passed" output with no assertion failures.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Dependencies installed:**
   ```bash
   npm list gray-matter js-yaml | grep -E "(gray-matter|js-yaml)"
   ```

2. **Module structure:**
   ```bash
   ls -la bin/lib/template-system/spec-parser.js
   ```

3. **Module exports:**
   ```bash
   node -e "const p = require('./bin/lib/template-system/spec-parser'); console.log(Object.keys(p))"
   ```
   Should show: `['parseSpec', 'parseSpecString']`

4. **Parse actual agent file:**
   ```bash
   node -e "
   const {parseSpec} = require('./bin/lib/template-system/spec-parser');
   const result = parseSpec('./agents/gsd-planner.md');
   console.log('Name:', result.frontmatter.name);
   console.log('Has body:', result.body.length > 0);
   "
   ```

5. **Tests pass:**
   ```bash
   node bin/lib/template-system/spec-parser.test.js && echo "✓ Tests passed"
   ```
</verification>

<success_criteria>
1. ✅ package.json contains gray-matter@^4.0.3 and js-yaml@^4.1.1
2. ✅ bin/lib/template-system/spec-parser.js exists and exports parseSpec function
3. ✅ Parser successfully extracts YAML frontmatter and markdown body from test files
4. ✅ Error messages include file path and line numbers when parsing fails
5. ✅ Unit tests verify parsing behavior for valid and invalid inputs
6. ✅ Module uses CommonJS require() syntax (not ES modules)
</success_criteria>

<output>
After completion, create `.planning/phases/01-template-engine-foundation/01-01-SUMMARY.md` documenting:
- Dependencies installed (versions)
- spec-parser.js implementation approach
- Test coverage
- Any edge cases discovered
- Integration notes for next plans
</output>
