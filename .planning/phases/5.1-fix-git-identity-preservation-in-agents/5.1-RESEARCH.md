# Phase 5.1: Fix git identity preservation in agents - Research

**Researched:** 2025-01-23
**Domain:** Git identity management in automated agents
**Confidence:** HIGH

## Summary

Git identity preservation is critical for automated agents that make commits. The issue: GitHub Copilot CLI automatically uses an agent's `name` field from frontmatter as the git commit author, overriding user identity. This results in commits attributed to "GSD Debugger" instead of the actual user.

**Root cause:** Copilot platform behavior - converts agent name (e.g., "gsd-debugger") to title case ("GSD Debugger") and uses it as git author with email `{name}@localhost`. This happens at the platform level, not in GSD code.

**Solution:** Use git environment variables (`GIT_AUTHOR_NAME`, `GIT_AUTHOR_EMAIL`, etc.) which have highest precedence and override Copilot's name-based behavior. Combined with config.json storage of user identity, this preserves user authorship across all commits while maintaining full automation.

**Primary recommendation:** Implement git identity collection during `/gsd:new-project` setup, store in config.json, and update all agents to use environment variables when committing.

## Standard Stack

Git identity management uses built-in git features - no external libraries needed.

### Core
| Tool | Version | Purpose | Why Standard |
|------|---------|---------|--------------|
| git config | git 2.0+ | Read user identity | Universal, cross-platform, respects hierarchy |
| Environment variables | bash standard | Override git identity | Highest precedence, works on all platforms |
| JSON config | native | Store identity fallback | Simple, no dependencies |

### Supporting
| Tool | Version | Purpose | When to Use |
|------|---------|---------|-------------|
| jq | 1.5+ | Parse JSON reliably | If available; graceful fallback to grep |
| git rev-parse | git 2.0+ | Validate git repo | Before any git operations |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Environment variables | git config --local | Lower precedence, Copilot may still override |
| Environment variables | --author flag | Only sets author, not committer (inconsistent) |
| Automated commits | Manual commit instructions | Breaks automation, poor UX |
| config.json storage | git config only | Fails if user hasn't configured git globally |

**Installation:**
No installation needed - uses git built-ins and bash.

## Architecture Patterns

### Recommended Configuration Structure

```
.planning/
├── config.json          # Includes git identity
│   └── git:
│       ├── author:
│       │   ├── name: "User Name"
│       │   └── email: "user@example.com"
│       └── source: "config|global|local"
└── ...
```

### Pattern 1: Identity Collection During Setup
**What:** Ask for git identity during `/gsd:new-project` if not already configured
**When to use:** First-time project initialization
**Example:**
```bash
# Check if git config exists
GIT_NAME=$(git config user.name 2>/dev/null)
GIT_EMAIL=$(git config user.email 2>/dev/null)

if [ -z "$GIT_NAME" ] || [ -z "$GIT_EMAIL" ]; then
    # Prompt user via AskUserQuestion
    echo "Git identity not configured. Please provide:"
    # ... store in config.json
fi
```

### Pattern 2: Read Identity from Config Hierarchy
**What:** Try git config first, fallback to config.json
**When to use:** Every agent that makes commits
**Example:**
```bash
# Read with fallback chain
read_git_identity() {
    local name email
    
    # Try git config (respects global/local hierarchy)
    name=$(git config user.name 2>/dev/null)
    email=$(git config user.email 2>/dev/null)
    
    # Fallback to project config.json
    if [ -z "$name" ] || [ -z "$email" ]; then
        if [ -f .planning/config.json ]; then
            # Simple grep-based extraction (no jq dependency)
            name=$(grep -A 2 '"git"' .planning/config.json | grep '"name"' | cut -d'"' -f4)
            email=$(grep -A 2 '"author"' .planning/config.json | grep '"email"' | cut -d'"' -f4)
        fi
    fi
    
    echo "$name"
    echo "$email"
}
```

### Pattern 3: Commit with User Identity
**What:** Set environment variables before every git commit
**When to use:** All agents making commits (executor, planner, debugger, researcher, synthesizer)
**Example:**
```bash
# Commit preserving user identity
commit_with_identity() {
    local commit_msg="$1"
    
    # Read identity (using pattern 2)
    read -r GIT_NAME GIT_EMAIL < <(read_git_identity)
    
    # Validate identity exists
    if [ -z "$GIT_NAME" ] || [ -z "$GIT_EMAIL" ]; then
        echo "ERROR: Git identity not configured. Run /gsd:new-project or set git config."
        return 1
    fi
    
    # Set all four environment variables (author + committer)
    GIT_AUTHOR_NAME="$GIT_NAME" \
    GIT_AUTHOR_EMAIL="$GIT_EMAIL" \
    GIT_COMMITTER_NAME="$GIT_NAME" \
    GIT_COMMITTER_EMAIL="$GIT_EMAIL" \
    git commit -m "$commit_msg"
    
    # Check commit succeeded
    if [ $? -ne 0 ]; then
        echo "ERROR: Git commit failed"
        return 1
    fi
}

# Usage in agents:
git add file.txt
commit_with_identity "feat(01-02): implement authentication"
```

### Pattern 4: Config.json Schema Extension
**What:** Add git section to config.json
**When to use:** During project initialization (Phase 5)
**Example:**
```json
{
  "mode": "YOLO",
  "depth": "Comprehensive",
  "parallelization": "enabled",
  "git": {
    "author": {
      "name": "Lex Christopherson",
      "email": "lex@glittercowboy.com"
    },
    "source": "global"
  },
  "created": "2025-01-23",
  "project": "My Project"
}
```

### Anti-Patterns to Avoid

- **Modifying git config globally:** NEVER run `git config --global user.name "Bot"` - permanently changes user's identity for ALL repos
- **Using --author flag alone:** Only sets author, not committer (shows mixed identity in git log)
- **Assuming config exists:** Always check and provide fallback or error
- **Complex JSON parsing in bash:** Avoid fragile sed/awk chains; use simple grep or jq
- **Silent commit failures:** Always check exit codes and fail loudly
- **Platform-specific code:** Use standard bash syntax (works in Git Bash on Windows)

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| JSON parsing in bash | Complex sed/awk/cut chains | jq (if available) or simple grep on known structure | JSON edge cases: escaped quotes, nested objects, whitespace |
| Git identity validation | Custom regex for emails | Basic check (contains @) + let git validate | Git has robust validation; don't duplicate |
| Environment variable passing | Wrapper scripts or custom tools | Standard bash `VAR=value command` | Universal, no dependencies, works everywhere |
| Config merging | Manual file manipulation | Read-modify-write with atomic operations | Race conditions, corrupted JSON |

**Key insight:** Git's environment variable system is designed exactly for this use case. Don't build custom wrappers - use the built-in mechanism.

## Common Pitfalls

### Pitfall 1: Copilot Name Field Override
**What goes wrong:** Having `name:` field in agent frontmatter causes Copilot to use agent name as git author
**Why it happens:** Copilot platform automatically converts agent name to title case and uses as commit author (`gsd-debugger` → `GSD Debugger <gsd-debugger@localhost>`)
**How to avoid:** Can't remove name (required for agent identification). Must use `GIT_AUTHOR_*` and `GIT_COMMITTER_*` environment variables which have higher precedence
**Warning signs:** Commits in git log show "GSD Debugger", "GSD Executor", etc. instead of user names

### Pitfall 2: Only Setting Author Variables
**What goes wrong:** Setting `GIT_AUTHOR_NAME/EMAIL` but not `GIT_COMMITTER_NAME/EMAIL`
**Why it happens:** Developers forget git tracks both author and committer separately
**How to avoid:** Always set all four variables together:
```bash
GIT_AUTHOR_NAME="$name" \
GIT_AUTHOR_EMAIL="$email" \
GIT_COMMITTER_NAME="$name" \
GIT_COMMITTER_EMAIL="$email" \
git commit -m "message"
```
**Warning signs:** `git log --format="%an vs %cn"` shows different author and committer

### Pitfall 3: Modifying User's Global Git Config
**What goes wrong:** Running `git config --global user.name "Bot Name"` to "fix" identity
**Why it happens:** Seems like the "proper" way to set git identity
**How to avoid:** NEVER modify git config in agents. Only READ config. Use environment variables to override
**Warning signs:** User's other repos suddenly have wrong author on commits

### Pitfall 4: Assuming Git Config Exists
**What goes wrong:** Code assumes `git config user.name` returns a value
**Why it happens:** Developers test in environments where they've already configured git
**How to avoid:** Always check for empty result and provide fallback (config.json) or error message
**Warning signs:** Commits with fallback identity like `username@hostname` or command failures

### Pitfall 5: Fragile JSON Parsing
**What goes wrong:** Using `cat config.json | grep '"name"' | cut -d'"' -f4` breaks on formatting changes
**Why it happens:** JSON parsing in bash is non-trivial; quick hacks are tempting
**How to avoid:** Use jq if available, or limit grep-based parsing to simple, well-known structures. Document JSON format requirements.
**Warning signs:** Extraction fails when JSON is reformatted, keys reordered, or nested differently

### Pitfall 6: Silent Commit Failures
**What goes wrong:** `git commit` fails (no identity, conflicts, etc.) but agent continues
**Why it happens:** Not checking exit codes; assuming commits always succeed
**How to avoid:** Check `$?` after every commit; fail task loudly if commit fails
**Warning signs:** Agent reports success but work isn't in git history; "ghost commits"

### Pitfall 7: Cross-Platform Path Issues
**What goes wrong:** Hardcoded paths like `~/.gitconfig` fail on Windows
**Why it happens:** Different conventions (Windows: `%USERPROFILE%\.gitconfig`, Unix: `~/.gitconfig`)
**How to avoid:** Use `git config` command (handles paths cross-platform) instead of direct file access
**Warning signs:** Commands work on Mac/Linux but fail on Windows or Git Bash

## Code Examples

Verified patterns from git documentation and testing:

### Reading Git Identity Safely
```bash
# Source: git-config(1) documentation, tested 2025-01-23

# Check if identity is configured
has_git_identity() {
    git config user.name >/dev/null 2>&1 && \
    git config user.email >/dev/null 2>&1
}

# Read with validation
read_git_identity() {
    local name email
    
    # Try git config (respects global → local hierarchy)
    name=$(git config user.name 2>/dev/null)
    email=$(git config user.email 2>/dev/null)
    
    if [ -z "$name" ] || [ -z "$email" ]; then
        # Fallback to config.json
        if [ -f .planning/config.json ]; then
            # Simple extraction for known structure
            name=$(grep -A 3 '"git"' .planning/config.json | \
                   grep '"name"' | cut -d'"' -f4)
            email=$(grep -A 4 '"git"' .planning/config.json | \
                    grep '"email"' | cut -d'"' -f4)
        fi
    fi
    
    # Validate results
    if [ -z "$name" ] || [ -z "$email" ] || [ ! "$email" =~ "@" ]; then
        echo "ERROR: Valid git identity not found" >&2
        return 1
    fi
    
    echo "$name"
    echo "$email"
}
```

### Committing with User Identity
```bash
# Source: git-commit(1) environment variables documentation, tested 2025-01-23

# Safe commit that preserves user identity
commit_as_user() {
    local commit_message="$1"
    
    # Read identity
    local identity_result
    identity_result=$(read_git_identity) || {
        echo "Cannot commit: Git identity not configured"
        echo "Please run: git config --global user.name 'Your Name'"
        echo "           git config --global user.email 'you@example.com'"
        return 1
    }
    
    # Parse results (bash read builtin handles newlines)
    local git_name git_email
    read -r git_name git_email <<< "$identity_result"
    
    # Commit with identity override (highest precedence)
    GIT_AUTHOR_NAME="$git_name" \
    GIT_AUTHOR_EMAIL="$git_email" \
    GIT_COMMITTER_NAME="$git_name" \
    GIT_COMMITTER_EMAIL="$git_email" \
    git commit -m "$commit_message"
    
    local exit_code=$?
    if [ $exit_code -ne 0 ]; then
        echo "ERROR: git commit failed with exit code $exit_code" >&2
        return $exit_code
    fi
    
    return 0
}

# Usage example in agents:
git add src/feature.ts
commit_as_user "feat(01-02): implement user authentication

- Add JWT token validation
- Implement password hashing
- Add session management"
```

### Config.json Git Section
```json
{
  "mode": "YOLO",
  "depth": "Comprehensive",
  "parallelization": "enabled",
  "git": {
    "author": {
      "name": "User Name",
      "email": "user@example.com"
    },
    "source": "global"
  },
  "created": "2025-01-23",
  "project": "Project Name",
  "version": "1.9.1"
}
```

### Setup Questions in gsd-new-project
```markdown
## Phase 5.5: Git Identity Configuration

**Check if git is configured:**

```bash
GIT_NAME=$(git config user.name 2>/dev/null)
GIT_EMAIL=$(git config user.email 2>/dev/null)
```

**If not configured**, use AskUserQuestion:

- header: "Git Identity"
- question: "Git user information is needed for commit attribution. How would you like to proceed?"
- options:
  - "Configure git globally" — I'll set it in git config (recommended)
  - "Store in project only" — Keep in .planning/config.json for this project
  - "I already configured it" — Skip this step

**If "Configure git globally":**
- Provide instructions:
  ```bash
  git config --global user.name "Your Name"
  git config --global user.email "you@example.com"
  ```
- Wait for user confirmation they've completed it
- Verify: re-check git config
- Store source as "global" in config.json

**If "Store in project only":**
- Ask for name (freeform text input)
- Ask for email (freeform text input)
- Validate email contains @ symbol
- Store in config.json git section
- Store source as "config"

**If "I already configured it":**
- Verify git config returns values
- If verified: store source as "global" in config.json
- If not verified: show error, loop back to question
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Agents stop making commits | Agents commit with user identity | 2025-01 | Restores automation while preserving authorship |
| Bare `git commit` commands | Environment variable override | 2025-01 | Works around Copilot name-based override |
| No identity collection | Setup questions in new-project | 2025-01 | Ensures identity available before first commit |
| Global config assumption | Config.json fallback | 2025-01 | Works for users who haven't configured git globally |

**Deprecated/outdated:**
- **Removing commits from agents**: Previous fix (commit 00fddb1, 2024-12-16) removed debugger commits entirely. This is WRONG - breaks automation. Revert and use identity preservation instead.
- **Agent name in commits**: 261 commits by "GSD Debugger" instead of actual users. Must be cleaned up in git history (optional, cosmetic).

## Open Questions

1. **Git history cleanup**
   - What we know: 261 commits attributed to "GSD Debugger" exist in history
   - What's unclear: Should we rewrite git history to fix these, or leave as historical artifact?
   - Recommendation: Leave history as-is (rewriting is risky). New commits will have correct identity. Document in CHANGELOG.

2. **Parallel agent identity handling**
   - What we know: Multiple agents can run in parallel and all need identity
   - What's unclear: Race conditions when reading config.json simultaneously?
   - Recommendation: Read-only operations are safe (no locking needed). If config.json write during parallel execution, use atomic writes (write to temp, then rename).

3. **Identity validation depth**
   - What we know: Basic validation (non-empty, contains @) is sufficient
   - What's unclear: Should we validate email format more strictly? Validate name doesn't contain special chars?
   - Recommendation: Keep validation minimal. Git's own validation will catch invalid formats. Let users control their identity format.

4. **Windows Git Bash compatibility**
   - What we know: Standard bash env var syntax should work
   - What's unclear: Any edge cases in Git Bash on Windows?
   - Recommendation: Test on Windows during implementation. Bash syntax is universal, but verify.

## Sources

### Primary (HIGH confidence)
- Git documentation: git-config(1), git-commit(1) - https://git-scm.com/docs
  - Environment variables: GIT_AUTHOR_NAME, GIT_AUTHOR_EMAIL, GIT_COMMITTER_NAME, GIT_COMMITTER_EMAIL
  - Config hierarchy: system → global → local → worktree
  - Tested: 2025-01-23 in sandbox environment
- Debug file: `.planning/debug/resolved/unauthorized-git-config-changes.md`
  - Root cause analysis of Copilot name-based override
  - Evidence: 261 commits by "GSD Debugger", agent names matching git authors
- Git history analysis: `git log --format="%an <%ae>" | sort | uniq -c`
  - Confirmed: GSD Debugger <gsd-debugger@localhost> (261 commits)
  - Confirmed: Lex Christopherson <lex@glittercowboy.com> (505 commits)

### Secondary (MEDIUM confidence)
- GitHub Copilot CLI behavior: Observed through session logs
  - Platform uses agent `name` field as commit author
  - Converts to title case (gsd-debugger → GSD Debugger)
  - Generates email as {name}@localhost
- Bash environment variable testing: /tmp/test_env_override.sh
  - Confirmed: Env vars override git config
  - Confirmed: All four variables (AUTHOR + COMMITTER) needed

### Tertiary (LOW confidence)
- Cross-platform compatibility: Assumed based on git documentation
  - Needs testing: Windows Git Bash behavior
  - Needs testing: Special characters in names/emails

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Using git built-ins, well-documented
- Architecture: HIGH - Patterns tested in sandbox, verified with git
- Pitfalls: HIGH - Based on real issues found (261 wrong commits) and common git mistakes
- Cross-platform: MEDIUM - Linux/macOS verified, Windows needs testing

**Research date:** 2025-01-23
**Valid until:** 2025-02-23 (30 days - stable domain, git hasn't changed core behavior in years)

**Affects:**
- Phase 5 (new-project): Add git identity questions
- gsd-new-project skill: Collect and store git identity  
- Template: config.json schema extension
- Agents (6 total): gsd-debugger, gsd-executor, gsd-planner, gsd-phase-researcher, gsd-research-synthesizer, gsd-verifier
- Agent specs (6 total): Update all commit commands to use identity preservation pattern
