---
phase: 06.2-installation-output-verification-bug-fixes
plan: 02
type: execute
wave: 2
depends_on: [06.2-01]
files_modified:
  - bin/lib/platforms/claude-adapter.js
  - bin/lib/platforms/copilot-adapter.js
  - bin/lib/platforms/codex-adapter.js
  - bin/lib/installer/orchestrator.js
autonomous: true
must_haves:
  - type: behavioral
    truths:
      - "Claude agents include `skills` field in frontmatter with all referenced skills"
      - "Copilot agents exclude `skills` field from frontmatter"
      - "Codex agents exclude `skills` field from frontmatter"
      - "Agent frontmatter uses custom serializer for correct format"
  - type: artifact
    files:
      - bin/lib/platforms/claude-adapter.js (with transformFrontmatter implementation)
      - bin/lib/platforms/copilot-adapter.js (with transformFrontmatter using custom serializer)
      - bin/lib/platforms/codex-adapter.js (with transformFrontmatter using custom serializer)
      - bin/lib/installer/orchestrator.js (calls adapter.transformFrontmatter in installAgents)
  - type: integration
    key_links:
      - "orchestrator.installAgents() calls adapter.transformFrontmatter() for each agent"
      - "ClaudeAdapter adds skills field extracted from agent content"
      - "CopilotAdapter/CodexAdapter use serializeFrontmatter() for correct format"
      - "Agent files written with transformed frontmatter"
---

# Plan 06.2-02: Fix Agent Frontmatter Transformation Pipeline

**Objective:** Integrate `adapter.transformFrontmatter()` into agent installation pipeline to fix platform-specific frontmatter bugs

**Context:** Currently agents are installed without platform-specific frontmatter transformation. This causes:
1. Claude agents missing `skills` field (breaks skill pre-loading)
2. Copilot/Codex agents incorrectly including `skills` field (undefined in their spec)
3. Wrong tools format for Copilot/Codex (multi-line instead of single-line arrays)

The custom serializer from 06.2-01 provides the formatting foundation. This plan wires it into the installation pipeline.

## Tasks

<task name="implement-adapter-transformFrontmatter" type="auto">
  <files>
    bin/lib/platforms/claude-adapter.js
    bin/lib/platforms/copilot-adapter.js
    bin/lib/platforms/codex-adapter.js
  </files>
  <action>
    Implement `transformFrontmatter(content)` method in each adapter:

    **1. ClaudeAdapter (`claude-adapter.js`):**
    
    ```javascript
    import matter from 'gray-matter';
    
    /**
     * Transform agent frontmatter for Claude platform
     * @param {string} content - Agent file content with frontmatter
     * @returns {string} Transformed content with Claude-specific frontmatter
     */
    transformFrontmatter(content) {
      const { data, content: body } = matter(content);
      
      // Extract skills from agent content if not already present
      if (!data.skills) {
        const skillReferences = this.extractSkillReferences(body);
        if (skillReferences.length > 0) {
          data.skills = skillReferences;
        }
      }
      
      // Use gray-matter to serialize (Claude supports standard YAML)
      return matter.stringify(body, data);
    }
    
    /**
     * Extract skill references from agent content
     * @param {string} content - Agent body content
     * @returns {string[]} Array of skill names
     */
    extractSkillReferences(content) {
      const skills = new Set();
      
      // Match /gsd-* patterns
      const matches = content.matchAll(/\/gsd-([a-z-]+)/g);
      for (const match of matches) {
        skills.add(`gsd-${match[1]}`);
      }
      
      return Array.from(skills).sort();
    }
    ```

    **2. CopilotAdapter (`copilot-adapter.js`):**
    
    ```javascript
    import matter from 'gray-matter';
    import { serializeFrontmatter } from '../rendering/frontmatter-serializer.js';
    
    /**
     * Transform agent frontmatter for Copilot platform
     * @param {string} content - Agent file content with frontmatter
     * @returns {string} Transformed content with Copilot-specific frontmatter
     */
    transformFrontmatter(content) {
      const { data, content: body } = matter(content);
      
      // Remove skills field (not supported in Copilot)
      delete data.skills;
      
      // Use custom serializer for correct format
      const frontmatter = serializeFrontmatter(data, 'copilot');
      
      return `---\n${frontmatter}\n---\n\n${body}`;
    }
    ```

    **3. CodexAdapter (`codex-adapter.js`):**
    
    ```javascript
    import matter from 'gray-matter';
    import { serializeFrontmatter } from '../rendering/frontmatter-serializer.js';
    
    /**
     * Transform agent frontmatter for Codex platform
     * @param {string} content - Agent file content with frontmatter
     * @returns {string} Transformed content with Codex-specific frontmatter
     */
    transformFrontmatter(content) {
      const { data, content: body } = matter(content);
      
      // Remove skills field (not supported in Codex)
      delete data.skills;
      
      // Use custom serializer for correct format
      const frontmatter = serializeFrontmatter(data, 'codex');
      
      return `---\n${frontmatter}\n---\n\n${body}`;
    }
    ```

    Add imports at top of each file as needed.
  </action>
  <verify>
    ```bash
    # Verify methods exist
    node -e "import('./bin/lib/platforms/claude-adapter.js').then(m => { const a = new m.ClaudeAdapter(); console.log(typeof a.transformFrontmatter); })"
    node -e "import('./bin/lib/platforms/copilot-adapter.js').then(m => { const a = new m.CopilotAdapter(); console.log(typeof a.transformFrontmatter); })"
    node -e "import('./bin/lib/platforms/codex-adapter.js').then(m => { const a = new m.CodexAdapter(); console.log(typeof a.transformFrontmatter); })"
    # Each should output: function
    ```
  </verify>
  <done>
    - ClaudeAdapter.transformFrontmatter() extracts and adds skills field
    - CopilotAdapter.transformFrontmatter() removes skills, uses custom serializer
    - CodexAdapter.transformFrontmatter() removes skills, uses custom serializer
    - All methods properly parse and reconstruct frontmatter
  </done>
</task>

<task name="integrate-transformation-into-orchestrator" type="auto">
  <files>bin/lib/installer/orchestrator.js</files>
  <action>
    Modify `installAgents()` function in orchestrator.js to call adapter transformation:

    **Current code (lines ~279-282):**
    ```javascript
    const content = await readFile(srcFile, 'utf8');
    const processed = replaceVariables(content, variables);
    await writeFile(destFile, processed);
    ```

    **New code:**
    ```javascript
    const content = await readFile(srcFile, 'utf8');
    
    // Step 1: Replace template variables
    const withVariables = replaceVariables(content, variables);
    
    // Step 2: Transform frontmatter (platform-specific)
    const processed = adapter.transformFrontmatter(withVariables);
    
    await writeFile(destFile, processed);
    ```

    This ensures every agent goes through:
    1. Template variable replacement ({{PLATFORM_ROOT}}, etc.)
    2. Platform-specific frontmatter transformation (skills field, tools format)

    The two-step process is necessary because:
    - Variables must be replaced before frontmatter parsing (frontmatter may contain variables)
    - Frontmatter transformation must happen after variables (operates on final content)
  </action>
  <verify>
    ```bash
    # Verify orchestrator calls transformFrontmatter
    grep -A 5 "adapter.transformFrontmatter" bin/lib/installer/orchestrator.js
    # Should show the new integration point
    ```
  </verify>
  <done>
    - Orchestrator calls `adapter.transformFrontmatter()` for each agent
    - Two-step pipeline: variable replacement → frontmatter transformation
    - All 13 agents processed through transformation pipeline
  </done>
</task>

## Success Criteria

- [ ] ClaudeAdapter extracts skills from agent content and adds to frontmatter
- [ ] CopilotAdapter removes skills field from frontmatter
- [ ] CodexAdapter removes skills field from frontmatter
- [ ] CopilotAdapter and CodexAdapter use custom serializer for correct format
- [ ] Orchestrator calls `adapter.transformFrontmatter()` during agent installation
- [ ] Transformation happens after variable replacement but before file write
- [ ] Agent installation pipeline complete: variables → transformation → write

## Output

**Files Modified:**
- `bin/lib/platforms/claude-adapter.js` - Added transformFrontmatter with skill extraction
- `bin/lib/platforms/copilot-adapter.js` - Added transformFrontmatter with custom serializer
- `bin/lib/platforms/codex-adapter.js` - Added transformFrontmatter with custom serializer
- `bin/lib/installer/orchestrator.js` - Integrated transformation into installAgents pipeline

**Integration Complete:**
Agent frontmatter now correctly formatted for each platform. Next plan will add recursive template variable processing and comprehensive integration tests.
